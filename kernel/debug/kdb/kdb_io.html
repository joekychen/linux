<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › debug › kdb › kdb_io.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>kdb_io.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Kernel Debugger Architecture Independent Console I/O handler</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1999-2006 Silicon Graphics, Inc.  All Rights Reserved.</span>
<span class="cm"> * Copyright (c) 2009 Wind River Systems, Inc.  All Rights Reserved.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/nmi.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kgdb.h&gt;</span>
<span class="cp">#include &lt;linux/kdb.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &quot;kdb_private.h&quot;</span>

<span class="cp">#define CMD_BUFLEN 256</span>
<span class="kt">char</span> <span class="n">kdb_prompt_str</span><span class="p">[</span><span class="n">CMD_BUFLEN</span><span class="p">];</span>

<span class="kt">int</span> <span class="n">kdb_trap_printk</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kgdb_transition_check</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;+&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">KGDB_TRANS</span><span class="p">);</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="n">slen</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_gdb_state_pass</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;kgdb&quot;</span><span class="p">);</span>
			<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">DOING_KGDB</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_read_get_key</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define ESCAPE_UDELAY 1000</span>
<span class="cp">#define ESCAPE_DELAY (2*1000000/ESCAPE_UDELAY) </span><span class="cm">/* 2 seconds worth of udelays */</span><span class="cp"></span>
	<span class="kt">char</span> <span class="n">escape_data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>	<span class="cm">/* longest vt100 escape sequence is 4 bytes */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ped</span> <span class="o">=</span> <span class="n">escape_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">escape_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">get_char_func</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">f_escape</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">kdb_poll_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="p">;</span> <span class="o">++</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Reset NMI watchdog once per poll loop */</span>
			<span class="n">touch_nmi_watchdog</span><span class="p">();</span>
			<span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">kdb_poll_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">escape_delay</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ped</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">ped</span> <span class="o">=</span> <span class="n">escape_data</span><span class="p">;</span>
			<span class="o">--</span><span class="n">escape_delay</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">escape_delay</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">key</span> <span class="o">=</span> <span class="o">*</span><span class="n">ped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">ped</span><span class="p">)</span>
				<span class="o">--</span><span class="n">escape_delay</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">escape_delay</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="n">ESCAPE_UDELAY</span><span class="p">);</span>
				<span class="o">--</span><span class="n">escape_delay</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bufsize</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span>
				<span class="n">key</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
			<span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
			<span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">escape_delay</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">&#39;\e&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">escape_delay</span> <span class="o">=</span> <span class="n">ESCAPE_DELAY</span><span class="p">;</span>
			<span class="n">ped</span> <span class="o">=</span> <span class="n">escape_data</span><span class="p">;</span>
			<span class="n">f_escape</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">escape_delay</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ped</span><span class="o">++</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f_escape</span> <span class="o">!=</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">escape_delay</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ped</span> <span class="o">-</span> <span class="n">escape_data</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* \e */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ped</span> <span class="o">-</span> <span class="n">escape_data</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* \e&lt;something&gt; */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span>
					<span class="n">escape_delay</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ped</span> <span class="o">-</span> <span class="n">escape_data</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* \e[&lt;something&gt; */</span>
				<span class="kt">int</span> <span class="n">mapkey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="sc">&#39;A&#39;</span>: <span class="cm">/* \e[A, up arrow */</span>
					<span class="n">mapkey</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="sc">&#39;B&#39;</span>: <span class="cm">/* \e[B, down arrow */</span>
					<span class="n">mapkey</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="sc">&#39;C&#39;</span>: <span class="cm">/* \e[C, right arrow */</span>
					<span class="n">mapkey</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="sc">&#39;D&#39;</span>: <span class="cm">/* \e[D, left arrow */</span>
					<span class="n">mapkey</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="sc">&#39;1&#39;</span>: <span class="cm">/* dropthrough */</span>
				<span class="k">case</span> <span class="sc">&#39;3&#39;</span>: <span class="cm">/* dropthrough */</span>
				<span class="cm">/* \e[&lt;1,3,4&gt;], may be home, del, end */</span>
				<span class="k">case</span> <span class="sc">&#39;4&#39;</span>:
					<span class="n">mapkey</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mapkey</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mapkey</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">escape_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapkey</span><span class="p">;</span>
						<span class="n">escape_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">escape_delay</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ped</span> <span class="o">-</span> <span class="n">escape_data</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* \e[&lt;1,3,4&gt;&lt;something&gt; */</span>
				<span class="kt">int</span> <span class="n">mapkey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">&#39;~&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">escape_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">case</span> <span class="sc">&#39;1&#39;</span>: <span class="cm">/* \e[1~, home */</span>
						<span class="n">mapkey</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="sc">&#39;3&#39;</span>: <span class="cm">/* \e[3~, del */</span>
						<span class="n">mapkey</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="sc">&#39;4&#39;</span>: <span class="cm">/* \e[4~, end */</span>
						<span class="n">mapkey</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mapkey</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">escape_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapkey</span><span class="p">;</span>
					<span class="n">escape_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">escape_delay</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>	<span class="cm">/* A key to process */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">key</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_read</span>
<span class="cm"> *</span>
<span class="cm"> *	This function reads a string of characters, terminated by</span>
<span class="cm"> *	a newline, or by reaching the end of the supplied buffer,</span>
<span class="cm"> *	from the current kernel debugger console device.</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	buffer	- Address of character buffer to receive input characters.</span>
<span class="cm"> *	bufsize - size, in bytes, of the character buffer</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	Returns a pointer to the buffer containing the received</span>
<span class="cm"> *	character string.  This string will be terminated by a</span>
<span class="cm"> *	newline character.</span>
<span class="cm"> * Locking:</span>
<span class="cm"> *	No locks are required to be held upon entry to this</span>
<span class="cm"> *	function.  It is not reentrant - it relies on the fact</span>
<span class="cm"> *	that while kdb is running on only one &quot;master debug&quot; cpu.</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> *</span>
<span class="cm"> * The buffer size must be &gt;= 2.  A buffer size of 2 means that the caller only</span>
<span class="cm"> * wants a single key.</span>
<span class="cm"> *</span>
<span class="cm"> * An escape key could be the start of a vt100 control sequence such as \e[D</span>
<span class="cm"> * (left arrow) or it could be a character in its own right.  The standard</span>
<span class="cm"> * method for detecting the difference is to wait for 2 seconds to see if there</span>
<span class="cm"> * are any other characters.  kdb is complicated by the lack of a timer service</span>
<span class="cm"> * (interrupts are off), by multiple input sources and by the need to sometimes</span>
<span class="cm"> * return after just one key.  Escape sequence processing has to be done as</span>
<span class="cm"> * states in the polling loop.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">kdb_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bufend</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">+</span><span class="n">bufsize</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Reserve space for newline</span>
<span class="cm">						 * and null byte */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">lastchar</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p_tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">tmpbuffer</span><span class="p">[</span><span class="n">CMD_BUFLEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len_tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">,</span> <span class="n">dtab_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key</span><span class="p">;</span>


	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetintenv</span><span class="p">(</span><span class="s">&quot;DTABCOUNT&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtab_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="n">dtab_count</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">cp</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lastchar</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="nl">poll_again:</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">kdb_read_get_key</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">tab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* backspace */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;</span> <span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&lt;</span> <span class="n">lastchar</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">lastchar</span> <span class="o">-</span> <span class="n">cp</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmpbuffer</span><span class="p">,</span> <span class="n">lastchar</span> <span class="o">-</span> <span class="n">cp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="p">(</span><span class="o">--</span><span class="n">lastchar</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="o">--</span><span class="n">cp</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\b</span><span class="s">%s </span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
			<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>: <span class="cm">/* enter */</span>
		<span class="o">*</span><span class="n">lastchar</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lastchar</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">KGDB_TRANS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">KGDB_TRANS</span><span class="p">);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* Del */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&lt;</span> <span class="n">lastchar</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span> <span class="n">cp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">lastchar</span> <span class="o">-</span> <span class="n">cp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">tmpbuffer</span><span class="p">,</span> <span class="n">lastchar</span> <span class="o">-</span> <span class="n">cp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="o">--</span><span class="n">lastchar</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s </span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
			<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* Home */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;</span> <span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">);</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* End */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&lt;</span> <span class="n">lastchar</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">lastchar</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* Left */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;</span> <span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\b</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="o">--</span><span class="n">cp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>: <span class="cm">/* Down */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
		       <span class="n">strlen</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lastchar</span><span class="o">-</span><span class="n">buffer</span><span class="p">));</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">)</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">lastchar</span><span class="o">-</span><span class="n">buffer</span><span class="p">))</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">%s</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmpbuffer</span><span class="p">);</span>
		<span class="o">*</span><span class="n">lastchar</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">lastchar</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">lastchar</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* Right */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&lt;</span> <span class="n">lastchar</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="p">);</span>
			<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>: <span class="cm">/* Up */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
		       <span class="n">strlen</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lastchar</span><span class="o">-</span><span class="n">buffer</span><span class="p">));</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">)</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">lastchar</span><span class="o">-</span><span class="n">buffer</span><span class="p">))</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">%s</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmpbuffer</span><span class="p">);</span>
		<span class="o">*</span><span class="n">lastchar</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">lastchar</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">lastchar</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>: <span class="cm">/* Tab */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tab</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="o">++</span><span class="n">tab</span><span class="p">;</span>
		<span class="n">p_tmp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p_tmp</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="n">p_tmp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_tmp</span> <span class="o">&gt;</span> <span class="n">cp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span> <span class="n">p_tmp</span><span class="p">,</span> <span class="n">cp</span><span class="o">-</span><span class="n">p_tmp</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmpbuffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">cp</span><span class="o">-</span><span class="n">p_tmp</span><span class="p">))</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">p_tmp</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_tmp</span><span class="p">)</span>
			<span class="o">++</span><span class="n">p_tmp</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p_tmp</span> <span class="o">=</span> <span class="n">tmpbuffer</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">kallsyms_symbol_complete</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">)</span> <span class="o">-</span>
						 <span class="p">(</span><span class="n">p_tmp</span> <span class="o">-</span> <span class="n">tmpbuffer</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tab</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%d symbols are found.&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">dtab_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">dtab_count</span><span class="p">;</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot; But only first %d symbols will&quot;</span>
					   <span class="s">&quot; be printed.</span><span class="se">\n</span><span class="s">You can change the&quot;</span>
					   <span class="s">&quot; environment variable DTABCOUNT.&quot;</span><span class="p">,</span>
					   <span class="n">count</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">kallsyms_symbol_next</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">p_tmp</span><span class="p">);</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p_tmp</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dtab_count</span><span class="p">)</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tab</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len_tmp</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">);</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">p_tmp</span><span class="o">+</span><span class="n">len_tmp</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">lastchar</span><span class="o">-</span><span class="n">cp</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">len_tmp</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">);</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">p_tmp</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">len_tmp</span><span class="o">-</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">len_tmp</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
			<span class="n">cp</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">lastchar</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kdb_nextline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* reset output line number */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&gt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">lastchar</span> <span class="o">&lt;</span> <span class="n">bufend</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&lt;</span> <span class="n">lastchar</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">tmpbuffer</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">lastchar</span> <span class="o">-</span> <span class="n">cp</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmpbuffer</span><span class="p">,</span> <span class="n">lastchar</span> <span class="o">-</span> <span class="n">cp</span><span class="p">);</span>
				<span class="o">*++</span><span class="n">lastchar</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
				<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
				<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">);</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
				<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*++</span><span class="n">lastchar</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
				<span class="cm">/* The kgdb transition check will hide</span>
<span class="cm">				 * printed characters if we think that</span>
<span class="cm">				 * kgdb is connecting, until the check</span>
<span class="cm">				 * fails */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">KGDB_TRANS</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">kgdb_transition_check</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
						<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* Special escape to kgdb */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lastchar</span> <span class="o">-</span> <span class="n">buffer</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span>
			    <span class="n">strcmp</span><span class="p">(</span><span class="n">lastchar</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;$?#3f&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kdb_gdb_state_pass</span><span class="p">(</span><span class="n">lastchar</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;kgdb&quot;</span><span class="p">);</span>
				<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">DOING_KGDB</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lastchar</span> <span class="o">-</span> <span class="n">buffer</span> <span class="o">&gt;=</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span>
			    <span class="n">strcmp</span><span class="p">(</span><span class="n">lastchar</span> <span class="o">-</span> <span class="mi">11</span><span class="p">,</span> <span class="s">&quot;$qSupported&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kdb_gdb_state_pass</span><span class="p">(</span><span class="n">lastchar</span> <span class="o">-</span> <span class="mi">11</span><span class="p">);</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;kgdb&quot;</span><span class="p">);</span>
				<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">DOING_KGDB</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">poll_again</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_getstr</span>
<span class="cm"> *</span>
<span class="cm"> *	Print the prompt string and read a command from the</span>
<span class="cm"> *	input device.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	buffer	Address of buffer to receive command</span>
<span class="cm"> *	bufsize Size of buffer in bytes</span>
<span class="cm"> *	prompt	Pointer to string to use as prompt string</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	Pointer to command buffer.</span>
<span class="cm"> * Locking:</span>
<span class="cm"> *	None.</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> *	For SMP kernels, the processor number will be</span>
<span class="cm"> *	substituted for %d, %x or %o in the prompt.</span>
<span class="cm"> */</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">kdb_getstr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bufsize</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prompt</span> <span class="o">&amp;&amp;</span> <span class="n">kdb_prompt_str</span> <span class="o">!=</span> <span class="n">prompt</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">CMD_BUFLEN</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">);</span>
	<span class="n">kdb_nextline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Prompt and input resets line number */</span>
	<span class="k">return</span> <span class="n">kdb_read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_input_flush</span>
<span class="cm"> *</span>
<span class="cm"> *	Get rid of any buffered console input.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	none</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	nothing</span>
<span class="cm"> * Locking:</span>
<span class="cm"> *	none</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> *	Call this function whenever you want to flush input.  If there is any</span>
<span class="cm"> *	outstanding input, it ignores all characters until there has been no</span>
<span class="cm"> *	data for approximately 1ms.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kdb_input_flush</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_char_func</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flush_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">flush_delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flush_delay</span><span class="o">--</span><span class="p">;</span>
<span class="nl">empty:</span>
		<span class="n">touch_nmi_watchdog</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">kdb_poll_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span> <span class="o">++</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">flush_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">empty</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flush_delay</span><span class="p">)</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_printf</span>
<span class="cm"> *</span>
<span class="cm"> *	Print a string to the output device(s).</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	printf-like format and optional args.</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	0</span>
<span class="cm"> * Locking:</span>
<span class="cm"> *	None.</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> *	use &#39;kdbcons-&gt;write()&#39; to avoid polluting &#39;log_buf&#39; with</span>
<span class="cm"> *	kdb output.</span>
<span class="cm"> *</span>
<span class="cm"> *  If the user is doing a cmd args | grep srch</span>
<span class="cm"> *  then kdb_grepping_flag is set.</span>
<span class="cm"> *  In that case we need to accumulate full lines (ending in \n) before</span>
<span class="cm"> *  searching for the pattern.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">kdb_buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>	<span class="cm">/* A bit too big to go on stack */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">next_avail</span> <span class="o">=</span> <span class="n">kdb_buffer</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">size_avail</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">suspend_grep</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * search arg1 to see if it contains arg2</span>
<span class="cm"> * (kdmain.c provides flags for ^pat and pat$)</span>
<span class="cm"> *</span>
<span class="cm"> * return 1 for found, 0 for not found</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_search_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">searched</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchfor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">firstchar</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len1</span><span class="p">,</span> <span class="n">len2</span><span class="p">;</span>

	<span class="cm">/* not counting the newline at the end of &quot;searched&quot; */</span>
	<span class="n">len1</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">searched</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">len2</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">searchfor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len1</span> <span class="o">&lt;</span> <span class="n">len2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kdb_grep_leading</span> <span class="o">&amp;&amp;</span> <span class="n">kdb_grep_trailing</span> <span class="o">&amp;&amp;</span> <span class="n">len1</span> <span class="o">!=</span> <span class="n">len2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kdb_grep_leading</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">searched</span><span class="p">,</span> <span class="n">searchfor</span><span class="p">,</span> <span class="n">len2</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kdb_grep_trailing</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">searched</span><span class="o">+</span><span class="n">len1</span><span class="o">-</span><span class="n">len2</span><span class="p">,</span> <span class="n">searchfor</span><span class="p">,</span> <span class="n">len2</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">firstchar</span> <span class="o">=</span> <span class="o">*</span><span class="n">searchfor</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">searched</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">firstchar</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">searchfor</span><span class="p">,</span> <span class="n">len2</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vkdb_printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linecount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">logging</span><span class="p">,</span> <span class="n">saved_loglevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">saved_trap_printk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">got_printf_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fnd</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="n">cp2</span><span class="p">,</span> <span class="o">*</span><span class="n">cphold</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">replaced_byte</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">moreprompt</span> <span class="o">=</span> <span class="s">&quot;more&gt; &quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">console_drivers</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">kdb_printf_lock</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="n">saved_trap_printk</span> <span class="o">=</span> <span class="n">kdb_trap_printk</span><span class="p">;</span>
	<span class="n">kdb_trap_printk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Serialize kdb_printf if multiple cpus try to write at once.</span>
<span class="cm">	 * But if any cpu goes recursive in kdb, just print the output,</span>
<span class="cm">	 * even if it is interleaved with any other text.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">PRINTF_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">PRINTF_LOCK</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kdb_printf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">got_printf_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kdb_event</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__acquire</span><span class="p">(</span><span class="n">kdb_printf_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetintenv</span><span class="p">(</span><span class="s">&quot;LINES&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span> <span class="o">||</span> <span class="n">linecount</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">linecount</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetintenv</span><span class="p">(</span><span class="s">&quot;LOGGING&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logging</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="n">logging</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kdb_grepping_flag</span> <span class="o">||</span> <span class="n">suspend_grep</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* normally, every vsnprintf starts a new buffer */</span>
		<span class="n">next_avail</span> <span class="o">=</span> <span class="n">kdb_buffer</span><span class="p">;</span>
		<span class="n">size_avail</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">next_avail</span><span class="p">,</span> <span class="n">size_avail</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If kdb_parse() found that the command was cmd xxx | grep yyy</span>
<span class="cm">	 * then kdb_grepping_flag is set, and kdb_grep_string contains yyy</span>
<span class="cm">	 *</span>
<span class="cm">	 * Accumulate the print data up to a newline before searching it.</span>
<span class="cm">	 * (vsnprintf does null-terminate the string that it generates)</span>
<span class="cm">	 */</span>

	<span class="cm">/* skip the search if prints are temporarily unconditional */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suspend_grep</span> <span class="o">&amp;&amp;</span> <span class="n">kdb_grepping_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Special cases that don&#39;t end with newlines</span>
<span class="cm">			 * but should be written without one:</span>
<span class="cm">			 *   The &quot;[nn]kdb&gt; &quot; prompt should</span>
<span class="cm">			 *   appear at the front of the buffer.</span>
<span class="cm">			 *</span>
<span class="cm">			 *   The &quot;[nn]more &quot; prompt should also be</span>
<span class="cm">			 *     (MOREPROMPT -&gt; moreprompt)</span>
<span class="cm">			 *   written *   but we print that ourselves,</span>
<span class="cm">			 *   we set the suspend_grep flag to make</span>
<span class="cm">			 *   it unconditional.</span>
<span class="cm">			 *</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_avail</span> <span class="o">==</span> <span class="n">kdb_buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * these should occur after a newline,</span>
<span class="cm">				 * so they will be at the front of the</span>
<span class="cm">				 * buffer</span>
<span class="cm">				 */</span>
				<span class="n">cp2</span> <span class="o">=</span> <span class="n">kdb_buffer</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp2</span><span class="p">,</span> <span class="n">kdb_prompt_str</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * We&#39;re about to start a new</span>
<span class="cm">					 * command, so we can go back</span>
<span class="cm">					 * to normal mode.</span>
<span class="cm">					 */</span>
					<span class="n">kdb_grepping_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">kdb_printit</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* no newline; don&#39;t search/write the buffer</span>
<span class="cm">			   until one is there */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">);</span>
			<span class="n">next_avail</span> <span class="o">=</span> <span class="n">kdb_buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">size_avail</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">kdb_print_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The newline is present; print through it or discard</span>
<span class="cm">		 * it, depending on the results of the search.</span>
<span class="cm">		 */</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>	 	     <span class="cm">/* to byte after the newline */</span>
		<span class="n">replaced_byte</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span> <span class="cm">/* remember what/where it was */</span>
		<span class="n">cphold</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>	     <span class="cm">/* end the string for our search */</span>

		<span class="cm">/*</span>
<span class="cm">		 * We now have a newline at the end of the string</span>
<span class="cm">		 * Only continue with this output if it contains the</span>
<span class="cm">		 * search string.</span>
<span class="cm">		 */</span>
		<span class="n">fnd</span> <span class="o">=</span> <span class="n">kdb_search_string</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">,</span> <span class="n">kdb_grep_string</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnd</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * At this point the complete line at the start</span>
<span class="cm">			 * of kdb_buffer can be discarded, as it does</span>
<span class="cm">			 * not contain what the user is looking for.</span>
<span class="cm">			 * Shift the buffer left.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">cphold</span> <span class="o">=</span> <span class="n">replaced_byte</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">,</span> <span class="n">cphold</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">);</span>
			<span class="n">next_avail</span> <span class="o">=</span> <span class="n">kdb_buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">size_avail</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">kdb_print_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * at this point the string is a full line and</span>
<span class="cm">		 * should be printed, up to the null.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
<span class="nl">kdb_printit:</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write to all consoles.</span>
<span class="cm">	 */</span>
	<span class="n">retlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbg_kdb_mode</span> <span class="o">&amp;&amp;</span> <span class="n">kgdb_connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdbstub_msg_write</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">,</span> <span class="n">retlen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dbg_io_ops</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dbg_io_ops</span><span class="o">-&gt;</span><span class="n">is_console</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">);</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">kdb_buffer</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg_io_ops</span><span class="o">-&gt;</span><span class="n">write_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">);</span>
				<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">kdb_buffer</span><span class="p">,</span> <span class="n">retlen</span><span class="p">);</span>
			<span class="n">touch_nmi_watchdog</span><span class="p">();</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logging</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_loglevel</span> <span class="o">=</span> <span class="n">console_loglevel</span><span class="p">;</span>
		<span class="n">console_loglevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">kdb_buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">PAGER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strchr</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="n">kdb_nextline</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* check for having reached the LINES number of printed lines */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kdb_nextline</span> <span class="o">==</span> <span class="n">linecount</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">buf1</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_SMP)</span>
		<span class="kt">char</span> <span class="n">buf2</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="cp">#endif</span>

		<span class="cm">/* Watch out for recursion here.  Any routine that calls</span>
<span class="cm">		 * kdb_printf will come back through here.  And kdb_read</span>
<span class="cm">		 * uses kdb_printf to echo on serial consoles ...</span>
<span class="cm">		 */</span>
		<span class="n">kdb_nextline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* In case of recursion */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Pause until cr.</span>
<span class="cm">		 */</span>
		<span class="n">moreprompt</span> <span class="o">=</span> <span class="n">kdbgetenv</span><span class="p">(</span><span class="s">&quot;MOREPROMPT&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">moreprompt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">moreprompt</span> <span class="o">=</span> <span class="s">&quot;more&gt; &quot;</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_SMP)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">moreprompt</span><span class="p">,</span> <span class="sc">&#39;%&#39;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span> <span class="n">moreprompt</span><span class="p">,</span> <span class="n">get_cpu</span><span class="p">());</span>
			<span class="n">put_cpu</span><span class="p">();</span>
			<span class="n">moreprompt</span> <span class="o">=</span> <span class="n">buf2</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">kdb_input_flush</span><span class="p">();</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">console_drivers</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dbg_io_ops</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dbg_io_ops</span><span class="o">-&gt;</span><span class="n">is_console</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">moreprompt</span><span class="p">);</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">moreprompt</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg_io_ops</span><span class="o">-&gt;</span><span class="n">write_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">);</span>
				<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">moreprompt</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">moreprompt</span><span class="p">));</span>
			<span class="n">touch_nmi_watchdog</span><span class="p">();</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">logging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">moreprompt</span><span class="p">);</span>

		<span class="n">kdb_read</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* &#39;2&#39; indicates to return</span>
<span class="cm">				    * immediately after getting one key. */</span>
		<span class="n">kdb_nextline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Really set output line 1 */</span>

		<span class="cm">/* empty and reset the buffer: */</span>
		<span class="n">kdb_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">next_avail</span> <span class="o">=</span> <span class="n">kdb_buffer</span><span class="p">;</span>
		<span class="n">size_avail</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buf1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;q&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;Q&#39;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* user hit q or Q */</span>
			<span class="n">KDB_FLAG_SET</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span> <span class="cm">/* command interrupted */</span>
			<span class="n">KDB_STATE_CLEAR</span><span class="p">(</span><span class="n">PAGER</span><span class="p">);</span>
			<span class="cm">/* end of command output; back to normal mode */</span>
			<span class="n">kdb_grepping_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">suspend_grep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* for this recursion */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_nextline</span> <span class="o">=</span> <span class="n">linecount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">suspend_grep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* for this recursion */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">buf1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* user hit something other than enter */</span>
			<span class="n">suspend_grep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* for this recursion */</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Only &#39;q&#39; or &#39;Q&#39; are processed at more &quot;</span>
				   <span class="s">&quot;prompt, input ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kdb_grepping_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* user hit enter */</span>
			<span class="n">suspend_grep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* for this recursion */</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kdb_input_flush</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For grep searches, shift the printed string left.</span>
<span class="cm">	 *  replaced_byte contains the character that was overwritten with</span>
<span class="cm">	 *  the terminating null, and cphold points to the null.</span>
<span class="cm">	 * Then adjust the notion of available space in the buffer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kdb_grepping_flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">suspend_grep</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cphold</span> <span class="o">=</span> <span class="n">replaced_byte</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">,</span> <span class="n">cphold</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">);</span>
		<span class="n">next_avail</span> <span class="o">=</span> <span class="n">kdb_buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">size_avail</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kdb_buffer</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">kdb_print_out:</span>
	<span class="n">suspend_grep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* end of what may have been a recursive call */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logging</span><span class="p">)</span>
		<span class="n">console_loglevel</span> <span class="o">=</span> <span class="n">saved_loglevel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">PRINTF_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">got_printf_lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">got_printf_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kdb_printf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">KDB_STATE_CLEAR</span><span class="p">(</span><span class="n">PRINTF_LOCK</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kdb_event</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__release</span><span class="p">(</span><span class="n">kdb_printf_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kdb_trap_printk</span> <span class="o">=</span> <span class="n">saved_trap_printk</span><span class="p">;</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">retlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kdb_printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">vkdb_printf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">kdb_printf</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
