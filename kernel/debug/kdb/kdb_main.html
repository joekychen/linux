<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › debug › kdb › kdb_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>kdb_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Kernel Debugger Architecture Independent Main Code</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2004 Silicon Graphics, Inc.  All Rights Reserved.</span>
<span class="cm"> * Copyright (C) 2000 Stephane Eranian &lt;eranian@hpl.hp.com&gt;</span>
<span class="cm"> * Xscale (R) modifications copyright (C) 2003 Intel Corporation.</span>
<span class="cm"> * Copyright (c) 2009 Wind River Systems, Inc.  All Rights Reserved.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/kgdb.h&gt;</span>
<span class="cp">#include &lt;linux/kdb.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/nmi.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/kdebug.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;kdb_private.h&quot;</span>

<span class="cp">#define GREP_LEN 256</span>
<span class="kt">char</span> <span class="n">kdb_grep_string</span><span class="p">[</span><span class="n">GREP_LEN</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">kdb_grepping_flag</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">kdb_grepping_flag</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">kdb_grep_leading</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">kdb_grep_trailing</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Kernel debugger state flags</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">kdb_flags</span><span class="p">;</span>
<span class="n">atomic_t</span> <span class="n">kdb_event</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_lock protects updates to kdb_initial_cpu.  Used to</span>
<span class="cm"> * single thread processors through the kernel debugger.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">kdb_initial_cpu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* cpu number that owns kdb */</span>
<span class="kt">int</span> <span class="n">kdb_nextline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">kdb_state</span><span class="p">;</span>			<span class="cm">/* General KDB state */</span>

<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">kdb_current_task</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">kdb_current_task</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">kdb_current_regs</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kdb_diemsg</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">kdb_go_count</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_KDB_CONTINUE_CATASTROPHIC</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">kdb_continue_catastrophic</span> <span class="o">=</span>
	<span class="n">CONFIG_KDB_CONTINUE_CATASTROPHIC</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">kdb_continue_catastrophic</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* kdb_commands describes the available commands. */</span>
<span class="k">static</span> <span class="n">kdbtab_t</span> <span class="o">*</span><span class="n">kdb_commands</span><span class="p">;</span>
<span class="cp">#define KDB_BASE_CMD_MAX 50</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">kdb_max_commands</span> <span class="o">=</span> <span class="n">KDB_BASE_CMD_MAX</span><span class="p">;</span>
<span class="k">static</span> <span class="n">kdbtab_t</span> <span class="n">kdb_base_commands</span><span class="p">[</span><span class="n">KDB_BASE_CMD_MAX</span><span class="p">];</span>
<span class="cp">#define for_each_kdbcmd(cmd, num)					\</span>
<span class="cp">	for ((cmd) = kdb_base_commands, (num) = 0;			\</span>
<span class="cp">	     num &lt; kdb_max_commands;					\</span>
<span class="cp">	     num++, num == KDB_BASE_CMD_MAX ? cmd = kdb_commands : cmd++)</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_kdbmsg</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">km_diag</span><span class="p">;</span>	<span class="cm">/* kdb diagnostic */</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">km_msg</span><span class="p">;</span>	<span class="cm">/* Corresponding message text */</span>
<span class="p">}</span> <span class="n">kdbmsg_t</span><span class="p">;</span>

<span class="cp">#define KDBMSG(msgnum, text) \</span>
<span class="cp">	{ KDB_##msgnum, text }</span>

<span class="k">static</span> <span class="n">kdbmsg_t</span> <span class="n">kdbmsgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">NOTFOUND</span><span class="p">,</span> <span class="s">&quot;Command Not Found&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">ARGCOUNT</span><span class="p">,</span> <span class="s">&quot;Improper argument count, see usage.&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">BADWIDTH</span><span class="p">,</span> <span class="s">&quot;Illegal value for BYTESPERWORD use 1, 2, 4 or 8, &quot;</span>
	       <span class="s">&quot;8 is only allowed on 64 bit systems&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">BADRADIX</span><span class="p">,</span> <span class="s">&quot;Illegal value for RADIX use 8, 10 or 16&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">NOTENV</span><span class="p">,</span> <span class="s">&quot;Cannot find environment variable&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">NOENVVALUE</span><span class="p">,</span> <span class="s">&quot;Environment variable should have value&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">NOTIMP</span><span class="p">,</span> <span class="s">&quot;Command not implemented&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">ENVFULL</span><span class="p">,</span> <span class="s">&quot;Environment full&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">ENVBUFFULL</span><span class="p">,</span> <span class="s">&quot;Environment buffer full&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">TOOMANYBPT</span><span class="p">,</span> <span class="s">&quot;Too many breakpoints defined&quot;</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_CPU_XSCALE</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">TOOMANYDBREGS</span><span class="p">,</span> <span class="s">&quot;More breakpoints than ibcr registers defined&quot;</span><span class="p">),</span>
<span class="cp">#else</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">TOOMANYDBREGS</span><span class="p">,</span> <span class="s">&quot;More breakpoints than db registers defined&quot;</span><span class="p">),</span>
<span class="cp">#endif</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">DUPBPT</span><span class="p">,</span> <span class="s">&quot;Duplicate breakpoint address&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">BPTNOTFOUND</span><span class="p">,</span> <span class="s">&quot;Breakpoint not found&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">BADMODE</span><span class="p">,</span> <span class="s">&quot;Invalid IDMODE&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">BADINT</span><span class="p">,</span> <span class="s">&quot;Illegal numeric value&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">INVADDRFMT</span><span class="p">,</span> <span class="s">&quot;Invalid symbolic address format&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">BADREG</span><span class="p">,</span> <span class="s">&quot;Invalid register name&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">BADCPUNUM</span><span class="p">,</span> <span class="s">&quot;Invalid cpu number&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">BADLENGTH</span><span class="p">,</span> <span class="s">&quot;Invalid length field&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">NOBP</span><span class="p">,</span> <span class="s">&quot;No Breakpoint exists&quot;</span><span class="p">),</span>
	<span class="n">KDBMSG</span><span class="p">(</span><span class="n">BADADDR</span><span class="p">,</span> <span class="s">&quot;Invalid address&quot;</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#undef KDBMSG</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">__nkdb_err</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kdbmsgs</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kdbmsg_t</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Initial environment.   This is all kept static and local to</span>
<span class="cm"> * this file.   We don&#39;t want to rely on the memory allocation</span>
<span class="cm"> * mechanisms in the kernel, so we use a very limited allocate-only</span>
<span class="cm"> * heap for new and altered environment variables.  The entire</span>
<span class="cm"> * environment is limited to a fixed number of entries (add more</span>
<span class="cm"> * to __env[] if required) and a fixed amount of heap (add more to</span>
<span class="cm"> * KDB_ENVBUFSIZE if required).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__env</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_SMP)</span>
 <span class="s">&quot;PROMPT=[%d]kdb&gt; &quot;</span><span class="p">,</span>
 <span class="s">&quot;MOREPROMPT=[%d]more&gt; &quot;</span><span class="p">,</span>
<span class="cp">#else</span>
 <span class="s">&quot;PROMPT=kdb&gt; &quot;</span><span class="p">,</span>
 <span class="s">&quot;MOREPROMPT=more&gt; &quot;</span><span class="p">,</span>
<span class="cp">#endif</span>
 <span class="s">&quot;RADIX=16&quot;</span><span class="p">,</span>
 <span class="s">&quot;MDCOUNT=8&quot;</span><span class="p">,</span>			<span class="cm">/* lines of md output */</span>
 <span class="n">KDB_PLATFORM_ENV</span><span class="p">,</span>
 <span class="s">&quot;DTABCOUNT=30&quot;</span><span class="p">,</span>
 <span class="s">&quot;NOSECT=1&quot;</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">__nenv</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__env</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="nf">kdb_curr_task</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">curr_task</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="cp">#ifdef	_TIF_MCA_INIT</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">task_thread_info</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_TIF_MCA_INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">KDB_TSK</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">krp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdbgetenv - This function will return the character string value of</span>
<span class="cm"> *	an environment variable.</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	match	A character string representing an environment variable.</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	NULL	No environment variable matches &#39;match&#39;</span>
<span class="cm"> *	char*	Pointer to string value of environment variable.</span>
<span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">kdbgetenv</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">ep</span> <span class="o">=</span> <span class="n">__env</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">matchlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">match</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__nenv</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="o">*</span><span class="n">ep</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">strncmp</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">matchlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="n">matchlen</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		   <span class="o">||</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">matchlen</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">cp</span> <span class="o">?</span> <span class="o">++</span><span class="n">cp</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdballocenv - This function is used to allocate bytes for</span>
<span class="cm"> *	environment entries.</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	match	A character string representing a numeric value</span>
<span class="cm"> * Outputs:</span>
<span class="cm"> *	*value  the unsigned long representation of the env variable &#39;match&#39;</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	Zero on success, a kdb diagnostic on failure.</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> *	We use a static environment buffer (envbuffer) to hold the values</span>
<span class="cm"> *	of dynamically generated environment variables (see kdb_set).  Buffer</span>
<span class="cm"> *	space once allocated is never free&#39;d, so over time, the amount of space</span>
<span class="cm"> *	(currently 512 bytes) will be exhausted if env variables are changed</span>
<span class="cm"> *	frequently.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">kdballocenv</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define	KDB_ENVBUFSIZE	512</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">envbuffer</span><span class="p">[</span><span class="n">KDB_ENVBUFSIZE</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">envbufsize</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">KDB_ENVBUFSIZE</span> <span class="o">-</span> <span class="n">envbufsize</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">envbuffer</span><span class="p">[</span><span class="n">envbufsize</span><span class="p">];</span>
		<span class="n">envbufsize</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdbgetulenv - This function will return the value of an unsigned</span>
<span class="cm"> *	long-valued environment variable.</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	match	A character string representing a numeric value</span>
<span class="cm"> * Outputs:</span>
<span class="cm"> *	*value  the unsigned long represntation of the env variable &#39;match&#39;</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	Zero on success, a kdb diagnostic on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdbgetulenv</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">match</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">kdbgetenv</span><span class="p">(</span><span class="n">match</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_NOTENV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_NOENVVALUE</span><span class="p">;</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdbgetintenv - This function will return the value of an</span>
<span class="cm"> *	integer-valued environment variable.</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	match	A character string representing an integer-valued env variable</span>
<span class="cm"> * Outputs:</span>
<span class="cm"> *	*value  the integer representation of the environment variable &#39;match&#39;</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	Zero on success, a kdb diagnostic on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kdbgetintenv</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">match</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetulenv</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diag</span><span class="p">)</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdbgetularg - This function will convert a numeric string into an</span>
<span class="cm"> *	unsigned long value.</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	arg	A character string representing a numeric value</span>
<span class="cm"> * Outputs:</span>
<span class="cm"> *	*value  the unsigned long represntation of arg.</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	Zero on success, a kdb diagnostic on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kdbgetularg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">endp</span> <span class="o">==</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Also try base 16, for us folks too lazy to type the</span>
<span class="cm">		 * leading 0x...</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">endp</span> <span class="o">==</span> <span class="n">arg</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">KDB_BADINT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kdbgetu64arg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">endp</span> <span class="o">==</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">endp</span> <span class="o">==</span> <span class="n">arg</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">KDB_BADINT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_set - This function implements the &#39;set&#39; command.  Alter an</span>
<span class="cm"> *	existing environment variable or create a new one.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kdb_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">varlen</span><span class="p">,</span> <span class="n">vallen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we can be invoked two ways:</span>
<span class="cm">	 *   set var=value    argv[1]=&quot;var&quot;, argv[2]=&quot;value&quot;</span>
<span class="cm">	 *   set var = value  argv[1]=&quot;var&quot;, argv[2]=&quot;=&quot;, argv[3]=&quot;value&quot;</span>
<span class="cm">	 * - if the latter, shift &#39;em down.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for internal variables</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;KDBDEBUG&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debugflags</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

		<span class="n">debugflags</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">KDB_DEBUG_FLAG_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb: illegal debug flags &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kdb_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">kdb_flags</span> <span class="o">&amp;</span>
			     <span class="o">~</span><span class="p">(</span><span class="n">KDB_DEBUG_FLAG_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">KDB_DEBUG_FLAG_SHIFT</span><span class="p">))</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">debugflags</span> <span class="o">&lt;&lt;</span> <span class="n">KDB_DEBUG_FLAG_SHIFT</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tokenizer squashed the &#39;=&#39; sign.  argv[1] is variable</span>
<span class="cm">	 * name, argv[2] = value.</span>
<span class="cm">	 */</span>
	<span class="n">varlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">vallen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">kdballocenv</span><span class="p">(</span><span class="n">varlen</span> <span class="o">+</span> <span class="n">vallen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ENVBUFFULL</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="s">&quot;%s=%s&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">ep</span><span class="p">[</span><span class="n">varlen</span><span class="o">+</span><span class="n">vallen</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__nenv</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__env</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">strncmp</span><span class="p">(</span><span class="n">__env</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">varlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">__env</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">varlen</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">__env</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">varlen</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">__env</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wasn&#39;t existing variable.  Fit into slot.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__nenv</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__env</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__env</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">KDB_ENVFULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_check_regs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kdb_current_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;No current kdb registers.&quot;</span>
			   <span class="s">&quot;  You may need to select another task</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">KDB_BADREG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdbgetaddrarg - This function is responsible for parsing an</span>
<span class="cm"> *	address-expression and returning the value of the expression,</span>
<span class="cm"> *	symbol name, and offset to the caller.</span>
<span class="cm"> *</span>
<span class="cm"> *	The argument may consist of a numeric value (decimal or</span>
<span class="cm"> *	hexidecimal), a symbol name, a register name (preceded by the</span>
<span class="cm"> *	percent sign), an environment variable with a numeric value</span>
<span class="cm"> *	(preceded by a dollar sign) or a simple arithmetic expression</span>
<span class="cm"> *	consisting of a symbol name, +/-, and a numeric constant value</span>
<span class="cm"> *	(offset).</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	argc	- count of arguments in argv</span>
<span class="cm"> *	argv	- argument vector</span>
<span class="cm"> *	*nextarg - index to next unparsed argument in argv[]</span>
<span class="cm"> *	regs	- Register state at time of KDB entry</span>
<span class="cm"> * Outputs:</span>
<span class="cm"> *	*value	- receives the value of the address-expression</span>
<span class="cm"> *	*offset - receives the offset specified, if any</span>
<span class="cm"> *	*name   - receives the symbol name, if any</span>
<span class="cm"> *	*nextarg - index to next unparsed argument in argv[]</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	zero is returned on success, a kdb diagnostic code is</span>
<span class="cm"> *      returned on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kdbgetaddrarg</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nextarg</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>  <span class="kt">long</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span>
		  <span class="kt">char</span> <span class="o">**</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">positive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">symname</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">symbol</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">kdb_symtab_t</span> <span class="n">symtab</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process arguments which follow the following syntax:</span>
<span class="cm">	 *</span>
<span class="cm">	 *  symbol | numeric-address [+/- numeric-offset]</span>
<span class="cm">	 *  %register</span>
<span class="cm">	 *  $environment-variable</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nextarg</span> <span class="o">&gt;</span> <span class="n">argc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">symname</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">argv</span><span class="p">[</span><span class="o">*</span><span class="n">nextarg</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is no whitespace between the symbol</span>
<span class="cm">	 * or address and the &#39;+&#39; or &#39;-&#39; symbols, we</span>
<span class="cm">	 * remember the character and replace it with a</span>
<span class="cm">	 * null so the symbol/value can be properly parsed</span>
<span class="cm">	 */</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">strpbrk</span><span class="p">(</span><span class="n">symname</span><span class="p">,</span> <span class="s">&quot;+-&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">symbol</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetulenv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">symname</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">symname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdb_check_regs</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
		<span class="cm">/* Implement register values with % at a later time as it is</span>
<span class="cm">		 * arch optional.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">KDB_NOTIMP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">found</span> <span class="o">=</span> <span class="n">kdbgetsymval</span><span class="p">(</span><span class="n">symname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symtab</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">symtab</span><span class="p">.</span><span class="n">sym_start</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetularg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="o">*</span><span class="n">nextarg</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">found</span> <span class="o">=</span> <span class="n">kdbnearsym</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symtab</span><span class="p">);</span>

	<span class="p">(</span><span class="o">*</span><span class="n">nextarg</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">symname</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
		<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">symtab</span><span class="p">.</span><span class="n">sym_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">nextarg</span> <span class="o">&gt;</span> <span class="n">argc</span><span class="p">)</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">symbol</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for +/- and offset</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symbol</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">argv</span><span class="p">[</span><span class="o">*</span><span class="n">nextarg</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="o">*</span><span class="n">nextarg</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Not our argument.  Return.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">positive</span> <span class="o">=</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="o">*</span><span class="n">nextarg</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">nextarg</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">positive</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbol</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now there must be an offset!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">nextarg</span> <span class="o">&gt;</span> <span class="n">argc</span><span class="p">)</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">symbol</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">KDB_INVADDRFMT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">symbol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">argv</span><span class="p">[</span><span class="o">*</span><span class="n">nextarg</span><span class="p">];</span>
		<span class="p">(</span><span class="o">*</span><span class="n">nextarg</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetularg</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">positive</span><span class="p">)</span>
		<span class="n">off</span> <span class="o">=</span> <span class="o">-</span><span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span>
		<span class="o">*</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">+=</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kdb_cmderror</span><span class="p">(</span><span class="kt">int</span> <span class="n">diag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;no error detected (diagnostic is %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">diag</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__nkdb_err</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdbmsgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">km_diag</span> <span class="o">==</span> <span class="n">diag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;diag: %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">diag</span><span class="p">,</span> <span class="n">kdbmsgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">km_msg</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Unknown diag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">diag</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_defcmd, kdb_defcmd2 - This function implements the &#39;defcmd&#39;</span>
<span class="cm"> *	command which defines one command as a set of other commands,</span>
<span class="cm"> *	terminated by endefcmd.  kdb_defcmd processes the initial</span>
<span class="cm"> *	&#39;defcmd&#39; command, kdb_defcmd2 is invoked from kdb_parse for</span>
<span class="cm"> *	the following commands until &#39;endefcmd&#39;.</span>
<span class="cm"> * Inputs:</span>
<span class="cm"> *	argc	argument count</span>
<span class="cm"> *	argv	argument vector</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	zero for success, a kdb diagnostic if error</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">defcmd_set</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usable</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">usage</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">help</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">command</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">defcmd_set</span> <span class="o">*</span><span class="n">defcmd_set</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">defcmd_set_count</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">defcmd_in_progress</span><span class="p">;</span>

<span class="cm">/* Forward references */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">kdb_exec_defcmd</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_defcmd2</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmdstr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">defcmd_set</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">defcmd_set</span> <span class="o">+</span> <span class="n">defcmd_set_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">save_command</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv0</span><span class="p">,</span> <span class="s">&quot;endefcmd&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">defcmd_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">usable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">usable</span><span class="p">)</span>
			<span class="n">kdb_register</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">kdb_exec_defcmd</span><span class="p">,</span>
				     <span class="n">s</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">usable</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_NOTIMP</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)),</span> <span class="n">GFP_KDB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Could not allocate new kdb_defcmd table for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cmdstr</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">usable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">KDB_NOTIMP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">save_command</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)));</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kdb_strdup</span><span class="p">(</span><span class="n">cmdstr</span><span class="p">,</span> <span class="n">GFP_KDB</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save_command</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_defcmd</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">defcmd_set</span> <span class="o">*</span><span class="n">save_defcmd_set</span> <span class="o">=</span> <span class="n">defcmd_set</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">defcmd_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb: nested defcmd detected, assuming missing &quot;</span>
			   <span class="s">&quot;endefcmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kdb_defcmd2</span><span class="p">(</span><span class="s">&quot;endefcmd&quot;</span><span class="p">,</span> <span class="s">&quot;endefcmd&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">defcmd_set</span><span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">defcmd_set</span> <span class="o">+</span> <span class="n">defcmd_set_count</span><span class="p">;</span> <span class="o">++</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;defcmd %s </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				   <span class="n">s</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;endefcmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>
	<span class="n">defcmd_set</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">defcmd_set_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">defcmd_set</span><span class="p">),</span>
			     <span class="n">GFP_KDB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">defcmd_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Could not allocate new defcmd_set entry for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">defcmd_set</span> <span class="o">=</span> <span class="n">save_defcmd_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">KDB_NOTIMP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">defcmd_set</span><span class="p">,</span> <span class="n">save_defcmd_set</span><span class="p">,</span>
	       <span class="n">defcmd_set_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">defcmd_set</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save_defcmd_set</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">defcmd_set</span> <span class="o">+</span> <span class="n">defcmd_set_count</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">));</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">usable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kdb_strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">GFP_KDB</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">=</span> <span class="n">kdb_strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">GFP_KDB</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">help</span> <span class="o">=</span> <span class="n">kdb_strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">GFP_KDB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">usage</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">help</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">++</span><span class="n">defcmd_set_count</span><span class="p">;</span>
	<span class="n">defcmd_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_exec_defcmd - Execute the set of commands associated with this</span>
<span class="cm"> *	defcmd name.</span>
<span class="cm"> * Inputs:</span>
<span class="cm"> *	argc	argument count</span>
<span class="cm"> *	argv	argument vector</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	zero for success, a kdb diagnostic if error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_exec_defcmd</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">defcmd_set</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">defcmd_set</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">defcmd_set_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">defcmd_set_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb_exec_defcmd: could not find commands for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">KDB_NOTIMP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Recursive use of kdb_parse, do not use argv after</span>
<span class="cm">		 * this point */</span>
		<span class="n">argv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;[%s]kdb&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">kdb_parse</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Command history */</span>
<span class="cp">#define KDB_CMD_HISTORY_COUNT	32</span>
<span class="cp">#define CMD_BUFLEN		200	</span><span class="cm">/* kdb_printf: max printline</span>
<span class="cm">					 * size == 256 */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_head</span><span class="p">,</span> <span class="n">cmd_tail</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmdptr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">cmd_hist</span><span class="p">[</span><span class="n">KDB_CMD_HISTORY_COUNT</span><span class="p">][</span><span class="n">CMD_BUFLEN</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">cmd_cur</span><span class="p">[</span><span class="n">CMD_BUFLEN</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * The &quot;str&quot; argument may point to something like  | grep xyz</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_grep</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">cp2</span><span class="p">;</span>

	<span class="cm">/* sanity check: we should have been called with the \ first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;|&#39;</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">))</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">&quot;grep &quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;invalid &#39;pipe&#39;, see grephelp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cp</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">))</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cp2</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp2</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cp2</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* remove the trailing newline */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;invalid &#39;pipe&#39;, see grephelp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* now cp points to a nonzero length search string */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allow it be &quot;x y z&quot; by removing the &quot;&#39;s - there must</span>
<span class="cm">		   be two of them */</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cp2</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;invalid quoted string, see grephelp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">cp2</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* end the string where the 2nd &quot; was */</span>
	<span class="p">}</span>
	<span class="n">kdb_grep_leading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;^&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_grep_leading</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">kdb_grep_trailing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">cp</span><span class="o">+</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_grep_trailing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">cp</span><span class="o">+</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">GREP_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;search string too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">kdb_grep_string</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
	<span class="n">kdb_grepping_flag</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_parse - Parse the command line, search the command table for a</span>
<span class="cm"> *	matching command and invoke the command function.  This</span>
<span class="cm"> *	function may be called recursively, if it is, the second call</span>
<span class="cm"> *	will overwrite argv and cbuf.  It is the caller&#39;s</span>
<span class="cm"> *	responsibility to save their argv if they recursively call</span>
<span class="cm"> *	kdb_parse().</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *      cmdstr	The input command line to be parsed.</span>
<span class="cm"> *	regs	The registers at the time kdb was entered.</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	Zero for success, a kdb diagnostic if failure.</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> *	Limited to 20 tokens.</span>
<span class="cm"> *</span>
<span class="cm"> *	Real rudimentary tokenization. Basically only whitespace</span>
<span class="cm"> *	is considered a token delimeter (but special consideration</span>
<span class="cm"> *	is taken of the &#39;=&#39; sign as used by the &#39;set&#39; command).</span>
<span class="cm"> *</span>
<span class="cm"> *	The algorithm used to tokenize the input string relies on</span>
<span class="cm"> *	there being at least one whitespace (or otherwise useless)</span>
<span class="cm"> *	character between tokens as the character immediately following</span>
<span class="cm"> *	the token is altered in-place to a null-byte to terminate the</span>
<span class="cm"> *	token string.</span>
<span class="cm"> */</span>

<span class="cp">#define MAXARGC	20</span>

<span class="kt">int</span> <span class="nf">kdb_parse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmdstr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="n">MAXARGC</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">cbuf</span><span class="p">[</span><span class="n">CMD_BUFLEN</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cpp</span><span class="p">,</span> <span class="n">quoted</span><span class="p">;</span>
	<span class="n">kdbtab_t</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">escaped</span><span class="p">,</span> <span class="n">ignore_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">check_grep</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First tokenize the command string.</span>
<span class="cm">	 */</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmdstr</span><span class="p">;</span>
	<span class="n">kdb_grepping_flag</span> <span class="o">=</span> <span class="n">check_grep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Previous command was interrupted, newline must not</span>
<span class="cm">		 * repeat the command */</span>
		<span class="n">KDB_FLAG_CLEAR</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span>
		<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">PAGER</span><span class="p">);</span>
		<span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no repeat */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cpp</span> <span class="o">=</span> <span class="n">cbuf</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* skip whitespace */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">))</span>
				<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">defcmd_in_progress</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* special case: check for | grep pattern */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;|&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">check_grep</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpp</span> <span class="o">&gt;=</span> <span class="n">cbuf</span> <span class="o">+</span> <span class="n">CMD_BUFLEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb_parse: command buffer &quot;</span>
					   <span class="s">&quot;overflow, command ignored</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">cmdstr</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">KDB_NOTFOUND</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="n">MAXARGC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb_parse: too many arguments, &quot;</span>
					   <span class="s">&quot;command ignored</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmdstr</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">KDB_NOTFOUND</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">argv</span><span class="p">[</span><span class="n">argc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpp</span><span class="p">;</span>
			<span class="n">escaped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">quoted</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="cm">/* Copy to next unquoted and unescaped</span>
<span class="cm">			 * whitespace or &#39;=&#39; */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">escaped</span> <span class="o">||</span> <span class="n">quoted</span> <span class="o">||</span> <span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cpp</span> <span class="o">&gt;=</span> <span class="n">cbuf</span> <span class="o">+</span> <span class="n">CMD_BUFLEN</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">escaped</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">escaped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="o">*</span><span class="n">cpp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">escaped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="n">quoted</span><span class="p">)</span>
					<span class="n">quoted</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
					<span class="n">quoted</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
				<span class="o">*</span><span class="n">cpp</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cpp</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">quoted</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="o">++</span><span class="n">cpp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">cpp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>	<span class="cm">/* Squash a ws or &#39;=&#39; character */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_grep</span><span class="p">)</span>
		<span class="n">parse_grep</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">defcmd_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">kdb_defcmd2</span><span class="p">(</span><span class="n">cmdstr</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">defcmd_in_progress</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* avoid repeat on endefcmd */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ignore_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">++</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">for_each_kdbcmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If this command is allowed to be abbreviated,</span>
<span class="cm">			 * check to see if this is it.</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_minlen</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_minlen</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">,</span>
					    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_minlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t find a command by this name, see if the first</span>
<span class="cm">	 * few characters of this match any of the known commands.</span>
<span class="cm">	 * e.g., md1c20 should match md.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">kdb_max_commands</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">for_each_kdbcmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">,</span>
					    <span class="n">strlen</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">kdb_max_commands</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
		<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">CMD</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_func</span><span class="p">)(</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">argv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">ignore_errors</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="n">KDB_CMD_GO</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">KDB_STATE_CLEAR</span><span class="p">(</span><span class="n">CMD</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cmd_repeat</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">KDB_REPEAT_NONE</span>:
			<span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="o">*</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KDB_REPEAT_NO_ARGS</span>:
			<span class="n">argc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="o">*</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KDB_REPEAT_WITH_ARGS</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the input with which we were presented does not</span>
<span class="cm">	 * map to an existing command, attempt to parse it as an</span>
<span class="cm">	 * address argument and display the result.   Useful for</span>
<span class="cm">	 * obtaining the address of a variable, or the nearest symbol</span>
<span class="cm">	 * to an address contained in a register.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">nextarg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kdbgetaddrarg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nextarg</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">KDB_NOTFOUND</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s = &quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">kdb_symbol_print</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">KDB_SP_DEFAULT</span><span class="p">);</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_ctrl_cmd</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define CTRL_P	16</span>
<span class="cp">#define CTRL_N	14</span>

	<span class="cm">/* initial situation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_head</span> <span class="o">==</span> <span class="n">cmd_tail</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CTRL_P</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdptr</span> <span class="o">!=</span> <span class="n">cmd_tail</span><span class="p">)</span>
			<span class="n">cmdptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmdptr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">KDB_CMD_HISTORY_COUNT</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">cmd_cur</span><span class="p">,</span> <span class="n">cmd_hist</span><span class="p">[</span><span class="n">cmdptr</span><span class="p">],</span> <span class="n">CMD_BUFLEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CTRL_N</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdptr</span> <span class="o">!=</span> <span class="n">cmd_head</span><span class="p">)</span>
			<span class="n">cmdptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmdptr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">KDB_CMD_HISTORY_COUNT</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">cmd_cur</span><span class="p">,</span> <span class="n">cmd_hist</span><span class="p">[</span><span class="n">cmdptr</span><span class="p">],</span> <span class="n">CMD_BUFLEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_reboot - This function implements the &#39;reboot&#39; command.  Reboot</span>
<span class="cm"> *	the system immediately, or loop for ever on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_reboot</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emergency_restart</span><span class="p">();</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Hmm, kdb_reboot did not reboot, spinning here</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="cm">/* NOTREACHED */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kdb_dumpregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old_lvl</span> <span class="o">=</span> <span class="n">console_loglevel</span><span class="p">;</span>
	<span class="n">console_loglevel</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">kdb_trap_printk</span><span class="o">++</span><span class="p">;</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">kdb_trap_printk</span><span class="o">--</span><span class="p">;</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">console_loglevel</span> <span class="o">=</span> <span class="n">old_lvl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kdb_set_current_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kdb_current_task</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kdb_task_has_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kdb_current_regs</span> <span class="o">=</span> <span class="n">KDB_TSKREGS</span><span class="p">(</span><span class="n">kdb_process_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kdb_current_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_local - The main code for kdb.  This routine is invoked on a</span>
<span class="cm"> *	specific processor, it is not global.  The main kdb() routine</span>
<span class="cm"> *	ensures that only one processor at a time is in this routine.</span>
<span class="cm"> *	This code is called with the real reason code on the first</span>
<span class="cm"> *	entry to a kdb session, thereafter it is called with reason</span>
<span class="cm"> *	SWITCH, even if the user goes back to the original cpu.</span>
<span class="cm"> * Inputs:</span>
<span class="cm"> *	reason		The reason KDB was invoked</span>
<span class="cm"> *	error		The hardware-defined error code</span>
<span class="cm"> *	regs		The exception frame at time of fault/breakpoint.</span>
<span class="cm"> *	db_result	Result code from the break or debug point.</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	0	KDB was invoked for an event which it wasn&#39;t responsible</span>
<span class="cm"> *	1	KDB handled the event for which it was invoked.</span>
<span class="cm"> *	KDB_CMD_GO	User typed &#39;go&#39;.</span>
<span class="cm"> *	KDB_CMD_CPU	User switched to another cpu.</span>
<span class="cm"> *	KDB_CMD_SS	Single step.</span>
<span class="cm"> *	KDB_CMD_SSB	Single step until branch.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_local</span><span class="p">(</span><span class="n">kdb_reason_t</span> <span class="n">reason</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
		     <span class="n">kdb_dbtrap_t</span> <span class="n">db_result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">kdb_current</span> <span class="o">=</span>
		<span class="n">kdb_curr_task</span><span class="p">(</span><span class="n">raw_smp_processor_id</span><span class="p">());</span>

	<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_local 1&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="n">kdb_go_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">KDB_REASON_DEBUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* special case below */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Entering kdb (current=0x%p, pid %d) &quot;</span><span class="p">,</span>
			   <span class="n">kdb_current</span><span class="p">,</span> <span class="n">kdb_current</span> <span class="o">?</span> <span class="n">kdb_current</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_SMP)</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;on processor %d &quot;</span><span class="p">,</span> <span class="n">raw_smp_processor_id</span><span class="p">());</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KDB_REASON_DEBUG</span>:
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If re-entering kdb after a single step</span>
<span class="cm">		 * command, don&#39;t print the message.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">db_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">KDB_DB_BPT</span>:
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Entering kdb (0x%p, pid %d) &quot;</span><span class="p">,</span>
				   <span class="n">kdb_current</span><span class="p">,</span> <span class="n">kdb_current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_SMP)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;on processor %d &quot;</span><span class="p">,</span> <span class="n">raw_smp_processor_id</span><span class="p">());</span>
<span class="cp">#endif</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;due to Debug @ &quot;</span> <span class="n">kdb_machreg_fmt</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">instruction_pointer</span><span class="p">(</span><span class="n">regs</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KDB_DB_SSB</span>:
			<span class="cm">/*</span>
<span class="cm">			 * In the midst of ssb command. Just return.</span>
<span class="cm">			 */</span>
			<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_local 3&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">KDB_CMD_SSB</span><span class="p">;</span>	<span class="cm">/* Continue with SSB command */</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KDB_DB_SS</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KDB_DB_SSBPT</span>:
			<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_local 4&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* kdba_db_trap did the work */</span>
		<span class="nl">default:</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb: Bad result from kdba_db_trap: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">db_result</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KDB_REASON_ENTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">KEYBOARD</span><span class="p">))</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;due to Keyboard Entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;due to KDB_ENTER()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KDB_REASON_KEYBOARD</span>:
		<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">KEYBOARD</span><span class="p">);</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;due to Keyboard Entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KDB_REASON_ENTER_SLAVE</span>:
		<span class="cm">/* drop through, slaves only get released via cpu switch */</span>
	<span class="k">case</span> <span class="n">KDB_REASON_SWITCH</span>:
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;due to cpu switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KDB_REASON_OOPS</span>:
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Oops: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kdb_diemsg</span><span class="p">);</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;due to oops @ &quot;</span> <span class="n">kdb_machreg_fmt</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">instruction_pointer</span><span class="p">(</span><span class="n">regs</span><span class="p">));</span>
		<span class="n">kdb_dumpregs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KDB_REASON_NMI</span>:
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;due to NonMaskable Interrupt @ &quot;</span>
			   <span class="n">kdb_machreg_fmt</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">instruction_pointer</span><span class="p">(</span><span class="n">regs</span><span class="p">));</span>
		<span class="n">kdb_dumpregs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KDB_REASON_SSTEP</span>:
	<span class="k">case</span> <span class="n">KDB_REASON_BREAK</span>:
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;due to %s @ &quot;</span> <span class="n">kdb_machreg_fmt</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">reason</span> <span class="o">==</span> <span class="n">KDB_REASON_BREAK</span> <span class="o">?</span>
			   <span class="s">&quot;Breakpoint&quot;</span> <span class="o">:</span> <span class="s">&quot;SS trap&quot;</span><span class="p">,</span> <span class="n">instruction_pointer</span><span class="p">(</span><span class="n">regs</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * Determine if this breakpoint is one that we</span>
<span class="cm">		 * are interested in.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">db_result</span> <span class="o">!=</span> <span class="n">KDB_DB_BPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb: error return from kdba_bp_trap: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">db_result</span><span class="p">);</span>
			<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_local 6&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Not for us, dismiss it */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KDB_REASON_RECURSE</span>:
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;due to Recursion @ &quot;</span> <span class="n">kdb_machreg_fmt</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">instruction_pointer</span><span class="p">(</span><span class="n">regs</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb: unexpected reason code: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_local 8&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Not for us, dismiss it */</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Initialize pager context.</span>
<span class="cm">		 */</span>
		<span class="n">kdb_nextline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">KDB_STATE_CLEAR</span><span class="p">(</span><span class="n">SUPPRESS</span><span class="p">);</span>

		<span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cmd_cur</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">cmd_hist</span><span class="p">[</span><span class="n">cmd_head</span><span class="p">])</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">ONLY_DO_DUMP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* kdb is off but a catastrophic error requires a dump.</span>
<span class="cm">			 * Take the dump and reboot.</span>
<span class="cm">			 * Turn on logging so the kdb output appears in the log</span>
<span class="cm">			 * buffer in the dump.</span>
<span class="cm">			 */</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">setargs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;set&quot;</span><span class="p">,</span> <span class="s">&quot;LOGGING&quot;</span><span class="p">,</span> <span class="s">&quot;1&quot;</span> <span class="p">};</span>
			<span class="n">kdb_set</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setargs</span><span class="p">);</span>
			<span class="n">kdb_reboot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="cm">/*NOTREACHED*/</span>
		<span class="p">}</span>

<span class="nl">do_full_getstr:</span>
<span class="cp">#if defined(CONFIG_SMP)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">,</span> <span class="n">CMD_BUFLEN</span><span class="p">,</span> <span class="n">kdbgetenv</span><span class="p">(</span><span class="s">&quot;PROMPT&quot;</span><span class="p">),</span>
			 <span class="n">raw_smp_processor_id</span><span class="p">());</span>
<span class="cp">#else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">,</span> <span class="n">CMD_BUFLEN</span><span class="p">,</span> <span class="n">kdbgetenv</span><span class="p">(</span><span class="s">&quot;PROMPT&quot;</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">defcmd_in_progress</span><span class="p">)</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">kdb_prompt_str</span><span class="p">,</span> <span class="s">&quot;[defcmd]&quot;</span><span class="p">,</span> <span class="n">CMD_BUFLEN</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Fetch command from keyboard</span>
<span class="cm">		 */</span>
		<span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">kdb_getstr</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="n">CMD_BUFLEN</span><span class="p">,</span> <span class="n">kdb_prompt_str</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cmdbuf</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cmdbuf</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmdptr</span> <span class="o">==</span> <span class="n">cmd_head</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">strncpy</span><span class="p">(</span><span class="n">cmd_hist</span><span class="p">[</span><span class="n">cmd_head</span><span class="p">],</span> <span class="n">cmd_cur</span><span class="p">,</span>
						<span class="n">CMD_BUFLEN</span><span class="p">);</span>
					<span class="o">*</span><span class="p">(</span><span class="n">cmd_hist</span><span class="p">[</span><span class="n">cmd_head</span><span class="p">]</span> <span class="o">+</span>
					  <span class="n">strlen</span><span class="p">(</span><span class="n">cmd_hist</span><span class="p">[</span><span class="n">cmd_head</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle_ctrl_cmd</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">))</span>
					<span class="o">*</span><span class="p">(</span><span class="n">cmd_cur</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">cmd_cur</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cmd_cur</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">do_full_getstr</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">cmd_hist</span><span class="p">[</span><span class="n">cmd_head</span><span class="p">],</span> <span class="n">cmd_cur</span><span class="p">,</span>
					<span class="n">CMD_BUFLEN</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">cmd_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_head</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">KDB_CMD_HISTORY_COUNT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_head</span> <span class="o">==</span> <span class="n">cmd_tail</span><span class="p">)</span>
				<span class="n">cmd_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">KDB_CMD_HISTORY_COUNT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cmdptr</span> <span class="o">=</span> <span class="n">cmd_head</span><span class="p">;</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdb_parse</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span> <span class="o">==</span> <span class="n">KDB_NOTFOUND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Unknown kdb command: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">);</span>
			<span class="n">diag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span> <span class="o">==</span> <span class="n">KDB_CMD_GO</span>
		 <span class="o">||</span> <span class="n">diag</span> <span class="o">==</span> <span class="n">KDB_CMD_CPU</span>
		 <span class="o">||</span> <span class="n">diag</span> <span class="o">==</span> <span class="n">KDB_CMD_SS</span>
		 <span class="o">||</span> <span class="n">diag</span> <span class="o">==</span> <span class="n">KDB_CMD_SSB</span>
		 <span class="o">||</span> <span class="n">diag</span> <span class="o">==</span> <span class="n">KDB_CMD_KGDB</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
			<span class="n">kdb_cmderror</span><span class="p">(</span><span class="n">diag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_local 9&quot;</span><span class="p">,</span> <span class="n">diag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * kdb_print_state - Print the state data for the current processor</span>
<span class="cm"> *	for debugging.</span>
<span class="cm"> * Inputs:</span>
<span class="cm"> *	text		Identifies the debug point</span>
<span class="cm"> *	value		Any integer value to be printed, e.g. reason code.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">kdb_print_state</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;state: %s cpu %d value %d initial %d state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">text</span><span class="p">,</span> <span class="n">raw_smp_processor_id</span><span class="p">(),</span> <span class="n">value</span><span class="p">,</span> <span class="n">kdb_initial_cpu</span><span class="p">,</span>
		   <span class="n">kdb_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_main_loop - After initial setup and assignment of the</span>
<span class="cm"> *	controlling cpu, all cpus are in this loop.  One cpu is in</span>
<span class="cm"> *	control and will issue the kdb prompt, the others will spin</span>
<span class="cm"> *	until &#39;go&#39; or cpu switch.</span>
<span class="cm"> *</span>
<span class="cm"> *	To get a consistent view of the kernel stacks for all</span>
<span class="cm"> *	processes, this routine is invoked from the main kdb code via</span>
<span class="cm"> *	an architecture specific routine.  kdba_main_loop is</span>
<span class="cm"> *	responsible for making the kernel stacks consistent for all</span>
<span class="cm"> *	processes, there should be no difference between a blocked</span>
<span class="cm"> *	process and a running process as far as kdb is concerned.</span>
<span class="cm"> * Inputs:</span>
<span class="cm"> *	reason		The reason KDB was invoked</span>
<span class="cm"> *	error		The hardware-defined error code</span>
<span class="cm"> *	reason2		kdb&#39;s current reason code.</span>
<span class="cm"> *			Initially error but can change</span>
<span class="cm"> *			according to kdb state.</span>
<span class="cm"> *	db_result	Result code from break or debug point.</span>
<span class="cm"> *	regs		The exception frame at time of fault/breakpoint.</span>
<span class="cm"> *			should always be valid.</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	0	KDB was invoked for an event which it wasn&#39;t responsible</span>
<span class="cm"> *	1	KDB handled the event for which it was invoked.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kdb_main_loop</span><span class="p">(</span><span class="n">kdb_reason_t</span> <span class="n">reason</span><span class="p">,</span> <span class="n">kdb_reason_t</span> <span class="n">reason2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span>
	      <span class="n">kdb_dbtrap_t</span> <span class="n">db_result</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Stay in kdb() until &#39;go&#39;, &#39;ss[b]&#39; or an error */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * All processors except the one that is in control</span>
<span class="cm">		 * will spin here.</span>
<span class="cm">		 */</span>
		<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_main_loop 1&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">HOLD_CPU</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* state KDB is turned off by kdb_cpu to see if the</span>
<span class="cm">			 * other cpus are still live, each cpu in this loop</span>
<span class="cm">			 * turns it back on.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">KDB</span><span class="p">))</span>
				<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">KDB</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">KDB_STATE_CLEAR</span><span class="p">(</span><span class="n">SUPPRESS</span><span class="p">);</span>
		<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_main_loop 2&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">LEAVING</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Another cpu said &#39;go&#39; */</span>
		<span class="cm">/* Still using kdb, this processor is in control */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">kdb_local</span><span class="p">(</span><span class="n">reason2</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">db_result</span><span class="p">);</span>
		<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_main_loop 3&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">KDB_CMD_CPU</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">KDB_CMD_SS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">DOING_SS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">KDB_CMD_SSB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">DOING_SS</span><span class="p">);</span>
			<span class="n">KDB_STATE_SET</span><span class="p">(</span><span class="n">DOING_SSB</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">KDB_CMD_KGDB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">DOING_KGDB</span><span class="p">))</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Entering please attach debugger &quot;</span>
					   <span class="s">&quot;or use $D#44+ or $3#33</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">KDB_CMD_GO</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Unexpected kdb_local return code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">result</span><span class="p">);</span>
		<span class="n">KDB_DEBUG_STATE</span><span class="p">(</span><span class="s">&quot;kdb_main_loop 4&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">KDB_STATE</span><span class="p">(</span><span class="n">DOING_SS</span><span class="p">))</span>
		<span class="n">KDB_STATE_CLEAR</span><span class="p">(</span><span class="n">SSBPT</span><span class="p">);</span>

	<span class="cm">/* Clean up any keyboard devices before leaving */</span>
	<span class="n">kdb_kbd_cleanup_state</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_mdr - This function implements the guts of the &#39;mdr&#39;, memory</span>
<span class="cm"> * read command.</span>
<span class="cm"> *	mdr  &lt;addr arg&gt;,&lt;byte count&gt;</span>
<span class="cm"> * Inputs:</span>
<span class="cm"> *	addr	Start address</span>
<span class="cm"> *	count	Number of bytes</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	Always 0.  Any errors are detected and printed by kdb_getarea.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_mdr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdb_getarea</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">addr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_md - This function implements the &#39;md&#39;, &#39;md1&#39;, &#39;md2&#39;, &#39;md4&#39;,</span>
<span class="cm"> *	&#39;md8&#39; &#39;mdr&#39; and &#39;mds&#39; commands.</span>
<span class="cm"> *</span>
<span class="cm"> *	md|mds  [&lt;addr arg&gt; [&lt;line count&gt; [&lt;radix&gt;]]]</span>
<span class="cm"> *	mdWcN	[&lt;addr arg&gt; [&lt;line count&gt; [&lt;radix&gt;]]]</span>
<span class="cm"> *		where W = is the width (1, 2, 4 or 8) and N is the count.</span>
<span class="cm"> *		for eg., md1c20 reads 20 bytes, 1 at a time.</span>
<span class="cm"> *	mdr  &lt;addr arg&gt;,&lt;byte count&gt;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kdb_md_line</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmtstr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">symbolic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nosect</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytesperword</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">repeat</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* print just one line of data */</span>
	<span class="n">kdb_symtab_t</span> <span class="n">symtab</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">cbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">word</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cbuf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phys</span><span class="p">)</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;phys &quot;</span> <span class="n">kdb_machreg_fmt0</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="n">kdb_machreg_fmt0</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">repeat</span><span class="o">--</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phys</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kdb_getphysword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bytesperword</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kdb_getword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bytesperword</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="n">fmtstr</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">symbolic</span><span class="p">)</span>
			<span class="n">kdbnearsym</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symtab</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">symtab</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">symtab</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">symtab</span><span class="p">.</span><span class="n">sym_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_symbol_print</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symtab</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nosect</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;                       %s %s &quot;</span>
					   <span class="n">kdb_machreg_fmt</span> <span class="s">&quot; &quot;</span>
					   <span class="n">kdb_machreg_fmt</span> <span class="s">&quot; &quot;</span>
					   <span class="n">kdb_machreg_fmt</span><span class="p">,</span> <span class="n">symtab</span><span class="p">.</span><span class="n">mod_name</span><span class="p">,</span>
					   <span class="n">symtab</span><span class="p">.</span><span class="n">sec_name</span><span class="p">,</span> <span class="n">symtab</span><span class="p">.</span><span class="n">sec_start</span><span class="p">,</span>
					   <span class="n">symtab</span><span class="p">.</span><span class="n">sym_start</span><span class="p">,</span> <span class="n">symtab</span><span class="p">.</span><span class="n">sym_end</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">bytesperword</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">union</span> <span class="p">{</span>
				<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
			<span class="p">}</span> <span class="n">wc</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<span class="cp">#ifdef	__BIG_ENDIAN</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">wc</span><span class="p">.</span><span class="n">c</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">bytesperword</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">wc</span><span class="p">.</span><span class="n">c</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">wc</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="p">;</span>
<span class="cp">#define printable_char(c) \</span>
<span class="cp">	({unsigned char __c = c; isascii(__c) &amp;&amp; isprint(__c) ? __c : &#39;.&#39;; })</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperword</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">=</span> <span class="n">printable_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">);</span>
				<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">=</span> <span class="n">printable_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">);</span>
				<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">=</span> <span class="n">printable_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">);</span>
				<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">=</span> <span class="n">printable_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">);</span>
				<span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">=</span> <span class="n">printable_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">);</span>
				<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">=</span> <span class="n">printable_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">);</span>
				<span class="n">addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">=</span> <span class="n">printable_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">);</span>
				<span class="n">addr</span><span class="o">++</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">=</span> <span class="n">printable_char</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">);</span>
				<span class="n">addr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#undef printable_char</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%*s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">num</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">bytesperword</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
		   <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">cbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_md</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">last_radix</span><span class="p">,</span> <span class="n">last_bytesperword</span><span class="p">,</span> <span class="n">last_repeat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">radix</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">mdcount</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">bytesperword</span> <span class="o">=</span> <span class="n">KDB_WORD_SIZE</span><span class="p">,</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nosect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">fmtchar</span><span class="p">,</span> <span class="n">fmtstr</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">symbolic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kdbgetintenv</span><span class="p">(</span><span class="s">&quot;MDCOUNT&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdcount</span><span class="p">);</span>
	<span class="n">kdbgetintenv</span><span class="p">(</span><span class="s">&quot;RADIX&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radix</span><span class="p">);</span>
	<span class="n">kdbgetintenv</span><span class="p">(</span><span class="s">&quot;BYTESPERWORD&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytesperword</span><span class="p">);</span>

	<span class="cm">/* Assume &#39;md &lt;addr&gt;&#39; and start with environment values */</span>
	<span class="n">repeat</span> <span class="o">=</span> <span class="n">mdcount</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">bytesperword</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;mdr&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">bytesperword</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytesperword</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytesperword</span> <span class="o">=</span> <span class="n">last_bytesperword</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bytesperword</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">bytesperword</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last_bytesperword</span> <span class="o">=</span> <span class="n">bytesperword</span><span class="p">;</span>
		<span class="n">repeat</span> <span class="o">=</span> <span class="n">mdcount</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">bytesperword</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;c&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="n">repeat</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">mdcount</span> <span class="o">=</span> <span class="p">((</span><span class="n">repeat</span> <span class="o">*</span> <span class="n">bytesperword</span><span class="p">)</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="o">!*</span><span class="n">p</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last_repeat</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;md&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;mds&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;mdp&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys</span> <span class="o">=</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_NOTFOUND</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">last_addr</span><span class="p">;</span>
		<span class="n">radix</span> <span class="o">=</span> <span class="n">last_radix</span><span class="p">;</span>
		<span class="n">bytesperword</span> <span class="o">=</span> <span class="n">last_bytesperword</span><span class="p">;</span>
		<span class="n">repeat</span> <span class="o">=</span> <span class="n">last_repeat</span><span class="p">;</span>
		<span class="n">mdcount</span> <span class="o">=</span> <span class="p">((</span><span class="n">repeat</span> <span class="o">*</span> <span class="n">bytesperword</span><span class="p">)</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">diag</span><span class="p">,</span> <span class="n">nextarg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetaddrarg</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nextarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="n">nextarg</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="n">nextarg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetularg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">nextarg</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mdcount</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
				<span class="n">repeat</span> <span class="o">=</span> <span class="n">mdcount</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">bytesperword</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="n">nextarg</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetularg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">nextarg</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diag</span><span class="p">)</span>
				<span class="n">radix</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;mdr&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">kdb_mdr</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">mdcount</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">radix</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">fmtchar</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">fmtchar</span> <span class="o">=</span> <span class="sc">&#39;x&#39;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">fmtchar</span> <span class="o">=</span> <span class="sc">&#39;o&#39;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">KDB_BADRADIX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">last_radix</span> <span class="o">=</span> <span class="n">radix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytesperword</span> <span class="o">&gt;</span> <span class="n">KDB_WORD_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_BADWIDTH</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperword</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">fmtstr</span><span class="p">,</span> <span class="s">&quot;%%16.16l%c &quot;</span><span class="p">,</span> <span class="n">fmtchar</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">fmtstr</span><span class="p">,</span> <span class="s">&quot;%%8.8l%c &quot;</span><span class="p">,</span> <span class="n">fmtchar</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">fmtstr</span><span class="p">,</span> <span class="s">&quot;%%4.4l%c &quot;</span><span class="p">,</span> <span class="n">fmtchar</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">fmtstr</span><span class="p">,</span> <span class="s">&quot;%%2.2l%c &quot;</span><span class="p">,</span> <span class="n">fmtchar</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">KDB_BADWIDTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">last_repeat</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="n">last_bytesperword</span> <span class="o">=</span> <span class="n">bytesperword</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;mds&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">symbolic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Do not save these changes as last_*, they are temporary mds</span>
<span class="cm">		 * overrides.</span>
<span class="cm">		 */</span>
		<span class="n">bytesperword</span> <span class="o">=</span> <span class="n">KDB_WORD_SIZE</span><span class="p">;</span>
		<span class="n">repeat</span> <span class="o">=</span> <span class="n">mdcount</span><span class="p">;</span>
		<span class="n">kdbgetintenv</span><span class="p">(</span><span class="s">&quot;NOSECT&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nosect</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Round address down modulo BYTESPERWORD */</span>

	<span class="n">addr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">bytesperword</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">repeat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbolic</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="mi">16</span> <span class="o">/</span> <span class="n">bytesperword</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">addr</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">repeat</span><span class="p">;</span> <span class="n">a</span> <span class="o">+=</span> <span class="n">bytesperword</span><span class="p">,</span> <span class="o">++</span><span class="n">z</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phys</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">kdb_getphysword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">bytesperword</span><span class="p">)</span>
						<span class="o">||</span> <span class="n">word</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kdb_getword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">bytesperword</span><span class="p">)</span> <span class="o">||</span> <span class="n">word</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">repeat</span><span class="p">);</span>
		<span class="n">kdb_md_line</span><span class="p">(</span><span class="n">fmtstr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">symbolic</span><span class="p">,</span> <span class="n">nosect</span><span class="p">,</span> <span class="n">bytesperword</span><span class="p">,</span>
			    <span class="n">num</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">phys</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">bytesperword</span> <span class="o">*</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">repeat</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">num</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="n">kdb_machreg_fmt0</span> <span class="s">&quot;-&quot;</span> <span class="n">kdb_machreg_fmt0</span>
				   <span class="s">&quot; zero suppressed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">addr</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">bytesperword</span> <span class="o">*</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">bytesperword</span> <span class="o">*</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">repeat</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">last_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_mm - This function implements the &#39;mm&#39; command.</span>
<span class="cm"> *	mm address-expression new-value</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> *	mm works on machine words, mmW works on bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_mm</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">contents</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nextarg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">KDB_NOTFOUND</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">nextarg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetaddrarg</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nextarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nextarg</span> <span class="o">&gt;</span> <span class="n">argc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>
	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetaddrarg</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nextarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">contents</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nextarg</span> <span class="o">!=</span> <span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">KDB_WORD_SIZE</span><span class="p">);</span>
	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdb_putword</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="n">kdb_printf</span><span class="p">(</span><span class="n">kdb_machreg_fmt</span> <span class="s">&quot; = &quot;</span> <span class="n">kdb_machreg_fmt</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">contents</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_go - This function implements the &#39;go&#39; command.</span>
<span class="cm"> *	go [address-expression]</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_go</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nextarg</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raw_smp_processor_id</span><span class="p">()</span> <span class="o">!=</span> <span class="n">kdb_initial_cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;go must execute on the entry cpu, &quot;</span>
			   <span class="s">&quot;please use </span><span class="se">\&quot;</span><span class="s">cpu %d</span><span class="se">\&quot;</span><span class="s"> and then execute go</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">kdb_initial_cpu</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">KDB_BADCPUNUM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextarg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetaddrarg</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nextarg</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">KDB_CMD_GO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">CATASTROPHIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Catastrophic error detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb_continue_catastrophic=%d, &quot;</span><span class="p">,</span>
			<span class="n">kdb_continue_catastrophic</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdb_continue_catastrophic</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">kdb_go_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;type go a second time if you really want &quot;</span>
				   <span class="s">&quot;to continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdb_continue_catastrophic</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;forcing reboot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kdb_reboot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;attempting to continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_rd - This function implements the &#39;rd&#39; command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_rd</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">kdb_check_regs</span><span class="p">();</span>
<span class="cp">#if DBG_MAX_REG_NUM &gt; 0</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rsize</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reg64</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg16</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DBG_MAX_REG_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsize</span> <span class="o">=</span> <span class="n">dbg_reg_def</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsize</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">rsize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dbg_reg_def</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">rsize</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">);</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">dbg_reg_def</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">rname</span> <span class="o">=</span> <span class="n">dbg_get_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg8</span><span class="p">,</span> <span class="n">kdb_current_regs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rname</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s: %02x&quot;</span><span class="p">,</span> <span class="n">rname</span><span class="p">,</span> <span class="n">reg8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">rname</span> <span class="o">=</span> <span class="n">dbg_get_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg16</span><span class="p">,</span> <span class="n">kdb_current_regs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rname</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s: %04x&quot;</span><span class="p">,</span> <span class="n">rname</span><span class="p">,</span> <span class="n">reg16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">rname</span> <span class="o">=</span> <span class="n">dbg_get_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg32</span><span class="p">,</span> <span class="n">kdb_current_regs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rname</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s: %08x&quot;</span><span class="p">,</span> <span class="n">rname</span><span class="p">,</span> <span class="n">reg32</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64</span>:
			<span class="n">rname</span> <span class="o">=</span> <span class="n">dbg_get_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg64</span><span class="p">,</span> <span class="n">kdb_current_regs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rname</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s: %016llx&quot;</span><span class="p">,</span> <span class="n">rname</span><span class="p">,</span> <span class="n">reg64</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s: ??&quot;</span><span class="p">,</span> <span class="n">dbg_reg_def</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">kdb_dumpregs</span><span class="p">(</span><span class="n">kdb_current_regs</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_rm - This function implements the &#39;rm&#39; (register modify)  command.</span>
<span class="cm"> *	rm register-name new-contents</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> *	Allows register modification with the same restrictions as gdb</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_rm</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if DBG_MAX_REG_NUM &gt; 0</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reg64</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg16</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allow presence or absence of leading &#39;%&#39; symbol.</span>
<span class="cm">	 */</span>
	<span class="n">rname</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">rname</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span>
		<span class="n">rname</span><span class="o">++</span><span class="p">;</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetu64arg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">reg64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdb_check_regs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">KDB_BADREG</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DBG_MAX_REG_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">rname</span><span class="p">,</span> <span class="n">dbg_reg_def</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">dbg_reg_def</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">reg8</span> <span class="o">=</span> <span class="n">reg64</span><span class="p">;</span>
			<span class="n">dbg_set_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg8</span><span class="p">,</span> <span class="n">kdb_current_regs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">reg16</span> <span class="o">=</span> <span class="n">reg64</span><span class="p">;</span>
			<span class="n">dbg_set_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg16</span><span class="p">,</span> <span class="n">kdb_current_regs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">reg32</span> <span class="o">=</span> <span class="n">reg64</span><span class="p">;</span>
			<span class="n">dbg_set_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg32</span><span class="p">,</span> <span class="n">kdb_current_regs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64</span>:
			<span class="n">dbg_set_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg64</span><span class="p">,</span> <span class="n">kdb_current_regs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;ERROR: Register set currently not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_MAGIC_SYSRQ)</span>
<span class="cm">/*</span>
<span class="cm"> * kdb_sr - This function implements the &#39;sr&#39; (SYSRQ key) command</span>
<span class="cm"> *	which interfaces to the soi-disant MAGIC SYSRQ functionality.</span>
<span class="cm"> *		sr &lt;magic-sysrq-code&gt;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_sr</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>
	<span class="n">kdb_trap_printk</span><span class="o">++</span><span class="p">;</span>
	<span class="n">__handle_sysrq</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">kdb_trap_printk</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_MAGIC_SYSRQ */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * kdb_ef - This function implements the &#39;regs&#39; (display exception</span>
<span class="cm"> *	frame) command.  This command takes an address and expects to</span>
<span class="cm"> *	find an exception frame at that address, formats and prints</span>
<span class="cm"> *	it.</span>
<span class="cm"> *		regs address-expression</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> *	Not done yet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_ef</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nextarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">nextarg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetaddrarg</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nextarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
	<span class="n">show_regs</span><span class="p">((</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_MODULES)</span>
<span class="cm">/*</span>
<span class="cm"> * kdb_lsmod - This function implements the &#39;lsmod&#39; command.  Lists</span>
<span class="cm"> *	currently loaded kernel modules.</span>
<span class="cm"> *	Mostly taken from userland lsmod.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_lsmod</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Module                  Size  modstruct     Used by</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">kdb_modules</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%-20s%8u  0x%p &quot;</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">mod</span><span class="o">-&gt;</span><span class="n">core_size</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mod</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MODULE_UNLOAD</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%4ld &quot;</span><span class="p">,</span> <span class="n">module_refcount</span><span class="p">(</span><span class="n">mod</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MODULE_STATE_GOING</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot; (Unloading)&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MODULE_STATE_COMING</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot; (Loading)&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot; (Live)&quot;</span><span class="p">);</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot; 0x%p&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">module_core</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MODULE_UNLOAD</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">module_use</span> <span class="o">*</span><span class="n">use</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot; [ &quot;</span><span class="p">);</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">use</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">source_list</span><span class="p">,</span>
					    <span class="n">source_list</span><span class="p">)</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">use</span><span class="o">-&gt;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_MODULES */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * kdb_env - This function implements the &#39;env&#39; command.  Display the</span>
<span class="cm"> *	current environment variables.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_env</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__nenv</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__env</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__env</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">KDB_DEBUG</span><span class="p">(</span><span class="n">MASK</span><span class="p">))</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;KDBFLAGS=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kdb_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PRINTK</span>
<span class="cm">/*</span>
<span class="cm"> * kdb_dmesg - This function implements the &#39;dmesg&#39; command to display</span>
<span class="cm"> *	the contents of the syslog buffer.</span>
<span class="cm"> *		dmesg [lines] [adjust]</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_dmesg</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">syslog_data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">,</span> <span class="n">logging</span><span class="p">,</span> <span class="n">logsize</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">adjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
		<span class="n">lines</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span>
			<span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adjust</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">||</span> <span class="n">adjust</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">adjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* disable LOGGING if set */</span>
	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetintenv</span><span class="p">(</span><span class="s">&quot;LOGGING&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logging</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diag</span> <span class="o">&amp;&amp;</span> <span class="n">logging</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">setargs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;set&quot;</span><span class="p">,</span> <span class="s">&quot;LOGGING&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span> <span class="p">};</span>
		<span class="n">kdb_set</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setargs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* syslog_data[0,1] physical start, end+1.  syslog_data[2,3]</span>
<span class="cm">	 * logical start, end+1. */</span>
	<span class="n">kdb_syslog_data</span><span class="p">(</span><span class="n">syslog_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">syslog_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">syslog_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">logsize</span> <span class="o">=</span> <span class="n">syslog_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">syslog_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">syslog_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">syslog_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="cp">#define KDB_WRAP(p) (((p - syslog_data[0]) % logsize) + syslog_data[0])</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">KDB_WRAP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="o">++</span><span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="o">++</span><span class="n">n</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjust</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;buffer only contains %d lines, nothing &quot;</span>
				   <span class="s">&quot;printed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adjust</span> <span class="o">-</span> <span class="n">lines</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;buffer only contains %d lines, last %d &quot;</span>
				   <span class="s">&quot;lines printed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">adjust</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjust</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">adjust</span><span class="p">;</span> <span class="o">++</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">KDB_WRAP</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
					<span class="o">--</span><span class="n">adjust</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">++</span><span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">lines</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">KDB_WRAP</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
				<span class="o">++</span><span class="n">lines</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">adjust</span> <span class="o">+</span> <span class="n">lines</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjust</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;buffer only contains %d lines, &quot;</span>
				   <span class="s">&quot;nothing printed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="n">skip</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lines</span> <span class="o">+=</span> <span class="n">skip</span><span class="p">;</span>
			<span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;buffer only contains %d lines, first &quot;</span>
				   <span class="s">&quot;%d lines printed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">lines</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">skip</span><span class="p">;</span> <span class="o">++</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">KDB_WRAP</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
				<span class="o">--</span><span class="n">skip</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">lines</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">KDB_WRAP</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
				<span class="o">--</span><span class="n">lines</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Do a line at a time (max 200 chars) to reduce protocol overhead */</span>
	<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">201</span><span class="p">];</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">KDB_WRAP</span><span class="p">(</span><span class="n">start</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">start</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PRINTK */</span><span class="cp"></span>
<span class="cm">/*</span>
<span class="cm"> * kdb_cpu - This function implements the &#39;cpu&#39; command.</span>
<span class="cm"> *	cpu	[&lt;cpunum&gt;]</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	KDB_CMD_CPU for success, a kdb diagnostic if error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kdb_cpu_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">start_cpu</span><span class="p">,</span> <span class="n">first_print</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">state</span><span class="p">,</span> <span class="n">prev_state</span> <span class="o">=</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>

	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Currently on cpu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_smp_processor_id</span><span class="p">());</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Available cpus: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">start_cpu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CPUS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">state</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>	<span class="cm">/* cpu is offline */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">state</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>	<span class="cm">/* cpu is responding to kdb */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kdb_task_state_char</span><span class="p">(</span><span class="n">KDB_TSK</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="sc">&#39;I&#39;</span><span class="p">)</span>
				<span class="n">state</span> <span class="o">=</span> <span class="sc">&#39;I&#39;</span><span class="p">;</span>	<span class="cm">/* idle task */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">prev_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev_state</span> <span class="o">!=</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_print</span><span class="p">)</span>
					<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
				<span class="n">first_print</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">start_cpu</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">start_cpu</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;-%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prev_state</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
					<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;(%c)&quot;</span><span class="p">,</span> <span class="n">prev_state</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">prev_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
			<span class="n">start_cpu</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* print the trailing cpus, ignoring them if they are all offline */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_state</span> <span class="o">!=</span> <span class="sc">&#39;F&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_print</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">start_cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start_cpu</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;-%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev_state</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;(%c)&quot;</span><span class="p">,</span> <span class="n">prev_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_cpu</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpunum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_cpu_status</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetularg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cpunum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate cpunum</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cpunum</span> <span class="o">&gt;</span> <span class="n">NR_CPUS</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">cpunum</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">KDB_BADCPUNUM</span><span class="p">;</span>

	<span class="n">dbg_switch_cpu</span> <span class="o">=</span> <span class="n">cpunum</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Switch to other cpu</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">KDB_CMD_CPU</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The user may not realize that ps/bta with no parameters does not print idle</span>
<span class="cm"> * or sleeping system daemon processes, so tell them how many were suppressed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">kdb_ps_suppressed</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">daemon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask_I</span> <span class="o">=</span> <span class="n">kdb_task_state_string</span><span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">),</span>
		      <span class="n">mask_M</span> <span class="o">=</span> <span class="n">kdb_task_state_string</span><span class="p">(</span><span class="s">&quot;M&quot;</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">g</span><span class="p">;</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">kdb_curr_task</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdb_task_state</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mask_I</span><span class="p">))</span>
			<span class="o">++</span><span class="n">idle</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kdb_do_each_thread</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdb_task_state</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mask_M</span><span class="p">))</span>
			<span class="o">++</span><span class="n">daemon</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">kdb_while_each_thread</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idle</span> <span class="o">||</span> <span class="n">daemon</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idle</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%d idle process%s (state I)%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">idle</span><span class="p">,</span> <span class="n">idle</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;es&quot;</span><span class="p">,</span>
				   <span class="n">daemon</span> <span class="o">?</span> <span class="s">&quot; and &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">daemon</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%d sleeping system daemon (state M) &quot;</span>
				   <span class="s">&quot;process%s&quot;</span><span class="p">,</span> <span class="n">daemon</span><span class="p">,</span>
				   <span class="n">daemon</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;es&quot;</span><span class="p">);</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot; suppressed,</span><span class="se">\n</span><span class="s">use &#39;ps A&#39; to see all.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_ps - This function implements the &#39;ps&#39; command which shows a</span>
<span class="cm"> *	list of the active processes.</span>
<span class="cm"> *		ps [DRSTCZEUIMA]   All processes, optionally filtered by state</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">kdb_ps1</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="n">probe_kernel_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">kdb_process_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;0x%p %8d %8d  %d %4d   %c  0x%p %c%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
		   <span class="n">kdb_task_has_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">kdb_process_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
		   <span class="n">kdb_task_state_char</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">),</span>
		   <span class="n">p</span> <span class="o">==</span> <span class="n">kdb_curr_task</span><span class="p">(</span><span class="n">raw_smp_processor_id</span><span class="p">())</span> <span class="o">?</span> <span class="sc">&#39;*&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
		   <span class="n">p</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kdb_task_has_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">KDB_TSK</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;  Error: no saved data for this cpu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">KDB_TSK</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="o">!=</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;  Error: does not match running &quot;</span>
				   <span class="s">&quot;process table (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">KDB_TSK</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_ps</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">,</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kdb_ps_suppressed</span><span class="p">();</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%-*s      Pid   Parent [*] cpu State %-*s Command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Task Addr&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Thread&quot;</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">kdb_task_state_string</span><span class="p">(</span><span class="n">argc</span> <span class="o">?</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* Run the active tasks first */</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">kdb_curr_task</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdb_task_state</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
			<span class="n">kdb_ps1</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Now the real tasks */</span>
	<span class="n">kdb_do_each_thread</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdb_task_state</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
			<span class="n">kdb_ps1</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">kdb_while_each_thread</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_pid - This function implements the &#39;pid&#39; command which switches</span>
<span class="cm"> *	the currently active process.</span>
<span class="cm"> *		pid [&lt;pid&gt; | R]</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_pid</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;R&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">KDB_TSK</span><span class="p">(</span><span class="n">kdb_initial_cpu</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetularg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">KDB_BADINT</span><span class="p">;</span>

			<span class="n">p</span> <span class="o">=</span> <span class="n">find_task_by_pid_ns</span><span class="p">((</span><span class="n">pid_t</span><span class="p">)</span><span class="n">val</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">init_pid_ns</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;No task with pid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pid_t</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kdb_set_current_task</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;KDB current process is %s(pid=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">kdb_current_task</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span>
		   <span class="n">kdb_current_task</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_ll - This function implements the &#39;ll&#39; command which follows a</span>
<span class="cm"> *	linked list and executes an arbitrary command for each</span>
<span class="cm"> *	element.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_ll</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">diag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">linkoffset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nextarg</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">nextarg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetaddrarg</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nextarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetularg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">linkoffset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Using the starting address as</span>
<span class="cm">	 * the first element in the list, and assuming that</span>
<span class="cm">	 * the list ends with a null pointer.</span>
<span class="cm">	 */</span>

	<span class="n">va</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">command</span> <span class="o">=</span> <span class="n">kdb_strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">GFP_KDB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%s: cannot duplicate command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Recursive use of kdb_parse, do not use argv after this point */</span>
	<span class="n">argv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span> <span class="n">kdb_machreg_fmt</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdb_parse</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">va</span> <span class="o">+</span> <span class="n">linkoffset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdb_getword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">va</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">va</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_kgdb</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">KDB_CMD_KGDB</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_help - This function implements the &#39;help&#39; and &#39;?&#39; commands.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_help</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kdbtab_t</span> <span class="o">*</span><span class="n">kt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%-15.15s %-20.20s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Command&quot;</span><span class="p">,</span> <span class="s">&quot;Usage&quot;</span><span class="p">,</span> <span class="s">&quot;Description&quot;</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;-----------------------------&quot;</span>
		   <span class="s">&quot;-----------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">for_each_kdbcmd</span><span class="p">(</span><span class="n">kt</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kt</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%-15.15s %-20.20s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kt</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">,</span>
				   <span class="n">kt</span><span class="o">-&gt;</span><span class="n">cmd_usage</span><span class="p">,</span> <span class="n">kt</span><span class="o">-&gt;</span><span class="n">cmd_help</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_kill - This function implements the &#39;kill&#39; commands.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_kill</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">sig</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">sig</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">endp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_BADINT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Invalid signal parameter.&lt;-signal&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sig</span> <span class="o">=</span> <span class="o">-</span><span class="n">sig</span><span class="p">;</span>

	<span class="n">pid</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">endp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_BADINT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Process ID must be large than 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find the process. */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">find_task_by_pid_ns</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_pid_ns</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;The specified process isn&#39;t found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">sig</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SI_USER</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>  <span class="cm">/* same capabilities as process being signalled */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_uid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* kdb has root authority */</span>
	<span class="n">kdb_send_sig_info</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kdb_tm</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">tm_sec</span><span class="p">;</span>	<span class="cm">/* seconds */</span>
	<span class="kt">int</span> <span class="n">tm_min</span><span class="p">;</span>	<span class="cm">/* minutes */</span>
	<span class="kt">int</span> <span class="n">tm_hour</span><span class="p">;</span>	<span class="cm">/* hours */</span>
	<span class="kt">int</span> <span class="n">tm_mday</span><span class="p">;</span>	<span class="cm">/* day of the month */</span>
	<span class="kt">int</span> <span class="n">tm_mon</span><span class="p">;</span>	<span class="cm">/* month */</span>
	<span class="kt">int</span> <span class="n">tm_year</span><span class="p">;</span>	<span class="cm">/* year */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kdb_gmtime</span><span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kdb_tm</span> <span class="o">*</span><span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This will work from 1970-2099, 2100 is not a leap year */</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">mon_day</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
				 <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span> <span class="p">};</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tm</span><span class="p">));</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span>  <span class="o">=</span> <span class="n">tv</span><span class="o">-&gt;</span><span class="n">tv_sec</span> <span class="o">%</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">);</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">tv</span><span class="o">-&gt;</span><span class="n">tv_sec</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* shift base from 1970 to 1968 */</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_min</span> <span class="o">=</span>  <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span> <span class="o">=</span>  <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">=</span> <span class="mi">68</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">365</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">%=</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">365</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mon_day</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">29</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">&gt;=</span> <span class="n">mon_day</span><span class="p">[</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">-=</span> <span class="n">mon_day</span><span class="p">[</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">++</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="p">;</span>
			<span class="n">mon_day</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">++</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Most of this code has been lifted from kernel/timer.c::sys_sysinfo().</span>
<span class="cm"> * I cannot call that code directly from kdb, it has an unconditional</span>
<span class="cm"> * cli()/sti() and calls routines that take locks which can stop the debugger.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kdb_sysinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">sysinfo</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">uptime</span><span class="p">;</span>
	<span class="n">do_posix_clock_monotonic_gettime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uptime</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">));</span>
	<span class="n">val</span><span class="o">-&gt;</span><span class="n">uptime</span> <span class="o">=</span> <span class="n">uptime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">val</span><span class="o">-&gt;</span><span class="n">loads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">avenrun</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">val</span><span class="o">-&gt;</span><span class="n">loads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">avenrun</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">val</span><span class="o">-&gt;</span><span class="n">loads</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">avenrun</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">val</span><span class="o">-&gt;</span><span class="n">procs</span> <span class="o">=</span> <span class="n">nr_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">si_meminfo</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_summary - This function implements the &#39;summary&#39; command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_summary</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">now</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kdb_tm</span> <span class="n">tm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sysinfo</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;sysname    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init_uts_ns</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">sysname</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;release    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init_uts_ns</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">release</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;version    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init_uts_ns</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;machine    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init_uts_ns</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">machine</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;nodename   %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init_uts_ns</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">nodename</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;domainname %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init_uts_ns</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">domainname</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;ccversion  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">CCVERSION</span><span class="p">));</span>

	<span class="n">now</span> <span class="o">=</span> <span class="n">__current_kernel_time</span><span class="p">();</span>
	<span class="n">kdb_gmtime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;date       %04d-%02d-%02d %02d:%02d:%02d &quot;</span>
		   <span class="s">&quot;tz_minuteswest %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="mi">1900</span><span class="o">+</span><span class="n">tm</span><span class="p">.</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">,</span>
		<span class="n">tm</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">,</span>
		<span class="n">sys_tz</span><span class="p">.</span><span class="n">tz_minuteswest</span><span class="p">);</span>

	<span class="n">kdb_sysinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;uptime     &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">uptime</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">days</span> <span class="o">=</span> <span class="n">val</span><span class="p">.</span><span class="n">uptime</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">);</span>
		<span class="n">val</span><span class="p">.</span><span class="n">uptime</span> <span class="o">%=</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">);</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%d day%s &quot;</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span> <span class="n">days</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;s&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%02ld:%02ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">.</span><span class="n">uptime</span><span class="o">/</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">),</span> <span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">uptime</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">%</span><span class="mi">60</span><span class="p">);</span>

	<span class="cm">/* lifted from fs/proc/proc_misc.c::loadavg_read_proc() */</span>

<span class="cp">#define LOAD_INT(x) ((x) &gt;&gt; FSHIFT)</span>
<span class="cp">#define LOAD_FRAC(x) LOAD_INT(((x) &amp; (FIXED_1-1)) * 100)</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;load avg   %ld.%02ld %ld.%02ld %ld.%02ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">LOAD_INT</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">loads</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">LOAD_FRAC</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">loads</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		<span class="n">LOAD_INT</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">loads</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">LOAD_FRAC</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">loads</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
		<span class="n">LOAD_INT</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">loads</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">LOAD_FRAC</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">loads</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
<span class="cp">#undef LOAD_INT</span>
<span class="cp">#undef LOAD_FRAC</span>
	<span class="cm">/* Display in kilobytes */</span>
<span class="cp">#define K(x) ((x) &lt;&lt; (PAGE_SHIFT - 10))</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">MemTotal:       %8lu kB</span><span class="se">\n</span><span class="s">MemFree:        %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Buffers:        %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">val</span><span class="p">.</span><span class="n">totalram</span><span class="p">,</span> <span class="n">val</span><span class="p">.</span><span class="n">freeram</span><span class="p">,</span> <span class="n">val</span><span class="p">.</span><span class="n">bufferram</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_per_cpu - This function implements the &#39;per_cpu&#39; command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_per_cpu</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">fmtstr</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">diag</span><span class="p">,</span> <span class="n">nextarg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">symaddr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bytesperword</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">whichcpu</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_ARGCOUNT</span><span class="p">;</span>

	<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetaddrarg</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nextarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symaddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetularg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bytesperword</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bytesperword</span><span class="p">)</span>
		<span class="n">bytesperword</span> <span class="o">=</span> <span class="n">KDB_WORD_SIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bytesperword</span> <span class="o">&gt;</span> <span class="n">KDB_WORD_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">KDB_BADWIDTH</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">fmtstr</span><span class="p">,</span> <span class="s">&quot;%%0%dlx &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">2</span><span class="o">*</span><span class="n">bytesperword</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdbgetularg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">whichcpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">diag</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">whichcpu</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;cpu %ld is not online</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">whichcpu</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">KDB_BADCPUNUM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Most architectures use __per_cpu_offset[cpu], some use</span>
<span class="cm">	 * __per_cpu_offset(cpu), smp has no __per_cpu_offset.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef	__per_cpu_offset</span>
<span class="cp">#define KDB_PCU(cpu) __per_cpu_offset(cpu)</span>
<span class="cp">#else</span>
<span class="cp">#ifdef	CONFIG_SMP</span>
<span class="cp">#define KDB_PCU(cpu) __per_cpu_offset[cpu]</span>
<span class="cp">#else</span>
<span class="cp">#define KDB_PCU(cpu) 0</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">KDB_FLAG</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">whichcpu</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0UL</span> <span class="o">&amp;&amp;</span> <span class="n">whichcpu</span> <span class="o">!=</span> <span class="n">cpu</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">symaddr</span> <span class="o">+</span> <span class="n">KDB_PCU</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdb_getword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bytesperword</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%5d &quot;</span> <span class="n">kdb_bfd_vma_fmt0</span> <span class="s">&quot; - unable to &quot;</span>
				   <span class="s">&quot;read, diag=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">diag</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;%5d &quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">kdb_md_line</span><span class="p">(</span><span class="n">fmtstr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			<span class="n">bytesperword</span> <span class="o">==</span> <span class="n">KDB_WORD_SIZE</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span> <span class="n">bytesperword</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#undef KDB_PCU</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * display help for the use of cmd | grep pattern</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdb_grep_help</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Usage of  cmd args | grep pattern:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;  Any command&#39;s output may be filtered through an &quot;</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;emulated &#39;pipe&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;  &#39;grep&#39; is just a key word.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;  The pattern may include a very limited set of &quot;</span>
		   <span class="s">&quot;metacharacters:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;   pattern or ^pattern or pattern$ or ^pattern$</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;  And if there are spaces in the pattern, you may &quot;</span>
		   <span class="s">&quot;quote it:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;   </span><span class="se">\&quot;</span><span class="s">pat tern</span><span class="se">\&quot;</span><span class="s"> or </span><span class="se">\&quot;</span><span class="s">^pat tern</span><span class="se">\&quot;</span><span class="s"> or </span><span class="se">\&quot;</span><span class="s">pat tern$</span><span class="se">\&quot;</span><span class="s">&quot;</span>
		   <span class="s">&quot; or </span><span class="se">\&quot;</span><span class="s">^pat tern$</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_register_repeat - This function is used to register a kernel</span>
<span class="cm"> * 	debugger command.</span>
<span class="cm"> * Inputs:</span>
<span class="cm"> *	cmd	Command name</span>
<span class="cm"> *	func	Function to execute the command</span>
<span class="cm"> *	usage	A simple usage string showing arguments</span>
<span class="cm"> *	help	A simple help string describing command</span>
<span class="cm"> *	repeat	Does the command auto repeat on enter?</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	zero for success, one if a duplicate command.</span>
<span class="cm"> */</span>
<span class="cp">#define kdb_command_extend 50	</span><span class="cm">/* arbitrary */</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">kdb_register_repeat</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			<span class="n">kdb_func_t</span> <span class="n">func</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">help</span><span class="p">,</span>
			<span class="kt">short</span> <span class="n">minlen</span><span class="p">,</span>
			<span class="n">kdb_repeat_t</span> <span class="n">repeat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">kdbtab_t</span> <span class="o">*</span><span class="n">kp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Brute force method to determine duplicates</span>
<span class="cm">	 */</span>
	<span class="n">for_each_kdbcmd</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Duplicate kdb command registered: &quot;</span>
				<span class="s">&quot;%s, func %p help %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">help</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Insert command into first available location in table</span>
<span class="cm">	 */</span>
	<span class="n">for_each_kdbcmd</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">kdb_max_commands</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdbtab_t</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">kdb_max_commands</span> <span class="o">-</span> <span class="n">KDB_BASE_CMD_MAX</span> <span class="o">+</span>
			 <span class="n">kdb_command_extend</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">),</span> <span class="n">GFP_KDB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Could not allocate new kdb_command &quot;</span>
				   <span class="s">&quot;table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdb_commands</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">kdb_commands</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">kdb_max_commands</span> <span class="o">-</span> <span class="n">KDB_BASE_CMD_MAX</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">kdb_commands</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">new</span> <span class="o">+</span> <span class="n">kdb_max_commands</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">kdb_command_extend</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">));</span>
		<span class="n">kdb_commands</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">kp</span> <span class="o">=</span> <span class="n">kdb_commands</span> <span class="o">+</span> <span class="n">kdb_max_commands</span> <span class="o">-</span> <span class="n">KDB_BASE_CMD_MAX</span><span class="p">;</span>
		<span class="n">kdb_max_commands</span> <span class="o">+=</span> <span class="n">kdb_command_extend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_name</span>   <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_func</span>   <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_usage</span>  <span class="o">=</span> <span class="n">usage</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_help</span>   <span class="o">=</span> <span class="n">help</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_flags</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_minlen</span> <span class="o">=</span> <span class="n">minlen</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_repeat</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">kdb_register_repeat</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * kdb_register - Compatibility register function for commands that do</span>
<span class="cm"> *	not need to specify a repeat state.  Equivalent to</span>
<span class="cm"> *	kdb_register_repeat with KDB_REPEAT_NONE.</span>
<span class="cm"> * Inputs:</span>
<span class="cm"> *	cmd	Command name</span>
<span class="cm"> *	func	Function to execute the command</span>
<span class="cm"> *	usage	A simple usage string showing arguments</span>
<span class="cm"> *	help	A simple help string describing command</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	zero for success, one if a duplicate command.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kdb_register</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	     <span class="n">kdb_func_t</span> <span class="n">func</span><span class="p">,</span>
	     <span class="kt">char</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span>
	     <span class="kt">char</span> <span class="o">*</span><span class="n">help</span><span class="p">,</span>
	     <span class="kt">short</span> <span class="n">minlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kdb_register_repeat</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">minlen</span><span class="p">,</span>
				   <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">kdb_register</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * kdb_unregister - This function is used to unregister a kernel</span>
<span class="cm"> *	debugger command.  It is generally called when a module which</span>
<span class="cm"> *	implements kdb commands is unloaded.</span>
<span class="cm"> * Inputs:</span>
<span class="cm"> *	cmd	Command name</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	zero for success, one command not registered.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kdb_unregister</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">kdbtab_t</span> <span class="o">*</span><span class="n">kp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  find the command.</span>
<span class="cm">	 */</span>
	<span class="n">for_each_kdbcmd</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Couldn&#39;t find it.  */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">kdb_unregister</span><span class="p">);</span>

<span class="cm">/* Initialize the kdb command table. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">kdb_inittab</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">kdbtab_t</span> <span class="o">*</span><span class="n">kp</span><span class="p">;</span>

	<span class="n">for_each_kdbcmd</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">kp</span><span class="o">-&gt;</span><span class="n">cmd_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;md&quot;</span><span class="p">,</span> <span class="n">kdb_md</span><span class="p">,</span> <span class="s">&quot;&lt;vaddr&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display Memory Contents, also mdWcN, e.g. md8c1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="n">KDB_REPEAT_NO_ARGS</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;mdr&quot;</span><span class="p">,</span> <span class="n">kdb_md</span><span class="p">,</span> <span class="s">&quot;&lt;vaddr&gt; &lt;bytes&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display Raw Memory&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NO_ARGS</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;mdp&quot;</span><span class="p">,</span> <span class="n">kdb_md</span><span class="p">,</span> <span class="s">&quot;&lt;paddr&gt; &lt;bytes&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display Physical Memory&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NO_ARGS</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;mds&quot;</span><span class="p">,</span> <span class="n">kdb_md</span><span class="p">,</span> <span class="s">&quot;&lt;vaddr&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display Memory Symbolically&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NO_ARGS</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;mm&quot;</span><span class="p">,</span> <span class="n">kdb_mm</span><span class="p">,</span> <span class="s">&quot;&lt;vaddr&gt; &lt;contents&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Modify Memory Contents&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NO_ARGS</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;go&quot;</span><span class="p">,</span> <span class="n">kdb_go</span><span class="p">,</span> <span class="s">&quot;[&lt;vaddr&gt;]&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Continue Execution&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;rd&quot;</span><span class="p">,</span> <span class="n">kdb_rd</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display Registers&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;rm&quot;</span><span class="p">,</span> <span class="n">kdb_rm</span><span class="p">,</span> <span class="s">&quot;&lt;reg&gt; &lt;contents&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Modify Registers&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;ef&quot;</span><span class="p">,</span> <span class="n">kdb_ef</span><span class="p">,</span> <span class="s">&quot;&lt;vaddr&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display exception frame&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;bt&quot;</span><span class="p">,</span> <span class="n">kdb_bt</span><span class="p">,</span> <span class="s">&quot;[&lt;vaddr&gt;]&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Stack traceback&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;btp&quot;</span><span class="p">,</span> <span class="n">kdb_bt</span><span class="p">,</span> <span class="s">&quot;&lt;pid&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display stack for process &lt;pid&gt;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;bta&quot;</span><span class="p">,</span> <span class="n">kdb_bt</span><span class="p">,</span> <span class="s">&quot;[DRSTCZEUIMA]&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display stack all processes&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;btc&quot;</span><span class="p">,</span> <span class="n">kdb_bt</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Backtrace current process on each cpu&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;btt&quot;</span><span class="p">,</span> <span class="n">kdb_bt</span><span class="p">,</span> <span class="s">&quot;&lt;vaddr&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Backtrace process given its struct task address&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;ll&quot;</span><span class="p">,</span> <span class="n">kdb_ll</span><span class="p">,</span> <span class="s">&quot;&lt;first-element&gt; &lt;linkoffset&gt; &lt;cmd&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Execute cmd for each element in linked list&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;env&quot;</span><span class="p">,</span> <span class="n">kdb_env</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Show environment variables&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">,</span> <span class="n">kdb_set</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Set environment variables&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="n">kdb_help</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display Help Message&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="n">kdb_help</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display Help Message&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">kdb_cpu</span><span class="p">,</span> <span class="s">&quot;&lt;cpunum&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Switch to new cpu&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;kgdb&quot;</span><span class="p">,</span> <span class="n">kdb_kgdb</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Enter kgdb mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;ps&quot;</span><span class="p">,</span> <span class="n">kdb_ps</span><span class="p">,</span> <span class="s">&quot;[&lt;flags&gt;|A]&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display active task list&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;pid&quot;</span><span class="p">,</span> <span class="n">kdb_pid</span><span class="p">,</span> <span class="s">&quot;&lt;pidnum&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Switch to another task&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;reboot&quot;</span><span class="p">,</span> <span class="n">kdb_reboot</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Reboot the machine immediately&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_MODULES)</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;lsmod&quot;</span><span class="p">,</span> <span class="n">kdb_lsmod</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;List loaded kernel modules&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_MAGIC_SYSRQ)</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;sr&quot;</span><span class="p">,</span> <span class="n">kdb_sr</span><span class="p">,</span> <span class="s">&quot;&lt;key&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Magic SysRq key&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_PRINTK)</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;dmesg&quot;</span><span class="p">,</span> <span class="n">kdb_dmesg</span><span class="p">,</span> <span class="s">&quot;[lines]&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display syslog buffer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;defcmd&quot;</span><span class="p">,</span> <span class="n">kdb_defcmd</span><span class="p">,</span> <span class="s">&quot;name </span><span class="se">\&quot;</span><span class="s">usage</span><span class="se">\&quot;</span><span class="s"> </span><span class="se">\&quot;</span><span class="s">help</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Define a set of commands, down to endefcmd&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;kill&quot;</span><span class="p">,</span> <span class="n">kdb_kill</span><span class="p">,</span> <span class="s">&quot;&lt;-signal&gt; &lt;pid&gt;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Send a signal to a process&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;summary&quot;</span><span class="p">,</span> <span class="n">kdb_summary</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Summarize the system&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;per_cpu&quot;</span><span class="p">,</span> <span class="n">kdb_per_cpu</span><span class="p">,</span> <span class="s">&quot;&lt;sym&gt; [&lt;bytes&gt;] [&lt;cpu&gt;]&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display per_cpu variables&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
	<span class="n">kdb_register_repeat</span><span class="p">(</span><span class="s">&quot;grephelp&quot;</span><span class="p">,</span> <span class="n">kdb_grep_help</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="s">&quot;Display help on | grep&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KDB_REPEAT_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Execute any commands defined in kdb_cmds.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">kdb_cmd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">diag</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">kdb_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diag</span> <span class="o">=</span> <span class="n">kdb_parse</span><span class="p">(</span><span class="n">kdb_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
			<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;kdb command %s failed, kdb diag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">kdb_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">diag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">defcmd_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kdb_printf</span><span class="p">(</span><span class="s">&quot;Incomplete &#39;defcmd&#39; set, forcing endefcmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kdb_parse</span><span class="p">(</span><span class="s">&quot;endefcmd&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize kdb_printf, breakpoint tables and kdb state */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">kdb_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">lvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">kdb_init_lvl</span> <span class="o">=</span> <span class="n">KDB_NOT_INITIALIZED</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kdb_init_lvl</span> <span class="o">==</span> <span class="n">KDB_INIT_FULL</span> <span class="o">||</span> <span class="n">lvl</span> <span class="o">&lt;=</span> <span class="n">kdb_init_lvl</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">kdb_init_lvl</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lvl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">KDB_NOT_INITIALIZED</span>:
			<span class="n">kdb_inittab</span><span class="p">();</span>		<span class="cm">/* Initialize Command Table */</span>
			<span class="n">kdb_initbptab</span><span class="p">();</span>	<span class="cm">/* Initialize Breakpoints */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KDB_INIT_EARLY</span>:
			<span class="n">kdb_cmd_init</span><span class="p">();</span>		<span class="cm">/* Build kdb_cmds tables */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kdb_init_lvl</span> <span class="o">=</span> <span class="n">lvl</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
