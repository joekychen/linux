<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › irq › chip.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>chip.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/kernel/irq/chip.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1992, 1998-2006 Linus Torvalds, Ingo Molnar</span>
<span class="cm"> * Copyright (C) 2005-2006, Thomas Gleixner, Russell King</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains the core interrupt handling code, for irq-chip</span>
<span class="cm"> * based architectures.</span>
<span class="cm"> *</span>
<span class="cm"> * Detailed information is available in Documentation/DocBook/genericirq</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/msi.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>

<span class="cp">#include &lt;trace/events/irq.h&gt;</span>

<span class="cp">#include &quot;internals.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> *	irq_set_chip - set the irq chip for an irq</span>
<span class="cm"> *	@irq:	irq number</span>
<span class="cm"> *	@chip:	pointer to irq chip description structure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">irq_set_chip</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_get_desc_lock</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">no_irq_chip</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">irq_put_desc_unlock</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * For !CONFIG_SPARSE_IRQ make the irq show up in</span>
<span class="cm">	 * allocated_irqs. For the CONFIG_SPARSE_IRQ case, it is</span>
<span class="cm">	 * already marked, and this call is harmless.</span>
<span class="cm">	 */</span>
	<span class="n">irq_reserve_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">irq_set_chip</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	irq_set_type - set the irq trigger type for an irq</span>
<span class="cm"> *	@irq:	irq number</span>
<span class="cm"> *	@type:	IRQ_TYPE_{LEVEL,EDGE}_* value - see include/linux/irq.h</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">irq_set_irq_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_get_desc_buslock</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="n">IRQ_GET_DESC_CHECK_GLOBAL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">&amp;=</span> <span class="n">IRQ_TYPE_SENSE_MASK</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__irq_set_trigger</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">irq_put_desc_busunlock</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">irq_set_irq_type</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	irq_set_handler_data - set irq handler data for an irq</span>
<span class="cm"> *	@irq:	Interrupt number</span>
<span class="cm"> *	@data:	Pointer to interrupt specific data</span>
<span class="cm"> *</span>
<span class="cm"> *	Set the hardware irq controller data for an irq</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">irq_set_handler_data</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_get_desc_lock</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">handler_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">irq_put_desc_unlock</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">irq_set_handler_data</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	irq_set_msi_desc - set MSI descriptor data for an irq</span>
<span class="cm"> *	@irq:	Interrupt number</span>
<span class="cm"> *	@entry:	Pointer to MSI descriptor data</span>
<span class="cm"> *</span>
<span class="cm"> *	Set the MSI descriptor entry for an irq</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">irq_set_msi_desc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_get_desc_lock</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="n">IRQ_GET_DESC_CHECK_GLOBAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">msi_desc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">irq_put_desc_unlock</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	irq_set_chip_data - set irq chip data for an irq</span>
<span class="cm"> *	@irq:	Interrupt number</span>
<span class="cm"> *	@data:	Pointer to chip specific data</span>
<span class="cm"> *</span>
<span class="cm"> *	Set the hardware irq chip data for an irq</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">irq_set_chip_data</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_get_desc_lock</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">irq_put_desc_unlock</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">irq_set_chip_data</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="nf">irq_get_irq_data</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_to_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">desc</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_state_clr_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqd_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_IRQ_DISABLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_state_set_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_IRQ_DISABLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_state_clr_masked</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqd_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_IRQ_MASKED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_state_set_masked</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_IRQ_MASKED</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">irq_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">resend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">irq_state_clr_disabled</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_startup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_startup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
		<span class="n">irq_state_clr_masked</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">irq_enable</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resend</span><span class="p">)</span>
		<span class="n">check_irq_resend</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">irq_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irq_state_set_disabled</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_shutdown</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_shutdown</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_disable</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="n">irq_state_set_masked</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irq_state_clr_disabled</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_unmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="n">irq_state_clr_masked</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irq_state_set_disabled</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
		<span class="n">irq_state_set_masked</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">irq_percpu_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_unmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">percpu_enabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">irq_percpu_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_disable</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="n">cpumask_clear_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">percpu_enabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mask_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask_ack</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">)</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">irq_state_set_masked</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
		<span class="n">irq_state_set_masked</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_unmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_unmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
		<span class="n">irq_state_clr_masked</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	handle_nested_irq - Handle a nested irq from a irq thread</span>
<span class="cm"> *	@irq:	the interrupt number</span>
<span class="cm"> *</span>
<span class="cm"> *	Handle interrupts which are nested into a threaded interrupt</span>
<span class="cm"> *	handler. The handler function is called inside the calling</span>
<span class="cm"> *	threads context.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">handle_nested_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_to_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">irqaction</span> <span class="o">*</span><span class="n">action</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">action_ret</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">raw_spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">kstat_incr_irqs_this_cpu</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="n">action</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">action</span> <span class="o">||</span> <span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">|=</span> <span class="n">IRQS_PENDING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irqd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_IRQ_INPROGRESS</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">action_ret</span> <span class="o">=</span> <span class="n">action</span><span class="o">-&gt;</span><span class="n">thread_fn</span><span class="p">(</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">action</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">noirqdebug</span><span class="p">)</span>
		<span class="n">note_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">action_ret</span><span class="p">);</span>

	<span class="n">raw_spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">irqd_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_IRQ_INPROGRESS</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">raw_spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">handle_nested_irq</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">irq_check_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;</span> <span class="n">IRQS_POLL_INPROGRESS</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">irq_wait_for_poll</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	handle_simple_irq - Simple and software-decoded IRQs.</span>
<span class="cm"> *	@irq:	the interrupt number</span>
<span class="cm"> *	@desc:	the interrupt description structure for this irq</span>
<span class="cm"> *</span>
<span class="cm"> *	Simple interrupts are either sent from a demultiplexing interrupt</span>
<span class="cm"> *	handler or come from hardware, where no interrupt hardware control</span>
<span class="cm"> *	is necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *	Note: The caller is expected to handle the ack, clear, mask and</span>
<span class="cm"> *	unmask issues if necessary.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">handle_simple_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irqd_irq_inprogress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_check_poll</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IRQS_REPLAY</span> <span class="o">|</span> <span class="n">IRQS_WAITING</span><span class="p">);</span>
	<span class="n">kstat_incr_irqs_this_cpu</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">||</span> <span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">|=</span> <span class="n">IRQS_PENDING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">handle_irq_event</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">handle_simple_irq</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Called unconditionally from handle_level_irq() and only for oneshot</span>
<span class="cm"> * interrupts from handle_fasteoi_irq()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cond_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to unmask in the following cases:</span>
<span class="cm">	 * - Standard level irq (IRQF_ONESHOT is not set)</span>
<span class="cm">	 * - Oneshot irq which did not wake the thread (caused by a</span>
<span class="cm">	 *   spurious interrupt or a primary handler handling it</span>
<span class="cm">	 *   completely).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">irqd_irq_masked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">threads_oneshot</span><span class="p">)</span>
		<span class="n">unmask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	handle_level_irq - Level type irq handler</span>
<span class="cm"> *	@irq:	the interrupt number</span>
<span class="cm"> *	@desc:	the interrupt description structure for this irq</span>
<span class="cm"> *</span>
<span class="cm"> *	Level type interrupts are active as long as the hardware line has</span>
<span class="cm"> *	the active level. This may require to mask the interrupt and unmask</span>
<span class="cm"> *	it after the associated handler has acknowledged the device, so the</span>
<span class="cm"> *	interrupt line is back to inactive.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">handle_level_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mask_ack_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irqd_irq_inprogress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_check_poll</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IRQS_REPLAY</span> <span class="o">|</span> <span class="n">IRQS_WAITING</span><span class="p">);</span>
	<span class="n">kstat_incr_irqs_this_cpu</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If its disabled or no action available</span>
<span class="cm">	 * keep it masked and get out of here</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">||</span> <span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">|=</span> <span class="n">IRQS_PENDING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">handle_irq_event</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">cond_unmask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">handle_level_irq</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IRQ_PREFLOW_FASTEOI</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">preflow_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">preflow_handler</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">preflow_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">preflow_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> *	handle_fasteoi_irq - irq handler for transparent controllers</span>
<span class="cm"> *	@irq:	the interrupt number</span>
<span class="cm"> *	@desc:	the interrupt description structure for this irq</span>
<span class="cm"> *</span>
<span class="cm"> *	Only a single callback will be issued to the chip: an -&gt;eoi()</span>
<span class="cm"> *	call when the interrupt has been serviced. This enables support</span>
<span class="cm"> *	for modern forms of interrupt handlers, which handle the flow</span>
<span class="cm"> *	details in hardware, transparently.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">handle_fasteoi_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irqd_irq_inprogress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_check_poll</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IRQS_REPLAY</span> <span class="o">|</span> <span class="n">IRQS_WAITING</span><span class="p">);</span>
	<span class="n">kstat_incr_irqs_this_cpu</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If its disabled or no action available</span>
<span class="cm">	 * then mask it and get out of here:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">||</span> <span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">|=</span> <span class="n">IRQS_PENDING</span><span class="p">;</span>
		<span class="n">mask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;</span> <span class="n">IRQS_ONESHOT</span><span class="p">)</span>
		<span class="n">mask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">preflow_handler</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">handle_irq_event</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;</span> <span class="n">IRQS_ONESHOT</span><span class="p">)</span>
		<span class="n">cond_unmask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

<span class="nl">out_eoi:</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_eoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQCHIP_EOI_IF_HANDLED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_eoi</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	handle_edge_irq - edge type IRQ handler</span>
<span class="cm"> *	@irq:	the interrupt number</span>
<span class="cm"> *	@desc:	the interrupt description structure for this irq</span>
<span class="cm"> *</span>
<span class="cm"> *	Interrupt occures on the falling and/or rising edge of a hardware</span>
<span class="cm"> *	signal. The occurrence is latched into the irq controller hardware</span>
<span class="cm"> *	and must be acked in order to be reenabled. After the ack another</span>
<span class="cm"> *	interrupt can happen on the same source even before the first one</span>
<span class="cm"> *	is handled by the associated event handler. If this happens it</span>
<span class="cm"> *	might be necessary to disable (mask) the interrupt depending on the</span>
<span class="cm"> *	controller hardware. This requires to reenable the interrupt inside</span>
<span class="cm"> *	of the loop which handles the interrupts which have arrived while</span>
<span class="cm"> *	the handler was running. If all pending interrupts are handled, the</span>
<span class="cm"> *	loop is left.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">handle_edge_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IRQS_REPLAY</span> <span class="o">|</span> <span class="n">IRQS_WAITING</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re currently running this IRQ, or its disabled,</span>
<span class="cm">	 * we shouldn&#39;t process the IRQ. Mark it pending, handle</span>
<span class="cm">	 * the necessary masking and go out</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">irqd_irq_inprogress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_check_poll</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">|=</span> <span class="n">IRQS_PENDING</span><span class="p">;</span>
			<span class="n">mask_ack_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kstat_incr_irqs_this_cpu</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="cm">/* Start handling the irq */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * When another irq arrived while we were handling</span>
<span class="cm">		 * one, we could have masked the irq.</span>
<span class="cm">		 * Renable it, if it was not disabled in meantime.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;</span> <span class="n">IRQS_PENDING</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">irqd_irq_masked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">))</span>
				<span class="n">unmask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">handle_irq_event</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;</span> <span class="n">IRQS_PENDING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="o">!</span><span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">));</span>

<span class="nl">out_unlock:</span>
	<span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">handle_edge_irq</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IRQ_EDGE_EOI_HANDLER</span>
<span class="cm">/**</span>
<span class="cm"> *	handle_edge_eoi_irq - edge eoi type IRQ handler</span>
<span class="cm"> *	@irq:	the interrupt number</span>
<span class="cm"> *	@desc:	the interrupt description structure for this irq</span>
<span class="cm"> *</span>
<span class="cm"> * Similar as the above handle_edge_irq, but using eoi and w/o the</span>
<span class="cm"> * mask/unmask logic.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">handle_edge_eoi_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_desc_get_chip</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IRQS_REPLAY</span> <span class="o">|</span> <span class="n">IRQS_WAITING</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re currently running this IRQ, or its disabled,</span>
<span class="cm">	 * we shouldn&#39;t process the IRQ. Mark it pending, handle</span>
<span class="cm">	 * the necessary masking and go out</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">irqd_irq_inprogress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_check_poll</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">|=</span> <span class="n">IRQS_PENDING</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_eoi</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kstat_incr_irqs_this_cpu</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_eoi</span><span class="p">;</span>

		<span class="n">handle_irq_event</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">istate</span> <span class="o">&amp;</span> <span class="n">IRQS_PENDING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="o">!</span><span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">));</span>

<span class="nl">out_eoi:</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_eoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> *	handle_percpu_irq - Per CPU local irq handler</span>
<span class="cm"> *	@irq:	the interrupt number</span>
<span class="cm"> *	@desc:	the interrupt description structure for this irq</span>
<span class="cm"> *</span>
<span class="cm"> *	Per CPU interrupts on SMP machines without locking requirements</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">handle_percpu_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_desc_get_chip</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">kstat_incr_irqs_this_cpu</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>

	<span class="n">handle_irq_event_percpu</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_eoi</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_eoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * handle_percpu_devid_irq - Per CPU local irq handler with per cpu dev ids</span>
<span class="cm"> * @irq:	the interrupt number</span>
<span class="cm"> * @desc:	the interrupt description structure for this irq</span>
<span class="cm"> *</span>
<span class="cm"> * Per CPU interrupts on SMP machines without locking requirements. Same as</span>
<span class="cm"> * handle_percpu_irq() above but with the following extras:</span>
<span class="cm"> *</span>
<span class="cm"> * action-&gt;percpu_dev_id is a pointer to percpu variables which</span>
<span class="cm"> * contain the real device id for the cpu on which this handler is</span>
<span class="cm"> * called</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">handle_percpu_devid_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_desc_get_chip</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">irqaction</span> <span class="o">*</span><span class="n">action</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">__this_cpu_ptr</span><span class="p">(</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">percpu_dev_id</span><span class="p">);</span>
	<span class="n">irqreturn_t</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">kstat_incr_irqs_this_cpu</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>

	<span class="n">trace_irq_handler_entry</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">action</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>
	<span class="n">trace_irq_handler_exit</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_eoi</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_eoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">__irq_set_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irq_flow_handler_t</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_chained</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_get_desc_buslock</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">handle_bad_irq</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">no_irq_chip</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Uninstall? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle_bad_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">no_irq_chip</span><span class="p">)</span>
			<span class="n">mask_ack_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">irq_state_set_disabled</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">handle_irq</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">!=</span> <span class="n">handle_bad_irq</span> <span class="o">&amp;&amp;</span> <span class="n">is_chained</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_settings_set_noprobe</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">irq_settings_set_norequest</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">irq_settings_set_nothread</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">irq_startup</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">irq_put_desc_busunlock</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__irq_set_handler</span><span class="p">);</span>

<span class="kt">void</span>
<span class="nf">irq_set_chip_and_handler_name</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			      <span class="n">irq_flow_handler_t</span> <span class="n">handle</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irq_set_chip</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">__irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">irq_modify_status</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_get_desc_lock</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">irq_settings_clr_and_set</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">clr</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>

	<span class="n">irqd_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_NO_BALANCING</span> <span class="o">|</span> <span class="n">IRQD_PER_CPU</span> <span class="o">|</span>
		   <span class="n">IRQD_TRIGGER_MASK</span> <span class="o">|</span> <span class="n">IRQD_LEVEL</span> <span class="o">|</span> <span class="n">IRQD_MOVE_PCNTXT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_settings_has_no_balance_set</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="n">irqd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_NO_BALANCING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_settings_is_per_cpu</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="n">irqd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_PER_CPU</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_settings_can_move_pcntxt</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="n">irqd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_MOVE_PCNTXT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_settings_is_level</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="n">irqd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">IRQD_LEVEL</span><span class="p">);</span>

	<span class="n">irqd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">,</span> <span class="n">irq_settings_get_trigger_mask</span><span class="p">(</span><span class="n">desc</span><span class="p">));</span>

	<span class="n">irq_put_desc_unlock</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">irq_modify_status</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	irq_cpu_online - Invoke all irq_cpu_online functions.</span>
<span class="cm"> *</span>
<span class="cm"> *	Iterate through all irqs and invoke the chip.irq_cpu_online()</span>
<span class="cm"> *	for each.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">irq_cpu_online</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">for_each_active_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">irq_to_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_cpu_online</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQCHIP_ONOFFLINE_ENABLED</span><span class="p">)</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)))</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_cpu_online</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>

		<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	irq_cpu_offline - Invoke all irq_cpu_offline functions.</span>
<span class="cm"> *</span>
<span class="cm"> *	Iterate through all irqs and invoke the chip.irq_cpu_offline()</span>
<span class="cm"> *	for each.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">irq_cpu_offline</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">for_each_active_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">irq_to_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_cpu_offline</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQCHIP_ONOFFLINE_ENABLED</span><span class="p">)</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">irqd_irq_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">)))</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_cpu_offline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>

		<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
