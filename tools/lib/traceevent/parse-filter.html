<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › lib › traceevent › parse-filter.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>parse-filter.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2010 Red Hat Inc, Steven Rostedt &lt;srostedt@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="cm"> * License as published by the Free Software Foundation;</span>
<span class="cm"> * version 2.1 of the License (not later!)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="cm"> * License along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>

<span class="cp">#include &quot;event-parse.h&quot;</span>
<span class="cp">#include &quot;event-utils.h&quot;</span>

<span class="cp">#define COMM &quot;COMM&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">format_field</span> <span class="n">comm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;COMM&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">event_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_list</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_format</span>	<span class="o">*</span><span class="n">event</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define MAX_ERR_STR_SIZE 256</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">error_str</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_str</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">input</span> <span class="o">=</span> <span class="n">pevent_get_input_buf</span><span class="p">();</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">pevent_get_input_buf_ptr</span><span class="p">();</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">input</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">MAX_ERR_STR_SIZE</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="n">error</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">error</span><span class="p">[</span><span class="n">len</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="n">error</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;^&#39;</span><span class="p">;</span>
		<span class="n">error</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">error</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">MAX_ERR_STR_SIZE</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="o">*</span><span class="n">error_str</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pevent_free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="nf">read_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">pevent_read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_NEWLINE</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_SPACE</span><span class="p">);</span>

	<span class="cm">/* If token is = or ! check to see if the next char is ~ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;!&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pevent_peek_char</span><span class="p">()</span> <span class="o">==</span> <span class="sc">&#39;~&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* append it */</span>
		<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="s">&quot;%c%c&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span> <span class="sc">&#39;~&#39;</span><span class="p">);</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="cm">/* Now remove the &#39;~&#39; from the buffer */</span>
		<span class="n">pevent_read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">filter_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">ea</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">eb</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">event_id</span> <span class="o">&lt;</span> <span class="n">eb</span><span class="o">-&gt;</span><span class="n">event_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">event_id</span> <span class="o">&gt;</span> <span class="n">eb</span><span class="o">-&gt;</span><span class="n">event_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span>
<span class="nf">find_filter_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">event_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">filter_type</span> <span class="o">=</span> <span class="n">bsearch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">,</span>
			      <span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">),</span>
			      <span class="n">filter_cmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">filter_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span>
<span class="nf">add_filter_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">filter_type</span> <span class="o">=</span> <span class="n">find_filter_type</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filter_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">filter_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span> <span class="o">=</span>
			<span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span> <span class="o">=</span>
			<span class="n">realloc</span><span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">)</span> <span class="o">*</span>
				<span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Could not allocate filter&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">event_id</span> <span class="o">&gt;</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">)</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">filter_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">event_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">pevent_find_event</span><span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">filter_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_alloc - create a new event filter</span>
<span class="cm"> * @pevent: The pevent that this filter is associated with</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="nf">pevent_filter_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span>

	<span class="n">filter</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">filter</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">filter</span><span class="p">));</span>
	<span class="n">filter</span><span class="o">-&gt;</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">pevent</span><span class="p">;</span>
	<span class="n">pevent_ref</span><span class="p">(</span><span class="n">pevent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">filter</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="nf">allocate_arg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_NONE</span>:
	<span class="k">case</span> <span class="n">FILTER_ARG_BOOLEAN</span>:
	<span class="k">case</span> <span class="n">FILTER_ARG_NUM</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_STR</span>:
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="n">regfree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_OP</span>:
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_list</span> <span class="o">**</span><span class="n">events</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_list</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>

	<span class="n">list</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">list</span><span class="p">));</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span>
	<span class="o">*</span><span class="n">events</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		       <span class="n">regex_t</span> <span class="o">*</span><span class="n">sreg</span><span class="p">,</span> <span class="n">regex_t</span> <span class="o">*</span><span class="n">ereg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sreg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">regexec</span><span class="p">(</span><span class="n">sreg</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">regexec</span><span class="p">(</span><span class="n">ereg</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">regexec</span><span class="p">(</span><span class="n">ereg</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">regexec</span><span class="p">(</span><span class="n">ereg</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">find_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_list</span> <span class="o">**</span><span class="n">events</span><span class="p">,</span>
	   <span class="kt">char</span> <span class="o">*</span><span class="n">sys_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="n">regex_t</span> <span class="n">ereg</span><span class="p">;</span>
	<span class="n">regex_t</span> <span class="n">sreg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if no name is given, then swap sys and name */</span>
		<span class="n">event_name</span> <span class="o">=</span> <span class="n">sys_name</span><span class="p">;</span>
		<span class="n">sys_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="s">&quot;^%s$&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regcomp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ereg</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">REG_ICASE</span><span class="o">|</span><span class="n">REG_NOSUB</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sys_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">sys_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="s">&quot;^%s$&quot;</span><span class="p">,</span> <span class="n">sys_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regcomp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sreg</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">REG_ICASE</span><span class="o">|</span><span class="n">REG_NOSUB</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regfree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ereg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event_match</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">sys_name</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sreg</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ereg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">add_event</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">regfree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ereg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sys_name</span><span class="p">)</span>
		<span class="n">regfree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sreg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_list</span> <span class="o">*</span><span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_list</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="p">;</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">events</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span>
<span class="nf">create_arg_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">error_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">allocate_arg</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">EVENT_SQUOTE</span>:
	<span class="k">case</span> <span class="n">EVENT_DQUOTE</span>:
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_VALUE</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_DQUOTE</span> <span class="o">?</span> <span class="n">FILTER_STRING</span> <span class="o">:</span> <span class="n">FILTER_CHAR</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">str</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc string&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_ITEM</span>:
		<span class="cm">/* if it is a number, then convert it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_VALUE</span><span class="p">;</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_NUMBER</span><span class="p">;</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Consider this a field */</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_any_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">COMM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* not a field, Make it false */</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">;</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">FILTER_FALSE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* If token is &#39;COMM&#39; then it is special */</span>
			<span class="n">field</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">comm</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_FIELD</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span> <span class="s">&quot;expected a value but found %s&quot;</span><span class="p">,</span>
			   <span class="n">token</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span>
<span class="nf">create_arg_op</span><span class="p">(</span><span class="k">enum</span> <span class="n">filter_op_type</span> <span class="n">btype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">allocate_arg</span><span class="p">();</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_OP</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">btype</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span>
<span class="nf">create_arg_exp</span><span class="p">(</span><span class="k">enum</span> <span class="n">filter_exp_type</span> <span class="n">etype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">allocate_arg</span><span class="p">();</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_EXP</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">etype</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span>
<span class="nf">create_arg_cmp</span><span class="p">(</span><span class="k">enum</span> <span class="n">filter_exp_type</span> <span class="n">etype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">allocate_arg</span><span class="p">();</span>
	<span class="cm">/* Use NUM and change if necessary */</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_NUM</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">etype</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_right</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
		     <span class="kt">char</span> <span class="o">**</span><span class="n">error_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">left</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_EXP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_OP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_NUM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * The arg must be num, str, or field</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FILTER_ARG_VALUE</span>:
		<span class="k">case</span> <span class="n">FILTER_ARG_FIELD</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
				   <span class="s">&quot;Illegal rvalue&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Depending on the type, we may need to</span>
<span class="cm">		 * convert this to a string or regex.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FILTER_CHAR</span>:
			<span class="cm">/*</span>
<span class="cm">			 * A char should be converted to number if</span>
<span class="cm">			 * the string is 1 byte, and the compare</span>
<span class="cm">			 * is not a REGEX.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
			    <span class="n">op</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_CMP_REGEX</span> <span class="o">&amp;&amp;</span>
			    <span class="n">op</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_CMP_NOT_REGEX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_NUMBER</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">do_int</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">FILTER_STRING</span>:

			<span class="cm">/* convert op to a string arg */</span>
			<span class="n">op_type</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
			<span class="n">str</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">str</span><span class="p">;</span>

			<span class="cm">/* reset the op for the new field */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">op</span><span class="p">));</span>

			<span class="cm">/*</span>
<span class="cm">			 * If left arg was a field not found then</span>
<span class="cm">			 * NULL the entire op.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free_arg</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
				<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
				<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">;</span>
				<span class="n">op</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">FILTER_FALSE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Left arg must be a field */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_ARG_FIELD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
					   <span class="s">&quot;Illegal lvalue for string comparison&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Make sure this is a valid string compare */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">op_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FILTER_CMP_EQ</span>:
				<span class="n">op_type</span> <span class="o">=</span> <span class="n">FILTER_CMP_MATCH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FILTER_CMP_NE</span>:
				<span class="n">op_type</span> <span class="o">=</span> <span class="n">FILTER_CMP_NOT_MATCH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">FILTER_CMP_REGEX</span>:
			<span class="k">case</span> <span class="n">FILTER_CMP_NOT_REGEX</span>:
				<span class="n">ret</span> <span class="o">=</span> <span class="n">regcomp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">reg</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">REG_ICASE</span><span class="o">|</span><span class="n">REG_NOSUB</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
						   <span class="s">&quot;RegEx &#39;%s&#39; did not compute&quot;</span><span class="p">,</span>
						   <span class="n">str</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
					   <span class="s">&quot;Illegal comparison for string&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_STR</span><span class="p">;</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">op_type</span><span class="p">;</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">left</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">val</span><span class="p">)</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc string&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Need a buffer to copy data for tests</span>
<span class="cm">			 */</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* Null terminate this buffer */</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* We no longer have left or right args */</span>
			<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">free_arg</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FILTER_NUMBER</span>:

 <span class="nl">do_int:</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FILTER_CMP_REGEX</span>:
			<span class="k">case</span> <span class="n">FILTER_CMP_NOT_REGEX</span>:
				<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
					   <span class="s">&quot;Op not allowed with integers&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* numeric compare */</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_fail:</span>
	<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
		   <span class="s">&quot;Syntax error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span>
<span class="nf">rotate_op_right</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_left</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_EXP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_ARG_OP</span><span class="p">)</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="n">rotate_op_right</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_OP</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_NUM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_ARG_OP</span><span class="p">)</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="n">rotate_op_right</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>

		<span class="cm">/* left arg of compares must be a field */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_ARG_FIELD</span> <span class="o">&amp;&amp;</span>
		    <span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">op_type</span> <span class="p">{</span>
	<span class="n">OP_NONE</span><span class="p">,</span>
	<span class="n">OP_BOOL</span><span class="p">,</span>
	<span class="n">OP_NOT</span><span class="p">,</span>
	<span class="n">OP_EXP</span><span class="p">,</span>
	<span class="n">OP_CMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">op_type</span> <span class="nf">process_op</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">filter_op_type</span> <span class="o">*</span><span class="n">btype</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">filter_cmp_type</span> <span class="o">*</span><span class="n">ctype</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">filter_exp_type</span> <span class="o">*</span><span class="n">etype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">btype</span> <span class="o">=</span> <span class="n">FILTER_OP_NOT</span><span class="p">;</span>
	<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_NONE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">FILTER_CMP_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&amp;&amp;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">btype</span> <span class="o">=</span> <span class="n">FILTER_OP_AND</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;||&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">btype</span> <span class="o">=</span> <span class="n">FILTER_OP_OR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;!&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">OP_NOT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">btype</span> <span class="o">!=</span> <span class="n">FILTER_OP_NOT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">OP_BOOL</span><span class="p">;</span>

	<span class="cm">/* Check for value expressions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;+&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_ADD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_SUB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_MUL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_DIV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;%&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_MOD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_RSHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_LSHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&amp;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_AND</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;|&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_OR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;^&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_XOR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;~&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">etype</span> <span class="o">=</span> <span class="n">FILTER_EXP_NOT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">etype</span> <span class="o">!=</span> <span class="n">FILTER_EXP_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">OP_EXP</span><span class="p">;</span>

	<span class="cm">/* Check for compares */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;==&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">FILTER_CMP_EQ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;!=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">FILTER_CMP_NE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">FILTER_CMP_LT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">FILTER_CMP_GT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&lt;=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">FILTER_CMP_LE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&gt;=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">FILTER_CMP_GE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;=~&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">FILTER_CMP_REGEX</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;!~&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">FILTER_CMP_NOT_REGEX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">OP_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">OP_CMP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_op_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_EXP</span>:
		<span class="k">return</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">right</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_OP</span>:
		<span class="k">return</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_NUM</span>:
		<span class="k">return</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">right</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_STR</span>:
		<span class="cm">/* A string conversion is always done */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_BOOLEAN</span>:
		<span class="cm">/* field not found, is ok */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">filter_vals</span> <span class="p">{</span>
	<span class="n">FILTER_VAL_NORM</span><span class="p">,</span>
	<span class="n">FILTER_VAL_FALSE</span><span class="p">,</span>
	<span class="n">FILTER_VAL_TRUE</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">reparent_op_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">old_child</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">other_child</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">**</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_ARG_OP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_ARG_OP</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;can not reparent other than OP&quot;</span><span class="p">);</span>

	<span class="cm">/* Get the sibling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_child</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">==</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">old_child</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">;</span>
		<span class="n">other_child</span> <span class="o">=</span> <span class="n">old_child</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_child</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">old_child</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
		<span class="n">other_child</span> <span class="o">=</span> <span class="n">old_child</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Error in reparent op, find other child&quot;</span><span class="p">);</span>

	<span class="cm">/* Detach arg from old_child */</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Check for root */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="n">old_child</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_arg</span><span class="p">(</span><span class="n">other_child</span><span class="p">);</span>
		<span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
		<span class="cm">/* Free arg without recussion */</span>
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">==</span> <span class="n">old_child</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">old_child</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Error in reparent op&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">free_arg</span><span class="p">(</span><span class="n">old_child</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">filter_vals</span> <span class="nf">test_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">filter_vals</span> <span class="n">lval</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* bad case */</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_BOOLEAN</span>:
		<span class="k">return</span> <span class="n">FILTER_VAL_FALSE</span> <span class="o">+</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

		<span class="cm">/* good cases: */</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_STR</span>:
	<span class="k">case</span> <span class="n">FILTER_ARG_VALUE</span>:
	<span class="k">case</span> <span class="n">FILTER_ARG_FIELD</span>:
		<span class="k">return</span> <span class="n">FILTER_VAL_NORM</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_EXP</span>:
		<span class="n">lval</span> <span class="o">=</span> <span class="n">test_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lval</span> <span class="o">!=</span> <span class="n">FILTER_VAL_NORM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">lval</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">test_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">FILTER_VAL_NORM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FILTER_VAL_NORM</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_NUM</span>:
		<span class="n">lval</span> <span class="o">=</span> <span class="n">test_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lval</span> <span class="o">!=</span> <span class="n">FILTER_VAL_NORM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">lval</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">test_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">FILTER_VAL_NORM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FILTER_VAL_NORM</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_OP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_OP_NOT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lval</span> <span class="o">=</span> <span class="n">test_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FILTER_VAL_NORM</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FILTER_VAL_TRUE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_OR</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">FILTER_VAL_TRUE</span><span class="p">;</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">test_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">FILTER_VAL_NORM</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

				<span class="n">reparent_op_arg</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">FILTER_VAL_NORM</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">FILTER_VAL_FALSE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_AND</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">FILTER_VAL_FALSE</span><span class="p">;</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">test_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">FILTER_VAL_NORM</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

				<span class="n">reparent_op_arg</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">FILTER_VAL_NORM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">test_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FILTER_VAL_NORM</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FILTER_VAL_TRUE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_OR</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">FILTER_VAL_TRUE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_NOT</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">FILTER_VAL_FALSE</span><span class="p">;</span>

			<span class="n">reparent_op_arg</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FILTER_VAL_NORM</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FILTER_VAL_FALSE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_AND</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">FILTER_VAL_FALSE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_NOT</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">FILTER_VAL_TRUE</span><span class="p">;</span>

			<span class="n">reparent_op_arg</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FILTER_VAL_NORM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">FILTER_VAL_NORM</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;bad arg in filter tree&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">FILTER_VAL_NORM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Remove any unknown event fields */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="nf">collapse_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">filter_vals</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">test_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_VAL_NORM</span>:
		<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_VAL_TRUE</span>:
	<span class="k">case</span> <span class="n">FILTER_VAL_FALSE</span>:
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">allocate_arg</span><span class="p">();</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">FILTER_VAL_TRUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">process_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">**</span><span class="n">parg</span><span class="p">,</span>
	       <span class="kt">char</span> <span class="o">**</span><span class="n">error_str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">not</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">current_op</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">current_exp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">left_item</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">op_type</span> <span class="n">op_type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">filter_op_type</span> <span class="n">btype</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">filter_exp_type</span> <span class="n">etype</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">filter_cmp_type</span> <span class="n">ctype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">parg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">free</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EVENT_SQUOTE</span>:
		<span class="k">case</span> <span class="n">EVENT_DQUOTE</span>:
		<span class="k">case</span> <span class="n">EVENT_ITEM</span>:
			<span class="n">arg</span> <span class="o">=</span> <span class="n">create_arg_item</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">error_str</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left_item</span><span class="p">)</span>
				<span class="n">left_item</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current_exp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">add_right</span><span class="p">(</span><span class="n">current_exp</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">error_str</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="n">left_item</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="cm">/* Not&#39;s only one one expression */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">not</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">current_op</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
					<span class="n">free</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
					<span class="o">*</span><span class="n">parg</span> <span class="o">=</span> <span class="n">current_exp</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EVENT_DELIM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">token</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
					   <span class="s">&quot;Illegal token &#39;,&#39;&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">token</span> <span class="o">==</span> <span class="sc">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">left_item</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
						   <span class="s">&quot;Open paren can not come after item&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_exp</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
						   <span class="s">&quot;Open paren can not come after expression&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">ret</span> <span class="o">=</span> <span class="n">process_filter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">error_str</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
							   <span class="s">&quot;Unbalanced number of &#39;(&#39;&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* A not wants just one expression */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">not</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">current_op</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
					<span class="o">*</span><span class="n">parg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">current_op</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">add_right</span><span class="p">(</span><span class="n">current_op</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">error_str</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">current_exp</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* &#39;)&#39; */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_op</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_exp</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>

				<span class="cm">/* Make sure everything is finished at this level */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_exp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">check_op_done</span><span class="p">(</span><span class="n">current_exp</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_op</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">check_op_done</span><span class="p">(</span><span class="n">current_op</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">current_op</span><span class="p">)</span>
					<span class="o">*</span><span class="n">parg</span> <span class="o">=</span> <span class="n">current_op</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">parg</span> <span class="o">=</span> <span class="n">current_exp</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EVENT_OP</span>:
			<span class="n">op_type</span> <span class="o">=</span> <span class="n">process_op</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">etype</span><span class="p">);</span>

			<span class="cm">/* All expect a left arg except for NOT */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">op_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OP_BOOL</span>:
				<span class="cm">/* Logic ops need a left expression */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_exp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_op</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
				<span class="cm">/* fall through */</span>
			<span class="k">case</span> <span class="n">OP_NOT</span>:
				<span class="cm">/* logic only processes ops and exp */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">left_item</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OP_EXP</span>:
			<span class="k">case</span> <span class="n">OP_CMP</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left_item</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OP_NONE</span>:
				<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
					   <span class="s">&quot;Unknown op token %s&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">op_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OP_BOOL</span>:
				<span class="n">arg</span> <span class="o">=</span> <span class="n">create_arg_op</span><span class="p">(</span><span class="n">btype</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_op</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">add_left</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">current_op</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">add_left</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">current_exp</span><span class="p">);</span>
				<span class="n">current_op</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
				<span class="n">current_exp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">OP_NOT</span>:
				<span class="n">arg</span> <span class="o">=</span> <span class="n">create_arg_op</span><span class="p">(</span><span class="n">btype</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_op</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">add_right</span><span class="p">(</span><span class="n">current_op</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">error_str</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="n">current_exp</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">process_filter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">error_str</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">add_right</span><span class="p">(</span><span class="n">current_exp</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">error_str</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">OP_EXP</span>:
			<span class="k">case</span> <span class="n">OP_CMP</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">op_type</span> <span class="o">==</span> <span class="n">OP_EXP</span><span class="p">)</span>
					<span class="n">arg</span> <span class="o">=</span> <span class="n">create_arg_exp</span><span class="p">(</span><span class="n">etype</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">arg</span> <span class="o">=</span> <span class="n">create_arg_cmp</span><span class="p">(</span><span class="n">ctype</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">current_op</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">add_right</span><span class="p">(</span><span class="n">current_op</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">error_str</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">add_left</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">left_item</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">current_exp</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVENT_NONE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_NONE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_op</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_exp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_print</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_op</span><span class="p">)</span>
		<span class="n">current_op</span> <span class="o">=</span> <span class="n">current_exp</span><span class="p">;</span>

	<span class="n">current_op</span> <span class="o">=</span> <span class="n">collapse_tree</span><span class="p">(</span><span class="n">current_op</span><span class="p">);</span>

	<span class="o">*</span><span class="n">parg</span> <span class="o">=</span> <span class="n">current_op</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail_print:</span>
	<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span> <span class="s">&quot;Syntax error&quot;</span><span class="p">);</span>
 <span class="nl">fail:</span>
	<span class="n">free_arg</span><span class="p">(</span><span class="n">current_op</span><span class="p">);</span>
	<span class="n">free_arg</span><span class="p">(</span><span class="n">current_exp</span><span class="p">);</span>
	<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">process_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filter_str</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">**</span><span class="n">parg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">error_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pevent_buffer_init</span><span class="p">(</span><span class="n">filter_str</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">filter_str</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">process_filter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">parg</span><span class="p">,</span> <span class="n">error_str</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
			   <span class="s">&quot;Unbalanced number of &#39;)&#39;&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* If parg is NULL, then make it into FALSE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">parg</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">parg</span> <span class="o">=</span> <span class="n">allocate_arg</span><span class="p">();</span>
		<span class="p">(</span><span class="o">*</span><span class="n">parg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">parg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">FILTER_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">filter_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filter_str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">error_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter_str</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">filter_str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">error_str</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* just add a TRUE arg */</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">allocate_arg</span><span class="p">();</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">FILTER_TRUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">filter_type</span> <span class="o">=</span> <span class="n">add_filter_type</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">)</span>
		<span class="n">free_arg</span><span class="p">(</span><span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
	<span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_add_filter_str - add a new filter</span>
<span class="cm"> * @filter: the event filter to add to</span>
<span class="cm"> * @filter_str: the filter string that contains the filter</span>
<span class="cm"> * @error_str: string containing reason for failed filter</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if the filter was successfully added</span>
<span class="cm"> *   -1 if there was an error.</span>
<span class="cm"> *</span>
<span class="cm"> * On error, if @error_str points to a string pointer,</span>
<span class="cm"> * it is set to the reason that the filter failed.</span>
<span class="cm"> * This string must be freed with &quot;free&quot;.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_filter_add_filter_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filter_str</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">**</span><span class="n">error_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_list</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_list</span> <span class="o">*</span><span class="n">events</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filter_start</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">next_event</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_event</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">event_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sys_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rtn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* clear buffer to reset show error */</span>
	<span class="n">pevent_buffer_init</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error_str</span><span class="p">)</span>
		<span class="o">*</span><span class="n">error_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">filter_start</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">filter_str</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filter_start</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">filter_start</span> <span class="o">-</span> <span class="n">filter_str</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">filter_str</span><span class="p">);</span>


	<span class="k">do</span> <span class="p">{</span>
		<span class="n">next_event</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">filter_str</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_event</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">filter_start</span> <span class="o">||</span> <span class="n">next_event</span> <span class="o">&lt;</span> <span class="n">filter_start</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">next_event</span> <span class="o">-</span> <span class="n">filter_str</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">filter_start</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">filter_start</span> <span class="o">-</span> <span class="n">filter_str</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">filter_str</span><span class="p">);</span>

		<span class="n">this_event</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">this_event</span><span class="p">,</span> <span class="n">filter_str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">this_event</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next_event</span><span class="p">)</span>
			<span class="n">next_event</span><span class="o">++</span><span class="p">;</span>

		<span class="n">filter_str</span> <span class="o">=</span> <span class="n">next_event</span><span class="p">;</span>

		<span class="n">sys_name</span> <span class="o">=</span> <span class="n">strtok_r</span><span class="p">(</span><span class="n">this_event</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">event_name</span> <span class="o">=</span> <span class="n">strtok_r</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sys_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span> <span class="s">&quot;No filter found&quot;</span><span class="p">);</span>
			<span class="cm">/* This can only happen when events is NULL, but still */</span>
			<span class="n">free_events</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">this_event</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Find this event */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">find_event</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">events</span><span class="p">,</span> <span class="n">strim</span><span class="p">(</span><span class="n">sys_name</span><span class="p">),</span> <span class="n">strim</span><span class="p">(</span><span class="n">event_name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
				<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
					   <span class="s">&quot;No event found under &#39;%s.%s&#39;&quot;</span><span class="p">,</span>
					   <span class="n">sys_name</span><span class="p">,</span> <span class="n">event_name</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">show_error</span><span class="p">(</span><span class="n">error_str</span><span class="p">,</span>
					   <span class="s">&quot;No event found under &#39;%s&#39;&quot;</span><span class="p">,</span>
					   <span class="n">sys_name</span><span class="p">);</span>
			<span class="n">free_events</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">this_event</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">free</span><span class="p">(</span><span class="n">this_event</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">filter_str</span><span class="p">);</span>

	<span class="cm">/* Skip the &#39;:&#39; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filter_start</span><span class="p">)</span>
		<span class="n">filter_start</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* filter starts here */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="p">;</span> <span class="n">event</span><span class="p">;</span> <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">filter_event</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">filter_start</span><span class="p">,</span>
				   <span class="n">error_str</span><span class="p">);</span>
		<span class="cm">/* Failures are returned if a parse error happened */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rtn</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">test_filters</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">test</span><span class="p">;</span>
			<span class="n">test</span> <span class="o">=</span> <span class="n">pevent_filter_make_string</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; &#39;%s: %s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">test</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">free_events</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtn</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">test_filters</span><span class="p">)</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_filter_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_arg</span><span class="p">(</span><span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_remove_event - remove a filter for an event</span>
<span class="cm"> * @filter: the event filter to remove from</span>
<span class="cm"> * @event_id: the event to remove a filter for</span>
<span class="cm"> *</span>
<span class="cm"> * Removes the filter saved for an event defined by @event_id</span>
<span class="cm"> * from the @filter.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1: if an event was removed</span>
<span class="cm"> *   0: if the event was not found</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_filter_remove_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">event_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">filter_type</span> <span class="o">=</span> <span class="n">find_filter_type</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">free_filter_type</span><span class="p">(</span><span class="n">filter_type</span><span class="p">);</span>

	<span class="cm">/* The filter_type points into the event_filters array */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span> <span class="o">+</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">filter_type</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">memmove</span><span class="p">(</span><span class="n">filter_type</span><span class="p">,</span> <span class="n">filter_type</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="o">--</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">filter_type</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_reset - clear all filters in a filter</span>
<span class="cm"> * @filter: the event filter to reset</span>
<span class="cm"> *</span>
<span class="cm"> * Removes all filters from a filter and resets it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pevent_filter_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_filter_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">);</span>
	<span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pevent_filter_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pevent_unref</span><span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">);</span>

	<span class="n">pevent_filter_reset</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg_to_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_filter_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sys</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="cm">/* Can&#39;t assume that the pevent&#39;s are the same */</span>
	<span class="n">sys</span> <span class="o">=</span> <span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">pevent_find_event_by_name</span><span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;FALSE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add trivial event */</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">allocate_arg</span><span class="p">();</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">filter_type</span> <span class="o">=</span> <span class="n">add_filter_type</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">filter_event</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_copy - copy a filter using another filter</span>
<span class="cm"> * @dest - the filter to copy to</span>
<span class="cm"> * @source - the filter to copy from</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success and -1 if not all filters were copied</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_filter_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pevent_filter_reset</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_filter_type</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * pevent_update_trivial - update the trivial filters with the given filter</span>
<span class="cm"> * @dest - the filter to update</span>
<span class="cm"> * @source - the filter as the source of the update</span>
<span class="cm"> * @type - the type of trivial filter to update.</span>
<span class="cm"> *</span>
<span class="cm"> * Scan dest for trivial events matching @type to replace with the source.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success and -1 if there was a problem updating, but</span>
<span class="cm"> *   events may have still been updated on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_update_trivial</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">filter_trivial_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">src_pevent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">dest_pevent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">src_pevent</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">;</span>
	<span class="n">dest_pevent</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">;</span>

	<span class="cm">/* Do nothing if either of the filters has nothing to filter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">filters</span> <span class="o">||</span> <span class="o">!</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filter_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_TRIVIAL_FALSE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_TRIVIAL_TRUE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">event</span> <span class="o">=</span> <span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">src_pevent</span> <span class="o">!=</span> <span class="n">dest_pevent</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* do a look up */</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">pevent_find_event_by_name</span><span class="p">(</span><span class="n">src_pevent</span><span class="p">,</span>
							  <span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span>
							  <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">str</span> <span class="o">=</span> <span class="n">pevent_filter_make_string</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Don&#39;t bother if the filter is trivial too */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;FALSE&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">filter_event</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_clear_trivial - clear TRUE and FALSE filters</span>
<span class="cm"> * @filter: the filter to remove trivial filters from</span>
<span class="cm"> * @type: remove only true, false, or both</span>
<span class="cm"> *</span>
<span class="cm"> * Removes filters that only contain a TRUE or FALES boolean arg.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pevent_filter_clear_trivial</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">filter_trivial_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">ids</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Two steps, first get all ids with trivial filters.</span>
<span class="cm">	 *  then remove those ids.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filter_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FILTER_TRIVIAL_FALSE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FILTER_TRIVIAL_TRUE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
			<span class="n">ids</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ids</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">ids</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ids</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ids</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Can&#39;t allocate ids&quot;</span><span class="p">);</span>
		<span class="n">ids</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">event_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pevent_filter_remove_event</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">ids</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_event_has_trivial - return true event contains trivial filter</span>
<span class="cm"> * @filter: the filter with the information</span>
<span class="cm"> * @event_id: the id of the event to test</span>
<span class="cm"> * @type: trivial type to test for (TRUE, FALSE, EITHER)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the event contains a matching trivial type</span>
<span class="cm"> *  otherwise 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_filter_event_has_trivial</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">event_id</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">filter_trivial_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">filter_type</span> <span class="o">=</span> <span class="n">find_filter_type</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_ARG_BOOLEAN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_TRIVIAL_FALSE</span>:
		<span class="k">return</span> <span class="o">!</span><span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_TRIVIAL_TRUE</span>:
		<span class="k">return</span> <span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">test_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">get_comm</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>

	<span class="n">pid</span> <span class="o">=</span> <span class="n">pevent_data_pid</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>
	<span class="n">comm</span> <span class="o">=</span> <span class="n">pevent_data_comm_from_pid</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">comm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">get_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
	  <span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Handle our dummy &quot;comm&quot; field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">comm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">get_comm</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pevent_read_number_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_SIGNED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="n">get_arg_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">get_exp_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lval</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">lval</span> <span class="o">=</span> <span class="n">get_arg_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">get_arg_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_ADD</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">+</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_SUB</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">-</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_MUL</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">*</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_DIV</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">/</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_MOD</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">%</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_RSHIFT</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">&gt;&gt;</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_LSHIFT</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">&lt;&lt;</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_AND</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">&amp;</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_OR</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">|</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_XOR</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">^</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_EXP_NOT</span>:
	<span class="nl">default:</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;error in exp&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">get_arg_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_FIELD</span>:
		<span class="k">return</span> <span class="n">get_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_VALUE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FILTER_NUMBER</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;must have number field!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_EXP</span>:
		<span class="k">return</span> <span class="n">get_exp_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;oops in filter&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lval</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">lval</span> <span class="o">=</span> <span class="n">get_arg_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">get_arg_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_EQ</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">==</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_CMP_NE</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">!=</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_CMP_GT</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">&gt;</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_CMP_LT</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">&lt;</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_CMP_GE</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">&gt;=</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_CMP_LE</span>:
		<span class="k">return</span> <span class="n">lval</span> <span class="o">&lt;=</span> <span class="n">rval</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* ?? */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_field_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to copy the data since we can&#39;t be sure the field</span>
<span class="cm">	 * is null terminated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* copy it */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="cm">/* the buffer is already NULL terminated */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">field</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">comm</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">get_comm</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">get_field_str</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_MATCH</span>:
		<span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_CMP_NOT_MATCH</span>:
		<span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_CMP_REGEX</span>:
		<span class="cm">/* Returns zero on match */</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">regexec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_CMP_NOT_REGEX</span>:
		<span class="k">return</span> <span class="n">regexec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="cm">/* ?? */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_OP_AND</span>:
		<span class="k">return</span> <span class="n">test_filter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">test_filter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_OP_OR</span>:
		<span class="k">return</span> <span class="n">test_filter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">test_filter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_OP_NOT</span>:
		<span class="k">return</span> <span class="o">!</span><span class="n">test_filter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="cm">/* ?? */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_BOOLEAN</span>:
		<span class="cm">/* easy case */</span>
		<span class="k">return</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_OP</span>:
		<span class="k">return</span> <span class="n">test_op</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_NUM</span>:
		<span class="k">return</span> <span class="n">test_num</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_STR</span>:
		<span class="k">return</span> <span class="n">test_str</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_EXP</span>:
	<span class="k">case</span> <span class="n">FILTER_ARG_VALUE</span>:
	<span class="k">case</span> <span class="n">FILTER_ARG_FIELD</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Expressions, fields and values evaluate</span>
<span class="cm">		 * to true if they return non zero</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">!!</span><span class="n">get_arg_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;oops!&quot;</span><span class="p">);</span>
		<span class="cm">/* ?? */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_event_filtered - return true if event has filter</span>
<span class="cm"> * @filter: filter struct with filter information</span>
<span class="cm"> * @event_id: event id to test if filter exists</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if filter found for @event_id</span>
<span class="cm"> *   otherwise 0;</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_event_filtered</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">event_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">filter_type</span> <span class="o">=</span> <span class="n">find_filter_type</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">filter_type</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_match - test if a record matches a filter</span>
<span class="cm"> * @filter: filter struct with filter information</span>
<span class="cm"> * @record: the record to test against the filter</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *  1 - filter found for event and @record matches</span>
<span class="cm"> *  0 - filter found for event and @record does not match</span>
<span class="cm"> * -1 - no filter found for @record&#39;s event</span>
<span class="cm"> * -2 - if no filters exist</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_filter_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">event_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FILTER_NONE</span><span class="p">;</span>

	<span class="n">event_id</span> <span class="o">=</span> <span class="n">pevent_data_type</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>

	<span class="n">filter_type</span> <span class="o">=</span> <span class="n">find_filter_type</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FILTER_NOEXIST</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">test_filter</span><span class="p">(</span><span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">FILTER_MATCH</span> <span class="o">:</span> <span class="n">FILTER_MISS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">op_to_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">right</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left_val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">right_val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_OP_AND</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;&amp;&amp;&quot;</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FILTER_OP_OR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
			<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;||&quot;</span><span class="p">;</span>

		<span class="n">left</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span> <span class="o">||</span> <span class="o">!</span><span class="n">right</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Try to consolidate boolean values */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">left_val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="s">&quot;FALSE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">left_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">right_val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="s">&quot;FALSE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">right_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">left_val</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_AND</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">left_val</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_OR</span> <span class="o">&amp;&amp;</span> <span class="n">left_val</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Just return left value */</span>
				<span class="n">str</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
				<span class="n">left</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">right_val</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* just evaluate this. */</span>
				<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">FILTER_OP_AND</span>:
					<span class="n">val</span> <span class="o">=</span> <span class="n">left_val</span> <span class="o">&amp;&amp;</span> <span class="n">right_val</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">FILTER_OP_OR</span>:
					<span class="n">val</span> <span class="o">=</span> <span class="n">left_val</span> <span class="o">||</span> <span class="n">right_val</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
					<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">right_val</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_AND</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">right_val</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FILTER_OP_OR</span> <span class="o">&amp;&amp;</span> <span class="n">right_val</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Just return right value */</span>
				<span class="n">str</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">right</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* The right value is meaningless */</span>
			<span class="n">str</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;(%s) %s (%s)&quot;</span><span class="p">,</span>
			 <span class="n">left</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_OP_NOT</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;!&quot;</span><span class="p">;</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">right</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* See if we can consolidate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">right_val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="s">&quot;FALSE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">right_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">right_val</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* just return the opposite */</span>
			<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">right_val</span><span class="p">)</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s(%s)&quot;</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* ?? */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">val_to_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">field_to_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">strdup</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">exp_to_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">lstr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rstr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">lstr</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
	<span class="n">rstr</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_ADD</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;+&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_SUB</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_MUL</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_DIV</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_MOD</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;%&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_RSHIFT</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;&gt;&gt;&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_LSHIFT</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;&lt;&lt;&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_AND</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;&amp;&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_OR</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;|&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FILTER_EXP_XOR</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;^&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;oops in exp&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lstr</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rstr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s %s %s&quot;</span><span class="p">,</span> <span class="n">lstr</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rstr</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">lstr</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">rstr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">num_to_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">lstr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rstr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">lstr</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
	<span class="n">rstr</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_EQ</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;==&quot;</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_NE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
			<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;!=&quot;</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_GT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
			<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;&gt;&quot;</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_LT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
			<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;&lt;&quot;</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_GE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
			<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;&gt;=&quot;</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_LE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
			<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;&lt;=&quot;</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lstr</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rstr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s %s %s&quot;</span><span class="p">,</span> <span class="n">lstr</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rstr</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* ?? */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">lstr</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">rstr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">str_to_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_MATCH</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;==&quot;</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_NOT_MATCH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
			<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;!=&quot;</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_REGEX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
			<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;=~&quot;</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FILTER_CMP_NOT_REGEX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
			<span class="n">op</span> <span class="o">=</span> <span class="s">&quot;!~&quot;</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s %s </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* ?? */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">arg_to_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">filter_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FILTER_ARG_BOOLEAN</span>:
		<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">boolean</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;TRUE&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">str</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_OP</span>:
		<span class="k">return</span> <span class="n">op_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_NUM</span>:
		<span class="k">return</span> <span class="n">num_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_STR</span>:
		<span class="k">return</span> <span class="n">str_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_VALUE</span>:
		<span class="k">return</span> <span class="n">val_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_FIELD</span>:
		<span class="k">return</span> <span class="n">field_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FILTER_ARG_EXP</span>:
		<span class="k">return</span> <span class="n">exp_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="cm">/* ?? */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_make_string - return a string showing the filter</span>
<span class="cm"> * @filter: filter struct with filter information</span>
<span class="cm"> * @event_id: the event id to return the filter string with</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a string that displays the filter contents.</span>
<span class="cm"> *  This string must be freed with free(str).</span>
<span class="cm"> *  NULL is returned if no filter is found.</span>
<span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span>
<span class="nf">pevent_filter_make_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">filter_type</span> <span class="o">=</span> <span class="n">find_filter_type</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">event_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_filter_compare - compare two filters and return if they are the same</span>
<span class="cm"> * @filter1: Filter to compare with @filter2</span>
<span class="cm"> * @filter2: Filter to compare with @filter1</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *  1 if the two filters hold the same content.</span>
<span class="cm"> *  0 if they do not.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_filter_compare</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filter_type</span> <span class="o">*</span><span class="n">filter_type2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str1</span><span class="p">,</span> <span class="o">*</span><span class="n">str2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Do the easy checks first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filter1</span><span class="o">-&gt;</span><span class="n">filters</span> <span class="o">!=</span> <span class="n">filter2</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter1</span><span class="o">-&gt;</span><span class="n">filters</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">filter2</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now take a look at each of the events to see if they have the same</span>
<span class="cm">	 * filters to them.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter1</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filter_type1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">filter1</span><span class="o">-&gt;</span><span class="n">event_filters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">filter_type2</span> <span class="o">=</span> <span class="n">find_filter_type</span><span class="p">(</span><span class="n">filter2</span><span class="p">,</span> <span class="n">filter_type1</span><span class="o">-&gt;</span><span class="n">event_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter_type2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter_type1</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">filter_type2</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">filter_type1</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FILTER_TRIVIAL_FALSE</span>:
		<span class="k">case</span> <span class="n">FILTER_TRIVIAL_TRUE</span>:
			<span class="cm">/* trivial types just need the type compared */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The best way to compare complex filters is with strings */</span>
		<span class="n">str1</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter1</span><span class="p">,</span> <span class="n">filter_type1</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
		<span class="n">str2</span> <span class="o">=</span> <span class="n">arg_to_str</span><span class="p">(</span><span class="n">filter2</span><span class="p">,</span> <span class="n">filter_type2</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">str1</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">str2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter1</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
