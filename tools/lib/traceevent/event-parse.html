<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › lib › traceevent › event-parse.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>event-parse.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2009, 2010 Red Hat Inc, Steven Rostedt &lt;srostedt@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="cm"> * License as published by the Free Software Foundation;</span>
<span class="cm"> * version 2.1 of the License (not later!)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="cm"> * License along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> *</span>
<span class="cm"> *  The parts for function graph printing was taken and modified from the</span>
<span class="cm"> *  Linux Kernel that were written by</span>
<span class="cm"> *    - Copyright (C) 2009  Frederic Weisbecker,</span>
<span class="cm"> *  Frederic Weisbecker gave his permission to relicense the code to</span>
<span class="cm"> *  the Lesser General Public License.</span>
<span class="cm"> */</span>
<span class="cp">#define _GNU_SOURCE</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;ctype.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>

<span class="cp">#include &quot;event-parse.h&quot;</span>
<span class="cp">#include &quot;event-utils.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input_buf</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">input_buf_ptr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">input_buf_siz</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">is_flag_field</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">is_symbolic_field</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">show_warning</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#define do_warning(fmt, ...)				\</span>
<span class="cp">	do {						\</span>
<span class="cp">		if (show_warning)			\</span>
<span class="cp">			warning(fmt, ##__VA_ARGS__);	\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_input_buf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">input_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">input_buf_siz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">input_buf_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pevent_get_input_buf</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">input_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">pevent_get_input_buf_ptr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">input_buf_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">event_handler</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_handler</span>		<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">id</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>			<span class="o">*</span><span class="n">sys_name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>			<span class="o">*</span><span class="n">event_name</span><span class="p">;</span>
	<span class="n">pevent_event_handler_func</span>	<span class="n">func</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pevent_func_params</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent_func_params</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pevent_func_arg_type</span>	<span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent_function_handler</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pevent_func_arg_type</span>	<span class="n">ret_type</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">pevent_func_handler</span>		<span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pevent_func_params</span>	<span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">nr_args</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="n">process_defined_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">free_func_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span><span class="n">func</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_buffer_init - init buffer for parsing</span>
<span class="cm"> * @buf: buffer to parse</span>
<span class="cm"> * @size: the size of the buffer</span>
<span class="cm"> *</span>
<span class="cm"> * For use with pevent_read_token(), this initializes the internal</span>
<span class="cm"> * buffer that pevent_read_token() will parse.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pevent_buffer_init</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_input_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">breakpoint</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">x</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="nf">alloc_arg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cmdline</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">comm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmdline_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cmdline_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdline_list</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">comm</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">pid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmdline_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdline_list</span> <span class="o">*</span><span class="n">cmdlist</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdline_list</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">cmdlines</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmdlines</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmdlines</span><span class="p">)</span> <span class="o">*</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cmdlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdlines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pid</span> <span class="o">=</span> <span class="n">cmdlist</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
		<span class="n">cmdlines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">comm</span> <span class="o">=</span> <span class="n">cmdlist</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">cmdlist</span><span class="p">;</span>
		<span class="n">cmdlist</span> <span class="o">=</span> <span class="n">cmdlist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qsort</span><span class="p">(</span><span class="n">cmdlines</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmdlines</span><span class="p">),</span> <span class="n">cmdline_cmp</span><span class="p">);</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span> <span class="o">=</span> <span class="n">cmdlines</span><span class="p">;</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">find_cmdline</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">comm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdline</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;&lt;idle&gt;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">)</span>
		<span class="n">cmdline_init</span><span class="p">(</span><span class="n">pevent</span><span class="p">);</span>

	<span class="n">key</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>

	<span class="n">comm</span> <span class="o">=</span> <span class="n">bsearch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">),</span> <span class="n">cmdline_cmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comm</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">comm</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;&lt;...&gt;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_pid_is_registered - return if a pid has a cmdline registered</span>
<span class="cm"> * @pevent: handle for the pevent</span>
<span class="cm"> * @pid: The pid to check if it has a cmdline registered with.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the pid has a cmdline mapped to it</span>
<span class="cm"> * 0 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_pid_is_registered</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">comm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdline</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">)</span>
		<span class="n">cmdline_init</span><span class="p">(</span><span class="n">pevent</span><span class="p">);</span>

	<span class="n">key</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>

	<span class="n">comm</span> <span class="o">=</span> <span class="n">bsearch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">),</span> <span class="n">cmdline_cmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If the command lines have been converted to an array, then</span>
<span class="cm"> * we must add this pid. This is much slower than when cmdlines</span>
<span class="cm"> * are added before the array is initialized.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_new_comm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">cmdlines</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">cmdline</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdline</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* avoid duplicates */</span>
	<span class="n">key</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>

	<span class="n">cmdline</span> <span class="o">=</span> <span class="n">bsearch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">),</span> <span class="n">cmdline_cmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdlines</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">cmdlines</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmdlines</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdlines</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdlines</span><span class="p">[</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">].</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">cmdlines</span><span class="p">[</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">].</span><span class="n">comm</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">comm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdlines</span><span class="p">[</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">].</span><span class="n">comm</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc comm&quot;</span><span class="p">);</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdlines</span><span class="p">[</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">].</span><span class="n">comm</span><span class="p">)</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">qsort</span><span class="p">(</span><span class="n">cmdlines</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmdlines</span><span class="p">),</span> <span class="n">cmdline_cmp</span><span class="p">);</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span> <span class="o">=</span> <span class="n">cmdlines</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_register_comm - register a pid / comm mapping</span>
<span class="cm"> * @pevent: handle for the pevent</span>
<span class="cm"> * @comm: the command line to register</span>
<span class="cm"> * @pid: the pid to map the command line to</span>
<span class="cm"> *</span>
<span class="cm"> * This adds a mapping to search for command line names with</span>
<span class="cm"> * a given pid. The comm is duplicated.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_register_comm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdline_list</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">add_new_comm</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

	<span class="n">item</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">));</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">comm</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">comm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc comm&quot;</span><span class="p">);</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlist</span><span class="p">;</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlist</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">func_map</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>		<span class="n">addr</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="o">*</span><span class="n">mod</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">func_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">func_list</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>	<span class="n">addr</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">mod</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">func_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">fa</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We are searching for a record in between, not an exact</span>
<span class="cm"> * match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">func_bcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">fa</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">||</span>

	    <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;&amp;</span>
	     <span class="n">fa</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">func_map_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">func_list</span> <span class="o">*</span><span class="n">funclist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">func_list</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">func_map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">func_map</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">func_map</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">funclist</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">funclist</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">funclist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">func_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">func</span> <span class="o">=</span> <span class="n">funclist</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
		<span class="n">func_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">funclist</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">func_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod</span> <span class="o">=</span> <span class="n">funclist</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">funclist</span><span class="p">;</span>
		<span class="n">funclist</span> <span class="o">=</span> <span class="n">funclist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qsort</span><span class="p">(</span><span class="n">func_map</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">func_map</span><span class="p">),</span> <span class="n">func_cmp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add a special record at the end.</span>
<span class="cm">	 */</span>
	<span class="n">func_map</span><span class="p">[</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_count</span><span class="p">].</span><span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">func_map</span><span class="p">[</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_count</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">func_map</span><span class="p">[</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_count</span><span class="p">].</span><span class="n">mod</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span> <span class="o">=</span> <span class="n">func_map</span><span class="p">;</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">funclist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span>
<span class="nf">find_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">func_map</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">)</span>
		<span class="n">func_map_init</span><span class="p">(</span><span class="n">pevent</span><span class="p">);</span>

	<span class="n">key</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">bsearch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_count</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">),</span> <span class="n">func_bcmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">func</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_find_function - find a function by a given address</span>
<span class="cm"> * @pevent: handle for the pevent</span>
<span class="cm"> * @addr: the address to find the function with</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the function stored that has the given</span>
<span class="cm"> * address. Note, the address does not have to be exact, it</span>
<span class="cm"> * will select the function that would contain the address.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pevent_find_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">find_func</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_find_function_address - find a function address by a given address</span>
<span class="cm"> * @pevent: handle for the pevent</span>
<span class="cm"> * @addr: the address to find the function with</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the address the function starts at. This can be used in</span>
<span class="cm"> * conjunction with pevent_find_function to print both the function</span>
<span class="cm"> * name and the function offset.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">pevent_find_function_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">find_func</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_register_function - register a function with a given address</span>
<span class="cm"> * @pevent: handle for the pevent</span>
<span class="cm"> * @function: the function name to register</span>
<span class="cm"> * @addr: the address the function starts at</span>
<span class="cm"> * @mod: the kernel module the function may be in (NULL for none)</span>
<span class="cm"> *</span>
<span class="cm"> * This registers a function name with an address and module.</span>
<span class="cm"> * The @func passed in is duplicated.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_register_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">func_list</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>

	<span class="n">item</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">));</span>

	<span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">funclist</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">)</span>
		<span class="n">item</span><span class="o">-&gt;</span><span class="n">mod</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">item</span><span class="o">-&gt;</span><span class="n">mod</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">funclist</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_print_funcs - print out the stored functions</span>
<span class="cm"> * @pevent: handle for the pevent</span>
<span class="cm"> *</span>
<span class="cm"> * This prints out the stored functions.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pevent_print_funcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">)</span>
		<span class="n">func_map_init</span><span class="p">(</span><span class="n">pevent</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%016llx %s&quot;</span><span class="p">,</span>
		       <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
		       <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">func</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">printk_map</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>		<span class="n">addr</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="o">*</span><span class="n">printk</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">printk_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">printk_list</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>	<span class="n">addr</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">printk</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">printk_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">fa</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">printk_map_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">printk_list</span> <span class="o">*</span><span class="n">printklist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">printk_list</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">printk_map</span> <span class="o">*</span><span class="n">printk_map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk_map</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">printk_map</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">printklist</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printklist</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">printklist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">printk</span> <span class="o">=</span> <span class="n">printklist</span><span class="o">-&gt;</span><span class="n">printk</span><span class="p">;</span>
		<span class="n">printk_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">printklist</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">printklist</span><span class="p">;</span>
		<span class="n">printklist</span> <span class="o">=</span> <span class="n">printklist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qsort</span><span class="p">(</span><span class="n">printk_map</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">printk_map</span><span class="p">),</span> <span class="n">printk_cmp</span><span class="p">);</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span> <span class="o">=</span> <span class="n">printk_map</span><span class="p">;</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printklist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">printk_map</span> <span class="o">*</span>
<span class="nf">find_printk</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">printk_map</span> <span class="o">*</span><span class="n">printk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">printk_map</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span><span class="p">)</span>
		<span class="n">printk_map_init</span><span class="p">(</span><span class="n">pevent</span><span class="p">);</span>

	<span class="n">key</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">printk</span> <span class="o">=</span> <span class="n">bsearch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_count</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span><span class="p">),</span> <span class="n">printk_cmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">printk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_register_print_string - register a string by its address</span>
<span class="cm"> * @pevent: handle for the pevent</span>
<span class="cm"> * @fmt: the string format to register</span>
<span class="cm"> * @addr: the address the string was located at</span>
<span class="cm"> *</span>
<span class="cm"> * This registers a string by the address it was stored in the kernel.</span>
<span class="cm"> * The @fmt passed in is duplicated.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_register_print_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">printk_list</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>

	<span class="n">item</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">));</span>

	<span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printklist</span><span class="p">;</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printklist</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">printk</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_print_printk - print out the stored strings</span>
<span class="cm"> * @pevent: handle for the pevent</span>
<span class="cm"> *</span>
<span class="cm"> * This prints the string formats that were stored.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pevent_print_printk</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span><span class="p">)</span>
		<span class="n">printk_map_init</span><span class="p">(</span><span class="n">pevent</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%016llx %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
		       <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">printk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="nf">alloc_event</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">event</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span>
			<span class="n">realloc</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">*</span>
				<span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Can not allocate events&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="o">++</span><span class="p">;</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">pevent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_item_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EVENT_ITEM</span> <span class="p">...</span> <span class="n">EVENT_SQUOTE</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_ERROR</span> <span class="p">...</span> <span class="n">EVENT_DELIM</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_flag_sym</span><span class="p">(</span><span class="k">struct</span> <span class="n">print_flag_sym</span> <span class="o">*</span><span class="n">fsym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_flag_sym</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">fsym</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">fsym</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">fsym</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">fsym</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">fsym</span><span class="p">);</span>
		<span class="n">fsym</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">farg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRINT_ATOM</span>:
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FIELD</span>:
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FLAGS</span>:
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">delim</span><span class="p">);</span>
		<span class="n">free_flag_sym</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_SYMBOL</span>:
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
		<span class="n">free_flag_sym</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">symbols</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_TYPE</span>:
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">item</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_STRING</span>:
	<span class="k">case</span> <span class="n">PRINT_BSTRING</span>:
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_DYNAMIC_ARRAY</span>:
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">dynarray</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_OP</span>:
		<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FUNC</span>:
		<span class="k">while</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">farg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">args</span><span class="p">;</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">farg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">free_arg</span><span class="p">(</span><span class="n">farg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRINT_NULL</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="nf">get_type</span><span class="p">(</span><span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EVENT_NEWLINE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">EVENT_SPACE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;_&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EVENT_ITEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EVENT_SQUOTE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EVENT_DQUOTE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isprint</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;(&#39;</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;)&#39;</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EVENT_DELIM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">EVENT_OP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__read_char</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_buf_ptr</span> <span class="o">&gt;=</span> <span class="n">input_buf_siz</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">input_buf</span><span class="p">[</span><span class="n">input_buf_ptr</span><span class="o">++</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__peek_char</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_buf_ptr</span> <span class="o">&gt;=</span> <span class="n">input_buf_siz</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">input_buf</span><span class="p">[</span><span class="n">input_buf_ptr</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_peek_char - peek at the next character that will be read</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the next character read, or -1 if end of buffer.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_peek_char</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__peek_char</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="n">force_token</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">);</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="nf">__read_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">last_ch</span><span class="p">,</span> <span class="n">quote_ch</span><span class="p">,</span> <span class="n">next_ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tok_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


	<span class="n">ch</span> <span class="o">=</span> <span class="n">__read_char</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">get_type</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EVENT_NEWLINE</span>:
	<span class="k">case</span> <span class="n">EVENT_DELIM</span>:
		<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EVENT_OP</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
			<span class="n">next_ch</span> <span class="o">=</span> <span class="n">__peek_char</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_ch</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_char</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;|&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;&amp;&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
			<span class="n">last_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">__peek_char</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="n">last_ch</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">test_equal</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_char</span><span class="p">();</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">last_ch</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
				<span class="k">goto</span> <span class="n">test_equal</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;!&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="k">goto</span> <span class="n">test_equal</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* what should we do instead? */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

 <span class="nl">test_equal:</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">__peek_char</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_char</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EVENT_DQUOTE</span>:
	<span class="k">case</span> <span class="n">EVENT_SQUOTE</span>:
		<span class="cm">/* don&#39;t keep quotes */</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="n">quote_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">last_ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">concat:</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">BUFSIZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="n">tok_size</span> <span class="o">+</span> <span class="n">BUFSIZ</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">tok</span><span class="p">)</span>
						<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>
					<span class="n">strcat</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">tok</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>
				<span class="n">tok_size</span> <span class="o">+=</span> <span class="n">BUFSIZ</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">last_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">__read_char</span><span class="p">();</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="cm">/* the &#39;\&#39; &#39;\&#39; will cancel itself */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">last_ch</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span>
				<span class="n">last_ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="n">quote_ch</span> <span class="o">||</span> <span class="n">last_ch</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">);</span>
		<span class="cm">/* remove the last quote */</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * For strings (double quotes) check the next token.</span>
<span class="cm">		 * If it is another string, concatinate the two.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_DQUOTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">save_input_buf_ptr</span> <span class="o">=</span> <span class="n">input_buf_ptr</span><span class="p">;</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="n">__read_char</span><span class="p">();</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">concat</span><span class="p">;</span>
			<span class="n">input_buf_ptr</span> <span class="o">=</span> <span class="n">save_input_buf_ptr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EVENT_ERROR</span> <span class="p">...</span> <span class="n">EVENT_SPACE</span>:
	<span class="k">case</span> <span class="n">EVENT_ITEM</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">get_type</span><span class="p">(</span><span class="n">__peek_char</span><span class="p">())</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">BUFSIZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="n">tok_size</span> <span class="o">+</span> <span class="n">BUFSIZ</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">tok</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>
				<span class="n">strcat</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">tok</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>
			<span class="n">tok_size</span> <span class="o">+=</span> <span class="n">BUFSIZ</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">__read_char</span><span class="p">();</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="n">tok_size</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">tok</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>
		<span class="n">strcat</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">tok</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ITEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Older versions of the kernel has a bug that</span>
<span class="cm">		 * creates invalid symbols and will break the mac80211</span>
<span class="cm">		 * parsing. This is a work around to that bug.</span>
<span class="cm">		 *</span>
<span class="cm">		 * See Linux kernel commit:</span>
<span class="cm">		 *  811cb50baf63461ce0bdb234927046131fc7fa8b</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="s">&quot;LOCAL_PR_FMT&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">);</span>
			<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">force_token</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">\%s</span><span class="se">\&quot;</span><span class="s"> &quot;</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="s">&quot;STA_PR_FMT&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">);</span>
			<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">force_token</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> sta:%pM</span><span class="se">\&quot;</span><span class="s"> &quot;</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="s">&quot;VIF_PR_FMT&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">);</span>
			<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">force_token</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> vif:%p(%d)</span><span class="se">\&quot;</span><span class="s"> &quot;</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="nf">force_token</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">save_input_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">save_input_buf_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">save_input_buf_siz</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	
	<span class="cm">/* save off the current input pointers */</span>
	<span class="n">save_input_buf</span> <span class="o">=</span> <span class="n">input_buf</span><span class="p">;</span>
	<span class="n">save_input_buf_ptr</span> <span class="o">=</span> <span class="n">input_buf_ptr</span><span class="p">;</span>
	<span class="n">save_input_buf_siz</span> <span class="o">=</span> <span class="n">input_buf_siz</span><span class="p">;</span>

	<span class="n">init_input_buf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">__read_token</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>

	<span class="cm">/* reset back to original token */</span>
	<span class="n">input_buf</span> <span class="o">=</span> <span class="n">save_input_buf</span><span class="p">;</span>
	<span class="n">input_buf_ptr</span> <span class="o">=</span> <span class="n">save_input_buf_ptr</span><span class="p">;</span>
	<span class="n">input_buf_siz</span> <span class="o">=</span> <span class="n">save_input_buf_siz</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tok</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="nf">read_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">__read_token</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_SPACE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

		<span class="n">free_token</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* not reached */</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_read_token - access to utilites to use the pevent parser</span>
<span class="cm"> * @tok: The token to return</span>
<span class="cm"> *</span>
<span class="cm"> * This will parse tokens from the string given by</span>
<span class="cm"> * pevent_init_data().</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the token type.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">event_type</span> <span class="nf">pevent_read_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_token</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_free_token - free a token returned by pevent_read_token</span>
<span class="cm"> * @token: the token to free</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pevent_free_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* no newline */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="nf">read_token_item</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">__read_token</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_SPACE</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_NEWLINE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">free_token</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* not reached */</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EVENT_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">,</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="n">expect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">expect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;Error: expected type %d but read %d&quot;</span><span class="p">,</span>
		    <span class="n">expect</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_type_token</span><span class="p">(</span><span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span>
		    <span class="k">enum</span> <span class="n">event_type</span> <span class="n">expect</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">expect_tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">expect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;Error: expected type %d but read %d&quot;</span><span class="p">,</span>
		    <span class="n">expect</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">expect_tok</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;Error: expected &#39;%s&#39; but read &#39;%s&#39;&quot;</span><span class="p">,</span>
		    <span class="n">expect_tok</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__read_expect_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">event_type</span> <span class="n">expect</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newline_ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newline_ok</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">test_type</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">expect</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_expect_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">event_type</span> <span class="n">expect</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__read_expect_type</span><span class="p">(</span><span class="n">expect</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__read_expected</span><span class="p">(</span><span class="k">enum</span> <span class="n">event_type</span> <span class="n">expect</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">newline_ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newline_ok</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">expect</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_expected</span><span class="p">(</span><span class="k">enum</span> <span class="n">event_type</span> <span class="n">expect</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__read_expected</span><span class="p">(</span><span class="n">expect</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_expected_item</span><span class="p">(</span><span class="k">enum</span> <span class="n">event_type</span> <span class="n">expect</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__read_expected</span><span class="p">(</span><span class="n">expect</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">event_read_name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">token</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_read_id</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected_item</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;ID&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">field_is_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_ARRAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;char&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;u8&quot;</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">strstr</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;s8&quot;</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">field_is_dynamic</span><span class="p">(</span><span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;__data_loc&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">field_is_long</span><span class="p">(</span><span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* includes long long */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;long&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_read_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">format_field</span> <span class="o">**</span><span class="n">fields</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">last_token</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_NEWLINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;field&quot;</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * The ftrace fields may still use the &quot;special&quot; name.</span>
<span class="cm">		 * Just ignore it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EVENT_FL_ISFTRACE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ITEM</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;special&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">last_token</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

		<span class="n">field</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">field</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">field</span><span class="p">));</span>
		<span class="n">field</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>

		<span class="cm">/* read the rest of the type */</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ITEM</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_OP</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="cm">/*</span>
<span class="cm">			     * Some of the ftrace fields are broken and have</span>
<span class="cm">			     * an illegal &quot;.&quot; in them.</span>
<span class="cm">			     */</span>
			    <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EVENT_FL_ISFTRACE</span> <span class="o">&amp;&amp;</span>
			     <span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_OP</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIELD_IS_POINTER</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
							      <span class="n">strlen</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
							      <span class="n">strlen</span><span class="p">(</span><span class="n">last_token</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
					<span class="n">strcat</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
					<span class="n">strcat</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">last_token</span><span class="p">);</span>
					<span class="n">free</span><span class="p">(</span><span class="n">last_token</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">last_token</span><span class="p">;</span>
				<span class="n">last_token</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;no type found&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">last_token</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_type</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">EVENT_OP</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">event_type</span> <span class="n">last_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">brackets</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIELD_IS_ARRAY</span><span class="p">;</span>

			<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ITEM</span><span class="p">)</span>
				<span class="n">field</span><span class="o">-&gt;</span><span class="n">arraylen</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">field</span><span class="o">-&gt;</span><span class="n">arraylen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		        <span class="k">while</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">last_type</span> <span class="o">==</span> <span class="n">EVENT_ITEM</span> <span class="o">&amp;&amp;</span>
				    <span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ITEM</span><span class="p">)</span>
					<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">last_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

				<span class="n">brackets</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">brackets</span><span class="p">,</span>
						   <span class="n">strlen</span><span class="p">(</span><span class="n">brackets</span><span class="p">)</span> <span class="o">+</span>
						   <span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">strcat</span><span class="p">(</span><span class="n">brackets</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">brackets</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
				<span class="cm">/* We only care about the last token */</span>
				<span class="n">field</span><span class="o">-&gt;</span><span class="n">arraylen</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_NONE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">die</span><span class="p">(</span><span class="s">&quot;failed to find token&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

			<span class="n">brackets</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">brackets</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">brackets</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">brackets</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>

			<span class="cm">/* add brackets to type */</span>

			<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the next token is not an OP, then it is of</span>
<span class="cm">			 * the format: type [] item;</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ITEM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
						      <span class="n">strlen</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
						      <span class="n">strlen</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span>
						      <span class="n">strlen</span><span class="p">(</span><span class="n">brackets</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">free_token</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">brackets</span><span class="p">);</span>
				<span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
						      <span class="n">strlen</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
						      <span class="n">strlen</span><span class="p">(</span><span class="n">brackets</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">brackets</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">free</span><span class="p">(</span><span class="n">brackets</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">field_is_string</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
			<span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIELD_IS_STRING</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_is_dynamic</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
			<span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIELD_IS_DYNAMIC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field_is_long</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
			<span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIELD_IS_LONG</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span>  <span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;offset&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_expect</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_expect</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_expect</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;size&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_expect</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_expect</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_expect</span><span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_NEWLINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* newer versions of the kernel have a &quot;signed&quot; type */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;signed&quot;</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_expect</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

			<span class="cm">/* add signed type */</span>

			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_expect</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_NEWLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_ARRAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">arraylen</span><span class="p">)</span>
				<span class="n">field</span><span class="o">-&gt;</span><span class="n">elementsize</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">arraylen</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_STRING</span><span class="p">)</span>
				<span class="n">field</span><span class="o">-&gt;</span><span class="n">elementsize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">field</span><span class="o">-&gt;</span><span class="n">elementsize</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">long_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">field</span><span class="o">-&gt;</span><span class="n">elementsize</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

		<span class="o">*</span><span class="n">fields</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
		<span class="n">fields</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
<span class="nl">fail_expect:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_read_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected_item</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;format&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_NEWLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">event_read_fields</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">common_fields</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">nr_common</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">event_read_fields</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">fields</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">nr_fields</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="n">process_arg_token</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
		  <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">,</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">);</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">process_arg_token</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="n">process_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">);</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_cond</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">right</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>

	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_OP</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

 <span class="nl">again:</span>
	<span class="cm">/* Handle other operations in the arguments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_OP</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_op</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

	<span class="n">top</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="cm">/* Top may point to itself */</span>
	<span class="n">top</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>

	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">top</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_op_prio</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;~&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;!&#39;</span>:
			<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;*&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;/&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;%&#39;</span>:
			<span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
			<span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
			<span class="cm">/* &#39;&gt;&gt;&#39; and &#39;&lt;&lt;&#39; are 8 */</span>
		<span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
			<span class="k">return</span> <span class="mi">9</span><span class="p">;</span>
			<span class="cm">/* &#39;==&#39; and &#39;!=&#39; are 10 */</span>
		<span class="k">case</span> <span class="sc">&#39;&amp;&#39;</span>:
			<span class="k">return</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;^&#39;</span>:
			<span class="k">return</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;|&#39;</span>:
			<span class="k">return</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%c&#39;&quot;</span><span class="p">,</span> <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;++&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;--&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			   <span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;&gt;=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			   <span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;&lt;=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">9</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;==&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			   <span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;!=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;&amp;&amp;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">14</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;||&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">15</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_op_prio</span><span class="p">(</span><span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* single ops are the greatest */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">||</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PRINT_NULL</span><span class="p">)</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">prio</span> <span class="o">=</span> <span class="n">get_op_prio</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">prio</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Note, *tok does not get freed, but will most likely be saved */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">right</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="cm">/* the op is passed in via tok */</span>
	<span class="n">token</span> <span class="o">=</span> <span class="o">*</span><span class="n">tok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PRINT_OP</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* handle single op */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;bad op token %s&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;~&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;!&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;bad op token %s&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="cm">/* make an empty left */</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
		<span class="n">left</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_NULL</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>

		<span class="n">right</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>

		<span class="cm">/* do not free the token, it belongs to an op */</span>
		<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;?&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">left</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
		<span class="cm">/* copy the top arg to the left */</span>
		<span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_OP</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">process_cond</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&amp;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;|&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&amp;&amp;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;||&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;+&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;^&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;==&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;!=&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">left</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>

		<span class="cm">/* copy the top arg to the left */</span>
		<span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_OP</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">set_op_prio</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EVENT_FL_FAILED</span><span class="p">;</span>
			<span class="cm">/* arg-&gt;op.op (= token) will be freed at out_free */</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

		<span class="cm">/* could just be a type pointer */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_DELIM</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PRINT_ATOM</span><span class="p">)</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;bad pointer type&quot;</span><span class="p">);</span>
			<span class="n">left</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">,</span>
					    <span class="n">strlen</span><span class="p">(</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">,</span> <span class="s">&quot; *&quot;</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
			<span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="o">*</span><span class="n">left</span><span class="p">;</span>
			<span class="n">free</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">right</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg_token</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">left</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
		<span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_OP</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>

		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">process_array</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EVENT_FL_FAILED</span><span class="p">;</span>
		<span class="cm">/* the arg is now the left side */</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_OP</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">prio</span><span class="p">;</span>

		<span class="cm">/* higher prios need to be closer to the root */</span>
		<span class="n">prio</span> <span class="o">=</span> <span class="n">get_op_prio</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prio</span> <span class="o">&gt;</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">prio</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">process_op</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">process_op</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

 <span class="nl">out_free:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span> <span class="n">__unused</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
	      <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;-&gt;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">field</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_FIELD</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_flag_field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_any_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIELD_IS_FLAG</span><span class="p">;</span>
		<span class="n">is_flag_field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_symbolic_field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_any_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIELD_IS_SYMBOLIC</span><span class="p">;</span>
		<span class="n">is_symbolic_field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

 <span class="nl">out_free:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
 <span class="nl">out_err:</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg_eval</span> <span class="p">(</span><span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">eval_type_str</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pointer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;pointer expected with non pointer type&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ref</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="cm">/* chop off the &quot; *&quot; */</span>
		<span class="n">ref</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">eval_type_str</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if this is a pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Try to figure out the arg size*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;struct&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* all bets off */</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;u8&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;u16&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;u32&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;u64&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;s64&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;s8&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">char</span><span class="p">)</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;s16&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">short</span><span class="p">)</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;s32&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;unsigned &quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">+=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;char&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sign</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">char</span><span class="p">)</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;short&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sign</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">short</span><span class="p">)</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sign</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to figure out the type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">eval_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pointer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PRINT_TYPE</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;expected type argument&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">eval_type_str</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pointer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arg_num_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="kt">long</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRINT_ATOM</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">strtoll</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_TYPE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">item</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">eval_type</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_OP</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;|&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">||</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">|</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;&amp;&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&amp;&amp;</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&amp;</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&gt;=</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;!&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
			<span class="cm">/* check for negative */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PRINT_NULL</span><span class="p">)</span>
				<span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">-</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PRINT_NULL</span><span class="p">)</span>
				<span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRINT_NULL</span>:
	<span class="k">case</span> <span class="n">PRINT_FIELD</span> <span class="p">...</span> <span class="n">PRINT_SYMBOL</span>:
	<span class="k">case</span> <span class="n">PRINT_STRING</span>:
	<span class="k">case</span> <span class="n">PRINT_BSTRING</span>:
	<span class="nl">default:</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;invalid eval type %d&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">arg_eval</span> <span class="p">(</span><span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRINT_ATOM</span>:
		<span class="k">return</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_TYPE</span>:
		<span class="k">return</span> <span class="n">arg_eval</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">item</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PRINT_OP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg_num_eval</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRINT_NULL</span>:
	<span class="k">case</span> <span class="n">PRINT_FIELD</span> <span class="p">...</span> <span class="n">PRINT_SYMBOL</span>:
	<span class="k">case</span> <span class="n">PRINT_STRING</span>:
	<span class="k">case</span> <span class="n">PRINT_BSTRING</span>:
	<span class="nl">default:</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;invalid eval type %d&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_flag_sym</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_flag_sym</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span> <span class="o">=</span> <span class="o">*</span><span class="n">tok</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;{&quot;</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>

		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_OP</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">process_op</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ERROR</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

		<span class="n">field</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">field</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">field</span><span class="p">));</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">arg_eval</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">field</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>

		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;}&quot;</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">arg_eval</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">field</span><span class="o">-&gt;</span><span class="n">str</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
		<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
		<span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_DELIM</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">));</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_FLAGS</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

	<span class="cm">/* Handle operations in the first argument */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_OP</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_op</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_item_type</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">delim</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">process_fields</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

 <span class="nl">out_free:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_symbols</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">));</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_SYMBOL</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">process_fields</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">symbols</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

 <span class="nl">out_free:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_dynamic_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">));</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_DYNAMIC_ARRAY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The item within the parenthesis is another field that holds</span>
<span class="cm">	 * the index into where the array starts.</span>
<span class="cm">	 */</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_ITEM</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="cm">/* Find the field */</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">dynarray</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">dynarray</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_OP</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ERROR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_arg</span><span class="p">;</span>

	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="n">tok</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

 <span class="nl">out_free_arg:</span>
	<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
 <span class="nl">out_free:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_paren</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">item_arg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ERROR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_OP</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_op</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ERROR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the next token is an item or another open paren, then</span>
<span class="cm">	 * this was a typecast.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_item_type</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_DELIM</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;(&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* make this a typecast and contine */</span>

		<span class="cm">/* prevous must be an atom */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PRINT_ATOM</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;previous needed to be PRINT_ATOM&quot;</span><span class="p">);</span>

		<span class="n">item_arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>

		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_TYPE</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">item_arg</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg_token</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">item_arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

 <span class="nl">out_free:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span> <span class="n">__unused</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_STRING</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>

 <span class="nl">out_free:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
 <span class="nl">out_err:</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span>
<span class="nf">find_func_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">func</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_handlers</span><span class="p">;</span> <span class="n">func</span><span class="p">;</span> <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">func</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_func_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">**</span><span class="n">next</span><span class="p">;</span>

	<span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_handlers</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">func</span> <span class="o">=</span> <span class="o">*</span><span class="n">next</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">free_func_handle</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_func_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">**</span><span class="n">next_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">farg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">test</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_FUNC</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">next_arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">args</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">nr_args</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">farg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">farg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">nr_args</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">test</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">test</span> <span class="o">=</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">free_arg</span><span class="p">(</span><span class="n">farg</span><span class="p">);</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">next_arg</span> <span class="o">=</span> <span class="n">farg</span><span class="p">;</span>
		<span class="n">next_arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">farg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
		 <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;__print_flags&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">is_flag_field</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">process_flags</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;__print_symbolic&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">is_symbolic_field</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">process_symbols</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;__get_str&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">process_str</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;__get_dynamic_array&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">process_dynamic_array</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">find_func_handler</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">process_func_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;function %s not defined&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">event_type</span>
<span class="nf">process_arg_token</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
		  <span class="kt">char</span> <span class="o">**</span><span class="n">tok</span><span class="p">,</span> <span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">atom</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="o">*</span><span class="n">tok</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EVENT_ITEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;REC&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">process_entry</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atom</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
		<span class="cm">/* test the next token */</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the next token is a parenthesis, then this</span>
<span class="cm">		 * is a function.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_DELIM</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;(&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/* this will free atom. */</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">process_function</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* atoms can be more than one token long */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ITEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atom</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_ATOM</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EVENT_DQUOTE</span>:
	<span class="k">case</span> <span class="n">EVENT_SQUOTE</span>:
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_ATOM</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_DELIM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;(&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">process_paren</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">EVENT_OP</span>:
		<span class="cm">/* handle single ops */</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_OP</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">process_op</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

		<span class="cm">/* On error, the op is freed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ERROR</span><span class="p">)</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* return error type if errored */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EVENT_ERROR</span> <span class="p">...</span> <span class="n">EVENT_NEWLINE</span>:
	<span class="nl">default:</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;unexpected type %d&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_read_print_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">EVENT_ERROR</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">args</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_NEWLINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">process_arg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">args</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_OP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">process_op</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">free_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_DELIM</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_NONE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_ERROR</span><span class="p">)</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">args</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_read_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected_item</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;print&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;fmt&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_DQUOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

 <span class="nl">concat:</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* ok to have no arg */</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Handle concatenation of print lines */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">EVENT_DQUOTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">cat</span><span class="p">;</span>

		<span class="n">cat</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">cat</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">concat</span><span class="p">;</span>
	<span class="p">}</span>
			     
	<span class="k">if</span> <span class="p">(</span><span class="n">test_type_token</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">EVENT_DELIM</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">event_read_print_args</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_find_common_field - return a common field by event</span>
<span class="cm"> * @event: handle for the event</span>
<span class="cm"> * @name: the name of the common field to return</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a common field from the event by the given @name.</span>
<span class="cm"> * This only searchs the common fields and not all field.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span>
<span class="nf">pevent_find_common_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">format</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">common_fields</span><span class="p">;</span>
	     <span class="n">format</span><span class="p">;</span> <span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">format</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_find_field - find a non-common field</span>
<span class="cm"> * @event: handle for the event</span>
<span class="cm"> * @name: the name of the non-common field</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a non-common field by the given @name.</span>
<span class="cm"> * This does not search common fields.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span>
<span class="nf">pevent_find_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">format</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">fields</span><span class="p">;</span>
	     <span class="n">format</span><span class="p">;</span> <span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">format</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_find_any_field - find any field by name</span>
<span class="cm"> * @event: handle for the event</span>
<span class="cm"> * @name: the name of the field</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a field by the given @name.</span>
<span class="cm"> * This searchs the common field names first, then</span>
<span class="cm"> * the non-common ones if a common one was not found.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span>
<span class="nf">pevent_find_any_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">pevent_find_common_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">format</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pevent_find_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_read_number - read a number from data</span>
<span class="cm"> * @pevent: handle for the pevent</span>
<span class="cm"> * @ptr: the raw data</span>
<span class="cm"> * @size: the size of the data that holds the number</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number (converted to host) from the</span>
<span class="cm"> * raw data.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">pevent_read_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">data2host2</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="n">data2host4</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="n">data2host8</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="cm">/* BUG! */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_read_number_field - read a number from data</span>
<span class="cm"> * @field: a handle to the field</span>
<span class="cm"> * @data: the raw data to read</span>
<span class="cm"> * @value: the value to place the number in</span>
<span class="cm"> *</span>
<span class="cm"> * Reads raw data according to a field offset and size,</span>
<span class="cm"> * and translates it into @value.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, -1 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_read_number_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">,</span>
					    <span class="n">data</span> <span class="o">+</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_common_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * All events should have the same common elements.</span>
<span class="cm">	 * Pick any event to find where the type is;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;no event_list!&quot;</span><span class="p">);</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_common_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;field &#39;%s&#39; not found&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__parse_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_common_info</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="o">*</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">trace_parse_common_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__parse_common</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">type_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">type_offset</span><span class="p">,</span>
			      <span class="s">&quot;common_type&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_common_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__parse_common</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">pid_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">pid_offset</span><span class="p">,</span>
			      <span class="s">&quot;common_pid&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_common_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__parse_common</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">pc_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">pc_offset</span><span class="p">,</span>
			      <span class="s">&quot;common_preempt_count&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_common_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__parse_common</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">flags_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">flags_offset</span><span class="p">,</span>
			      <span class="s">&quot;common_flags&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_common_lock_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__parse_common</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">ld_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">ld_offset</span><span class="p">,</span>
			     <span class="s">&quot;common_lock_depth&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">events_id_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_find_event - find an event by given id</span>
<span class="cm"> * @pevent: a handle to the pevent</span>
<span class="cm"> * @id: the id of the event</span>
<span class="cm"> *</span>
<span class="cm"> * Returns an event that has a given @id.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="nf">pevent_find_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">**</span><span class="n">eventptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">pkey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">;</span>

	<span class="cm">/* Check cache first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_event</span> <span class="o">&amp;&amp;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_event</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_event</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">eventptr</span> <span class="o">=</span> <span class="n">bsearch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkey</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">),</span> <span class="n">events_id_cmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eventptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_event</span> <span class="o">=</span> <span class="o">*</span><span class="n">eventptr</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">*</span><span class="n">eventptr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_find_event_by_name - find an event by given name</span>
<span class="cm"> * @pevent: a handle to the pevent</span>
<span class="cm"> * @sys: the system name to search for</span>
<span class="cm"> * @name: the name of the event to search for</span>
<span class="cm"> *</span>
<span class="cm"> * This returns an event with a given @name and under the system</span>
<span class="cm"> * @sys. If @sys is NULL the first event with @name is returned.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span>
<span class="nf">pevent_find_event_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sys</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_event</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">sys</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_event</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sys</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="n">sys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">)</span>
		<span class="n">event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">event</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">eval_num_arg</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">typearg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">larg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field_size</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRINT_NULL</span>:
		<span class="cm">/* ?? */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_ATOM</span>:
		<span class="k">return</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PRINT_FIELD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_any_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">)</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;field %s not found&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* must be a number */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FLAGS</span>:
	<span class="k">case</span> <span class="n">PRINT_SYMBOL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_TYPE</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">item</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">eval_type</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PRINT_STRING</span>:
	<span class="k">case</span> <span class="n">PRINT_BSTRING</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FUNC</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">trace_seq</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">trace_seq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">process_defined_func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">trace_seq_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PRINT_OP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Arrays are special, since we don&#39;t want</span>
<span class="cm">			 * to read the arg as is.</span>
<span class="cm">			 */</span>
			<span class="n">right</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>

			<span class="cm">/* handle typecasts */</span>
			<span class="n">larg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">larg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PRINT_TYPE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">typearg</span><span class="p">)</span>
					<span class="n">typearg</span> <span class="o">=</span> <span class="n">larg</span><span class="p">;</span>
				<span class="n">larg</span> <span class="o">=</span> <span class="n">larg</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">item</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Default to long size */</span>
			<span class="n">field_size</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">long_size</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">larg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PRINT_DYNAMIC_ARRAY</span>:
				<span class="n">offset</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span>
						   <span class="n">data</span> <span class="o">+</span> <span class="n">larg</span><span class="o">-&gt;</span><span class="n">dynarray</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
						   <span class="n">larg</span><span class="o">-&gt;</span><span class="n">dynarray</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">larg</span><span class="o">-&gt;</span><span class="n">dynarray</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">elementsize</span><span class="p">)</span>
					<span class="n">field_size</span> <span class="o">=</span> <span class="n">larg</span><span class="o">-&gt;</span><span class="n">dynarray</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">elementsize</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * The actual length of the dynamic array is stored</span>
<span class="cm">				 * in the top half of the field, and the offset</span>
<span class="cm">				 * is in the bottom half of the 32 bit field.</span>
<span class="cm">				 */</span>
				<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PRINT_FIELD</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">larg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">larg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span>
						<span class="n">pevent_find_any_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">larg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">larg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">)</span>
						<span class="n">die</span><span class="p">(</span><span class="s">&quot;field %s not found&quot;</span><span class="p">,</span> <span class="n">larg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">field_size</span> <span class="o">=</span> <span class="n">larg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">elementsize</span><span class="p">;</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">larg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span>
					<span class="n">right</span> <span class="o">*</span> <span class="n">larg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">elementsize</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">goto</span> <span class="n">default_op</span><span class="p">;</span> <span class="cm">/* oops, all bets off */</span>
			<span class="p">}</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span>
						 <span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">field_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">typearg</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">eval_type</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">typearg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;?&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
 <span class="nl">default_op:</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;!&#39;</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="o">!</span><span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;~&#39;</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="o">~</span><span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;|&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">||</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">|</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;&amp;&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&amp;&amp;</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&amp;</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&gt;=</span> <span class="n">right</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">-</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;/&#39;</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">/</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;*&#39;</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">left</span> <span class="o">*</span> <span class="n">right</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;unknown op &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* not sure what to do there */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">flag</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">flag</span> <span class="n">flags</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;HI_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;TIMER_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;NET_TX_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;NET_RX_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;BLOCK_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;BLOCK_IOPOLL_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;TASKLET_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SCHED_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HRTIMER_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;RCU_SOFTIRQ&quot;</span><span class="p">,</span> <span class="mi">9</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;HRTIMER_NORESTART&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HRTIMER_RESTART&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">eval_flag</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some flags in the format files do not get converted.</span>
<span class="cm">	 * If the flag is not numeric, see if it is something that</span>
<span class="cm">	 * we already know about.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_str_to_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">len_arg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len_arg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_str_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">len_arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_flag_sym</span> <span class="o">*</span><span class="n">flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="n">fval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">print</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRINT_NULL</span>:
		<span class="cm">/* ?? */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_ATOM</span>:
		<span class="n">print_str_to_seq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FIELD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_any_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">)</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;field %s not found&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Zero sized fields, mean the rest of the data */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">?</span> <span class="o">:</span> <span class="n">size</span> <span class="o">-</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Some events pass in pointers. If this is not an array</span>
<span class="cm">		 * and the size is the same as long_size, assume that it</span>
<span class="cm">		 * is a pointer.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_ARRAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">long_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">str</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">print_str_to_seq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FLAGS</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
		<span class="n">print</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">flag</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span> <span class="n">flag</span><span class="p">;</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fval</span> <span class="o">=</span> <span class="n">eval_flag</span><span class="p">(</span><span class="n">flag</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">print_str_to_seq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="n">flag</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fval</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">fval</span><span class="p">)</span> <span class="o">==</span> <span class="n">fval</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">delim</span><span class="p">)</span>
					<span class="n">trace_seq_puts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">delim</span><span class="p">);</span>
				<span class="n">print_str_to_seq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="n">flag</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
				<span class="n">print</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">fval</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_SYMBOL</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">flag</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">symbols</span><span class="p">;</span> <span class="n">flag</span><span class="p">;</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fval</span> <span class="o">=</span> <span class="n">eval_flag</span><span class="p">(</span><span class="n">flag</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">fval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">print_str_to_seq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="n">flag</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRINT_TYPE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_STRING</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">str_offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

			<span class="n">f</span> <span class="o">=</span> <span class="n">pevent_find_any_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">str_offset</span> <span class="o">=</span> <span class="n">data2host4</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">str_offset</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">print_str_to_seq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">str_offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PRINT_BSTRING</span>:
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_OP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The only op for string should be ? :</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="n">print_str_arg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
				      <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">print_str_arg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
				      <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FUNC</span>:
		<span class="n">process_defined_func</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* well... */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">process_defined_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span><span class="n">func_handle</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pevent_func_params</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">farg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_seq</span> <span class="n">str</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">save_str</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">save_str</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">strings</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">nr_args</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)(</span><span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">farg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">args</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>

	<span class="n">args</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">*</span> <span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">nr_args</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">nr_args</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PEVENT_FUNC_ARG_INT</span>:
		<span class="k">case</span> <span class="n">PEVENT_FUNC_ARG_LONG</span>:
		<span class="k">case</span> <span class="n">PEVENT_FUNC_ARG_PTR</span>:
			<span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">farg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PEVENT_FUNC_ARG_STRING</span>:
			<span class="n">trace_seq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">);</span>
			<span class="n">print_str_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">farg</span><span class="p">);</span>
			<span class="n">trace_seq_terminate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">);</span>
			<span class="n">string</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">string</span><span class="p">));</span>
			<span class="n">string</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">strings</span><span class="p">;</span>
			<span class="n">string</span><span class="o">-&gt;</span><span class="n">str</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
			<span class="n">strings</span> <span class="o">=</span> <span class="n">string</span><span class="p">;</span>
			<span class="n">trace_seq_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * Something went totally wrong, this is not</span>
<span class="cm">			 * an input error, something in this code broke.</span>
<span class="cm">			 */</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unexpected end of arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">farg</span> <span class="o">=</span> <span class="n">farg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)(</span><span class="n">s</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">strings</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">string</span> <span class="o">=</span> <span class="n">strings</span><span class="p">;</span>
		<span class="n">strings</span> <span class="o">=</span> <span class="n">string</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">string</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="cm">/* TBD : handle return type here */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="nf">make_bprint_args</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span> <span class="o">*</span><span class="n">ip_field</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bptr</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">bprint_buf_field</span><span class="p">;</span>
	<span class="n">ip_field</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">bprint_ip_field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;buf&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;can&#39;t find buffer field for binary printk&quot;</span><span class="p">);</span>
		<span class="n">ip_field</span> <span class="o">=</span> <span class="n">pevent_find_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;ip&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip_field</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;can&#39;t find ip field for binary printk&quot;</span><span class="p">);</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">bprint_buf_field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">bprint_ip_field</span> <span class="o">=</span> <span class="n">ip_field</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ip</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">ip_field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">ip_field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The first arg is the IP pointer.</span>
<span class="cm">	 */</span>
	<span class="n">args</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
	<span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_ATOM</span><span class="p">;</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="cm">/* skip the first &quot;%pf : &quot; */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">bptr</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	     <span class="n">bptr</span> <span class="o">&lt;</span> <span class="n">data</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="p">{</span>
 <span class="nl">process_again:</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;%&#39;</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
				<span class="n">ls</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">process_again</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
				<span class="n">ls</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">process_again</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;0&#39;</span> <span class="p">...</span> <span class="sc">&#39;9&#39;</span>:
				<span class="k">goto</span> <span class="n">process_again</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;p&#39;</span>:
				<span class="n">ls</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="cm">/* fall through */</span>
			<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:
				<span class="cm">/* the pointers are always 4 bytes aligned */</span>
				<span class="n">bptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bptr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="o">~</span><span class="mi">3</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">ls</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">ls</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">long_size</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">ls</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">bptr</span><span class="p">,</span> <span class="n">ls</span><span class="p">);</span>
				<span class="n">bptr</span> <span class="o">+=</span> <span class="n">ls</span><span class="p">;</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_ATOM</span><span class="p">;</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
				<span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
				<span class="n">arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_BSTRING</span><span class="p">;</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">bptr</span><span class="p">);</span>
				<span class="n">bptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">bptr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
				<span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">args</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">free_arg</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
		<span class="n">args</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">get_bprint_format</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span> <span class="n">__unused</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">printk_map</span> <span class="o">*</span><span class="n">printk</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">bprint_fmt_field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;fmt&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;can&#39;t find format field for binary printk&quot;</span><span class="p">);</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">bprint_fmt_field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">printk</span> <span class="o">=</span> <span class="n">find_printk</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="mi">45</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="s">&quot;%%pf : (NO FORMAT FOUND at %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">format</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">printk</span><span class="o">-&gt;</span><span class="n">printk</span><span class="p">;</span>
	<span class="cm">/* Remove any quotes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="s">&quot;%s : %s&quot;</span><span class="p">,</span> <span class="s">&quot;%pf&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="cm">/* remove ending quotes and new line since we will add one too */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">format</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">format</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_mac_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mac</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;%.2x:%.2x:%.2x:%.2x:%.2x:%.2x&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PRINT_FUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">process_defined_func</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PRINT_FIELD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ARG TYPE NOT FIELD BUT %d&quot;</span><span class="p">,</span>
				 <span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span> <span class="o">==</span> <span class="sc">&#39;m&#39;</span><span class="p">)</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;%.2x%.2x%.2x%.2x%.2x%.2x&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span>
			<span class="n">pevent_find_any_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;field %s not found&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;INVALIDMAC&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_event_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">fields</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; %s=&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_ARRAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_DYNAMIC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_STRING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">trace_seq_puts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ARRAY[&quot;</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
						<span class="n">trace_seq_puts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>
					<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span>
							 <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;]&#39;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
						 <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_POINTER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;0x%llx&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_SIGNED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">4</span>:
					<span class="cm">/*</span>
<span class="cm">					 * If field is long then print it in hex.</span>
<span class="cm">					 * A long usually stores pointers.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_LONG</span><span class="p">)</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%2d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%1d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_LONG</span><span class="p">)</span>
					<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;0x%llx&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%llu&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_fmt</span> <span class="o">*</span><span class="n">print_fmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">print_fmt</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">print_fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">func_map</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">saveptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bprint_fmt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">format</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">show_func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len_as_arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len_arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ls</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EVENT_FL_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;[FAILED TO PARSE]&quot;</span><span class="p">);</span>
		<span class="n">print_event_fields</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EVENT_FL_ISBPRINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bprint_fmt</span> <span class="o">=</span> <span class="n">get_bprint_format</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">args</span> <span class="o">=</span> <span class="n">make_bprint_args</span><span class="p">(</span><span class="n">bprint_fmt</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">bprint_fmt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
				<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;t&#39;</span>:
				<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\t&#39;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
				<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\r&#39;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;\\&#39;</span>:
				<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\\&#39;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">saveptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
			<span class="n">show_func</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">len_as_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">cont_process:</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;%&#39;</span>:
				<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;%&#39;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;#&#39;</span>:
				<span class="cm">/* FIXME: need to handle properly */</span>
				<span class="k">goto</span> <span class="n">cont_process</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
				<span class="n">ls</span><span class="o">--</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cont_process</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
				<span class="n">ls</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cont_process</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
				<span class="n">ls</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cont_process</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;*&#39;</span>:
				<span class="cm">/* The argument is the length. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
					<span class="n">die</span><span class="p">(</span><span class="s">&quot;no argument match&quot;</span><span class="p">);</span>
				<span class="n">len_arg</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
				<span class="n">len_as_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cont_process</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;.&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;z&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;Z&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;0&#39;</span> <span class="p">...</span> <span class="sc">&#39;9&#39;</span>:
				<span class="k">goto</span> <span class="n">cont_process</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;p&#39;</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">long_size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
					<span class="n">ls</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ls</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;F&#39;</span> <span class="o">||</span>
				    <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
					<span class="n">show_func</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;m&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">print_mac_arg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
					<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* fall through */</span>
			<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;X&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
					<span class="n">die</span><span class="p">(</span><span class="s">&quot;no argument match&quot;</span><span class="p">);</span>

				<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">saveptr</span><span class="p">;</span>

				<span class="cm">/* should never happen */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
					<span class="n">die</span><span class="p">(</span><span class="s">&quot;bad format!&quot;</span><span class="p">);</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">saveptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">format</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">val</span> <span class="o">=</span> <span class="n">eval_num_arg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">show_func</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">func</span> <span class="o">=</span> <span class="n">find_func</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">trace_seq_puts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">show_func</span> <span class="o">==</span> <span class="sc">&#39;F&#39;</span><span class="p">)</span>
							<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
							       <span class="s">&quot;+0x%llx&quot;</span><span class="p">,</span>
							       <span class="n">val</span> <span class="o">-</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">long_size</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

					<span class="n">ls</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="cm">/* make %l into %ll */</span>
					<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
						<span class="n">memmove</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="s">&quot;%p&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">strcpy</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="s">&quot;0x%llx&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="o">-</span><span class="mi">2</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">len_as_arg</span><span class="p">)</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">len_as_arg</span><span class="p">)</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">len_as_arg</span><span class="p">)</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">len_as_arg</span><span class="p">)</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">len_as_arg</span><span class="p">)</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span>
								 <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">die</span><span class="p">(</span><span class="s">&quot;bad count (%d)&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
					<span class="n">die</span><span class="p">(</span><span class="s">&quot;no matching argument&quot;</span><span class="p">);</span>

				<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">saveptr</span><span class="p">;</span>

				<span class="cm">/* should never happen */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
					<span class="n">die</span><span class="p">(</span><span class="s">&quot;bad format!&quot;</span><span class="p">);</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">saveptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">format</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len_as_arg</span><span class="p">)</span>
					<span class="n">len_arg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">print_str_arg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
					      <span class="n">format</span><span class="p">,</span> <span class="n">len_arg</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;&gt;%c&lt;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_args</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">bprint_fmt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_data_lat_fmt - parse the data for the latency format</span>
<span class="cm"> * @pevent: a handle to the pevent</span>
<span class="cm"> * @s: the trace_seq to write to</span>
<span class="cm"> * @data: the raw data to read from</span>
<span class="cm"> * @size: currently unused.</span>
<span class="cm"> *</span>
<span class="cm"> * This parses out the Latency format (interrupts disabled,</span>
<span class="cm"> * need rescheduling, in hard/soft interrupt, preempt count</span>
<span class="cm"> * and lock depth) and places it into the trace_seq.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pevent_data_lat_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">check_lock_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">lock_depth_exists</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lat_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock_depth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hardirq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">softirq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">lat_flags</span> <span class="o">=</span> <span class="n">parse_common_flags</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">pc</span> <span class="o">=</span> <span class="n">parse_common_pc</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="cm">/* lock_depth may not always exist */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_lock_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>

		<span class="n">check_lock_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_common_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;common_lock_depth&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span>
			<span class="n">lock_depth_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock_depth_exists</span><span class="p">)</span>
		<span class="n">lock_depth</span> <span class="o">=</span> <span class="n">parse_common_lock_depth</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">hardirq</span> <span class="o">=</span> <span class="n">lat_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_FLAG_HARDIRQ</span><span class="p">;</span>
	<span class="n">softirq</span> <span class="o">=</span> <span class="n">lat_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_FLAG_SOFTIRQ</span><span class="p">;</span>

	<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%c%c%c&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">lat_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_FLAG_IRQS_OFF</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;d&#39;</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">lat_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_FLAG_IRQS_NOSUPPORT</span><span class="p">)</span> <span class="o">?</span>
	       <span class="sc">&#39;X&#39;</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">lat_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_FLAG_NEED_RESCHED</span><span class="p">)</span> <span class="o">?</span>
	       <span class="sc">&#39;N&#39;</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">hardirq</span> <span class="o">&amp;&amp;</span> <span class="n">softirq</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;H&#39;</span> <span class="o">:</span>
	       <span class="n">hardirq</span> <span class="o">?</span> <span class="sc">&#39;h&#39;</span> <span class="o">:</span> <span class="n">softirq</span> <span class="o">?</span> <span class="sc">&#39;s&#39;</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">)</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock_depth_exists</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">lock_depth</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">trace_seq_terminate</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_data_type - parse out the given event type</span>
<span class="cm"> * @pevent: a handle to the pevent</span>
<span class="cm"> * @rec: the record to read from</span>
<span class="cm"> *</span>
<span class="cm"> * This returns the event id from the @rec.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_data_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">trace_parse_common_type</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_data_event_from_type - find the event by a given type</span>
<span class="cm"> * @pevent: a handle to the pevent</span>
<span class="cm"> * @type: the type of the event.</span>
<span class="cm"> *</span>
<span class="cm"> * This returns the event form a given @type;</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="nf">pevent_data_event_from_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pevent_find_event</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_data_pid - parse the PID from raw data</span>
<span class="cm"> * @pevent: a handle to the pevent</span>
<span class="cm"> * @rec: the record to parse</span>
<span class="cm"> *</span>
<span class="cm"> * This returns the PID from a raw data.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_data_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">parse_common_pid</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_data_comm_from_pid - return the command line from PID</span>
<span class="cm"> * @pevent: a handle to the pevent</span>
<span class="cm"> * @pid: the PID of the task to search for</span>
<span class="cm"> *</span>
<span class="cm"> * This returns a pointer to the command line that has the given</span>
<span class="cm"> * @pid.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pevent_data_comm_from_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comm</span><span class="p">;</span>

	<span class="n">comm</span> <span class="o">=</span> <span class="n">find_cmdline</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">comm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_data_comm_from_pid - parse the data into the print format</span>
<span class="cm"> * @s: the trace_seq to write to</span>
<span class="cm"> * @event: the handle to the event</span>
<span class="cm"> * @cpu: the cpu the event was recorded on</span>
<span class="cm"> * @data: the raw data</span>
<span class="cm"> * @size: the size of the raw data</span>
<span class="cm"> * @nsecs: the timestamp of the event</span>
<span class="cm"> *</span>
<span class="cm"> * This parses the raw @data using the given @event information and</span>
<span class="cm"> * writes the print format into the trace_seq.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pevent_event_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">print_pretty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">print_raw</span><span class="p">)</span>
		<span class="n">print_event_fields</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
			<span class="n">print_pretty</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
						      <span class="n">event</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">print_pretty</span><span class="p">)</span>
			<span class="n">pretty_print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">trace_seq_terminate</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pevent_print_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spaces</span> <span class="o">=</span> <span class="s">&quot;                    &quot;</span><span class="p">;</span> <span class="cm">/* 20 spaces */</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">secs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">usecs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nsecs</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comm</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">secs</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">ts</span> <span class="o">/</span> <span class="n">NSECS_PER_SEC</span><span class="p">;</span>
	<span class="n">nsecs</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">ts</span> <span class="o">-</span> <span class="n">secs</span> <span class="o">*</span> <span class="n">NSECS_PER_SEC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;ug! negative record size %d&quot;</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">trace_parse_common_type</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">pevent_find_event</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;ug! no event found for type %d&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pid</span> <span class="o">=</span> <span class="n">parse_common_pid</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">comm</span> <span class="o">=</span> <span class="n">find_cmdline</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">latency_format</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%8.8s-%-5d %3d&quot;</span><span class="p">,</span>
		       <span class="n">comm</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">pevent_data_lat_fmt</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%16s-%-5d [%03d]&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PEVENT_NSEC_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usecs</span> <span class="o">=</span> <span class="n">nsecs</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usecs</span> <span class="o">=</span> <span class="p">(</span><span class="n">nsecs</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="n">NSECS_PER_USEC</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; %5lu.%0*lu: %s: &quot;</span><span class="p">,</span> <span class="n">secs</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">usecs</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Space out the event names evenly. */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%.*s&quot;</span><span class="p">,</span> <span class="mi">20</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>

	<span class="n">pevent_event_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">events_id_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">ea</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">eb</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ea</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">eb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ea</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">*</span><span class="n">eb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">events_name_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">ea</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">eb</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">((</span><span class="o">*</span><span class="n">ea</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">eb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">((</span><span class="o">*</span><span class="n">ea</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">eb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">events_id_cmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">events_system_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">ea</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">eb</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">((</span><span class="o">*</span><span class="n">ea</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">eb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">((</span><span class="o">*</span><span class="n">ea</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">eb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">events_id_cmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">event_format</span> <span class="o">**</span><span class="nf">pevent_list_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="k">enum</span> <span class="n">event_sort_type</span> <span class="n">sort_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">**</span><span class="n">events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">sort</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">);</span>

	<span class="n">events</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">sort_events</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;&amp;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_type</span> <span class="o">==</span> <span class="n">sort_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">events</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">events</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">events</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">events</span><span class="p">)</span> <span class="o">*</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">);</span>
		<span class="n">events</span><span class="p">[</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">sort_events</span> <span class="o">=</span> <span class="n">events</span><span class="p">;</span>

		<span class="cm">/* the internal events are sorted by id */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sort_type</span> <span class="o">==</span> <span class="n">EVENT_SORT_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_type</span> <span class="o">=</span> <span class="n">sort_type</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">events</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sort_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EVENT_SORT_ID</span>:
		<span class="n">sort</span> <span class="o">=</span> <span class="n">events_id_cmp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_SORT_NAME</span>:
		<span class="n">sort</span> <span class="o">=</span> <span class="n">events_name_cmp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_SORT_SYSTEM</span>:
		<span class="n">sort</span> <span class="o">=</span> <span class="n">events_system_cmp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">events</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qsort</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">events</span><span class="p">),</span> <span class="n">sort</span><span class="p">);</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">last_type</span> <span class="o">=</span> <span class="n">sort_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">events</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">format_field</span> <span class="o">**</span>
<span class="nf">get_event_fields</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">**</span><span class="n">fields</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fields</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">field</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span> <span class="n">field</span><span class="p">;</span> <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;event %s has more %s fields than specified&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;event %s has less %s fields than specified&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fields</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_event_common_fields - return a list of common fields for an event</span>
<span class="cm"> * @event: the event to return the common fields of.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns an allocated array of fields. The last item in the array is NULL.</span>
<span class="cm"> * The array must be freed with free().</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">format_field</span> <span class="o">**</span><span class="nf">pevent_event_common_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_event_fields</span><span class="p">(</span><span class="s">&quot;common&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">nr_common</span><span class="p">,</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">common_fields</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_event_fields - return a list of event specific fields for an event</span>
<span class="cm"> * @event: the event to return the fields of.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns an allocated array of fields. The last item in the array is NULL.</span>
<span class="cm"> * The array must be freed with free().</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">format_field</span> <span class="o">**</span><span class="nf">pevent_event_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_event_fields</span><span class="p">(</span><span class="s">&quot;event&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">nr_fields</span><span class="p">,</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">fields</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">print_flag_sym</span> <span class="o">*</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;{ %s, %s }&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_seq_puts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>
		<span class="n">print_fields</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* for debugging */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">print_paren</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_seq</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRINT_NULL</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;null&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_ATOM</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">atom</span><span class="p">.</span><span class="n">atom</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FIELD</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;REC-&gt;%s&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_FLAGS</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;__print_flags(&quot;</span><span class="p">);</span>
		<span class="n">print_args</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;, %s, &quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">delim</span><span class="p">);</span>
		<span class="n">trace_seq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">print_fields</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">trace_seq_do_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">trace_seq_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_SYMBOL</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;__print_symbolic(&quot;</span><span class="p">);</span>
		<span class="n">print_args</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
		<span class="n">trace_seq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">print_fields</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">symbols</span><span class="p">);</span>
		<span class="n">trace_seq_do_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">trace_seq_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_STRING</span>:
	<span class="k">case</span> <span class="n">PRINT_BSTRING</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;__get_str(%s)&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_TYPE</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;(%s)&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="n">print_args</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">typecast</span><span class="p">.</span><span class="n">item</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRINT_OP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">print_paren</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_paren</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">);</span>
		<span class="n">print_args</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %s &quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
		<span class="n">print_args</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_paren</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* we should warn... */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">print_args</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_header_field</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mandatory</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">save_input_buf_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">save_input_buf_siz</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">save_input_buf_ptr</span> <span class="o">=</span> <span class="n">input_buf_ptr</span><span class="p">;</span>
	<span class="n">save_input_buf_siz</span> <span class="o">=</span> <span class="n">input_buf_siz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;field&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is not a mandatory field, then test it first.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mandatory</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>
		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;offset&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="s">&quot;size&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">read_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_NEWLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* newer versions of the kernel have a &quot;signed&quot; type */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EVENT_ITEM</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;signed&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_ITEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_expected</span><span class="p">(</span><span class="n">EVENT_OP</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_expect_type</span><span class="p">(</span><span class="n">EVENT_NEWLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">token</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">fail:</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">discard:</span>
	<span class="n">input_buf_ptr</span> <span class="o">=</span> <span class="n">save_input_buf_ptr</span><span class="p">;</span>
	<span class="n">input_buf_siz</span> <span class="o">=</span> <span class="n">save_input_buf_siz</span><span class="p">;</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">free_token</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_parse_header_page - parse the data stored in the header page</span>
<span class="cm"> * @pevent: the handle to the pevent</span>
<span class="cm"> * @buf: the buffer storing the header page format string</span>
<span class="cm"> * @size: the size of @buf</span>
<span class="cm"> * @long_size: the long size to use if there is no header</span>
<span class="cm"> *</span>
<span class="cm"> * This parses the header page format for information on the</span>
<span class="cm"> * ring buffer used. The @buf should be copied from</span>
<span class="cm"> *</span>
<span class="cm"> * /sys/kernel/debug/tracing/events/header_page</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_parse_header_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">long_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ignore</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Old kernels did not have header page info.</span>
<span class="cm">		 * Sorry but we just use what we find here in user space.</span>
<span class="cm">		 */</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_ts_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_size_size</span> <span class="o">=</span> <span class="n">long_size</span><span class="p">;</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_data_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="o">+</span> <span class="n">long_size</span><span class="p">;</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">old_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_input_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">parse_header_field</span><span class="p">(</span><span class="s">&quot;timestamp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_ts_offset</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_ts_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">parse_header_field</span><span class="p">(</span><span class="s">&quot;commit&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_size_offset</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_size_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">parse_header_field</span><span class="p">(</span><span class="s">&quot;overwrite&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_overwrite</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">ignore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">parse_header_field</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_data_offset</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">header_page_data_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_matches</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sys_name</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">id</span> <span class="o">!=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sys_name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sys_name</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_handler</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">sys_name</span><span class="p">);</span>
	<span class="n">free</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">event_name</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_event_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_handler</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="o">**</span><span class="n">next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">;</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	     <span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">next</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event_matches</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				  <span class="n">handle</span><span class="o">-&gt;</span><span class="n">sys_name</span><span class="p">,</span>
				  <span class="n">handle</span><span class="o">-&gt;</span><span class="n">event_name</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">next</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_stat</span><span class="p">(</span><span class="s">&quot;overriding event (%d) %s:%s with new print handler&quot;</span><span class="p">,</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">free_handler</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_parse_event - parse the event format</span>
<span class="cm"> * @pevent: the handle to the pevent</span>
<span class="cm"> * @buf: the buffer storing the event format string</span>
<span class="cm"> * @size: the size of @buf</span>
<span class="cm"> * @sys: the system the event belongs to</span>
<span class="cm"> *</span>
<span class="cm"> * This parses the event format and creates an event structure</span>
<span class="cm"> * to quickly parse raw data for a given event.</span>
<span class="cm"> *</span>
<span class="cm"> * These files currently come from:</span>
<span class="cm"> *</span>
<span class="cm"> * /sys/kernel/debug/tracing/events/.../.../format</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_parse_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_input_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">alloc_event</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">event_read_name</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bad event? */</span>
		<span class="n">free</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">&quot;ftrace&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EVENT_FL_ISFTRACE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;bprint&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EVENT_FL_ISBPRINT</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">event_read_id</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;failed to read event id&quot;</span><span class="p">);</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">sys</span><span class="p">);</span>

	<span class="cm">/* Add pevent to event so that it can be referenced */</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">pevent</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">event_read_format</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;failed to read event format for %s&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">event_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the event has an override, don&#39;t print warnings if the event</span>
<span class="cm">	 * print format fails to parse.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_event_handle</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>
		<span class="n">show_warning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">event_read_print</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_warning</span><span class="p">(</span><span class="s">&quot;failed to read event print fmt for %s&quot;</span><span class="p">,</span>
			   <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">show_warning</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">event_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">show_warning</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">add_event</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EVENT_FL_ISFTRACE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">print_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">list</span><span class="p">;</span>

		<span class="cm">/* old ftrace had no args */</span>

		<span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">args</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">field</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">fields</span><span class="p">;</span> <span class="n">field</span><span class="p">;</span> <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="n">alloc_arg</span><span class="p">();</span>
			<span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PRINT_FIELD</span><span class="p">;</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#define PRINT_ARGS 0</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PRINT_ARGS</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
		<span class="n">print_args</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">args</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">event_failed:</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EVENT_FL_FAILED</span><span class="p">;</span>
	<span class="cm">/* still add it even if it failed */</span>
	<span class="n">add_event</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_field_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;&lt;CANT FIND FIELD %s&gt;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pevent_read_number_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; %s=INVALID&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_get_field_raw - return the raw pointer into the data field</span>
<span class="cm"> * @s: The seq to print to on error</span>
<span class="cm"> * @event: the event that the field is for</span>
<span class="cm"> * @name: The name of the field</span>
<span class="cm"> * @record: The record with the field name.</span>
<span class="cm"> * @len: place to store the field length.</span>
<span class="cm"> * @err: print default error if failed.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer into record-&gt;data of the field and places</span>
<span class="cm"> * the length of the field in @len.</span>
<span class="cm"> *</span>
<span class="cm"> * On failure, it returns NULL.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">pevent_get_field_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;&lt;CANT FIND FIELD %s&gt;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allow @len to be NULL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIELD_IS_DYNAMIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">pevent_read_number</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pevent</span><span class="p">,</span>
					    <span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_get_field_val - find a field and return its value</span>
<span class="cm"> * @s: The seq to print to on error</span>
<span class="cm"> * @event: the event that the field is for</span>
<span class="cm"> * @name: The name of the field</span>
<span class="cm"> * @record: The record with the field name.</span>
<span class="cm"> * @val: place to store the value of the field.</span>
<span class="cm"> * @err: print default error if failed.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success -1 on field not found.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_get_field_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">get_field_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_get_common_field_val - find a common field and return its value</span>
<span class="cm"> * @s: The seq to print to on error</span>
<span class="cm"> * @event: the event that the field is for</span>
<span class="cm"> * @name: The name of the field</span>
<span class="cm"> * @record: The record with the field name.</span>
<span class="cm"> * @val: place to store the value of the field.</span>
<span class="cm"> * @err: print default error if failed.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success -1 on field not found.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_get_common_field_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_common_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">get_field_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_get_any_field_val - find a any field and return its value</span>
<span class="cm"> * @s: The seq to print to on error</span>
<span class="cm"> * @event: the event that the field is for</span>
<span class="cm"> * @name: The name of the field</span>
<span class="cm"> * @record: The record with the field name.</span>
<span class="cm"> * @val: place to store the value of the field.</span>
<span class="cm"> * @err: print default error if failed.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success -1 on field not found.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_get_any_field_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_any_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">get_field_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_print_num_field - print a field and a format</span>
<span class="cm"> * @s: The seq to print to</span>
<span class="cm"> * @fmt: The printf format to print the field with.</span>
<span class="cm"> * @event: the event that the field is for</span>
<span class="cm"> * @name: The name of the field</span>
<span class="cm"> * @record: The record with the field name.</span>
<span class="cm"> * @err: print default error if failed.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, -1 field not fould, or 1 if buffer is full.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_print_num_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">pevent_record</span> <span class="o">*</span><span class="n">record</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span> <span class="o">=</span> <span class="n">pevent_find_field</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pevent_read_number_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

 <span class="nl">failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;CAN&#39;T FIND FIELD </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_func_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent_func_params</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>

	<span class="n">free</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_register_print_function - register a helper function</span>
<span class="cm"> * @pevent: the handle to the pevent</span>
<span class="cm"> * @func: the function to process the helper function</span>
<span class="cm"> * @name: the name of the helper function</span>
<span class="cm"> * @parameters: A list of enum pevent_func_arg_type</span>
<span class="cm"> *</span>
<span class="cm"> * Some events may have helper functions in the print format arguments.</span>
<span class="cm"> * This allows a plugin to dynmically create a way to process one</span>
<span class="cm"> * of these functions.</span>
<span class="cm"> *</span>
<span class="cm"> * The @parameters is a variable list of pevent_func_arg_type enums that</span>
<span class="cm"> * must end with PEVENT_FUNC_ARG_VOID.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_register_print_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span>
				   <span class="n">pevent_func_handler</span> <span class="n">func</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">pevent_func_arg_type</span> <span class="n">ret_type</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span><span class="n">func_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pevent_func_params</span> <span class="o">**</span><span class="n">next_param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pevent_func_params</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pevent_func_arg_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>

	<span class="n">func_handle</span> <span class="o">=</span> <span class="n">find_func_handler</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is most like caused by the users own</span>
<span class="cm">		 * plugins updating the function. This overrides the</span>
<span class="cm">		 * system defaults.</span>
<span class="cm">		 */</span>
		<span class="n">pr_stat</span><span class="p">(</span><span class="s">&quot;override of function helper &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">remove_func_handler</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">func_handle</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">func_handle</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">func_handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">func_handle</span><span class="p">));</span>

	<span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">ret_type</span> <span class="o">=</span> <span class="n">ret_type</span><span class="p">;</span>
	<span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Failed to allocate function name&quot;</span><span class="p">);</span>

	<span class="n">next_param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">);</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pevent_func_arg_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PEVENT_FUNC_ARG_VOID</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">type</span> <span class="o">&gt;=</span> <span class="n">PEVENT_FUNC_ARG_MAX_TYPES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warning</span><span class="p">(</span><span class="s">&quot;Invalid argument type %d&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">param</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">));</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="o">*</span><span class="n">next_param</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="n">next_param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

		<span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">nr_args</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">func_handle</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_handlers</span><span class="p">;</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_handlers</span> <span class="o">=</span> <span class="n">func_handle</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_free:</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">free_func_handle</span><span class="p">(</span><span class="n">func_handle</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_register_event_handle - register a way to parse an event</span>
<span class="cm"> * @pevent: the handle to the pevent</span>
<span class="cm"> * @id: the id of the event to register</span>
<span class="cm"> * @sys_name: the system name the event belongs to</span>
<span class="cm"> * @event_name: the name of the event</span>
<span class="cm"> * @func: the function to call to parse the event information</span>
<span class="cm"> *</span>
<span class="cm"> * This function allows a developer to override the parsing of</span>
<span class="cm"> * a given event. If for some reason the default print format</span>
<span class="cm"> * is not sufficient, this function will register a function</span>
<span class="cm"> * for an event to be used to parse the data instead.</span>
<span class="cm"> *</span>
<span class="cm"> * If @id is &gt;= 0, then it is used to find the event.</span>
<span class="cm"> * else @sys_name and @event_name are used.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pevent_register_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sys_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_name</span><span class="p">,</span>
				  <span class="n">pevent_event_handler_func</span> <span class="n">func</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_handler</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* search by id */</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">pevent_find_event</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event_name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sys_name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sys_name</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">pevent_find_event_by_name</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="n">sys_name</span><span class="p">,</span> <span class="n">event_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_stat</span><span class="p">(</span><span class="s">&quot;overriding event (%d) %s:%s with new print handler&quot;</span><span class="p">,</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">not_found:</span>
	<span class="cm">/* Save for later use. */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">malloc_or_die</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">handle</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">handle</span><span class="p">));</span>
	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
		<span class="n">handle</span><span class="o">-&gt;</span><span class="n">event_name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">event_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sys_name</span><span class="p">)</span>
		<span class="n">handle</span><span class="o">-&gt;</span><span class="n">sys_name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">sys_name</span><span class="p">);</span>

	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">;</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_alloc - create a pevent handle</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="nf">pevent_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">;</span>

	<span class="n">pevent</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pevent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="p">));</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pevent</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pevent_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_format_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_field</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">format</span> <span class="o">*</span><span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_format_fields</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">common_fields</span><span class="p">);</span>
	<span class="n">free_format_fields</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">);</span>

	<span class="n">free_formats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
	<span class="n">free_args</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">print_fmt</span><span class="p">.</span><span class="n">args</span><span class="p">);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pevent_free - free a pevent handle</span>
<span class="cm"> * @pevent: the pevent handle to free</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pevent_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdline_list</span> <span class="o">*</span><span class="n">cmdlist</span><span class="p">,</span> <span class="o">*</span><span class="n">cmdnext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">func_list</span> <span class="o">*</span><span class="n">funclist</span><span class="p">,</span> <span class="o">*</span><span class="n">funcnext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">printk_list</span> <span class="o">*</span><span class="n">printklist</span><span class="p">,</span> <span class="o">*</span><span class="n">printknext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pevent_function_handler</span> <span class="o">*</span><span class="n">func_handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_handler</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cmdlist</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlist</span><span class="p">;</span>
	<span class="n">funclist</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">funclist</span><span class="p">;</span>
	<span class="n">printklist</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printklist</span><span class="p">;</span>

	<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdline_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">comm</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">cmdlines</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cmdlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdnext</span> <span class="o">=</span> <span class="n">cmdlist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">cmdlist</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">cmdlist</span><span class="p">);</span>
		<span class="n">cmdlist</span> <span class="o">=</span> <span class="n">cmdnext</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">func</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_map</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">funclist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">funcnext</span> <span class="o">=</span> <span class="n">funclist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">funclist</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">funclist</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">funclist</span><span class="p">);</span>
		<span class="n">funclist</span> <span class="o">=</span> <span class="n">funcnext</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_handlers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">func_handler</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_handlers</span><span class="p">;</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">func_handlers</span> <span class="o">=</span> <span class="n">func_handler</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free_func_handle</span><span class="p">(</span><span class="n">func_handler</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">printk</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">printk_map</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">printklist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printknext</span> <span class="o">=</span> <span class="n">printklist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free</span><span class="p">(</span><span class="n">printklist</span><span class="o">-&gt;</span><span class="n">printk</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">printklist</span><span class="p">);</span>
		<span class="n">printklist</span> <span class="o">=</span> <span class="n">printknext</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">nr_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_event</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">;</span>
		<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free_handler</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">sort_events</span><span class="p">);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">pevent</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pevent_unref</span><span class="p">(</span><span class="k">struct</span> <span class="n">pevent</span> <span class="o">*</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pevent_free</span><span class="p">(</span><span class="n">pevent</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
