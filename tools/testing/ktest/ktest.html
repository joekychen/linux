<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › testing › ktest › ktest.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ktest.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl -w</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Copyright 2010 - Steven Rostedt <a href="&#109;&#97;&#105;&#x6C;&#x74;&#111;:&#x73;&#x72;&#111;&#x73;&#116;&#101;d&#116;&#64;&#114;&#101;&#x64;&#104;&#97;&#116;.&#x63;&#111;&#109;">&#x73;&#x72;&#111;&#x73;&#116;&#101;d&#116;&#64;&#114;&#101;&#x64;&#104;&#97;&#116;.&#x63;&#111;&#109;</a>, Red Hat Inc.
Licensed under the terms of the GNU GPL License version 2</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IPC::</span><span class="n">Open2</span><span class="p">;</span>
<span class="k">use</span> <span class="n">Fcntl</span> <span class="sx">qw(F_GETFL F_SETFL O_NONBLOCK)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Path</span> <span class="sx">qw(mkpath)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Copy</span> <span class="sx">qw(cp)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">FileHandle</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$VERSION</span> <span class="o">=</span> <span class="s">&quot;0.2&quot;</span><span class="p">;</span>

<span class="vg">$|</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">%opt</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%repeat_tests</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%repeats</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>default opts</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">%default</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&quot;NUM_TESTS&quot;</span>			<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;TEST_TYPE&quot;</span>			<span class="o">=&gt;</span> <span class="s">&quot;build&quot;</span><span class="p">,</span>
    <span class="s">&quot;BUILD_TYPE&quot;</span>		<span class="o">=&gt;</span> <span class="s">&quot;randconfig&quot;</span><span class="p">,</span>
    <span class="s">&quot;MAKE_CMD&quot;</span>			<span class="o">=&gt;</span> <span class="s">&quot;make&quot;</span><span class="p">,</span>
    <span class="s">&quot;TIMEOUT&quot;</span>			<span class="o">=&gt;</span> <span class="mi">120</span><span class="p">,</span>
    <span class="s">&quot;TMP_DIR&quot;</span>			<span class="o">=&gt;</span> <span class="s">&quot;/tmp/ktest/\${MACHINE}&quot;</span><span class="p">,</span>
    <span class="s">&quot;SLEEP_TIME&quot;</span>		<span class="o">=&gt;</span> <span class="mi">60</span><span class="p">,</span>	<span class="c1"># sleep time between tests</span>
    <span class="s">&quot;BUILD_NOCLEAN&quot;</span>		<span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">&quot;REBOOT_ON_ERROR&quot;</span>		<span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">&quot;POWEROFF_ON_ERROR&quot;</span>		<span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">&quot;REBOOT_ON_SUCCESS&quot;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;POWEROFF_ON_SUCCESS&quot;</span>	<span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">&quot;BUILD_OPTIONS&quot;</span>		<span class="o">=&gt;</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
    <span class="s">&quot;BISECT_SLEEP_TIME&quot;</span>		<span class="o">=&gt;</span> <span class="mi">60</span><span class="p">,</span>   <span class="c1"># sleep time between bisects</span>
    <span class="s">&quot;PATCHCHECK_SLEEP_TIME&quot;</span>	<span class="o">=&gt;</span> <span class="mi">60</span><span class="p">,</span> <span class="c1"># sleep time between patch checks</span>
    <span class="s">&quot;CLEAR_LOG&quot;</span>			<span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">&quot;BISECT_MANUAL&quot;</span>		<span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">&quot;BISECT_SKIP&quot;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;MIN_CONFIG_TYPE&quot;</span>		<span class="o">=&gt;</span> <span class="s">&quot;boot&quot;</span><span class="p">,</span>
    <span class="s">&quot;SUCCESS_LINE&quot;</span>		<span class="o">=&gt;</span> <span class="s">&quot;login:&quot;</span><span class="p">,</span>
    <span class="s">&quot;DETECT_TRIPLE_FAULT&quot;</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;NO_INSTALL&quot;</span>		<span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">&quot;BOOTED_TIMEOUT&quot;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;DIE_ON_FAILURE&quot;</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;SSH_EXEC&quot;</span>			<span class="o">=&gt;</span> <span class="s">&quot;ssh \$SSH_USER\@\$MACHINE \$SSH_COMMAND&quot;</span><span class="p">,</span>
    <span class="s">&quot;SCP_TO_TARGET&quot;</span>		<span class="o">=&gt;</span> <span class="s">&quot;scp \$SRC_FILE \$SSH_USER\@\$MACHINE:\$DST_FILE&quot;</span><span class="p">,</span>
    <span class="s">&quot;SCP_TO_TARGET_INSTALL&quot;</span>	<span class="o">=&gt;</span> <span class="s">&quot;\${SCP_TO_TARGET}&quot;</span><span class="p">,</span>
    <span class="s">&quot;REBOOT&quot;</span>			<span class="o">=&gt;</span> <span class="s">&quot;ssh \$SSH_USER\@\$MACHINE reboot&quot;</span><span class="p">,</span>
    <span class="s">&quot;STOP_AFTER_SUCCESS&quot;</span>	<span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s">&quot;STOP_AFTER_FAILURE&quot;</span>	<span class="o">=&gt;</span> <span class="mi">60</span><span class="p">,</span>
    <span class="s">&quot;STOP_TEST_AFTER&quot;</span>		<span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>required, and we will ask users if they don't have them but we keep the default
value something that is common.</p></td><td class="code"><div class="highlight"><pre>    <span class="s">&quot;REBOOT_TYPE&quot;</span>		<span class="o">=&gt;</span> <span class="s">&quot;grub&quot;</span><span class="p">,</span>
    <span class="s">&quot;LOCALVERSION&quot;</span>		<span class="o">=&gt;</span> <span class="s">&quot;-test&quot;</span><span class="p">,</span>
    <span class="s">&quot;SSH_USER&quot;</span>			<span class="o">=&gt;</span> <span class="s">&quot;root&quot;</span><span class="p">,</span>
    <span class="s">&quot;BUILD_TARGET&quot;</span>	 	<span class="o">=&gt;</span> <span class="s">&quot;arch/x86/boot/bzImage&quot;</span><span class="p">,</span>
    <span class="s">&quot;TARGET_IMAGE&quot;</span>		<span class="o">=&gt;</span> <span class="s">&quot;/boot/vmlinuz-test&quot;</span><span class="p">,</span>

    <span class="s">&quot;LOG_FILE&quot;</span>			<span class="o">=&gt;</span> <span class="nb">undef</span><span class="p">,</span>
    <span class="s">&quot;IGNORE_UNUSED&quot;</span>		<span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">);</span>

<span class="k">my</span> <span class="nv">$ktest_config</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$version</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$have_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$machine</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$ssh_user</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$tmpdir</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$builddir</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$outputdir</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$output_config</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$test_type</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$build_type</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$build_options</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$pre_build</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$post_build</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$pre_build_die</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$post_build_die</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$reboot_type</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$reboot_script</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$power_cycle</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$reboot</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$reboot_on_error</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$switch_to_good</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$switch_to_test</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$poweroff_on_error</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$reboot_on_success</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$die_on_failure</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$powercycle_after_reboot</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$poweroff_after_halt</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$ssh_exec</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$scp_to_target</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$scp_to_target_install</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$power_off</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$grub_menu</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$grub_number</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$target</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$make</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$post_install</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$no_install</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$noclean</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$minconfig</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$start_minconfig</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$start_minconfig_defined</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$output_minconfig</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$minconfig_type</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$use_output_minconfig</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$ignore_config</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$ignore_errors</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$addconfig</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$in_bisect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_bad_commit</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$reverse_bisect</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_manual</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_skip</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$config_bisect_good</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_ret_good</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_ret_bad</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_ret_skip</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_ret_abort</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_ret_default</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$in_patchcheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$run_test</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$redirect</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$buildlog</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$testlog</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dmesg</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$monitor_fp</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$monitor_pid</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$monitor_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sleep_time</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_sleep_time</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$patchcheck_sleep_time</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$ignore_warnings</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$store_failures</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$store_successes</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$test_name</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$timeout</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$booted_timeout</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$detect_triplefault</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$console</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$reboot_success_line</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$success_line</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$stop_after_success</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$stop_after_failure</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$stop_test_after</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$build_target</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$target_image</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$checkout</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$localversion</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$iteration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$successes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$bisect_good</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_bad</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_type</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_start</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_replay</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_files</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_reverse</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$bisect_check</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$config_bisect</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$config_bisect_type</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$patchcheck_type</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$patchcheck_start</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$patchcheck_end</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>set when a test is something other that just building or install
which would require more options.</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$buildonly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>set when creating a new config</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$newconfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">%entered_configs</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%config_help</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%variable</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%force_config</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>do not force reboots on config problems</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$no_reboot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>reboot on success</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$reboot_success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">%option_map</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&quot;MACHINE&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$machine</span><span class="p">,</span>
    <span class="s">&quot;SSH_USER&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$ssh_user</span><span class="p">,</span>
    <span class="s">&quot;TMP_DIR&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$tmpdir</span><span class="p">,</span>
    <span class="s">&quot;OUTPUT_DIR&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$outputdir</span><span class="p">,</span>
    <span class="s">&quot;BUILD_DIR&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$builddir</span><span class="p">,</span>
    <span class="s">&quot;TEST_TYPE&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$test_type</span><span class="p">,</span>
    <span class="s">&quot;BUILD_TYPE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$build_type</span><span class="p">,</span>
    <span class="s">&quot;BUILD_OPTIONS&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$build_options</span><span class="p">,</span>
    <span class="s">&quot;PRE_BUILD&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$pre_build</span><span class="p">,</span>
    <span class="s">&quot;POST_BUILD&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$post_build</span><span class="p">,</span>
    <span class="s">&quot;PRE_BUILD_DIE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$pre_build_die</span><span class="p">,</span>
    <span class="s">&quot;POST_BUILD_DIE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$post_build_die</span><span class="p">,</span>
    <span class="s">&quot;POWER_CYCLE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$power_cycle</span><span class="p">,</span>
    <span class="s">&quot;REBOOT&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$reboot</span><span class="p">,</span>
    <span class="s">&quot;BUILD_NOCLEAN&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$noclean</span><span class="p">,</span>
    <span class="s">&quot;MIN_CONFIG&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$minconfig</span><span class="p">,</span>
    <span class="s">&quot;OUTPUT_MIN_CONFIG&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$output_minconfig</span><span class="p">,</span>
    <span class="s">&quot;START_MIN_CONFIG&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$start_minconfig</span><span class="p">,</span>
    <span class="s">&quot;MIN_CONFIG_TYPE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$minconfig_type</span><span class="p">,</span>
    <span class="s">&quot;USE_OUTPUT_MIN_CONFIG&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$use_output_minconfig</span><span class="p">,</span>
    <span class="s">&quot;IGNORE_CONFIG&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$ignore_config</span><span class="p">,</span>
    <span class="s">&quot;TEST&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$run_test</span><span class="p">,</span>
    <span class="s">&quot;ADD_CONFIG&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$addconfig</span><span class="p">,</span>
    <span class="s">&quot;REBOOT_TYPE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$reboot_type</span><span class="p">,</span>
    <span class="s">&quot;GRUB_MENU&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$grub_menu</span><span class="p">,</span>
    <span class="s">&quot;POST_INSTALL&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$post_install</span><span class="p">,</span>
    <span class="s">&quot;NO_INSTALL&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$no_install</span><span class="p">,</span>
    <span class="s">&quot;REBOOT_SCRIPT&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$reboot_script</span><span class="p">,</span>
    <span class="s">&quot;REBOOT_ON_ERROR&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$reboot_on_error</span><span class="p">,</span>
    <span class="s">&quot;SWITCH_TO_GOOD&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$switch_to_good</span><span class="p">,</span>
    <span class="s">&quot;SWITCH_TO_TEST&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$switch_to_test</span><span class="p">,</span>
    <span class="s">&quot;POWEROFF_ON_ERROR&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$poweroff_on_error</span><span class="p">,</span>
    <span class="s">&quot;REBOOT_ON_SUCCESS&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$reboot_on_success</span><span class="p">,</span>
    <span class="s">&quot;DIE_ON_FAILURE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$die_on_failure</span><span class="p">,</span>
    <span class="s">&quot;POWER_OFF&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$power_off</span><span class="p">,</span>
    <span class="s">&quot;POWERCYCLE_AFTER_REBOOT&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$powercycle_after_reboot</span><span class="p">,</span>
    <span class="s">&quot;POWEROFF_AFTER_HALT&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$poweroff_after_halt</span><span class="p">,</span>
    <span class="s">&quot;SLEEP_TIME&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$sleep_time</span><span class="p">,</span>
    <span class="s">&quot;BISECT_SLEEP_TIME&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_sleep_time</span><span class="p">,</span>
    <span class="s">&quot;PATCHCHECK_SLEEP_TIME&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$patchcheck_sleep_time</span><span class="p">,</span>
    <span class="s">&quot;IGNORE_WARNINGS&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$ignore_warnings</span><span class="p">,</span>
    <span class="s">&quot;IGNORE_ERRORS&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$ignore_errors</span><span class="p">,</span>
    <span class="s">&quot;BISECT_MANUAL&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_manual</span><span class="p">,</span>
    <span class="s">&quot;BISECT_SKIP&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_skip</span><span class="p">,</span>
    <span class="s">&quot;CONFIG_BISECT_GOOD&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$config_bisect_good</span><span class="p">,</span>
    <span class="s">&quot;BISECT_RET_GOOD&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_ret_good</span><span class="p">,</span>
    <span class="s">&quot;BISECT_RET_BAD&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_ret_bad</span><span class="p">,</span>
    <span class="s">&quot;BISECT_RET_SKIP&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_ret_skip</span><span class="p">,</span>
    <span class="s">&quot;BISECT_RET_ABORT&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_ret_abort</span><span class="p">,</span>
    <span class="s">&quot;BISECT_RET_DEFAULT&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_ret_default</span><span class="p">,</span>
    <span class="s">&quot;STORE_FAILURES&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$store_failures</span><span class="p">,</span>
    <span class="s">&quot;STORE_SUCCESSES&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$store_successes</span><span class="p">,</span>
    <span class="s">&quot;TEST_NAME&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$test_name</span><span class="p">,</span>
    <span class="s">&quot;TIMEOUT&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$timeout</span><span class="p">,</span>
    <span class="s">&quot;BOOTED_TIMEOUT&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$booted_timeout</span><span class="p">,</span>
    <span class="s">&quot;CONSOLE&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$console</span><span class="p">,</span>
    <span class="s">&quot;DETECT_TRIPLE_FAULT&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$detect_triplefault</span><span class="p">,</span>
    <span class="s">&quot;SUCCESS_LINE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$success_line</span><span class="p">,</span>
    <span class="s">&quot;REBOOT_SUCCESS_LINE&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$reboot_success_line</span><span class="p">,</span>
    <span class="s">&quot;STOP_AFTER_SUCCESS&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$stop_after_success</span><span class="p">,</span>
    <span class="s">&quot;STOP_AFTER_FAILURE&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$stop_after_failure</span><span class="p">,</span>
    <span class="s">&quot;STOP_TEST_AFTER&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$stop_test_after</span><span class="p">,</span>
    <span class="s">&quot;BUILD_TARGET&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$build_target</span><span class="p">,</span>
    <span class="s">&quot;SSH_EXEC&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$ssh_exec</span><span class="p">,</span>
    <span class="s">&quot;SCP_TO_TARGET&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$scp_to_target</span><span class="p">,</span>
    <span class="s">&quot;SCP_TO_TARGET_INSTALL&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$scp_to_target_install</span><span class="p">,</span>
    <span class="s">&quot;CHECKOUT&quot;</span>			<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$checkout</span><span class="p">,</span>
    <span class="s">&quot;TARGET_IMAGE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$target_image</span><span class="p">,</span>
    <span class="s">&quot;LOCALVERSION&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$localversion</span><span class="p">,</span>

    <span class="s">&quot;BISECT_GOOD&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_good</span><span class="p">,</span>
    <span class="s">&quot;BISECT_BAD&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_bad</span><span class="p">,</span>
    <span class="s">&quot;BISECT_TYPE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_type</span><span class="p">,</span>
    <span class="s">&quot;BISECT_START&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_start</span><span class="p">,</span>
    <span class="s">&quot;BISECT_REPLAY&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_replay</span><span class="p">,</span>
    <span class="s">&quot;BISECT_FILES&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_files</span><span class="p">,</span>
    <span class="s">&quot;BISECT_REVERSE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_reverse</span><span class="p">,</span>
    <span class="s">&quot;BISECT_CHECK&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$bisect_check</span><span class="p">,</span>

    <span class="s">&quot;CONFIG_BISECT&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$config_bisect</span><span class="p">,</span>
    <span class="s">&quot;CONFIG_BISECT_TYPE&quot;</span>	<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$config_bisect_type</span><span class="p">,</span>

    <span class="s">&quot;PATCHCHECK_TYPE&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$patchcheck_type</span><span class="p">,</span>
    <span class="s">&quot;PATCHCHECK_START&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$patchcheck_start</span><span class="p">,</span>
    <span class="s">&quot;PATCHCHECK_END&quot;</span>		<span class="o">=&gt;</span> <span class="o">\</span><span class="nv">$patchcheck_end</span><span class="p">,</span>
<span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Options may be used by other options, record them.</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">%used_options</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>default variables that can be used</p></td><td class="code"><div class="highlight"><pre><span class="nb">chomp</span> <span class="p">(</span><span class="nv">$variable</span><span class="p">{</span><span class="s">&quot;PWD&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="sb">`pwd`</span><span class="p">);</span>

<span class="nv">$config_help</span><span class="p">{</span><span class="s">&quot;MACHINE&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span>
 <span class="n">The</span> <span class="n">machine</span> <span class="n">hostname</span> <span class="n">that</span> <span class="n">you</span> <span class="n">will</span> <span class="n">test</span><span class="o">.</span>
 <span class="n">For</span> <span class="n">build</span> <span class="n">only</span> <span class="n">tests</span><span class="p">,</span> <span class="n">it</span> <span class="n">is</span> <span class="n">still</span> <span class="n">needed</span> <span class="n">to</span> <span class="n">differentiate</span> <span class="nb">log</span> <span class="n">files</span><span class="o">.</span>
<span class="n">EOF</span>
    <span class="p">;</span>
<span class="nv">$config_help</span><span class="p">{</span><span class="s">&quot;SSH_USER&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span>
 <span class="n">The</span> <span class="n">box</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="n">have</span> <span class="n">ssh</span> <span class="n">on</span> <span class="n">normal</span> <span class="n">bootup</span><span class="p">,</span> <span class="n">provide</span> <span class="n">the</span> <span class="n">user</span>
  <span class="p">(</span><span class="n">most</span> <span class="n">likely</span> <span class="n">root</span><span class="p">,</span> <span class="n">since</span> <span class="n">you</span> <span class="n">need</span> <span class="n">privileged</span> <span class="n">operations</span><span class="p">)</span>
<span class="n">EOF</span>
    <span class="p">;</span>
<span class="nv">$config_help</span><span class="p">{</span><span class="s">&quot;BUILD_DIR&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span>
 <span class="n">The</span> <span class="n">directory</span> <span class="n">that</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">Linux</span> <span class="n">source</span> <span class="n">code</span> <span class="p">(</span><span class="n">full</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span>
 <span class="n">You</span> <span class="n">can</span> <span class="k">use</span> <span class="o">\</span><span class="nv">$</span><span class="p">{</span><span class="n">PWD</span><span class="p">}</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">path</span> <span class="n">where</span> <span class="n">ktest</span><span class="o">.</span><span class="n">pl</span> <span class="n">is</span> <span class="n">run</span><span class="p">,</span> <span class="ow">or</span> <span class="k">use</span>
 <span class="o">\</span><span class="nv">$</span><span class="p">{</span><span class="n">THIS_DIR</span><span class="p">}</span> <span class="n">which</span> <span class="n">is</span> <span class="n">assigned</span> <span class="o">\</span><span class="nv">$</span><span class="p">{</span><span class="n">PWD</span><span class="p">}</span> <span class="n">but</span> <span class="n">may</span> <span class="n">be</span> <span class="n">changed</span> <span class="n">later</span><span class="o">.</span>
<span class="n">EOF</span>
    <span class="p">;</span>
<span class="nv">$config_help</span><span class="p">{</span><span class="s">&quot;OUTPUT_DIR&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span>
 <span class="n">The</span> <span class="n">directory</span> <span class="n">that</span> <span class="n">the</span> <span class="n">objects</span> <span class="n">will</span> <span class="n">be</span> <span class="n">built</span> <span class="p">(</span><span class="n">full</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span>
 <span class="p">(</span><span class="n">can</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">same</span> <span class="n">as</span> <span class="n">BUILD_DIR</span><span class="p">)</span>
 <span class="n">You</span> <span class="n">can</span> <span class="k">use</span> <span class="o">\</span><span class="nv">$</span><span class="p">{</span><span class="n">PWD</span><span class="p">}</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">path</span> <span class="n">where</span> <span class="n">ktest</span><span class="o">.</span><span class="n">pl</span> <span class="n">is</span> <span class="n">run</span><span class="p">,</span> <span class="ow">or</span> <span class="k">use</span>
 <span class="o">\</span><span class="nv">$</span><span class="p">{</span><span class="n">THIS_DIR</span><span class="p">}</span> <span class="n">which</span> <span class="n">is</span> <span class="n">assigned</span> <span class="o">\</span><span class="nv">$</span><span class="p">{</span><span class="n">PWD</span><span class="p">}</span> <span class="n">but</span> <span class="n">may</span> <span class="n">be</span> <span class="n">changed</span> <span class="n">later</span><span class="o">.</span>
<span class="n">EOF</span>
    <span class="p">;</span>
<span class="nv">$config_help</span><span class="p">{</span><span class="s">&quot;BUILD_TARGET&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span>
 <span class="n">The</span> <span class="n">location</span> <span class="n">of</span> <span class="n">the</span> <span class="n">compiled</span> <span class="n">file</span> <span class="n">to</span> <span class="n">copy</span> <span class="n">to</span> <span class="n">the</span> <span class="n">target</span><span class="o">.</span>
 <span class="p">(</span><span class="n">relative</span> <span class="n">to</span> <span class="n">OUTPUT_DIR</span><span class="p">)</span>
<span class="n">EOF</span>
    <span class="p">;</span>
<span class="nv">$config_help</span><span class="p">{</span><span class="s">&quot;BUILD_OPTIONS&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span>
 <span class="n">Options</span> <span class="n">to</span> <span class="n">add</span> <span class="n">to</span> <span class="o">\</span><span class="s">&quot;make\&quot; when building.</span>
<span class="s"> i.e.  -j20</span>
<span class="s">EOF</span>
<span class="s">    ;</span>
<span class="s">$config_help{&quot;</span><span class="n">TARGET_IMAGE</span><span class="s">&quot;} = &lt;&lt; &quot;</span><span class="n">EOF</span><span class="s">&quot;</span>
<span class="s"> The place to put your image on the test machine.</span>
<span class="s">EOF</span>
<span class="s">    ;</span>
<span class="s">$config_help{&quot;</span><span class="n">POWER_CYCLE</span><span class="s">&quot;} = &lt;&lt; &quot;</span><span class="n">EOF</span><span class="s">&quot;</span>
<span class="s"> A script or command to reboot the box.</span>

<span class="s"> Here is a digital loggers power switch example</span>
<span class="s"> POWER_CYCLE = wget --no-proxy -O /dev/null -q  --auth-no-challenge &#39;http://admin:admin\@power/outlet?5=CCL&#39;</span>

<span class="s"> Here is an example to reboot a virtual box on the current host</span>
<span class="s"> with the name &quot;</span><span class="n">Guest</span><span class="s">&quot;.</span>
<span class="s"> POWER_CYCLE = virsh destroy Guest; sleep 5; virsh start Guest</span>
<span class="s">EOF</span>
<span class="s">    ;</span>
<span class="s">$config_help{&quot;</span><span class="n">CONSOLE</span><span class="s">&quot;} = &lt;&lt; &quot;</span><span class="n">EOF</span><span class="s">&quot;</span>
<span class="s"> The script or command that reads the console</span>

<span class="s">  If you use ttywatch server, something like the following would work.</span>
<span class="s">CONSOLE = nc -d localhost 3001</span>

<span class="s"> For a virtual machine with guest name &quot;</span><span class="n">Guest</span><span class="s">&quot;.</span>
<span class="s">CONSOLE =  virsh console Guest</span>
<span class="s">EOF</span>
<span class="s">    ;</span>
<span class="s">$config_help{&quot;</span><span class="n">LOCALVERSION</span><span class="s">&quot;} = &lt;&lt; &quot;</span><span class="n">EOF</span><span class="s">&quot;</span>
<span class="s"> Required version ending to differentiate the test</span>
<span class="s"> from other linux builds on the system.</span>
<span class="s">EOF</span>
<span class="s">    ;</span>
<span class="s">$config_help{&quot;</span><span class="n">REBOOT_TYPE</span><span class="s">&quot;} = &lt;&lt; &quot;</span><span class="n">EOF</span><span class="s">&quot;</span>
<span class="s"> Way to reboot the box to the test kernel.</span>
<span class="s"> Only valid options so far are &quot;</span><span class="n">grub</span><span class="s">&quot; and &quot;</span><span class="n">script</span><span class="s">&quot;.</span>

<span class="s"> If you specify grub, it will assume grub version 1</span>
<span class="s"> and will search in /boot/grub/menu.lst for the title \$GRUB_MENU</span>
<span class="s"> and select that target to reboot to the kernel. If this is not</span>
<span class="s"> your setup, then specify &quot;</span><span class="n">script</span><span class="s">&quot; and have a command or script</span>
<span class="s"> specified in REBOOT_SCRIPT to boot to the target.</span>

<span class="s"> The entry in /boot/grub/menu.lst must be entered in manually.</span>
<span class="s"> The test will not modify that file.</span>
<span class="s">EOF</span>
<span class="s">    ;</span>
<span class="s">$config_help{&quot;</span><span class="n">GRUB_MENU</span><span class="s">&quot;} = &lt;&lt; &quot;</span><span class="n">EOF</span><span class="s">&quot;</span>
<span class="s"> The grub title name for the test kernel to boot</span>
<span class="s"> (Only mandatory if REBOOT_TYPE = grub)</span>

<span class="s"> Note, ktest.pl will not update the grub menu.lst, you need to</span>
<span class="s"> manually add an option for the test. ktest.pl will search</span>
<span class="s"> the grub menu.lst for this option to find what kernel to</span>
<span class="s"> reboot into.</span>

<span class="s"> For example, if in the /boot/grub/menu.lst the test kernel title has:</span>
<span class="s"> title Test Kernel</span>
<span class="s"> kernel vmlinuz-test</span>
<span class="s"> GRUB_MENU = Test Kernel</span>
<span class="s">EOF</span>
<span class="s">    ;</span>
<span class="s">$config_help{&quot;</span><span class="n">REBOOT_SCRIPT</span><span class="s">&quot;} = &lt;&lt; &quot;</span><span class="n">EOF</span><span class="s">&quot;</span>
<span class="s"> A script to reboot the target into the test kernel</span>
<span class="s"> (Only mandatory if REBOOT_TYPE = script)</span>
<span class="s">EOF</span>
<span class="s">    ;</span>

<span class="s">sub read_prompt {</span>
<span class="s">    my ($cancel, $prompt) = @_;</span>

<span class="s">    my $ans;</span>

<span class="s">    for (;;) {</span>
<span class="s">	if ($cancel) {</span>
<span class="s">	    print &quot;</span><span class="nv">$prompt</span> <span class="p">[</span><span class="n">y</span><span class="sr">/n/</span><span class="n">C</span><span class="p">]</span> <span class="s">&quot;;</span>
<span class="s">	} else {</span>
<span class="s">	    print &quot;</span><span class="nv">$prompt</span> <span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span> <span class="s">&quot;;</span>
<span class="s">	}</span>
<span class="s">	$ans = &lt;STDIN&gt;;</span>
<span class="s">	chomp $ans;</span>
<span class="s">	if ($ans =~ /^\s*$/) {</span>
<span class="s">	    if ($cancel) {</span>
<span class="s">		$ans = &quot;</span><span class="n">c</span><span class="s">&quot;;</span>
<span class="s">	    } else {</span>
<span class="s">		$ans = &quot;</span><span class="n">y</span><span class="s">&quot;;</span>
<span class="s">	    }</span>
<span class="s">	}</span>
<span class="s">	last if ($ans =~ /^y$/i || $ans =~ /^n$/i);</span>
<span class="s">	if ($cancel) {</span>
<span class="s">	    last if ($ans =~ /^c$/i);</span>
<span class="s">	    print &quot;</span><span class="n">Please</span> <span class="n">answer</span> <span class="n">either</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;n&#39;</span> <span class="ow">or</span> <span class="s">&#39;c&#39;</span><span class="o">.\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	} else {</span>
<span class="s">	    print &quot;</span><span class="n">Please</span> <span class="n">answer</span> <span class="n">either</span> <span class="s">&#39;y&#39;</span> <span class="ow">or</span> <span class="s">&#39;n&#39;</span><span class="o">.\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	}</span>
<span class="s">    }</span>
<span class="s">    if ($ans =~ /^c/i) {</span>
<span class="s">	exit;</span>
<span class="s">    }</span>
<span class="s">    if ($ans !~ /^y$/i) {</span>
<span class="s">	return 0;</span>
<span class="s">    }</span>
<span class="s">    return 1;</span>
<span class="s">}</span>

<span class="s">sub read_yn {</span>
<span class="s">    my ($prompt) = @_;</span>

<span class="s">    return read_prompt 0, $prompt;</span>
<span class="s">}</span>

<span class="s">sub read_ync {</span>
<span class="s">    my ($prompt) = @_;</span>

<span class="s">    return read_prompt 1, $prompt;</span>
<span class="s">}</span>

<span class="s">sub get_ktest_config {</span>
<span class="s">    my ($config) = @_;</span>
<span class="s">    my $ans;</span>

<span class="s">    return if (defined($opt{$config}));</span>

<span class="s">    if (defined($config_help{$config})) {</span>
<span class="s">	print &quot;</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	print $config_help{$config};</span>
<span class="s">    }</span>

<span class="s">    for (;;) {</span>
<span class="s">	print &quot;</span><span class="nv">$config</span> <span class="o">=</span> <span class="s">&quot;;</span>
<span class="s">	if (defined($default{$config}) &amp;&amp; length($default{$config})) {</span>
<span class="s">	    print &quot;</span><span class="o">\</span><span class="p">[</span><span class="nv">$default</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span><span class="o">\</span><span class="p">]</span> <span class="s">&quot;;</span>
<span class="s">	}</span>
<span class="s">	$ans = &lt;STDIN&gt;;</span>
<span class="s">	$ans =~ s/^\s*(.*\S)\s*$/$1/;</span>
<span class="s">	if ($ans =~ /^\s*$/) {</span>
<span class="s">	    if ($default{$config}) {</span>
<span class="s">		$ans = $default{$config};</span>
<span class="s">	    } else {</span>
<span class="s">		print &quot;</span><span class="n">Your</span> <span class="n">answer</span> <span class="n">can</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">blank</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">		next;</span>
<span class="s">	    }</span>
<span class="s">	}</span>
<span class="s">	$entered_configs{$config} = ${ans};</span>
<span class="s">	last;</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">sub get_ktest_configs {</span>
<span class="s">    get_ktest_config(&quot;</span><span class="n">MACHINE</span><span class="s">&quot;);</span>
<span class="s">    get_ktest_config(&quot;</span><span class="n">BUILD_DIR</span><span class="s">&quot;);</span>
<span class="s">    get_ktest_config(&quot;</span><span class="n">OUTPUT_DIR</span><span class="s">&quot;);</span>

<span class="s">    if ($newconfig) {</span>
<span class="s">	get_ktest_config(&quot;</span><span class="n">BUILD_OPTIONS</span><span class="s">&quot;);</span>
<span class="s">    }</span>


<span class="s">#DIVIDER</span>
<span class="s">    if (!$buildonly) {</span>
<span class="s">	get_ktest_config(&quot;</span><span class="n">POWER_CYCLE</span><span class="s">&quot;);</span>
<span class="s">	get_ktest_config(&quot;</span><span class="n">CONSOLE</span><span class="s">&quot;);</span>
<span class="s">    }</span>


<span class="s">#DIVIDER</span>
<span class="s">    if ($buildonly != 1) {</span>
<span class="s">	get_ktest_config(&quot;</span><span class="n">SSH_USER</span><span class="s">&quot;);</span>
<span class="s">	get_ktest_config(&quot;</span><span class="n">BUILD_TARGET</span><span class="s">&quot;);</span>
<span class="s">	get_ktest_config(&quot;</span><span class="n">TARGET_IMAGE</span><span class="s">&quot;);</span>
<span class="s">    }</span>

<span class="s">    get_ktest_config(&quot;</span><span class="n">LOCALVERSION</span><span class="s">&quot;);</span>

<span class="s">    return if ($buildonly);</span>

<span class="s">    my $rtype = $opt{&quot;</span><span class="n">REBOOT_TYPE</span><span class="s">&quot;};</span>

<span class="s">    if (!defined($rtype)) {</span>
<span class="s">	if (!defined($opt{&quot;</span><span class="n">GRUB_MENU</span><span class="s">&quot;})) {</span>
<span class="s">	    get_ktest_config(&quot;</span><span class="n">REBOOT_TYPE</span><span class="s">&quot;);</span>
<span class="s">	    $rtype = $entered_configs{&quot;</span><span class="n">REBOOT_TYPE</span><span class="s">&quot;};</span>
<span class="s">	} else {</span>
<span class="s">	    $rtype = &quot;</span><span class="n">grub</span><span class="s">&quot;;</span>
<span class="s">	}</span>
<span class="s">    }</span>

<span class="s">    if ($rtype eq &quot;</span><span class="n">grub</span><span class="s">&quot;) {</span>
<span class="s">	get_ktest_config(&quot;</span><span class="n">GRUB_MENU</span><span class="s">&quot;);</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">sub process_variables {</span>
<span class="s">    my ($value, $remove_undef) = @_;</span>
<span class="s">    my $retval = &quot;&quot;;</span>


<span class="s">#DIVIDER</span>
<span class="s">    $value = &quot;</span> <span class="nv">$value</span><span class="s">&quot;;</span>

<span class="s">    while ($value =~ /(.*?[^\\])\$\{(.*?)\}(.*)/) {</span>
<span class="s">	my $begin = $1;</span>
<span class="s">	my $var = $2;</span>
<span class="s">	my $end = $3;</span>

<span class="s">#DIVIDER</span>
<span class="s">	$retval = &quot;</span><span class="nv">$retval$begin</span><span class="s">&quot;;</span>
<span class="s">	if (defined($variable{$var})) {</span>
<span class="s">	    $retval = &quot;</span><span class="nv">$retval$variable</span><span class="p">{</span><span class="nv">$var</span><span class="p">}</span><span class="s">&quot;;</span>
<span class="s">	} elsif (defined($remove_undef) &amp;&amp; $remove_undef) {</span>

<span class="s">#DIVIDER</span>
<span class="s">	    $retval = &quot;</span><span class="nv">$</span><span class="p">{</span><span class="n">retval</span><span class="p">}</span><span class="mi">0</span><span class="s">&quot;;</span>
<span class="s">	} else {</span>

<span class="s">#DIVIDER</span>
<span class="s">	    $retval = &quot;</span><span class="nv">$retval</span><span class="o">\</span><span class="vg">$\</span><span class="p">{</span><span class="nv">$var</span><span class="o">\</span><span class="p">}</span><span class="s">&quot;;</span>

<span class="s">#DIVIDER</span>
<span class="s">	    $used_options{$var} = 1;</span>
<span class="s">	}</span>
<span class="s">	$value = $end;</span>
<span class="s">    }</span>
<span class="s">    $retval = &quot;</span><span class="nv">$retval$value</span><span class="s">&quot;;</span>


<span class="s">#DIVIDER</span>
<span class="s">    $retval =~ s/ //;</span>

<span class="s">    return &quot;</span><span class="nv">$retval</span><span class="s">&quot;</span>
<span class="s">}</span>

<span class="s">sub set_value {</span>
<span class="s">    my ($lvalue, $rvalue, $override, $overrides, $name) = @_;</span>

<span class="s">    my $prvalue = process_variables($rvalue);</span>

<span class="s">    if ($buildonly &amp;&amp; $lvalue =~ /^TEST_TYPE(\[.*\])?$/ &amp;&amp; $prvalue ne &quot;</span><span class="n">build</span><span class="s">&quot;) {</span>

<span class="s">#DIVIDER</span>
<span class="s">	if ($prvalue ne &quot;</span><span class="n">install</span><span class="s">&quot;) {</span>
<span class="s">	    $buildonly = 0;</span>
<span class="s">	} else {</span>

<span class="s">#DIVIDER</span>
<span class="s">	    $buildonly = 2;</span>
<span class="s">	}</span>
<span class="s">    }</span>

<span class="s">    if (defined($opt{$lvalue})) {</span>
<span class="s">	if (!$override || defined(${$overrides}{$lvalue})) {</span>
<span class="s">	    my $extra = &quot;&quot;;</span>
<span class="s">	    if ($override) {</span>
<span class="s">		$extra = &quot;</span><span class="n">In</span> <span class="n">the</span> <span class="n">same</span> <span class="n">override</span> <span class="n">section</span><span class="o">!\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	    }</span>
<span class="s">	    die &quot;</span><span class="nv">$name:</span> <span class="vg">$.</span><span class="p">:</span> <span class="n">Option</span> <span class="nv">$lvalue</span> <span class="nb">defined</span> <span class="n">more</span> <span class="n">than</span> <span class="n">once</span><span class="o">!\</span><span class="n">n</span><span class="nv">$extra</span><span class="s">&quot;;</span>
<span class="s">	}</span>
<span class="s">	${$overrides}{$lvalue} = $prvalue;</span>
<span class="s">    }</span>
<span class="s">    if ($rvalue =~ /^\s*$/) {</span>
<span class="s">	delete $opt{$lvalue};</span>
<span class="s">    } else {</span>
<span class="s">	$opt{$lvalue} = $prvalue;</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">sub set_variable {</span>
<span class="s">    my ($lvalue, $rvalue) = @_;</span>

<span class="s">    if ($rvalue =~ /^\s*$/) {</span>
<span class="s">	delete $variable{$lvalue};</span>
<span class="s">    } else {</span>
<span class="s">	$rvalue = process_variables($rvalue);</span>
<span class="s">	$variable{$lvalue} = $rvalue;</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">sub process_compare {</span>
<span class="s">    my ($lval, $cmp, $rval) = @_;</span>


<span class="s">#DIVIDER</span>

<span class="s">    $lval =~ s/^\s*//;</span>
<span class="s">    $lval =~ s/\s*$//;</span>

<span class="s">    $rval =~ s/^\s*//;</span>
<span class="s">    $rval =~ s/\s*$//;</span>

<span class="s">    if ($cmp eq &quot;</span><span class="o">==</span><span class="s">&quot;) {</span>
<span class="s">	return $lval eq $rval;</span>
<span class="s">    } elsif ($cmp eq &quot;</span><span class="o">!=</span><span class="s">&quot;) {</span>
<span class="s">	return $lval ne $rval;</span>
<span class="s">    }</span>

<span class="s">    my $statement = &quot;</span><span class="nv">$lval</span> <span class="nv">$cmp</span> <span class="nv">$rval</span><span class="s">&quot;;</span>
<span class="s">    my $ret = eval $statement;</span>


<span class="s">#DIVIDER</span>
<span class="s">    if ($@) {</span>
<span class="s">	return -1;</span>
<span class="s">    }</span>

<span class="s">    return $ret;</span>
<span class="s">}</span>

<span class="s">sub value_defined {</span>
<span class="s">    my ($val) = @_;</span>

<span class="s">    return defined($variable{$2}) ||</span>
<span class="s">	defined($opt{$2});</span>
<span class="s">}</span>

<span class="s">my $d = 0;</span>
<span class="s">sub process_expression {</span>
<span class="s">    my ($name, $val) = @_;</span>

<span class="s">    my $c = $d++;</span>

<span class="s">    while ($val =~ s/\(([^\(]*?)\)/\&amp;\&amp;\&amp;\&amp;VAL\&amp;\&amp;\&amp;\&amp;/) {</span>
<span class="s">	my $express = $1;</span>

<span class="s">	if (process_expression($name, $express)) {</span>
<span class="s">	    $val =~ s/\&amp;\&amp;\&amp;\&amp;VAL\&amp;\&amp;\&amp;\&amp;/ 1 /;</span>
<span class="s">	} else {</span>
<span class="s">	    $val =~ s/\&amp;\&amp;\&amp;\&amp;VAL\&amp;\&amp;\&amp;\&amp;/ 0 /;</span>
<span class="s">	}</span>
<span class="s">    }</span>

<span class="s">    $d--;</span>
<span class="s">    my $OR = &quot;</span><span class="o">\\|\\|</span><span class="s">&quot;;</span>
<span class="s">    my $AND = &quot;</span><span class="o">\\&amp;\\&amp;</span><span class="s">&quot;;</span>

<span class="s">    while ($val =~ s/^(.*?)($OR|$AND)//) {</span>
<span class="s">	my $express = $1;</span>
<span class="s">	my $op = $2;</span>

<span class="s">	if (process_expression($name, $express)) {</span>
<span class="s">	    if ($op eq &quot;</span><span class="o">||</span><span class="s">&quot;) {</span>
<span class="s">		return 1;</span>
<span class="s">	    }</span>
<span class="s">	} else {</span>
<span class="s">	    if ($op eq &quot;</span><span class="o">&amp;&amp;</span><span class="s">&quot;) {</span>
<span class="s">		return 0;</span>
<span class="s">	    }</span>
<span class="s">	}</span>
<span class="s">    }</span>

<span class="s">    if ($val =~ /(.*)(==|\!=|&gt;=|&lt;=|&gt;|&lt;)(.*)/) {</span>
<span class="s">	my $ret = process_compare($1, $2, $3);</span>
<span class="s">	if ($ret &lt; 0) {</span>
<span class="s">	    die &quot;</span><span class="nv">$name:</span> <span class="vg">$.</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">process</span> <span class="n">comparison</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	}</span>
<span class="s">	return $ret;</span>
<span class="s">    }</span>

<span class="s">    if ($val =~ /^\s*(NOT\s*)?DEFINED\s+(\S+)\s*$/) {</span>
<span class="s">	if (defined $1) {</span>
<span class="s">	    return !value_defined($2);</span>
<span class="s">	} else {</span>
<span class="s">	    return value_defined($2);</span>
<span class="s">	}</span>
<span class="s">    }</span>

<span class="s">    if ($val =~ /^\s*0\s*$/) {</span>
<span class="s">	return 0;</span>
<span class="s">    } elsif ($val =~ /^\s*\d+\s*$/) {</span>
<span class="s">	return 1;</span>
<span class="s">    }</span>

<span class="s">    die (&quot;</span><span class="nv">$name:</span> <span class="vg">$.</span><span class="p">:</span> <span class="n">Undefined</span> <span class="n">content</span> <span class="nv">$val</span> <span class="n">in</span> <span class="k">if</span> <span class="n">statement</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;);</span>
<span class="s">}</span>

<span class="s">sub process_if {</span>
<span class="s">    my ($name, $value) = @_;</span>


<span class="s">#DIVIDER</span>
<span class="s">    my $val = process_variables($value, 1);</span>
<span class="s">    my $ret = process_expression $name, $val;</span>

<span class="s">    return $ret;</span>
<span class="s">}</span>

<span class="s">sub __read_config {</span>
<span class="s">    my ($config, $current_test_num) = @_;</span>

<span class="s">    my $in;</span>
<span class="s">    open($in, $config) || die &quot;</span><span class="n">can</span><span class="s">&#39;t read file $config&quot;;</span>

<span class="s">    my $name = $config;</span>
<span class="s">    $name =~ s,.*/(.*),$1,;</span>

<span class="s">    my $test_num = $$current_test_num;</span>
<span class="s">    my $default = 1;</span>
<span class="s">    my $repeat = 1;</span>
<span class="s">    my $num_tests_set = 0;</span>
<span class="s">    my $skip = 0;</span>
<span class="s">    my $rest;</span>
<span class="s">    my $line;</span>
<span class="s">    my $test_case = 0;</span>
<span class="s">    my $if = 0;</span>
<span class="s">    my $if_set = 0;</span>
<span class="s">    my $override = 0;</span>

<span class="s">    my %overrides;</span>

<span class="s">    while (&lt;$in&gt;) {</span>


<span class="s">#DIVIDER</span>
<span class="s">	next if (/^\s*$/ || /\s*\#/);</span>

<span class="s">	if (/^\s*(TEST_START|DEFAULTS)\b(.*)/) {</span>

<span class="s">	    my $type = $1;</span>
<span class="s">	    $rest = $2;</span>
<span class="s">	    $line = $2;</span>

<span class="s">	    my $old_test_num;</span>
<span class="s">	    my $old_repeat;</span>
<span class="s">	    $override = 0;</span>

<span class="s">	    if ($type eq &quot;TEST_START&quot;) {</span>

<span class="s">		if ($num_tests_set) {</span>
<span class="s">		    die &quot;$name: $.: Can not specify both NUM_TESTS and TEST_START\n&quot;;</span>
<span class="s">		}</span>

<span class="s">		$old_test_num = $test_num;</span>
<span class="s">		$old_repeat = $repeat;</span>

<span class="s">		$test_num += $repeat;</span>
<span class="s">		$default = 0;</span>
<span class="s">		$repeat = 1;</span>
<span class="s">	    } else {</span>
<span class="s">		$default = 1;</span>
<span class="s">	    }</span>


<span class="s">#DIVIDER</span>
<span class="s">	    if ($rest =~ s/\s+SKIP\b//) {</span>
<span class="s">		$skip = 1;</span>
<span class="s">	    } else {</span>
<span class="s">		$test_case = 1;</span>
<span class="s">		$skip = 0;</span>
<span class="s">	    }</span>

<span class="s">	    if ($rest =~ s/\sELSE\b//) {</span>
<span class="s">		if (!$if) {</span>
<span class="s">		    die &quot;$name: $.: ELSE found with out matching IF section\n$_&quot;;</span>
<span class="s">		}</span>
<span class="s">		$if = 0;</span>

<span class="s">		if ($if_set) {</span>
<span class="s">		    $skip = 1;</span>
<span class="s">		} else {</span>
<span class="s">		    $skip = 0;</span>
<span class="s">		}</span>
<span class="s">	    }</span>

<span class="s">	    if ($rest =~ s/\sIF\s+(.*)//) {</span>
<span class="s">		if (process_if($name, $1)) {</span>
<span class="s">		    $if_set = 1;</span>
<span class="s">		} else {</span>
<span class="s">		    $skip = 1;</span>
<span class="s">		}</span>
<span class="s">		$if = 1;</span>
<span class="s">	    } else {</span>
<span class="s">		$if = 0;</span>
<span class="s">		$if_set = 0;</span>
<span class="s">	    }</span>

<span class="s">	    if (!$skip) {</span>
<span class="s">		if ($type eq &quot;TEST_START&quot;) {</span>
<span class="s">		    if ($rest =~ s/\s+ITERATE\s+(\d+)//) {</span>
<span class="s">			$repeat = $1;</span>
<span class="s">			$repeat_tests{&quot;$test_num&quot;} = $repeat;</span>
<span class="s">		    }</span>
<span class="s">		} elsif ($rest =~ s/\sOVERRIDE\b//) {</span>

<span class="s">#DIVIDER</span>
<span class="s">		    $override = 1;</span>

<span class="s">#DIVIDER</span>
<span class="s">		    %overrides = ();</span>
<span class="s">		}</span>
<span class="s">	    }</span>

<span class="s">	    if (!$skip &amp;&amp; $rest !~ /^\s*$/) {</span>
<span class="s">		die &quot;$name: $.: Gargbage found after $type\n$_&quot;;</span>
<span class="s">	    }</span>

<span class="s">	    if ($skip &amp;&amp; $type eq &quot;TEST_START&quot;) {</span>
<span class="s">		$test_num = $old_test_num;</span>
<span class="s">		$repeat = $old_repeat;</span>
<span class="s">	    }</span>

<span class="s">	} elsif (/^\s*ELSE\b(.*)$/) {</span>
<span class="s">	    if (!$if) {</span>
<span class="s">		die &quot;$name: $.: ELSE found with out matching IF section\n$_&quot;;</span>
<span class="s">	    }</span>
<span class="s">	    $rest = $1;</span>
<span class="s">	    if ($if_set) {</span>
<span class="s">		$skip = 1;</span>
<span class="s">		$rest = &quot;&quot;;</span>
<span class="s">	    } else {</span>
<span class="s">		$skip = 0;</span>

<span class="s">		if ($rest =~ /\sIF\s+(.*)/) {</span>

<span class="s">#DIVIDER</span>
<span class="s">		    if (!process_if($name, $1)) {</span>
<span class="s">			$skip = 1;</span>
<span class="s">		    }</span>
<span class="s">		    $rest = &quot;&quot;;</span>
<span class="s">		} else {</span>
<span class="s">		    $if = 0;</span>
<span class="s">		}</span>
<span class="s">	    }</span>

<span class="s">	    if ($rest !~ /^\s*$/) {</span>
<span class="s">		die &quot;$name: $.: Gargbage found after DEFAULTS\n$_&quot;;</span>
<span class="s">	    }</span>

<span class="s">	} elsif (/^\s*INCLUDE\s+(\S+)/) {</span>

<span class="s">	    next if ($skip);</span>

<span class="s">	    if (!$default) {</span>
<span class="s">		die &quot;$name: $.: INCLUDE can only be done in default sections\n$_&quot;;</span>
<span class="s">	    }</span>

<span class="s">	    my $file = process_variables($1);</span>

<span class="s">	    if ($file !~ m,^/,) {</span>

<span class="s">#DIVIDER</span>
<span class="s">		if ($config =~ m,(.*)/,) {</span>
<span class="s">		    if (-f &quot;$1/$file&quot;) {</span>
<span class="s">			$file = &quot;$1/$file&quot;;</span>
<span class="s">		    }</span>
<span class="s">		}</span>
<span class="s">	    }</span>
<span class="s">		</span>
<span class="s">	    if ( ! -r $file ) {</span>
<span class="s">		die &quot;$name: $.: Can&#39;</span><span class="n">t</span> <span class="nb">read</span> <span class="n">file</span> <span class="nv">$file</span><span class="o">\</span><span class="n">n</span><span class="nv">$_</span><span class="s">&quot;;</span>
<span class="s">	    }</span>

<span class="s">	    if (__read_config($file, \$test_num)) {</span>
<span class="s">		$test_case = 1;</span>
<span class="s">	    }</span>

<span class="s">	} elsif (/^\s*([A-Z_\[\]\d]+)\s*=\s*(.*?)\s*$/) {</span>

<span class="s">	    next if ($skip);</span>

<span class="s">	    my $lvalue = $1;</span>
<span class="s">	    my $rvalue = $2;</span>

<span class="s">	    if (!$default &amp;&amp;</span>
<span class="s">		($lvalue eq &quot;</span><span class="n">NUM_TESTS</span><span class="s">&quot; ||</span>
<span class="s">		 $lvalue eq &quot;</span><span class="n">LOG_FILE</span><span class="s">&quot; ||</span>
<span class="s">		 $lvalue eq &quot;</span><span class="n">CLEAR_LOG</span><span class="s">&quot;)) {</span>
<span class="s">		die &quot;</span><span class="nv">$name:</span> <span class="vg">$.</span><span class="p">:</span> <span class="nv">$lvalue</span> <span class="n">must</span> <span class="n">be</span> <span class="n">set</span> <span class="n">in</span> <span class="n">DEFAULTS</span> <span class="n">section</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	    }</span>

<span class="s">	    if ($lvalue eq &quot;</span><span class="n">NUM_TESTS</span><span class="s">&quot;) {</span>
<span class="s">		if ($test_num) {</span>
<span class="s">		    die &quot;</span><span class="nv">$name:</span> <span class="vg">$.</span><span class="p">:</span> <span class="n">Can</span> <span class="ow">not</span> <span class="n">specify</span> <span class="n">both</span> <span class="n">NUM_TESTS</span> <span class="ow">and</span> <span class="n">TEST_START</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">		}</span>
<span class="s">		if (!$default) {</span>
<span class="s">		    die &quot;</span><span class="nv">$name:</span> <span class="vg">$.</span><span class="p">:</span> <span class="n">NUM_TESTS</span> <span class="n">must</span> <span class="n">be</span> <span class="n">set</span> <span class="n">in</span> <span class="n">default</span> <span class="n">section</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">		}</span>
<span class="s">		$num_tests_set = 1;</span>
<span class="s">	    }</span>

<span class="s">	    if ($default || $lvalue =~ /\[\d+\]$/) {</span>
<span class="s">		set_value($lvalue, $rvalue, $override, \%overrides, $name);</span>
<span class="s">	    } else {</span>
<span class="s">		my $val = &quot;</span><span class="nv">$lvalue</span><span class="o">\</span><span class="p">[</span><span class="nv">$test_num</span><span class="o">\</span><span class="p">]</span><span class="s">&quot;;</span>
<span class="s">		set_value($val, $rvalue, $override, \%overrides, $name);</span>

<span class="s">		if ($repeat &gt; 1) {</span>
<span class="s">		    $repeats{$val} = $repeat;</span>
<span class="s">		}</span>
<span class="s">	    }</span>
<span class="s">	} elsif (/^\s*([A-Z_\[\]\d]+)\s*:=\s*(.*?)\s*$/) {</span>
<span class="s">	    next if ($skip);</span>

<span class="s">	    my $lvalue = $1;</span>
<span class="s">	    my $rvalue = $2;</span>


<span class="s">#DIVIDER</span>
<span class="s">	    set_variable($lvalue, $rvalue);</span>

<span class="s">	} else {</span>
<span class="s">	    die &quot;</span><span class="nv">$name:</span> <span class="vg">$.</span><span class="p">:</span> <span class="n">Garbage</span> <span class="n">found</span> <span class="n">in</span> <span class="n">config</span><span class="o">\</span><span class="n">n</span><span class="nv">$_</span><span class="s">&quot;;</span>
<span class="s">	}</span>
<span class="s">    }</span>

<span class="s">    if ($test_num) {</span>
<span class="s">	$test_num += $repeat - 1;</span>
<span class="s">	$opt{&quot;</span><span class="n">NUM_TESTS</span><span class="s">&quot;} = $test_num;</span>
<span class="s">    }</span>

<span class="s">    close($in);</span>

<span class="s">    $$current_test_num = $test_num;</span>

<span class="s">    return $test_case;</span>
<span class="s">}</span>

<span class="s">sub get_test_case {</span>
<span class="s">	print &quot;</span><span class="n">What</span> <span class="n">test</span> <span class="k">case</span> <span class="n">would</span> <span class="n">you</span> <span class="n">like</span> <span class="n">to</span> <span class="n">run</span><span class="p">?</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	print &quot;</span> <span class="p">(</span><span class="n">build</span><span class="p">,</span> <span class="n">install</span> <span class="ow">or</span> <span class="n">boot</span><span class="p">)</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	print &quot;</span> <span class="n">Other</span> <span class="n">tests</span> <span class="n">are</span> <span class="n">available</span> <span class="n">but</span> <span class="nb">require</span> <span class="n">editing</span> <span class="n">the</span> <span class="n">config</span> <span class="n">file</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	my $ans = &lt;STDIN&gt;;</span>
<span class="s">	chomp $ans;</span>
<span class="s">	$default{&quot;</span><span class="n">TEST_TYPE</span><span class="s">&quot;} = $ans;</span>
<span class="s">}</span>

<span class="s">sub read_config {</span>
<span class="s">    my ($config) = @_;</span>

<span class="s">    my $test_case;</span>
<span class="s">    my $test_num = 0;</span>

<span class="s">    $test_case = __read_config $config, \$test_num;</span>


<span class="s">#DIVIDER</span>
<span class="s">    get_ktest_configs;</span>


<span class="s">#DIVIDER</span>
<span class="s">    if (!$test_case) {</span>
<span class="s">	print &quot;</span><span class="n">No</span> <span class="n">test</span> <span class="k">case</span> <span class="n">specified</span><span class="o">.\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	get_test_case;</span>
<span class="s">    }</span>


<span class="s">#DIVIDER</span>

<span class="s">    foreach my $default (keys %default) {</span>
<span class="s">	if (!defined($opt{$default})) {</span>
<span class="s">	    $opt{$default} = $default{$default};</span>
<span class="s">	}</span>
<span class="s">    }</span>

<span class="s">    if ($opt{&quot;</span><span class="n">IGNORE_UNUSED</span><span class="s">&quot;} == 1) {</span>
<span class="s">	return;</span>
<span class="s">    }</span>

<span class="s">    my %not_used;</span>


<span class="s">#DIVIDER</span>
<span class="s">    foreach my $option (keys %opt) {</span>
<span class="s">	my $op = $option;</span>

<span class="s">#DIVIDER</span>
<span class="s">	$op =~ s/\[.*\]//;</span>
<span class="s">	if (!exists($option_map{$op}) &amp;&amp;</span>
<span class="s">	    !exists($default{$op}) &amp;&amp;</span>
<span class="s">	    !exists($used_options{$op})) {</span>
<span class="s">	    $not_used{$op} = 1;</span>
<span class="s">	}</span>
<span class="s">    }</span>

<span class="s">    if (%not_used) {</span>
<span class="s">	my $s = &quot;</span><span class="n">s</span> <span class="n">are</span><span class="s">&quot;;</span>
<span class="s">	$s = &quot;</span> <span class="n">is</span><span class="s">&quot; if (keys %not_used == 1);</span>
<span class="s">	print &quot;</span><span class="n">The</span> <span class="n">following</span> <span class="n">option</span><span class="nv">$s</span> <span class="ow">not</span> <span class="n">used</span><span class="p">;</span> <span class="n">could</span> <span class="n">be</span> <span class="n">a</span> <span class="n">typo:</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	foreach my $option (keys %not_used) {</span>
<span class="s">	    print &quot;</span><span class="nv">$option</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	}</span>
<span class="s">	print &quot;</span><span class="n">Set</span> <span class="n">IGRNORE_UNUSED</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">have</span> <span class="n">ktest</span> <span class="n">ignore</span> <span class="n">unused</span> <span class="n">variables</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	if (!read_yn &quot;</span><span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span><span class="p">?</span><span class="s">&quot;) {</span>
<span class="s">	    exit -1;</span>
<span class="s">	}</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">sub __eval_option {</span>
<span class="s">    my ($option, $i) = @_;</span>


<span class="s">#DIVIDER</span>
<span class="s">    $option = &quot;</span> <span class="nv">$option</span><span class="s">&quot;;</span>
<span class="s">    my $retval = &quot;&quot;;</span>
<span class="s">    my $repeated = 0;</span>
<span class="s">    my $parent = 0;</span>

<span class="s">    foreach my $test (keys %repeat_tests) {</span>
<span class="s">	if ($i &gt;= $test &amp;&amp;</span>
<span class="s">	    $i &lt; $test + $repeat_tests{$test}) {</span>

<span class="s">	    $repeated = 1;</span>
<span class="s">	    $parent = $test;</span>
<span class="s">	    last;</span>
<span class="s">	}</span>
<span class="s">    }</span>

<span class="s">    while ($option =~ /(.*?[^\\])\$\{(.*?)\}(.*)/) {</span>
<span class="s">	my $start = $1;</span>
<span class="s">	my $var = $2;</span>
<span class="s">	my $end = $3;</span>


<span class="s">#DIVIDER</span>
<span class="s">	$retval = &quot;</span><span class="nv">$retval$start</span><span class="s">&quot;;</span>


<span class="s">#DIVIDER</span>

<span class="s">	my $o = &quot;</span><span class="nv">$var</span><span class="o">\</span><span class="p">[</span><span class="nv">$i</span><span class="o">\</span><span class="p">]</span><span class="s">&quot;;</span>
<span class="s">	my $parento = &quot;</span><span class="nv">$var</span><span class="o">\</span><span class="p">[</span><span class="nv">$parent</span><span class="o">\</span><span class="p">]</span><span class="s">&quot;;</span>

<span class="s">	if (defined($opt{$o})) {</span>
<span class="s">	    $o = $opt{$o};</span>
<span class="s">	    $retval = &quot;</span><span class="nv">$retval$o</span><span class="s">&quot;;</span>
<span class="s">	} elsif ($repeated &amp;&amp; defined($opt{$parento})) {</span>
<span class="s">	    $o = $opt{$parento};</span>
<span class="s">	    $retval = &quot;</span><span class="nv">$retval$o</span><span class="s">&quot;;</span>
<span class="s">	} elsif (defined($opt{$var})) {</span>
<span class="s">	    $o = $opt{$var};</span>
<span class="s">	    $retval = &quot;</span><span class="nv">$retval$o</span><span class="s">&quot;;</span>
<span class="s">	} else {</span>
<span class="s">	    $retval = &quot;</span><span class="nv">$retval</span><span class="o">\</span><span class="vg">$\</span><span class="p">{</span><span class="nv">$var</span><span class="o">\</span><span class="p">}</span><span class="s">&quot;;</span>
<span class="s">	}</span>

<span class="s">	$option = $end;</span>
<span class="s">    }</span>

<span class="s">    $retval = &quot;</span><span class="nv">$retval$option</span><span class="s">&quot;;</span>

<span class="s">    $retval =~ s/^ //;</span>

<span class="s">    return $retval;</span>
<span class="s">}</span>

<span class="s">sub eval_option {</span>
<span class="s">    my ($option, $i) = @_;</span>

<span class="s">    my $prev = &quot;&quot;;</span>


<span class="s">#DIVIDER</span>
<span class="s">    my $r = 0;</span>
<span class="s">    while ($prev ne $option) {</span>

<span class="s">#DIVIDER</span>
<span class="s">	if ($r++ &gt; 100) {</span>
<span class="s">	    die &quot;</span><span class="n">Over</span> <span class="mi">100</span> <span class="n">evaluations</span> <span class="n">accurred</span> <span class="n">with</span> <span class="nv">$option</span><span class="o">\</span><span class="n">n</span><span class="s">&quot; .</span>
<span class="s">		&quot;</span><span class="n">Check</span> <span class="k">for</span> <span class="n">recursive</span> <span class="n">variables</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	}</span>
<span class="s">	$prev = $option;</span>
<span class="s">	$option = __eval_option($option, $i);</span>
<span class="s">    }</span>

<span class="s">    return $option;</span>
<span class="s">}</span>

<span class="s">sub _logit {</span>
<span class="s">    if (defined($opt{&quot;</span><span class="n">LOG_FILE</span><span class="s">&quot;})) {</span>
<span class="s">	open(OUT, &quot;</span><span class="o">&gt;&gt;</span> <span class="nv">$opt</span><span class="p">{</span><span class="n">LOG_FILE</span><span class="p">}</span><span class="s">&quot;) or die &quot;</span><span class="n">Can</span><span class="s">&#39;t write to $opt{LOG_FILE}&quot;;</span>
<span class="s">	print OUT @_;</span>
<span class="s">	close(OUT);</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">sub logit {</span>
<span class="s">    if (defined($opt{&quot;LOG_FILE&quot;})) {</span>
<span class="s">	_logit @_;</span>
<span class="s">    } else {</span>
<span class="s">	print @_;</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">sub doprint {</span>
<span class="s">    print @_;</span>
<span class="s">    _logit @_;</span>
<span class="s">}</span>

<span class="s">sub run_command;</span>
<span class="s">sub start_monitor;</span>
<span class="s">sub end_monitor;</span>
<span class="s">sub wait_for_monitor;</span>

<span class="s">sub reboot {</span>
<span class="s">    my ($time) = @_;</span>

<span class="s">    if (defined($time)) {</span>
<span class="s">	start_monitor;</span>

<span class="s">#DIVIDER</span>
<span class="s">	wait_for_monitor 1;</span>
<span class="s">    }</span>


<span class="s">#DIVIDER</span>
<span class="s">    if (run_command $reboot) {</span>
<span class="s">	if (defined($powercycle_after_reboot)) {</span>
<span class="s">	    sleep $powercycle_after_reboot;</span>
<span class="s">	    run_command &quot;$power_cycle&quot;;</span>
<span class="s">	}</span>
<span class="s">    } else {</span>

<span class="s">#DIVIDER</span>
<span class="s">	run_command &quot;$power_cycle&quot;;</span>
<span class="s">    }</span>

<span class="s">    if (defined($time)) {</span>
<span class="s">	wait_for_monitor($time, $reboot_success_line);</span>
<span class="s">	end_monitor;</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">sub reboot_to_good {</span>
<span class="s">    my ($time) = @_;</span>

<span class="s">    if (defined($switch_to_good)) {</span>
<span class="s">	run_command $switch_to_good;</span>
<span class="s">    }</span>

<span class="s">    reboot $time;</span>
<span class="s">}</span>

<span class="s">sub do_not_reboot {</span>
<span class="s">    my $i = $iteration;</span>

<span class="s">    return $test_type eq &quot;build&quot; || $no_reboot ||</span>
<span class="s">	($test_type eq &quot;patchcheck&quot; &amp;&amp; $opt{&quot;PATCHCHECK_TYPE[$i]&quot;} eq &quot;build&quot;) ||</span>
<span class="s">	($test_type eq &quot;bisect&quot; &amp;&amp; $opt{&quot;BISECT_TYPE[$i]&quot;} eq &quot;build&quot;);</span>
<span class="s">}</span>

<span class="s">sub dodie {</span>
<span class="s">    doprint &quot;CRITICAL FAILURE... &quot;, @_, &quot;\n&quot;;</span>

<span class="s">    my $i = $iteration;</span>

<span class="s">    if ($reboot_on_error &amp;&amp; !do_not_reboot) {</span>

<span class="s">	doprint &quot;REBOOTING\n&quot;;</span>
<span class="s">	reboot_to_good;</span>

<span class="s">    } elsif ($poweroff_on_error &amp;&amp; defined($power_off)) {</span>
<span class="s">	doprint &quot;POWERING OFF\n&quot;;</span>
<span class="s">	`$power_off`;</span>
<span class="s">    }</span>

<span class="s">    if (defined($opt{&quot;LOG_FILE&quot;})) {</span>
<span class="s">	print &quot; See $opt{LOG_FILE} for more info.\n&quot;;</span>
<span class="s">    }</span>

<span class="s">    die @_, &quot;\n&quot;;</span>
<span class="s">}</span>

<span class="s">sub open_console {</span>
<span class="s">    my ($fp) = @_;</span>

<span class="s">    my $flags;</span>

<span class="s">    my $pid = open($fp, &quot;$console|&quot;) or</span>
<span class="s">	dodie &quot;Can&#39;</span><span class="n">t</span> <span class="nb">open</span> <span class="n">console</span> <span class="nv">$console</span><span class="s">&quot;;</span>

<span class="s">    $flags = fcntl($fp, F_GETFL, 0) or</span>
<span class="s">	dodie &quot;</span><span class="n">Can</span><span class="s">&#39;t get flags for the socket: $!&quot;;</span>
<span class="s">    $flags = fcntl($fp, F_SETFL, $flags | O_NONBLOCK) or</span>
<span class="s">	dodie &quot;Can&#39;</span><span class="n">t</span> <span class="n">set</span> <span class="n">flags</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">socket</span><span class="p">:</span> <span class="vg">$!</span><span class="s">&quot;;</span>

<span class="s">    return $pid;</span>
<span class="s">}</span>

<span class="s">sub close_console {</span>
<span class="s">    my ($fp, $pid) = @_;</span>

<span class="s">    doprint &quot;</span><span class="nb">kill</span> <span class="n">child</span> <span class="n">process</span> <span class="nv">$pid</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">    kill 2, $pid;</span>

<span class="s">    print &quot;</span><span class="n">closing</span><span class="o">!\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">    close($fp);</span>
<span class="s">}</span>

<span class="s">sub start_monitor {</span>
<span class="s">    if ($monitor_cnt++) {</span>
<span class="s">	return;</span>
<span class="s">    }</span>
<span class="s">    $monitor_fp = \*MONFD;</span>
<span class="s">    $monitor_pid = open_console $monitor_fp;</span>

<span class="s">    return;</span>

<span class="s">    open(MONFD, &quot;</span><span class="n">Stop</span> <span class="n">perl</span> <span class="n">from</span> <span class="n">warning</span> <span class="n">about</span> <span class="n">single</span> <span class="k">use</span> <span class="n">of</span> <span class="n">MONFD</span><span class="s">&quot;);</span>
<span class="s">}</span>

<span class="s">sub end_monitor {</span>
<span class="s">    if (--$monitor_cnt) {</span>
<span class="s">	return;</span>
<span class="s">    }</span>
<span class="s">    close_console($monitor_fp, $monitor_pid);</span>
<span class="s">}</span>

<span class="s">sub wait_for_monitor {</span>
<span class="s">    my ($time, $stop) = @_;</span>
<span class="s">    my $full_line = &quot;&quot;;</span>
<span class="s">    my $line;</span>
<span class="s">    my $booted = 0;</span>

<span class="s">    doprint &quot;</span><span class="o">**</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">monitor</span> <span class="n">to</span> <span class="n">settle</span> <span class="n">down</span> <span class="o">**\</span><span class="n">n</span><span class="s">&quot;;</span>


<span class="s">#DIVIDER</span>
<span class="s">    while (!$booted) {</span>
<span class="s">	$line = wait_for_input($monitor_fp, $time);</span>
<span class="s">	last if (!defined($line));</span>
<span class="s">	print &quot;</span><span class="nv">$line</span><span class="s">&quot;;</span>
<span class="s">	$full_line .= $line;</span>

<span class="s">	if (defined($stop) &amp;&amp; $full_line =~ /$stop/) {</span>
<span class="s">	    doprint &quot;</span><span class="nb">wait</span> <span class="k">for</span> <span class="n">monitor</span> <span class="n">detected</span> <span class="nv">$stop</span><span class="o">\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">	    $booted = 1;</span>
<span class="s">	}</span>

<span class="s">	if ($line =~ /\n/) {</span>
<span class="s">	    $full_line = &quot;&quot;;</span>
<span class="s">	}</span>
<span class="s">    }</span>
<span class="s">    print &quot;</span><span class="o">**</span> <span class="n">Monitor</span> <span class="n">flushed</span> <span class="o">**\</span><span class="n">n</span><span class="s">&quot;;</span>
<span class="s">}</span>

<span class="s">sub save_logs {</span>
<span class="s">	my ($result, $basedir) = @_;</span>
<span class="s">	my @t = localtime;</span>
<span class="s">	my $date = sprintf &quot;</span><span class="nv">%04d%02d%02d%02d%02d%02d</span><span class="s">&quot;,</span>
<span class="s">		1900+$t[5],$t[4],$t[3],$t[2],$t[1],$t[0];</span>

<span class="s">	my $type = $build_type;</span>
<span class="s">	if ($type =~ /useconfig/) {</span>
<span class="s">	    $type = &quot;</span><span class="n">useconfig</span><span class="s">&quot;;</span>
<span class="s">	}</span>

<span class="s">	my $dir = &quot;</span><span class="nv">$machine</span><span class="o">-</span><span class="nv">$test_type</span><span class="o">-</span><span class="nv">$type</span><span class="o">-</span><span class="nv">$result</span><span class="o">-</span><span class="nv">$date</span><span class="s">&quot;;</span>

<span class="s">	$dir = &quot;</span><span class="nv">$basedir</span><span class="o">/</span><span class="nv">$dir</span><span class="s">&quot;;</span>

<span class="s">	if (!-d $dir) {</span>
<span class="s">	    mkpath($dir) or</span>
<span class="s">		die &quot;</span><span class="n">can</span><span class="s">&#39;t create $dir&quot;;</span>
<span class="s">	}</span>

<span class="s">	my %files = (</span>
<span class="s">		&quot;config&quot; =&gt; $output_config,</span>
<span class="s">		&quot;buildlog&quot; =&gt; $buildlog,</span>
<span class="s">		&quot;dmesg&quot; =&gt; $dmesg,</span>
<span class="s">		&quot;testlog&quot; =&gt; $testlog,</span>
<span class="s">	);</span>

<span class="s">	while (my ($name, $source) = each(%files)) {</span>
<span class="s">		if (-f &quot;$source&quot;) {</span>
<span class="s">			cp &quot;$source&quot;, &quot;$dir/$name&quot; or</span>
<span class="s">				die &quot;failed to copy $source&quot;;</span>
<span class="s">		}</span>
<span class="s">	}</span>

<span class="s">	doprint &quot;*** Saved info to $dir ***\n&quot;;</span>
<span class="s">}</span>

<span class="s">sub fail {</span>

<span class="s">	if ($die_on_failure) {</span>
<span class="s">		dodie @_;</span>
<span class="s">	}</span>

<span class="s">	doprint &quot;FAILED\n&quot;;</span>

<span class="s">	my $i = $iteration;</span>


<span class="s">#DIVIDER</span>
<span class="s">	if (!do_not_reboot) {</span>
<span class="s">	    doprint &quot;REBOOTING\n&quot;;</span>
<span class="s">	    reboot_to_good $sleep_time;</span>
<span class="s">	}</span>

<span class="s">	my $name = &quot;&quot;;</span>

<span class="s">	if (defined($test_name)) {</span>
<span class="s">	    $name = &quot; ($test_name)&quot;;</span>
<span class="s">	}</span>

<span class="s">	doprint &quot;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n&quot;;</span>
<span class="s">	doprint &quot;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n&quot;;</span>
<span class="s">	doprint &quot;KTEST RESULT: TEST $i$name Failed: &quot;, @_, &quot;\n&quot;;</span>
<span class="s">	doprint &quot;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n&quot;;</span>
<span class="s">	doprint &quot;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n&quot;;</span>

<span class="s">	if (defined($store_failures)) {</span>
<span class="s">	    save_logs &quot;fail&quot;, $store_failures;</span>
<span class="s">        }</span>

<span class="s">	return 1;</span>
<span class="s">}</span>

<span class="s">sub run_command {</span>
<span class="s">    my ($command) = @_;</span>
<span class="s">    my $dolog = 0;</span>
<span class="s">    my $dord = 0;</span>
<span class="s">    my $pid;</span>

<span class="s">    $command =~ s/\$SSH_USER/$ssh_user/g;</span>
<span class="s">    $command =~ s/\$MACHINE/$machine/g;</span>

<span class="s">    doprint(&quot;$command ... &quot;);</span>

<span class="s">    $pid = open(CMD, &quot;$command 2&gt;&amp;1 |&quot;) or</span>
<span class="s">	(fail &quot;unable to exec $command&quot; and return 0);</span>

<span class="s">    if (defined($opt{&quot;LOG_FILE&quot;})) {</span>
<span class="s">	open(LOG, &quot;&gt;&gt;$opt{LOG_FILE}&quot;) or</span>
<span class="s">	    dodie &quot;failed to write to log&quot;;</span>
<span class="s">	$dolog = 1;</span>
<span class="s">    }</span>

<span class="s">    if (defined($redirect)) {</span>
<span class="s">	open (RD, &quot;&gt;$redirect&quot;) or</span>
<span class="s">	    dodie &quot;failed to write to redirect $redirect&quot;;</span>
<span class="s">	$dord = 1;</span>
<span class="s">    }</span>

<span class="s">    while (&lt;CMD&gt;) {</span>
<span class="s">	print LOG if ($dolog);</span>
<span class="s">	print RD  if ($dord);</span>
<span class="s">    }</span>

<span class="s">    waitpid($pid, 0);</span>
<span class="s">    my $failed = $?;</span>

<span class="s">    close(CMD);</span>
<span class="s">    close(LOG) if ($dolog);</span>
<span class="s">    close(RD)  if ($dord);</span>

<span class="s">    if ($failed) {</span>
<span class="s">	doprint &quot;FAILED!\n&quot;;</span>
<span class="s">    } else {</span>
<span class="s">	doprint &quot;SUCCESS\n&quot;;</span>
<span class="s">    }</span>

<span class="s">    return !$failed;</span>
<span class="s">}</span>

<span class="s">sub run_ssh {</span>
<span class="s">    my ($cmd) = @_;</span>
<span class="s">    my $cp_exec = $ssh_exec;</span>

<span class="s">    $cp_exec =~ s/\$SSH_COMMAND/$cmd/g;</span>
<span class="s">    return run_command &quot;$cp_exec&quot;;</span>
<span class="s">}</span>

<span class="s">sub run_scp {</span>
<span class="s">    my ($src, $dst, $cp_scp) = @_;</span>

<span class="s">    $cp_scp =~ s/\$SRC_FILE/$src/g;</span>
<span class="s">    $cp_scp =~ s/\$DST_FILE/$dst/g;</span>

<span class="s">    return run_command &quot;$cp_scp&quot;;</span>
<span class="s">}</span>

<span class="s">sub run_scp_install {</span>
<span class="s">    my ($src, $dst) = @_;</span>

<span class="s">    my $cp_scp = $scp_to_target_install;</span>

<span class="s">    return run_scp($src, $dst, $cp_scp);</span>
<span class="s">}</span>

<span class="s">sub run_scp_mod {</span>
<span class="s">    my ($src, $dst) = @_;</span>

<span class="s">    my $cp_scp = $scp_to_target;</span>

<span class="s">    return run_scp($src, $dst, $cp_scp);</span>
<span class="s">}</span>

<span class="s">sub get_grub_index {</span>

<span class="s">    if ($reboot_type ne &quot;grub&quot;) {</span>
<span class="s">	return;</span>
<span class="s">    }</span>
<span class="s">    return if (defined($grub_number));</span>

<span class="s">    doprint &quot;Find grub menu ... &quot;;</span>
<span class="s">    $grub_number = -1;</span>

<span class="s">    my $ssh_grub = $ssh_exec;</span>
<span class="s">    $ssh_grub =~ s,\$SSH_COMMAND,cat /boot/grub/menu.lst,g;</span>

<span class="s">    open(IN, &quot;$ssh_grub |&quot;)</span>
<span class="s">	or die &quot;unable to get menu.lst&quot;;</span>

<span class="s">    my $found = 0;</span>

<span class="s">    while (&lt;IN&gt;) {</span>
<span class="s">	if (/^\s*title\s+$grub_menu\s*$/) {</span>
<span class="s">	    $grub_number++;</span>
<span class="s">	    $found = 1;</span>
<span class="s">	    last;</span>
<span class="s">	} elsif (/^\s*title\s/) {</span>
<span class="s">	    $grub_number++;</span>
<span class="s">	}</span>
<span class="s">    }</span>
<span class="s">    close(IN);</span>

<span class="s">    die &quot;Could not find &#39;</span><span class="nv">$grub_menu</span><span class="s">&#39; in /boot/grub/menu on $machine&quot;</span>
<span class="s">	if (!$found);</span>
<span class="s">    doprint &quot;$grub_number\n&quot;;</span>
<span class="s">}</span>

<span class="s">sub wait_for_input</span>
<span class="s">{</span>
<span class="s">    my ($fp, $time) = @_;</span>
<span class="s">    my $rin;</span>
<span class="s">    my $ready;</span>
<span class="s">    my $line;</span>
<span class="s">    my $ch;</span>

<span class="s">    if (!defined($time)) {</span>
<span class="s">	$time = $timeout;</span>
<span class="s">    }</span>

<span class="s">    $rin = &#39;&#39;;</span>
<span class="s">    vec($rin, fileno($fp), 1) = 1;</span>
<span class="s">    $ready = select($rin, undef, undef, $time);</span>

<span class="s">    $line = &quot;&quot;;</span>


<span class="s">#DIVIDER</span>
<span class="s">    while (sysread $fp, $ch, 1) {</span>
<span class="s">	$line .= $ch;</span>
<span class="s">	last if ($ch eq &quot;\n&quot;);</span>
<span class="s">    }</span>

<span class="s">    if (!length($line)) {</span>
<span class="s">	return undef;</span>
<span class="s">    }</span>

<span class="s">    return $line;</span>
<span class="s">}</span>

<span class="s">sub reboot_to {</span>
<span class="s">    if (defined($switch_to_test)) {</span>
<span class="s">	run_command $switch_to_test;</span>
<span class="s">    }</span>

<span class="s">    if ($reboot_type eq &quot;grub&quot;) {</span>
<span class="s">	run_ssh &quot;&#39;</span><span class="p">(</span><span class="n">echo</span> <span class="o">\</span><span class="s">&quot;savedefault --default=$grub_number --once\&quot; | grub --batch)&#39;&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$reboot_script</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">run_command</span> <span class="s">&quot;$reboot_script&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">reboot</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">get_sha1</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$commit</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="n">doprint</span> <span class="s">&quot;git rev-list --max-count=1 $commit ... &quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$sha1</span> <span class="o">=</span> <span class="sb">`git rev-list --max-count=1 $commit`</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="vg">$?</span><span class="p">;</span>

    <span class="n">logit</span> <span class="nv">$sha1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;FAILED\n&quot;</span><span class="p">;</span>
	<span class="n">dodie</span> <span class="s">&quot;Failed to get git $commit&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">print</span> <span class="s">&quot;SUCCESS\n&quot;</span><span class="p">;</span>

    <span class="nb">chomp</span> <span class="nv">$sha1</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$sha1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">monitor</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$booted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$bug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$bug_ignored</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$skip_call_trace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$loops</span><span class="p">;</span>

    <span class="n">wait_for_monitor</span> <span class="mi">5</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$full_line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">DMESG</span><span class="p">,</span> <span class="s">&quot;&gt; $dmesg&quot;</span><span class="p">)</span> <span class="ow">or</span>
	<span class="nb">die</span> <span class="s">&quot;unable to write to $dmesg&quot;</span><span class="p">;</span>

    <span class="n">reboot_to</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$success_start</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$failure_start</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$monitor_start</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$version_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$done</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$bug</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$stop_after_failure</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="nv">$stop_after_failure</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">my</span> <span class="nv">$time</span> <span class="o">=</span> <span class="nv">$stop_after_failure</span> <span class="o">-</span> <span class="p">(</span><span class="nb">time</span> <span class="o">-</span> <span class="nv">$failure_start</span><span class="p">);</span>
	    <span class="nv">$line</span> <span class="o">=</span> <span class="n">wait_for_input</span><span class="p">(</span><span class="nv">$monitor_fp</span><span class="p">,</span> <span class="nv">$time</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$line</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">doprint</span> <span class="s">&quot;bug timed out after $booted_timeout seconds\n&quot;</span><span class="p">;</span>
		<span class="n">doprint</span> <span class="s">&quot;Test forced to stop after $stop_after_failure seconds after failure\n&quot;</span><span class="p">;</span>
		<span class="k">last</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$booted</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$line</span> <span class="o">=</span> <span class="n">wait_for_input</span><span class="p">(</span><span class="nv">$monitor_fp</span><span class="p">,</span> <span class="nv">$booted_timeout</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$line</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$s</span> <span class="o">=</span> <span class="nv">$booted_timeout</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">?</span> <span class="s">&quot;&quot;</span> <span class="p">:</span> <span class="s">&quot;s&quot;</span><span class="p">;</span>
		<span class="n">doprint</span> <span class="s">&quot;Successful boot found: break after $booted_timeout second$s\n&quot;</span><span class="p">;</span>
		<span class="k">last</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$line</span> <span class="o">=</span> <span class="n">wait_for_input</span><span class="p">(</span><span class="nv">$monitor_fp</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$line</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$s</span> <span class="o">=</span> <span class="nv">$timeout</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">?</span> <span class="s">&quot;&quot;</span> <span class="p">:</span> <span class="s">&quot;s&quot;</span><span class="p">;</span>
		<span class="n">doprint</span> <span class="s">&quot;Timed out after $timeout second$s\n&quot;</span><span class="p">;</span>
		<span class="k">last</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="n">doprint</span> <span class="nv">$line</span><span class="p">;</span>
	<span class="k">print</span> <span class="n">DMESG</span> <span class="nv">$line</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>options required for other than just building a kernel</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$full_line</span> <span class="o">.=</span> <span class="nv">$line</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$full_line</span> <span class="o">=~</span><span class="sr"> /$success_line/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$booted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="nv">$success_start</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$booted</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$stop_after_success</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="nv">$stop_after_success</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">my</span> <span class="nv">$now</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$now</span> <span class="o">-</span> <span class="nv">$success_start</span> <span class="o">&gt;=</span> <span class="nv">$stop_after_success</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">doprint</span> <span class="s">&quot;Test forced to stop after $stop_after_success seconds after success\n&quot;</span><span class="p">;</span>
		<span class="k">last</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$full_line</span> <span class="o">=~</span><span class="sr"> /\[ backtrace testing \]/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$skip_call_trace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$full_line</span> <span class="o">=~</span><span class="sr"> /call trace:/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$bug</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$skip_call_trace</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$ignore_errors</span><span class="p">)</span> <span class="p">{</span>
		    <span class="nv">$bug_ignored</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="nv">$bug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		    <span class="nv">$failure_start</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$bug</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$stop_after_failure</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="nv">$stop_after_failure</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">my</span> <span class="nv">$now</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$now</span> <span class="o">-</span> <span class="nv">$failure_start</span> <span class="o">&gt;=</span> <span class="nv">$stop_after_failure</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">doprint</span> <span class="s">&quot;Test forced to stop after $stop_after_failure seconds after failure\n&quot;</span><span class="p">;</span>
		<span class="k">last</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$full_line</span> <span class="o">=~</span><span class="sr"> /\[ end of backtrace testing \]/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$skip_call_trace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$full_line</span> <span class="o">=~</span><span class="sr"> /Kernel panic -/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$failure_start</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
	    <span class="nv">$bug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>options required for install and more</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$full_line</span> <span class="o">=~</span><span class="sr"> /\bLinux version (\S+).*\n/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$1</span> <span class="ow">eq</span> <span class="nv">$version</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$version_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$version_found</span> <span class="o">&amp;&amp;</span> <span class="nv">$detect_triplefault</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>We want to check for '\', and it is just easier
to check the previous characet of '$' and not need
to worry if '$' is the first character. By adding
a space to $value, we can just check [^\]\$ and
it will still work.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">doprint</span> <span class="s">&quot;Aleady booted in Linux kernel $version, but now\n&quot;</span><span class="p">;</span>
		<span class="n">doprint</span> <span class="s">&quot;we booted into Linux kernel $1.\n&quot;</span><span class="p">;</span>
		<span class="n">doprint</span> <span class="s">&quot;Assuming that this is a triple fault.\n&quot;</span><span class="p">;</span>
		<span class="n">doprint</span> <span class="s">&quot;To disable this: set DETECT_TRIPLE_FAULT to 0\n&quot;</span><span class="p">;</span>
		<span class="k">last</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\n/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$full_line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$stop_test_after</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$booted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nb">time</span> <span class="o">-</span> <span class="nv">$monitor_start</span> <span class="o">&gt;</span> <span class="nv">$stop_test_after</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">doprint</span> <span class="s">&quot;STOP_TEST_AFTER ($stop_test_after seconds) timed out\n&quot;</span><span class="p">;</span>
		<span class="nv">$done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="nb">close</span><span class="p">(</span><span class="n">DMESG</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$in_bisect</span><span class="p">);</span>
	<span class="n">fail</span> <span class="s">&quot;failed - got a bug report&quot;</span> <span class="ow">and</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$booted</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$in_bisect</span><span class="p">);</span>
	<span class="n">fail</span> <span class="s">&quot;failed - never got a boot prompt.&quot;</span> <span class="ow">and</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$bug_ignored</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;WARNING: Call Trace detected but ignored due to IGNORE_ERRORS=1\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">eval_kernel_version</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$option</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nv">$option</span> <span class="o">=~</span> <span class="sr">s/\$KERNEL_VERSION/$version/g</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$option</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">do_post_install</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$post_install</span><span class="p">));</span>

    <span class="k">my</span> <span class="nv">$cp_post_install</span> <span class="o">=</span> <span class="n">eval_kernel_version</span> <span class="nv">$post_install</span><span class="p">;</span>
    <span class="n">run_command</span> <span class="s">&quot;$cp_post_install&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;Failed to run post install&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">install</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$no_install</span><span class="p">);</span>

    <span class="k">my</span> <span class="nv">$cp_target</span> <span class="o">=</span> <span class="n">eval_kernel_version</span> <span class="nv">$target_image</span><span class="p">;</span>

    <span class="n">run_scp_install</span> <span class="s">&quot;$outputdir/$build_target&quot;</span><span class="p">,</span> <span class="s">&quot;$cp_target&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;failed to copy image&quot;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$install_mods</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>append beginning of value to retval</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$install_mods</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="s">&quot;$output_config&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dodie</span><span class="p">(</span><span class="s">&quot;Can&#39;t read config file&quot;</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/CONFIG_MODULES(=y)?/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$install_mods</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$1</span><span class="p">));</span>
	    <span class="k">last</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$install_mods</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">do_post_install</span><span class="p">;</span>
	<span class="n">doprint</span> <span class="s">&quot;No modules needed\n&quot;</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">run_command</span> <span class="s">&quot;$make INSTALL_MOD_STRIP=1 INSTALL_MOD_PATH=$tmpdir modules_install&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;Failed to install modules&quot;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$modlib</span> <span class="o">=</span> <span class="s">&quot;/lib/modules/$version&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$modtar</span> <span class="o">=</span> <span class="s">&quot;ktest-mods.tar.bz2&quot;</span><span class="p">;</span>

    <span class="n">run_ssh</span> <span class="s">&quot;rm -rf $modlib&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;failed to remove old mods: $modlib&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>for if statements, any variable that is not defined,
we simple convert to 0</p></td><td class="code"><div class="highlight"><pre>    <span class="n">run_command</span> <span class="s">&quot;cd $tmpdir &amp;&amp; tar -cjf $modtar lib/modules/$version&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;making tarball&quot;</span><span class="p">;</span>

    <span class="n">run_scp_mod</span> <span class="s">&quot;$tmpdir/$modtar&quot;</span><span class="p">,</span> <span class="s">&quot;/tmp&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;failed to copy modules&quot;</span><span class="p">;</span>

    <span class="nb">unlink</span> <span class="s">&quot;$tmpdir/$modtar&quot;</span><span class="p">;</span>

    <span class="n">run_ssh</span> <span class="s">&quot;&#39;(cd / &amp;&amp; tar xjf /tmp/$modtar)&#39;&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;failed to tar modules&quot;</span><span class="p">;</span>

    <span class="n">run_ssh</span> <span class="s">&quot;rm -f /tmp/$modtar&quot;</span><span class="p">;</span>

    <span class="n">do_post_install</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">get_version</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>put back the origin piece.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$have_version</span><span class="p">);</span>
    <span class="n">doprint</span> <span class="s">&quot;$make kernelrelease ... &quot;</span><span class="p">;</span>
    <span class="nv">$version</span> <span class="o">=</span> <span class="sb">`$make kernelrelease | tail -1`</span><span class="p">;</span>
    <span class="nb">chomp</span><span class="p">(</span><span class="nv">$version</span><span class="p">);</span>
    <span class="n">doprint</span> <span class="s">&quot;$version\n&quot;</span><span class="p">;</span>
    <span class="nv">$have_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">start_monitor_and_boot</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>This could be an option that is used later, save
it so we don't warn if this option is not one of
ktests options.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">start_monitor</span><span class="p">;</span>
    <span class="n">wait_for_monitor</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">end_monitor</span><span class="p">;</span>

    <span class="n">get_grub_index</span><span class="p">;</span>
    <span class="n">get_version</span><span class="p">;</span>
    <span class="n">install</span><span class="p">;</span>

    <span class="n">start_monitor</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">monitor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">check_buildlog</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$patch</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">@files</span> <span class="o">=</span> <span class="sb">`git show $patch | diffstat -l`</span><span class="p">;</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="s">&quot;git show $patch |&quot;</span><span class="p">)</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;failed to show $patch&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="o">^---</span> <span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="o">.*</span><span class="p">),)</span> <span class="p">{</span>
	    <span class="nb">chomp</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$files</span><span class="p">[</span><span class="nv">$#files</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="nv">$buildlog</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dodie</span> <span class="s">&quot;Can&#39;t open $buildlog&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/^\s*(.*?):.*(warning|error)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$file</span> <span class="p">(</span><span class="nv">@files</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$fullpath</span> <span class="o">=</span> <span class="s">&quot;$builddir/$file&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$file</span> <span class="ow">eq</span> <span class="nv">$err</span> <span class="o">||</span> <span class="nv">$fullpath</span> <span class="ow">eq</span> <span class="nv">$err</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">fail</span> <span class="s">&quot;$file built with warnings&quot;</span> <span class="ow">and</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">apply_min_config</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$outconfig</span> <span class="o">=</span> <span class="s">&quot;$output_config.new&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>remove the space added in the beginning</p></td><td class="code"><div class="highlight"><pre>    <span class="n">doprint</span> <span class="s">&quot;Applying minimum configurations into $output_config.new\n&quot;</span><span class="p">;</span>

    <span class="nb">open</span> <span class="p">(</span><span class="n">OUT</span><span class="p">,</span> <span class="s">&quot;&gt;$outconfig&quot;</span><span class="p">)</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;Can&#39;t create $outconfig&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="nv">$output_config</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="nv">$output_config</span><span class="p">)</span> <span class="ow">or</span>
	    <span class="n">dodie</span> <span class="s">&quot;Failed to open $output_config&quot;</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="sr">/^(# )?(CONFIG_[^\s=]*)/</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$force_config</span><span class="p">{</span><span class="nv">$2</span><span class="p">}));</span>
	    <span class="p">}</span>
	    <span class="k">print</span> <span class="n">OUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nb">close</span> <span class="n">IN</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%force_config</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$force_config{$config}\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="n">OUT</span><span class="p">;</span>

    <span class="n">run_command</span> <span class="s">&quot;mv $outconfig $output_config&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">make_oldconfig</span> <span class="p">{</span>

    <span class="k">my</span> <span class="nv">@force_list</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%force_config</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$#force_list</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">apply_min_config</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">run_command</span> <span class="s">&quot;$make oldnoconfig&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Note if a test is something other than build, then we
will need other manditory options.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">doprint</span> <span class="s">&quot;oldnoconfig failed, trying yes &#39;&#39; | make oldconfig\n&quot;</span><span class="p">;</span>
	<span class="n">run_command</span> <span class="s">&quot;yes &#39;&#39; | $make oldconfig&quot;</span> <span class="ow">or</span>
	    <span class="n">dodie</span> <span class="s">&quot;failed make config oldconfig&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>install still limits some manditory options.</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">load_force_config</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;failed to read $config&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/^(CONFIG[^\s=]*)(\s*=.*)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$force_config</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^# (CONFIG_\S*) is not set/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$force_config</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="n">IN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">build</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$type</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nb">unlink</span> <span class="nv">$buildlog</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>remove whitespace</p></td><td class="code"><div class="highlight"><pre>    <span class="k">my</span> <span class="nv">$save_no_reboot</span> <span class="o">=</span> <span class="nv">$no_reboot</span><span class="p">;</span>
    <span class="nv">$no_reboot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>$@ stores error of eval</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$have_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$pre_build</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="n">run_command</span> <span class="nv">$pre_build</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$ret</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$pre_build_die</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="nv">$pre_build_die</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">dodie</span> <span class="s">&quot;failed to pre_build\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="o">=~</span><span class="sr"> /^useconfig:(.*)/</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">run_command</span> <span class="s">&quot;cp $1 $output_config&quot;</span> <span class="ow">or</span>
	    <span class="n">dodie</span> <span class="s">&quot;could not copy $1 to .config&quot;</span><span class="p">;</span>

	<span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;oldconfig&quot;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Convert variables and replace undefined ones with 0</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&quot;oldconfig&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;oldnoconfig&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>ignore blank lines and comments</p></td><td class="code"><div class="highlight"><pre>	<span class="n">run_command</span> <span class="s">&quot;touch $output_config&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$noclean</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">run_command</span> <span class="s">&quot;mv $output_config $outputdir/config_temp&quot;</span> <span class="ow">or</span>
		<span class="n">dodie</span> <span class="s">&quot;moving .config&quot;</span><span class="p">;</span>

	    <span class="n">run_command</span> <span class="s">&quot;$make mrproper&quot;</span> <span class="ow">or</span> <span class="n">dodie</span> <span class="s">&quot;make mrproper&quot;</span><span class="p">;</span>

	    <span class="n">run_command</span> <span class="s">&quot;mv $outputdir/config_temp $output_config&quot;</span> <span class="ow">or</span>
		<span class="n">dodie</span> <span class="s">&quot;moving config_temp&quot;</span><span class="p">;</span>
	<span class="p">}</span>

    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="o">!</span><span class="nv">$noclean</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">unlink</span> <span class="s">&quot;$output_config&quot;</span><span class="p">;</span>
	<span class="n">run_command</span> <span class="s">&quot;$make mrproper&quot;</span> <span class="ow">or</span>
	    <span class="n">dodie</span> <span class="s">&quot;make mrproper&quot;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>If SKIP is anywhere in the line, the command will be skipped</p></td><td class="code"><div class="highlight"><pre>    <span class="nb">open</span><span class="p">(</span><span class="n">OUT</span><span class="p">,</span> <span class="s">&quot;&gt; $outputdir/localversion&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dodie</span><span class="p">(</span><span class="s">&quot;Can&#39;t make localversion file&quot;</span><span class="p">);</span>
    <span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$localversion\n&quot;</span><span class="p">;</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">OUT</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$minconfig</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">load_force_config</span><span class="p">(</span><span class="nv">$minconfig</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">ne</span> <span class="s">&quot;oldnoconfig&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">run_command</span> <span class="s">&quot;$make $type&quot;</span> <span class="ow">or</span>
	    <span class="n">dodie</span> <span class="s">&quot;failed make config&quot;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>DEFAULT only</p></td><td class="code"><div class="highlight"><pre>    <span class="n">make_oldconfig</span><span class="p">;</span>

    <span class="nv">$redirect</span> <span class="o">=</span> <span class="s">&quot;$buildlog&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$build_ret</span> <span class="o">=</span> <span class="n">run_command</span> <span class="s">&quot;$make $build_options&quot;</span><span class="p">;</span>
    <span class="nb">undef</span> <span class="nv">$redirect</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$post_build</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Clear previous overrides</p></td><td class="code"><div class="highlight"><pre>	<span class="n">get_version</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="n">run_command</span> <span class="nv">$post_build</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$ret</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$post_build_die</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="nv">$post_build_die</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">dodie</span> <span class="s">&quot;failed to post_build\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$build_ret</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>May be a ELSE IF section.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$in_bisect</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$no_reboot</span> <span class="o">=</span> <span class="nv">$save_no_reboot</span><span class="p">;</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fail</span> <span class="s">&quot;failed build&quot;</span> <span class="ow">and</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$no_reboot</span> <span class="o">=</span> <span class="nv">$save_no_reboot</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">halt</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">run_ssh</span> <span class="s">&quot;halt&quot;</span> <span class="ow">or</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$power_off</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$poweroff_after_halt</span><span class="p">))</span> <span class="p">{</span>
	    <span class="nb">sleep</span> <span class="nv">$poweroff_after_halt</span><span class="p">;</span>
	    <span class="n">run_command</span> <span class="s">&quot;$power_off&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>check the path of the config file first</p></td><td class="code"><div class="highlight"><pre>	<span class="n">run_command</span> <span class="s">&quot;$power_off&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">success</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nv">$successes</span><span class="o">++</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$test_name</span><span class="p">))</span> <span class="p">{</span>
	<span class="nv">$name</span> <span class="o">=</span> <span class="s">&quot; ($test_name)&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">doprint</span> <span class="s">&quot;\n\n*******************************************\n&quot;</span><span class="p">;</span>
    <span class="n">doprint</span>     <span class="s">&quot;*******************************************\n&quot;</span><span class="p">;</span>
    <span class="n">doprint</span>     <span class="s">&quot;KTEST RESULT: TEST $i$name SUCCESS!!!!         **\n&quot;</span><span class="p">;</span>
    <span class="n">doprint</span>     <span class="s">&quot;*******************************************\n&quot;</span><span class="p">;</span>
    <span class="n">doprint</span>     <span class="s">&quot;*******************************************\n&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$store_successes</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">save_logs</span> <span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="nv">$store_successes</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">!=</span> <span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;NUM_TESTS&quot;</span><span class="p">}</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">do_not_reboot</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;Reboot and wait $sleep_time seconds\n&quot;</span><span class="p">;</span>
	<span class="n">reboot_to_good</span> <span class="nv">$sleep_time</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">answer_bisect</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;Pass or fail? [p/f]&quot;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$ans</span> <span class="o">=</span> <span class="sr">&lt;STDIN&gt;</span><span class="p">;</span>
	<span class="nb">chomp</span> <span class="nv">$ans</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$ans</span> <span class="ow">eq</span> <span class="s">&quot;p&quot;</span> <span class="o">||</span> <span class="nv">$ans</span> <span class="ow">eq</span> <span class="s">&quot;P&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$ans</span> <span class="ow">eq</span> <span class="s">&quot;f&quot;</span> <span class="o">||</span> <span class="nv">$ans</span> <span class="ow">eq</span> <span class="s">&quot;F&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">print</span> <span class="s">&quot;Please answer &#39;P&#39; or &#39;F&#39;\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">child_run_test</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>process config variables.
Config variables are only active while reading the
config and can be defined anywhere. They also ignore
TEST_START and DEFAULTS, but are skipped if they are in
on of these sections that have SKIP defined.
The save variable can be
defined multiple times and the new one simply overrides
the prevous one.</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$reboot_on_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$poweroff_on_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$die_on_failure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="nv">$redirect</span> <span class="o">=</span> <span class="s">&quot;$testlog&quot;</span><span class="p">;</span>
    <span class="n">run_command</span> <span class="nv">$run_test</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nb">undef</span> <span class="nv">$redirect</span><span class="p">;</span>

    <span class="nb">exit</span> <span class="nv">$failed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$child_done</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">child_finished</span> <span class="p">{</span>
    <span class="nv">$child_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">do_run_test</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$child_pid</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$child_exit</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$full_line</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$bug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">wait_for_monitor</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">doprint</span> <span class="s">&quot;run test $run_test\n&quot;</span><span class="p">;</span>

    <span class="nv">$child_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nv">$SIG</span><span class="p">{</span><span class="n">CHLD</span><span class="p">}</span> <span class="o">=</span> <span class="sx">qw(child_finished)</span><span class="p">;</span>

    <span class="nv">$child_pid</span> <span class="o">=</span> <span class="nb">fork</span><span class="p">;</span>

    <span class="n">child_run_test</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$child_pid</span><span class="p">);</span>

    <span class="nv">$full_line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="k">do</span> <span class="p">{</span>
	<span class="nv">$line</span> <span class="o">=</span> <span class="n">wait_for_input</span><span class="p">(</span><span class="nv">$monitor_fp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$line</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>make sure we have all mandatory configs</p></td><td class="code"><div class="highlight"><pre>	    <span class="nv">$full_line</span> <span class="o">.=</span> <span class="nv">$line</span><span class="p">;</span>
	    <span class="n">doprint</span> <span class="nv">$line</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="nv">$full_line</span> <span class="o">=~</span><span class="sr"> /call trace:/i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$bug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="nv">$full_line</span> <span class="o">=~</span><span class="sr"> /Kernel panic -/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$bug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /\n/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$full_line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$child_done</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$bug</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$failure_start</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$now</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
	    <span class="nv">$line</span> <span class="o">=</span> <span class="n">wait_for_input</span><span class="p">(</span><span class="nv">$monitor_fp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$line</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">doprint</span> <span class="nv">$line</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="nv">$now</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$now</span> <span class="o">-</span> <span class="nv">$failure_start</span> <span class="o">&gt;=</span> <span class="nv">$stop_after_failure</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">last</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$line</span><span class="p">));</span>

	<span class="n">doprint</span> <span class="s">&quot;Detected kernel crash!\n&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>was a test specified?</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">kill</span> <span class="mi">9</span><span class="p">,</span> <span class="nv">$child_pid</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nb">waitpid</span> <span class="nv">$child_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$child_exit</span> <span class="o">=</span> <span class="vg">$?</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$bug</span> <span class="o">&amp;&amp;</span> <span class="nv">$in_bisect</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$bisect_ret_good</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$child_exit</span> <span class="o">==</span> <span class="nv">$bisect_ret_good</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$bisect_ret_skip</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$child_exit</span> <span class="o">==</span> <span class="nv">$bisect_ret_skip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$bisect_ret_abort</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$child_exit</span> <span class="o">==</span> <span class="nv">$bisect_ret_abort</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="s">&quot;test abort&quot;</span> <span class="ow">and</span> <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$bisect_ret_bad</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$child_exit</span> <span class="o">==</span> <span class="nv">$bisect_ret_skip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$bisect_ret_default</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$bisect_ret_default</span> <span class="ow">eq</span> <span class="s">&quot;good&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$bisect_ret_default</span> <span class="ow">eq</span> <span class="s">&quot;bad&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$bisect_ret_default</span> <span class="ow">eq</span> <span class="s">&quot;skip&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$bisect_ret_default</span> <span class="ow">eq</span> <span class="s">&quot;abort&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="s">&quot;unknown default action: $bisect_ret_default&quot;</span>
		    <span class="ow">and</span> <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$bug</span> <span class="o">||</span> <span class="nv">$child_exit</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nv">$in_bisect</span><span class="p">;</span>
	<span class="n">fail</span> <span class="s">&quot;test failed&quot;</span> <span class="ow">and</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">run_git_bisect</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$command</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="n">doprint</span> <span class="s">&quot;$command ... &quot;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$output</span> <span class="o">=</span> <span class="sb">`$command 2&gt;&amp;1`</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="vg">$?</span><span class="p">;</span>

    <span class="n">logit</span> <span class="nv">$output</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;FAILED\n&quot;</span><span class="p">;</span>
	<span class="n">dodie</span> <span class="s">&quot;Failed to git bisect&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">doprint</span> <span class="s">&quot;SUCCESS\n&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$output</span> <span class="o">=~</span> <span class="sr">m/^(Bisecting: .*\(roughly \d+ steps?\))\s+\[([[:xdigit:]]+)\]/</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;$1 [$2]\n&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$output</span> <span class="o">=~</span> <span class="sr">m/^([[:xdigit:]]+) is the first bad commit/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$bisect_bad_commit</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="n">doprint</span> <span class="s">&quot;Found bad commit... $1\n&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>set any defaults</p></td><td class="code"><div class="highlight"><pre>	<span class="k">print</span> <span class="nv">$output</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">bisect_reboot</span> <span class="p">{</span>
    <span class="n">doprint</span> <span class="s">&quot;Reboot and sleep $bisect_sleep_time seconds\n&quot;</span><span class="p">;</span>
    <span class="n">reboot_to_good</span> <span class="nv">$bisect_sleep_time</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>check if there are any stragglers (typos?)</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">run_bisect_test</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$buildtype</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$output</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ret</span><span class="p">;</span>

    <span class="nv">$in_bisect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">build</span> <span class="nv">$buildtype</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">ne</span> <span class="s">&quot;build&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$failed</span> <span class="o">&amp;&amp;</span> <span class="nv">$bisect_skip</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$in_bisect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dodie</span> <span class="s">&quot;Failed on build&quot;</span> <span class="k">if</span> <span class="nv">$failed</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>remove per test labels.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">start_monitor_and_boot</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">ne</span> <span class="s">&quot;boot&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$failed</span> <span class="o">&amp;&amp;</span> <span class="nv">$bisect_skip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end_monitor</span><span class="p">;</span>
		<span class="n">bisect_reboot</span><span class="p">;</span>
		<span class="nv">$in_bisect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">dodie</span> <span class="s">&quot;Failed on boot&quot;</span> <span class="k">if</span> <span class="nv">$failed</span><span class="p">;</span>

	    <span class="n">do_run_test</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">end_monitor</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$failed</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nv">$result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Add space to evaluate the character before $</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">ne</span> <span class="s">&quot;build&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">bisect_reboot</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$in_bisect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">run_bisect</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$type</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$buildtype</span> <span class="o">=</span> <span class="s">&quot;oldconfig&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Append beginning of line</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$minconfig</span><span class="p">))</span> <span class="p">{</span>
	<span class="nv">$buildtype</span> <span class="o">=</span> <span class="s">&quot;useconfig:$minconfig&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$ret</span> <span class="o">=</span> <span class="n">run_bisect_test</span> <span class="nv">$type</span><span class="p">,</span> <span class="nv">$buildtype</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$bisect_manual</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$ret</span> <span class="o">=</span> <span class="n">answer_bisect</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>If the iteration option OPT[$i] exists, then use that.
otherwise see if the default OPT (without [$i]) exists.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$reverse_bisect</span> <span class="o">&amp;&amp;</span> <span class="nv">$ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$ret</span> <span class="o">=</span> <span class="o">!</span><span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;good&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span>  <span class="s">&quot;bad&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$bisect_skip</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;HIT A BAD COMMIT ... SKIPPING\n&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;skip&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">update_bisect_replay</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$tmp_log</span> <span class="o">=</span> <span class="s">&quot;$tmpdir/ktest_bisect_log&quot;</span><span class="p">;</span>
    <span class="n">run_command</span> <span class="s">&quot;git bisect log &gt; $tmp_log&quot;</span> <span class="ow">or</span>
	<span class="nb">die</span> <span class="s">&quot;can&#39;t create bisect log&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$tmp_log</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">bisect</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$result</span><span class="p">;</span>

    <span class="nb">die</span> <span class="s">&quot;BISECT_GOOD[$i] not defined\n&quot;</span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$bisect_good</span><span class="p">));</span>
    <span class="nb">die</span> <span class="s">&quot;BISECT_BAD[$i] not defined\n&quot;</span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$bisect_bad</span><span class="p">));</span>
    <span class="nb">die</span> <span class="s">&quot;BISECT_TYPE[$i] not defined\n&quot;</span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$bisect_type</span><span class="p">));</span>

    <span class="k">my</span> <span class="nv">$good</span> <span class="o">=</span> <span class="nv">$bisect_good</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$bad</span> <span class="o">=</span> <span class="nv">$bisect_bad</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$bisect_type</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$bisect_start</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$replay</span> <span class="o">=</span> <span class="nv">$bisect_replay</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$start_files</span> <span class="o">=</span> <span class="nv">$bisect_files</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$start_files</span><span class="p">))</span> <span class="p">{</span>
	<span class="nv">$start_files</span> <span class="o">=</span> <span class="s">&quot; -- &quot;</span> <span class="o">.</span> <span class="nv">$start_files</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nv">$start_files</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Since an option can evaluate to another option,
keep iterating until we do not evaluate any more
options.</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$good</span> <span class="o">=</span> <span class="n">get_sha1</span><span class="p">(</span><span class="nv">$good</span><span class="p">);</span>
    <span class="nv">$bad</span> <span class="o">=</span> <span class="n">get_sha1</span><span class="p">(</span><span class="nv">$bad</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$bisect_reverse</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$bisect_reverse</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;Performing a reverse bisect (bad is good, good is bad!)\n&quot;</span><span class="p">;</span>
	<span class="nv">$reverse_bisect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nv">$reverse_bisect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Check for recursive evaluations.
100 deep should be more than enough.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&quot;test&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$run_test</span><span class="p">))</span> <span class="p">{</span>
	<span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;boot&quot;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>flush out current monitor
May contain the reboot success line</p></td><td class="code"><div class="highlight"><pre>    <span class="k">my</span> <span class="nv">$bisect_start_file</span> <span class="o">=</span> <span class="s">&quot;$builddir/.git/BISECT_START&quot;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$check</span> <span class="o">=</span> <span class="nv">$bisect_check</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$do_check</span> <span class="o">=</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$check</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$check</span> <span class="ow">ne</span> <span class="s">&quot;0&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$bisect_start_file</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;Bisect in progress found\n&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$do_check</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">print</span> <span class="s">&quot; If you say yes, then no checks of good or bad will be done\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$replay</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">print</span> <span class="s">&quot;** BISECT_REPLAY is defined in config file **&quot;</span><span class="p">;</span>
	    <span class="k">print</span> <span class="s">&quot; Ignore config option and perform new git bisect log?\n&quot;</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">read_ync</span> <span class="s">&quot; (yes, no, or cancel) &quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$replay</span> <span class="o">=</span> <span class="n">update_bisect_replay</span><span class="p">;</span>
		<span class="nv">$do_check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="n">read_yn</span> <span class="s">&quot;read git log and continue?&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$replay</span> <span class="o">=</span> <span class="n">update_bisect_replay</span><span class="p">;</span>
	    <span class="nv">$do_check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$do_check</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>try to reboot normally</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$head</span> <span class="o">=</span> <span class="n">get_sha1</span><span class="p">(</span><span class="s">&quot;HEAD&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$check</span> <span class="ow">ne</span> <span class="s">&quot;good&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">doprint</span> <span class="s">&quot;TESTING BISECT BAD [$bad]\n&quot;</span><span class="p">;</span>
	    <span class="n">run_command</span> <span class="s">&quot;git checkout $bad&quot;</span> <span class="ow">or</span>
		<span class="nb">die</span> <span class="s">&quot;Failed to checkout $bad&quot;</span><span class="p">;</span>

	    <span class="nv">$result</span> <span class="o">=</span> <span class="n">run_bisect</span> <span class="nv">$type</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="ow">ne</span> <span class="s">&quot;bad&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="s">&quot;Tested BISECT_BAD [$bad] and it succeeded&quot;</span> <span class="ow">and</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$check</span> <span class="ow">ne</span> <span class="s">&quot;bad&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">doprint</span> <span class="s">&quot;TESTING BISECT GOOD [$good]\n&quot;</span><span class="p">;</span>
	    <span class="n">run_command</span> <span class="s">&quot;git checkout $good&quot;</span> <span class="ow">or</span>
		<span class="nb">die</span> <span class="s">&quot;Failed to checkout $good&quot;</span><span class="p">;</span>

	    <span class="nv">$result</span> <span class="o">=</span> <span class="n">run_bisect</span> <span class="nv">$type</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="ow">ne</span> <span class="s">&quot;good&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="s">&quot;Tested BISECT_GOOD [$good] and it failed&quot;</span> <span class="ow">and</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>nope? power cycle it.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">run_command</span> <span class="s">&quot;git checkout $head&quot;</span> <span class="ow">or</span>
	    <span class="nb">die</span> <span class="s">&quot;Failed to checkout $head&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">run_command</span> <span class="s">&quot;git bisect start$start_files&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;could not start bisect&quot;</span><span class="p">;</span>

    <span class="n">run_command</span> <span class="s">&quot;git bisect good $good&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;could not set bisect good to $good&quot;</span><span class="p">;</span>

    <span class="n">run_git_bisect</span> <span class="s">&quot;git bisect bad $bad&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;could not set bisect bad to $bad&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$replay</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">run_command</span> <span class="s">&quot;git bisect replay $replay&quot;</span> <span class="ow">or</span>
	    <span class="n">dodie</span> <span class="s">&quot;failed to run replay&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$start</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">run_command</span> <span class="s">&quot;git checkout $start&quot;</span> <span class="ow">or</span>
	    <span class="n">dodie</span> <span class="s">&quot;failed to checkout $start&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$test</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
	<span class="nv">$result</span> <span class="o">=</span> <span class="n">run_bisect</span> <span class="nv">$type</span><span class="p">;</span>
	<span class="nv">$test</span> <span class="o">=</span> <span class="n">run_git_bisect</span> <span class="s">&quot;git bisect $result&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$test</span><span class="p">);</span>

    <span class="n">run_command</span> <span class="s">&quot;git bisect log&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;could not capture git bisect log&quot;</span><span class="p">;</span>

    <span class="n">run_command</span> <span class="s">&quot;git bisect reset&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;could not reset git bisect&quot;</span><span class="p">;</span>

    <span class="n">doprint</span> <span class="s">&quot;Bad commit was [$bisect_bad_commit]\n&quot;</span><span class="p">;</span>

    <span class="n">success</span> <span class="nv">$i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">%config_ignore</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%config_set</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">%config_list</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%null_config</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">%dependency</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">assign_configs</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$hash</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span>
	<span class="ow">or</span> <span class="n">dodie</span> <span class="s">&quot;Failed to read $config&quot;</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/^((CONFIG\S*)=.*)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$</span><span class="p">{</span><span class="nv">$hash</span><span class="p">}{</span><span class="nv">$2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">process_config_ignore</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="n">assign_configs</span> <span class="o">\</span><span class="nv">%config_ignore</span><span class="p">,</span> <span class="nv">$config</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">read_current_config</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$config_ref</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nv">%</span><span class="p">{</span><span class="nv">$config_ref</span><span class="p">}</span> <span class="o">=</span> <span class="p">();</span>
    <span class="nb">undef</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$config_ref</span><span class="p">};</span>

    <span class="k">my</span> <span class="nv">@key</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$config_ref</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$#key</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;did not delete!\n&quot;</span><span class="p">;</span>
	<span class="nb">exit</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="s">&quot;$output_config&quot;</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/^(CONFIG\S+)=(.*)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$</span><span class="p">{</span><span class="nv">$config_ref</span><span class="p">}{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">get_dependencies</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$arr</span> <span class="o">=</span> <span class="nv">$dependency</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$arr</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">();</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">@deps</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$arr</span><span class="p">};</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$dep</span> <span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$arr</span><span class="p">})</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;ADD DEP $dep\n&quot;</span><span class="p">;</span>
	<span class="nv">@deps</span> <span class="o">=</span> <span class="p">(</span><span class="nv">@deps</span><span class="p">,</span> <span class="n">get_dependencies</span> <span class="nv">$dep</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">@deps</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">create_config</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">@configs</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">OUT</span><span class="p">,</span> <span class="s">&quot;&gt;$output_config&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dodie</span> <span class="s">&quot;Can not write to $output_config&quot;</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@configs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$config_set{$config}\n&quot;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">@deps</span> <span class="o">=</span> <span class="n">get_dependencies</span> <span class="nv">$config</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$dep</span> <span class="p">(</span><span class="nv">@deps</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$config_set{$dep}\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%config_ignore</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$config_ignore{$config}\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">OUT</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>read the monitor and wait for the system to calm down</p></td><td class="code"><div class="highlight"><pre>    <span class="n">make_oldconfig</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">compare_configs</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">%a</span><span class="p">,</span> <span class="nv">%b</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$item</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%a</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$b</span><span class="p">{</span><span class="nv">$item</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="k">print</span> <span class="s">&quot;diff $item\n&quot;</span><span class="p">;</span>
	    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nb">delete</span> <span class="nv">$b</span><span class="p">{</span><span class="nv">$item</span><span class="p">};</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">@keys</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%b</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$#keys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;diff2 $keys[0]\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$#keys</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">run_config_bisect_test</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$type</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">run_bisect_test</span> <span class="nv">$type</span><span class="p">,</span> <span class="s">&quot;oldconfig&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">process_passed</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">%configs</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="n">doprint</span> <span class="s">&quot;These configs had no failure: (Enabling them for further compiles)\n&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>no need to reboot for just building.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%configs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$config_list</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="n">doprint</span> <span class="s">&quot; removing $config\n&quot;</span><span class="p">;</span>
	    <span class="nv">$config_ignore</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$config_list</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	    <span class="nb">delete</span> <span class="nv">$config_list</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="n">doprint</span> <span class="s">&quot;config copied to $outputdir/config_good\n&quot;</span><span class="p">;</span>
    <span class="n">run_command</span> <span class="s">&quot;cp -f $output_config $outputdir/config_good&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">process_failed</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="n">doprint</span> <span class="s">&quot;\n\n***************************************\n&quot;</span><span class="p">;</span>
    <span class="n">doprint</span> <span class="s">&quot;Found bad config: $config\n&quot;</span><span class="p">;</span>
    <span class="n">doprint</span> <span class="s">&quot;***************************************\n\n&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">run_config_bisect</span> <span class="p">{</span>

    <span class="k">my</span> <span class="nv">@start_list</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%config_list</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$#start_list</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;No more configs to test!!!\n&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">doprint</span> <span class="s">&quot;***** RUN TEST ***\n&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$config_bisect_type</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">%current_config</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$#start_list</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">doprint</span> <span class="s">&quot;  $count configs to test\n&quot;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$half</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nv">$#start_list</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

    <span class="k">do</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">@tophalf</span> <span class="o">=</span> <span class="nv">@start_list</span><span class="p">[</span><span class="mi">0</span> <span class="o">..</span> <span class="nv">$half</span><span class="p">];</span>

	<span class="n">create_config</span> <span class="nv">@tophalf</span><span class="p">;</span>
	<span class="n">read_current_config</span> <span class="o">\</span><span class="nv">%current_config</span><span class="p">;</span>

	<span class="nv">$count</span> <span class="o">=</span> <span class="nv">$#tophalf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">doprint</span> <span class="s">&quot;Testing $count configs\n&quot;</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>try to read one char at a time</p></td><td class="code"><div class="highlight"><pre>	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@tophalf</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$current_config</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
		<span class="n">logit</span> <span class="s">&quot; $config\n&quot;</span><span class="p">;</span>
		<span class="nv">$found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$found</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>we are not guaranteed to get a full line</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">doprint</span> <span class="s">&quot;Top half produced no set configs, trying bottom half\n&quot;</span><span class="p">;</span>
	    <span class="nv">@tophalf</span> <span class="o">=</span> <span class="nv">@start_list</span><span class="p">[</span><span class="nv">$half</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">..</span> <span class="nv">$#start_list</span><span class="p">];</span>
	    <span class="n">create_config</span> <span class="nv">@tophalf</span><span class="p">;</span>
	    <span class="n">read_current_config</span> <span class="o">\</span><span class="nv">%current_config</span><span class="p">;</span>
	    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@tophalf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$current_config</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
		    <span class="n">logit</span> <span class="s">&quot; $config\n&quot;</span><span class="p">;</span>
		    <span class="nv">$found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">doprint</span> <span class="s">&quot;Failed: Can&#39;t make new config with current configs\n&quot;</span><span class="p">;</span>
		<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@start_list</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">doprint</span> <span class="s">&quot;  CONFIG: $config\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$#tophalf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">doprint</span> <span class="s">&quot;Testing $count configs\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nv">$ret</span> <span class="o">=</span> <span class="n">run_config_bisect_test</span> <span class="nv">$type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$bisect_manual</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$ret</span> <span class="o">=</span> <span class="n">answer_bisect</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$ret</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">process_passed</span> <span class="nv">%current_config</span><span class="p">;</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">doprint</span> <span class="s">&quot;This config had a failure.\n&quot;</span><span class="p">;</span>
	<span class="n">doprint</span> <span class="s">&quot;Removing these configs that were not set in this config:\n&quot;</span><span class="p">;</span>
	<span class="n">doprint</span> <span class="s">&quot;config copied to $outputdir/config_bad\n&quot;</span><span class="p">;</span>
	<span class="n">run_command</span> <span class="s">&quot;cp -f $output_config $outputdir/config_bad&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Detect triple faults by testing the banner</p></td><td class="code"><div class="highlight"><pre>	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%config_list</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$current_config</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
		<span class="n">doprint</span> <span class="s">&quot; removing $config\n&quot;</span><span class="p">;</span>
		<span class="nb">delete</span> <span class="nv">$config_list</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="nv">@start_list</span> <span class="o">=</span> <span class="nv">@tophalf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$#start_list</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">process_failed</span> <span class="nv">$start_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>We already booted into the kernel we are testing,
but now we booted into another kernel?
Consider this a triple fault.</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$half</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nv">$#start_list</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$#start_list</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>should we process modules?</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$bisect_manual</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">process_failed</span> <span class="nv">$start_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">@tophalf</span> <span class="o">=</span> <span class="nv">@start_list</span><span class="p">[</span><span class="mi">0</span> <span class="o">..</span> <span class="mi">0</span><span class="p">];</span>

    <span class="nv">$ret</span> <span class="o">=</span> <span class="n">run_config_bisect_test</span> <span class="nv">$type</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">process_passed</span> <span class="nv">%current_config</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">process_failed</span> <span class="nv">$start_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">config_bisect</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$start_config</span> <span class="o">=</span> <span class="nv">$config_bisect</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$tmpconfig</span> <span class="o">=</span> <span class="s">&quot;$tmpdir/use_config&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$config_bisect_good</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">process_config_ignore</span> <span class="nv">$config_bisect_good</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>would be nice if scp -r did not follow symbolic links</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$minconfig</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>get the release name</p></td><td class="code"><div class="highlight"><pre>	<span class="n">run_command</span> <span class="s">&quot;cp $minconfig $tmpconfig&quot;</span> <span class="ow">or</span>
	    <span class="n">dodie</span> <span class="s">&quot;failed to copy $minconfig to $tmpconfig&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nb">unlink</span> <span class="nv">$tmpconfig</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="nv">$tmpconfig</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">load_force_config</span><span class="p">(</span><span class="nv">$tmpconfig</span><span class="p">);</span>
	<span class="n">process_config_ignore</span> <span class="nv">$tmpconfig</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Make sure the stable kernel has finished booting</p></td><td class="code"><div class="highlight"><pre>    <span class="n">run_command</span> <span class="s">&quot;cp $start_config $output_config&quot;</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;failed to copy $start_config to $output_config&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Read the config file and remove anything that
is in the force_config hash (from minconfig and others)
then add the force config back.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">my</span> <span class="nv">%config_check</span><span class="p">;</span>
    <span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="nv">$output_config</span><span class="p">)</span>
	<span class="ow">or</span> <span class="n">dodie</span> <span class="s">&quot;failed to open $output_config&quot;</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/^((CONFIG\S*)=.*)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$config_check</span><span class="p">{</span><span class="nv">$2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>Perhaps oldnoconfig doesn't exist in this version of the kernel
try a yes '' | oldconfig</p></td><td class="code"><div class="highlight"><pre>    <span class="n">make_oldconfig</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>read a config file and use this to force new configs.</p></td><td class="code"><div class="highlight"><pre>    <span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="nv">$output_config</span><span class="p">)</span>
	<span class="ow">or</span> <span class="n">dodie</span> <span class="s">&quot;Failed to read $start_config&quot;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">%removed_configs</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">%added_configs</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/^((CONFIG\S*)=.*)/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>Failed builds should not reboot the target</p></td><td class="code"><div class="highlight"><pre>	    <span class="nv">$config_set</span><span class="p">{</span><span class="nv">$2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$config_check</span><span class="p">{</span><span class="nv">$2</span><span class="p">}))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$config_ignore</span><span class="p">{</span><span class="nv">$2</span><span class="p">}))</span> <span class="p">{</span>
		    <span class="nv">$removed_configs</span><span class="p">{</span><span class="nv">$2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="nv">$config_list</span><span class="p">{</span><span class="nv">$2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$config_ignore</span><span class="p">{</span><span class="nv">$2</span><span class="p">}))</span> <span class="p">{</span>
		<span class="nv">$added_configs</span><span class="p">{</span><span class="nv">$2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$config_list</span><span class="p">{</span><span class="nv">$2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span>

    <span class="k">my</span> <span class="nv">@confs</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%removed_configs</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$#confs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;Configs overridden by default configs and removed from check:\n&quot;</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@confs</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">doprint</span> <span class="s">&quot; $config\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">@confs</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%added_configs</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$#confs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;Configs appearing in make oldconfig and added:\n&quot;</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@confs</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">doprint</span> <span class="s">&quot; $config\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">%config_test</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$once</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Calculate a new version from here.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">create_config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%config_list</span><span class="p">);</span>
    <span class="n">read_current_config</span> <span class="o">\</span><span class="nv">%config_test</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%config_list</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$config_test</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$once</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$once</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">doprint</span> <span class="s">&quot;Configs not produced by kconfig (will not be checked):\n&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">doprint</span> <span class="s">&quot;  $config\n&quot;</span><span class="p">;</span>
	    <span class="nb">delete</span> <span class="nv">$config_list</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">my</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
	<span class="nv">$ret</span> <span class="o">=</span> <span class="n">run_config_bisect</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$ret</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$ret</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">success</span> <span class="nv">$i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">patchcheck_reboot</span> <span class="p">{</span>
    <span class="n">doprint</span> <span class="s">&quot;Reboot and sleep $patchcheck_sleep_time seconds\n&quot;</span><span class="p">;</span>
    <span class="n">reboot_to_good</span> <span class="nv">$patchcheck_sleep_time</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">patchcheck</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nb">die</span> <span class="s">&quot;PATCHCHECK_START[$i] not defined\n&quot;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$patchcheck_start</span><span class="p">));</span>
    <span class="nb">die</span> <span class="s">&quot;PATCHCHECK_TYPE[$i] not defined\n&quot;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$patchcheck_type</span><span class="p">));</span>

    <span class="k">my</span> <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$patchcheck_start</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$end</span> <span class="o">=</span> <span class="s">&quot;HEAD&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$patchcheck_end</span><span class="p">))</span> <span class="p">{</span>
	<span class="nv">$end</span> <span class="o">=</span> <span class="nv">$patchcheck_end</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>old config can ask questions</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$start</span> <span class="o">=</span> <span class="n">get_sha1</span><span class="p">(</span><span class="nv">$start</span><span class="p">);</span>
    <span class="nv">$end</span> <span class="o">=</span> <span class="n">get_sha1</span><span class="p">(</span><span class="nv">$end</span><span class="p">);</span>

    <span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$patchcheck_type</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>allow for empty configs</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&quot;test&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$run_test</span><span class="p">))</span> <span class="p">{</span>
	<span class="nv">$type</span> <span class="o">=</span> <span class="s">&quot;boot&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="s">&quot;git log --pretty=oneline $end|&quot;</span><span class="p">)</span> <span class="ow">or</span>
	<span class="n">dodie</span> <span class="s">&quot;could not get git list&quot;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">@list</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
	<span class="nv">$list</span><span class="p">[</span><span class="nv">$#list</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
	<span class="k">last</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/^$start/</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$list</span><span class="p">[</span><span class="nv">$#list</span><span class="p">]</span> <span class="o">!~</span> <span class="sr">/^$start/</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fail</span> <span class="s">&quot;SHA1 $start not found&quot;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>add something to distinguish this build</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">@list</span> <span class="o">=</span> <span class="nb">reverse</span> <span class="nv">@list</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$save_clean</span> <span class="o">=</span> <span class="nv">$noclean</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">%ignored_warnings</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$ignore_warnings</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$sha1</span> <span class="p">(</span><span class="nb">split</span> <span class="sr">/\s+/</span><span class="p">,</span> <span class="nv">$ignore_warnings</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$ignored_warnings</span><span class="p">{</span><span class="nv">$sha1</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="nv">$in_patchcheck</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$item</span> <span class="p">(</span><span class="nv">@list</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$sha1</span> <span class="o">=</span> <span class="nv">$item</span><span class="p">;</span>
	<span class="nv">$sha1</span> <span class="o">=~</span> <span class="sr">s/^([[:xdigit:]]+).*/$1/</span><span class="p">;</span>

	<span class="n">doprint</span> <span class="s">&quot;\nProcessing commit $item\n\n&quot;</span><span class="p">;</span>

	<span class="n">run_command</span> <span class="s">&quot;git checkout $sha1&quot;</span> <span class="ow">or</span>
	    <span class="nb">die</span> <span class="s">&quot;Failed to checkout $sha1&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>Run old config regardless, to enforce min configurations</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$item</span> <span class="ow">eq</span> <span class="nv">$list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
	    <span class="nv">$item</span> <span class="ow">eq</span> <span class="nv">$list</span><span class="p">[</span><span class="nv">$#list</span><span class="p">])</span> <span class="p">{</span>
	    <span class="nv">$noclean</span> <span class="o">=</span> <span class="nv">$save_clean</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$noclean</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$minconfig</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">build</span> <span class="s">&quot;useconfig:$minconfig&quot;</span> <span class="ow">or</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>Because a post build may change the kernel version
do it now.</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">build</span> <span class="s">&quot;oldconfig&quot;</span> <span class="ow">or</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$ignored_warnings</span><span class="p">{</span><span class="nv">$sha1</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="n">check_buildlog</span> <span class="nv">$sha1</span> <span class="ow">or</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&quot;build&quot;</span><span class="p">);</span>

	<span class="k">my</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">start_monitor_and_boot</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$failed</span> <span class="o">&amp;&amp;</span> <span class="nv">$type</span> <span class="ow">ne</span> <span class="s">&quot;boot&quot;</span><span class="p">){</span>
	    <span class="n">do_run_test</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">end_monitor</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$failed</span><span class="p">);</span>

	<span class="n">patchcheck_reboot</span><span class="p">;</span>

    <span class="p">}</span>
    <span class="nv">$in_patchcheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">success</span> <span class="nv">$i</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">%depends</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%depcount</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$iflevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@ifdeps</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>bisect may need this to pass</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">%read_kconfigs</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">add_dep</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>nope? the zap it!</p></td><td class="code"><div class="highlight"><pre>    <span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="nv">$dep</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$depends</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
	<span class="nv">$depends</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">.=</span> <span class="s">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$dep</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nv">$depends</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$dep</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>child should have no power</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$depcount</span><span class="p">{</span><span class="nv">$dep</span><span class="p">})</span> <span class="p">{</span>
	<span class="nv">$depcount</span><span class="p">{</span><span class="nv">$dep</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nv">$depcount</span><span class="p">{</span><span class="nv">$dep</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> 
<span class="p">}</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>we are not guaranteed to get a full line</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">read_kconfig</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$kconfig</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$state</span> <span class="o">=</span> <span class="s">&quot;NONE&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$config</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@kconfigs</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$cont</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$kconfig</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;file $kconfig does not exist, skipping\n&quot;</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">KIN</span><span class="p">,</span> <span class="s">&quot;$kconfig&quot;</span><span class="p">)</span>
	<span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Can&#39;t open $kconfig&quot;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;KIN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>kill the child with extreme prejudice</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$cont</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$_</span> <span class="o">=</span> <span class="nv">$line</span> <span class="o">.</span> <span class="s">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$_</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="sr">s/\\$//</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$cont</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
	    <span class="k">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nv">$cont</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>we already logged it, just print it now.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="sr">/^source\s*&quot;(.*)&quot;/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$kconfigs</span><span class="p">[</span><span class="nv">$#kconfigs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>returns 1 on success, 0 on failure, -1 on skip</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="sr">/^\s*(menu)?config\s+(\S+)\s*$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$state</span> <span class="o">=</span> <span class="s">&quot;NEW&quot;</span><span class="p">;</span>
	    <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>

	    <span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$iflevel</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">add_dep</span> <span class="nv">$config</span><span class="p">,</span> <span class="nv">$ifdeps</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
	    <span class="p">}</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Now boot the box</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$state</span> <span class="ow">eq</span> <span class="s">&quot;NEW&quot;</span> <span class="o">&amp;&amp;</span> <span class="sr">/^\s*depends\s+on\s+(.*)$/</span><span class="p">)</span> <span class="p">{</span>

	    <span class="n">add_dep</span> <span class="nv">$config</span><span class="p">,</span> <span class="nv">$1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>reboot the box to a kernel we can ssh to</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$state</span> <span class="ow">eq</span> <span class="s">&quot;NEW&quot;</span> <span class="o">&amp;&amp;</span> <span class="sr">/^\s*select\s+(\S+)/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>We should have a minconfig to use?</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">add_dep</span> <span class="nv">$1</span><span class="p">,</span> <span class="nv">$config</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>Are we looking for where it worked, not failed?</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^if\s+(.*\S)\s*$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">my</span> <span class="nv">$deps</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>convert to true sha1's</p></td><td class="code"><div class="highlight"><pre>	    <span class="nv">$deps</span> <span class="o">=~</span> <span class="sr">s/^[^a-zA-Z0-9_]*//</span><span class="p">;</span>
	    <span class="nv">$deps</span> <span class="o">=~</span> <span class="sr">s/[^a-zA-Z0-9_]*$//</span><span class="p">;</span>

	    <span class="k">my</span> <span class="nv">@deps</span> <span class="o">=</span> <span class="nb">split</span> <span class="sr">/[^a-zA-Z0-9_]+/</span><span class="p">,</span> <span class="nv">$deps</span><span class="p">;</span>

	    <span class="nv">$ifdeps</span><span class="p">[</span><span class="nv">$iflevel</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">join</span> <span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="nv">@deps</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^endif/</span><span class="p">)</span> <span class="p">{</span>

	    <span class="nv">$iflevel</span><span class="o">--</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$iflevel</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>Can't have a test without having a test to run</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*help\s*$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$state</span> <span class="o">=</span> <span class="s">&quot;NONE&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">KIN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>Check if a bisect was running</p></td><td class="code"><div class="highlight"><pre>    <span class="k">foreach</span> <span class="nv">$kconfig</span> <span class="p">(</span><span class="nv">@kconfigs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$read_kconfigs</span><span class="p">{</span><span class="nv">$kconfig</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="nv">$read_kconfigs</span><span class="p">{</span><span class="nv">$kconfig</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">read_kconfig</span><span class="p">(</span><span class="s">&quot;$builddir/$kconfig&quot;</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">read_depends</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>get current HEAD</p></td><td class="code"><div class="highlight"><pre>    <span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="nv">$output_config</span><span class="p">)</span>
	<span class="ow">or</span> <span class="n">dodie</span> <span class="s">&quot;Failed to read $output_config&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$arch</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">Linux</span><span class="o">/</span><span class="p">(</span><span class="o">\</span><span class="n">S</span><span class="o">+</span><span class="p">)</span><span class="o">\</span><span class="n">s</span><span class="o">+\</span><span class="n">S</span><span class="o">+\</span><span class="n">s</span><span class="o">+</span><span class="n">Kernel</span> <span class="n">Configuration</span><span class="p">,)</span> <span class="p">{</span>
	    <span class="nv">$arch</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="k">last</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="n">IN</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$arch</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;Could not find arch from config file\n&quot;</span><span class="p">;</span>
	<span class="n">doprint</span> <span class="s">&quot;no dependencies used\n&quot;</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>checkout where we started</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;i386&quot;</span> <span class="o">||</span> <span class="nv">$arch</span> <span class="ow">eq</span> <span class="s">&quot;x86_64&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$arch</span> <span class="o">=</span> <span class="s">&quot;x86&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arch</span> <span class="o">=~</span><span class="sr"> /^tile/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$arch</span> <span class="o">=</span> <span class="s">&quot;tile&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$kconfig</span> <span class="o">=</span> <span class="s">&quot;$builddir/arch/$arch/Kconfig&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$kconfig</span> <span class="o">&amp;&amp;</span> <span class="nv">$arch</span> <span class="o">=~</span><span class="sr"> /\d$/</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$orig</span> <span class="o">=</span> <span class="nv">$arch</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>exit;</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$arch</span> <span class="o">=~</span> <span class="sr">s/\d*$//</span><span class="p">;</span>
	<span class="nv">$kconfig</span> <span class="o">=</span> <span class="s">&quot;$builddir/arch/$arch/Kconfig&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$kconfig</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">doprint</span> <span class="s">&quot;No idea what arch dir $orig is for\n&quot;</span><span class="p">;</span>
	    <span class="n">doprint</span> <span class="s">&quot;no dependencies used\n&quot;</span><span class="p">;</span>
	    <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">read_kconfig</span><span class="p">(</span><span class="nv">$kconfig</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">read_config_list</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nb">open</span> <span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span>
	<span class="ow">or</span> <span class="n">dodie</span> <span class="s">&quot;Failed to read $config&quot;</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="sr">&lt;IN&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="sr">/^((CONFIG\S*)=.*)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$config_ignore</span><span class="p">{</span><span class="nv">$2</span><span class="p">}))</span> <span class="p">{</span>
		<span class="nv">$config_list</span><span class="p">{</span><span class="nv">$2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="nb">close</span><span class="p">(</span><span class="n">IN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">read_output_config</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="n">assign_configs</span> <span class="o">\</span><span class="nv">%config_ignore</span><span class="p">,</span> <span class="nv">$config</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">make_new_config</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">@configs</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nb">open</span> <span class="p">(</span><span class="n">OUT</span><span class="p">,</span> <span class="s">&quot;&gt;$output_config&quot;</span><span class="p">)</span>
	<span class="ow">or</span> <span class="n">dodie</span> <span class="s">&quot;Failed to write $output_config&quot;</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@configs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$config\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">close</span> <span class="n">OUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">chomp_config</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="nv">$config</span> <span class="o">=~</span> <span class="sr">s/CONFIG_//</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$config</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">get_depends</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$dep</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$kconfig</span> <span class="o">=</span> <span class="n">chomp_config</span> <span class="nv">$dep</span><span class="p">;</span>

    <span class="nv">$dep</span> <span class="o">=</span> <span class="nv">$depends</span><span class="p">{</span><span class="s">&quot;$kconfig&quot;</span><span class="p">};</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Passed! All these configs are part of a good compile.
Add them to the min options.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">my</span> <span class="nv">$valid</span> <span class="o">=</span> <span class="s">&quot;A-Za-z_0-9&quot;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">@configs</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nv">$dep</span> <span class="o">=~</span><span class="sr"> /[$valid]/</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$dep</span> <span class="o">=~</span><span class="sr"> /^[^$valid]*([$valid]+)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">my</span> <span class="nv">$conf</span> <span class="o">=</span> <span class="s">&quot;CONFIG_&quot;</span> <span class="o">.</span> <span class="nv">$1</span><span class="p">;</span>

	    <span class="nv">$configs</span><span class="p">[</span><span class="nv">$#configs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$conf</span><span class="p">;</span>

	    <span class="nv">$dep</span> <span class="o">=~</span> <span class="sr">s/^[^$valid]*[$valid]+//</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span> <span class="s">&quot;this should never happen&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">@configs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">%min_configs</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%keep_configs</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%save_configs</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%processed_configs</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%nochange_config</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">test_this_config</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$found</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>make sure we test something</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$processed_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nb">undef</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$processed_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>try the other half</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$nochange_config</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nb">undef</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$kconfig</span> <span class="o">=</span> <span class="n">chomp_config</span> <span class="nv">$config</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>A config exists in this group that was bad.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$depends</span><span class="p">{</span><span class="s">&quot;$kconfig&quot;</span><span class="p">}))</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">@parents</span> <span class="o">=</span> <span class="n">get_depends</span> <span class="nv">$config</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$parent</span> <span class="p">(</span><span class="nv">@parents</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>remove half the configs we are looking at and see if
they are good.</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$parent</span><span class="p">}));</span>
	    <span class="nv">$found</span> <span class="o">=</span> <span class="n">test_this_config</span><span class="p">(</span><span class="nv">$parent</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$found</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nv">$found</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>we found a single config, try it again unless we are running manually</p></td><td class="code"><div class="highlight"><pre>    <span class="k">my</span> <span class="nv">%configs</span> <span class="o">=</span> <span class="nv">%min_configs</span><span class="p">;</span>
    <span class="nb">delete</span> <span class="nv">$configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
    <span class="n">make_new_config</span> <span class="p">((</span><span class="nb">values</span> <span class="nv">%configs</span><span class="p">),</span> <span class="p">(</span><span class="nb">values</span> <span class="nv">%keep_configs</span><span class="p">));</span>
    <span class="n">make_oldconfig</span><span class="p">;</span>
    <span class="nb">undef</span> <span class="nv">%configs</span><span class="p">;</span>
    <span class="n">assign_configs</span> <span class="o">\</span><span class="nv">%configs</span><span class="p">,</span> <span class="nv">$output_config</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$config</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">}));</span>

    <span class="n">doprint</span> <span class="s">&quot;disabling config $config did not change .config\n&quot;</span><span class="p">;</span>

    <span class="nv">$nochange_config</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">undef</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">make_min_config</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$minconfig_type</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">ne</span> <span class="s">&quot;boot&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$type</span> <span class="ow">ne</span> <span class="s">&quot;test&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fail</span> <span class="s">&quot;Invalid MIN_CONFIG_TYPE &#39;$minconfig_type&#39;\n&quot;</span> <span class="o">.</span>
	    <span class="s">&quot; make_min_config works only with &#39;boot&#39; and &#39;test&#39;\n&quot;</span> <span class="ow">and</span> <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$output_minconfig</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">fail</span> <span class="s">&quot;OUTPUT_MIN_CONFIG not defined&quot;</span> <span class="ow">and</span> <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>Make the file with the bad config and the min config</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="nv">$output_minconfig</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$start_minconfig_defined</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;$output_minconfig exists\n&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$use_output_minconfig</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">read_yn</span> <span class="s">&quot; Use it as minconfig?&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$start_minconfig</span> <span class="o">=</span> <span class="nv">$output_minconfig</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$use_output_minconfig</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">doprint</span> <span class="s">&quot;Using $output_minconfig as MIN_CONFIG\n&quot;</span><span class="p">;</span>
	    <span class="nv">$start_minconfig</span> <span class="o">=</span> <span class="nv">$output_minconfig</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">doprint</span> <span class="s">&quot;Set to still use MIN_CONFIG as starting point\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$start_minconfig</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">fail</span> <span class="s">&quot;START_MIN_CONFIG or MIN_CONFIG not defined&quot;</span> <span class="ow">and</span> <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$temp_config</span> <span class="o">=</span> <span class="s">&quot;$tmpdir/temp_config&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>read the min config for things to ignore</p></td><td class="code"><div class="highlight"><pre>    <span class="k">my</span> <span class="nv">$save_minconfig</span> <span class="o">=</span> <span class="nv">$minconfig</span><span class="p">;</span>
    <span class="nb">undef</span> <span class="nv">$minconfig</span><span class="p">;</span>

    <span class="n">run_command</span> <span class="s">&quot;$make allnoconfig&quot;</span> <span class="ow">or</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">read_depends</span><span class="p">;</span>

    <span class="n">process_config_ignore</span> <span class="nv">$output_config</span><span class="p">;</span>

    <span class="nb">undef</span> <span class="nv">%save_configs</span><span class="p">;</span>
    <span class="nb">undef</span> <span class="nv">%min_configs</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$ignore_config</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>now process the start config</p></td><td class="code"><div class="highlight"><pre>	<span class="sb">`touch $ignore_config`</span><span class="p">;</span>
	<span class="n">assign_configs</span> <span class="o">\</span><span class="nv">%save_configs</span><span class="p">,</span> <span class="nv">$ignore_config</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">%keep_configs</span> <span class="o">=</span> <span class="nv">%save_configs</span><span class="p">;</span>

    <span class="n">doprint</span> <span class="s">&quot;Load initial configs from $start_minconfig\n&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>read directly what we want to check</p></td><td class="code"><div class="highlight"><pre>    <span class="n">assign_configs</span> <span class="o">\</span><span class="nv">%min_configs</span><span class="p">,</span> <span class="nv">$start_minconfig</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">@config_keys</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%min_configs</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>Now run oldconfig with the minconfig</p></td><td class="code"><div class="highlight"><pre>    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@config_keys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$kconfig</span> <span class="o">=</span> <span class="n">chomp_config</span> <span class="nv">$config</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span> <span class="nv">$depcount</span><span class="p">{</span><span class="nv">$kconfig</span><span class="p">})</span> <span class="p">{</span>
		<span class="nv">$depcount</span><span class="p">{</span><span class="nv">$kconfig</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>check to see what we lost (or gained)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@config_keys</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>save off all options</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$keep_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$ignore_config</span><span class="p">;</span>
	    <span class="nv">$file</span> <span class="o">=~</span> <span class="n">s</span><span class="p">,</span><span class="o">.*/</span><span class="p">(</span><span class="o">.*</span><span class="p">?)</span><span class="vg">$,</span><span class="nv">$1</span><span class="p">,;</span>
	    <span class="n">doprint</span> <span class="s">&quot;$config set by $file ... ignored\n&quot;</span><span class="p">;</span>
	    <span class="nb">delete</span> <span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	    <span class="k">next</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>Sometimes kconfig does weird things. We must make sure
that the config we autocreate has everything we need
to test, otherwise we may miss testing configs, or
may not be able to create a new config.
Here we create a config with everything set.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$config_ignore</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$config_ignore</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="ow">ne</span> <span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">})</span> <span class="p">{</span>
		<span class="n">doprint</span> <span class="s">&quot;$config is in allnoconfig as &#39;$config_ignore{$config}&#39;&quot;</span><span class="p">;</span>
		<span class="n">doprint</span> <span class="s">&quot; but it is &#39;$min_configs{$config}&#39; in minconfig .. keeping\n&quot;</span><span class="p">;</span>
		<span class="nv">$keep_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">doprint</span> <span class="s">&quot;$config set by allnoconfig ... ignored\n&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="nb">delete</span> <span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$take_two</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$done</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">my</span> <span class="nv">$config</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$found</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>Get the true sha1's since we can use things like HEAD~3</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">@test_configs</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%min_configs</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>Can't have a test without having a test to run</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">@test_configs</span> <span class="o">=</span> <span class="nb">sort</span>  <span class="p">{</span> <span class="nv">$depcount</span><span class="p">{</span><span class="n">chomp_config</span><span class="p">(</span><span class="nv">$b</span><span class="p">)}</span> <span class="sr">&lt;=&gt;</span> <span class="nv">$depcount</span><span class="p">{</span><span class="n">chomp_config</span><span class="p">(</span><span class="nv">$a</span><span class="p">)}</span> <span class="p">}</span>
			  <span class="nv">@test_configs</span> <span class="p">;</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>go backwards in the list</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$#test_configs</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$nochange_config</span><span class="p">{</span><span class="nv">$test_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]}))</span> <span class="p">{</span>
		<span class="nv">$reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">last</span><span class="p">;</span>
	    <span class="p">}</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>only clean on the first and last patch</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">my</span> <span class="nv">$config</span> <span class="o">=</span> <span class="nb">shift</span> <span class="nv">@test_configs</span><span class="p">;</span>
	    <span class="nb">push</span> <span class="nv">@test_configs</span><span class="p">,</span> <span class="nv">$config</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>?? no config to use?</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$reset</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nb">undef</span> <span class="nv">%nochange_config</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nb">undef</span> <span class="nv">%processed_configs</span><span class="p">;</span>

	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@test_configs</span><span class="p">)</span> <span class="p">{</span>

	    <span class="nv">$found</span> <span class="o">=</span> <span class="n">test_this_config</span> <span class="nv">$config</span><span class="p">;</span>

	    <span class="k">last</span> <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$found</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>prevent recursion</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$found</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>$config depends on $dep</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$take_two</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">undef</span> <span class="nv">%nochange_config</span><span class="p">;</span>
		<span class="nv">$take_two</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">next</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">doprint</span> <span class="s">&quot;No more configs found that we can disable\n&quot;</span><span class="p">;</span>
	    <span class="nv">$done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="k">last</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nv">$take_two</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nv">$config</span> <span class="o">=</span> <span class="nv">$found</span><span class="p">;</span>

	<span class="n">doprint</span> <span class="s">&quot;Test with $config disabled\n&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>record the number of configs depending on $dep</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$in_bisect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">my</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">build</span> <span class="s">&quot;oldconfig&quot;</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start_monitor_and_boot</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&quot;test&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$failed</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">do_run_test</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">end_monitor</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nv">$in_bisect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$failed</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">doprint</span> <span class="s">&quot;$min_configs{$config} is needed to boot the box... keeping\n&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>taken from streamline_config.pl</p></td><td class="code"><div class="highlight"><pre>	    <span class="nv">$keep_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	    <span class="nv">$save_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
	    <span class="nb">delete</span> <span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>Make sure that lines ending with \ continue</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$ignore_config</span><span class="p">))</span> <span class="p">{</span>
		<span class="nb">open</span> <span class="p">(</span><span class="n">OUT</span><span class="p">,</span> <span class="s">&quot;&gt;$temp_config&quot;</span><span class="p">)</span>
		    <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Can&#39;t write to $temp_config&quot;</span><span class="p">;</span>
		<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%save_configs</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$save_configs{$config}\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nb">close</span> <span class="n">OUT</span><span class="p">;</span>
		<span class="n">run_command</span> <span class="s">&quot;mv $temp_config $ignore_config&quot;</span> <span class="ow">or</span>
		    <span class="n">dodie</span> <span class="s">&quot;failed to copy update to $ignore_config&quot;</span><span class="p">;</span>
	    <span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>collect any Kconfig sources</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">doprint</span> <span class="s">&quot;$config is not needed, disabling\n&quot;</span><span class="p">;</span>

	    <span class="nb">delete</span> <span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>configs found</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">my</span> <span class="nv">%configs</span><span class="p">;</span>
	    <span class="n">assign_configs</span> <span class="o">\</span><span class="nv">%configs</span><span class="p">,</span> <span class="nv">$output_config</span><span class="p">;</span>
	    <span class="k">my</span> <span class="nv">@config_keys</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%min_configs</span><span class="p">;</span>
	    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@config_keys</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">}))</span> <span class="p">{</span>
		    <span class="n">doprint</span> <span class="s">&quot;$config is not set, disabling\n&quot;</span><span class="p">;</span>
		    <span class="nb">delete</span> <span class="nv">$min_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">};</span>
		<span class="p">}</span>
	    <span class="p">}</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>collect the depends for the config</p></td><td class="code"><div class="highlight"><pre>	    <span class="nb">open</span> <span class="p">(</span><span class="n">OUT</span><span class="p">,</span> <span class="s">&quot;&gt;$temp_config&quot;</span><span class="p">)</span>
		<span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Can&#39;t write to $temp_config&quot;</span><span class="p">;</span>
	    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%keep_configs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$keep_configs{$config}\n&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%min_configs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$min_configs{$config}\n&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="nb">close</span> <span class="n">OUT</span><span class="p">;</span>

	    <span class="n">run_command</span> <span class="s">&quot;mv $temp_config $output_minconfig&quot;</span> <span class="ow">or</span>
		<span class="n">dodie</span> <span class="s">&quot;failed to copy update to $output_minconfig&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">doprint</span> <span class="s">&quot;Reboot and wait $sleep_time seconds\n&quot;</span><span class="p">;</span>
	<span class="n">reboot_to_good</span> <span class="nv">$sleep_time</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">success</span> <span class="nv">$i</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$#ARGV</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;ktest.pl version: $VERSION\n   usage: ktest.pl config-file\n&quot;</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$#ARGV</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$ktest_config</span> <span class="o">=</span> <span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$ktest_config</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="s">&quot;$ktest_config does not exist.\n&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_yn</span> <span class="s">&quot;Create it?&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$ktest_config</span> <span class="o">=</span> <span class="s">&quot;ktest.conf&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$ktest_config</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$newconfig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">get_test_case</span><span class="p">;</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">OUT</span><span class="p">,</span> <span class="s">&quot;&gt;$ktest_config&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Can not create $ktest_config&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="n">OUT</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;EOF&quot;</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>Get the configs that select this config</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>selected by depends on config</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>Check for if statements</p></td><td class="code"><div class="highlight"><pre><span class="n">THIS_DIR</span> <span class="p">:</span><span class="o">=</span> <span class="nv">$variable</span><span class="p">{</span><span class="s">&quot;PWD&quot;</span><span class="p">}</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>remove beginning and ending non text</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST_START</span>
<span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="nv">$default</span><span class="p">{</span><span class="s">&quot;TEST_TYPE&quot;</span><span class="p">}</span>

<span class="n">DEFAULTS</span>
<span class="n">EOF</span>
<span class="p">;</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">OUT</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">read_config</span> <span class="nv">$ktest_config</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;LOG_FILE&quot;</span><span class="p">}))</span> <span class="p">{</span>
    <span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;LOG_FILE&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="n">eval_option</span><span class="p">(</span><span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;LOG_FILE&quot;</span><span class="p">},</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>stop on "help"</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">@new_configs</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%entered_configs</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$#new_configs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;\nAppending entered in configs to $ktest_config\n&quot;</span><span class="p">;</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">OUT</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;$ktest_config&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;Can not append to $ktest_config&quot;</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$config</span> <span class="p">(</span><span class="nv">@new_configs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="n">OUT</span> <span class="s">&quot;$config = $entered_configs{$config}\n&quot;</span><span class="p">;</span>
	<span class="nv">$opt</span><span class="p">{</span><span class="nv">$config</span><span class="p">}</span> <span class="o">=</span> <span class="n">process_variables</span><span class="p">(</span><span class="nv">$entered_configs</span><span class="p">{</span><span class="nv">$config</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;CLEAR_LOG&quot;</span><span class="p">}</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;LOG_FILE&quot;</span><span class="p">}))</span> <span class="p">{</span>
    <span class="nb">unlink</span> <span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;LOG_FILE&quot;</span><span class="p">};</span>
<span class="p">}</span>

<span class="n">doprint</span> <span class="s">&quot;\n\nSTARTING AUTOMATED TESTS\n\n&quot;</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="k">my</span> <span class="nv">$repeat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;NUM_TESTS&quot;</span><span class="p">};</span> <span class="nv">$i</span> <span class="o">+=</span> <span class="nv">$repeat</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;DEFAULT OPTIONS:\n&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">doprint</span> <span class="s">&quot;\nTEST $i OPTIONS&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$repeat_tests</span><span class="p">{</span><span class="nv">$i</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="nv">$repeat</span> <span class="o">=</span> <span class="nv">$repeat_tests</span><span class="p">{</span><span class="nv">$i</span><span class="p">};</span>
	    <span class="n">doprint</span> <span class="s">&quot; ITERATE $repeat&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">doprint</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$option</span> <span class="p">(</span><span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%opt</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$option</span> <span class="o">=~</span><span class="sr"> /\[(\d+)\]$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">!=</span> <span class="nv">$1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">doprint</span> <span class="s">&quot;$option = $opt{$option}\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">__set_test_option</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$option</span> <span class="o">=</span> <span class="s">&quot;$name\[$i\]&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opt</span><span class="p">{</span><span class="nv">$option</span><span class="p">}))</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nv">$opt</span><span class="p">{</span><span class="nv">$option</span><span class="p">};</span>
    <span class="p">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$test</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%repeat_tests</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&gt;=</span> <span class="nv">$test</span> <span class="o">&amp;&amp;</span>
	    <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$test</span> <span class="o">+</span> <span class="nv">$repeat_tests</span><span class="p">{</span><span class="nv">$test</span><span class="p">})</span> <span class="p">{</span>
	    <span class="nv">$option</span> <span class="o">=</span> <span class="s">&quot;$name\[$test\]&quot;</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opt</span><span class="p">{</span><span class="nv">$option</span><span class="p">}))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nv">$opt</span><span class="p">{</span><span class="nv">$option</span><span class="p">};</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$opt</span><span class="p">{</span><span class="nv">$name</span><span class="p">}))</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nv">$opt</span><span class="p">{</span><span class="nv">$name</span><span class="p">};</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">undef</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">set_test_option</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$i</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$option</span> <span class="o">=</span> <span class="n">__set_test_option</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$i</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$option</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$option</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">eval_option</span><span class="p">(</span><span class="nv">$option</span><span class="p">,</span> <span class="nv">$i</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>read in any configs that were found.</p></td><td class="code"><div class="highlight"><pre><span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;NUM_TESTS&quot;</span><span class="p">};</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>find out which arch this is by the kconfig file</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">$no_reboot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$reboot_success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nv">$have_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nv">$iteration</span> <span class="o">=</span> <span class="nv">$i</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$makecmd</span> <span class="o">=</span> <span class="n">set_test_option</span><span class="p">(</span><span class="s">&quot;MAKE_CMD&quot;</span><span class="p">,</span> <span class="nv">$i</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>arch is really the subarch, we need to know
what directory to look at.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$opt</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%option_map</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$</span><span class="p">{</span><span class="nv">$option_map</span><span class="p">{</span><span class="nv">$opt</span><span class="p">}}</span> <span class="o">=</span> <span class="n">set_test_option</span><span class="p">(</span><span class="nv">$opt</span><span class="p">,</span> <span class="nv">$i</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$start_minconfig_defined</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$start_minconfig</span><span class="p">))</span> <span class="p">{</span>
	<span class="nv">$start_minconfig_defined</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nv">$start_minconfig</span> <span class="o">=</span> <span class="nv">$minconfig</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nb">chdir</span> <span class="nv">$builddir</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;can&#39;t change directory to $builddir&quot;</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$dir</span> <span class="p">(</span><span class="nv">$tmpdir</span><span class="p">,</span> <span class="nv">$outputdir</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!-</span><span class="n">d</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">mkpath</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="ow">or</span>
		<span class="nb">die</span> <span class="s">&quot;can&#39;t create $dir&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="nv">$ENV</span><span class="p">{</span><span class="s">&quot;SSH_USER&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$ssh_user</span><span class="p">;</span>
    <span class="nv">$ENV</span><span class="p">{</span><span class="s">&quot;MACHINE&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$machine</span><span class="p">;</span>

    <span class="nv">$buildlog</span> <span class="o">=</span> <span class="s">&quot;$tmpdir/buildlog-$machine&quot;</span><span class="p">;</span>
    <span class="nv">$testlog</span> <span class="o">=</span> <span class="s">&quot;$tmpdir/testlog-$machine&quot;</span><span class="p">;</span>
    <span class="nv">$dmesg</span> <span class="o">=</span> <span class="s">&quot;$tmpdir/dmesg-$machine&quot;</span><span class="p">;</span>
    <span class="nv">$make</span> <span class="o">=</span> <span class="s">&quot;$makecmd O=$outputdir&quot;</span><span class="p">;</span>
    <span class="nv">$output_config</span> <span class="o">=</span> <span class="s">&quot;$outputdir/.config&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$buildonly</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$target</span> <span class="o">=</span> <span class="s">&quot;$ssh_user\@$machine&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$reboot_type</span> <span class="ow">eq</span> <span class="s">&quot;grub&quot;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">dodie</span> <span class="s">&quot;GRUB_MENU not defined&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$grub_menu</span><span class="p">));</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$run_type</span> <span class="o">=</span> <span class="nv">$build_type</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">eq</span> <span class="s">&quot;patchcheck&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$run_type</span> <span class="o">=</span> <span class="nv">$patchcheck_type</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">eq</span> <span class="s">&quot;bisect&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$run_type</span> <span class="o">=</span> <span class="nv">$bisect_type</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">eq</span> <span class="s">&quot;config_bisect&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$run_type</span> <span class="o">=</span> <span class="nv">$config_bisect_type</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">eq</span> <span class="s">&quot;make_min_config&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$run_type</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>some subarchs have numbers, truncate them</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$run_type</span><span class="p">))</span> <span class="p">{</span>
	<span class="nv">$run_type</span> <span class="o">=</span> <span class="s">&quot;ERROR&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$installme</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="nv">$installme</span> <span class="o">=</span> <span class="s">&quot; no_install&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$no_install</span><span class="p">);</span>

    <span class="n">doprint</span> <span class="s">&quot;\n\n&quot;</span><span class="p">;</span>
    <span class="n">doprint</span> <span class="s">&quot;RUNNING TEST $i of $opt{NUM_TESTS} with option $test_type $run_type$installme\n\n&quot;</span><span class="p">;</span>

    <span class="nb">unlink</span> <span class="nv">$dmesg</span><span class="p">;</span>
    <span class="nb">unlink</span> <span class="nv">$buildlog</span><span class="p">;</span>
    <span class="nb">unlink</span> <span class="nv">$testlog</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$addconfig</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$min</span> <span class="o">=</span> <span class="nv">$minconfig</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$minconfig</span><span class="p">))</span> <span class="p">{</span>
	    <span class="nv">$min</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">run_command</span> <span class="s">&quot;cat $addconfig $min &gt; $tmpdir/add_config&quot;</span> <span class="ow">or</span>
	    <span class="n">dodie</span> <span class="s">&quot;Failed to create temp config&quot;</span><span class="p">;</span>
	<span class="nv">$minconfig</span> <span class="o">=</span> <span class="s">&quot;$tmpdir/add_config&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$checkout</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">run_command</span> <span class="s">&quot;git checkout $checkout&quot;</span> <span class="ow">or</span>
	    <span class="nb">die</span> <span class="s">&quot;failed to checkout $checkout&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$no_reboot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>the dep string we have saves the dependencies as they
were found, including expressions like ! &amp;&amp; ||. We
want to split this out into just an array of configs.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$reboot_on_success</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$reboot_success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">eq</span> <span class="s">&quot;bisect&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">bisect</span> <span class="nv">$i</span><span class="p">;</span>
	<span class="k">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">eq</span> <span class="s">&quot;config_bisect&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">config_bisect</span> <span class="nv">$i</span><span class="p">;</span>
	<span class="k">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">eq</span> <span class="s">&quot;patchcheck&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">patchcheck</span> <span class="nv">$i</span><span class="p">;</span>
	<span class="k">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">eq</span> <span class="s">&quot;make_min_config&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">make_min_config</span> <span class="nv">$i</span><span class="p">;</span>
	<span class="k">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$build_type</span> <span class="ow">ne</span> <span class="s">&quot;nobuild&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">build</span> <span class="nv">$build_type</span> <span class="ow">or</span> <span class="k">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">eq</span> <span class="s">&quot;install&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">get_version</span><span class="p">;</span>
	<span class="n">install</span><span class="p">;</span>
	<span class="n">success</span> <span class="nv">$i</span><span class="p">;</span>
	<span class="k">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$test_type</span> <span class="ow">ne</span> <span class="s">&quot;build&quot;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">start_monitor_and_boot</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$failed</span> <span class="o">&amp;&amp;</span> <span class="nv">$test_type</span> <span class="ow">ne</span> <span class="s">&quot;boot&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$run_test</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">do_run_test</span> <span class="ow">or</span> <span class="nv">$failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">end_monitor</span><span class="p">;</span>
	<span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$failed</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">success</span> <span class="nv">$i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;POWEROFF_ON_SUCCESS&quot;</span><span class="p">})</span> <span class="p">{</span>
    <span class="n">halt</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$opt</span><span class="p">{</span><span class="s">&quot;REBOOT_ON_SUCCESS&quot;</span><span class="p">}</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">do_not_reboot</span> <span class="o">&amp;&amp;</span> <span class="nv">$reboot_success</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">reboot_to_good</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$switch_to_good</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>if we already processed this config, skip it</p></td><td class="code"><div class="highlight"><pre>    <span class="n">run_command</span> <span class="nv">$switch_to_good</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">doprint</span> <span class="s">&quot;\n    $successes of $opt{NUM_TESTS} tests were successful\n\n&quot;</span><span class="p">;</span>

<span class="nb">exit</span> <span class="mi">0</span><span class="p">;</span>

</pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>if this config failed during this round, skip it</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>Test dependencies first</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>if the parent is in the min config, check it first</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>Remove this config from the list of configs
do a make oldnoconfig and then read the resulting
.config to make sure it is missing the config that
we had before</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>If output<em>minconfig exists, and the start</em>minconfig
came from min_config, than ask if we should use
that instead.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>First things first. We build an allnoconfig to find
out what the defaults are that we can't touch.
Some are selections, but we really can't handle selections.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>make sure the file exists</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>Look at the current min configs, and save off all the
ones that were set via the allnoconfig</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>All configs need a depcount</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>Remove anything that was set by the make allnoconfig
we shouldn't need them as they get set for us anyway.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div><p>Remove anything in the ignore_config</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>But make sure the settings are the same. If a min config
sets a selection, we do not want to get rid of it if
it is not the same as what we have. Just move it into
the keep configs.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>Now disable each config one by one and do a make oldconfig
till we find a config that changes our list.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>Sort keys by who is most dependent on</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-133"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-133">&#182;</a></div><p>Put configs that did not modify the config at the end.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-134"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-134">&#182;</a></div><p>This config didn't change the .config last time.
Place it at the end</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-135"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-135">&#182;</a></div><p>if every test config has failed to modify the .config file
in the past, then reset and start over.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-136"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-136">&#182;</a></div><p>oh well, try another config</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-137"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-137">&#182;</a></div><p>we could have failed due to the nochange_config hash
reset and try again</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-138"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-138">&#182;</a></div><p>set in_bisect to keep build and monitor from dieing</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-139"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-139">&#182;</a></div><p>this config is needed, add it to the ignore list.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-140"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-140">&#182;</a></div><p>update new ignore configs</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-141"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-141">&#182;</a></div><p>We booted without this config, remove it from the minconfigs.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-142"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-142">&#182;</a></div><p>Also disable anything that is not enabled in this config</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-143"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-143">&#182;</a></div><p>Save off all the current mandidory configs</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-144"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-144">&#182;</a></div><p>Generated by ktest.pl</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-145"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-145">&#182;</a></div><p>PWD is a ktest.pl variable that will result in the process working
directory that ktest.pl is executed in.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-146"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-146">&#182;</a></div><p>THIS_DIR is automatically assigned the PWD of the path that generated
the config file. It is best to use this variable when assigning other
directory paths within this directory. This allows you to easily
move the test cases to other locations or to other machines.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-147"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-147">&#182;</a></div><p>Define each test with TEST_START
The config options below it will override the defaults</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-148"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-148">&#182;</a></div><p>Append any configs entered in manually to the config file.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-149"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-149">&#182;</a></div><p>First we need to do is the builds</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-150"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-150">&#182;</a></div><p>Do not reboot on failing test options</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-151"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-151">&#182;</a></div><p>Load all the options into their mapped variable names</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-152"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-152">&#182;</a></div><p>mistake in config file?</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-153"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-153">&#182;</a></div><p>A test may opt to not reboot the box</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-154"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-154">&#182;</a></div><p>still need to get to the good kernel</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
