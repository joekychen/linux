<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › testing › selftests › mqueue › mq_open_tests.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mq_open_tests.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This application is Copyright 2012 Red Hat, Inc.</span>
<span class="cm"> *	Doug Ledford &lt;dledford@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * mq_open_tests is free software: you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation, version 3.</span>
<span class="cm"> *</span>
<span class="cm"> * mq_open_tests is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * For the full text of the license, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * mq_open_tests.c</span>
<span class="cm"> *   Tests the various situations that should either succeed or fail to</span>
<span class="cm"> *   open a posix message queue and then reports whether or not they</span>
<span class="cm"> *   did as they were supposed to.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;limits.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/time.h&gt;</span>
<span class="cp">#include &lt;sys/resource.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;mqueue.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">usage</span> <span class="o">=</span>
<span class="s">&quot;Usage:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  %s path</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	path	Path name of the message queue to create</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	Note: this program must be run as root in order to enable all tests</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">DEF_MSGS</span> <span class="o">=</span> <span class="s">&quot;/proc/sys/fs/mqueue/msg_default&quot;</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">DEF_MSGSIZE</span> <span class="o">=</span> <span class="s">&quot;/proc/sys/fs/mqueue/msgsize_default&quot;</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">MAX_MSGS</span> <span class="o">=</span> <span class="s">&quot;/proc/sys/fs/mqueue/msg_max&quot;</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">MAX_MSGSIZE</span> <span class="o">=</span> <span class="s">&quot;/proc/sys/fs/mqueue/msgsize_max&quot;</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">default_settings</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rlimit</span> <span class="n">saved_limits</span><span class="p">,</span> <span class="n">cur_limits</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">saved_def_msgs</span><span class="p">,</span> <span class="n">saved_def_msgsize</span><span class="p">,</span> <span class="n">saved_max_msgs</span><span class="p">,</span> <span class="n">saved_max_msgsize</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">cur_def_msgs</span><span class="p">,</span> <span class="n">cur_def_msgsize</span><span class="p">,</span> <span class="n">cur_max_msgs</span><span class="p">,</span> <span class="n">cur_max_msgsize</span><span class="p">;</span>
<span class="kt">FILE</span> <span class="o">*</span><span class="n">def_msgs</span><span class="p">,</span> <span class="o">*</span><span class="n">def_msgsize</span><span class="p">,</span> <span class="o">*</span><span class="n">max_msgs</span><span class="p">,</span> <span class="o">*</span><span class="n">max_msgsize</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">queue_path</span><span class="p">;</span>
<span class="n">mqd_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">shutdown</span><span class="p">(</span><span class="kt">int</span> <span class="n">exit_val</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_cause</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line_no</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">get</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">getr</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rlimit</span> <span class="o">*</span><span class="n">rlim</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">setr</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rlimit</span> <span class="o">*</span><span class="n">rlim</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">validate_current_settings</span><span class="p">();</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">test_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">result</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">test_queue_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">result</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rewind</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fprintf</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">perror</span><span class="p">(</span><span class="n">err_msg</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">shutdown</span><span class="p">(</span><span class="kt">int</span> <span class="n">exit_val</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_cause</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">in_shutdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* In case we get called recursively by a set() call below */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_shutdown</span><span class="o">++</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mq_close</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;mq_close() during shutdown&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_path</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Be silent if this fails, if we cleaned up already it&#39;s</span>
<span class="cm">		 * expected to fail</span>
<span class="cm">		 */</span>
		<span class="n">mq_unlink</span><span class="p">(</span><span class="n">queue_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_settings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saved_def_msgs</span><span class="p">)</span>
			<span class="n">__set</span><span class="p">(</span><span class="n">def_msgs</span><span class="p">,</span> <span class="n">saved_def_msgs</span><span class="p">,</span>
			      <span class="s">&quot;failed to restore saved_def_msgs&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saved_def_msgsize</span><span class="p">)</span>
			<span class="n">__set</span><span class="p">(</span><span class="n">def_msgsize</span><span class="p">,</span> <span class="n">saved_def_msgsize</span><span class="p">,</span>
			      <span class="s">&quot;failed to restore saved_def_msgsize&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_max_msgs</span><span class="p">)</span>
		<span class="n">__set</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">,</span> <span class="n">saved_max_msgs</span><span class="p">,</span>
		      <span class="s">&quot;failed to restore saved_max_msgs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_max_msgsize</span><span class="p">)</span>
		<span class="n">__set</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">,</span> <span class="n">saved_max_msgsize</span><span class="p">,</span>
		      <span class="s">&quot;failed to restore saved_max_msgsize&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exit_val</span><span class="p">)</span>
		<span class="n">error</span><span class="p">(</span><span class="n">exit_val</span><span class="p">,</span> <span class="n">errno</span><span class="p">,</span> <span class="s">&quot;%s at %d&quot;</span><span class="p">,</span> <span class="n">err_cause</span><span class="p">,</span> <span class="n">line_no</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">rewind</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Error reading /proc entry&quot;</span><span class="p">,</span> <span class="n">__LINE__</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">;</span>

	<span class="n">rewind</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fprintf</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shutdown</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Failed writing to /proc file&quot;</span><span class="p">,</span>
				<span class="n">__LINE__</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">new_value</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shutdown</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;We didn&#39;t get what we wrote to /proc back&quot;</span><span class="p">,</span>
				<span class="n">__LINE__</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">getr</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rlimit</span> <span class="o">*</span><span class="n">rlim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">rlim</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;getrlimit()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">setr</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rlimit</span> <span class="o">*</span><span class="n">rlim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">rlim</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;setrlimit()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">validate_current_settings</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rlim_needed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Current rlimit value for POSIX message queue bytes is &quot;</span>
		       <span class="s">&quot;unreasonably low,</span><span class="se">\n</span><span class="s">increasing.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
		<span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">;</span>
		<span class="n">setr</span><span class="p">(</span><span class="n">RLIMIT_MSGQUEUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_limits</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">default_settings</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rlim_needed</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_def_msgs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cur_def_msgsize</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
						    <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rlim_needed</span> <span class="o">&gt;</span> <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Temporarily lowering default queue parameters &quot;</span>
			       <span class="s">&quot;to something that will work</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;with the current rlimit values.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set</span><span class="p">(</span><span class="n">def_msgs</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">cur_def_msgs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">set</span><span class="p">(</span><span class="n">def_msgsize</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
			<span class="n">cur_def_msgsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rlim_needed</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_max_msgs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cur_max_msgsize</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
						    <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rlim_needed</span> <span class="o">&gt;</span> <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Temporarily lowering maximum queue parameters &quot;</span>
			       <span class="s">&quot;to something that will work</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;with the current rlimit values in case this is &quot;</span>
			       <span class="s">&quot;a kernel that ties the default</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;queue parameters to the maximum queue &quot;</span>
			       <span class="s">&quot;parameters.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">cur_max_msgs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">set</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
			<span class="n">cur_max_msgsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * test_queue - Test opening a queue, shutdown if we fail.  This should</span>
<span class="cm"> * only be called in situations that should never fail.  We clean up</span>
<span class="cm"> * after ourselves and return the queue attributes in *result.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">test_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_EXCL</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">perms</span> <span class="o">=</span> <span class="n">DEFFILEMODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">queue</span> <span class="o">=</span> <span class="n">mq_open</span><span class="p">(</span><span class="n">queue_path</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">perms</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mq_open()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq_getattr</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mq_getattr()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq_close</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mq_close()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq_unlink</span><span class="p">(</span><span class="n">queue_path</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mq_unlink()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Same as test_queue above, but failure is not fatal.</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * 0 - Failed to create a queue</span>
<span class="cm"> * 1 - Created a queue, attributes in *result</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">test_queue_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_EXCL</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">perms</span> <span class="o">=</span> <span class="n">DEFFILEMODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">queue</span> <span class="o">=</span> <span class="n">mq_open</span><span class="p">(</span><span class="n">queue_path</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">perms</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq_getattr</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mq_getattr()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq_close</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mq_close()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq_unlink</span><span class="p">(</span><span class="n">queue_path</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mq_unlink()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mq_attr</span> <span class="n">attr</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Must pass a valid queue name</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Although we can create a msg queue with a non-absolute path name,</span>
<span class="cm">	 * unlink will fail.  So, if the name doesn&#39;t start with a /, add one</span>
<span class="cm">	 * when we save it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
		<span class="n">queue_path</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">queue_path</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_path</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;malloc()&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">queue_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>
		<span class="n">queue_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">queue_path</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Not running as root, but almost all tests &quot;</span>
			<span class="s">&quot;require root in order to modify</span><span class="se">\n</span><span class="s">system settings.  &quot;</span>
			<span class="s">&quot;Exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Find out what files there are for us to make tweaks in */</span>
	<span class="n">def_msgs</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">DEF_MSGS</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">);</span>
	<span class="n">def_msgsize</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">DEF_MSGSIZE</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">);</span>
	<span class="n">max_msgs</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">MAX_MSGS</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">);</span>
	<span class="n">max_msgsize</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">MAX_MSGSIZE</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_msgs</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Failed to open msg_max&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_msgsize</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Failed to open msgsize_max&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_msgs</span> <span class="o">||</span> <span class="n">def_msgsize</span><span class="p">)</span>
		<span class="n">default_settings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Load up the current system values for everything we can */</span>
	<span class="n">getr</span><span class="p">(</span><span class="n">RLIMIT_MSGQUEUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_limits</span><span class="p">);</span>
	<span class="n">cur_limits</span> <span class="o">=</span> <span class="n">saved_limits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_settings</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_def_msgs</span> <span class="o">=</span> <span class="n">cur_def_msgs</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">def_msgs</span><span class="p">);</span>
		<span class="n">saved_def_msgsize</span> <span class="o">=</span> <span class="n">cur_def_msgsize</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">def_msgsize</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">saved_max_msgs</span> <span class="o">=</span> <span class="n">cur_max_msgs</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">);</span>
	<span class="n">saved_max_msgsize</span> <span class="o">=</span> <span class="n">cur_max_msgsize</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">);</span>

	<span class="cm">/* Tell the user our initial state */</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Initial system state:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Using queue path:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">queue_path</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(soft):</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_limits</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(hard):</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_limits</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Maximum Message Size:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_max_msgsize</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Maximum Queue Size:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_max_msgs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_settings</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Default Message Size:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_def_msgsize</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Default Queue Size:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_def_msgs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Default Message Size:</span><span class="se">\t\t</span><span class="s">Not Supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Default Queue Size:</span><span class="se">\t\t</span><span class="s">Not Supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">validate_current_settings</span><span class="p">();</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Adjusted system state for testing:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(soft):</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(hard):</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Maximum Message Size:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_max_msgsize</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Maximum Queue Size:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_max_msgs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_settings</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Default Message Size:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_def_msgsize</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Default Queue Size:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_def_msgs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Test series 1, behavior when no attr struct &quot;</span>
	       <span class="s">&quot;passed to mq_open:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">default_settings</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_queue</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Given sane system settings, mq_open without an attr &quot;</span>
		       <span class="s">&quot;struct succeeds:</span><span class="se">\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">!=</span> <span class="n">cur_max_msgs</span> <span class="o">||</span>
		    <span class="n">result</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">!=</span> <span class="n">cur_max_msgsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel does not support setting the default &quot;</span>
			       <span class="s">&quot;mq attributes,</span><span class="se">\n</span><span class="s">but also doesn&#39;t tie the &quot;</span>
			       <span class="s">&quot;defaults to the maximums:</span><span class="se">\t\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">,</span> <span class="o">++</span><span class="n">cur_max_msgs</span><span class="p">);</span>
			<span class="n">set</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">,</span> <span class="o">++</span><span class="n">cur_max_msgsize</span><span class="p">);</span>
			<span class="n">test_queue</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">==</span> <span class="n">cur_max_msgs</span> <span class="o">&amp;&amp;</span>
			    <span class="n">result</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">==</span> <span class="n">cur_max_msgsize</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel does not support setting the &quot;</span>
				       <span class="s">&quot;default mq attributes and</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;also ties system wide defaults to &quot;</span>
				       <span class="s">&quot;the system wide maximums:</span><span class="se">\t\t</span><span class="s">&quot;</span>
				       <span class="s">&quot;FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel does not support setting the &quot;</span>
				       <span class="s">&quot;default mq attributes,</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;but also doesn&#39;t tie the defaults to &quot;</span>
				       <span class="s">&quot;the maximums:</span><span class="se">\t\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel supports setting defaults separately from &quot;</span>
		       <span class="s">&quot;maximums:</span><span class="se">\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * While we are here, go ahead and test that the kernel</span>
<span class="cm">		 * properly follows the default settings</span>
<span class="cm">		 */</span>
		<span class="n">test_queue</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Given sane values, mq_open without an attr struct &quot;</span>
		       <span class="s">&quot;succeeds:</span><span class="se">\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">!=</span> <span class="n">cur_def_msgs</span> <span class="o">||</span>
		    <span class="n">result</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">!=</span> <span class="n">cur_def_msgsize</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel supports setting defaults, but does &quot;</span>
			       <span class="s">&quot;not actually honor them:</span><span class="se">\t</span><span class="s">FAIL</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">set</span><span class="p">(</span><span class="n">def_msgs</span><span class="p">,</span> <span class="o">++</span><span class="n">cur_def_msgs</span><span class="p">);</span>
			<span class="n">set</span><span class="p">(</span><span class="n">def_msgsize</span><span class="p">,</span> <span class="o">++</span><span class="n">cur_def_msgsize</span><span class="p">);</span>
			<span class="cm">/* In case max was the same as the default */</span>
			<span class="n">set</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">,</span> <span class="o">++</span><span class="n">cur_max_msgs</span><span class="p">);</span>
			<span class="n">set</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">,</span> <span class="o">++</span><span class="n">cur_max_msgsize</span><span class="p">);</span>
			<span class="n">test_queue</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">!=</span> <span class="n">cur_def_msgs</span> <span class="o">||</span>
			    <span class="n">result</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">!=</span> <span class="n">cur_def_msgsize</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel supports setting defaults, but &quot;</span>
				       <span class="s">&quot;does not actually honor them:</span><span class="se">\t</span><span class="s">&quot;</span>
				       <span class="s">&quot;FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel properly honors default setting &quot;</span>
				       <span class="s">&quot;knobs:</span><span class="se">\t\t\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">set</span><span class="p">(</span><span class="n">def_msgs</span><span class="p">,</span> <span class="n">cur_max_msgs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cur_def_msgs</span> <span class="o">=</span> <span class="n">cur_max_msgs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set</span><span class="p">(</span><span class="n">def_msgsize</span><span class="p">,</span> <span class="n">cur_max_msgsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cur_def_msgsize</span> <span class="o">=</span> <span class="n">cur_max_msgsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_def_msgs</span> <span class="o">*</span> <span class="p">(</span><span class="n">cur_def_msgsize</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span> <span class="o">&gt;=</span>
		    <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_def_msgs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span>
				<span class="p">(</span><span class="n">cur_def_msgsize</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
			<span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">;</span>
			<span class="n">setr</span><span class="p">(</span><span class="n">RLIMIT_MSGQUEUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_limits</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">==</span> <span class="n">cur_max_msgs</span> <span class="o">&amp;&amp;</span>
			    <span class="n">result</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">==</span> <span class="n">cur_max_msgsize</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel properly limits default values &quot;</span>
				       <span class="s">&quot;to lesser of default/max:</span><span class="se">\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel does not properly set default &quot;</span>
				       <span class="s">&quot;queue parameters when</span><span class="se">\n</span><span class="s">defaults &gt; &quot;</span>
				       <span class="s">&quot;max:</span><span class="se">\t\t\t\t\t\t\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel fails to open mq because defaults are &quot;</span>
			       <span class="s">&quot;greater than maximums:</span><span class="se">\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set</span><span class="p">(</span><span class="n">def_msgs</span><span class="p">,</span> <span class="o">--</span><span class="n">cur_def_msgs</span><span class="p">);</span>
		<span class="n">set</span><span class="p">(</span><span class="n">def_msgsize</span><span class="p">,</span> <span class="o">--</span><span class="n">cur_def_msgsize</span><span class="p">);</span>
		<span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="n">cur_def_msgs</span> <span class="o">*</span>
			<span class="n">cur_def_msgsize</span><span class="p">;</span>
		<span class="n">setr</span><span class="p">(</span><span class="n">RLIMIT_MSGQUEUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_limits</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel creates queue even though defaults &quot;</span>
			       <span class="s">&quot;would exceed</span><span class="se">\n</span><span class="s">rlimit setting:&quot;</span>
			       <span class="s">&quot;</span><span class="se">\t\t\t\t\t\t\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel properly fails to create queue when &quot;</span>
			       <span class="s">&quot;defaults would</span><span class="se">\n</span><span class="s">exceed rlimit:&quot;</span>
			       <span class="s">&quot;</span><span class="se">\t\t\t\t\t\t\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Test #2 - open with an attr struct that exceeds rlimit</span>
<span class="cm">	 */</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Test series 2, behavior when attr struct is &quot;</span>
	       <span class="s">&quot;passed to mq_open:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cur_max_msgs</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cur_max_msgsize</span> <span class="o">=</span> <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">set</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">,</span> <span class="n">cur_max_msgs</span><span class="p">);</span>
	<span class="n">set</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">,</span> <span class="n">cur_max_msgsize</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">=</span> <span class="n">cur_max_msgs</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">=</span> <span class="n">cur_max_msgsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open in excess of rlimit max when euid = 0 &quot;</span>
		       <span class="s">&quot;succeeded:</span><span class="se">\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open in excess of rlimit max when euid = 0 &quot;</span>
		       <span class="s">&quot;failed:</span><span class="se">\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">=</span> <span class="n">cur_max_msgs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with mq_maxmsg &gt; limit when euid = 0 &quot;</span>
		       <span class="s">&quot;succeeded:</span><span class="se">\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with mq_maxmsg &gt; limit when euid = 0 &quot;</span>
		       <span class="s">&quot;failed:</span><span class="se">\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">=</span> <span class="n">cur_max_msgsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with mq_msgsize &gt; limit when euid = 0 &quot;</span>
		       <span class="s">&quot;succeeded:</span><span class="se">\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with mq_msgsize &gt; limit when euid = 0 &quot;</span>
		       <span class="s">&quot;failed:</span><span class="se">\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with total size &gt; 2GB when euid = 0 &quot;</span>
		       <span class="s">&quot;succeeded:</span><span class="se">\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with total size &gt; 2GB when euid = 0 &quot;</span>
		       <span class="s">&quot;failed:</span><span class="se">\t\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seteuid</span><span class="p">(</span><span class="mi">99</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">=</span> <span class="n">cur_max_msgs</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">=</span> <span class="n">cur_max_msgsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open in excess of rlimit max when euid = 99 &quot;</span>
		       <span class="s">&quot;succeeded:</span><span class="se">\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open in excess of rlimit max when euid = 99 &quot;</span>
		       <span class="s">&quot;failed:</span><span class="se">\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">=</span> <span class="n">cur_max_msgs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with mq_maxmsg &gt; limit when euid = 99 &quot;</span>
		       <span class="s">&quot;succeeded:</span><span class="se">\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with mq_maxmsg &gt; limit when euid = 99 &quot;</span>
		       <span class="s">&quot;failed:</span><span class="se">\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">=</span> <span class="n">cur_max_msgsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with mq_msgsize &gt; limit when euid = 99 &quot;</span>
		       <span class="s">&quot;succeeded:</span><span class="se">\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with mq_msgsize &gt; limit when euid = 99 &quot;</span>
		       <span class="s">&quot;failed:</span><span class="se">\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_queue_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with total size &gt; 2GB when euid = 99 &quot;</span>
		       <span class="s">&quot;succeeded:</span><span class="se">\t\t</span><span class="s">FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Queue open with total size &gt; 2GB when euid = 99 &quot;</span>
		       <span class="s">&quot;failed:</span><span class="se">\t\t\t</span><span class="s">PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">shutdown</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
