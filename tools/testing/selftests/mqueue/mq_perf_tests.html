<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › testing › selftests › mqueue › mq_perf_tests.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mq_perf_tests.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This application is Copyright 2012 Red Hat, Inc.</span>
<span class="cm"> *	Doug Ledford &lt;dledford@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * mq_perf_tests is free software: you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation, version 3.</span>
<span class="cm"> *</span>
<span class="cm"> * mq_perf_tests is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * For the full text of the license, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * mq_perf_tests.c</span>
<span class="cm"> *   Tests various types of message queue workloads, concentrating on those</span>
<span class="cm"> *   situations that invole large message sizes, large message queue depths,</span>
<span class="cm"> *   or both, and reports back useful metrics about kernel message queue</span>
<span class="cm"> *   performance.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define _GNU_SOURCE</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;limits.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;signal.h&gt;</span>
<span class="cp">#include &lt;pthread.h&gt;</span>
<span class="cp">#include &lt;sched.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/time.h&gt;</span>
<span class="cp">#include &lt;sys/resource.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;mqueue.h&gt;</span>
<span class="cp">#include &lt;popt.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">usage</span> <span class="o">=</span>
<span class="s">&quot;Usage:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  %s [-c #[,#..] -f] path</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	-c #	Skip most tests and go straight to a high queue depth test</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		and then run that test continuously (useful for running at</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		the same time as some other workload to see how much the</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		cache thrashing caused by adding messages to a very deep</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		queue impacts the performance of other programs).  The number</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		indicates which CPU core we should bind the process to during</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		the run.  If you have more than one physical CPU, then you</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		will need one copy per physical CPU package, and you should</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		specify the CPU cores to pin ourself to via a comma separated</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		list of CPU values.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	-f	Only usable with continuous mode.  Pin ourself to the CPUs</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		as requested, then instead of looping doing a high mq</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		workload, just busy loop.  This will allow us to lock up a</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		single CPU just like we normally would, but without actually</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		thrashing the CPU cache.  This is to make it easier to get</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		comparable numbers from some other workload running on the</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		other CPUs.  One set of numbers with # CPUs locked up running</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		an mq workload, and another set of numbers with those same</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		CPUs locked away from the test workload, but not doing</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;		anything to trash the cache like the mq workload might.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	path	Path name of the message queue to create</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	Note: this program must be run as root in order to enable all tests</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">MAX_MSGS</span> <span class="o">=</span> <span class="s">&quot;/proc/sys/fs/mqueue/msg_max&quot;</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">MAX_MSGSIZE</span> <span class="o">=</span> <span class="s">&quot;/proc/sys/fs/mqueue/msgsize_max&quot;</span><span class="p">;</span>

<span class="cp">#define min(a, b) ((a) &lt; (b) ? (a) : (b))</span>
<span class="cp">#define MAX_CPUS 64</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">cpu_option_string</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">cpus_to_pin</span><span class="p">[</span><span class="n">MAX_CPUS</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">num_cpus_to_pin</span><span class="p">;</span>
<span class="n">pthread_t</span> <span class="n">cpu_threads</span><span class="p">[</span><span class="n">MAX_CPUS</span><span class="p">];</span>
<span class="n">pthread_t</span> <span class="n">main_thread</span><span class="p">;</span>
<span class="n">cpu_set_t</span> <span class="o">*</span><span class="n">cpu_set</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">cpu_set_size</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">cpus_online</span><span class="p">;</span>

<span class="cp">#define MSG_SIZE 16</span>
<span class="cp">#define TEST1_LOOPS 10000000</span>
<span class="cp">#define TEST2_LOOPS 100000</span>
<span class="kt">int</span> <span class="n">continuous_mode</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">continuous_mode_fake</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">rlimit</span> <span class="n">saved_limits</span><span class="p">,</span> <span class="n">cur_limits</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">saved_max_msgs</span><span class="p">,</span> <span class="n">saved_max_msgsize</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">cur_max_msgs</span><span class="p">,</span> <span class="n">cur_max_msgsize</span><span class="p">;</span>
<span class="kt">FILE</span> <span class="o">*</span><span class="n">max_msgs</span><span class="p">,</span> <span class="o">*</span><span class="n">max_msgsize</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">cur_nice</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">queue_path</span> <span class="o">=</span> <span class="s">&quot;/mq_perf_tests&quot;</span><span class="p">;</span>
<span class="n">mqd_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">mq_attr</span> <span class="n">result</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">mq_prio_max</span><span class="p">;</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">poptOption</span> <span class="n">options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">longName</span> <span class="o">=</span> <span class="s">&quot;continuous&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">shortName</span> <span class="o">=</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">argInfo</span> <span class="o">=</span> <span class="n">POPT_ARG_STRING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_option_string</span><span class="p">,</span>
		<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">descrip</span> <span class="o">=</span> <span class="s">&quot;Run continuous tests at a high queue depth in &quot;</span>
			<span class="s">&quot;order to test the effects of cache thrashing on &quot;</span>
			<span class="s">&quot;other tasks on the system.  This test is intended &quot;</span>
			<span class="s">&quot;to be run on one core of each physical CPU while &quot;</span>
			<span class="s">&quot;some other CPU intensive task is run on all the other &quot;</span>
			<span class="s">&quot;cores of that same physical CPU and the other task &quot;</span>
			<span class="s">&quot;is timed.  It is assumed that the process of adding &quot;</span>
			<span class="s">&quot;messages to the message queue in a tight loop will &quot;</span>
			<span class="s">&quot;impact that other task to some degree.  Once the &quot;</span>
			<span class="s">&quot;tests are performed in this way, you should then &quot;</span>
			<span class="s">&quot;re-run the tests using fake mode in order to check &quot;</span>
			<span class="s">&quot;the difference in time required to perform the CPU &quot;</span>
			<span class="s">&quot;intensive task&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">argDescrip</span> <span class="o">=</span> <span class="s">&quot;cpu[,cpu]&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">longName</span> <span class="o">=</span> <span class="s">&quot;fake&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">shortName</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">argInfo</span> <span class="o">=</span> <span class="n">POPT_ARG_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">continuous_mode_fake</span><span class="p">,</span>
		<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">descrip</span> <span class="o">=</span> <span class="s">&quot;Tie up the CPUs that we would normally tie up in&quot;</span>
			<span class="s">&quot;continuous mode, but don&#39;t actually do any mq stuff, &quot;</span>
			<span class="s">&quot;just keep the CPU busy so it can&#39;t be used to process &quot;</span>
			<span class="s">&quot;system level tasks as this would free up resources on &quot;</span>
			<span class="s">&quot;the other CPU cores and skew the comparison between &quot;</span>
			<span class="s">&quot;the no-mqueue work and mqueue work tests&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">argDescrip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">longName</span> <span class="o">=</span> <span class="s">&quot;path&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">shortName</span> <span class="o">=</span> <span class="sc">&#39;p&#39;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">argInfo</span> <span class="o">=</span> <span class="n">POPT_ARG_STRING</span> <span class="o">|</span> <span class="n">POPT_ARGFLAG_SHOW_DEFAULT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue_path</span><span class="p">,</span>
		<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;p&#39;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">descrip</span> <span class="o">=</span> <span class="s">&quot;The name of the path to use in the mqueue &quot;</span>
			<span class="s">&quot;filesystem for our tests&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">argDescrip</span> <span class="o">=</span> <span class="s">&quot;pathname&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">POPT_AUTOHELP</span>
	<span class="n">POPT_TABLEEND</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">shutdown</span><span class="p">(</span><span class="kt">int</span> <span class="n">exit_val</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_cause</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line_no</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">sig_action_SIGUSR1</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">sig_action</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">get</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">try_set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">getr</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rlimit</span> <span class="o">*</span><span class="n">rlim</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">setr</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rlimit</span> <span class="o">*</span><span class="n">rlim</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">open_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">increase_limits</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rewind</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fprintf</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">perror</span><span class="p">(</span><span class="n">err_msg</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">shutdown</span><span class="p">(</span><span class="kt">int</span> <span class="n">exit_val</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_cause</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">in_shutdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errno_at_shutdown</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* In case we get called by multiple threads or from an sighandler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_shutdown</span><span class="o">++</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_cpus_to_pin</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_threads</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pthread_kill</span><span class="p">(</span><span class="n">cpu_threads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">SIGUSR1</span><span class="p">);</span>
			<span class="n">pthread_join</span><span class="p">(</span><span class="n">cpu_threads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mq_close</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;mq_close() during shutdown&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_path</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Be silent if this fails, if we cleaned up already it&#39;s</span>
<span class="cm">		 * expected to fail</span>
<span class="cm">		 */</span>
		<span class="n">mq_unlink</span><span class="p">(</span><span class="n">queue_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_max_msgs</span><span class="p">)</span>
		<span class="n">__set</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">,</span> <span class="n">saved_max_msgs</span><span class="p">,</span>
		      <span class="s">&quot;failed to restore saved_max_msgs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_max_msgsize</span><span class="p">)</span>
		<span class="n">__set</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">,</span> <span class="n">saved_max_msgsize</span><span class="p">,</span>
		      <span class="s">&quot;failed to restore saved_max_msgsize&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exit_val</span><span class="p">)</span>
		<span class="n">error</span><span class="p">(</span><span class="n">exit_val</span><span class="p">,</span> <span class="n">errno_at_shutdown</span><span class="p">,</span> <span class="s">&quot;%s at %d&quot;</span><span class="p">,</span>
		      <span class="n">err_cause</span><span class="p">,</span> <span class="n">line_no</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sig_action_SIGUSR1</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pthread_self</span><span class="p">()</span> <span class="o">!=</span> <span class="n">main_thread</span><span class="p">)</span>
		<span class="n">pthread_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Caught signal %d in SIGUSR1 handler, &quot;</span>
				<span class="s">&quot;exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signum</span><span class="p">);</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Returned from shutdown?!?!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sig_action</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pthread_self</span><span class="p">()</span> <span class="o">!=</span> <span class="n">main_thread</span><span class="p">)</span>
		<span class="n">pthread_kill</span><span class="p">(</span><span class="n">main_thread</span><span class="p">,</span> <span class="n">signum</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Caught signal %d, exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signum</span><span class="p">);</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Returned from shutdown?!?!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">rewind</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Error reading /proc entry&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">;</span>

	<span class="n">rewind</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fprintf</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shutdown</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Failed writing to /proc file&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">new_value</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shutdown</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;We didn&#39;t get what we wrote to /proc back&quot;</span><span class="p">,</span>
				<span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">try_set</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">;</span>

	<span class="n">rewind</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">new_value</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">new_value</span> <span class="o">==</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">getr</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rlimit</span> <span class="o">*</span><span class="n">rlim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">rlim</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;getrlimit()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">setr</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rlimit</span> <span class="o">*</span><span class="n">rlim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">rlim</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;setrlimit()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * open_queue - open the global queue for testing</span>
<span class="cm"> * @attr - An attr struct specifying the desired queue traits</span>
<span class="cm"> * @result - An attr struct that lists the actual traits the queue has</span>
<span class="cm"> *</span>
<span class="cm"> * This open is not allowed to fail, failure will result in an orderly</span>
<span class="cm"> * shutdown of the program.  The global queue_path is used to set what</span>
<span class="cm"> * queue to open, the queue descriptor is saved in the global queue</span>
<span class="cm"> * variable.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">open_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_EXCL</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">perms</span> <span class="o">=</span> <span class="n">DEFFILEMODE</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">mq_open</span><span class="p">(</span><span class="n">queue_path</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">perms</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mq_open()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq_getattr</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mq_getattr()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Queue %s created:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">queue_path</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">mq_flags:</span><span class="se">\t\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">mq_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span> <span class="o">?</span>
	       <span class="s">&quot;O_NONBLOCK&quot;</span> <span class="o">:</span> <span class="s">&quot;(null)&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">mq_maxmsg:</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">mq_maxmsg</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">mq_msgsize:</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">mq_msgsize</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">mq_curmsgs:</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">mq_curmsgs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">fake_cont_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_cpus_to_pin</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pthread_self</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Started fake continuous mode thread %d on CPU %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
	       <span class="n">cpus_to_pin</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">cont_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="n">MSG_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">priority</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_cpus_to_pin</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pthread_self</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Started continuous mode thread %d on CPU %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
	       <span class="n">cpus_to_pin</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">mq_send</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="n">mq_receive</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">priority</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define drain_queue() \</span>
<span class="cp">	while (mq_receive(queue, buff, MSG_SIZE, &amp;prio_in) == MSG_SIZE)</span>

<span class="cp">#define do_untimed_send() \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (mq_send(queue, buff, MSG_SIZE, prio_out)) \</span>
<span class="cp">			shutdown(3, &quot;Test send failure&quot;, __LINE__); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define do_send_recv() \</span>
<span class="cp">	do { \</span>
<span class="cp">		clock_gettime(clock, &amp;start); \</span>
<span class="cp">		if (mq_send(queue, buff, MSG_SIZE, prio_out)) \</span>
<span class="cp">			shutdown(3, &quot;Test send failure&quot;, __LINE__); \</span>
<span class="cp">		clock_gettime(clock, &amp;middle); \</span>
<span class="cp">		if (mq_receive(queue, buff, MSG_SIZE, &amp;prio_in) != MSG_SIZE) \</span>
<span class="cp">			shutdown(3, &quot;Test receive failure&quot;, __LINE__); \</span>
<span class="cp">		clock_gettime(clock, &amp;end); \</span>
<span class="cp">		nsec = ((middle.tv_sec - start.tv_sec) * 1000000000) + \</span>
<span class="cp">			(middle.tv_nsec - start.tv_nsec); \</span>
<span class="cp">		send_total.tv_nsec += nsec; \</span>
<span class="cp">		if (send_total.tv_nsec &gt;= 1000000000) { \</span>
<span class="cp">			send_total.tv_sec++; \</span>
<span class="cp">			send_total.tv_nsec -= 1000000000; \</span>
<span class="cp">		} \</span>
<span class="cp">		nsec = ((end.tv_sec - middle.tv_sec) * 1000000000) + \</span>
<span class="cp">			(end.tv_nsec - middle.tv_nsec); \</span>
<span class="cp">		recv_total.tv_nsec += nsec; \</span>
<span class="cp">		if (recv_total.tv_nsec &gt;= 1000000000) { \</span>
<span class="cp">			recv_total.tv_sec++; \</span>
<span class="cp">			recv_total.tv_nsec -= 1000000000; \</span>
<span class="cp">		} \</span>
<span class="cp">	} while (0)</span>

<span class="k">struct</span> <span class="n">test</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">const_prio</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">inc_prio</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++*</span><span class="n">prio</span> <span class="o">==</span> <span class="n">mq_prio_max</span><span class="p">)</span>
		<span class="o">*</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dec_prio</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--*</span><span class="n">prio</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">prio</span> <span class="o">=</span> <span class="n">mq_prio_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">random_prio</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">prio</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="n">mq_prio_max</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">test</span> <span class="n">test2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Test #2a: Time send/recv message, queue full, constant prio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">const_prio</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Test #2b: Time send/recv message, queue full, increasing prio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">inc_prio</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Test #2c: Time send/recv message, queue full, decreasing prio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dec_prio</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Test #2d: Time send/recv message, queue full, random prio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">random_prio</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Tests to perform (all done with MSG_SIZE messages):</span>
<span class="cm"> *</span>
<span class="cm"> * 1) Time to add/remove message with 0 messages on queue</span>
<span class="cm"> * 1a) with constant prio</span>
<span class="cm"> * 2) Time to add/remove message when queue close to capacity:</span>
<span class="cm"> * 2a) with constant prio</span>
<span class="cm"> * 2b) with increasing prio</span>
<span class="cm"> * 2c) with decreasing prio</span>
<span class="cm"> * 2d) with random prio</span>
<span class="cm"> * 3) Test limits of priorities honored (double check _SC_MQ_PRIO_MAX)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">perf_test_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="n">MSG_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">prio_out</span><span class="p">,</span> <span class="n">prio_in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">clockid_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">pthread_t</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">res</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">send_total</span><span class="p">,</span> <span class="n">recv_total</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">nsec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">test</span> <span class="o">*</span><span class="n">cur_test</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_threads</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Started mqueue performance test thread on CPU %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpus_to_pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">mq_prio_max</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_MQ_PRIO_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq_prio_max</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;sysconf(_SC_MQ_PRIO_MAX)&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pthread_getcpuclockid</span><span class="p">(</span><span class="n">cpu_threads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;pthread_getcpuclockid&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock_getres</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;clock_getres()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Max priorities:</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mq_prio_max</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Clock resolution:</span><span class="se">\t\t</span><span class="s">%d nsec%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">,</span>
	       <span class="n">res</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>



	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Test #1: Time send/recv message, queue empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">(%d iterations)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEST1_LOOPS</span><span class="p">);</span>
	<span class="n">prio_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">send_total</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">send_total</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">recv_total</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">recv_total</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TEST1_LOOPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">do_send_recv</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Send msg:</span><span class="se">\t\t\t</span><span class="s">%d.%ds total time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">send_total</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">send_total</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="n">nsec</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">send_total</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000000000</span> <span class="o">+</span>
		 <span class="n">send_total</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="n">TEST1_LOOPS</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t\t\t\t</span><span class="s">%d nsec/msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nsec</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Recv msg:</span><span class="se">\t\t\t</span><span class="s">%d.%ds total time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">recv_total</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">recv_total</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="n">nsec</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">recv_total</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000000000</span> <span class="o">+</span>
		<span class="n">recv_total</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="n">TEST1_LOOPS</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t\t\t\t</span><span class="s">%d nsec/msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nsec</span><span class="p">);</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">cur_test</span> <span class="o">=</span> <span class="n">test2</span><span class="p">;</span> <span class="n">cur_test</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">cur_test</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">cur_test</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">(%d iterations)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEST2_LOOPS</span><span class="p">);</span>
		<span class="n">prio_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">send_total</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">send_total</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">recv_total</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">recv_total</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Filling queue...&quot;</span><span class="p">);</span>
		<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
		<span class="n">clock_gettime</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_untimed_send</span><span class="p">();</span>
			<span class="n">cur_test</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prio_out</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clock_gettime</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
		<span class="n">nsec</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">*</span>
			<span class="mi">1000000000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;done.</span><span class="se">\t\t</span><span class="s">%lld.%llds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nsec</span> <span class="o">/</span> <span class="mi">1000000000</span><span class="p">,</span>
		       <span class="n">nsec</span> <span class="o">%</span> <span class="mi">1000000000</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Testing...&quot;</span><span class="p">);</span>
		<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TEST2_LOOPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_send_recv</span><span class="p">();</span>
			<span class="n">cur_test</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prio_out</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Send msg:</span><span class="se">\t\t\t</span><span class="s">%d.%ds total time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">send_total</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">send_total</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
		<span class="n">nsec</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">send_total</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000000000</span> <span class="o">+</span>
			 <span class="n">send_total</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="n">TEST2_LOOPS</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t\t\t\t</span><span class="s">%d nsec/msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nsec</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Recv msg:</span><span class="se">\t\t\t</span><span class="s">%d.%ds total time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">recv_total</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">recv_total</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
		<span class="n">nsec</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">recv_total</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000000000</span> <span class="o">+</span>
			<span class="n">recv_total</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="n">TEST2_LOOPS</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t\t\t\t</span><span class="s">%d nsec/msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nsec</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Draining queue...&quot;</span><span class="p">);</span>
		<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
		<span class="n">clock_gettime</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
		<span class="n">drain_queue</span><span class="p">();</span>
		<span class="n">clock_gettime</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
		<span class="n">nsec</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">*</span>
			<span class="mi">1000000000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;done.</span><span class="se">\t\t</span><span class="s">%lld.%llds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nsec</span> <span class="o">/</span> <span class="mi">1000000000</span><span class="p">,</span>
		       <span class="n">nsec</span> <span class="o">%</span> <span class="mi">1000000000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">increase_limits</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">RLIM_INFINITY</span><span class="p">;</span>
	<span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="n">RLIM_INFINITY</span><span class="p">;</span>
	<span class="n">setr</span><span class="p">(</span><span class="n">RLIMIT_MSGQUEUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_limits</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">try_set</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">,</span> <span class="n">cur_max_msgs</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">))</span>
		<span class="p">;</span>
	<span class="n">cur_max_msgs</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">try_set</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">,</span> <span class="n">cur_max_msgsize</span> <span class="o">+=</span> <span class="mi">1024</span><span class="p">))</span>
		<span class="p">;</span>
	<span class="n">cur_max_msgsize</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setpriority</span><span class="p">(</span><span class="n">PRIO_PROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setpriority()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">cur_nice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mq_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">,</span> <span class="o">*</span><span class="n">next_option</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sigaction</span> <span class="n">sa</span><span class="p">;</span>
	<span class="n">poptContext</span> <span class="n">popt_context</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">retval</span><span class="p">;</span>

	<span class="n">main_thread</span> <span class="o">=</span> <span class="n">pthread_self</span><span class="p">();</span>
	<span class="n">num_cpus_to_pin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_NPROCESSORS_ONLN</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;sysconf(_SC_NPROCESSORS_ONLN)&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cpus_online</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">MAX_CPUS</span><span class="p">,</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_NPROCESSORS_ONLN</span><span class="p">));</span>
	<span class="n">cpu_set</span> <span class="o">=</span> <span class="n">CPU_ALLOC</span><span class="p">(</span><span class="n">cpus_online</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_set</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;CPU_ALLOC()&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cpu_set_size</span> <span class="o">=</span> <span class="n">CPU_ALLOC_SIZE</span><span class="p">(</span><span class="n">cpus_online</span><span class="p">);</span>
	<span class="n">CPU_ZERO_S</span><span class="p">(</span><span class="n">cpu_set_size</span><span class="p">,</span> <span class="n">cpu_set</span><span class="p">);</span>

	<span class="n">popt_context</span> <span class="o">=</span> <span class="n">poptGetContext</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">argv</span><span class="p">,</span>
				      <span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">poptGetNextOpt</span><span class="p">(</span><span class="n">popt_context</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="n">continuous_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">option</span> <span class="o">=</span> <span class="n">cpu_option_string</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">next_option</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">next_option</span><span class="p">)</span>
					<span class="o">*</span><span class="n">next_option</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">cpu</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">&gt;=</span> <span class="n">cpus_online</span><span class="p">)</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;CPU %d exceeds &quot;</span>
						<span class="s">&quot;cpus online, ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">cpu</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">cpus_to_pin</span><span class="p">[</span><span class="n">num_cpus_to_pin</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">next_option</span><span class="p">)</span>
					<span class="n">option</span> <span class="o">=</span> <span class="o">++</span><span class="n">next_option</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">next_option</span> <span class="o">&amp;&amp;</span> <span class="n">num_cpus_to_pin</span> <span class="o">&lt;</span> <span class="n">MAX_CPUS</span><span class="p">);</span>
			<span class="cm">/* Double check that they didn&#39;t give us the same CPU</span>
<span class="cm">			 * more than once */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">num_cpus_to_pin</span><span class="p">;</span> <span class="n">cpu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CPU_ISSET_S</span><span class="p">(</span><span class="n">cpus_to_pin</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span> <span class="n">cpu_set_size</span><span class="p">,</span>
						<span class="n">cpu_set</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Any given CPU may &quot;</span>
						<span class="s">&quot;only be given once.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">CPU_SET_S</span><span class="p">(</span><span class="n">cpus_to_pin</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span>
						  <span class="n">cpu_set_size</span><span class="p">,</span> <span class="n">cpu_set</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;p&#39;</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Although we can create a msg queue with a</span>
<span class="cm">			 * non-absolute path name, unlink will fail.  So,</span>
<span class="cm">			 * if the name doesn&#39;t start with a /, add one</span>
<span class="cm">			 * when we save it.</span>
<span class="cm">			 */</span>
			<span class="n">option</span> <span class="o">=</span> <span class="n">queue_path</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">option</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">queue_path</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">option</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_path</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">perror</span><span class="p">(</span><span class="s">&quot;malloc()&quot;</span><span class="p">);</span>
					<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">queue_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>
				<span class="n">queue_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">queue_path</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
				<span class="n">free</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">continuous_mode</span> <span class="o">&amp;&amp;</span> <span class="n">num_cpus_to_pin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Must pass at least one CPU to continuous &quot;</span>
			<span class="s">&quot;mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">poptPrintUsage</span><span class="p">(</span><span class="n">popt_context</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">continuous_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_cpus_to_pin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cpus_to_pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpus_online</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Not running as root, but almost all tests &quot;</span>
			<span class="s">&quot;require root in order to modify</span><span class="se">\n</span><span class="s">system settings.  &quot;</span>
			<span class="s">&quot;Exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">max_msgs</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">MAX_MSGS</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">);</span>
	<span class="n">max_msgsize</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">MAX_MSGSIZE</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_msgs</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Failed to open msg_max&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_msgsize</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Failed to open msgsize_max&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/* Load up the current system values for everything we can */</span>
	<span class="n">getr</span><span class="p">(</span><span class="n">RLIMIT_MSGQUEUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_limits</span><span class="p">);</span>
	<span class="n">cur_limits</span> <span class="o">=</span> <span class="n">saved_limits</span><span class="p">;</span>
	<span class="n">saved_max_msgs</span> <span class="o">=</span> <span class="n">cur_max_msgs</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">max_msgs</span><span class="p">);</span>
	<span class="n">saved_max_msgsize</span> <span class="o">=</span> <span class="n">cur_max_msgsize</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">max_msgsize</span><span class="p">);</span>
	<span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cur_nice</span> <span class="o">=</span> <span class="n">getpriority</span><span class="p">(</span><span class="n">PRIO_PROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errno</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;getpriority()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/* Tell the user our initial state */</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Initial system state:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Using queue path:</span><span class="se">\t\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">queue_path</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(soft):</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_limits</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(hard):</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_limits</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Maximum Message Size:</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_max_msgsize</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Maximum Queue Size:</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_max_msgs</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Nice value:</span><span class="se">\t\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_nice</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">increase_limits</span><span class="p">();</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Adjusted system state for testing:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">==</span> <span class="n">RLIM_INFINITY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(soft):</span><span class="se">\t\t\t</span><span class="s">(unlimited)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(hard):</span><span class="se">\t\t\t</span><span class="s">(unlimited)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(soft):</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">RLIMIT_MSGQUEUE(hard):</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cur_limits</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Maximum Message Size:</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_max_msgsize</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Maximum Queue Size:</span><span class="se">\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_max_msgs</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Nice value:</span><span class="se">\t\t\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_nice</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Continuous mode:</span><span class="se">\t\t\t</span><span class="s">(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">continuous_mode</span> <span class="o">?</span>
	       <span class="p">(</span><span class="n">continuous_mode_fake</span> <span class="o">?</span> <span class="s">&quot;fake mode&quot;</span> <span class="o">:</span> <span class="s">&quot;enabled&quot;</span><span class="p">)</span> <span class="o">:</span>
	       <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">CPUs to pin:</span><span class="se">\t\t\t\t</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">cpus_to_pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">num_cpus_to_pin</span><span class="p">;</span> <span class="n">cpu</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;,%d&quot;</span><span class="p">,</span> <span class="n">cpus_to_pin</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sa</span><span class="p">.</span><span class="n">sa_sigaction</span> <span class="o">=</span> <span class="n">sig_action_SIGUSR1</span><span class="p">;</span>
	<span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
	<span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">,</span> <span class="n">SIGHUP</span><span class="p">);</span>
	<span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">,</span> <span class="n">SIGINT</span><span class="p">);</span>
	<span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">,</span> <span class="n">SIGQUIT</span><span class="p">);</span>
	<span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span>
	<span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="n">SA_SIGINFO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;sigaction(SIGUSR1)&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">sa</span><span class="p">.</span><span class="n">sa_sigaction</span> <span class="o">=</span> <span class="n">sig_action</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;sigaction(SIGHUP)&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;sigaction(SIGINT)&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGQUIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;sigaction(SIGQUIT)&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;sigaction(SIGTERM)&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">continuous_mode_fake</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">mq_flags</span> <span class="o">=</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span> <span class="o">=</span> <span class="n">cur_max_msgs</span><span class="p">;</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span> <span class="o">=</span> <span class="n">MSG_SIZE</span><span class="p">;</span>
		<span class="n">open_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_cpus_to_pin</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pthread_attr_t</span> <span class="n">thread_attr</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">thread_func</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">continuous_mode_fake</span><span class="p">)</span>
			<span class="n">thread_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fake_cont_thread</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">continuous_mode</span><span class="p">)</span>
			<span class="n">thread_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cont_thread</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">thread_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">perf_test_thread</span><span class="p">;</span>

		<span class="n">CPU_ZERO_S</span><span class="p">(</span><span class="n">cpu_set_size</span><span class="p">,</span> <span class="n">cpu_set</span><span class="p">);</span>
		<span class="n">CPU_SET_S</span><span class="p">(</span><span class="n">cpus_to_pin</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cpu_set_size</span><span class="p">,</span> <span class="n">cpu_set</span><span class="p">);</span>
		<span class="n">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_attr</span><span class="p">);</span>
		<span class="n">pthread_attr_setaffinity_np</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_attr</span><span class="p">,</span> <span class="n">cpu_set_size</span><span class="p">,</span>
					    <span class="n">cpu_set</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_threads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">thread_attr</span><span class="p">,</span> <span class="n">thread_func</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">shutdown</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;pthread_create()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">pthread_attr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">continuous_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pthread_join</span><span class="p">(</span><span class="n">cpu_threads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">retval</span><span class="p">);</span>
		<span class="n">shutdown</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">retval</span><span class="p">,</span> <span class="s">&quot;perf_test_thread()&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
