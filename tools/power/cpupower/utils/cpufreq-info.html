<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › power › cpupower › utils › cpufreq-info.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cpufreq-info.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  (C) 2004-2009  Dominik Brodowski &lt;linux@dominikbrodowski.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Licensed under the terms of the GNU GPL License version 2.</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="cp">#include &lt;getopt.h&gt;</span>

<span class="cp">#include &quot;cpufreq.h&quot;</span>
<span class="cp">#include &quot;helpers/helpers.h&quot;</span>
<span class="cp">#include &quot;helpers/bitmask.h&quot;</span>

<span class="cp">#define LINE_LEN 10</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">count_cpus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="n">LINE_LEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpunr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;/proc/stat&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t count the number of CPUs (%s: %s), assuming 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="s">&quot;/proc/stat&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fgets</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">LINE_LEN</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="n">LINE_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">LINE_LEN</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;cpu &quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;cpu%d &quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpunr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpunr</span> <span class="o">&gt;</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cpunr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="cm">/* cpu count starts from 0, on error return 1 (UP) */</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_cpufreq_output</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">nr_cpus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_pctg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_pctg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;          minimum CPU frequency  -  maximum CPU frequency  -  governor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">nr_cpus</span> <span class="o">=</span> <span class="n">count_cpus</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">nr_cpus</span><span class="p">;</span> <span class="n">cpu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_get_policy</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_get_hardware_limits</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">min_pctg</span> <span class="o">=</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">max</span><span class="p">;</span>
			<span class="n">max_pctg</span> <span class="o">=</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">max</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;CPU%3d    %9lu kHz (%3d %%)  -  %9lu kHz (%3d %%)  -  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cpu</span> <span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span> <span class="o">?</span> <span class="n">min_pctg</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">,</span>
			<span class="n">max</span> <span class="o">?</span> <span class="n">max_pctg</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">);</span>

		<span class="n">cpufreq_put_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_speed</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">+=</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%u.%02u GHz&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">speed</span><span class="o">/</span><span class="mi">1000000</span><span class="p">),</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">speed</span><span class="o">%</span><span class="mi">1000000</span><span class="p">)</span><span class="o">/</span><span class="mi">10000</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">+=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%u MHz&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">speed</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%u.%01u MHz&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">speed</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">speed</span><span class="o">%</span><span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu kHz&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_duration</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">duration</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">)</span>
			<span class="n">duration</span> <span class="o">+=</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%u.%02u ms&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">duration</span><span class="o">/</span><span class="mi">1000000</span><span class="p">),</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">duration</span><span class="o">%</span><span class="mi">1000000</span><span class="p">)</span><span class="o">/</span><span class="mi">10000</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">)</span>
			<span class="n">duration</span> <span class="o">+=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%u us&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">duration</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span>
			<span class="n">duration</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%u.%01u us&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">duration</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">duration</span><span class="o">%</span><span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu ns&quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --boost / -b */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_boost_mode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">support</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">b_states</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pstate_no</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* ToDo: Make this more global */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pstates</span><span class="p">[</span><span class="n">MAX_HW_PSTATES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpupower_cpu_info</span><span class="p">.</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">X86_VENDOR_AMD</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cpupower_cpu_info</span><span class="p">.</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">X86_VENDOR_INTEL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_has_boost_support</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">support</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b_states</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Error while evaluating Boost Capabilities&quot;</span>
				<span class="s">&quot; on CPU %d -- are you root?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* P state changes via MSR are identified via cpuid 80000007</span>
<span class="cm">	   on Intel and AMD, but we assume boost capable machines can do that</span>
<span class="cm">	   if (cpuid_eax(0x80000000) &gt;= 0x80000007</span>
<span class="cm">	   &amp;&amp; (cpuid_edx(0x80000007) &amp; (1 &lt;&lt; 7)))</span>
<span class="cm">	*/</span>

	<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  boost state support:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    Supported: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">support</span> <span class="o">?</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;yes&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;no&quot;</span><span class="p">));</span>
	<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    Active: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">active</span> <span class="o">?</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;yes&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;no&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpupower_cpu_info</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">X86_VENDOR_AMD</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cpupower_cpu_info</span><span class="p">.</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">decode_pstates</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">cpupower_cpu_info</span><span class="p">.</span><span class="n">family</span><span class="p">,</span> <span class="n">b_states</span><span class="p">,</span>
				     <span class="n">pstates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstate_no</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    Boost States: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">b_states</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    Total States: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">pstate_no</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pstate_no</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">b_states</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    Pstate-Pb%d: %luMHz (boost state)&quot;</span>
					 <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">pstates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    Pstate-P%d:  %luMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
				       <span class="n">i</span> <span class="o">-</span> <span class="n">b_states</span><span class="p">,</span> <span class="n">pstates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpupower_cpu_info</span><span class="p">.</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">CPUPOWER_CAP_HAS_TURBO_RATIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">double</span> <span class="n">bclk</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">intel_turbo_ratio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ratio</span><span class="p">;</span>

		<span class="cm">/* Any way to autodetect this ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpupower_cpu_info</span><span class="p">.</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">CPUPOWER_CAP_IS_SNB</span><span class="p">)</span>
			<span class="n">bclk</span> <span class="o">=</span> <span class="mf">100.00</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bclk</span> <span class="o">=</span> <span class="mf">133.33</span><span class="p">;</span>
		<span class="n">intel_turbo_ratio</span> <span class="o">=</span> <span class="n">msr_intel_get_turbo_ratio</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">dprint</span> <span class="p">(</span><span class="s">&quot;    Ratio: 0x%llx - bclk: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">intel_turbo_ratio</span><span class="p">,</span> <span class="n">bclk</span><span class="p">);</span>

		<span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">intel_turbo_ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    %.0f MHz max turbo 4 active cores</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
			       <span class="n">ratio</span> <span class="o">*</span> <span class="n">bclk</span><span class="p">);</span>

		<span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">intel_turbo_ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    %.0f MHz max turbo 3 active cores</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
			       <span class="n">ratio</span> <span class="o">*</span> <span class="n">bclk</span><span class="p">);</span>

		<span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">intel_turbo_ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    %.0f MHz max turbo 2 active cores</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
			       <span class="n">ratio</span> <span class="o">*</span> <span class="n">bclk</span><span class="p">);</span>

		<span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">intel_turbo_ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;    %.0f MHz max turbo 1 active cores</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
			       <span class="n">ratio</span> <span class="o">*</span> <span class="n">bclk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_output_one</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_affected_cpus</span> <span class="o">*</span><span class="n">cpus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_available_frequencies</span> <span class="o">*</span><span class="n">freqs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">freq_kernel</span><span class="p">,</span> <span class="n">freq_hardware</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_trans</span><span class="p">,</span> <span class="n">latency</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">total_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_available_governors</span> <span class="o">*</span><span class="n">governors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_cpu_exists</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">freq_kernel</span> <span class="o">=</span> <span class="n">cpufreq_get_freq_kernel</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">freq_hardware</span> <span class="o">=</span> <span class="n">cpufreq_get_freq_hardware</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">driver</span> <span class="o">=</span> <span class="n">cpufreq_get_driver</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  no or unknown cpufreq driver is active on this CPU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  driver: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">driver</span><span class="p">);</span>
		<span class="n">cpufreq_put_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cpus</span> <span class="o">=</span> <span class="n">cpufreq_get_related_cpus</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  CPUs which run at the same hardware frequency: &quot;</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
			<span class="n">cpus</span> <span class="o">=</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">cpufreq_put_related_cpus</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cpus</span> <span class="o">=</span> <span class="n">cpufreq_get_affected_cpus</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  CPUs which need to have their frequency coordinated by software: &quot;</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
			<span class="n">cpus</span> <span class="o">=</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">cpufreq_put_affected_cpus</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">latency</span> <span class="o">=</span> <span class="n">cpufreq_get_transition_latency</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">latency</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  maximum transition latency: &quot;</span><span class="p">));</span>
		<span class="n">print_duration</span><span class="p">(</span><span class="n">latency</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpufreq_get_hardware_limits</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  hardware limits: &quot;</span><span class="p">));</span>
		<span class="n">print_speed</span><span class="p">(</span><span class="n">min</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot; - &quot;</span><span class="p">);</span>
		<span class="n">print_speed</span><span class="p">(</span><span class="n">max</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">freqs</span> <span class="o">=</span> <span class="n">cpufreq_get_available_frequencies</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  available frequency steps: &quot;</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">freqs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_speed</span><span class="p">(</span><span class="n">freqs</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
			<span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">print_speed</span><span class="p">(</span><span class="n">freqs</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cpufreq_put_available_frequencies</span><span class="p">(</span><span class="n">freqs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">governors</span> <span class="o">=</span> <span class="n">cpufreq_get_available_governors</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">governors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  available cpufreq governors: &quot;</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">governors</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s, &quot;</span><span class="p">,</span> <span class="n">governors</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">);</span>
			<span class="n">governors</span> <span class="o">=</span> <span class="n">governors</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">governors</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">);</span>
		<span class="n">cpufreq_put_available_governors</span><span class="p">(</span><span class="n">governors</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_get_policy</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  current policy: frequency should be within &quot;</span><span class="p">));</span>
		<span class="n">print_speed</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot; and &quot;</span><span class="p">));</span>
		<span class="n">print_speed</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">                  &quot;</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;The governor </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> may&quot;</span>
		       <span class="s">&quot; decide which speed to use</span><span class="se">\n</span><span class="s">                  within this range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
		       <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">);</span>
		<span class="n">cpufreq_put_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq_kernel</span> <span class="o">||</span> <span class="n">freq_hardware</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  current CPU frequency is &quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq_hardware</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_speed</span><span class="p">(</span><span class="n">freq_hardware</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot; (asserted by call to hardware)&quot;</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">print_speed</span><span class="p">(</span><span class="n">freq_kernel</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="n">cpufreq_get_stats</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;  cpufreq stats: &quot;</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">stats</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_speed</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;:%.2f%%&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">time_in_state</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_time</span><span class="p">);</span>
			<span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cpufreq_put_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">);</span>
		<span class="n">total_trans</span> <span class="o">=</span> <span class="n">cpufreq_get_transitions</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total_trans</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_trans</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">get_boost_mode</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* --freq / -f */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_freq_kernel</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">human</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">cpufreq_get_freq_kernel</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">human</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_speed</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* --hwfreq / -w */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_freq_hardware</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">human</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">cpufreq_get_freq_hardware</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">human</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_speed</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --hwlimits / -l */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_hardware_limits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_get_hardware_limits</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --driver / -d */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_driver</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cpufreq_get_driver</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
	<span class="n">cpufreq_put_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --policy / -p */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_policy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_get_policy</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu %lu %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">);</span>
	<span class="n">cpufreq_put_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --governors / -g */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_available_governors</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_available_governors</span> <span class="o">*</span><span class="n">governors</span> <span class="o">=</span>
		<span class="n">cpufreq_get_available_governors</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">governors</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">governors</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">governors</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">);</span>
		<span class="n">governors</span> <span class="o">=</span> <span class="n">governors</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">governors</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">);</span>
	<span class="n">cpufreq_put_available_governors</span><span class="p">(</span><span class="n">governors</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* --affected-cpus  / -a */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_affected_cpus</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_affected_cpus</span> <span class="o">*</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">cpufreq_get_affected_cpus</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpus</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">cpus</span> <span class="o">=</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">cpufreq_put_affected_cpus</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --related-cpus  / -r */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_related_cpus</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_affected_cpus</span> <span class="o">*</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">cpufreq_get_related_cpus</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpus</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">cpus</span> <span class="o">=</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">cpufreq_put_related_cpus</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --stats / -s */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_freq_stats</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">human</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_trans</span> <span class="o">=</span> <span class="n">cpufreq_get_transitions</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">total_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">cpufreq_get_stats</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_time</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">human</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_speed</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;:%.2f%%&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">time_in_state</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_time</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu:%llu&quot;</span><span class="p">,</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">time_in_state</span><span class="p">);</span>
		<span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cpufreq_put_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_trans</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_trans</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --latency / -y */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_latency</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">human</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">latency</span> <span class="o">=</span> <span class="n">cpufreq_get_transition_latency</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">latency</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">human</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_duration</span><span class="p">(</span><span class="n">latency</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">latency</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">info_opts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;debug&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;e&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;boost&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;b&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;freq&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hwfreq&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;w&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hwlimits&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;l&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;driver&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;policy&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;p&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;governors&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;g&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;related-cpus&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>	<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;r&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;affected-cpus&quot;</span><span class="p">,.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>	<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;stats&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;s&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;latency&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;y&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;o&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;human&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="n">no_argument</span><span class="p">,</span>		<span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;m&#39;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">cmd_freq_info</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">optarg</span><span class="p">;</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">optind</span><span class="p">,</span> <span class="n">opterr</span><span class="p">,</span> <span class="n">optopt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cont</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">human</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">output_param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;oefwldpgrasmyb&quot;</span><span class="p">,</span> <span class="n">info_opts</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">output_param</span> <span class="o">=</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
			<span class="n">cont</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
			<span class="n">cont</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;o&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;a&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;g&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;p&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;y&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">output_param</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">output_param</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">cont</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">output_param</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">human</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">output_param</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">cont</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">human</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;invalid or unknown argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cont</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">output_param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;o&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmask_isallclear</span><span class="p">(</span><span class="n">cpus_chosen</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;The argument passed to this tool can&#39;t be &quot;</span>
				 <span class="s">&quot;combined with passing a --cpu argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">output_param</span> <span class="o">=</span> <span class="sc">&#39;e&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Default is: show output of CPU 0 only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmask_isallclear</span><span class="p">(</span><span class="n">cpus_chosen</span><span class="p">))</span>
		<span class="n">bitmask_setbit</span><span class="p">(</span><span class="n">cpus_chosen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">output_param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;You can&#39;t specify more than one --cpu parameter and/or</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;more than one output-specific argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;invalid or unknown argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;o&#39;</span>:
		<span class="n">proc_cpufreq_output</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">bitmask_first</span><span class="p">(</span><span class="n">cpus_chosen</span><span class="p">);</span>
	     <span class="n">cpu</span> <span class="o">&lt;=</span> <span class="n">bitmask_last</span><span class="p">(</span><span class="n">cpus_chosen</span><span class="p">);</span> <span class="n">cpu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmask_isbitset</span><span class="p">(</span><span class="n">cpus_chosen</span><span class="p">,</span> <span class="n">cpu</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_cpu_exists</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;couldn&#39;t analyze CPU %d as it doesn&#39;t seem to be present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;analyzing CPU %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">cpu</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">output_param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="n">get_boost_mode</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
			<span class="n">debug_output_one</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;a&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_affected_cpus</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_related_cpus</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;g&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_available_governors</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;p&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_policy</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_driver</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_hardware_limits</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_freq_hardware</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">human</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_freq_kernel</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">human</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_freq_stats</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">human</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;y&#39;</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_latency</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">human</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
