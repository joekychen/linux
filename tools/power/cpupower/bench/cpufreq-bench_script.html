<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › power › cpupower › bench › cpufreq-bench_script.sh

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cpufreq-bench_script.sh</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/bash</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2, or (at your option)
any later version.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
02110-1301, USA.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Author/Copyright(c): 2009, Thomas Renninger <a href="&#109;&#97;&#x69;&#108;&#x74;&#111;:&#x74;&#x72;&#101;&#x6E;n&#x40;&#x73;&#x75;&#115;&#101;&#x2E;&#x64;&#x65;">&#x74;&#x72;&#101;&#x6E;n&#x40;&#x73;&#x75;&#115;&#101;&#x2E;&#x64;&#x65;</a>, Novell Inc.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Ondemand up_threshold and sampling rate test script for cpufreq-bench
mircobenchmark.
Modify the general variables at the top or extend or copy out parts
if you want to test other things</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Default with latest kernels is 95, before micro account patches
it was 80, cmp. with git commit 808009131046b62ac434dbc796</p></td><td class="code"><div class="highlight"><pre><span class="nv">UP_THRESHOLD</span><span class="o">=</span><span class="s2">&quot;60 80 95&quot;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Depending on the kernel and the HW sampling rate could be restricted
and cannot be set that low...
E.g. before git commit cef9615a853ebc4972084f7 one could only set
min sampling rate of 80000 if CONFIG_HZ=250</p></td><td class="code"><div class="highlight"><pre><span class="nv">SAMPLING_RATE</span><span class="o">=</span><span class="s2">&quot;20000 80000&quot;</span>

<span class="k">function </span>measure<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local</span> -i up_threshold_set
    <span class="nb">local</span> -i sampling_rate_set

    <span class="k">for </span>up_threshold in <span class="nv">$UP_THRESHOLD</span>;<span class="k">do</span>
<span class="k">	for </span>sampling_rate in <span class="nv">$SAMPLING_RATE</span>;<span class="k">do</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Set values in sysfs</p></td><td class="code"><div class="highlight"><pre>	    <span class="nb">echo</span> <span class="nv">$up_threshold</span> &gt;/sys/devices/system/cpu/cpu0/cpufreq/ondemand/up_threshold
	    <span class="nb">echo</span> <span class="nv">$sampling_rate</span> &gt;/sys/devices/system/cpu/cpu0/cpufreq/ondemand/sampling_rate
	    <span class="nv">up_threshold_set</span><span class="o">=</span><span class="k">$(</span>cat /sys/devices/system/cpu/cpu0/cpufreq/ondemand/up_threshold<span class="k">)</span>
	    <span class="nv">sampling_rate_set</span><span class="o">=</span><span class="k">$(</span>cat /sys/devices/system/cpu/cpu0/cpufreq/ondemand/sampling_rate<span class="k">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Verify set values in sysfs</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">up_threshold_set</span><span class="k">}</span> -eq <span class="k">${</span><span class="nv">up_threshold</span><span class="k">}</span> <span class="o">]</span>;<span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;up_threshold: $up_threshold, set in sysfs: ${up_threshold_set}&quot;</span>
	    <span class="k">else</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;WARNING: Tried to set up_threshold: $up_threshold, set in sysfs: ${up_threshold_set}&quot;</span>
	    <span class="k">fi</span>
<span class="k">	    if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">sampling_rate_set</span><span class="k">}</span> -eq <span class="k">${</span><span class="nv">sampling_rate</span><span class="k">}</span> <span class="o">]</span>;<span class="k">then</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;sampling_rate: $sampling_rate, set in sysfs: ${sampling_rate_set}&quot;</span>
	    <span class="k">else</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;WARNING: Tried to set sampling_rate: $sampling_rate, set in sysfs: ${sampling_rate_set}&quot;</span>
	    <span class="k">fi</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Benchmark</p></td><td class="code"><div class="highlight"><pre>	    cpufreq-bench -o /var/log/cpufreq-bench/up_threshold_<span class="k">${</span><span class="nv">up_threshold</span><span class="k">}</span>_sampling_rate_<span class="k">${</span><span class="nv">sampling_rate</span><span class="k">}</span>
	<span class="k">done</span>
<span class="k">    done</span>
<span class="o">}</span>

<span class="k">function </span>create_plots<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local command</span>

<span class="nb">    </span><span class="k">for </span>up_threshold in <span class="nv">$UP_THRESHOLD</span>;<span class="k">do</span>
<span class="k">	</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;cpufreq-bench_plot.sh -o \&quot;sampling_rate_${SAMPLING_RATE}_up_threshold_${up_threshold}\&quot; -t \&quot;Ondemand sampling_rate: ${SAMPLING_RATE} comparison - Up_threshold: $up_threshold %\&quot;&quot;</span>
	<span class="k">for </span>sampling_rate in <span class="nv">$SAMPLING_RATE</span>;<span class="k">do</span>
<span class="k">	    </span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;${command} /var/log/cpufreq-bench/up_threshold_${up_threshold}_sampling_rate_${sampling_rate}/* \&quot;sampling_rate = $sampling_rate\&quot;&quot;</span>
	<span class="k">done</span>
<span class="k">	</span><span class="nb">echo</span> <span class="nv">$command</span>
	<span class="nb">eval</span> <span class="s2">&quot;$command&quot;</span>
	<span class="nb">echo</span>
<span class="nb">    </span><span class="k">done</span>

<span class="k">    for </span>sampling_rate in <span class="nv">$SAMPLING_RATE</span>;<span class="k">do</span>
<span class="k">	</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;cpufreq-bench_plot.sh -o \&quot;up_threshold_${UP_THRESHOLD}_sampling_rate_${sampling_rate}\&quot; -t \&quot;Ondemand up_threshold: ${UP_THRESHOLD} % comparison - sampling_rate: $sampling_rate\&quot;&quot;</span>
	<span class="k">for </span>up_threshold in <span class="nv">$UP_THRESHOLD</span>;<span class="k">do</span>
<span class="k">	    </span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;${command} /var/log/cpufreq-bench/up_threshold_${up_threshold}_sampling_rate_${sampling_rate}/* \&quot;up_threshold = $up_threshold\&quot;&quot;</span>
	<span class="k">done</span>
<span class="k">	</span><span class="nb">echo</span> <span class="nv">$command</span>
	<span class="nb">eval</span> <span class="s2">&quot;$command&quot;</span>
	<span class="nb">echo</span>
<span class="nb">    </span><span class="k">done</span>

<span class="k">    </span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;cpufreq-bench_plot.sh -o \&quot;up_threshold_${UP_THRESHOLD}_sampling_rate_${SAMPLING_RATE}\&quot; -t \&quot;Ondemand up_threshold: ${UP_THRESHOLD} and sampling_rate ${SAMPLING_RATE} comparison\&quot;&quot;</span>
    <span class="k">for </span>sampling_rate in <span class="nv">$SAMPLING_RATE</span>;<span class="k">do</span>
<span class="k">	for </span>up_threshold in <span class="nv">$UP_THRESHOLD</span>;<span class="k">do</span>
<span class="k">	    </span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;${command} /var/log/cpufreq-bench/up_threshold_${up_threshold}_sampling_rate_${sampling_rate}/* \&quot;up_threshold = $up_threshold - sampling_rate = $sampling_rate\&quot;&quot;</span>
	<span class="k">done</span>
<span class="k">    done</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;$command&quot;</span>
    <span class="nb">eval</span> <span class="s2">&quot;$command&quot;</span>
<span class="o">}</span>

measure
create_plots

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
