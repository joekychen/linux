<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › builtin-top.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>builtin-top.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * builtin-top.c</span>
<span class="cm"> *</span>
<span class="cm"> * Builtin top command: Display a continuously updated profile of</span>
<span class="cm"> * any workload, CPU or specific PID.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008, Red Hat Inc, Ingo Molnar &lt;mingo@redhat.com&gt;</span>
<span class="cm"> *		 2011, Red Hat Inc, Arnaldo Carvalho de Melo &lt;acme@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Improvements and fixes by:</span>
<span class="cm"> *</span>
<span class="cm"> *   Arjan van de Ven &lt;arjan@linux.intel.com&gt;</span>
<span class="cm"> *   Yanmin Zhang &lt;yanmin.zhang@intel.com&gt;</span>
<span class="cm"> *   Wu Fengguang &lt;fengguang.wu@intel.com&gt;</span>
<span class="cm"> *   Mike Galbraith &lt;efault@gmx.de&gt;</span>
<span class="cm"> *   Paul Mackerras &lt;paulus@samba.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Released under the GPL v2. (and only v2, not any later version)</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;builtin.h&quot;</span>

<span class="cp">#include &quot;perf.h&quot;</span>

<span class="cp">#include &quot;util/annotate.h&quot;</span>
<span class="cp">#include &quot;util/cache.h&quot;</span>
<span class="cp">#include &quot;util/color.h&quot;</span>
<span class="cp">#include &quot;util/evlist.h&quot;</span>
<span class="cp">#include &quot;util/evsel.h&quot;</span>
<span class="cp">#include &quot;util/session.h&quot;</span>
<span class="cp">#include &quot;util/symbol.h&quot;</span>
<span class="cp">#include &quot;util/thread.h&quot;</span>
<span class="cp">#include &quot;util/thread_map.h&quot;</span>
<span class="cp">#include &quot;util/top.h&quot;</span>
<span class="cp">#include &quot;util/util.h&quot;</span>
<span class="cp">#include &lt;linux/rbtree.h&gt;</span>
<span class="cp">#include &quot;util/parse-options.h&quot;</span>
<span class="cp">#include &quot;util/parse-events.h&quot;</span>
<span class="cp">#include &quot;util/cpumap.h&quot;</span>
<span class="cp">#include &quot;util/xyarray.h&quot;</span>
<span class="cp">#include &quot;util/sort.h&quot;</span>

<span class="cp">#include &quot;util/debug.h&quot;</span>

<span class="cp">#include &lt;assert.h&gt;</span>
<span class="cp">#include &lt;elf.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>

<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;termios.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;inttypes.h&gt;</span>

<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;time.h&gt;</span>
<span class="cp">#include &lt;sched.h&gt;</span>

<span class="cp">#include &lt;sys/syscall.h&gt;</span>
<span class="cp">#include &lt;sys/ioctl.h&gt;</span>
<span class="cp">#include &lt;sys/poll.h&gt;</span>
<span class="cp">#include &lt;sys/prctl.h&gt;</span>
<span class="cp">#include &lt;sys/wait.h&gt;</span>
<span class="cp">#include &lt;sys/uio.h&gt;</span>
<span class="cp">#include &lt;sys/utsname.h&gt;</span>
<span class="cp">#include &lt;sys/mman.h&gt;</span>

<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="kt">void</span> <span class="nf">get_term_dimensions</span><span class="p">(</span><span class="k">struct</span> <span class="n">winsize</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;LINES&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_row</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;COLUMNS&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_col</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_row</span> <span class="o">&amp;&amp;</span> <span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_col</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef TIOCGWINSZ</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="n">ws</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_row</span> <span class="o">&amp;&amp;</span> <span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_col</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_row</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
	<span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_col</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__update_print_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span> <span class="o">-=</span> <span class="mi">9</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__sig_winch</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span> <span class="n">__used</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">get_term_dimensions</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_row</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_row</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_row</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">perf_top__update_print_entries</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_top__parse_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hist_entry</span> <span class="o">*</span><span class="n">he</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">he</span> <span class="o">||</span> <span class="o">!</span><span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sym</span> <span class="o">=</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span><span class="p">;</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">map</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can&#39;t annotate with just /proc/kallsyms</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">symtab_type</span> <span class="o">==</span> <span class="n">SYMTAB__KALLSYMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t annotate %s: No vmlinux file was found in the &quot;</span>
		       <span class="s">&quot;path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_assign</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symbol__alloc_hist</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Not enough memory for annotating &#39;%s&#39; symbol!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">symbol__annotate</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">out_assign:</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span> <span class="o">=</span> <span class="n">he</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__zero_source_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">hist_entry</span> <span class="o">*</span><span class="n">he</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span> <span class="o">=</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span><span class="p">;</span>
	<span class="n">symbol__annotate_zero_histograms</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ui__warn_map_erange</span><span class="p">(</span><span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">utsname</span> <span class="n">uts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">uname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts</span><span class="p">);</span>

	<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;Out of bounds address found:</span><span class="se">\n\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Addr:   %&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;DSO:    %s %c</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Map:    %&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;-%&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Symbol: %&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;-%&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; %c %s</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Arch:   %s</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Kernel: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Tools:  %s</span><span class="se">\n\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Not all samples will be on the annotation output.</span><span class="se">\n\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;Please report to linux-kernel@vger.kernel.org</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ip</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span> <span class="n">dso__symtab_origin</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">),</span>
		    <span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
		    <span class="n">sym</span><span class="o">-&gt;</span><span class="n">binding</span> <span class="o">==</span> <span class="n">STB_GLOBAL</span> <span class="o">?</span> <span class="sc">&#39;g&#39;</span> <span class="o">:</span>
		    <span class="n">sym</span><span class="o">-&gt;</span><span class="n">binding</span> <span class="o">==</span> <span class="n">STB_LOCAL</span>  <span class="o">?</span> <span class="sc">&#39;l&#39;</span> <span class="o">:</span> <span class="sc">&#39;w&#39;</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">err</span> <span class="o">?</span> <span class="s">&quot;[unknown]&quot;</span> <span class="o">:</span> <span class="n">uts</span><span class="p">.</span><span class="n">machine</span><span class="p">,</span>
		    <span class="n">err</span> <span class="o">?</span> <span class="s">&quot;[unknown]&quot;</span> <span class="o">:</span> <span class="n">uts</span><span class="p">.</span><span class="n">release</span><span class="p">,</span> <span class="n">perf_version_string</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_browser</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">erange_warned</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__record_precise_ip</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">hist_entry</span> <span class="o">*</span><span class="n">he</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">counter</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	      <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span> <span class="o">!=</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">use_browser</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sym</span> <span class="o">=</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span><span class="p">;</span>
	<span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pthread_mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">symbol__alloc_hist</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Not enough memory for annotating &#39;%s&#39; symbol!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ip</span> <span class="o">=</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">map_ip</span><span class="p">(</span><span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">symbol__inc_addr_samples</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERANGE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">erange_warned</span><span class="p">)</span>
		<span class="n">ui__warn_map_erange</span><span class="p">(</span><span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__show_details</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hist_entry</span> <span class="o">*</span><span class="n">he</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">symbol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">more</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">he</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">symbol</span> <span class="o">=</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span><span class="p">;</span>
	<span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">symbol</span><span class="p">);</span>

	<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Showing %s for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="p">),</span> <span class="n">symbol</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  Events  Pcnt (&gt;=%d%%)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_pcnt_filter</span><span class="p">);</span>

	<span class="n">more</span> <span class="o">=</span> <span class="n">symbol__annotate_printf</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_pcnt_filter</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">)</span>
		<span class="n">symbol__annotate_zero_histogram</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">symbol__annotate_decay_histogram</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">more</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d lines not displayed, maybe increase display entries [e]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">more</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>		<span class="n">CONSOLE_CLEAR</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;[H[2J&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hist_entry</span> <span class="o">*</span><span class="nf">perf_evsel__add_hist_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">addr_location</span> <span class="o">*</span><span class="n">al</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hist_entry</span> <span class="o">*</span><span class="n">he</span><span class="p">;</span>

	<span class="n">he</span> <span class="o">=</span> <span class="n">__hists__add_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span> <span class="n">al</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hists__inc_nr_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span> <span class="n">PERF_RECORD_SAMPLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">he</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__print_sym_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">bf</span><span class="p">[</span><span class="mi">160</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">win_width</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">puts</span><span class="p">(</span><span class="n">CONSOLE_CLEAR</span><span class="p">);</span>

	<span class="n">perf_top__header_snprintf</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bf</span><span class="p">));</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>

	<span class="n">perf_top__reset_sample_counters</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-*.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">win_width</span><span class="p">,</span> <span class="n">win_width</span><span class="p">,</span> <span class="n">graph_dotted_line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_lost_warned</span> <span class="o">!=</span>
	    <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_events</span><span class="p">[</span><span class="n">PERF_RECORD_LOST</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_lost_warned</span> <span class="o">=</span>
			<span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_events</span><span class="p">[</span><span class="n">PERF_RECORD_LOST</span><span class="p">];</span>
		<span class="n">color_fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">PERF_COLOR_RED</span><span class="p">,</span>
			      <span class="s">&quot;WARNING: LOST %d chunks, Check IO/CPU overload&quot;</span><span class="p">,</span>
			      <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_lost_warned</span><span class="p">);</span>
		<span class="o">++</span><span class="n">printed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perf_top__show_details</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hists__collapse_resort_threaded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">);</span>
	<span class="n">hists__output_resort_threaded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">);</span>
	<span class="n">hists__decay_entries_threaded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span>
				      <span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_user_symbols</span><span class="p">,</span>
				      <span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_kernel_symbols</span><span class="p">);</span>
	<span class="n">hists__output_recalc_col_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span>
				     <span class="n">top</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_row</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="n">hists__fprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
		       <span class="n">top</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_row</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">printed</span><span class="p">,</span> <span class="n">win_width</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prompt_integer</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s: &quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prompt_percent</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">prompt_integer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
		<span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__prompt_symbol</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hist_entry</span> <span class="o">*</span><span class="n">syme</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">found</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* zero counters of active symbol */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">syme</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__zero_source_counters</span><span class="p">(</span><span class="n">syme</span><span class="p">);</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s: &quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">next</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">entries</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hist_entry</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Sorry, %s is not active.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">perf_top__parse_source</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__print_mapped_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">.</span><span class="n">sym</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Mapped keys:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[d]     display refresh delay.             </span><span class="se">\t</span><span class="s">(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">delay_secs</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[e]     display entries (lines).           </span><span class="se">\t</span><span class="s">(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[E]     active event counter.              </span><span class="se">\t</span><span class="s">(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="p">));</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[f]     profile display filter (count).    </span><span class="se">\t</span><span class="s">(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">count_filter</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[F]     annotate display filter (percent). </span><span class="se">\t</span><span class="s">(%d%%)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_pcnt_filter</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[s]     annotate symbol.                   </span><span class="se">\t</span><span class="s">(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">?:</span> <span class="s">&quot;NULL&quot;</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[S]     stop annotation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span>
		<span class="s">&quot;</span><span class="se">\t</span><span class="s">[K]     hide kernel_symbols symbols.     </span><span class="se">\t</span><span class="s">(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_kernel_symbols</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span>
		<span class="s">&quot;</span><span class="se">\t</span><span class="s">[U]     hide user symbols.               </span><span class="se">\t</span><span class="s">(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_user_symbols</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[z]     toggle sample zeroing.             </span><span class="se">\t</span><span class="s">(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[qQ]    quit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_top__key_mapped</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;z&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;q&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;Q&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;U&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;F&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;S&#39;</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
			<span class="k">return</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__handle_keypress</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_top__key_mapped</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pollfd</span> <span class="n">stdin_poll</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="p">};</span>
		<span class="k">struct</span> <span class="n">termios</span> <span class="n">tc</span><span class="p">,</span> <span class="n">save</span><span class="p">;</span>

		<span class="n">perf_top__print_mapped_keys</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Enter selection, or unmapped key to continue: &quot;</span><span class="p">);</span>
		<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

		<span class="n">tcgetattr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save</span><span class="p">);</span>
		<span class="n">tc</span> <span class="o">=</span> <span class="n">save</span><span class="p">;</span>
		<span class="n">tc</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICANON</span> <span class="o">|</span> <span class="n">ECHO</span><span class="p">);</span>
		<span class="n">tc</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tc</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tcsetattr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc</span><span class="p">);</span>

		<span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stdin_poll</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>

		<span class="n">tcsetattr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_top__key_mapped</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="n">prompt_integer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">delay_secs</span><span class="p">,</span> <span class="s">&quot;Enter display delay&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">delay_secs</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">top</span><span class="o">-&gt;</span><span class="n">delay_secs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
			<span class="n">prompt_integer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span><span class="p">,</span> <span class="s">&quot;Enter display entries (lines)&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">print_entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sigaction</span> <span class="n">act</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">sa_sigaction</span> <span class="o">=</span> <span class="n">perf_top__sig_winch</span><span class="p">,</span>
					<span class="p">.</span><span class="n">sa_flags</span>     <span class="o">=</span> <span class="n">SA_SIGINFO</span><span class="p">,</span>
				<span class="p">};</span>
				<span class="n">perf_top__sig_winch</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">top</span><span class="p">);</span>
				<span class="n">sigaction</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">perf_top__sig_winch</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">top</span><span class="p">);</span>
				<span class="n">signal</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="n">SIG_DFL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Select 0 as the default event: */</span>
				<span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Available events:&quot;</span><span class="p">);</span>

				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">%d %s&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">event_name</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="p">));</span>

				<span class="n">prompt_integer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span> <span class="s">&quot;Enter details event counter&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Sorry, no such event, using %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="p">));</span>
					<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">==</span> <span class="n">counter</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_evsel</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
			<span class="n">prompt_integer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">count_filter</span><span class="p">,</span> <span class="s">&quot;Enter display event count filter&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;F&#39;</span>:
			<span class="n">prompt_percent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_pcnt_filter</span><span class="p">,</span>
				       <span class="s">&quot;Enter details display event filter (percent)&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
			<span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_kernel_symbols</span> <span class="o">=</span> <span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_kernel_symbols</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;q&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;Q&#39;</span>:
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">dump_symtab</span><span class="p">)</span>
				<span class="n">perf_session__fprintf_dsos</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="n">perf_top__prompt_symbol</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="s">&quot;Enter details symbol&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;S&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">hist_entry</span> <span class="o">*</span><span class="n">syme</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span><span class="p">;</span>

				<span class="n">top</span><span class="o">-&gt;</span><span class="n">sym_filter_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">__zero_source_counters</span><span class="p">(</span><span class="n">syme</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;U&#39;</span>:
			<span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_user_symbols</span> <span class="o">=</span> <span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_user_symbols</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;z&#39;</span>:
			<span class="n">top</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__sort_new_samples</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">perf_top__reset_sample_counters</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">selected</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">sym_evsel</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">selected</span><span class="p">;</span>

	<span class="n">hists__collapse_resort_threaded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">);</span>
	<span class="n">hists__output_resort_threaded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">);</span>
	<span class="n">hists__decay_entries_threaded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sym_evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span>
				      <span class="n">t</span><span class="o">-&gt;</span><span class="n">hide_user_symbols</span><span class="p">,</span>
				      <span class="n">t</span><span class="o">-&gt;</span><span class="n">hide_kernel_symbols</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">display_thread_tui</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">help</span> <span class="o">=</span> <span class="s">&quot;For a higher level overview, try: perf top --sort comm,dso&quot;</span><span class="p">;</span>

	<span class="n">perf_top__sort_new_samples</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the uid_filter_str, in the future the TUI will allow</span>
<span class="cm">	 * Zooming in/out UIDs. For now juse use whatever the user passed</span>
<span class="cm">	 * via --uid.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">pos</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">uid_filter_str</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">uid_str</span><span class="p">;</span>

	<span class="n">perf_evlist__tui_browse_hists</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span>
				      <span class="n">perf_top__sort_new_samples</span><span class="p">,</span>
				      <span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">delay_secs</span><span class="p">);</span>

	<span class="n">exit_browser</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">display_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pollfd</span> <span class="n">stdin_poll</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">termios</span> <span class="n">tc</span><span class="p">,</span> <span class="n">save</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delay_msecs</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">tcgetattr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save</span><span class="p">);</span>
	<span class="n">tc</span> <span class="o">=</span> <span class="n">save</span><span class="p">;</span>
	<span class="n">tc</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICANON</span> <span class="o">|</span> <span class="n">ECHO</span><span class="p">);</span>
	<span class="n">tc</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pthread__unblock_sigwinch</span><span class="p">();</span>
<span class="nl">repeat:</span>
	<span class="n">delay_msecs</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">delay_secs</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tcsetattr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc</span><span class="p">);</span>
	<span class="cm">/* trash return*/</span>
	<span class="n">getc</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perf_top__print_sym_table</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Either timeout expired or we got an EINTR due to SIGWINCH,</span>
<span class="cm">		 * refresh screen in both cases.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stdin_poll</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">delay_msecs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Fall trhu */</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">process_hotkey</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">process_hotkey:</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
	<span class="n">tcsetattr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save</span><span class="p">);</span>

	<span class="n">perf_top__handle_keypress</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tag samples to be skipped. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">skip_symbols</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;intel_idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;default_idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;native_safe_halt&quot;</span><span class="p">,</span>
	<span class="s">&quot;cpu_idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;enter_idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;exit_idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;mwait_idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;mwait_idle_with_hints&quot;</span><span class="p">,</span>
	<span class="s">&quot;poll_idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;ppc64_runlatch_off&quot;</span><span class="p">,</span>
	<span class="s">&quot;pseries_dedicated_idle_sleep&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">symbol_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span> <span class="n">__used</span><span class="p">,</span> <span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ppc64 uses function descriptors and appends a &#39;.&#39; to the</span>
<span class="cm">	 * start of every instruction address. Remove it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span>
		<span class="n">name</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;_text&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;_etext&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;_sinittext&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;init_module&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;cleanup_module&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">strstr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;_text_start&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">strstr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;_text_end&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">skip_symbols</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">skip_symbols</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sym</span><span class="o">-&gt;</span><span class="n">ignore</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__process_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_top</span><span class="p">,</span> <span class="n">tool</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">addr_location</span> <span class="n">al</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine</span> <span class="o">&amp;&amp;</span> <span class="n">perf_guest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t find guest [%d]&#39;s kernel information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%u unprocessable samples recorded.&quot;</span><span class="p">,</span>
		       <span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unprocessable_samples</span><span class="o">++</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">PERF_RECORD_MISC_EXACT_IP</span><span class="p">)</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">exact_samples</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_event__preprocess_sample</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span>
					  <span class="n">symbol_filter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">al</span><span class="p">.</span><span class="n">filtered</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">kptr_restrict_warned</span> <span class="o">&amp;&amp;</span>
	    <span class="n">symbol_conf</span><span class="p">.</span><span class="n">kptr_restrict</span> <span class="o">&amp;&amp;</span>
	    <span class="n">al</span><span class="p">.</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_KERNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ui__warning</span><span class="p">(</span>
<span class="s">&quot;Kernel address maps (/proc/{kallsyms,modules}) are restricted.</span><span class="se">\n\n</span><span class="s">&quot;</span>
<span class="s">&quot;Check /proc/sys/kernel/kptr_restrict.</span><span class="se">\n\n</span><span class="s">&quot;</span>
<span class="s">&quot;Kernel%s samples will not be resolved.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="o">!</span><span class="n">RB_EMPTY_ROOT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">al</span><span class="p">.</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">symbols</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">])</span> <span class="o">?</span>
			  <span class="s">&quot; modules&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_browser</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">kptr_restrict_warned</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">al</span><span class="p">.</span><span class="n">sym</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Kernel samples will not be resolved.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * As we do lazy loading of symtabs we only will know if the</span>
<span class="cm">		 * specified vmlinux file is invalid when we actually have a</span>
<span class="cm">		 * hit in kernel space and then try to load it. So if we get</span>
<span class="cm">		 * here and there are _no_ symbols in the DSO backing the</span>
<span class="cm">		 * kernel map, bail out.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We may never get here, for instance, if we use -K/</span>
<span class="cm">		 * --hide-kernel-symbols, even if the user specifies an</span>
<span class="cm">		 * invalid --vmlinux ;-)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">kptr_restrict_warned</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vmlinux_warned</span> <span class="o">&amp;&amp;</span>
		    <span class="n">al</span><span class="p">.</span><span class="n">map</span> <span class="o">==</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">vmlinux_maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">RB_EMPTY_ROOT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">al</span><span class="p">.</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">symbols</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">]))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">vmlinux_name</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;The %s file can&#39;t be used.</span><span class="se">\n</span><span class="s">%s&quot;</span><span class="p">,</span>
					    <span class="n">symbol_conf</span><span class="p">.</span><span class="n">vmlinux_name</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;A vmlinux file was not found.</span><span class="se">\n</span><span class="s">%s&quot;</span><span class="p">,</span>
					    <span class="n">msg</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">use_browser</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">top</span><span class="o">-&gt;</span><span class="n">vmlinux_warned</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">al</span><span class="p">.</span><span class="n">sym</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">al</span><span class="p">.</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hist_entry</span> <span class="o">*</span><span class="n">he</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sort__has_parent</span> <span class="o">||</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">use_callchain</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sample</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">machine__resolve_callchain</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">al</span><span class="p">.</span><span class="kr">thread</span><span class="p">,</span>
							 <span class="n">sample</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">he</span> <span class="o">=</span> <span class="n">perf_evsel__add_hist_entry</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al</span><span class="p">,</span> <span class="n">sample</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">he</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Problem incrementing symbol period, skipping event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">use_callchain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">callchain_append</span><span class="p">(</span><span class="n">he</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callchain_cursor</span><span class="p">,</span>
					       <span class="n">sample</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sort_has_symbols</span><span class="p">)</span>
			<span class="n">perf_top__record_precise_ip</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">he</span><span class="p">,</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__mmap_read_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_sample</span> <span class="n">sample</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">origin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">event</span> <span class="o">=</span> <span class="n">perf_evlist__mmap_read</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">perf_session__parse_sample</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t parse sample, err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">evsel</span> <span class="o">=</span> <span class="n">perf_evlist__id2evsel</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">,</span> <span class="n">sample</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="n">assert</span><span class="p">(</span><span class="n">evsel</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">origin</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">PERF_RECORD_MISC_CPUMODE_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_RECORD_SAMPLE</span><span class="p">)</span>
			<span class="o">++</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">origin</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PERF_RECORD_MISC_USER</span>:
			<span class="o">++</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">us_samples</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_user_symbols</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">machine</span> <span class="o">=</span> <span class="n">perf_session__find_host_machine</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PERF_RECORD_MISC_KERNEL</span>:
			<span class="o">++</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">kernel_samples</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">hide_kernel_symbols</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">machine</span> <span class="o">=</span> <span class="n">perf_session__find_host_machine</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span>:
			<span class="o">++</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">guest_kernel_samples</span><span class="p">;</span>
			<span class="n">machine</span> <span class="o">=</span> <span class="n">perf_session__find_machine</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PERF_RECORD_MISC_GUEST_USER</span>:
			<span class="o">++</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">guest_us_samples</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * TODO: we don&#39;t process guest user from host side</span>
<span class="cm">			 * except simple counting.</span>
<span class="cm">			 */</span>
			<span class="cm">/* Fall thru */</span>
		<span class="nl">default:</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_RECORD_SAMPLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perf_event__process_sample</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">PERF_RECORD_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hists__inc_nr_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
			<span class="n">perf_event__process</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">++</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unknown_events</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__mmap_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_mmaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">perf_top__mmap_read_idx</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_top__start_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">;</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">xyarray</span> <span class="o">*</span><span class="n">group_fd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">counter</span> <span class="o">!=</span> <span class="n">first</span><span class="p">)</span>
			<span class="n">group_fd</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>

		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">=</span> <span class="n">PERF_SAMPLE_IP</span> <span class="o">|</span> <span class="n">PERF_SAMPLE_TID</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">|=</span> <span class="n">PERF_SAMPLE_PERIOD</span><span class="p">;</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">freq</span>	  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_freq</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">|=</span> <span class="n">PERF_SAMPLE_ID</span><span class="p">;</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">read_format</span> <span class="o">|=</span> <span class="n">PERF_FORMAT_ID</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">perf_target__has_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">))</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">|=</span> <span class="n">PERF_SAMPLE_CPU</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">use_callchain</span><span class="p">)</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">|=</span> <span class="n">PERF_SAMPLE_CALLCHAIN</span><span class="p">;</span>

		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">mmap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">comm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">inherit</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">inherit</span><span class="p">;</span>
<span class="nl">fallback_missing_features:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">exclude_guest_missing</span><span class="p">)</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">exclude_guest</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">exclude_host</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">retry_sample_id:</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_id_all</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">sample_id_all_missing</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">try_again:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__open</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span>
				     <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span>
				     <span class="n">group_fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">EPERM</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="n">EACCES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ui__error_paranoid</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">exclude_guest_missing</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">exclude_guest</span> <span class="o">||</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">exclude_host</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Old kernel, cannot exclude &quot;</span>
						 <span class="s">&quot;guest or host samples.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">top</span><span class="o">-&gt;</span><span class="n">exclude_guest_missing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">fallback_missing_features</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sample_id_all_missing</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Old kernel, no attr-&gt;sample_id_type_all field</span>
<span class="cm">					 */</span>
					<span class="n">top</span><span class="o">-&gt;</span><span class="n">sample_id_all_missing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">retry_sample_id</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * If it&#39;s cycles then fall back to hrtimer</span>
<span class="cm">			 * based cpu-clock-tick sw counter, which</span>
<span class="cm">			 * is always available even if no PMU support:</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_HARDWARE</span> <span class="o">&amp;&amp;</span>
			    <span class="n">attr</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">==</span> <span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
					<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;Cycles event not supported,</span><span class="se">\n</span><span class="s">&quot;</span>
						    <span class="s">&quot;trying to fall back to cpu-clock-ticks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_SOFTWARE</span><span class="p">;</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_SW_CPU_CLOCK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">free</span><span class="p">(</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">counter</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;The %s event is not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">event_name</span><span class="p">(</span><span class="n">counter</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">EMFILE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;Too many events are opened.</span><span class="se">\n</span><span class="s">&quot;</span>
					    <span class="s">&quot;Try again after reducing the number of events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;The sys_perf_event_open() syscall &quot;</span>
				    <span class="s">&quot;returned with %d (%s).  /bin/dmesg &quot;</span>
				    <span class="s">&quot;may provide additional information.</span><span class="se">\n</span><span class="s">&quot;</span>
				    <span class="s">&quot;No CONFIG_PERF_EVENTS=y kernel support &quot;</span>
				    <span class="s">&quot;configured?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evlist__mmap</span><span class="p">(</span><span class="n">evlist</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">mmap_pages</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;Failed to mmap with %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">errno</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">exit_browser</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_top__setup_sample_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">sort_has_symbols</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">use_callchain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;Selected -g but </span><span class="se">\&quot;</span><span class="s">sym</span><span class="se">\&quot;</span><span class="s"> not present in --sort/-s.&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">dont_use_callchains</span> <span class="o">&amp;&amp;</span> <span class="n">callchain_param</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">CHAIN_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">callchain_register_param</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callchain_param</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;Can&#39;t register callchain params.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__cmd_top</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pthread_t</span> <span class="kr">thread</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME: perf_session__new should allow passing a O_MMAP, so that all this</span>
<span class="cm">	 * mmap reading, etc is encapsulated in it. Use O_WRONLY for now.</span>
<span class="cm">	 */</span>
	<span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">=</span> <span class="n">perf_session__new</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">perf_top__setup_sample_type</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_delete</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_target__has_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">))</span>
		<span class="n">perf_event__synthesize_thread_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">tool</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">,</span>
						  <span class="n">perf_event__process</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">perf_event__synthesize_threads</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">tool</span><span class="p">,</span> <span class="n">perf_event__process</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">);</span>
	<span class="n">perf_top__start_counters</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>
	<span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">;</span>
	<span class="n">perf_session__update_sample_type</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">);</span>

	<span class="cm">/* Wait for a minimal set of events before starting the snapshot */</span>
	<span class="n">poll</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">pollfd</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_fds</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">perf_top__mmap_read</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">use_browser</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">display_thread_tui</span> <span class="o">:</span>
							    <span class="n">display_thread</span><span class="p">),</span> <span class="n">top</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;Could not create display thread.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">realtime_prio</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sched_param</span> <span class="n">param</span><span class="p">;</span>

		<span class="n">param</span><span class="p">.</span><span class="n">sched_priority</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">realtime_prio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sched_setscheduler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SCHED_FIFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;Could not set realtime priority.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">;</span>

		<span class="n">perf_top__mmap_read</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hits</span> <span class="o">==</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">pollfd</span><span class="p">,</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_fds</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_delete:</span>
	<span class="n">perf_session__delete</span><span class="p">(</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">);</span>
	<span class="n">top</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_callchain_opt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">perf_top</span> <span class="o">*</span><span class="p">)</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="o">*</span><span class="n">tok2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * --no-call-graph</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top</span><span class="o">-&gt;</span><span class="n">dont_use_callchains</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">symbol_conf</span><span class="p">.</span><span class="n">use_callchain</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tok</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tok</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* get the output mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="s">&quot;graph&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
		<span class="n">callchain_param</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">CHAIN_GRAPH_ABS</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="s">&quot;flat&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
		<span class="n">callchain_param</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">CHAIN_FLAT</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="s">&quot;fractal&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
		<span class="n">callchain_param</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">CHAIN_GRAPH_REL</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">callchain_param</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">CHAIN_NONE</span><span class="p">;</span>
		<span class="n">symbol_conf</span><span class="p">.</span><span class="n">use_callchain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* get the min percentage */</span>
	<span class="n">tok</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tok</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">setup</span><span class="p">;</span>

	<span class="n">callchain_param</span><span class="p">.</span><span class="n">min_percent</span> <span class="o">=</span> <span class="n">strtod</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tok</span> <span class="o">==</span> <span class="n">endptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* get the print limit */</span>
	<span class="n">tok2</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tok2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">setup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tok2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;c&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">callchain_param</span><span class="p">.</span><span class="n">print_limit</span> <span class="o">=</span> <span class="n">strtod</span><span class="p">(</span><span class="n">tok2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endptr</span><span class="p">);</span>
		<span class="n">tok2</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tok2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">setup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the call chain order */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">tok2</span><span class="p">,</span> <span class="s">&quot;caller&quot;</span><span class="p">))</span>
		<span class="n">callchain_param</span><span class="p">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">ORDER_CALLER</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">tok2</span><span class="p">,</span> <span class="s">&quot;callee&quot;</span><span class="p">))</span>
		<span class="n">callchain_param</span><span class="p">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">ORDER_CALLEE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nl">setup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">callchain_register_param</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callchain_param</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Can&#39;t register callchain params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">top_usage</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;perf top [&lt;options&gt;]&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">cmd_top</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">errbuf</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">perf_top</span> <span class="n">top</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">count_filter</span>	     <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">delay_secs</span>	     <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">freq</span>		     <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span> <span class="cm">/* 4 KHz */</span>
		<span class="p">.</span><span class="n">mmap_pages</span>	     <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_pcnt_filter</span>     <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">target</span>		     <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">uses_mmap</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">char</span> <span class="n">callchain_default_opt</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;fractal,0.5,callee&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">OPT_CALLBACK</span><span class="p">(</span><span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="s">&quot;event&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">evlist</span><span class="p">,</span> <span class="s">&quot;event&quot;</span><span class="p">,</span>
		     <span class="s">&quot;event selector. use &#39;perf list&#39; to list available events&quot;</span><span class="p">,</span>
		     <span class="n">parse_events_option</span><span class="p">),</span>
	<span class="n">OPT_INTEGER</span><span class="p">(</span><span class="sc">&#39;c&#39;</span><span class="p">,</span> <span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">default_interval</span><span class="p">,</span>
		    <span class="s">&quot;event period to sample&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;p&#39;</span><span class="p">,</span> <span class="s">&quot;pid&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="s">&quot;pid&quot;</span><span class="p">,</span>
		    <span class="s">&quot;profile events on existing process id&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="s">&quot;tid&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span> <span class="s">&quot;tid&quot;</span><span class="p">,</span>
		    <span class="s">&quot;profile events on existing thread id&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="s">&quot;all-cpus&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">system_wide</span><span class="p">,</span>
			    <span class="s">&quot;system-wide collection from all CPUs&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">cpu_list</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">,</span>
		    <span class="s">&quot;list of cpus to monitor&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;k&#39;</span><span class="p">,</span> <span class="s">&quot;vmlinux&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">vmlinux_name</span><span class="p">,</span>
		   <span class="s">&quot;file&quot;</span><span class="p">,</span> <span class="s">&quot;vmlinux pathname&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="s">&quot;hide_kernel_symbols&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">hide_kernel_symbols</span><span class="p">,</span>
		    <span class="s">&quot;hide kernel symbols&quot;</span><span class="p">),</span>
	<span class="n">OPT_UINTEGER</span><span class="p">(</span><span class="sc">&#39;m&#39;</span><span class="p">,</span> <span class="s">&quot;mmap-pages&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">mmap_pages</span><span class="p">,</span> <span class="s">&quot;number of mmap data pages&quot;</span><span class="p">),</span>
	<span class="n">OPT_INTEGER</span><span class="p">(</span><span class="sc">&#39;r&#39;</span><span class="p">,</span> <span class="s">&quot;realtime&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">realtime_prio</span><span class="p">,</span>
		    <span class="s">&quot;collect data with this RT SCHED_FIFO priority&quot;</span><span class="p">),</span>
	<span class="n">OPT_INTEGER</span><span class="p">(</span><span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="s">&quot;delay&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">delay_secs</span><span class="p">,</span>
		    <span class="s">&quot;number of seconds to delay between refreshes&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="s">&quot;dump-symtab&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">dump_symtab</span><span class="p">,</span>
			    <span class="s">&quot;dump the symbol table used for profiling&quot;</span><span class="p">),</span>
	<span class="n">OPT_INTEGER</span><span class="p">(</span><span class="sc">&#39;f&#39;</span><span class="p">,</span> <span class="s">&quot;count-filter&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">count_filter</span><span class="p">,</span>
		    <span class="s">&quot;only display functions with more events than this&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="s">&quot;group&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">group</span><span class="p">,</span>
			    <span class="s">&quot;put the counters into a counter group&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;i&#39;</span><span class="p">,</span> <span class="s">&quot;inherit&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">inherit</span><span class="p">,</span>
		    <span class="s">&quot;child tasks inherit counters&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;sym-annotate&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">sym_filter</span><span class="p">,</span> <span class="s">&quot;symbol name&quot;</span><span class="p">,</span>
		    <span class="s">&quot;symbol to annotate&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;z&#39;</span><span class="p">,</span> <span class="s">&quot;zero&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span>
		    <span class="s">&quot;zero history across updates&quot;</span><span class="p">),</span>
	<span class="n">OPT_INTEGER</span><span class="p">(</span><span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="s">&quot;freq&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">freq</span><span class="p">,</span>
		    <span class="s">&quot;profile at this frequency&quot;</span><span class="p">),</span>
	<span class="n">OPT_INTEGER</span><span class="p">(</span><span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="s">&quot;entries&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">print_entries</span><span class="p">,</span>
		    <span class="s">&quot;display this many functions&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="s">&quot;hide_user_symbols&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">hide_user_symbols</span><span class="p">,</span>
		    <span class="s">&quot;hide user symbols&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;tui&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">use_tui</span><span class="p">,</span> <span class="s">&quot;Use the TUI interface&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;stdio&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">use_stdio</span><span class="p">,</span> <span class="s">&quot;Use the stdio interface&quot;</span><span class="p">),</span>
	<span class="n">OPT_INCR</span><span class="p">(</span><span class="sc">&#39;v&#39;</span><span class="p">,</span> <span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verbose</span><span class="p">,</span>
		    <span class="s">&quot;be more verbose (show counter open errors, etc)&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;s&#39;</span><span class="p">,</span> <span class="s">&quot;sort&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sort_order</span><span class="p">,</span> <span class="s">&quot;key[,key2...]&quot;</span><span class="p">,</span>
		   <span class="s">&quot;sort by key(s): pid, comm, dso, symbol, parent&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;n&#39;</span><span class="p">,</span> <span class="s">&quot;show-nr-samples&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">show_nr_samples</span><span class="p">,</span>
		    <span class="s">&quot;Show a column with the number of samples&quot;</span><span class="p">),</span>
	<span class="n">OPT_CALLBACK_DEFAULT</span><span class="p">(</span><span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="s">&quot;call-graph&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">,</span> <span class="s">&quot;output_type,min_percent, call_order&quot;</span><span class="p">,</span>
		     <span class="s">&quot;Display callchains using output_type (graph, flat, fractal, or none), min percent threshold and callchain order. &quot;</span>
		     <span class="s">&quot;Default: fractal,0.5,callee&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parse_callchain_opt</span><span class="p">,</span>
		     <span class="n">callchain_default_opt</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;show-total-period&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">show_total_period</span><span class="p">,</span>
		    <span class="s">&quot;Show a column with the sum of periods&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dsos&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">dso_list_str</span><span class="p">,</span> <span class="s">&quot;dso[,dso...]&quot;</span><span class="p">,</span>
		   <span class="s">&quot;only consider symbols in these dsos&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;comms&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">comm_list_str</span><span class="p">,</span> <span class="s">&quot;comm[,comm...]&quot;</span><span class="p">,</span>
		   <span class="s">&quot;only consider symbols in these comms&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;symbols&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">sym_list_str</span><span class="p">,</span> <span class="s">&quot;symbol[,symbol...]&quot;</span><span class="p">,</span>
		   <span class="s">&quot;only consider these symbols&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">annotate_src</span><span class="p">,</span>
		    <span class="s">&quot;Interleave source code with assembly code (default)&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;asm-raw&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">annotate_asm_raw</span><span class="p">,</span>
		    <span class="s">&quot;Display raw encoding of assembly instructions (default)&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="s">&quot;disassembler-style&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disassembler_style</span><span class="p">,</span> <span class="s">&quot;disassembler style&quot;</span><span class="p">,</span>
		   <span class="s">&quot;Specify disassembler style (e.g. -M intel for intel syntax)&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;u&#39;</span><span class="p">,</span> <span class="s">&quot;uid&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">uid_str</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="s">&quot;user to profile&quot;</span><span class="p">),</span>
	<span class="n">OPT_END</span><span class="p">()</span>
	<span class="p">};</span>

	<span class="n">top</span><span class="p">.</span><span class="n">evlist</span> <span class="o">=</span> <span class="n">perf_evlist__new</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">evlist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">symbol_conf</span><span class="p">.</span><span class="n">exclude_other</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">argc</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">top_usage</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span>
		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">top_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sort_order</span> <span class="o">==</span> <span class="n">default_sort_order</span><span class="p">)</span>
		<span class="n">sort_order</span> <span class="o">=</span> <span class="s">&quot;dso,symbol&quot;</span><span class="p">;</span>

	<span class="n">setup_sorting</span><span class="p">(</span><span class="n">top_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">use_stdio</span><span class="p">)</span>
		<span class="n">use_browser</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">use_tui</span><span class="p">)</span>
		<span class="n">use_browser</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">setup_browser</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">perf_target__validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perf_target__strerror</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">);</span>
		<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">perf_target__parse_uid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>

		<span class="n">perf_target__strerror</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">);</span>
		<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">saved_errno</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_delete_evlist</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_target__none</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">))</span>
		<span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">system_wide</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evlist__create_maps</span><span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">evlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">target</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">top_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">top</span><span class="p">.</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">&amp;&amp;</span>
	    <span class="n">perf_evlist__add_default</span><span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">evlist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;Not enough memory for event selector list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">symbol_conf</span><span class="p">.</span><span class="n">nr_events</span> <span class="o">=</span> <span class="n">top</span><span class="p">.</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">delay_secs</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">top</span><span class="p">.</span><span class="n">delay_secs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * User specified count overrides default frequency.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">default_interval</span><span class="p">)</span>
		<span class="n">top</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top</span><span class="p">.</span><span class="n">default_interval</span> <span class="o">=</span> <span class="n">top</span><span class="p">.</span><span class="n">freq</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ui__error</span><span class="p">(</span><span class="s">&quot;frequency and count are zero, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fill in the ones not specifically initialized via -c:</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">sample_period</span><span class="p">)</span>
			<span class="n">pos</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">sample_period</span> <span class="o">=</span> <span class="n">top</span><span class="p">.</span><span class="n">default_interval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">top</span><span class="p">.</span><span class="n">sym_evsel</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">symbol_conf</span><span class="p">.</span><span class="n">priv_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">annotation</span><span class="p">);</span>

	<span class="n">symbol_conf</span><span class="p">.</span><span class="n">try_vmlinux_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">vmlinux_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symbol__init</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sort_entry__setup_elide</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sort_dso</span><span class="p">,</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">dso_list</span><span class="p">,</span> <span class="s">&quot;dso&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
	<span class="n">sort_entry__setup_elide</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sort_comm</span><span class="p">,</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">comm_list</span><span class="p">,</span> <span class="s">&quot;comm&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
	<span class="n">sort_entry__setup_elide</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sort_sym</span><span class="p">,</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">sym_list</span><span class="p">,</span> <span class="s">&quot;symbol&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Avoid annotation data structures overhead when symbols aren&#39;t on the</span>
<span class="cm">	 * sort list.</span>
<span class="cm">	 */</span>
	<span class="n">top</span><span class="p">.</span><span class="n">sort_has_symbols</span> <span class="o">=</span> <span class="n">sort_sym</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">get_term_dimensions</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">winsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">print_entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sigaction</span> <span class="n">act</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">sa_sigaction</span> <span class="o">=</span> <span class="n">perf_top__sig_winch</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sa_flags</span>     <span class="o">=</span> <span class="n">SA_SIGINFO</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="n">perf_top__update_print_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">);</span>
		<span class="n">sigaction</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__cmd_top</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">);</span>

<span class="nl">out_delete_evlist:</span>
	<span class="n">perf_evlist__delete</span><span class="p">(</span><span class="n">top</span><span class="p">.</span><span class="n">evlist</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
