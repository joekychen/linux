<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › util › parse-events.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>parse-events.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;../../../include/linux/hw_breakpoint.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;../perf.h&quot;</span>
<span class="cp">#include &quot;evlist.h&quot;</span>
<span class="cp">#include &quot;evsel.h&quot;</span>
<span class="cp">#include &quot;parse-options.h&quot;</span>
<span class="cp">#include &quot;parse-events.h&quot;</span>
<span class="cp">#include &quot;exec_cmd.h&quot;</span>
<span class="cp">#include &quot;string.h&quot;</span>
<span class="cp">#include &quot;symbol.h&quot;</span>
<span class="cp">#include &quot;cache.h&quot;</span>
<span class="cp">#include &quot;header.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>
<span class="cp">#include &quot;parse-events-flex.h&quot;</span>
<span class="cp">#include &quot;pmu.h&quot;</span>

<span class="cp">#define MAX_NAME_LEN 100</span>

<span class="k">struct</span> <span class="n">event_symbol</span> <span class="p">{</span>
	<span class="n">u8</span>		<span class="n">type</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">symbol</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">alias</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef PARSER_DEBUG</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">parse_events_debug</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="kt">int</span> <span class="n">parse_events_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">);</span>

<span class="cp">#define CHW(x) .type = PERF_TYPE_HARDWARE, .config = PERF_COUNT_HW_##x</span>
<span class="cp">#define CSW(x) .type = PERF_TYPE_SOFTWARE, .config = PERF_COUNT_SW_##x</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_symbol</span> <span class="n">event_symbols</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">CPU_CYCLES</span><span class="p">),</span>			<span class="s">&quot;cpu-cycles&quot;</span><span class="p">,</span>			<span class="s">&quot;cycles&quot;</span>		<span class="p">},</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">STALLED_CYCLES_FRONTEND</span><span class="p">),</span>	<span class="s">&quot;stalled-cycles-frontend&quot;</span><span class="p">,</span>	<span class="s">&quot;idle-cycles-frontend&quot;</span>	<span class="p">},</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">STALLED_CYCLES_BACKEND</span><span class="p">),</span>	<span class="s">&quot;stalled-cycles-backend&quot;</span><span class="p">,</span>	<span class="s">&quot;idle-cycles-backend&quot;</span>	<span class="p">},</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">INSTRUCTIONS</span><span class="p">),</span>			<span class="s">&quot;instructions&quot;</span><span class="p">,</span>			<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">CACHE_REFERENCES</span><span class="p">),</span>		<span class="s">&quot;cache-references&quot;</span><span class="p">,</span>		<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">CACHE_MISSES</span><span class="p">),</span>			<span class="s">&quot;cache-misses&quot;</span><span class="p">,</span>			<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">BRANCH_INSTRUCTIONS</span><span class="p">),</span>		<span class="s">&quot;branch-instructions&quot;</span><span class="p">,</span>		<span class="s">&quot;branches&quot;</span>		<span class="p">},</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">BRANCH_MISSES</span><span class="p">),</span>			<span class="s">&quot;branch-misses&quot;</span><span class="p">,</span>		<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">BUS_CYCLES</span><span class="p">),</span>			<span class="s">&quot;bus-cycles&quot;</span><span class="p">,</span>			<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CHW</span><span class="p">(</span><span class="n">REF_CPU_CYCLES</span><span class="p">),</span>		<span class="s">&quot;ref-cycles&quot;</span><span class="p">,</span>			<span class="s">&quot;&quot;</span>			<span class="p">},</span>

  <span class="p">{</span> <span class="n">CSW</span><span class="p">(</span><span class="n">CPU_CLOCK</span><span class="p">),</span>			<span class="s">&quot;cpu-clock&quot;</span><span class="p">,</span>			<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CSW</span><span class="p">(</span><span class="n">TASK_CLOCK</span><span class="p">),</span>			<span class="s">&quot;task-clock&quot;</span><span class="p">,</span>			<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CSW</span><span class="p">(</span><span class="n">PAGE_FAULTS</span><span class="p">),</span>			<span class="s">&quot;page-faults&quot;</span><span class="p">,</span>			<span class="s">&quot;faults&quot;</span>		<span class="p">},</span>
  <span class="p">{</span> <span class="n">CSW</span><span class="p">(</span><span class="n">PAGE_FAULTS_MIN</span><span class="p">),</span>		<span class="s">&quot;minor-faults&quot;</span><span class="p">,</span>			<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CSW</span><span class="p">(</span><span class="n">PAGE_FAULTS_MAJ</span><span class="p">),</span>		<span class="s">&quot;major-faults&quot;</span><span class="p">,</span>			<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CSW</span><span class="p">(</span><span class="n">CONTEXT_SWITCHES</span><span class="p">),</span>		<span class="s">&quot;context-switches&quot;</span><span class="p">,</span>		<span class="s">&quot;cs&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CSW</span><span class="p">(</span><span class="n">CPU_MIGRATIONS</span><span class="p">),</span>		<span class="s">&quot;cpu-migrations&quot;</span><span class="p">,</span>		<span class="s">&quot;migrations&quot;</span>		<span class="p">},</span>
  <span class="p">{</span> <span class="n">CSW</span><span class="p">(</span><span class="n">ALIGNMENT_FAULTS</span><span class="p">),</span>		<span class="s">&quot;alignment-faults&quot;</span><span class="p">,</span>		<span class="s">&quot;&quot;</span>			<span class="p">},</span>
  <span class="p">{</span> <span class="n">CSW</span><span class="p">(</span><span class="n">EMULATION_FAULTS</span><span class="p">),</span>		<span class="s">&quot;emulation-faults&quot;</span><span class="p">,</span>		<span class="s">&quot;&quot;</span>			<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define __PERF_EVENT_FIELD(config, name) \</span>
<span class="cp">	((config &amp; PERF_EVENT_##name##_MASK) &gt;&gt; PERF_EVENT_##name##_SHIFT)</span>

<span class="cp">#define PERF_EVENT_RAW(config)		__PERF_EVENT_FIELD(config, RAW)</span>
<span class="cp">#define PERF_EVENT_CONFIG(config)	__PERF_EVENT_FIELD(config, CONFIG)</span>
<span class="cp">#define PERF_EVENT_TYPE(config)		__PERF_EVENT_FIELD(config, TYPE)</span>
<span class="cp">#define PERF_EVENT_ID(config)		__PERF_EVENT_FIELD(config, EVENT)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sw_event_names</span><span class="p">[</span><span class="n">PERF_COUNT_SW_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;cpu-clock&quot;</span><span class="p">,</span>
	<span class="s">&quot;task-clock&quot;</span><span class="p">,</span>
	<span class="s">&quot;page-faults&quot;</span><span class="p">,</span>
	<span class="s">&quot;context-switches&quot;</span><span class="p">,</span>
	<span class="s">&quot;CPU-migrations&quot;</span><span class="p">,</span>
	<span class="s">&quot;minor-faults&quot;</span><span class="p">,</span>
	<span class="s">&quot;major-faults&quot;</span><span class="p">,</span>
	<span class="s">&quot;alignment-faults&quot;</span><span class="p">,</span>
	<span class="s">&quot;emulation-faults&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define MAX_ALIASES 8</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hw_cache</span><span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">][</span><span class="n">MAX_ALIASES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="p">{</span> <span class="s">&quot;L1-dcache&quot;</span><span class="p">,</span>	<span class="s">&quot;l1-d&quot;</span><span class="p">,</span>		<span class="s">&quot;l1d&quot;</span><span class="p">,</span>		<span class="s">&quot;L1-data&quot;</span><span class="p">,</span>		<span class="p">},</span>
 <span class="p">{</span> <span class="s">&quot;L1-icache&quot;</span><span class="p">,</span>	<span class="s">&quot;l1-i&quot;</span><span class="p">,</span>		<span class="s">&quot;l1i&quot;</span><span class="p">,</span>		<span class="s">&quot;L1-instruction&quot;</span><span class="p">,</span>	<span class="p">},</span>
 <span class="p">{</span> <span class="s">&quot;LLC&quot;</span><span class="p">,</span>	<span class="s">&quot;L2&quot;</span><span class="p">,</span>							<span class="p">},</span>
 <span class="p">{</span> <span class="s">&quot;dTLB&quot;</span><span class="p">,</span>	<span class="s">&quot;d-tlb&quot;</span><span class="p">,</span>	<span class="s">&quot;Data-TLB&quot;</span><span class="p">,</span>				<span class="p">},</span>
 <span class="p">{</span> <span class="s">&quot;iTLB&quot;</span><span class="p">,</span>	<span class="s">&quot;i-tlb&quot;</span><span class="p">,</span>	<span class="s">&quot;Instruction-TLB&quot;</span><span class="p">,</span>			<span class="p">},</span>
 <span class="p">{</span> <span class="s">&quot;branch&quot;</span><span class="p">,</span>	<span class="s">&quot;branches&quot;</span><span class="p">,</span>	<span class="s">&quot;bpu&quot;</span><span class="p">,</span>		<span class="s">&quot;btb&quot;</span><span class="p">,</span>		<span class="s">&quot;bpc&quot;</span><span class="p">,</span>	<span class="p">},</span>
 <span class="p">{</span> <span class="s">&quot;node&quot;</span><span class="p">,</span>								<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hw_cache_op</span><span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">][</span><span class="n">MAX_ALIASES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="p">{</span> <span class="s">&quot;load&quot;</span><span class="p">,</span>	<span class="s">&quot;loads&quot;</span><span class="p">,</span>	<span class="s">&quot;read&quot;</span><span class="p">,</span>					<span class="p">},</span>
 <span class="p">{</span> <span class="s">&quot;store&quot;</span><span class="p">,</span>	<span class="s">&quot;stores&quot;</span><span class="p">,</span>	<span class="s">&quot;write&quot;</span><span class="p">,</span>				<span class="p">},</span>
 <span class="p">{</span> <span class="s">&quot;prefetch&quot;</span><span class="p">,</span>	<span class="s">&quot;prefetches&quot;</span><span class="p">,</span>	<span class="s">&quot;speculative-read&quot;</span><span class="p">,</span> <span class="s">&quot;speculative-load&quot;</span><span class="p">,</span>	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hw_cache_result</span><span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span>
				  <span class="p">[</span><span class="n">MAX_ALIASES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="p">{</span> <span class="s">&quot;refs&quot;</span><span class="p">,</span>	<span class="s">&quot;Reference&quot;</span><span class="p">,</span>	<span class="s">&quot;ops&quot;</span><span class="p">,</span>		<span class="s">&quot;access&quot;</span><span class="p">,</span>		<span class="p">},</span>
 <span class="p">{</span> <span class="s">&quot;misses&quot;</span><span class="p">,</span>	<span class="s">&quot;miss&quot;</span><span class="p">,</span>							<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define C(x)		PERF_COUNT_HW_CACHE_##x</span>
<span class="cp">#define CACHE_READ	(1 &lt;&lt; C(OP_READ))</span>
<span class="cp">#define CACHE_WRITE	(1 &lt;&lt; C(OP_WRITE))</span>
<span class="cp">#define CACHE_PREFETCH	(1 &lt;&lt; C(OP_PREFETCH))</span>
<span class="cp">#define COP(x)		(1 &lt;&lt; x)</span>

<span class="cm">/*</span>
<span class="cm"> * cache operartion stat</span>
<span class="cm"> * L1I : Read and prefetch only</span>
<span class="cm"> * ITLB and BPU : Read-only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_cache_stat</span><span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">MAX</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">CACHE_READ</span> <span class="o">|</span> <span class="n">CACHE_WRITE</span> <span class="o">|</span> <span class="n">CACHE_PREFETCH</span><span class="p">),</span>
 <span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">L1I</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">CACHE_READ</span> <span class="o">|</span> <span class="n">CACHE_PREFETCH</span><span class="p">),</span>
 <span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">LL</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">CACHE_READ</span> <span class="o">|</span> <span class="n">CACHE_WRITE</span> <span class="o">|</span> <span class="n">CACHE_PREFETCH</span><span class="p">),</span>
 <span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">CACHE_READ</span> <span class="o">|</span> <span class="n">CACHE_WRITE</span> <span class="o">|</span> <span class="n">CACHE_PREFETCH</span><span class="p">),</span>
 <span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">CACHE_READ</span><span class="p">),</span>
 <span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">BPU</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">CACHE_READ</span><span class="p">),</span>
 <span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">NODE</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">CACHE_READ</span> <span class="o">|</span> <span class="n">CACHE_WRITE</span> <span class="o">|</span> <span class="n">CACHE_PREFETCH</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define for_each_subsystem(sys_dir, sys_dirent, sys_next)	       \</span>
<span class="cp">	while (!readdir_r(sys_dir, &amp;sys_dirent, &amp;sys_next) &amp;&amp; sys_next)	       \</span>
<span class="cp">	if (sys_dirent.d_type == DT_DIR &amp;&amp;				       \</span>
<span class="cp">	   (strcmp(sys_dirent.d_name, &quot;.&quot;)) &amp;&amp;				       \</span>
<span class="cp">	   (strcmp(sys_dirent.d_name, &quot;..&quot;)))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tp_event_has_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">sys_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">evt_dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">evt_path</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">MAXPATHLEN</span><span class="p">,</span> <span class="s">&quot;%s/%s/%s/id&quot;</span><span class="p">,</span> <span class="n">tracing_events_path</span><span class="p">,</span>
			<span class="n">sys_dir</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">evt_dir</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
	<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define for_each_event(sys_dirent, evt_dir, evt_dirent, evt_next)	       \</span>
<span class="cp">	while (!readdir_r(evt_dir, &amp;evt_dirent, &amp;evt_next) &amp;&amp; evt_next)        \</span>
<span class="cp">	if (evt_dirent.d_type == DT_DIR &amp;&amp;				       \</span>
<span class="cp">	   (strcmp(evt_dirent.d_name, &quot;.&quot;)) &amp;&amp;				       \</span>
<span class="cp">	   (strcmp(evt_dirent.d_name, &quot;..&quot;)) &amp;&amp;				       \</span>
<span class="cp">	   (!tp_event_has_id(&amp;sys_dirent, &amp;evt_dirent)))</span>

<span class="cp">#define MAX_EVENT_LENGTH 512</span>


<span class="k">struct</span> <span class="n">tracepoint_path</span> <span class="o">*</span><span class="nf">tracepoint_id_to_path</span><span class="p">(</span><span class="n">u64</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tracepoint_path</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">DIR</span> <span class="o">*</span><span class="n">sys_dir</span><span class="p">,</span> <span class="o">*</span><span class="n">evt_dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">sys_next</span><span class="p">,</span> <span class="o">*</span><span class="n">evt_next</span><span class="p">,</span> <span class="n">sys_dirent</span><span class="p">,</span> <span class="n">evt_dirent</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">evt_path</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">dir_path</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debugfs_valid_mountpoint</span><span class="p">(</span><span class="n">tracing_events_path</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sys_dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">tracing_events_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sys_dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">for_each_subsystem</span><span class="p">(</span><span class="n">sys_dir</span><span class="p">,</span> <span class="n">sys_dirent</span><span class="p">,</span> <span class="n">sys_next</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">MAXPATHLEN</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">tracing_events_path</span><span class="p">,</span>
			 <span class="n">sys_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">);</span>
		<span class="n">evt_dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evt_dir</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">for_each_event</span><span class="p">(</span><span class="n">sys_dirent</span><span class="p">,</span> <span class="n">evt_dir</span><span class="p">,</span> <span class="n">evt_dirent</span><span class="p">,</span> <span class="n">evt_next</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">snprintf</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">MAXPATHLEN</span><span class="p">,</span> <span class="s">&quot;%s/%s/id&quot;</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span>
				 <span class="n">evt_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">);</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">id_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id_buf</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">atoll</span><span class="p">(</span><span class="n">id_buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">config</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">closedir</span><span class="p">(</span><span class="n">evt_dir</span><span class="p">);</span>
				<span class="n">closedir</span><span class="p">(</span><span class="n">sys_dir</span><span class="p">);</span>
				<span class="n">path</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">));</span>
				<span class="n">path</span><span class="o">-&gt;</span><span class="n">system</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">MAX_EVENT_LENGTH</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">free</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
					<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">MAX_EVENT_LENGTH</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">free</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">);</span>
					<span class="n">free</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
					<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="n">sys_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">,</span>
					<span class="n">MAX_EVENT_LENGTH</span><span class="p">);</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">evt_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">,</span>
					<span class="n">MAX_EVENT_LENGTH</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">path</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">closedir</span><span class="p">(</span><span class="n">evt_dir</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">closedir</span><span class="p">(</span><span class="n">sys_dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TP_PATH_LEN (MAX_EVENT_LENGTH * 2 + 1)</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tracepoint_id_to_name</span><span class="p">(</span><span class="n">u64</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">TP_PATH_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tracepoint_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">tracepoint_id_to_path</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">TP_PATH_LEN</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">TP_PATH_LEN</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_cache_op_valid</span><span class="p">(</span><span class="n">u8</span> <span class="n">cache_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cache_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_cache_stat</span><span class="p">[</span><span class="n">cache_type</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">COP</span><span class="p">(</span><span class="n">cache_op</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* valid */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* invalid */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">event_cache_name</span><span class="p">(</span><span class="n">u8</span> <span class="n">cache_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cache_op</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cache_result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s-%s-%s&quot;</span><span class="p">,</span> <span class="n">hw_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">hw_cache_op</span><span class="p">[</span><span class="n">cache_op</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">hw_cache_result</span><span class="p">[</span><span class="n">cache_result</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s-%s&quot;</span><span class="p">,</span> <span class="n">hw_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">hw_cache_op</span><span class="p">[</span><span class="n">cache_op</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">event_type</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PERF_TYPE_HARDWARE</span>:
		<span class="k">return</span> <span class="s">&quot;hardware&quot;</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PERF_TYPE_SOFTWARE</span>:
		<span class="k">return</span> <span class="s">&quot;software&quot;</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PERF_TYPE_TRACEPOINT</span>:
		<span class="k">return</span> <span class="s">&quot;tracepoint&quot;</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PERF_TYPE_HW_CACHE</span>:
		<span class="k">return</span> <span class="s">&quot;hardware-cache&quot;</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">event_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">config</span> <span class="o">=</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_RAW</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_HARDWARE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm"> 		 * XXX minimal fix, see comment on perf_evsen__name, this static buffer</span>
<span class="cm"> 		 * will go away together with event_name in the next devel cycle.</span>
<span class="cm"> 		 */</span>
		<span class="k">static</span> <span class="kt">char</span> <span class="n">bf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
		<span class="n">perf_evsel__name</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bf</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">bf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__event_name</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">__event_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u64</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;raw 0x%&quot;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PERF_TYPE_HARDWARE</span>:
		<span class="k">return</span> <span class="n">__perf_evsel__hw_name</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">PERF_TYPE_HW_CACHE</span>: <span class="p">{</span>
		<span class="n">u8</span> <span class="n">cache_type</span><span class="p">,</span> <span class="n">cache_op</span><span class="p">,</span> <span class="n">cache_result</span><span class="p">;</span>

		<span class="n">cache_type</span>   <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cache_type</span> <span class="o">&gt;</span> <span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="s">&quot;unknown-ext-hardware-cache-type&quot;</span><span class="p">;</span>

		<span class="n">cache_op</span>     <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cache_op</span> <span class="o">&gt;</span> <span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="s">&quot;unknown-ext-hardware-cache-op&quot;</span><span class="p">;</span>

		<span class="n">cache_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cache_result</span> <span class="o">&gt;</span> <span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="s">&quot;unknown-ext-hardware-cache-result&quot;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cache_op_valid</span><span class="p">(</span><span class="n">cache_type</span><span class="p">,</span> <span class="n">cache_op</span><span class="p">))</span>
			<span class="k">return</span> <span class="s">&quot;invalid-cache&quot;</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">event_cache_name</span><span class="p">(</span><span class="n">cache_type</span><span class="p">,</span> <span class="n">cache_op</span><span class="p">,</span> <span class="n">cache_result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">PERF_TYPE_SOFTWARE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">&lt;</span> <span class="n">PERF_COUNT_SW_MAX</span> <span class="o">&amp;&amp;</span> <span class="n">sw_event_names</span><span class="p">[</span><span class="n">config</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">sw_event_names</span><span class="p">[</span><span class="n">config</span><span class="p">];</span>
		<span class="k">return</span> <span class="s">&quot;unknown-software&quot;</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PERF_TYPE_TRACEPOINT</span>:
		<span class="k">return</span> <span class="n">tracepoint_id_to_name</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">**</span><span class="n">_list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="o">*</span><span class="n">_list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">list</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">event_attr_init</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>

	<span class="n">evsel</span> <span class="o">=</span> <span class="n">perf_evsel__new</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">)</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evsel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="o">*</span><span class="n">_list</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_aliases</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">names</span><span class="p">[][</span><span class="n">MAX_ALIASES</span><span class="p">],</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">longest</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_ALIASES</span> <span class="o">&amp;&amp;</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">longest</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">n</span><span class="p">))</span>
				<span class="n">longest</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">longest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events_add_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">op_result1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">op_result2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_NAME_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">cache_type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cache_op</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cache_result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">op_result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">op_result1</span><span class="p">,</span> <span class="n">op_result2</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No fallback - if we cannot get a clear cache type</span>
<span class="cm">	 * then bail out:</span>
<span class="cm">	 */</span>
	<span class="n">cache_type</span> <span class="o">=</span> <span class="n">parse_aliases</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">hw_cache</span><span class="p">,</span>
				   <span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">op_result</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">op_result</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot;-%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cache_op</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cache_op</span> <span class="o">=</span> <span class="n">parse_aliases</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">hw_cache_op</span><span class="p">,</span>
						 <span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cache_op</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cache_op_valid</span><span class="p">(</span><span class="n">cache_type</span><span class="p">,</span> <span class="n">cache_op</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cache_result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cache_result</span> <span class="o">=</span> <span class="n">parse_aliases</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">hw_cache_result</span><span class="p">,</span>
						<span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cache_result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fall back to reads:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_op</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">cache_op</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_CACHE_OP_READ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fall back to accesses:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">cache_result</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_CACHE_RESULT_ACCESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">cache_type</span> <span class="o">|</span> <span class="p">(</span><span class="n">cache_op</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cache_result</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">add_event</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_tracepoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">sys_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">evt_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_NAME_LEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">evt_path</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">MAXPATHLEN</span><span class="p">,</span> <span class="s">&quot;%s/%s/%s/id&quot;</span><span class="p">,</span> <span class="n">tracing_events_path</span><span class="p">,</span>
		 <span class="n">sys_name</span><span class="p">,</span> <span class="n">evt_name</span><span class="p">);</span>

	<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">id_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id_buf</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">atoll</span><span class="p">(</span><span class="n">id_buf</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_TRACEPOINT</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">|=</span> <span class="n">PERF_SAMPLE_RAW</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">|=</span> <span class="n">PERF_SAMPLE_TIME</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">|=</span> <span class="n">PERF_SAMPLE_CPU</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">sample_period</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="n">sys_name</span><span class="p">,</span> <span class="n">evt_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">add_event</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_tracepoint_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">sys_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">evt_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">evt_path</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">evt_ent</span><span class="p">;</span>
	<span class="kt">DIR</span> <span class="o">*</span><span class="n">evt_dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">MAXPATHLEN</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">tracing_events_path</span><span class="p">,</span> <span class="n">sys_name</span><span class="p">);</span>
	<span class="n">evt_dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">evt_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evt_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;Can&#39;t open event dir&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">evt_ent</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">evt_dir</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">evt_ent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">)</span>
		    <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">evt_ent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&quot;..&quot;</span><span class="p">)</span>
		    <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">evt_ent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&quot;enable&quot;</span><span class="p">)</span>
		    <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">evt_ent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&quot;filter&quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strglobmatch</span><span class="p">(</span><span class="n">evt_ent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">evt_name</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">add_tracepoint</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sys_name</span><span class="p">,</span> <span class="n">evt_ent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events_add_tracepoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">sys</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">debugfs_valid_mountpoint</span><span class="p">(</span><span class="n">tracing_events_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strpbrk</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;*?&quot;</span><span class="p">)</span> <span class="o">?</span>
	       <span class="n">add_tracepoint_multi</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span> <span class="o">:</span>
	       <span class="n">add_tracepoint</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_breakpoint_type</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span> <span class="o">||</span> <span class="o">!</span><span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_type</span> <span class="o">|=</span> <span class="n">HW_BREAKPOINT_R</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_type</span> <span class="o">|=</span> <span class="n">HW_BREAKPOINT_W</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_type</span> <span class="o">|=</span> <span class="n">HW_BREAKPOINT_X</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_type</span><span class="p">)</span> <span class="cm">/* Default */</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_type</span> <span class="o">=</span> <span class="n">HW_BREAKPOINT_R</span> <span class="o">|</span> <span class="n">HW_BREAKPOINT_W</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events_add_breakpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_NAME_LEN</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">bp_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_breakpoint_type</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should find a nice way to override the access length</span>
<span class="cm">	 * Provide some defaults for now</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">bp_type</span> <span class="o">==</span> <span class="n">HW_BREAKPOINT_X</span><span class="p">)</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">bp_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">bp_len</span> <span class="o">=</span> <span class="n">HW_BREAKPOINT_LEN_4</span><span class="p">;</span>

	<span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_BREAKPOINT</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;mem:%p:%s&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="o">?</span> <span class="n">type</span> <span class="o">:</span> <span class="s">&quot;rw&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">add_event</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_term</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">*</span><span class="n">term</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define CHECK_TYPE_VAL(type)					\</span>
<span class="cp">do {								\</span>
<span class="cp">	if (PARSE_EVENTS__TERM_TYPE_ ## type != term-&gt;type_val)	\</span>
<span class="cp">		return -EINVAL;					\</span>
<span class="cp">} while (0)</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">type_term</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PARSE_EVENTS__TERM_TYPE_CONFIG</span>:
		<span class="n">CHECK_TYPE_VAL</span><span class="p">(</span><span class="n">NUM</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARSE_EVENTS__TERM_TYPE_CONFIG1</span>:
		<span class="n">CHECK_TYPE_VAL</span><span class="p">(</span><span class="n">NUM</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">config1</span> <span class="o">=</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARSE_EVENTS__TERM_TYPE_CONFIG2</span>:
		<span class="n">CHECK_TYPE_VAL</span><span class="p">(</span><span class="n">NUM</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">config2</span> <span class="o">=</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARSE_EVENTS__TERM_TYPE_SAMPLE_PERIOD</span>:
		<span class="n">CHECK_TYPE_VAL</span><span class="p">(</span><span class="n">NUM</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_period</span> <span class="o">=</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARSE_EVENTS__TERM_TYPE_BRANCH_SAMPLE_TYPE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * TODO uncomment when the field is available</span>
<span class="cm">		 * attr-&gt;branch_sample_type = term-&gt;val.num;</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARSE_EVENTS__TERM_TYPE_NAME</span>:
		<span class="n">CHECK_TYPE_VAL</span><span class="p">(</span><span class="n">STR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#undef CHECK_TYPE_VAL</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config_term</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fail</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events_add_numeric</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">config</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">attr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head_config</span> <span class="o">&amp;&amp;</span>
	    <span class="n">config_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">head_config</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">add_event</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">__event_name</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">config</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_events__is_name_term</span><span class="p">(</span><span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">*</span><span class="n">term</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">type_term</span> <span class="o">==</span> <span class="n">PARSE_EVENTS__TERM_TYPE_NAME</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pmu_event_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head_terms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">head_terms</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parse_events__is_name_term</span><span class="p">(</span><span class="n">term</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">.</span><span class="n">str</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">__event_name</span><span class="p">(</span><span class="n">PERF_TYPE_RAW</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events_add_pmu</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_pmu</span> <span class="o">*</span><span class="n">pmu</span><span class="p">;</span>

	<span class="n">pmu</span> <span class="o">=</span> <span class="n">perf_pmu__find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure hardcoded terms first, no need to check</span>
<span class="cm">	 * return value when called with fail == 0 ;)</span>
<span class="cm">	 */</span>
	<span class="n">config_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">head_config</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_pmu__config</span><span class="p">(</span><span class="n">pmu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">head_config</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">add_event</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span>
			 <span class="n">pmu_event_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">head_config</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">parse_events_update_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_event</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Called for single event definition. Update the</span>
<span class="cm">	 * &#39;all event&#39; list, and reinit the &#39;signle event&#39;</span>
<span class="cm">	 * list, for next event definition.</span>
<span class="cm">	 */</span>
	<span class="n">list_splice_tail</span><span class="p">(</span><span class="n">list_event</span><span class="p">,</span> <span class="n">list_all</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">list_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events_modifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exclude</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exclude_GH</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eH</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">precise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;u&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exclude</span><span class="p">)</span>
				<span class="n">exclude</span> <span class="o">=</span> <span class="n">eu</span> <span class="o">=</span> <span class="n">ek</span> <span class="o">=</span> <span class="n">eh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">eu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;k&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exclude</span><span class="p">)</span>
				<span class="n">exclude</span> <span class="o">=</span> <span class="n">eu</span> <span class="o">=</span> <span class="n">ek</span> <span class="o">=</span> <span class="n">eh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exclude</span><span class="p">)</span>
				<span class="n">exclude</span> <span class="o">=</span> <span class="n">eu</span> <span class="o">=</span> <span class="n">ek</span> <span class="o">=</span> <span class="n">eh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">eh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;G&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exclude_GH</span><span class="p">)</span>
				<span class="n">exclude_GH</span> <span class="o">=</span> <span class="n">eG</span> <span class="o">=</span> <span class="n">eH</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">eG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;H&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exclude_GH</span><span class="p">)</span>
				<span class="n">exclude_GH</span> <span class="o">=</span> <span class="n">eG</span> <span class="o">=</span> <span class="n">eH</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">eH</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;p&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">precise</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="o">++</span><span class="n">str</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * precise ip:</span>
<span class="cm">	 *</span>
<span class="cm">	 *  0 - SAMPLE_IP can have arbitrary skid</span>
<span class="cm">	 *  1 - SAMPLE_IP must have constant skid</span>
<span class="cm">	 *  2 - SAMPLE_IP requested to have 0 skid</span>
<span class="cm">	 *  3 - SAMPLE_IP must have 0 skid</span>
<span class="cm">	 *</span>
<span class="cm">	 *  See also PERF_RECORD_MISC_EXACT_IP</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">precise</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_user</span>   <span class="o">=</span> <span class="n">eu</span><span class="p">;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_kernel</span> <span class="o">=</span> <span class="n">ek</span><span class="p">;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_hv</span>     <span class="o">=</span> <span class="n">eh</span><span class="p">;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">precise_ip</span>     <span class="o">=</span> <span class="n">precise</span><span class="p">;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_host</span>   <span class="o">=</span> <span class="n">eH</span><span class="p">;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_guest</span>  <span class="o">=</span> <span class="n">eG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list_tmp</span><span class="p">);</span>
	<span class="n">YY_BUFFER_STATE</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">parse_events__scan_string</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

<span class="cp">#ifdef PARSER_DEBUG</span>
	<span class="n">parse_events_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_events_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span>

	<span class="n">parse_events__flush_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">parse_events__delete_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">parse_events_lex_destroy</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span><span class="p">;</span>
		<span class="n">perf_evlist__splice_list_tail</span><span class="p">(</span><span class="n">evlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * There are 2 users - builtin-record and builtin-test objects.</span>
<span class="cm">	 * Both call perf_evlist__delete in case of error, so we dont</span>
<span class="cm">	 * need to bother.</span>
<span class="cm">	 */</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;invalid or unsupported event: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Run &#39;perf list&#39; for a list of valid events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events_option</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">unset</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">**</span><span class="p">)</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">parse_events</span><span class="p">(</span><span class="n">evlist</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">unset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_filter</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">unset</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">**</span><span class="p">)</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">last</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PERF_TYPE_TRACEPOINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;-F option should follow a -e tracepoint option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">last</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;not enough memory to hold filter string</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">event_type_descriptors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Hardware event&quot;</span><span class="p">,</span>
	<span class="s">&quot;Software event&quot;</span><span class="p">,</span>
	<span class="s">&quot;Tracepoint event&quot;</span><span class="p">,</span>
	<span class="s">&quot;Hardware cache event&quot;</span><span class="p">,</span>
	<span class="s">&quot;Raw hardware event descriptor&quot;</span><span class="p">,</span>
	<span class="s">&quot;Hardware breakpoint&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Print the events from &lt;debugfs_mount_point&gt;/tracing/events</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">print_tracepoint_events</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">subsys_glob</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_glob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">DIR</span> <span class="o">*</span><span class="n">sys_dir</span><span class="p">,</span> <span class="o">*</span><span class="n">evt_dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">sys_next</span><span class="p">,</span> <span class="o">*</span><span class="n">evt_next</span><span class="p">,</span> <span class="n">sys_dirent</span><span class="p">,</span> <span class="n">evt_dirent</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">evt_path</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">dir_path</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debugfs_valid_mountpoint</span><span class="p">(</span><span class="n">tracing_events_path</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sys_dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">tracing_events_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sys_dir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_subsystem</span><span class="p">(</span><span class="n">sys_dir</span><span class="p">,</span> <span class="n">sys_dirent</span><span class="p">,</span> <span class="n">sys_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsys_glob</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> 
		    <span class="o">!</span><span class="n">strglobmatch</span><span class="p">(</span><span class="n">sys_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">,</span> <span class="n">subsys_glob</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">MAXPATHLEN</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">tracing_events_path</span><span class="p">,</span>
			 <span class="n">sys_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">);</span>
		<span class="n">evt_dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evt_dir</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">for_each_event</span><span class="p">(</span><span class="n">sys_dirent</span><span class="p">,</span> <span class="n">evt_dir</span><span class="p">,</span> <span class="n">evt_dirent</span><span class="p">,</span> <span class="n">evt_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">event_glob</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> 
			    <span class="o">!</span><span class="n">strglobmatch</span><span class="p">(</span><span class="n">evt_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">,</span> <span class="n">event_glob</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">snprintf</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">MAXPATHLEN</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span>
				 <span class="n">sys_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">,</span> <span class="n">evt_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %-50s [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">evt_path</span><span class="p">,</span>
				<span class="n">event_type_descriptors</span><span class="p">[</span><span class="n">PERF_TYPE_TRACEPOINT</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">closedir</span><span class="p">(</span><span class="n">evt_dir</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">closedir</span><span class="p">(</span><span class="n">sys_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check whether event is in &lt;debugfs_mount_point&gt;/tracing/events</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">is_valid_tracepoint</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_string</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">DIR</span> <span class="o">*</span><span class="n">sys_dir</span><span class="p">,</span> <span class="o">*</span><span class="n">evt_dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">sys_next</span><span class="p">,</span> <span class="o">*</span><span class="n">evt_next</span><span class="p">,</span> <span class="n">sys_dirent</span><span class="p">,</span> <span class="n">evt_dirent</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">evt_path</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">dir_path</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debugfs_valid_mountpoint</span><span class="p">(</span><span class="n">tracing_events_path</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sys_dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">tracing_events_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sys_dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_subsystem</span><span class="p">(</span><span class="n">sys_dir</span><span class="p">,</span> <span class="n">sys_dirent</span><span class="p">,</span> <span class="n">sys_next</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">MAXPATHLEN</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">tracing_events_path</span><span class="p">,</span>
			 <span class="n">sys_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">);</span>
		<span class="n">evt_dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evt_dir</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">for_each_event</span><span class="p">(</span><span class="n">sys_dirent</span><span class="p">,</span> <span class="n">evt_dir</span><span class="p">,</span> <span class="n">evt_dirent</span><span class="p">,</span> <span class="n">evt_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">MAXPATHLEN</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span>
				 <span class="n">sys_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">,</span> <span class="n">evt_dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">evt_path</span><span class="p">,</span> <span class="n">event_string</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">closedir</span><span class="p">(</span><span class="n">evt_dir</span><span class="p">);</span>
				<span class="n">closedir</span><span class="p">(</span><span class="n">sys_dir</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">closedir</span><span class="p">(</span><span class="n">evt_dir</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">closedir</span><span class="p">(</span><span class="n">sys_dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_events_type</span><span class="p">(</span><span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_symbol</span> <span class="o">*</span><span class="n">syms</span> <span class="o">=</span> <span class="n">event_symbols</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">event_symbols</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">syms</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">syms</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">syms</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">))</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>  <span class="s">&quot;%s OR %s&quot;</span><span class="p">,</span>
				 <span class="n">syms</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">,</span> <span class="n">syms</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">syms</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">);</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %-50s [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">event_type_descriptors</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">print_hwcache_events</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_glob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">type</span> <span class="o">&lt;</span> <span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">;</span> <span class="n">type</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">op</span> <span class="o">&lt;</span> <span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">;</span> <span class="n">op</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* skip invalid cache type */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cache_op_valid</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">op</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">event_cache_name</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">event_glob</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strglobmatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">event_glob</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %-50s [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
					<span class="n">event_type_descriptors</span><span class="p">[</span><span class="n">PERF_TYPE_HW_CACHE</span><span class="p">]);</span>
				<span class="o">++</span><span class="n">printed</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">printed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print the help text for the event symbols:</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">print_events</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_glob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">prev_type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ntypes_printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_symbol</span> <span class="o">*</span><span class="n">syms</span> <span class="o">=</span> <span class="n">event_symbols</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_NAME_LEN</span><span class="p">];</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;List of pre-defined events (to be used in -e):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">event_symbols</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">syms</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">syms</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">prev_type</span> <span class="o">&amp;&amp;</span> <span class="n">printed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ntypes_printed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">event_glob</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> 
		    <span class="o">!</span><span class="p">(</span><span class="n">strglobmatch</span><span class="p">(</span><span class="n">syms</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">,</span> <span class="n">event_glob</span><span class="p">)</span> <span class="o">||</span>
		      <span class="p">(</span><span class="n">syms</span><span class="o">-&gt;</span><span class="n">alias</span> <span class="o">&amp;&amp;</span> <span class="n">strglobmatch</span><span class="p">(</span><span class="n">syms</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">,</span> <span class="n">event_glob</span><span class="p">))))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">syms</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">))</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;%s OR %s&quot;</span><span class="p">,</span> <span class="n">syms</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">,</span> <span class="n">syms</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">syms</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %-50s [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">event_type_descriptors</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>

		<span class="n">prev_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="o">++</span><span class="n">printed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntypes_printed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">print_hwcache_events</span><span class="p">(</span><span class="n">event_glob</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_glob</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %-50s [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;rNNN&quot;</span><span class="p">,</span>
	       <span class="n">event_type_descriptors</span><span class="p">[</span><span class="n">PERF_TYPE_RAW</span><span class="p">]);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %-50s [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;cpu/t1=v1[,t2=v2,t3 ...]/modifier&quot;</span><span class="p">,</span>
	       <span class="n">event_type_descriptors</span><span class="p">[</span><span class="n">PERF_TYPE_RAW</span><span class="p">]);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;   (see &#39;perf list --help&#39; on how to encode it)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %-50s [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;mem:&lt;addr&gt;[:access]&quot;</span><span class="p">,</span>
			<span class="n">event_type_descriptors</span><span class="p">[</span><span class="n">PERF_TYPE_BREAKPOINT</span><span class="p">]);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">print_tracepoint_events</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events__is_hardcoded_term</span><span class="p">(</span><span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">*</span><span class="n">term</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">type_term</span> <span class="o">!=</span> <span class="n">PARSE_EVENTS__TERM_TYPE_USER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">new_term</span><span class="p">(</span><span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">**</span><span class="n">_term</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type_val</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">type_term</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">long</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>

	<span class="n">term</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">term</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">term</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">term</span><span class="o">-&gt;</span><span class="n">type_val</span>  <span class="o">=</span> <span class="n">type_val</span><span class="p">;</span>
	<span class="n">term</span><span class="o">-&gt;</span><span class="n">type_term</span> <span class="o">=</span> <span class="n">type_term</span><span class="p">;</span>
	<span class="n">term</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type_val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PARSE_EVENTS__TERM_TYPE_NUM</span>:
		<span class="n">term</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARSE_EVENTS__TERM_TYPE_STR</span>:
		<span class="n">term</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">_term</span> <span class="o">=</span> <span class="n">term</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events__term_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">**</span><span class="n">term</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">type_term</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="kt">long</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">new_term</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">PARSE_EVENTS__TERM_TYPE_NUM</span><span class="p">,</span> <span class="n">type_term</span><span class="p">,</span>
			<span class="n">config</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">parse_events__term_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">**</span><span class="n">term</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">type_term</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">new_term</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">PARSE_EVENTS__TERM_TYPE_STR</span><span class="p">,</span> <span class="n">type_term</span><span class="p">,</span>
			<span class="n">config</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">parse_events__free_terms</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">terms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parse_events__term</span> <span class="o">*</span><span class="n">term</span><span class="p">,</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">terms</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">term</span><span class="p">);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">terms</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
