<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › util › header.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>header.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#define _FILE_OFFSET_BITS 64</span>

<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;byteswap.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;sys/utsname.h&gt;</span>

<span class="cp">#include &quot;evlist.h&quot;</span>
<span class="cp">#include &quot;evsel.h&quot;</span>
<span class="cp">#include &quot;header.h&quot;</span>
<span class="cp">#include &quot;../perf.h&quot;</span>
<span class="cp">#include &quot;trace-event.h&quot;</span>
<span class="cp">#include &quot;session.h&quot;</span>
<span class="cp">#include &quot;symbol.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;cpumap.h&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">no_buildid_cache</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">event_count</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_trace_event_type</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">header_argc</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">header_argv</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">perf_header__push_event</span><span class="p">(</span><span class="n">u64</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_trace_event_type</span> <span class="o">*</span><span class="n">nevents</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_EVENT_NAME</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Event %s will be truncated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">nevents</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="p">(</span><span class="n">event_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">events</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nevents</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">events</span> <span class="o">=</span> <span class="n">nevents</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="p">[</span><span class="n">event_count</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_trace_event_type</span><span class="p">));</span>
	<span class="n">events</span><span class="p">[</span><span class="n">event_count</span><span class="p">].</span><span class="n">event_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">event_count</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">MAX_EVENT_NAME</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">event_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">perf_header__find_event</span><span class="p">(</span><span class="n">u64</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">event_id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * magic2 = &quot;PERFILE2&quot;</span>
<span class="cm"> * must be a numerical value to let the endianness</span>
<span class="cm"> * determine the memory layout. That way we are able</span>
<span class="cm"> * to detect endianness when reading the perf.data file</span>
<span class="cm"> * back.</span>
<span class="cm"> *</span>
<span class="cm"> * we check for legacy (PERFFILE) format.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__perf_magic1</span> <span class="o">=</span> <span class="s">&quot;PERFFILE&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">__perf_magic2</span>    <span class="o">=</span> <span class="mh">0x32454c4946524550ULL</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">__perf_magic2_sw</span> <span class="o">=</span> <span class="mh">0x50455246494c4532ULL</span><span class="p">;</span>

<span class="cp">#define PERF_MAGIC	__perf_magic2</span>

<span class="k">struct</span> <span class="n">perf_file_attr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span>	<span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_file_section</span>	<span class="n">ids</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">perf_header__set_feat</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">feat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">perf_header__clear_feat</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">feat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">perf_header__has_feat</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">feat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NAME_ALIGN 64</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_padded</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">count_aligned</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">zero_buf</span><span class="p">[</span><span class="n">NAME_ALIGN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">zero_buf</span><span class="p">,</span> <span class="n">count_aligned</span> <span class="o">-</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_write_string</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">olen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">olen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">olen</span><span class="p">,</span> <span class="n">NAME_ALIGN</span><span class="p">);</span>

	<span class="cm">/* write len, incl. \0 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">write_padded</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">olen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">do_read_string</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">sz</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * strings are padded by zeroes</span>
<span class="cm">		 * thus the actual strlen of buf</span>
<span class="cm">		 * may be less than len</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">perf_header__set_cmdline</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">header_argc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">argc</span><span class="p">;</span>

	<span class="cm">/* do not include NULL termination */</span>
	<span class="n">header_argv</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header_argv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * must copy argv contents because it gets moved</span>
<span class="cm">	 * around during option parsing</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">header_argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define dsos__for_each_with_build_id(pos, head)	\</span>
<span class="cp">	list_for_each_entry(pos, head, node)	\</span>
<span class="cp">		if (!pos-&gt;has_build_id)		\</span>
<span class="cp">			continue;		\</span>
<span class="cp">		else</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dsos__write_buildid_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">misc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">dsos__for_each_with_build_id</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">build_id_event</span> <span class="n">b</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">hit</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">long_name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">NAME_ALIGN</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">.</span><span class="n">build_id</span><span class="p">,</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">));</span>
		<span class="n">b</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
		<span class="n">b</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">misc</span><span class="p">;</span>
		<span class="n">b</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">write_padded</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span>
				   <span class="n">pos</span><span class="o">-&gt;</span><span class="n">long_name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">machine__write_buildid_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">kmisc</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_KERNEL</span><span class="p">,</span>
	    <span class="n">umisc</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_USER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine__is_host</span><span class="p">(</span><span class="n">machine</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kmisc</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span><span class="p">;</span>
		<span class="n">umisc</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_GUEST_USER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__dsos__write_buildid_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kernel_dsos</span><span class="p">,</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					  <span class="n">kmisc</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__dsos__write_buildid_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">user_dsos</span><span class="p">,</span>
						  <span class="n">machine</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">umisc</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsos__write_buildid_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">perf_session</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">nd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">machine__write_buildid_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nd</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">machines</span><span class="p">);</span> <span class="n">nd</span><span class="p">;</span> <span class="n">nd</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">machine</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">machine__write_buildid_table</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">build_id_cache__add_s</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sbuild_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">debugdir</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_kallsyms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PATH_MAX</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">realname</span><span class="p">,</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
	     <span class="o">*</span><span class="n">linkname</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="o">*</span><span class="n">targetname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_kallsyms</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">kptr_restrict</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Not caching a kptr_restrict&#39;ed /proc/kallsyms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">realname</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">realname</span> <span class="o">=</span> <span class="n">realpath</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">realname</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">linkname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%s%s%s&quot;</span><span class="p">,</span>
		       <span class="n">debugdir</span><span class="p">,</span> <span class="n">is_kallsyms</span> <span class="o">?</span> <span class="s">&quot;/&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">realname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mo">0755</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;/%s&quot;</span><span class="p">,</span> <span class="n">sbuild_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_kallsyms</span><span class="p">)</span> <span class="p">{</span>
			 <span class="k">if</span> <span class="p">(</span><span class="n">copyfile</span><span class="p">(</span><span class="s">&quot;/proc/kallsyms&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="p">(</span><span class="n">realname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">copyfile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%s/.build-id/%.2s&quot;</span><span class="p">,</span>
		       <span class="n">debugdir</span><span class="p">,</span> <span class="n">sbuild_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="n">X_OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mkdir_p</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="mo">0755</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">linkname</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;/%s&quot;</span><span class="p">,</span> <span class="n">sbuild_id</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">targetname</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">debugdir</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">targetname</span><span class="p">,</span> <span class="s">&quot;../..&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symlink</span><span class="p">(</span><span class="n">targetname</span><span class="p">,</span> <span class="n">linkname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_kallsyms</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">realname</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">linkname</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_id_cache__add_b</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">build_id</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">build_id_size</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">debugdir</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="n">is_kallsyms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">sbuild_id</span><span class="p">[</span><span class="n">BUILD_ID_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">build_id__sprintf</span><span class="p">(</span><span class="n">build_id</span><span class="p">,</span> <span class="n">build_id_size</span><span class="p">,</span> <span class="n">sbuild_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">build_id_cache__add_s</span><span class="p">(</span><span class="n">sbuild_id</span><span class="p">,</span> <span class="n">debugdir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_kallsyms</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">build_id_cache__remove_s</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sbuild_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">debugdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PATH_MAX</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
	     <span class="o">*</span><span class="n">linkname</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">linkname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%s/.build-id/%.2s/%s&quot;</span><span class="p">,</span>
		 <span class="n">debugdir</span><span class="p">,</span> <span class="n">sbuild_id</span><span class="p">,</span> <span class="n">sbuild_id</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readlink</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlink</span><span class="p">(</span><span class="n">linkname</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since the link is relative, we must make it absolute:</span>
<span class="cm">	 */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%s/.build-id/%.2s/%s&quot;</span><span class="p">,</span>
		 <span class="n">debugdir</span><span class="p">,</span> <span class="n">sbuild_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlink</span><span class="p">(</span><span class="n">linkname</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">linkname</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dso__cache_build_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">debugdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_kallsyms</span> <span class="o">=</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">kernel</span> <span class="o">&amp;&amp;</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">build_id_cache__add_b</span><span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">),</span>
				     <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span> <span class="n">debugdir</span><span class="p">,</span> <span class="n">is_kallsyms</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dsos__cache_build_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">debugdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dsos__for_each_with_build_id</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dso__cache_build_id</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">debugdir</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">machine__cache_build_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">debugdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">__dsos__cache_build_ids</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kernel_dsos</span><span class="p">,</span> <span class="n">debugdir</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">__dsos__cache_build_ids</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">user_dsos</span><span class="p">,</span> <span class="n">debugdir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_session__cache_build_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">nd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">debugdir</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">debugdir</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">debugdir</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buildid_dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mkdir</span><span class="p">(</span><span class="n">debugdir</span><span class="p">,</span> <span class="mo">0755</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EEXIST</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">machine__cache_build_ids</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">,</span> <span class="n">debugdir</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nd</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">machines</span><span class="p">);</span> <span class="n">nd</span><span class="p">;</span> <span class="n">nd</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">machine</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">machine__cache_build_ids</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">debugdir</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">machine__read_build_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span> <span class="n">bool</span> <span class="n">with_hits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">__dsos__read_build_ids</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kernel_dsos</span><span class="p">,</span> <span class="n">with_hits</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">__dsos__read_build_ids</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">user_dsos</span><span class="p">,</span> <span class="n">with_hits</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">perf_session__read_build_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="n">bool</span> <span class="n">with_hits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">nd</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">machine__read_build_ids</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">,</span> <span class="n">with_hits</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nd</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">machines</span><span class="p">);</span> <span class="n">nd</span><span class="p">;</span> <span class="n">nd</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">machine</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">machine__read_build_ids</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">with_hits</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_tracing_data</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_tracing_data</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_build_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">session</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_session</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_session__read_build_ids</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dsos__write_buildid_table</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to write buildid table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_buildid_cache</span><span class="p">)</span>
		<span class="n">perf_session__cache_build_ids</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_hostname</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">utsname</span> <span class="n">uts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">uts</span><span class="p">.</span><span class="n">nodename</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_osrelease</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">utsname</span> <span class="n">uts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">uts</span><span class="p">.</span><span class="n">release</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_arch</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">utsname</span> <span class="n">uts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">uts</span><span class="p">.</span><span class="n">machine</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_version</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">perf_version_string</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_cpudesc</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CPUINFO_PROC</span>
<span class="cp">#define CPUINFO_PROC NULL</span>
<span class="cp">#endif</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">search</span> <span class="o">=</span> <span class="n">CPUINFO_PROC</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">search</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;/proc/cpuinfo&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">search</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/* squash extra space characters (branding string) */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">))</span>
				<span class="n">q</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">!=</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
				<span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">r</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">q</span><span class="o">++</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_nrcpus</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nrc</span><span class="p">,</span> <span class="n">nra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">nr</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_NPROCESSORS_CONF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">nrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="n">UINT_MAX</span><span class="p">);</span>

	<span class="n">nr</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_NPROCESSORS_ONLN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">nra</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="n">UINT_MAX</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nrc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nrc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nra</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nra</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_event_desc</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nre</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nri</span><span class="p">,</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">nre</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * write number of events</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nre</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nre</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * size of perf_event_attr struct</span>
<span class="cm">	 */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sz</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * write number of unique id per event</span>
<span class="cm">		 * there is one id per instance of an event</span>
<span class="cm">		 *</span>
<span class="cm">		 * copy into an nri to be independent of the</span>
<span class="cm">		 * type of ids,</span>
<span class="cm">		 */</span>
		<span class="n">nri</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nri</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nri</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * write event string as passed on cmdline</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">event_name</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * write unique ids for this event</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_cmdline</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">proc</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * actual atual path to perf binary</span>
<span class="cm">	 */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="s">&quot;/proc/%d/exe&quot;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">readlink</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* readlink() does not add null termination */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/* account for binary path */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">header_argc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">header_argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">header_argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CORE_SIB_FMT \</span>
<span class="cp">	&quot;/sys/devices/system/cpu/cpu%d/topology/core_siblings_list&quot;</span>
<span class="cp">#define THRD_SIB_FMT \</span>
<span class="cp">	&quot;/sys/devices/system/cpu/cpu%d/topology/thread_siblings_list&quot;</span>

<span class="k">struct</span> <span class="n">cpu_topo</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">core_sib</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">thread_sib</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">core_siblings</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">thread_siblings</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_cpu_topo</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_topo</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">CORE_SIB_FMT</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_sib</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_siblings</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_sib</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_siblings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_sib</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">THRD_SIB_FMT</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_sib</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_siblings</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_sib</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_siblings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_sib</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">if</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_cpu_topo</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_topo</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_sib</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_siblings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_sib</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_siblings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cpu_topo</span> <span class="o">*</span><span class="nf">build_cpu_topology</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_topo</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ncpus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ncpus</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_NPROCESSORS_CONF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncpus</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ncpus</span> <span class="o">&amp;</span> <span class="n">UINT_MAX</span><span class="p">);</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_siblings</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_siblings</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">build_cpu_topo</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_cpu_topo</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_cpu_topology</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_topo</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">build_cpu_topology</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_sib</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_sib</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_sib</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">core_siblings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_sib</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_sib</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_sib</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">thread_siblings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">free_cpu_topo</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_total_mem</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">mem</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;/proc/meminfo&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;MemTotal:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%*s %&quot;</span><span class="n">PRIu64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mem</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_topo_node</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">MAXPATHLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">field</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mem_total</span><span class="p">,</span> <span class="n">mem_free</span><span class="p">,</span> <span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;/sys/devices/system/node/node%d/meminfo&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* skip over invalid lines */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%*s %*d %s %&quot;</span><span class="n">PRIu64</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s">&quot;MemTotal:&quot;</span><span class="p">))</span>
			<span class="n">mem_total</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s">&quot;MemFree:&quot;</span><span class="p">))</span>
			<span class="n">mem_free</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_total</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_free</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;/sys/devices/system/node/node%d/cpulist&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_numa_topology</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_map</span> <span class="o">*</span><span class="n">node_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;/sys/devices/system/node/online&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">node_map</span> <span class="o">=</span> <span class="n">cpu_map__new</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_map</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">node_map</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">node_map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">write_topo_node</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">node_map</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * default get_cpuid(): nothing gets recorded</span>
<span class="cm"> * actual implementation must be in arch/$(ARCH)/util/header.c</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">weak</span><span class="p">))</span> <span class="n">get_cpuid</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">sz</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_cpuid</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_cpuid</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">write_it</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nl">write_it:</span>
	<span class="k">return</span> <span class="n">do_write_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_branch_stack</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span> <span class="n">__used</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_hostname</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# hostname : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_osrelease</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# os release : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_arch</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# arch : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cpudesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# cpudesc : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_nrcpus</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">))</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* interpreted as error */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# nrcpus online : %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">))</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* interpreted as error */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# nrcpus avail : %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# perf version : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cmdline</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# cmdline : &quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cpu_topology</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# sibling cores   : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# sibling threads : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_event_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nre</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">msz</span><span class="p">;</span>

	<span class="cm">/* number of events */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nre</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nre</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">nre</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">nre</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">nre</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sz</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>

	<span class="cm">/* buffer to hold on file attr struct */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">msz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&lt;</span> <span class="n">msz</span><span class="p">)</span>
		<span class="n">msz</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nre</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * must read entire on-file attr struct to</span>
<span class="cm">		 * sync up with layout.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="n">sz</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
			<span class="n">perf_event__attr_swap</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">msz</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
			<span class="n">nr</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>

		<span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# event : name = %s, &quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;type = %d, config = 0x%&quot;</span><span class="n">PRIx64</span>
			    <span class="s">&quot;, config1 = 0x%&quot;</span><span class="n">PRIx64</span><span class="s">&quot;, config2 = 0x%&quot;</span><span class="n">PRIx64</span><span class="p">,</span>
				<span class="n">attr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">attr</span><span class="p">.</span><span class="n">config1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">attr</span><span class="p">.</span><span class="n">config2</span><span class="p">);</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;, excl_usr = %d, excl_kern = %d&quot;</span><span class="p">,</span>
				<span class="n">attr</span><span class="p">.</span><span class="n">exclude_user</span><span class="p">,</span>
				<span class="n">attr</span><span class="p">.</span><span class="n">exclude_kernel</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;, id = {&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
				<span class="n">id</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
				<span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;,&#39;</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

			<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot; %&quot;</span><span class="n">PRIu64</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">==</span> <span class="n">nr</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot; }&quot;</span><span class="p">);</span>
		<span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# event desc: not available or unable to read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_total_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">mem</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mem</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# total memory : %&quot;</span><span class="n">PRIu64</span><span class="s">&quot; kB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# total memory : unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_numa_topology</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">mem_total</span><span class="p">,</span> <span class="n">mem_free</span><span class="p">;</span>

	<span class="cm">/* nr nodes */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">nr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* node number */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_total</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_free</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mem_total</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">mem_total</span><span class="p">);</span>
			<span class="n">mem_free</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">mem_free</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# node%u meminfo  : total = %&quot;</span><span class="n">PRIu64</span><span class="s">&quot; kB,&quot;</span>
			    <span class="s">&quot; free = %&quot;</span><span class="n">PRIu64</span><span class="s">&quot; kB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">c</span><span class="p">,</span>
			<span class="n">mem_total</span><span class="p">,</span>
			<span class="n">mem_free</span><span class="p">);</span>

		<span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# node%u cpu list : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# numa topology : not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cpuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">do_read_string</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# cpuid : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_branch_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span> <span class="n">__used</span><span class="p">,</span>
			       <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# contains samples with branch stack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__event_process_build_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">build_id_event</span> <span class="o">*</span><span class="n">bev</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">misc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dso_kernel_type</span> <span class="n">dso_type</span><span class="p">;</span>

	<span class="n">machine</span> <span class="o">=</span> <span class="n">perf_session__findnew_machine</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bev</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">misc</span> <span class="o">=</span> <span class="n">bev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">PERF_RECORD_MISC_CPUMODE_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">misc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_MISC_KERNEL</span>:
		<span class="n">dso_type</span> <span class="o">=</span> <span class="n">DSO_TYPE_KERNEL</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kernel_dsos</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span>:
		<span class="n">dso_type</span> <span class="o">=</span> <span class="n">DSO_TYPE_GUEST_KERNEL</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kernel_dsos</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_MISC_USER</span>:
	<span class="k">case</span> <span class="n">PERF_RECORD_MISC_GUEST_USER</span>:
		<span class="n">dso_type</span> <span class="o">=</span> <span class="n">DSO_TYPE_USER</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">user_dsos</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dso</span> <span class="o">=</span> <span class="n">__dsos__findnew</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dso</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">sbuild_id</span><span class="p">[</span><span class="n">BUILD_ID_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">dso__set_build_id</span><span class="p">(</span><span class="n">dso</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bev</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span>
			<span class="n">dso</span><span class="o">-&gt;</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">dso_type</span><span class="p">;</span>

		<span class="n">build_id__sprintf</span><span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">),</span>
				  <span class="n">sbuild_id</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;build id event received for %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span> <span class="n">sbuild_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_header__read_build_ids_abi_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_session</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">perf_event_header</span>   <span class="n">header</span><span class="p">;</span>
		<span class="n">u8</span>			   <span class="n">build_id</span><span class="p">[</span><span class="n">ALIGN</span><span class="p">(</span><span class="n">BUILD_ID_SIZE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))];</span>
		<span class="kt">char</span>			   <span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">old_bev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">build_id_event</span> <span class="n">bev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_bev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">old_bev</span><span class="p">))</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">old_bev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
			<span class="n">perf_event_header__bswap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_bev</span><span class="p">.</span><span class="n">header</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">old_bev</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">old_bev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">bev</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">old_bev</span><span class="p">.</span><span class="n">header</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * As the pid is the missing value, we need to fill</span>
<span class="cm">		 * it properly. The header.misc value give us nice hint.</span>
<span class="cm">		 */</span>
		<span class="n">bev</span><span class="p">.</span><span class="n">pid</span>	<span class="o">=</span> <span class="n">HOST_KERNEL_ID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bev</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_GUEST_USER</span> <span class="o">||</span>
		    <span class="n">bev</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span><span class="p">)</span>
			<span class="n">bev</span><span class="p">.</span><span class="n">pid</span>	<span class="o">=</span> <span class="n">DEFAULT_GUEST_KERNEL_ID</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">bev</span><span class="p">.</span><span class="n">build_id</span><span class="p">,</span> <span class="n">old_bev</span><span class="p">.</span><span class="n">build_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bev</span><span class="p">.</span><span class="n">build_id</span><span class="p">));</span>
		<span class="n">__event_process_build_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bev</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">bev</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_header__read_build_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_session</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">build_id_event</span> <span class="n">bev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">orig_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bev</span><span class="p">))</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
			<span class="n">perf_event_header__bswap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bev</span><span class="p">.</span><span class="n">header</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">bev</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * The a1645ce1 changeset:</span>
<span class="cm">		 *</span>
<span class="cm">		 * &quot;perf: &#39;perf kvm&#39; tool for monitoring guest performance from host&quot;</span>
<span class="cm">		 *</span>
<span class="cm">		 * Added a field to struct build_id_event that broke the file</span>
<span class="cm">		 * format.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Since the kernel build-id is the first entry, process the</span>
<span class="cm">		 * table using the old format if the well known</span>
<span class="cm">		 * &#39;[kernel.kallsyms]&#39; string for the kernel build-id has the</span>
<span class="cm">		 * first 4 characters chopped off (where the pid_t sits).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;nel.kallsyms]&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">orig_offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">perf_header__read_build_ids_abi_quirk</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">__event_process_build_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bev</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">bev</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_tracing_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_file_section</span> <span class="o">*</span><span class="n">section</span> <span class="n">__unused</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span> <span class="n">__unused</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">feat</span> <span class="n">__unused</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">trace_report</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_build_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_file_section</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">feat</span> <span class="n">__unused</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_header__read_build_ids</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to read buildids, continuing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">feature_ops</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">print</span><span class="p">)(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">process</span><span class="p">)(</span><span class="k">struct</span> <span class="n">perf_file_section</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">feat</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">full_only</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FEAT_OPA(n, func) \</span>
<span class="cp">	[n] = { .name = #n, .write = write_##func, .print = print_##func }</span>
<span class="cp">#define FEAT_OPP(n, func) \</span>
<span class="cp">	[n] = { .name = #n, .write = write_##func, .print = print_##func, \</span>
<span class="cp">		.process = process_##func }</span>
<span class="cp">#define FEAT_OPF(n, func) \</span>
<span class="cp">	[n] = { .name = #n, .write = write_##func, .print = print_##func, \</span>
<span class="cp">		.full_only = true }</span>

<span class="cm">/* feature_ops not implemented: */</span>
<span class="cp">#define print_tracing_data	NULL</span>
<span class="cp">#define print_build_id		NULL</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">feature_ops</span> <span class="n">feat_ops</span><span class="p">[</span><span class="n">HEADER_LAST_FEATURE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FEAT_OPP</span><span class="p">(</span><span class="n">HEADER_TRACING_DATA</span><span class="p">,</span>	<span class="n">tracing_data</span><span class="p">),</span>
	<span class="n">FEAT_OPP</span><span class="p">(</span><span class="n">HEADER_BUILD_ID</span><span class="p">,</span>	<span class="n">build_id</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_HOSTNAME</span><span class="p">,</span>	<span class="n">hostname</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_OSRELEASE</span><span class="p">,</span>	<span class="n">osrelease</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_VERSION</span><span class="p">,</span>	<span class="n">version</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_ARCH</span><span class="p">,</span>		<span class="n">arch</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_NRCPUS</span><span class="p">,</span>		<span class="n">nrcpus</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_CPUDESC</span><span class="p">,</span>	<span class="n">cpudesc</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_CPUID</span><span class="p">,</span>		<span class="n">cpuid</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_TOTAL_MEM</span><span class="p">,</span>	<span class="n">total_mem</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_EVENT_DESC</span><span class="p">,</span>	<span class="n">event_desc</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_CMDLINE</span><span class="p">,</span>	<span class="n">cmdline</span><span class="p">),</span>
	<span class="n">FEAT_OPF</span><span class="p">(</span><span class="n">HEADER_CPU_TOPOLOGY</span><span class="p">,</span>	<span class="n">cpu_topology</span><span class="p">),</span>
	<span class="n">FEAT_OPF</span><span class="p">(</span><span class="n">HEADER_NUMA_TOPOLOGY</span><span class="p">,</span>	<span class="n">numa_topology</span><span class="p">),</span>
	<span class="n">FEAT_OPA</span><span class="p">(</span><span class="n">HEADER_BRANCH_STACK</span><span class="p">,</span>	<span class="n">branch_stack</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">header_print_data</span> <span class="p">{</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">full</span><span class="p">;</span> <span class="cm">/* extended list of headers */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_file_section__fprintf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_file_section</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">feat</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">header_print_data</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to lseek to %&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot; offset for feature &quot;</span>
				<span class="s">&quot;%d, continuing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">feat</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">feat</span> <span class="o">&gt;=</span> <span class="n">HEADER_LAST_FEATURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unknown feature %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">feat</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feat_ops</span><span class="p">[</span><span class="n">feat</span><span class="p">].</span><span class="n">print</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feat_ops</span><span class="p">[</span><span class="n">feat</span><span class="p">].</span><span class="n">full_only</span> <span class="o">||</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">full</span><span class="p">)</span>
		<span class="n">feat_ops</span><span class="p">[</span><span class="n">feat</span><span class="p">].</span><span class="n">print</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# %s info available, use -I to display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">feat_ops</span><span class="p">[</span><span class="n">feat</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_header__fprintf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">full</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">header_print_data</span> <span class="n">hd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
	<span class="n">hd</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
	<span class="n">hd</span><span class="p">.</span><span class="n">full</span> <span class="o">=</span> <span class="n">full</span><span class="p">;</span>

	<span class="n">perf_header__process_sections</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hd</span><span class="p">,</span>
				      <span class="n">perf_file_section__fprintf_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_write_feat</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">perf_file_section</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_header__has_feat</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feat_ops</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">write</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">feat_ops</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">evlist</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to write feature %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

			<span class="cm">/* undo anything written */</span>
			<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_header__adds_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr_sections</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_file_section</span> <span class="o">*</span><span class="n">feat_sec</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sec_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sec_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">feat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nr_sections</span> <span class="o">=</span> <span class="n">bitmap_weight</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span> <span class="n">HEADER_FEAT_BITS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_sections</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">feat_sec</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">feat_sec</span><span class="p">),</span> <span class="n">nr_sections</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">feat_sec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sec_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">feat_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">nr_sections</span><span class="p">;</span>

	<span class="n">sec_start</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">;</span>
	<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sec_start</span> <span class="o">+</span> <span class="n">sec_size</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span> <span class="n">HEADER_FEAT_BITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_write_feat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">evlist</span><span class="p">))</span>
			<span class="n">perf_header__clear_feat</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">feat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sec_start</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * may write more than needed due to dropped feature, but</span>
<span class="cm">	 * this is okay, reader will skip the mising entries</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">feat_sec</span><span class="p">,</span> <span class="n">sec_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to write feature section</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">feat_sec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_header__write_pipe</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_pipe_file_header</span> <span class="n">f_header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">f_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">perf_pipe_file_header</span><span class="p">){</span>
		<span class="p">.</span><span class="n">magic</span>	   <span class="o">=</span> <span class="n">PERF_MAGIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_header</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_header</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to write perf pipe header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_session__write_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">bool</span> <span class="n">at_exit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_file_header</span> <span class="n">f_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_file_attr</span>   <span class="n">f_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="o">*</span><span class="n">pair</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_header</span><span class="p">),</span> <span class="n">SEEK_SET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span> <span class="o">!=</span> <span class="n">evlist</span><span class="p">)</span>
		<span class="n">pair</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">id_offset</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">out_err_write:</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to write perf header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span> <span class="o">!=</span> <span class="n">evlist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">pair</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">pair</span><span class="o">-&gt;</span><span class="n">ids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_err_write</span><span class="p">;</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">ids</span> <span class="o">+=</span> <span class="n">pair</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">;</span>
			<span class="n">pair</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pair</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">attr_offset</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f_attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">perf_file_attr</span><span class="p">){</span>
			<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ids</span>  <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">id_offset</span><span class="p">,</span>
				<span class="p">.</span><span class="n">size</span>   <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span>
			<span class="p">}</span>
		<span class="p">};</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_attr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to write perf header attribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">event_offset</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">event_size</span> <span class="o">=</span> <span class="n">event_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_trace_event_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">event_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to write perf header events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">at_exit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">perf_header__adds_write</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">evlist</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">perf_file_header</span><span class="p">){</span>
		<span class="p">.</span><span class="n">magic</span>	   <span class="o">=</span> <span class="n">PERF_MAGIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_header</span><span class="p">),</span>
		<span class="p">.</span><span class="n">attr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_attr</span><span class="p">),</span>
		<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">attr_offset</span><span class="p">,</span>
			<span class="p">.</span><span class="n">size</span>   <span class="o">=</span> <span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_attr</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">,</span>
			<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">event_types</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">event_offset</span><span class="p">,</span>
			<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">event_size</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f_header</span><span class="p">.</span><span class="n">adds_features</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">));</span>

	<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">do_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_header</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to write perf header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">frozen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_header__getbuffer64</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readn</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">mem_bswap_64</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_header__process_sections</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">process</span><span class="p">)(</span><span class="k">struct</span> <span class="n">perf_file_section</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">feat</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_file_section</span> <span class="o">*</span><span class="n">feat_sec</span><span class="p">,</span> <span class="o">*</span><span class="n">sec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_sections</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sec_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">feat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nr_sections</span> <span class="o">=</span> <span class="n">bitmap_weight</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span> <span class="n">HEADER_FEAT_BITS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_sections</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">feat_sec</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">feat_sec</span><span class="p">),</span> <span class="n">nr_sections</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feat_sec</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sec_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">feat_sec</span><span class="p">)</span> <span class="o">*</span> <span class="n">nr_sections</span><span class="p">;</span>

	<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">perf_header__getbuffer64</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">feat_sec</span><span class="p">,</span> <span class="n">sec_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span> <span class="n">HEADER_LAST_FEATURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">sec</span><span class="o">++</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">feat_sec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">attr_file_abi_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PERF_ATTR_SIZE_VER0</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PERF_ATTR_SIZE_VER1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * In the legacy file format, the magic number is not used to encode endianness.</span>
<span class="cm"> * hdr_sz was used to encode endianness. But given that hdr_sz can vary based</span>
<span class="cm"> * on ABI revisions, we need to try all combinations for all endianness to</span>
<span class="cm"> * detect the endianness.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_all_file_abis</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">hdr_sz</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">ref_size</span><span class="p">,</span> <span class="n">attr_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">attr_file_abi_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ref_size</span> <span class="o">=</span> <span class="n">attr_file_abi_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			 <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_file_section</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr_sz</span> <span class="o">!=</span> <span class="n">ref_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attr_size</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">hdr_sz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attr_size</span> <span class="o">!=</span> <span class="n">ref_size</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ABI%d perf.data file detected, need_swap=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span>
			 <span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* could not determine endianness */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PERF_PIPE_HDR_VER0	16</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">attr_pipe_abi_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PERF_PIPE_HDR_VER0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * In the legacy pipe format, there is an implicit assumption that endiannesss</span>
<span class="cm"> * between host recording the samples, and host parsing the samples is the</span>
<span class="cm"> * same. This is not always the case given that the pipe output may always be</span>
<span class="cm"> * redirected into a file and analyzed on a different machine with possibly a</span>
<span class="cm"> * different endianness and perf_event ABI revsions in the perf tool itself.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_all_pipe_abis</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">hdr_sz</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">attr_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">attr_pipe_abi_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr_sz</span> <span class="o">!=</span> <span class="n">attr_pipe_abi_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">attr_size</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">hdr_sz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attr_size</span> <span class="o">!=</span> <span class="n">hdr_sz</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Pipe ABI%d perf.data file detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_magic_endian</span><span class="p">(</span><span class="n">u64</span> <span class="n">magic</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">hdr_sz</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">is_pipe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* check for legacy format */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">magic</span><span class="p">,</span> <span class="n">__perf_magic1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">magic</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;legacy perf.data format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_pipe</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">try_all_pipe_abis</span><span class="p">(</span><span class="n">hdr_sz</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">try_all_file_abis</span><span class="p">(</span><span class="n">hdr_sz</span><span class="p">,</span> <span class="n">ph</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * the new magic number serves two purposes:</span>
<span class="cm">	 * - unique number to identify actual perf.data files</span>
<span class="cm">	 * - encode endianness of file</span>
<span class="cm">	 */</span>

	<span class="cm">/* check magic number with one endianness */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">==</span> <span class="n">__perf_magic2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check magic number with opposite endianness */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">__perf_magic2_sw</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_file_header__read</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_file_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">readn</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_magic_endian</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span>
			       <span class="n">header</span><span class="o">-&gt;</span><span class="n">attr_size</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;magic/endian check failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem_bswap_64</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_file_header</span><span class="p">,</span>
			     <span class="n">adds_features</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Support the previous format */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">),</span> <span class="n">adds_features</span><span class="p">))</span>
			<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span> <span class="n">HEADER_FEAT_BITS</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * feature bitmap is declared as an array of unsigned longs --</span>
<span class="cm">		 * not good since its size can differ between the host that</span>
<span class="cm">		 * generated the data file and the host analyzing the file.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We need to handle endianness, but we don&#39;t know the size of</span>
<span class="cm">		 * the unsigned long where the file was generated. Take a best</span>
<span class="cm">		 * guess at determining it: try 64-bit swap first (ie., file</span>
<span class="cm">		 * created on a 64-bit host), and check if the hostname feature</span>
<span class="cm">		 * bit is set (this feature bit is forced on as of fbe96f2).</span>
<span class="cm">		 * If the bit is not, undo the 64-bit swap and try a 32-bit</span>
<span class="cm">		 * swap. If the hostname bit is still not set (e.g., older data</span>
<span class="cm">		 * file), punt and fallback to the original behavior --</span>
<span class="cm">		 * clearing all feature bits and setting buildid.</span>
<span class="cm">		 */</span>
		<span class="n">mem_bswap_64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span>
			    <span class="n">BITS_TO_U64</span><span class="p">(</span><span class="n">HEADER_FEAT_BITS</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HEADER_HOSTNAME</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* unswap as u64 */</span>
			<span class="n">mem_bswap_64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span>
				    <span class="n">BITS_TO_U64</span><span class="p">(</span><span class="n">HEADER_FEAT_BITS</span><span class="p">));</span>

			<span class="cm">/* unswap as u32 */</span>
			<span class="n">mem_bswap_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span>
				    <span class="n">BITS_TO_U32</span><span class="p">(</span><span class="n">HEADER_FEAT_BITS</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HEADER_HOSTNAME</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span> <span class="n">HEADER_FEAT_BITS</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HEADER_BUILD_ID</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">adds_features</span><span class="p">));</span>

	<span class="n">ph</span><span class="o">-&gt;</span><span class="n">event_offset</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">event_types</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">ph</span><span class="o">-&gt;</span><span class="n">event_size</span>   <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">event_types</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">ph</span><span class="o">-&gt;</span><span class="n">data_offset</span>  <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">ph</span><span class="o">-&gt;</span><span class="n">data_size</span>	 <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_file_section__process</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_file_section</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">feat</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to lseek to %&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot; offset for feature &quot;</span>
			  <span class="s">&quot;%d, continuing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">feat</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">feat</span> <span class="o">&gt;=</span> <span class="n">HEADER_LAST_FEATURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;unknown feature %d, continuing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">feat</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feat_ops</span><span class="p">[</span><span class="n">feat</span><span class="p">].</span><span class="n">process</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">feat_ops</span><span class="p">[</span><span class="n">feat</span><span class="p">].</span><span class="n">process</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_file_header__read_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_pipe_file_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span>
				       <span class="n">bool</span> <span class="n">repipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">readn</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_magic_endian</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;endian/magic failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">repipe</span> <span class="o">&amp;&amp;</span> <span class="n">do_write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_header__read_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_pipe_file_header</span> <span class="n">f_header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_file_header__read_pipe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f_header</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
					<span class="n">session</span><span class="o">-&gt;</span><span class="n">repipe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;incompatible file format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">session</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_attr</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">perf_file_attr</span> <span class="o">*</span><span class="n">f_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">sz</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">our_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">f_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">f_attr</span><span class="p">));</span>

	<span class="cm">/* read minimal guaranteed structure */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">readn</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">PERF_ATTR_SIZE_VER0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cannot read %d bytes of header attr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">PERF_ATTR_SIZE_VER0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* on file perf_event_attr size */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* assume ABI0 */</span>
		<span class="n">sz</span> <span class="o">=</span>  <span class="n">PERF_ATTR_SIZE_VER0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="n">our_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;file uses a more recent and unsupported ABI&quot;</span>
			 <span class="s">&quot; (%zu bytes extra)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sz</span> <span class="o">-</span> <span class="n">our_sz</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* what we have not yet read and that we know about */</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">-</span> <span class="n">PERF_ATTR_SIZE_VER0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">attr</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">PERF_ATTR_SIZE_VER0</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">readn</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* read perf_file_section, ids are read in caller */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">readn</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_attr</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_attr</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_evsel__set_tracepoint_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">trace_find_event</span><span class="p">(</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">bf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bf</span><span class="p">),</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_evlist__set_tracepoint_names</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_TRACEPOINT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">perf_evsel__set_tracepoint_name</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_session__read_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_file_header</span>	<span class="n">f_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_file_attr</span>	<span class="n">f_attr</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">f_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_attrs</span><span class="p">,</span> <span class="n">nr_ids</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span> <span class="o">=</span> <span class="n">perf_evlist__new</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fd_pipe</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">perf_header__read_pipe</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_file_header__read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f_header</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nr_attrs</span> <span class="o">=</span> <span class="n">f_header</span><span class="p">.</span><span class="n">attrs</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">f_header</span><span class="p">.</span><span class="n">attr_size</span><span class="p">;</span>
	<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">f_header</span><span class="p">.</span><span class="n">attrs</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_attrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">;</span>
		<span class="kt">off_t</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_attr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_attr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_errno</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">needs_swap</span><span class="p">)</span>
			<span class="n">perf_event__attr_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">);</span>
		<span class="n">evsel</span> <span class="o">=</span> <span class="n">perf_evsel__new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">evsel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_delete_evlist</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do it before so that if perf_evsel__alloc_id fails, this</span>
<span class="cm">		 * entry gets purged too at perf_evlist__delete().</span>
<span class="cm">		 */</span>
		<span class="n">perf_evlist__add</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">,</span> <span class="n">evsel</span><span class="p">);</span>

		<span class="n">nr_ids</span> <span class="o">=</span> <span class="n">f_attr</span><span class="p">.</span><span class="n">ids</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t have the cpu and thread maps on the header, so</span>
<span class="cm">		 * for allocating the perf_sample_id table we fake 1 cpu and</span>
<span class="cm">		 * hattr-&gt;ids threads.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__alloc_id</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_ids</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_delete_evlist</span><span class="p">;</span>

		<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">f_attr</span><span class="p">.</span><span class="n">ids</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nr_ids</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">perf_header__getbuffer64</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f_id</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">out_errno</span><span class="p">;</span>

			<span class="n">perf_evlist__id_add</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">f_id</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">symbol_conf</span><span class="p">.</span><span class="n">nr_events</span> <span class="o">=</span> <span class="n">nr_attrs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f_header</span><span class="p">.</span><span class="n">event_types</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">f_header</span><span class="p">.</span><span class="n">event_types</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">f_header</span><span class="p">.</span><span class="n">event_types</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_header__getbuffer64</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span>
					     <span class="n">f_header</span><span class="p">.</span><span class="n">event_types</span><span class="p">.</span><span class="n">size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_errno</span><span class="p">;</span>
		<span class="n">event_count</span> <span class="o">=</span>  <span class="n">f_header</span><span class="p">.</span><span class="n">event_types</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_trace_event_type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">perf_header__process_sections</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				      <span class="n">perf_file_section__process</span><span class="p">);</span>

	<span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evlist__set_tracepoint_names</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_delete_evlist</span><span class="p">;</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">frozen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_errno:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

<span class="nl">out_delete_evlist:</span>
	<span class="n">perf_evlist__delete</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">);</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ids</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
				<span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_attr</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_header</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">ids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_RECORD_HEADER_ATTR</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				   <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">perf_event__synthesize_attr</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">,</span>
						  <span class="n">attr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">process</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to create perf header attribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__process_attr</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">**</span><span class="n">pevlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">n_ids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span> <span class="o">=</span> <span class="o">*</span><span class="n">pevlist</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evlist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pevlist</span> <span class="o">=</span> <span class="n">evlist</span> <span class="o">=</span> <span class="n">perf_evlist__new</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evlist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">evsel</span> <span class="o">=</span> <span class="n">perf_evsel__new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">evlist</span><span class="o">-&gt;</span><span class="n">nr_entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evsel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">perf_evlist__add</span><span class="p">(</span><span class="n">evlist</span><span class="p">,</span> <span class="n">evsel</span><span class="p">);</span>

	<span class="n">ids</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">ids</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">id</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">event</span><span class="p">;</span>
	<span class="n">n_ids</span> <span class="o">=</span> <span class="n">ids</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t have the cpu and thread maps on the header, so</span>
<span class="cm">	 * for allocating the perf_sample_id table we fake 1 cpu and</span>
<span class="cm">	 * hattr-&gt;ids threads.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__alloc_id</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_ids</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perf_evlist__id_add</span><span class="p">(</span><span class="n">evlist</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_event_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				      <span class="n">u64</span> <span class="n">event_id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				      <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="n">ev</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>

	<span class="n">ev</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_id</span> <span class="o">=</span> <span class="n">event_id</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_EVENT_NAME</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">MAX_EVENT_NAME</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ev</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_RECORD_HEADER_EVENT_TYPE</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">event_type</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_event_types</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				       <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_trace_event_type</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">perf_event__synthesize_event_type</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">event_id</span><span class="p">,</span>
							<span class="n">type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span>
							<span class="n">machine</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to create perf header event type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__process_event_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__unused</span><span class="p">,</span>
				   <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_header__push_event</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_id</span><span class="p">,</span>
				    <span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_tracing_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">*</span><span class="n">evlist</span><span class="p">,</span>
					<span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="n">ev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tracing_data</span> <span class="o">*</span><span class="n">tdata</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aligned_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">padding</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="n">__used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are going to store the size of the data followed</span>
<span class="cm">	 * by the data contents. Since the fd descriptor is a pipe,</span>
<span class="cm">	 * we cannot seek back to store the size of the data once</span>
<span class="cm">	 * we know it. Instead we:</span>
<span class="cm">	 *</span>
<span class="cm">	 * - write the tracing data to the temp file</span>
<span class="cm">	 * - get/write the data size to pipe</span>
<span class="cm">	 * - write the tracing data from the temp file</span>
<span class="cm">	 *   to the pipe</span>
<span class="cm">	 */</span>
	<span class="n">tdata</span> <span class="o">=</span> <span class="n">tracing_data_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>

	<span class="n">ev</span><span class="p">.</span><span class="n">tracing_data</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_RECORD_HEADER_TRACING_DATA</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">aligned_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">padding</span> <span class="o">=</span> <span class="n">aligned_size</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">tracing_data</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">tracing_data</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">tracing_data</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">aligned_size</span><span class="p">;</span>

	<span class="n">process</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The put function will copy all the tracing data</span>
<span class="cm">	 * stored in temp file to the pipe.</span>
<span class="cm">	 */</span>
	<span class="n">tracing_data_put</span><span class="p">(</span><span class="n">tdata</span><span class="p">);</span>

	<span class="n">write_padded</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">padding</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">aligned_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__process_tracing_data</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">size_read</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">tracing_data</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">off_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>

	<span class="cm">/* setup for reading amidst mmap */</span>
	<span class="n">lseek</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tracing_data_event</span><span class="p">),</span>
	      <span class="n">SEEK_SET</span><span class="p">);</span>

	<span class="n">size_read</span> <span class="o">=</span> <span class="n">trace_report</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">repipe</span><span class="p">);</span>

	<span class="n">padding</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size_read</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="o">-</span> <span class="n">size_read</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;reading input file&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">repipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">retw</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">padding</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retw</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">retw</span> <span class="o">!=</span> <span class="n">padding</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;repiping tracing data padding&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size_read</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;tracing data size mismatch&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size_read</span> <span class="o">+</span> <span class="n">padding</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_build_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">u16</span> <span class="n">misc</span><span class="p">,</span>
				    <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="n">ev</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">hit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">long_name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">NAME_ALIGN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">build_id</span><span class="p">.</span><span class="n">build_id</span><span class="p">,</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">));</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">build_id</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_RECORD_HEADER_BUILD_ID</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">build_id</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">misc</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">build_id</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">build_id</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">build_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">build_id</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">long_name_len</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__process_build_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
				 <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__event_process_build_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">,</span>
				 <span class="n">event</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span>
				 <span class="n">session</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">disable_buildid_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">no_buildid_cache</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
