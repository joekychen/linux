<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › util › dwarf-aux.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dwarf-aux.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * dwarf-aux.c : libdw auxiliary interfaces</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;stdbool.h&gt;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;dwarf-aux.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * cu_find_realpath - Find the realpath of the target file</span>
<span class="cm"> * @cu_die: A DIE(dwarf information entry) of CU(compilation Unit)</span>
<span class="cm"> * @fname:  The tail filename of the target file</span>
<span class="cm"> *</span>
<span class="cm"> * Find the real(long) path of @fname in @cu_die.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">cu_find_realpath</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">cu_die</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Files</span> <span class="o">*</span><span class="n">files</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nfiles</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fname</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dwarf_getsrcfiles</span><span class="p">(</span><span class="n">cu_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">files</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfiles</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nfiles</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">dwarf_filesrc</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strtailcmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">nfiles</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">src</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cu_get_comp_dir - Get the path of compilation directory</span>
<span class="cm"> * @cu_die: a CU DIE</span>
<span class="cm"> *</span>
<span class="cm"> * Get the path of compilation directory of given @cu_die.</span>
<span class="cm"> * Since this depends on DW_AT_comp_dir, older gcc will not</span>
<span class="cm"> * embedded it. In that case, this returns NULL.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">cu_get_comp_dir</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">cu_die</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_attr</span><span class="p">(</span><span class="n">cu_die</span><span class="p">,</span> <span class="n">DW_AT_comp_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dwarf_formstring</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cu_find_lineinfo - Get a line number and file name for given address</span>
<span class="cm"> * @cu_die: a CU DIE</span>
<span class="cm"> * @addr: An address</span>
<span class="cm"> * @fname: a pointer which returns the file name string</span>
<span class="cm"> * @lineno: a pointer which returns the line number</span>
<span class="cm"> *</span>
<span class="cm"> * Find a line number and file name for @addr in @cu_die.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cu_find_lineinfo</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">cu_die</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">fname</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lineno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Line</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="n">Dwarf_Addr</span> <span class="n">laddr</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">dwarf_getsrc_die</span><span class="p">(</span><span class="n">cu_die</span><span class="p">,</span> <span class="p">(</span><span class="n">Dwarf_Addr</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&amp;&amp;</span> <span class="n">dwarf_lineaddr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">laddr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">laddr</span> <span class="o">&amp;&amp;</span> <span class="n">dwarf_lineno</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">fname</span> <span class="o">=</span> <span class="n">dwarf_linesrc</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">fname</span><span class="p">)</span>
			<span class="cm">/* line number is useless without filename */</span>
			<span class="o">*</span><span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">lineno</span> <span class="o">?:</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__die_find_inline_cb</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * cu_walk_functions_at - Walk on function DIEs at given address</span>
<span class="cm"> * @cu_die: A CU DIE</span>
<span class="cm"> * @addr: An address</span>
<span class="cm"> * @callback: A callback which called with found DIEs</span>
<span class="cm"> * @data: A user data</span>
<span class="cm"> *</span>
<span class="cm"> * Walk on function DIEs at given @addr in @cu_die. Passed DIEs</span>
<span class="cm"> * should be subprogram or inlined-subroutines.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cu_walk_functions_at</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">cu_die</span><span class="p">,</span> <span class="n">Dwarf_Addr</span> <span class="n">addr</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Die</span> <span class="n">die_mem</span><span class="p">;</span>
	<span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">sc_die</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="cm">/* Inlined function could be recursive. Trace it until fail */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">sc_die</span> <span class="o">=</span> <span class="n">die_find_realfunc</span><span class="p">(</span><span class="n">cu_die</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">die_mem</span><span class="p">);</span>
	     <span class="n">sc_die</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">sc_die</span> <span class="o">=</span> <span class="n">die_find_child</span><span class="p">(</span><span class="n">sc_die</span><span class="p">,</span> <span class="n">__die_find_inline_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">die_mem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">sc_die</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_compare_name - Compare diename and tname</span>
<span class="cm"> * @dw_die: a DIE</span>
<span class="cm"> * @tname: a string of target name</span>
<span class="cm"> *</span>
<span class="cm"> * Compare the name of @dw_die and @tname. Return false if @dw_die has no name.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">die_compare_name</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">dw_die</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">dwarf_diename</span><span class="p">(</span><span class="n">dw_die</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">name</span> <span class="o">?</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_get_call_lineno - Get callsite line number of inline-function instance</span>
<span class="cm"> * @in_die: a DIE of an inlined function instance</span>
<span class="cm"> *</span>
<span class="cm"> * Get call-site line number of @in_die. This means from where the inline</span>
<span class="cm"> * function is called.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">die_get_call_lineno</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">in_die</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="n">Dwarf_Word</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwarf_attr</span><span class="p">(</span><span class="n">in_die</span><span class="p">,</span> <span class="n">DW_AT_call_line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">dwarf_formudata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_get_type - Get type DIE</span>
<span class="cm"> * @vr_die: a DIE of a variable</span>
<span class="cm"> * @die_mem: where to store a type DIE</span>
<span class="cm"> *</span>
<span class="cm"> * Get a DIE of the type of given variable (@vr_die), and store</span>
<span class="cm"> * it to die_mem. Return NULL if fails to get a type DIE.</span>
<span class="cm"> */</span>
<span class="n">Dwarf_Die</span> <span class="o">*</span><span class="nf">die_get_type</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">vr_die</span><span class="p">,</span> <span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Attribute</span> <span class="n">attr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_attr_integrate</span><span class="p">(</span><span class="n">vr_die</span><span class="p">,</span> <span class="n">DW_AT_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dwarf_formref_die</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">die_mem</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">die_mem</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get a type die, but skip qualifiers */</span>
<span class="k">static</span> <span class="n">Dwarf_Die</span> <span class="o">*</span><span class="nf">__die_get_real_type</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">vr_die</span><span class="p">,</span> <span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">vr_die</span> <span class="o">=</span> <span class="n">die_get_type</span><span class="p">(</span><span class="n">vr_die</span><span class="p">,</span> <span class="n">die_mem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vr_die</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">dwarf_tag</span><span class="p">(</span><span class="n">vr_die</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_const_type</span> <span class="o">||</span>
		 <span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_restrict_type</span> <span class="o">||</span>
		 <span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_volatile_type</span> <span class="o">||</span>
		 <span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_shared_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vr_die</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_get_real_type - Get a type die, but skip qualifiers and typedef</span>
<span class="cm"> * @vr_die: a DIE of a variable</span>
<span class="cm"> * @die_mem: where to store a type DIE</span>
<span class="cm"> *</span>
<span class="cm"> * Get a DIE of the type of given variable (@vr_die), and store</span>
<span class="cm"> * it to die_mem. Return NULL if fails to get a type DIE.</span>
<span class="cm"> * If the type is qualifiers (e.g. const) or typedef, this skips it</span>
<span class="cm"> * and tries to find real type (structure or basic types, e.g. int).</span>
<span class="cm"> */</span>
<span class="n">Dwarf_Die</span> <span class="o">*</span><span class="nf">die_get_real_type</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">vr_die</span><span class="p">,</span> <span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">vr_die</span> <span class="o">=</span> <span class="n">__die_get_real_type</span><span class="p">(</span><span class="n">vr_die</span><span class="p">,</span> <span class="n">die_mem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">vr_die</span> <span class="o">&amp;&amp;</span> <span class="n">dwarf_tag</span><span class="p">(</span><span class="n">vr_die</span><span class="p">)</span> <span class="o">==</span> <span class="n">DW_TAG_typedef</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vr_die</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get attribute and translate it as a udata */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">die_get_attr_udata</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">tp_die</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">attr_name</span><span class="p">,</span>
			      <span class="n">Dwarf_Word</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Attribute</span> <span class="n">attr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_attr</span><span class="p">(</span><span class="n">tp_die</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">dwarf_formudata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get attribute and translate it as a sdata */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">die_get_attr_sdata</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">tp_die</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">attr_name</span><span class="p">,</span>
			      <span class="n">Dwarf_Sword</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Attribute</span> <span class="n">attr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_attr</span><span class="p">(</span><span class="n">tp_die</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">dwarf_formsdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_is_signed_type - Check whether a type DIE is signed or not</span>
<span class="cm"> * @tp_die: a DIE of a type</span>
<span class="cm"> *</span>
<span class="cm"> * Get the encoding of @tp_die and return true if the encoding</span>
<span class="cm"> * is signed.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">die_is_signed_type</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">tp_die</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Word</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">die_get_attr_udata</span><span class="p">(</span><span class="n">tp_die</span><span class="p">,</span> <span class="n">DW_AT_encoding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">DW_ATE_signed_char</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">DW_ATE_signed</span> <span class="o">||</span>
		<span class="n">ret</span> <span class="o">==</span> <span class="n">DW_ATE_signed_fixed</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_get_data_member_location - Get the data-member offset</span>
<span class="cm"> * @mb_die: a DIE of a member of a data structure</span>
<span class="cm"> * @offs: The offset of the member in the data structure</span>
<span class="cm"> *</span>
<span class="cm"> * Get the offset of @mb_die in the data structure including @mb_die, and</span>
<span class="cm"> * stores result offset to @offs. If any error occurs this returns errno.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">die_get_data_member_location</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">mb_die</span><span class="p">,</span> <span class="n">Dwarf_Word</span> <span class="o">*</span><span class="n">offs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="n">Dwarf_Op</span> <span class="o">*</span><span class="n">expr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nexpr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_attr</span><span class="p">(</span><span class="n">mb_die</span><span class="p">,</span> <span class="n">DW_AT_data_member_location</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_formudata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">offs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DW_AT_data_member_location should be DW_OP_plus_uconst */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dwarf_getlocation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nexpr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nexpr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">atom</span> <span class="o">!=</span> <span class="n">DW_OP_plus_uconst</span> <span class="o">||</span> <span class="n">nexpr</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Unable to get offset:Unexpected OP %x (%zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">atom</span><span class="p">,</span> <span class="n">nexpr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dwarf_Word</span><span class="p">)</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">number</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the call file index number in CU DIE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">die_get_call_fileno</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">in_die</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Sword</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">die_get_attr_sdata</span><span class="p">(</span><span class="n">in_die</span><span class="p">,</span> <span class="n">DW_AT_call_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">idx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the declared file index number in CU DIE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">die_get_decl_fileno</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">pdie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Sword</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">die_get_attr_sdata</span><span class="p">(</span><span class="n">pdie</span><span class="p">,</span> <span class="n">DW_AT_decl_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">idx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_get_call_file - Get callsite file name of inlined function instance</span>
<span class="cm"> * @in_die: a DIE of an inlined function instance</span>
<span class="cm"> *</span>
<span class="cm"> * Get call-site file name of @in_die. This means from which file the inline</span>
<span class="cm"> * function is called.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">die_get_call_file</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">in_die</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Die</span> <span class="n">cu_die</span><span class="p">;</span>
	<span class="n">Dwarf_Files</span> <span class="o">*</span><span class="n">files</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">die_get_call_fileno</span><span class="p">(</span><span class="n">in_die</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">dwarf_diecu</span><span class="p">(</span><span class="n">in_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cu_die</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">dwarf_getsrcfiles</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cu_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">files</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dwarf_filesrc</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * die_find_child - Generic DIE search function in DIE tree</span>
<span class="cm"> * @rt_die: a root DIE</span>
<span class="cm"> * @callback: a callback function</span>
<span class="cm"> * @data: a user data passed to the callback function</span>
<span class="cm"> * @die_mem: a buffer for result DIE</span>
<span class="cm"> *</span>
<span class="cm"> * Trace DIE tree from @rt_die and call @callback for each child DIE.</span>
<span class="cm"> * If @callback returns DIE_FIND_CB_END, this stores the DIE into</span>
<span class="cm"> * @die_mem and returns it. If @callback returns DIE_FIND_CB_CONTINUE,</span>
<span class="cm"> * this continues to trace the tree. Optionally, @callback can return</span>
<span class="cm"> * DIE_FIND_CB_CHILD and DIE_FIND_CB_SIBLING, those means trace only</span>
<span class="cm"> * the children and trace only the siblings respectively.</span>
<span class="cm"> * Returns NULL if @callback can&#39;t find any appropriate DIE.</span>
<span class="cm"> */</span>
<span class="n">Dwarf_Die</span> <span class="o">*</span><span class="nf">die_find_child</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">rt_die</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Die</span> <span class="n">child_die</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dwarf_child</span><span class="p">(</span><span class="n">rt_die</span><span class="p">,</span> <span class="n">die_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">die_mem</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">DIE_FIND_CB_END</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">die_mem</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">DIE_FIND_CB_CHILD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">die_find_child</span><span class="p">(</span><span class="n">die_mem</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child_die</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">die_mem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child_die</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Dwarf_Die</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">die_mem</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">DIE_FIND_CB_SIBLING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">dwarf_siblingof</span><span class="p">(</span><span class="n">die_mem</span><span class="p">,</span> <span class="n">die_mem</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">__addr_die_search_param</span> <span class="p">{</span>
	<span class="n">Dwarf_Addr</span>	<span class="n">addr</span><span class="p">;</span>
	<span class="n">Dwarf_Die</span>	<span class="o">*</span><span class="n">die_mem</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* die_find callback for non-inlined function search */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__die_search_func_cb</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">fn_die</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__addr_die_search_param</span> <span class="o">*</span><span class="n">ad</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_tag</span><span class="p">(</span><span class="n">fn_die</span><span class="p">)</span> <span class="o">==</span> <span class="n">DW_TAG_subprogram</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dwarf_haspc</span><span class="p">(</span><span class="n">fn_die</span><span class="p">,</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">die_mem</span><span class="p">,</span> <span class="n">fn_die</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Dwarf_Die</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">DWARF_CB_ABORT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">DWARF_CB_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_find_realfunc - Search a non-inlined function at given address</span>
<span class="cm"> * @cu_die: a CU DIE which including @addr</span>
<span class="cm"> * @addr: target address</span>
<span class="cm"> * @die_mem: a buffer for result DIE</span>
<span class="cm"> *</span>
<span class="cm"> * Search a non-inlined function DIE which includes @addr. Stores the</span>
<span class="cm"> * DIE to @die_mem and returns it if found. Returns NULl if failed.</span>
<span class="cm"> */</span>
<span class="n">Dwarf_Die</span> <span class="o">*</span><span class="nf">die_find_realfunc</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">cu_die</span><span class="p">,</span> <span class="n">Dwarf_Addr</span> <span class="n">addr</span><span class="p">,</span>
				    <span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__addr_die_search_param</span> <span class="n">ad</span><span class="p">;</span>
	<span class="n">ad</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">ad</span><span class="p">.</span><span class="n">die_mem</span> <span class="o">=</span> <span class="n">die_mem</span><span class="p">;</span>
	<span class="cm">/* dwarf_getscopes can&#39;t find subprogram. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwarf_getfuncs</span><span class="p">(</span><span class="n">cu_die</span><span class="p">,</span> <span class="n">__die_search_func_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">die_mem</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* die_find callback for inline function search */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__die_find_inline_cb</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Addr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_tag</span><span class="p">(</span><span class="n">die_mem</span><span class="p">)</span> <span class="o">==</span> <span class="n">DW_TAG_inlined_subroutine</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dwarf_haspc</span><span class="p">(</span><span class="n">die_mem</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DIE_FIND_CB_END</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">DIE_FIND_CB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_find_inlinefunc - Search an inlined function at given address</span>
<span class="cm"> * @cu_die: a CU DIE which including @addr</span>
<span class="cm"> * @addr: target address</span>
<span class="cm"> * @die_mem: a buffer for result DIE</span>
<span class="cm"> *</span>
<span class="cm"> * Search an inlined function DIE which includes @addr. Stores the</span>
<span class="cm"> * DIE to @die_mem and returns it if found. Returns NULl if failed.</span>
<span class="cm"> * If several inlined functions are expanded recursively, this trace</span>
<span class="cm"> * it and returns deepest one.</span>
<span class="cm"> */</span>
<span class="n">Dwarf_Die</span> <span class="o">*</span><span class="nf">die_find_inlinefunc</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">sp_die</span><span class="p">,</span> <span class="n">Dwarf_Addr</span> <span class="n">addr</span><span class="p">,</span>
			       <span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Die</span> <span class="n">tmp_die</span><span class="p">;</span>

	<span class="n">sp_die</span> <span class="o">=</span> <span class="n">die_find_child</span><span class="p">(</span><span class="n">sp_die</span><span class="p">,</span> <span class="n">__die_find_inline_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_die</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp_die</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Inlined function could be recursive. Trace it until fail */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sp_die</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">die_mem</span><span class="p">,</span> <span class="n">sp_die</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Dwarf_Die</span><span class="p">));</span>
		<span class="n">sp_die</span> <span class="o">=</span> <span class="n">die_find_child</span><span class="p">(</span><span class="n">sp_die</span><span class="p">,</span> <span class="n">__die_find_inline_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">tmp_die</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">die_mem</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">__instance_walk_param</span> <span class="p">{</span>
	<span class="kt">void</span>    <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>    <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">retval</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__die_walk_instances_cb</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">inst</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__instance_walk_param</span> <span class="o">*</span><span class="n">iwp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">Dwarf_Attribute</span> <span class="n">attr_mem</span><span class="p">;</span>
	<span class="n">Dwarf_Die</span> <span class="n">origin_mem</span><span class="p">;</span>
	<span class="n">Dwarf_Attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">origin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">attr</span> <span class="o">=</span> <span class="n">dwarf_attr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">DW_AT_abstract_origin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DIE_FIND_CB_CONTINUE</span><span class="p">;</span>

	<span class="n">origin</span> <span class="o">=</span> <span class="n">dwarf_formref_die</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">origin_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">origin</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">origin</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DIE_FIND_CB_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* Ignore redundant instances */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_tag</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">==</span> <span class="n">DW_TAG_inlined_subroutine</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dwarf_decl_line</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">die_get_call_lineno</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">==</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">die_get_decl_fileno</span><span class="p">(</span><span class="n">origin</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">die_get_call_fileno</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">==</span> <span class="n">tmp</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">DIE_FIND_CB_CONTINUE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">iwp</span><span class="o">-&gt;</span><span class="n">retval</span> <span class="o">=</span> <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">iwp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">iwp</span><span class="o">-&gt;</span><span class="n">retval</span><span class="p">)</span> <span class="o">?</span> <span class="n">DIE_FIND_CB_END</span> <span class="o">:</span> <span class="n">DIE_FIND_CB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_walk_instances - Walk on instances of given DIE</span>
<span class="cm"> * @or_die: an abstract original DIE</span>
<span class="cm"> * @callback: a callback function which is called with instance DIE</span>
<span class="cm"> * @data: user data</span>
<span class="cm"> *</span>
<span class="cm"> * Walk on the instances of give @in_die. @in_die must be an inlined function</span>
<span class="cm"> * declartion. This returns the return value of @callback if it returns</span>
<span class="cm"> * non-zero value, or -ENOENT if there is no instance.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">die_walk_instances</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">or_die</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Die</span> <span class="n">cu_die</span><span class="p">;</span>
	<span class="n">Dwarf_Die</span> <span class="n">die_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__instance_walk_param</span> <span class="n">iwp</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">or_die</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_diecu</span><span class="p">(</span><span class="n">or_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cu_die</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">die_find_child</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cu_die</span><span class="p">,</span> <span class="n">__die_walk_instances_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">die_mem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">iwp</span><span class="p">.</span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Line walker internal parameters */</span>
<span class="k">struct</span> <span class="n">__line_walk_param</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">recursive</span><span class="p">;</span>
	<span class="n">line_walk_callback_t</span> <span class="n">callback</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__die_walk_funclines_cb</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">in_die</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__line_walk_param</span> <span class="o">*</span><span class="n">lw</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">Dwarf_Addr</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lineno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_tag</span><span class="p">(</span><span class="n">in_die</span><span class="p">)</span> <span class="o">==</span> <span class="n">DW_TAG_inlined_subroutine</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fname</span> <span class="o">=</span> <span class="n">die_get_call_file</span><span class="p">(</span><span class="n">in_die</span><span class="p">);</span>
		<span class="n">lineno</span> <span class="o">=</span> <span class="n">die_get_call_lineno</span><span class="p">(</span><span class="n">in_die</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="o">&amp;&amp;</span> <span class="n">lineno</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dwarf_entrypc</span><span class="p">(</span><span class="n">in_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lw</span><span class="o">-&gt;</span><span class="n">retval</span> <span class="o">=</span> <span class="n">lw</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">lw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lw</span><span class="o">-&gt;</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">DIE_FIND_CB_END</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lw</span><span class="o">-&gt;</span><span class="n">recursive</span><span class="p">)</span>
		<span class="cm">/* Don&#39;t need to search recursively */</span>
		<span class="k">return</span> <span class="n">DIE_FIND_CB_SIBLING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fname</span> <span class="o">=</span> <span class="n">dwarf_decl_file</span><span class="p">(</span><span class="n">in_die</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="o">&amp;&amp;</span> <span class="n">dwarf_decl_line</span><span class="p">(</span><span class="n">in_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lineno</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lw</span><span class="o">-&gt;</span><span class="n">retval</span> <span class="o">=</span> <span class="n">lw</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">lw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lw</span><span class="o">-&gt;</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">DIE_FIND_CB_END</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Continue to search nested inlined function call-sites */</span>
	<span class="k">return</span> <span class="n">DIE_FIND_CB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Walk on lines of blocks included in given DIE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__die_walk_funclines</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">sp_die</span><span class="p">,</span> <span class="n">bool</span> <span class="n">recursive</span><span class="p">,</span>
				<span class="n">line_walk_callback_t</span> <span class="n">callback</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__line_walk_param</span> <span class="n">lw</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">recursive</span> <span class="o">=</span> <span class="n">recursive</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">Dwarf_Die</span> <span class="n">die_mem</span><span class="p">;</span>
	<span class="n">Dwarf_Addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lineno</span><span class="p">;</span>

	<span class="cm">/* Handle function declaration line */</span>
	<span class="n">fname</span> <span class="o">=</span> <span class="n">dwarf_decl_file</span><span class="p">(</span><span class="n">sp_die</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="o">&amp;&amp;</span> <span class="n">dwarf_decl_line</span><span class="p">(</span><span class="n">sp_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lineno</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dwarf_entrypc</span><span class="p">(</span><span class="n">sp_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lw</span><span class="p">.</span><span class="n">retval</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lw</span><span class="p">.</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">die_find_child</span><span class="p">(</span><span class="n">sp_die</span><span class="p">,</span> <span class="n">__die_walk_funclines_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">die_mem</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">lw</span><span class="p">.</span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__die_walk_culines_cb</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">sp_die</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__line_walk_param</span> <span class="o">*</span><span class="n">lw</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">lw</span><span class="o">-&gt;</span><span class="n">retval</span> <span class="o">=</span> <span class="n">__die_walk_funclines</span><span class="p">(</span><span class="n">sp_die</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">lw</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">,</span> <span class="n">lw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lw</span><span class="o">-&gt;</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DWARF_CB_ABORT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">DWARF_CB_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_walk_lines - Walk on lines inside given DIE</span>
<span class="cm"> * @rt_die: a root DIE (CU, subprogram or inlined_subroutine)</span>
<span class="cm"> * @callback: callback routine</span>
<span class="cm"> * @data: user data</span>
<span class="cm"> *</span>
<span class="cm"> * Walk on all lines inside given @rt_die and call @callback on each line.</span>
<span class="cm"> * If the @rt_die is a function, walk only on the lines inside the function,</span>
<span class="cm"> * otherwise @rt_die must be a CU DIE.</span>
<span class="cm"> * Note that this walks not only dwarf line list, but also function entries</span>
<span class="cm"> * and inline call-site.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">die_walk_lines</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">rt_die</span><span class="p">,</span> <span class="n">line_walk_callback_t</span> <span class="n">callback</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Lines</span> <span class="o">*</span><span class="n">lines</span><span class="p">;</span>
	<span class="n">Dwarf_Line</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="n">Dwarf_Addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Dwarf_Die</span> <span class="n">die_mem</span><span class="p">,</span> <span class="o">*</span><span class="n">cu_die</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nlines</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Get the CU die */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_tag</span><span class="p">(</span><span class="n">rt_die</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DW_TAG_compile_unit</span><span class="p">)</span>
		<span class="n">cu_die</span> <span class="o">=</span> <span class="n">dwarf_diecu</span><span class="p">(</span><span class="n">rt_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">die_mem</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cu_die</span> <span class="o">=</span> <span class="n">rt_die</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cu_die</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug2</span><span class="p">(</span><span class="s">&quot;Failed to get CU from given DIE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get lines list in the CU */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_getsrclines</span><span class="p">(</span><span class="n">cu_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lines</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nlines</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug2</span><span class="p">(</span><span class="s">&quot;Failed to get source lines on this CU.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug2</span><span class="p">(</span><span class="s">&quot;Get %zd lines from this CU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nlines</span><span class="p">);</span>

	<span class="cm">/* Walk on the lines on lines list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nlines</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">line</span> <span class="o">=</span> <span class="n">dwarf_onesrcline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">dwarf_lineno</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lineno</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">dwarf_lineaddr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug2</span><span class="p">(</span><span class="s">&quot;Failed to get line info. &quot;</span>
				  <span class="s">&quot;Possible error in debuginfo.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Filter lines based on address */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt_die</span> <span class="o">!=</span> <span class="n">cu_die</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * Address filtering</span>
<span class="cm">			 * The line is included in given function, and</span>
<span class="cm">			 * no inline block includes it.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwarf_haspc</span><span class="p">(</span><span class="n">rt_die</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">die_find_inlinefunc</span><span class="p">(</span><span class="n">rt_die</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">die_mem</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Get source line */</span>
		<span class="n">fname</span> <span class="o">=</span> <span class="n">dwarf_linesrc</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dwarf lines doesn&#39;t include function declarations and inlined</span>
<span class="cm">	 * subroutines. We have to check functions list or given function.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt_die</span> <span class="o">!=</span> <span class="n">cu_die</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t need walk functions recursively, because nested</span>
<span class="cm">		 * inlined functions don&#39;t have lines of the specified DIE.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__die_walk_funclines</span><span class="p">(</span><span class="n">rt_die</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">__line_walk_param</span> <span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">,</span>
			<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
			<span class="p">.</span><span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="n">dwarf_getfuncs</span><span class="p">(</span><span class="n">cu_die</span><span class="p">,</span> <span class="n">__die_walk_culines_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">__find_variable_param</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">Dwarf_Addr</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__die_find_variable_cb</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__find_variable_param</span> <span class="o">*</span><span class="n">fvp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">dwarf_tag</span><span class="p">(</span><span class="n">die_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_formal_parameter</span> <span class="o">||</span>
	     <span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_variable</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">die_compare_name</span><span class="p">(</span><span class="n">die_mem</span><span class="p">,</span> <span class="n">fvp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DIE_FIND_CB_END</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwarf_haspc</span><span class="p">(</span><span class="n">die_mem</span><span class="p">,</span> <span class="n">fvp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DIE_FIND_CB_CONTINUE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">DIE_FIND_CB_SIBLING</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_find_variable_at - Find a given name variable at given address</span>
<span class="cm"> * @sp_die: a function DIE</span>
<span class="cm"> * @name: variable name</span>
<span class="cm"> * @addr: address</span>
<span class="cm"> * @die_mem: a buffer for result DIE</span>
<span class="cm"> *</span>
<span class="cm"> * Find a variable DIE called @name at @addr in @sp_die.</span>
<span class="cm"> */</span>
<span class="n">Dwarf_Die</span> <span class="o">*</span><span class="nf">die_find_variable_at</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">sp_die</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				<span class="n">Dwarf_Addr</span> <span class="n">addr</span><span class="p">,</span> <span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__find_variable_param</span> <span class="n">fvp</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">};</span>

	<span class="k">return</span> <span class="n">die_find_child</span><span class="p">(</span><span class="n">sp_die</span><span class="p">,</span> <span class="n">__die_find_variable_cb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fvp</span><span class="p">,</span>
			      <span class="n">die_mem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__die_find_member_cb</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dwarf_tag</span><span class="p">(</span><span class="n">die_mem</span><span class="p">)</span> <span class="o">==</span> <span class="n">DW_TAG_member</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">die_compare_name</span><span class="p">(</span><span class="n">die_mem</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DIE_FIND_CB_END</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">DIE_FIND_CB_SIBLING</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_find_member - Find a given name member in a data structure</span>
<span class="cm"> * @st_die: a data structure type DIE</span>
<span class="cm"> * @name: member name</span>
<span class="cm"> * @die_mem: a buffer for result DIE</span>
<span class="cm"> *</span>
<span class="cm"> * Find a member DIE called @name in @st_die.</span>
<span class="cm"> */</span>
<span class="n">Dwarf_Die</span> <span class="o">*</span><span class="nf">die_find_member</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">st_die</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">die_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">die_find_child</span><span class="p">(</span><span class="n">st_die</span><span class="p">,</span> <span class="n">__die_find_member_cb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">,</span>
			      <span class="n">die_mem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_get_typename - Get the name of given variable DIE</span>
<span class="cm"> * @vr_die: a variable DIE</span>
<span class="cm"> * @buf: a buffer for result type name</span>
<span class="cm"> * @len: a max-length of @buf</span>
<span class="cm"> *</span>
<span class="cm"> * Get the name of @vr_die and stores it to @buf. Return the actual length</span>
<span class="cm"> * of type name if succeeded. Return -E2BIG if @len is not enough long, and</span>
<span class="cm"> * Return -ENOENT if failed to find type name.</span>
<span class="cm"> * Note that the result will stores typedef name if possible, and stores</span>
<span class="cm"> * &quot;*(function_type)&quot; if the type is a function pointer.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">die_get_typename</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">vr_die</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Dwarf_Die</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ret2</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__die_get_real_type</span><span class="p">(</span><span class="n">vr_die</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">dwarf_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_array_type</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_pointer_type</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_subroutine_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Function pointer */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;(function_type)&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">E2BIG</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwarf_diename</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_union_type</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;union &quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">DW_TAG_structure_type</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;struct &quot;</span><span class="p">;</span>
		<span class="cm">/* Write a base name */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">dwarf_diename</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">E2BIG</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">die_get_typename</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret2</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret2</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">ret</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">E2BIG</span> <span class="o">:</span> <span class="n">ret2</span> <span class="o">+</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * die_get_varname - Get the name and type of given variable DIE</span>
<span class="cm"> * @vr_die: a variable DIE</span>
<span class="cm"> * @buf: a buffer for type and variable name</span>
<span class="cm"> * @len: the max-length of @buf</span>
<span class="cm"> *</span>
<span class="cm"> * Get the name and type of @vr_die and stores it in @buf as &quot;type\tname&quot;.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">die_get_varname</span><span class="p">(</span><span class="n">Dwarf_Die</span> <span class="o">*</span><span class="n">vr_die</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ret2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">die_get_typename</span><span class="p">(</span><span class="n">vr_die</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to get type, make it unknown.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;(unknown_type)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret2</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%s&quot;</span><span class="p">,</span>
				<span class="n">dwarf_diename</span><span class="p">(</span><span class="n">vr_die</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret2</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">ret</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">E2BIG</span> <span class="o">:</span> <span class="n">ret2</span> <span class="o">+</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
