<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › util › session.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>session.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#define _FILE_OFFSET_BITS 64</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;byteswap.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/mman.h&gt;</span>

<span class="cp">#include &quot;evlist.h&quot;</span>
<span class="cp">#include &quot;evsel.h&quot;</span>
<span class="cp">#include &quot;session.h&quot;</span>
<span class="cp">#include &quot;tool.h&quot;</span>
<span class="cp">#include &quot;sort.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;cpumap.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_session__open</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stat</span> <span class="n">input_stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">fd_pipe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">STDIN_FILENO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">perf_session__read_header</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;incompatible file format (rerun with -v to learn more)&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>

		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to open %s: %s&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">ENOENT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;perf.data&quot;</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  (try &#39;perf record&#39; first)&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_stat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_close</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="n">input_stat</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">input_stat</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">!=</span> <span class="n">geteuid</span><span class="p">()))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;file %s not owned by current user or root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;zero-sized file (%s), nothing to do!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_session__read_header</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;incompatible file format (rerun with -v to learn more)&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_evlist__valid_sample_type</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;non matching sample_type&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_evlist__valid_sample_id_all</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;non matching sample_id_all&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">input_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_close:</span>
	<span class="n">close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">perf_session__update_sample_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">=</span> <span class="n">perf_evlist__sample_type</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">__perf_evsel__sample_size</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sample_type</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">sample_id_all</span> <span class="o">=</span> <span class="n">perf_evlist__sample_id_all</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span> <span class="o">=</span> <span class="n">perf_evlist__id_hdr_size</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">.</span><span class="n">id_hdr_size</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_session__create_kernel_maps</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">machine__create_kernel_maps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">machines__create_guest_kernel_maps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">machines</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_session__destroy_kernel_maps</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">machine__destroy_kernel_maps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">);</span>
	<span class="n">machines__destroy_guest_kernel_maps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">machines</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="nf">perf_session__new</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
				       <span class="n">bool</span> <span class="n">force</span><span class="p">,</span> <span class="n">bool</span> <span class="n">repipe</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filename</span> <span class="o">||</span> <span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fstat</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;perf.data&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
	<span class="n">self</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * On 64bit we can mmap the data file in one go. No need for tiny mmap</span>
<span class="cm">	 * slices. On 32bit we use 32MB.</span>
<span class="cm">	 */</span>
<span class="cp">#if BITS_PER_LONG == 64</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">mmap_window</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">mmap_window</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024ULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">machines</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">repipe</span> <span class="o">=</span> <span class="n">repipe</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">.</span><span class="n">samples</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">.</span><span class="n">sample_cache</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">.</span><span class="n">to_free</span><span class="p">);</span>
	<span class="n">machine__init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">HOST_KERNEL_ID</span><span class="p">);</span>
	<span class="n">hists__init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_session__open</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_delete</span><span class="p">;</span>
		<span class="n">perf_session__update_sample_type</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">O_WRONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * In O_RDONLY mode this will be performed when reading the</span>
<span class="cm">		 * kernel MMAP event, in perf_event__process_mmap().</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_session__create_kernel_maps</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_delete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span> <span class="o">&amp;&amp;</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">ordering_requires_timestamps</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tool</span><span class="o">-&gt;</span><span class="n">ordered_samples</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sample_id_all</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;WARNING: No sample_id_all support, falling back to unordered processing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">ordered_samples</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="nl">out_delete:</span>
	<span class="n">perf_session__delete</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">machine__delete_dead_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">dead_threads</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">thread__delete</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_session__delete_dead_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">machine__delete_dead_threads</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">machine__delete_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">nd</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>

		<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">);</span>
		<span class="n">nd</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
		<span class="n">thread__delete</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_session__delete_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">machine__delete_threads</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">perf_session__delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">perf_session__destroy_kernel_maps</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="n">perf_session__delete_dead_threads</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="n">perf_session__delete_threads</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="n">machine__exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine__remove_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">th</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">last_match</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We may have references to this thread, for instance in some hist_entry</span>
<span class="cm">	 * instances, so just move them to a separate list.</span>
<span class="cm">	 */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">dead_threads</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">symbol__match_parent_regex</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">regexec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent_regex</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cpumodes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PERF_RECORD_MISC_USER</span><span class="p">,</span>
	<span class="n">PERF_RECORD_MISC_KERNEL</span><span class="p">,</span>
	<span class="n">PERF_RECORD_MISC_GUEST_USER</span><span class="p">,</span>
	<span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span>
<span class="p">};</span>
<span class="cp">#define NCPUMODES (sizeof(cpumodes)/sizeof(u8))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip__resolve_ams</span><span class="p">(</span><span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">addr_map_symbol</span> <span class="o">*</span><span class="n">ams</span><span class="p">,</span>
			    <span class="n">u64</span> <span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">addr_location</span> <span class="n">al</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">al</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">al</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NCPUMODES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">cpumodes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/*</span>
<span class="cm">		 * We cannot use the header.misc hint to determine whether a</span>
<span class="cm">		 * branch stack address is user, kernel, guest, hypervisor.</span>
<span class="cm">		 * Branches may straddle the kernel/user/hypervisor boundaries.</span>
<span class="cm">		 * Thus, we have to try consecutively until we find a match</span>
<span class="cm">		 * or else, the symbol is unknown</span>
<span class="cm">		 */</span>
		<span class="n">thread__find_addr_location</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">MAP__FUNCTION</span><span class="p">,</span>
				<span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">al</span><span class="p">.</span><span class="n">sym</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">found:</span>
	<span class="n">ams</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
	<span class="n">ams</span><span class="o">-&gt;</span><span class="n">al_addr</span> <span class="o">=</span> <span class="n">al</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">ams</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">=</span> <span class="n">al</span><span class="p">.</span><span class="n">sym</span><span class="p">;</span>
	<span class="n">ams</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">=</span> <span class="n">al</span><span class="p">.</span><span class="n">map</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">branch_info</span> <span class="o">*</span><span class="nf">machine__resolve_bstack</span><span class="p">(</span><span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">thr</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">branch_stack</span> <span class="o">*</span><span class="n">bs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">branch_info</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">bi</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">bs</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">branch_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bi</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip__resolve_ams</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span><span class="p">,</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span><span class="p">);</span>
		<span class="n">ip__resolve_ams</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">from</span><span class="p">,</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">from</span><span class="p">);</span>
		<span class="n">bi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bi</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">machine__resolve_callchain</span><span class="p">(</span><span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ip_callchain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">symbol</span> <span class="o">**</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cpumode</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_USER</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">callchain_cursor_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callchain_cursor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="n">PERF_MAX_STACK_DEPTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;corrupted callchain. skipping...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">ip</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">addr_location</span> <span class="n">al</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">callchain_param</span><span class="p">.</span><span class="n">order</span> <span class="o">==</span> <span class="n">ORDER_CALLEE</span><span class="p">)</span>
			<span class="n">ip</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ips</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">ip</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ips</span><span class="p">[</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="o">&gt;=</span> <span class="n">PERF_CONTEXT_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PERF_CONTEXT_HV</span>:
				<span class="n">cpumode</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_HYPERVISOR</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PERF_CONTEXT_KERNEL</span>:
				<span class="n">cpumode</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_KERNEL</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PERF_CONTEXT_USER</span>:
				<span class="n">cpumode</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_USER</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid callchain context: &quot;</span>
					 <span class="s">&quot;%&quot;</span><span class="n">PRId64</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">ip</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * It seems the callchain is corrupted.</span>
<span class="cm">				 * Discard all.</span>
<span class="cm">				 */</span>
				<span class="n">callchain_cursor_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callchain_cursor</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">al</span><span class="p">.</span><span class="n">filtered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">thread__find_addr_location</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">cpumode</span><span class="p">,</span>
					   <span class="n">MAP__FUNCTION</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">al</span><span class="p">.</span><span class="n">sym</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sort__has_parent</span> <span class="o">&amp;&amp;</span> <span class="o">!*</span><span class="n">parent</span> <span class="o">&amp;&amp;</span>
			    <span class="n">symbol__match_parent_regex</span><span class="p">(</span><span class="n">al</span><span class="p">.</span><span class="n">sym</span><span class="p">))</span>
				<span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">al</span><span class="p">.</span><span class="n">sym</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">use_callchain</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">callchain_cursor_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callchain_cursor</span><span class="p">,</span>
					      <span class="n">ip</span><span class="p">,</span> <span class="n">al</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">al</span><span class="p">.</span><span class="n">sym</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_event_synth_tracing_data_stub</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="n">__used</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;: unhandled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_event_synth_attr_stub</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="n">__used</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">perf_evlist</span> <span class="o">**</span><span class="n">pevlist</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;: unhandled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_event_sample_stub</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
				     <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="n">__used</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span> <span class="n">__used</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;: unhandled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_event_stub</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="n">__used</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span> <span class="n">__used</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;: unhandled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_finished_round_stub</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
				       <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="n">__used</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">perf_session</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;: unhandled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_event_type_stub</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
				   <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;: unhandled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">process_finished_round</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_tool__fill_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">sample</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">sample</span> <span class="o">=</span> <span class="n">process_event_sample_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">mmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">process_event_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">comm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">comm</span> <span class="o">=</span> <span class="n">process_event_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">fork</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">fork</span> <span class="o">=</span> <span class="n">process_event_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">=</span> <span class="n">process_event_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">=</span> <span class="n">perf_event__process_lost</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">process_event_sample_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">throttle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">process_event_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">unthrottle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">process_event_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">=</span> <span class="n">process_event_synth_attr_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">process_event_type_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">tracing_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">tracing_data</span> <span class="o">=</span> <span class="n">process_event_synth_tracing_data_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">build_id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tool</span><span class="o">-&gt;</span><span class="n">build_id</span> <span class="o">=</span> <span class="n">process_finished_round_stub</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">finished_round</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">)</span>
			<span class="n">tool</span><span class="o">-&gt;</span><span class="n">finished_round</span> <span class="o">=</span> <span class="n">process_finished_round</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tool</span><span class="o">-&gt;</span><span class="n">finished_round</span> <span class="o">=</span> <span class="n">process_finished_round_stub</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">mem_bswap_32</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">byte_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">byte_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">);</span>
		<span class="n">byte_size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="o">++</span><span class="n">m</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mem_bswap_64</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">byte_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">byte_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">);</span>
		<span class="n">byte_size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
		<span class="o">++</span><span class="n">m</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">swap_sample_id_all</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">event</span> <span class="o">+</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">mem_bswap_64</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__all64_swap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				   <span class="n">bool</span> <span class="n">sample_id_all</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_header</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="n">mem_bswap_64</span><span class="p">(</span><span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__comm_swap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sample_id_all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample_id_all</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="n">swap_sample_id_all</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__mmap_swap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">sample_id_all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pid</span>	  <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">tid</span>	  <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span>	  <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pgoff</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pgoff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample_id_all</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="n">swap_sample_id_all</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__task_swap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sample_id_all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">pid</span>	 <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">tid</span>	 <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">ppid</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">ppid</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">ptid</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">ptid</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample_id_all</span><span class="p">)</span>
		<span class="n">swap_sample_id_all</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__read_swap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sample_id_all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">pid</span>		 <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">tid</span>		 <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">value</span>	 <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">time_enabled</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">time_enabled</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">time_running</span> <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">time_running</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">id</span>		 <span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample_id_all</span><span class="p">)</span>
		<span class="n">swap_sample_id_all</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">revbyte</span><span class="p">(</span><span class="n">u8</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x33</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xaa</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">rev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * XXX this is hack in attempt to carry flags bitfield</span>
<span class="cm"> * throught endian village. ABI says:</span>
<span class="cm"> *</span>
<span class="cm"> * Bit-fields are allocated from right to left (least to most significant)</span>
<span class="cm"> * on little-endian implementations and from left to right (most to least</span>
<span class="cm"> * significant) on big-endian implementations.</span>
<span class="cm"> *</span>
<span class="cm"> * The above seems to be byte specific, so we need to reverse each</span>
<span class="cm"> * byte of the bitfield. &#39;Internet&#39; also says this might be implementation</span>
<span class="cm"> * specific and we probably need proper fix and carry perf_event_attr</span>
<span class="cm"> * bitfield flags in separate data file FEAT_ section. Thought this seems</span>
<span class="cm"> * to work for now.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">swap_bitfield</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">revbyte</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* exported for swapping attributes in file header */</span>
<span class="kt">void</span> <span class="nf">perf_event__attr_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">size</span>		<span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">config</span>		<span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_period</span>	<span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_period</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_type</span>	<span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">sample_type</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">read_format</span>	<span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">read_format</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">wakeup_events</span>	<span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">wakeup_events</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_type</span>		<span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_type</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_addr</span>		<span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_addr</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_len</span>		<span class="o">=</span> <span class="n">bswap_64</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">bp_len</span><span class="p">);</span>

	<span class="n">swap_bitfield</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">read_format</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__hdr_attr_swap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">sample_id_all</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">perf_event__attr_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">id</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">event</span><span class="p">;</span>
	<span class="n">mem_bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__event_type_swap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">sample_id_all</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_id</span> <span class="o">=</span>
		<span class="n">bswap_64</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_type</span><span class="p">.</span><span class="n">event_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__tracing_data_swap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					  <span class="n">bool</span> <span class="n">sample_id_all</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">tracing_data</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">tracing_data</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">perf_event__swap_op</span><span class="p">)(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				    <span class="n">bool</span> <span class="n">sample_id_all</span><span class="p">);</span>

<span class="k">static</span> <span class="n">perf_event__swap_op</span> <span class="n">perf_event__swap_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PERF_RECORD_MMAP</span><span class="p">]</span>		  <span class="o">=</span> <span class="n">perf_event__mmap_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_COMM</span><span class="p">]</span>		  <span class="o">=</span> <span class="n">perf_event__comm_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_FORK</span><span class="p">]</span>		  <span class="o">=</span> <span class="n">perf_event__task_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_EXIT</span><span class="p">]</span>		  <span class="o">=</span> <span class="n">perf_event__task_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_LOST</span><span class="p">]</span>		  <span class="o">=</span> <span class="n">perf_event__all64_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_READ</span><span class="p">]</span>		  <span class="o">=</span> <span class="n">perf_event__read_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_SAMPLE</span><span class="p">]</span>		  <span class="o">=</span> <span class="n">perf_event__all64_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_HEADER_ATTR</span><span class="p">]</span>	  <span class="o">=</span> <span class="n">perf_event__hdr_attr_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_HEADER_EVENT_TYPE</span><span class="p">]</span>	  <span class="o">=</span> <span class="n">perf_event__event_type_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_HEADER_TRACING_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">perf_event__tracing_data_swap</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_HEADER_BUILD_ID</span><span class="p">]</span>	  <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_HEADER_MAX</span><span class="p">]</span>	  <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sample_queue</span> <span class="p">{</span>
	<span class="n">u64</span>			<span class="n">timestamp</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">file_offset</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">perf_event</span>	<span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_session_free_sample_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ordered_samples</span> <span class="o">*</span><span class="n">os</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">to_free</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sample_queue</span> <span class="o">*</span><span class="n">sq</span><span class="p">;</span>

		<span class="n">sq</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">to_free</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sample_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">sq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_session_deliver_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				      <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				      <span class="n">u64</span> <span class="n">file_offset</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_sample_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ordered_samples</span> <span class="o">*</span><span class="n">os</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sample_queue</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_sample</span> <span class="n">sample</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">next_flush</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">last_ts</span> <span class="o">=</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">last_sample</span> <span class="o">?</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">last_sample</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">:</span> <span class="mi">0ULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">progress_next</span> <span class="o">=</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">nr_samples</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">ordered_samples</span> <span class="o">||</span> <span class="o">!</span><span class="n">limit</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">perf_session__parse_sample</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t parse sample, err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">perf_session_deliver_event</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span>
						   <span class="n">iter</span><span class="o">-&gt;</span><span class="n">file_offset</span><span class="p">);</span>

		<span class="n">os</span><span class="o">-&gt;</span><span class="n">last_flush</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_cache</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">progress_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">progress_next</span> <span class="o">+=</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">nr_samples</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ui_progress__update</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">nr_samples</span><span class="p">,</span>
					    <span class="s">&quot;Processing time ordered events...&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">os</span><span class="o">-&gt;</span><span class="n">last_sample</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">last_ts</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">os</span><span class="o">-&gt;</span><span class="n">last_sample</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sample_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">os</span><span class="o">-&gt;</span><span class="n">nr_samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When perf record finishes a pass on every buffers, it records this pseudo</span>
<span class="cm"> * event.</span>
<span class="cm"> * We record the max timestamp t found in the pass n.</span>
<span class="cm"> * Assuming these timestamps are monotonic across cpus, we know that if</span>
<span class="cm"> * a buffer still has events with timestamps below t, they will be all</span>
<span class="cm"> * available and then read in the pass n + 1.</span>
<span class="cm"> * Hence when we start to read the pass n + 2, we can safely flush every</span>
<span class="cm"> * events with timestamps below t.</span>
<span class="cm"> *</span>
<span class="cm"> *    ============ PASS n =================</span>
<span class="cm"> *       CPU 0         |   CPU 1</span>
<span class="cm"> *                     |</span>
<span class="cm"> *    cnt1 timestamps  |   cnt2 timestamps</span>
<span class="cm"> *          1          |         2</span>
<span class="cm"> *          2          |         3</span>
<span class="cm"> *          -          |         4  &lt;--- max recorded</span>
<span class="cm"> *</span>
<span class="cm"> *    ============ PASS n + 1 ==============</span>
<span class="cm"> *       CPU 0         |   CPU 1</span>
<span class="cm"> *                     |</span>
<span class="cm"> *    cnt1 timestamps  |   cnt2 timestamps</span>
<span class="cm"> *          3          |         5</span>
<span class="cm"> *          4          |         6</span>
<span class="cm"> *          5          |         7 &lt;---- max recorded</span>
<span class="cm"> *</span>
<span class="cm"> *      Flush every events below timestamp 4</span>
<span class="cm"> *</span>
<span class="cm"> *    ============ PASS n + 2 ==============</span>
<span class="cm"> *       CPU 0         |   CPU 1</span>
<span class="cm"> *                     |</span>
<span class="cm"> *    cnt1 timestamps  |   cnt2 timestamps</span>
<span class="cm"> *          6          |         8</span>
<span class="cm"> *          7          |         9</span>
<span class="cm"> *          -          |         10</span>
<span class="cm"> *</span>
<span class="cm"> *      Flush every events below timestamp 7</span>
<span class="cm"> *      etc...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_finished_round</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="n">__used</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_sample_queue</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tool</span><span class="p">);</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">.</span><span class="n">next_flush</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">.</span><span class="n">max_timestamp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The queue is ordered by time */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__queue_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">sample_queue</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ordered_samples</span> <span class="o">*</span><span class="n">os</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sample_queue</span> <span class="o">*</span><span class="n">sample</span> <span class="o">=</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">last_sample</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="o">++</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">nr_samples</span><span class="p">;</span>
	<span class="n">os</span><span class="o">-&gt;</span><span class="n">last_sample</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sample</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">);</span>
		<span class="n">os</span><span class="o">-&gt;</span><span class="n">max_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * last_sample might point to some random place in the list as it&#39;s</span>
<span class="cm">	 * the last queued event. We expect that the new event is close to</span>
<span class="cm">	 * this.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sample</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sample</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">);</span>
				<span class="n">os</span><span class="o">-&gt;</span><span class="n">max_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sample</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sample_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sample</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sample</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sample_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define MAX_SAMPLE_BUFFER	(64 * 1024 / sizeof(struct sample_queue))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_session_queue_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">,</span> <span class="n">u64</span> <span class="n">file_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ordered_samples</span> <span class="o">*</span><span class="n">os</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_cache</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sample_queue</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timestamp</span> <span class="o">||</span> <span class="n">timestamp</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">.</span><span class="n">last_flush</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Warning: Timestamp below last timeslice flush</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sample_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer</span> <span class="o">+</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer_idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer_idx</span> <span class="o">==</span> <span class="n">MAX_SAMPLE_BUFFER</span><span class="p">)</span>
			<span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">MAX_SAMPLE_BUFFER</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">to_free</span><span class="p">);</span>
		<span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer_idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">os</span><span class="o">-&gt;</span><span class="n">sample_buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">file_offset</span> <span class="o">=</span> <span class="n">file_offset</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">__queue_event</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">callchain__printf</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;... chain: nr:%&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;..... %2d: %016&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="o">-&gt;</span><span class="n">ips</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">branch_stack__printf</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;... branch stack: nr:%&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">branch_stack</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">branch_stack</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;..... %2&quot;</span><span class="n">PRIu64</span><span class="s">&quot;: %016&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; -&gt; %016&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">branch_stack</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">from</span><span class="p">,</span>
			<span class="n">sample</span><span class="o">-&gt;</span><span class="n">branch_stack</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_session__print_tstamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				       <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PERF_RECORD_SAMPLE</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">sample_id_all</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fputs</span><span class="p">(</span><span class="s">&quot;-1 -1 &quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">&amp;</span> <span class="n">PERF_SAMPLE_CPU</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%u &quot;</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">&amp;</span> <span class="n">PERF_SAMPLE_TIME</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		       <span class="n">u64</span> <span class="n">file_offset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dump_trace</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; [%#x]: event: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">file_offset</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

	<span class="n">trace_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample</span><span class="p">)</span>
		<span class="n">perf_session__print_tstamp</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; [%#x]: PERF_RECORD_%s&quot;</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span>
	       <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">perf_event__name</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dump_trace</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;(IP, %d): %d/%d: %#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; period: %&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot; addr: %#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
	       <span class="n">sample</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">&amp;</span> <span class="n">PERF_SAMPLE_CALLCHAIN</span><span class="p">)</span>
		<span class="n">callchain__printf</span><span class="p">(</span><span class="n">sample</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">&amp;</span> <span class="n">PERF_SAMPLE_BRANCH_STACK</span><span class="p">)</span>
		<span class="n">branch_stack__printf</span><span class="p">(</span><span class="n">sample</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span>
	<span class="nf">perf_session__find_machine_for_cpumode</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
					       <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">cpumode</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">PERF_RECORD_MISC_CPUMODE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span> <span class="o">&amp;&amp;</span> <span class="n">perf_guest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_RECORD_MMAP</span><span class="p">)</span>
			<span class="n">pid</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pid</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pid</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">pid</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">perf_session__find_machine</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">perf_session__find_host_machine</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_session_deliver_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				      <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				      <span class="n">u64</span> <span class="n">file_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">;</span>

	<span class="n">dump_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">sample</span><span class="p">);</span>

	<span class="n">evsel</span> <span class="o">=</span> <span class="n">perf_evlist__id2evsel</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evsel</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PERF_RECORD_SAMPLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX We&#39;re leaving PERF_RECORD_SAMPLE unnacounted here</span>
<span class="cm">		 * because the tools right now may apply filters, discarding</span>
<span class="cm">		 * some of the samples. For consistency, in the future we</span>
<span class="cm">		 * should have something like nr_filtered_samples and remove</span>
<span class="cm">		 * the sample-&gt;period from total_sample_period, etc, KISS for</span>
<span class="cm">		 * now tho.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Also testing against NULL allows us to handle files without</span>
<span class="cm">		 * attr.sample_id_all and/or without PERF_SAMPLE_ID. In the</span>
<span class="cm">		 * future probably it&#39;ll be a good idea to restrict event</span>
<span class="cm">		 * processing via perf_session to files with both set.</span>
<span class="cm">		 */</span>
		<span class="n">hists__inc_nr_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">machine</span> <span class="o">=</span> <span class="n">perf_session__find_machine_for_cpumode</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_SAMPLE</span>:
		<span class="n">dump_sample</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evsel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unknown_id</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">machine</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unprocessable_samples</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">sample</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_MMAP</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_COMM</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_FORK</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_EXIT</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_LOST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">==</span> <span class="n">perf_event__process_lost</span><span class="p">)</span>
			<span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">total_lost</span> <span class="o">+=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">.</span><span class="n">lost</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_READ</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_THROTTLE</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">throttle</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_UNTHROTTLE</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">unthrottle</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="o">++</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unknown_events</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_session__preprocess_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
					   <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PERF_RECORD_SAMPLE</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">&amp;</span> <span class="n">PERF_SAMPLE_CALLCHAIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip_callchain__valid</span><span class="p">(</span><span class="n">sample</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;call-chain problem with event, skipping it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">++</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_invalid_chains</span><span class="p">;</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">total_invalid_chains</span> <span class="o">+=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_session__process_user_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span> <span class="n">u64</span> <span class="n">file_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dump_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* These events are processed right away */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_HEADER_ATTR</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">perf_session__update_sample_type</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_HEADER_EVENT_TYPE</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_HEADER_TRACING_DATA</span>:
		<span class="cm">/* setup for reading amidst mmap */</span>
		<span class="n">lseek</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">tracing_data</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_HEADER_BUILD_ID</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_FINISHED_ROUND</span>:
		<span class="k">return</span> <span class="n">tool</span><span class="o">-&gt;</span><span class="n">finished_round</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">event_swap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sample_id_all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">perf_event__swap_op</span> <span class="n">swap</span><span class="p">;</span>

	<span class="n">swap</span> <span class="o">=</span> <span class="n">perf_event__swap_ops</span><span class="p">[</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">swap</span><span class="p">)</span>
		<span class="n">swap</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">sample_id_all</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_session__process_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				       <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				       <span class="n">u64</span> <span class="n">file_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_sample</span> <span class="n">sample</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">event_swap</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">sample_id_all</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">PERF_RECORD_HEADER_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">hists__inc_nr_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">PERF_RECORD_USER_TYPE_START</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">perf_session__process_user_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For all kernel events we get the sample data</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">perf_session__parse_sample</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Preprocess sample records - precheck callchains */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_session__preprocess_sample</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">perf_session_queue_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">,</span>
					       <span class="n">file_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">perf_session_deliver_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span>
					  <span class="n">file_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">perf_event_header__bswap</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_header</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">bswap_32</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">=</span> <span class="n">bswap_16</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">misc</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">bswap_16</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="nf">perf_session__findnew</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">machine__findnew_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="nf">perf_session__register_idle_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">perf_session__findnew</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">thread__set_comm</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="s">&quot;swapper&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;problem inserting idle task.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kr">thread</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_session__warn_about_errors</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tool</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">==</span> <span class="n">perf_event__process_lost</span> <span class="o">&amp;&amp;</span>
	    <span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_events</span><span class="p">[</span><span class="n">PERF_RECORD_LOST</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;Processed %d events and lost %d chunks!</span><span class="se">\n\n</span><span class="s">&quot;</span>
			    <span class="s">&quot;Check IO/CPU overload!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			    <span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_events</span><span class="p">[</span><span class="n">PERF_RECORD_LOST</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unknown_events</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;Found %u unknown events!</span><span class="se">\n\n</span><span class="s">&quot;</span>
			    <span class="s">&quot;Is this an older tool processing a perf.data &quot;</span>
			    <span class="s">&quot;file generated by a more recent tool?</span><span class="se">\n\n</span><span class="s">&quot;</span>
			    <span class="s">&quot;If that is not the case, consider &quot;</span>
			    <span class="s">&quot;reporting to linux-kernel@vger.kernel.org.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unknown_events</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unknown_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;%u samples with id not present in the header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unknown_id</span><span class="p">);</span>
	<span class="p">}</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_invalid_chains</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;Found invalid callchains!</span><span class="se">\n\n</span><span class="s">&quot;</span>
 			    <span class="s">&quot;%u out of %u events were discarded for this reason.</span><span class="se">\n\n</span><span class="s">&quot;</span>
 			    <span class="s">&quot;Consider reporting to linux-kernel@vger.kernel.org.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
 			    <span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_invalid_chains</span><span class="p">,</span>
 			    <span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_events</span><span class="p">[</span><span class="n">PERF_RECORD_SAMPLE</span><span class="p">]);</span>
 	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unprocessable_samples</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;%u unprocessable samples recorded.</span><span class="se">\n</span><span class="s">&quot;</span>
			    <span class="s">&quot;Do you have a KVM guest running and not using &#39;perf kvm&#39;?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">nr_unprocessable_samples</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define session_done()	(*(volatile int *)(&amp;session_done))</span>
<span class="k">volatile</span> <span class="kt">int</span> <span class="n">session_done</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__perf_session__process_pipe_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">cur_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">perf_tool__fill_defaults</span><span class="p">(</span><span class="n">tool</span><span class="p">);</span>

	<span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cur_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">cur_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
<span class="nl">more:</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">readn</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_header</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to read event header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">perf_event_header__bswap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">cur_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to allocate memory to read event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">cur_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_header</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">readn</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_header</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unexpected end of event stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to read event data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skip</span> <span class="o">=</span> <span class="n">perf_session__process_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">head</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; [%#x]: failed to process type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">head</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">head</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">head</span> <span class="o">+=</span> <span class="n">skip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">session_done</span><span class="p">())</span>
		<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">perf_session__warn_about_errors</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">);</span>
	<span class="n">perf_session_free_sample_buffers</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span>
<span class="nf">fetch_mmaped_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
		   <span class="n">u64</span> <span class="n">head</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">mmap_size</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ensure we have enough space remaining to read</span>
<span class="cm">	 * the size of the event in the headers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mmap_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">event</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">head</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">needs_swap</span><span class="p">)</span>
		<span class="n">perf_event_header__bswap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">+</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">mmap_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">event</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__perf_session__process_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data_size</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">file_size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">head</span><span class="p">,</span> <span class="n">page_offset</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">file_pos</span><span class="p">,</span> <span class="n">progress_next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">mmap_prot</span><span class="p">,</span> <span class="n">mmap_flags</span><span class="p">,</span> <span class="n">map_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span>	<span class="n">page_size</span><span class="p">,</span> <span class="n">mmap_size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">mmaps</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">perf_tool__fill_defaults</span><span class="p">(</span><span class="n">tool</span><span class="p">);</span>

	<span class="n">page_size</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGESIZE</span><span class="p">);</span>

	<span class="n">page_offset</span> <span class="o">=</span> <span class="n">page_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">/</span> <span class="n">page_size</span><span class="p">);</span>
	<span class="n">file_offset</span> <span class="o">=</span> <span class="n">page_offset</span><span class="p">;</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">data_offset</span> <span class="o">-</span> <span class="n">page_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">+</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="n">file_size</span><span class="p">)</span>
		<span class="n">file_size</span> <span class="o">=</span> <span class="n">data_offset</span> <span class="o">+</span> <span class="n">data_size</span><span class="p">;</span>

	<span class="n">progress_next</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">mmap_size</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">mmap_window</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmap_size</span> <span class="o">&gt;</span> <span class="n">file_size</span><span class="p">)</span>
		<span class="n">mmap_size</span> <span class="o">=</span> <span class="n">file_size</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mmaps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mmaps</span><span class="p">));</span>

	<span class="n">mmap_prot</span>  <span class="o">=</span> <span class="n">PROT_READ</span><span class="p">;</span>
	<span class="n">mmap_flags</span> <span class="o">=</span> <span class="n">MAP_SHARED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">needs_swap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmap_prot</span>  <span class="o">|=</span> <span class="n">PROT_WRITE</span><span class="p">;</span>
		<span class="n">mmap_flags</span> <span class="o">=</span> <span class="n">MAP_PRIVATE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">remap:</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mmap_size</span><span class="p">,</span> <span class="n">mmap_prot</span><span class="p">,</span> <span class="n">mmap_flags</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span>
		   <span class="n">file_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to mmap file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mmaps</span><span class="p">[</span><span class="n">map_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">map_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mmaps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">file_pos</span> <span class="o">=</span> <span class="n">file_offset</span> <span class="o">+</span> <span class="n">head</span><span class="p">;</span>

<span class="nl">more:</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">fetch_mmaped_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">mmap_size</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmaps</span><span class="p">[</span><span class="n">map_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">munmap</span><span class="p">(</span><span class="n">mmaps</span><span class="p">[</span><span class="n">map_idx</span><span class="p">],</span> <span class="n">mmap_size</span><span class="p">);</span>
			<span class="n">mmaps</span><span class="p">[</span><span class="n">map_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">page_offset</span> <span class="o">=</span> <span class="n">page_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">head</span> <span class="o">/</span> <span class="n">page_size</span><span class="p">);</span>
		<span class="n">file_offset</span> <span class="o">+=</span> <span class="n">page_offset</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">-=</span> <span class="n">page_offset</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">remap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">perf_session__process_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">file_pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; [%#x]: failed to process type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">file_offset</span> <span class="o">+</span> <span class="n">head</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
		       <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">head</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">file_pos</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file_pos</span> <span class="o">&gt;=</span> <span class="n">progress_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">progress_next</span> <span class="o">+=</span> <span class="n">file_size</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ui_progress__update</span><span class="p">(</span><span class="n">file_pos</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span>
				    <span class="s">&quot;Processing events...&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file_pos</span> <span class="o">&lt;</span> <span class="n">file_size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* do the final flush for ordered samples */</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">ordered_samples</span><span class="p">.</span><span class="n">next_flush</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
	<span class="n">flush_sample_queue</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tool</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="n">perf_session__warn_about_errors</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tool</span><span class="p">);</span>
	<span class="n">perf_session_free_sample_buffers</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_session__process_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_session__register_idle_thread</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">fd_pipe</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__perf_session__process_events</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
						     <span class="n">self</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">data_offset</span><span class="p">,</span>
						     <span class="n">self</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">data_size</span><span class="p">,</span>
						     <span class="n">self</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">tool</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__perf_session__process_pipe_events</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">perf_session__has_traces</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sample_type</span> <span class="o">&amp;</span> <span class="n">PERF_SAMPLE_RAW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No trace sample to read. Did you call &#39;perf %s&#39;?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">maps__set_kallsyms_ref_reloc_sym</span><span class="p">(</span><span class="k">struct</span> <span class="n">map</span> <span class="o">**</span><span class="n">maps</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbol_name</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bracket</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">map_type</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ref_reloc_sym</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>

	<span class="n">ref</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ref_reloc_sym</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">symbol_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bracket</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;]&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bracket</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bracket</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAP__NR_TYPES</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kmap</span> <span class="o">*</span><span class="n">kmap</span> <span class="o">=</span> <span class="n">map__kmap</span><span class="p">(</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kmap</span><span class="o">-&gt;</span><span class="n">ref_reloc_sym</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">perf_session__fprintf_dsos</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__dsos__fprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">.</span><span class="n">kernel_dsos</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">+</span>
	       <span class="n">__dsos__fprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">.</span><span class="n">user_dsos</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">+</span>
	       <span class="n">machines__fprintf_dsos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">machines</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">perf_session__fprintf_dsos_buildid</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
					  <span class="n">bool</span> <span class="n">with_hits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">machine__fprintf_dsos_buildid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">with_hits</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="n">machines__fprintf_dsos_buildid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">machines</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">with_hits</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">perf_session__fprintf_nr_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;Aggregated stats:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">+=</span> <span class="n">hists__fprintf_nr_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;%s stats:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="p">(</span><span class="n">pos</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">hists__fprintf_nr_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">hists</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">perf_session__fprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME: Here we have to actually print all the machines in this</span>
<span class="cm">	 * session, not just the host...</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">machine__fprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">perf_session__remove_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">th</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME: This one makes no sense, we need to remove the thread from</span>
<span class="cm">	 * the machine it belongs to, perf_session can have many machines, so</span>
<span class="cm">	 * doing it always on -&gt;host_machine is wrong.  Fix when auditing all</span>
<span class="cm">	 * the &#39;perf kvm&#39; code.</span>
<span class="cm">	 */</span>
	<span class="n">machine__remove_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">host_machine</span><span class="p">,</span> <span class="n">th</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="nf">perf_session__find_first_evtype</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">evlist</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">perf_event__print_ip</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">print_sym</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print_dso</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print_symoffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">addr_location</span> <span class="n">al</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">callchain_cursor_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_event__preprocess_sample</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span><span class="p">(</span><span class="s">&quot;problem processing %d event, skipping it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">use_callchain</span> <span class="o">&amp;&amp;</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">machine__resolve_callchain</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">al</span><span class="p">.</span><span class="kr">thread</span><span class="p">,</span>
						<span class="n">sample</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
				<span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to resolve callchain. Skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">callchain_cursor_commit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callchain_cursor</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">callchain_cursor_current</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callchain_cursor</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">%16&quot;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">print_sym</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
				<span class="n">symbol__fprintf_symname</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">sym</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">print_dso</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot; (&quot;</span><span class="p">);</span>
				<span class="n">map__fprintf_dsoname</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">callchain_cursor_advance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callchain_cursor</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%16&quot;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_sym</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">print_symoffset</span><span class="p">)</span>
				<span class="n">symbol__fprintf_symname_offs</span><span class="p">(</span><span class="n">al</span><span class="p">.</span><span class="n">sym</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al</span><span class="p">,</span>
							     <span class="n">stdout</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">symbol__fprintf_symname</span><span class="p">(</span><span class="n">al</span><span class="p">.</span><span class="n">sym</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">print_dso</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; (&quot;</span><span class="p">);</span>
			<span class="n">map__fprintf_dsoname</span><span class="p">(</span><span class="n">al</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_session__cpu_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cpu_list</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">cpu_bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PERF_TYPE_MAX</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">;</span>

		<span class="n">evsel</span> <span class="o">=</span> <span class="n">perf_session__find_first_evtype</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evsel</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">&amp;</span> <span class="n">PERF_SAMPLE_CPU</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;File does not contain CPU events. &quot;</span>
			       <span class="s">&quot;Remove -c option to proceed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">cpu_map__new</span><span class="p">(</span><span class="n">cpu_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Invalid cpu_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">&gt;=</span> <span class="n">MAX_NR_CPUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Requested CPU %d too large. &quot;</span>
			       <span class="s">&quot;Consider raising MAX_NR_CPUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">cpu_bitmap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">perf_session__fprintf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">full</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fstat</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# ========</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# captured on: %s&quot;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">.</span><span class="n">st_ctime</span><span class="p">));</span>
	<span class="n">perf_header__fprintf_info</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">full</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;# ========</span><span class="se">\n</span><span class="s">#</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
