<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › util › annotate.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>annotate.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2011, Red Hat Inc, Arnaldo Carvalho de Melo &lt;acme@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Parts came from builtin-annotate.c, see those files for further</span>
<span class="cm"> * copyright notes.</span>
<span class="cm"> *</span>
<span class="cm"> * Released under the GPL v2. (and only v2, not any later version)</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;build-id.h&quot;</span>
<span class="cp">#include &quot;color.h&quot;</span>
<span class="cp">#include &quot;cache.h&quot;</span>
<span class="cp">#include &quot;symbol.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;annotate.h&quot;</span>
<span class="cp">#include &lt;pthread.h&gt;</span>

<span class="k">const</span> <span class="kt">char</span> 	<span class="o">*</span><span class="n">disassembler_style</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins__find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disasm_line__parse</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">namep</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">rawp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ins__delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ins__raw_scnprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%-6.6s %s&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ins__scnprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">scnprintf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">scnprintf</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ins__raw_scnprintf</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">call__parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endptr</span><span class="p">,</span> <span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endptr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">endptr</span><span class="p">,</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">indirect_call</span><span class="p">;</span>

	<span class="n">name</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tok</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tok</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tok</span> <span class="o">=</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">indirect_call:</span>
	<span class="n">tok</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">endptr</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tok</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tok</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">endptr</span><span class="p">,</span> <span class="sc">&#39;*&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tok</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">tok</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">call__scnprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%-6.6s %s&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ins__raw_scnprintf</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%-6.6s *%&quot;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ins_ops</span> <span class="n">call_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parse</span>	   <span class="o">=</span> <span class="n">call__parse</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scnprintf</span> <span class="o">=</span> <span class="n">call__scnprintf</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">bool</span> <span class="nf">ins__is_call</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">call_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jump__parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">,</span> <span class="sc">&#39;+&#39;</span><span class="p">);</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">strtoll</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">++</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">strtoll</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">UINT64_MAX</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jump__scnprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%-6.6s %&quot;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ins_ops</span> <span class="n">jump_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parse</span>	   <span class="o">=</span> <span class="n">jump__parse</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scnprintf</span> <span class="o">=</span> <span class="n">jump__scnprintf</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">bool</span> <span class="nf">ins__is_jump</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">comment__symbol</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">raw</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comment</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">addrp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">namep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endptr</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;(%rip)&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">addrp</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endptr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">endptr</span><span class="p">,</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">name</span><span class="o">++</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lock__parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ops</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disasm_line__parse</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_ops</span><span class="p">;</span>

        <span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ins</span> <span class="o">=</span> <span class="n">ins__find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ins</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out_free_ops</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">)</span>
                <span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ops</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_ops:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lock__scnprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">printed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ins</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ins__raw_scnprintf</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>

	<span class="n">printed</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%-6.6s &quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">printed</span> <span class="o">+</span> <span class="n">ins__scnprintf</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ins</span><span class="p">,</span> <span class="n">bf</span> <span class="o">+</span> <span class="n">printed</span><span class="p">,</span>
					<span class="n">size</span> <span class="o">-</span> <span class="n">printed</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lock__delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">.</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ins_ops</span> <span class="n">lock_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">free</span>	   <span class="o">=</span> <span class="n">lock__delete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parse</span>	   <span class="o">=</span> <span class="n">lock__parse</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scnprintf</span> <span class="o">=</span> <span class="n">lock__scnprintf</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mov__parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">),</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">comment</span><span class="p">,</span> <span class="n">prev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">);</span>
	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">raw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="o">++</span><span class="n">s</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="o">++</span><span class="n">s</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_source</span><span class="p">;</span>

	<span class="n">comment</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;#&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comment</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="o">++</span><span class="n">comment</span><span class="p">;</span>

	<span class="n">comment__symbol</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">comment__symbol</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_source:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mov__scnprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%-6.6s %s,%s&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">name</span> <span class="o">?:</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span>
			 <span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span> <span class="o">?:</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ins_ops</span> <span class="n">mov_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parse</span>	   <span class="o">=</span> <span class="n">mov__parse</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scnprintf</span> <span class="o">=</span> <span class="n">mov__scnprintf</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dec__parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">comment</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">prev</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="o">++</span><span class="n">s</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">comment</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;#&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comment</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="o">++</span><span class="n">comment</span><span class="p">;</span>

	<span class="n">comment__symbol</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dec__scnprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%-6.6s %s&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">name</span> <span class="o">?:</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ins_ops</span> <span class="n">dec_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parse</span>	   <span class="o">=</span> <span class="n">dec__parse</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scnprintf</span> <span class="o">=</span> <span class="n">dec__scnprintf</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nop__scnprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ins_operands</span> <span class="o">*</span><span class="n">ops</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%-6.6s&quot;</span><span class="p">,</span> <span class="s">&quot;nop&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ins_ops</span> <span class="n">nop_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">scnprintf</span> <span class="o">=</span> <span class="n">nop__scnprintf</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Must be sorted by name!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ins</span> <span class="n">instructions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;add&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;addl&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;addq&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;addw&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;and&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bts&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;call&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">call_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;callq&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">call_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmp&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmpb&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmpl&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmpq&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmpw&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmpxch&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dec&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dec_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;decl&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dec_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;imul&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;inc&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dec_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;incl&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dec_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ja&quot;</span><span class="p">,</span>	   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jae&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jb&quot;</span><span class="p">,</span>	   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jbe&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jc&quot;</span><span class="p">,</span>	   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jcxz&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;je&quot;</span><span class="p">,</span>	   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jecxz&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jg&quot;</span><span class="p">,</span>	   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jge&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jl&quot;</span><span class="p">,</span>    <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jle&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jmp&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jmpq&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jna&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jnae&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jnb&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jnbe&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jnc&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jne&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jng&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jnge&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jnl&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jnle&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jno&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jnp&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jns&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jnz&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jo&quot;</span><span class="p">,</span>	   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jp&quot;</span><span class="p">,</span>	   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jpe&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jpo&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jrcxz&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;js&quot;</span><span class="p">,</span>	   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jz&quot;</span><span class="p">,</span>	   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">jump_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lea&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lock&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">lock_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mov&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;movb&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;movdqa&quot;</span><span class="p">,.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;movl&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;movq&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;movslq&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;movzbl&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;movzwl&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nop&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">nop_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nopl&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">nop_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nopw&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">nop_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;or&quot;</span><span class="p">,</span>    <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;orl&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;test&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;testb&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;testl&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xadd&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">ops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">mov_ops</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ins__cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">insp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="n">insp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ins</span> <span class="o">*</span><span class="nf">ins__find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">nmemb</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">instructions</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bsearch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="n">nmemb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ins</span><span class="p">),</span> <span class="n">ins__cmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">symbol__annotate_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span> <span class="n">__used</span><span class="p">,</span> <span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">symbol__alloc_hist</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">symbol__size</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">sizeof_sym_hist</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_hist</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

	<span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">)</span> <span class="o">+</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">nr_events</span> <span class="o">*</span> <span class="n">sizeof_sym_hist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sizeof_sym_hist</span> <span class="o">=</span> <span class="n">sizeof_sym_hist</span><span class="p">;</span>
	<span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">nr_histograms</span>   <span class="o">=</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">nr_events</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">symbol__annotate_zero_histograms</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>

	<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">histograms</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">nr_histograms</span> <span class="o">*</span> <span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sizeof_sym_hist</span><span class="p">);</span>
	<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">symbol__inc_addr_samples</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">evidx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sym_hist</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pr_debug3</span><span class="p">(</span><span class="s">&quot;%s: addr=%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">unmap_ip</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">addr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">||</span> <span class="n">addr</span> <span class="o">&gt;</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">annotation__histogram</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">evidx</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">sum</span><span class="o">++</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pr_debug3</span><span class="p">(</span><span class="s">&quot;%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; %s: period++ [addr: %#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;, %#&quot;</span> <span class="n">PRIx64</span>
		  <span class="s">&quot;, evidx=%d] =&gt; %&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		  <span class="n">addr</span><span class="p">,</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">evidx</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disasm_line__init_ins</span><span class="p">(</span><span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">dl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span> <span class="o">=</span> <span class="n">ins__find</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">)</span>
		<span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">disasm_line__parse</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">namep</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">rawp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="o">++</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rawp</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">rawp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">((</span><span class="o">*</span><span class="n">rawp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="o">++*</span><span class="n">rawp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">rawp</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rawp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">namep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_name</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">rawp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">rawp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">rawp</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">((</span><span class="o">*</span><span class="n">rawp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">rawp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_name:</span>
	<span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">namep</span><span class="p">);</span>
	<span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="nf">disasm_line__new</span><span class="p">(</span><span class="n">s64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">privsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">dl</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dl</span><span class="p">)</span> <span class="o">+</span> <span class="n">privsize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dl</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">dl</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_delete</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disasm_line__parse</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">raw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_free_line</span><span class="p">;</span>

			<span class="n">disasm_line__init_ins</span><span class="p">(</span><span class="n">dl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dl</span><span class="p">;</span>

<span class="nl">out_free_line:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="nl">out_delete:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">dl</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">disasm_line__free</span><span class="p">(</span><span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">dl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span> <span class="o">&amp;&amp;</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">)</span>
		<span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ins__delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">dl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">disasm_line__scnprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">dl</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">bool</span> <span class="n">raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raw</span> <span class="o">||</span> <span class="o">!</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%-6.6s %s&quot;</span><span class="p">,</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ins__scnprintf</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ins</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disasm__add</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="nf">disasm__get_next_ip_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_for_each_entry_continue</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">disasm_line__print</span><span class="p">(</span><span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">dl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="n">u64</span> <span class="n">start</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">evidx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_pcnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">printed</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">max_lines</span><span class="p">,</span> <span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prev_line</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prev_color</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">double</span> <span class="n">percent</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">source_line</span> <span class="o">*</span><span class="n">src_line</span> <span class="o">=</span> <span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sym_hist</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">annotation__histogram</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">evidx</span><span class="p">);</span>
		<span class="n">s64</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u64</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">disasm__get_next_ip_line</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">dl</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">len</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">src_line</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">path</span> <span class="o">=</span> <span class="n">src_line</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">path</span><span class="p">;</span>
				<span class="n">percent</span> <span class="o">+=</span> <span class="n">src_line</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">percent</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">hits</span> <span class="o">+=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>

			<span class="o">++</span><span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">src_line</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">)</span>
			<span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">hits</span> <span class="o">/</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">percent</span> <span class="o">&lt;</span> <span class="n">min_pcnt</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_lines</span> <span class="o">&amp;&amp;</span> <span class="n">printed</span> <span class="o">&gt;=</span> <span class="n">max_lines</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="n">dl</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">disasm_line__print</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">evidx</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">color</span> <span class="o">=</span> <span class="n">get_percent_color</span><span class="p">(</span><span class="n">percent</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Also color the filename and line if needed, with</span>
<span class="cm">		 * the same color than the percentage. Don&#39;t print it</span>
<span class="cm">		 * twice for close colored addr with the same filename:line</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev_line</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">prev_line</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
				       <span class="o">||</span> <span class="n">color</span> <span class="o">!=</span> <span class="n">prev_color</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">color_fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
				<span class="n">prev_line</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
				<span class="n">prev_color</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">color_fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot; %7.2f&quot;</span><span class="p">,</span> <span class="n">percent</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot; :	&quot;</span><span class="p">);</span>
		<span class="n">color_fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">PERF_COLOR_MAGENTA</span><span class="p">,</span> <span class="s">&quot;  %&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">color_fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">PERF_COLOR_BLUE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_lines</span> <span class="o">&amp;&amp;</span> <span class="n">printed</span> <span class="o">&gt;=</span> <span class="n">max_lines</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;         :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;         :	%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">symbol__parse_objdump_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
				      <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">privsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">dl</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">parsed_line</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp2</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">line_len</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">line_ip</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">line_len</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">line</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">line_len</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">line_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
		<span class="n">line</span><span class="p">[</span><span class="o">--</span><span class="n">line_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">line_ip</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">parsed_line</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Strip leading spaces:</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Parse hexa addresses followed by &#39;:&#39;</span>
<span class="cm">		 */</span>
		<span class="n">line_ip</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp2</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp2</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">==</span> <span class="n">tmp2</span> <span class="o">||</span> <span class="n">tmp2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">line_ip</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line_ip</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">start</span> <span class="o">=</span> <span class="n">map__rip_2objdump</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">),</span>
		    <span class="n">end</span> <span class="o">=</span> <span class="n">map__rip_2objdump</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">line_ip</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">line_ip</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">parsed_line</span> <span class="o">=</span> <span class="n">tmp2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dl</span> <span class="o">=</span> <span class="n">disasm_line__new</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">parsed_line</span><span class="p">,</span> <span class="n">privsize</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">disasm__add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">dl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">symbol__annotate</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">privsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="n">dso__build_id_filename</span><span class="p">(</span><span class="n">dso</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">free_filename</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">command</span><span class="p">[</span><span class="n">PATH_MAX</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">symfs_filename</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">symfs_filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">symfs_filename</span><span class="p">),</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span>
			 <span class="n">symbol_conf</span><span class="p">.</span><span class="n">symfs</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">has_build_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t annotate %s: not enough memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">fallback</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">readlink</span><span class="p">(</span><span class="n">symfs_filename</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">strstr</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;[kernel.kallsyms]&quot;</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">access</span><span class="p">(</span><span class="n">symfs_filename</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="nl">fallback:</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we don&#39;t have build-ids or the build-id file isn&#39;t in the</span>
<span class="cm">		 * cache, or is just a kallsyms file, well, lets hope that this</span>
<span class="cm">		 * DSO is the same as when &#39;perf record&#39; ran.</span>
<span class="cm">		 */</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">symfs_filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">symfs_filename</span><span class="p">),</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span>
			 <span class="n">symbol_conf</span><span class="p">.</span><span class="n">symfs</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
		<span class="n">free_filename</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">symtab_type</span> <span class="o">==</span> <span class="n">SYMTAB__KALLSYMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">bf</span><span class="p">[</span><span class="n">BUILD_ID_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot; with build id &quot;</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">build_id_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">annotate_warned</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_filename</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">has_build_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">build_id__sprintf</span><span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">build_id</span><span class="p">),</span> <span class="n">bf</span> <span class="o">+</span> <span class="mi">15</span><span class="p">);</span>
			<span class="n">build_id_msg</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="n">dso</span><span class="o">-&gt;</span><span class="n">annotate_warned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t annotate %s:</span><span class="se">\n\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;No vmlinux file%s</span><span class="se">\n</span><span class="s">was found in the path.</span><span class="se">\n\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Please use:</span><span class="se">\n\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;  perf buildid-cache -av vmlinux</span><span class="se">\n\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;or:</span><span class="se">\n\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;  --vmlinux vmlinux</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">build_id_msg</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_filename</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: filename=%s, sym=%s, start=%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;, end=%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">filename</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">unmap_ip</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">),</span>
		 <span class="n">map</span><span class="o">-&gt;</span><span class="n">unmap_ip</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;annotating [%p] %30s : [%p] %30s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dso</span><span class="p">,</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command</span><span class="p">),</span>
		 <span class="s">&quot;objdump %s%s --start-address=0x%016&quot;</span> <span class="n">PRIx64</span>
		 <span class="s">&quot; --stop-address=0x%016&quot;</span> <span class="n">PRIx64</span>
		 <span class="s">&quot; -d %s %s -C %s|grep -v %s|expand&quot;</span><span class="p">,</span>
		 <span class="n">disassembler_style</span> <span class="o">?</span> <span class="s">&quot;-M &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">disassembler_style</span> <span class="o">?</span> <span class="n">disassembler_style</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">map__rip_2objdump</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">),</span>
		 <span class="n">map__rip_2objdump</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
		 <span class="n">symbol_conf</span><span class="p">.</span><span class="n">annotate_asm_raw</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;--no-show-raw&quot;</span><span class="p">,</span>
		 <span class="n">symbol_conf</span><span class="p">.</span><span class="n">annotate_src</span> <span class="o">?</span> <span class="s">&quot;-S&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">symfs_filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Executing: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

	<span class="n">file</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_filename</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">symbol__parse_objdump_line</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">privsize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">pclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="nl">out_free_filename:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free_filename</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_source_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">source_line</span> <span class="o">*</span><span class="n">src_line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">source_line</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">source_line</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">src_line</span><span class="o">-&gt;</span><span class="n">percent</span> <span class="o">&gt;</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">percent</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_line</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_line</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">symbol__free_source_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">source_line</span> <span class="o">*</span><span class="n">src_line</span> <span class="o">=</span> <span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">src_line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">path</span><span class="p">);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">src_line</span><span class="p">);</span>
	<span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">lines</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the filename:line for the colored entries */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">symbol__get_source_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">evidx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">PATH_MAX</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">source_line</span> <span class="o">*</span><span class="n">src_line</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sym_hist</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">annotation__histogram</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">evidx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">src_line</span> <span class="o">=</span> <span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">lines</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">source_line</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">map__rip_2objdump</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">line_len</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
		<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

		<span class="n">src_line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">percent</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;addr2line -e %s %016&quot;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">line_len</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">line_len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="n">src_line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">path</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">line_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src_line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">path</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="n">strcpy</span><span class="p">(</span><span class="n">src_line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="n">insert_source_line</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_line</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="nl">next:</span>
		<span class="n">pclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_summary</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">source_line</span> <span class="o">*</span><span class="n">src_line</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Sorted summary for file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;----------------------------------------------</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RB_EMPTY_ROOT</span><span class="p">(</span><span class="n">root</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot; Nothing higher than %1.1f%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MIN_GREEN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">double</span> <span class="n">percent</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

		<span class="n">src_line</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">source_line</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">percent</span> <span class="o">=</span> <span class="n">src_line</span><span class="o">-&gt;</span><span class="n">percent</span><span class="p">;</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">get_percent_color</span><span class="p">(</span><span class="n">percent</span><span class="p">);</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">src_line</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>

		<span class="n">color_fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot; %7.2f %s&quot;</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">symbol__annotate_hits</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="kt">int</span> <span class="n">evidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sym_hist</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">annotation__histogram</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">evidx</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">len</span> <span class="o">=</span> <span class="n">symbol__size</span><span class="p">(</span><span class="n">sym</span><span class="p">),</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%*&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;: %&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BITS_PER_LONG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%*s: %&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BITS_PER_LONG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;h-&gt;sum&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">symbol__annotate_printf</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">evidx</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">full_paths</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_pcnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_lines</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span> <span class="o">*</span><span class="n">d_filename</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start</span> <span class="o">=</span> <span class="n">map__rip_2objdump</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">printed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">more</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">full_paths</span><span class="p">)</span>
		<span class="n">d_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">d_filename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">symbol__size</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot; Percent |	Source code &amp; Disassembly of %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d_filename</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
		<span class="n">symbol__annotate_hits</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">evidx</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">&amp;&amp;</span> <span class="n">queue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">queue</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">disasm_line__print</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">evidx</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					    <span class="n">min_pcnt</span><span class="p">,</span> <span class="n">printed</span><span class="p">,</span> <span class="n">max_lines</span><span class="p">,</span>
					    <span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="o">++</span><span class="n">printed</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printed</span> <span class="o">+=</span> <span class="n">queue_len</span><span class="p">;</span>
				<span class="n">queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* filtered by max_lines */</span>
			<span class="o">++</span><span class="n">more</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * Filtered by min_pcnt or non IP lines when</span>
<span class="cm">			 * context != 0</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">queue_len</span> <span class="o">==</span> <span class="n">context</span><span class="p">)</span>
				<span class="n">queue</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">queue</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">++</span><span class="n">queue_len</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">more</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">symbol__annotate_zero_histogram</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="kt">int</span> <span class="n">evidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sym_hist</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">annotation__histogram</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">evidx</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">notes</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sizeof_sym_hist</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">symbol__annotate_decay_histogram</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="kt">int</span> <span class="n">evidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">annotation</span> <span class="o">*</span><span class="n">notes</span> <span class="o">=</span> <span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sym_hist</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">annotation__histogram</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">evidx</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">symbol__size</span><span class="p">(</span><span class="n">sym</span><span class="p">),</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">disasm__purge</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">disasm_line__free</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">disasm_line__fprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">dl</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">printed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>

	<span class="n">printed</span> <span class="o">=</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printed</span> <span class="o">+=</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;%.*s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">6</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">printed</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span>
				   <span class="n">dl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">printed</span> <span class="o">+</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">disasm__fprintf</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">disasm_line</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">printed</span> <span class="o">+=</span> <span class="n">disasm_line__fprintf</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">printed</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">symbol__tty_annotate</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">,</span> <span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">evidx</span><span class="p">,</span>
			 <span class="n">bool</span> <span class="n">print_lines</span><span class="p">,</span> <span class="n">bool</span> <span class="n">full_paths</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_pcnt</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">max_lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="n">source_line</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symbol__annotate</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">symbol__size</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">print_lines</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">symbol__get_source_line</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">evidx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">source_line</span><span class="p">,</span>
					<span class="n">len</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
		<span class="n">print_summary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">source_line</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">symbol__annotate_printf</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">evidx</span><span class="p">,</span> <span class="n">full_paths</span><span class="p">,</span>
				<span class="n">min_pcnt</span><span class="p">,</span> <span class="n">max_lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">print_lines</span><span class="p">)</span>
		<span class="n">symbol__free_source_line</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">disasm__purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">symbol__annotation</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
