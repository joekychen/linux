<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › util › probe-event.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>probe-event.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * probe-event.c : perf-probe definition to probe_events format converter</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Masami Hiramatsu &lt;mhiramat@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;sys/utsname.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;limits.h&gt;</span>
<span class="cp">#include &lt;elf.h&gt;</span>

<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;event.h&quot;</span>
<span class="cp">#include &quot;strlist.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;cache.h&quot;</span>
<span class="cp">#include &quot;color.h&quot;</span>
<span class="cp">#include &quot;symbol.h&quot;</span>
<span class="cp">#include &quot;thread.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>
<span class="cp">#include &quot;trace-event.h&quot;	</span><span class="cm">/* For __unused */</span><span class="cp"></span>
<span class="cp">#include &quot;probe-event.h&quot;</span>
<span class="cp">#include &quot;probe-finder.h&quot;</span>
<span class="cp">#include &quot;session.h&quot;</span>

<span class="cp">#define MAX_CMDLEN 256</span>
<span class="cp">#define MAX_PROBE_ARGS 128</span>
<span class="cp">#define PERFPROBE_GROUP &quot;probe&quot;</span>

<span class="n">bool</span> <span class="n">probe_event_dry_run</span><span class="p">;</span>	<span class="cm">/* Dry run flag */</span>

<span class="cp">#define semantic_error(msg ...) pr_err(&quot;Semantic error :&quot; msg)</span>

<span class="cm">/* If there is no space to write, returns -E2BIG. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
	<span class="n">__attribute__</span><span class="p">((</span><span class="n">format</span><span class="p">(</span><span class="n">printf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)));</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e_snprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">synthesize_perf_probe_point</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_point</span> <span class="o">*</span><span class="n">pp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">convert_name_to_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">exec</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">machine</span> <span class="n">machine</span><span class="p">;</span>

<span class="cm">/* Initialize symbol maps and path of vmlinux/modules */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_vmlinux</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">symbol_conf</span><span class="p">.</span><span class="n">sort_by_name</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">vmlinux_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">symbol_conf</span><span class="p">.</span><span class="n">try_vmlinux_path</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Use vmlinux: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">vmlinux_name</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">symbol__init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to init symbol map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">machine__init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">HOST_KERNEL_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine__create_kernel_maps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;machine__create_kernel_maps() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to init vmlinux path.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="nf">__find_kernel_function_by_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">map</span> <span class="o">**</span><span class="n">mapp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">machine__find_kernel_function_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mapp</span><span class="p">,</span>
						     <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="nf">kernel_get_module_map</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">nd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_groups</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">machine</span><span class="p">.</span><span class="n">kmaps</span><span class="p">;</span>

	<span class="cm">/* A file path -- this is an offline module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">module</span> <span class="o">&amp;&amp;</span> <span class="n">strchr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">machine__new_module</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">module</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">module</span><span class="p">)</span>
		<span class="n">module</span> <span class="o">=</span> <span class="s">&quot;kernel&quot;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nd</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">]);</span> <span class="n">nd</span><span class="p">;</span> <span class="n">nd</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">map</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">short_name</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span>
			    <span class="n">pos</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">short_name_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="nf">kernel_get_module_dso</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vmlinux_name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dso</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">machine</span><span class="p">.</span><span class="n">kernel_dsos</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">short_name</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span>
				    <span class="n">dso</span><span class="o">-&gt;</span><span class="n">short_name_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to find module %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">machine</span><span class="p">.</span><span class="n">vmlinux_maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">];</span>
	<span class="n">dso</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">;</span>

	<span class="n">vmlinux_name</span> <span class="o">=</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">vmlinux_name</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vmlinux_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dso__load_vmlinux</span><span class="p">(</span><span class="n">dso</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">vmlinux_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dso__load_vmlinux_path</span><span class="p">(</span><span class="n">dso</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to load kernel map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">found:</span>
	<span class="k">return</span> <span class="n">dso</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">kernel_get_module_path</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span> <span class="o">=</span> <span class="n">kernel_get_module_dso</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dso</span><span class="p">)</span> <span class="o">?</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_user_exec</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">symbol_conf</span><span class="p">.</span><span class="n">try_vmlinux_path</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">symbol_conf</span><span class="p">.</span><span class="n">sort_by_name</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">symbol__init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to init symbol map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">convert_to_perf_probe_point</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_point</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">perf_probe_point</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">retprobe</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">retprobe</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DWARF_SUPPORT</span>
<span class="cm">/* Open new debuginfo of given module */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">debuginfo</span> <span class="o">*</span><span class="nf">open_debuginfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="cm">/* A file path -- this is an offline module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">module</span> <span class="o">&amp;&amp;</span> <span class="n">strchr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">))</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">module</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">kernel_get_module_path</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to find path of %s module.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">module</span> <span class="o">?:</span> <span class="s">&quot;kernel&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">debuginfo__new</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert trace point to probe point with debuginfo</span>
<span class="cm"> * Currently only handles kprobes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kprobe_convert_to_perf_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_point</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">perf_probe_point</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">debuginfo</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>

	<span class="n">sym</span> <span class="o">=</span> <span class="n">__find_kernel_function_by_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">unmap_ip</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;try to find %s+%ld@%&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">,</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

		<span class="n">dinfo</span> <span class="o">=</span> <span class="n">debuginfo__new_online_kernel</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">debuginfo__find_probe_point</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span>
						 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
			<span class="n">debuginfo__delete</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to open debuginfo at 0x%&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">addr</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to find corresponding probes from &quot;</span>
			 <span class="s">&quot;debuginfo. Use kprobe event information.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">convert_to_perf_probe_point</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">retprobe</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">retprobe</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_module_to_probe_trace_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">*</span><span class="n">tevs</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">ntevs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">module</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is a module path -- get the module name */</span>
		<span class="n">module</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">module</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
			<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">module</span><span class="p">;</span>	<span class="cm">/* For free() */</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">point</span><span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">point</span><span class="p">.</span><span class="n">module</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Try to find perf_probe_event with debuginfo */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_to_find_probe_trace_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">**</span><span class="n">tevs</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">max_tevs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">need_dwarf</span> <span class="o">=</span> <span class="n">perf_probe_event_need_dwarf</span><span class="p">(</span><span class="n">pev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">debuginfo</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ntevs</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">uprobes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_dwarf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Debuginfo-analysis is not yet supported&quot;</span>
					<span class="s">&quot; with -x/--exec option.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">convert_name_to_addr</span><span class="p">(</span><span class="n">pev</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dinfo</span> <span class="o">=</span> <span class="n">open_debuginfo</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_dwarf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to open debuginfo file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Could not open debuginfo. Try to use symbols.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Searching trace events corresponding to a probe event */</span>
	<span class="n">ntevs</span> <span class="o">=</span> <span class="n">debuginfo__find_trace_events</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">pev</span><span class="p">,</span> <span class="n">tevs</span><span class="p">,</span> <span class="n">max_tevs</span><span class="p">);</span>

	<span class="n">debuginfo__delete</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntevs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Succeeded to find trace events */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;find %d probe_trace_events.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntevs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">add_module_to_probe_trace_events</span><span class="p">(</span><span class="o">*</span><span class="n">tevs</span><span class="p">,</span> <span class="n">ntevs</span><span class="p">,</span>
							       <span class="n">target</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">ntevs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntevs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="p">{</span>	<span class="cm">/* No error but failed to find probe point. */</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Probe point &#39;%s&#39; not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">synthesize_perf_probe_point</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Error path : ntevs &lt; 0 */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;An error occurred in debuginfo analysis (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntevs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntevs</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Warning: No dwarf info found in the vmlinux - &quot;</span>
			<span class="s">&quot;please rebuild kernel with CONFIG_DEBUG_INFO=y.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_dwarf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Trying to use symbols.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ntevs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find a src file from a DWARF tag path. Prepend optional source path prefix</span>
<span class="cm"> * and chop off leading directories that do not exist. Result is passed back as</span>
<span class="cm"> * a newly allocated path on success.</span>
<span class="cm"> * Return 0 if file was found and readable, -errno otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_real_path</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">raw_path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comp_dir</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">**</span><span class="n">new_path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">source_prefix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">comp_dir</span><span class="p">)</span>
			<span class="cm">/* If not an absolute path, try to use comp_dir */</span>
			<span class="n">prefix</span> <span class="o">=</span> <span class="n">comp_dir</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">new_path</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">raw_path</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">new_path</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">new_path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="o">*</span><span class="n">new_path</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">raw_path</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="o">*</span><span class="n">new_path</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">source_prefix</span><span class="p">)</span>
			<span class="cm">/* In case of searching comp_dir, don&#39;t retry */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ENAMETOOLONG</span>:
		<span class="k">case</span> <span class="n">ENOENT</span>:
		<span class="k">case</span> <span class="n">EROFS</span>:
		<span class="k">case</span> <span class="n">EFAULT</span>:
			<span class="n">raw_path</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="o">++</span><span class="n">raw_path</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raw_path</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">new_path</span><span class="p">);</span>
				<span class="o">*</span><span class="n">new_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">new_path</span><span class="p">);</span>
			<span class="o">*</span><span class="n">new_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define LINEBUF_SIZE 256</span>
<span class="cp">#define NR_ADDITIONAL_LINES 2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__show_one_line</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">bool</span> <span class="n">skip</span><span class="p">,</span> <span class="n">bool</span> <span class="n">show_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LINEBUF_SIZE</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span> <span class="o">=</span> <span class="n">show_num</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="n">PERF_COLOR_BLUE</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">LINEBUF_SIZE</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prefix</span> <span class="o">=</span> <span class="n">show_num</span> <span class="o">?</span> <span class="s">&quot;%7d  &quot;</span> <span class="o">:</span> <span class="s">&quot;         &quot;</span><span class="p">;</span>
			<span class="n">color_fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">color_fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ferror</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;File read error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_show_one_line</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">bool</span> <span class="n">skip</span><span class="p">,</span> <span class="n">bool</span> <span class="n">show_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">__show_one_line</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">show_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Source file is shorter than expected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define show_one_line_with_num(f,l)	_show_one_line(f,l,false,true)</span>
<span class="cp">#define show_one_line(f,l)		_show_one_line(f,l,false,false)</span>
<span class="cp">#define skip_one_line(f,l)		_show_one_line(f,l,true,false)</span>
<span class="cp">#define show_one_line_or_eof(f,l)	__show_one_line(f,l,false,false)</span>

<span class="cm">/*</span>
<span class="cm"> * Show line-range always requires debuginfo to find source file and</span>
<span class="cm"> * line number.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">show_line_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">line_range</span> <span class="o">*</span><span class="n">lr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">line_node</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">debuginfo</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Search a line range */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_vmlinux</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dinfo</span> <span class="o">=</span> <span class="n">open_debuginfo</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to open debuginfo file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">debuginfo__find_line_range</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">lr</span><span class="p">);</span>
	<span class="n">debuginfo__delete</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Specified source line is not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Debuginfo analysis failed. (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Convert source file path */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_real_path</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">comp_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lr</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>	<span class="cm">/* Free old path */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to find source file. (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup_pager</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lr</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;&lt;%s@%s:%d&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span>
			<span class="n">lr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;&lt;%s:%d&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">lr</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to open %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span>
			   <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Skip to starting line number */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">skip_one_line</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">l</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lr</span><span class="o">-&gt;</span><span class="n">line_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&gt;</span> <span class="n">l</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">show_one_line</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">l</span> <span class="o">-</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">show_one_line_with_num</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">l</span><span class="o">++</span> <span class="o">-</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lr</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="n">INT_MAX</span><span class="p">)</span>
		<span class="n">lr</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">NR_ADDITIONAL_LINES</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">show_one_line_or_eof</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">l</span><span class="o">++</span> <span class="o">-</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">end:</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_available_vars_at</span><span class="p">(</span><span class="k">struct</span> <span class="n">debuginfo</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">max_vls</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strfilter</span> <span class="o">*</span><span class="n">_filter</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">externs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">nvars</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">str_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">variable_list</span> <span class="o">*</span><span class="n">vls</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">vl</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">synthesize_perf_probe_point</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Searching variables at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">debuginfo__find_available_vars_at</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">pev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vls</span><span class="p">,</span>
						<span class="n">max_vls</span><span class="p">,</span> <span class="n">externs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to find variables at %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Some variables are found */</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;Available variables at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ret</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/*</span>
<span class="cm">		 * A probe point might be converted to</span>
<span class="cm">		 * several trace points.</span>
<span class="cm">		 */</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">@&lt;%s+%lu&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vl</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span><span class="p">,</span>
			<span class="n">vl</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">vl</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span><span class="p">);</span>
		<span class="n">nvars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vl</span><span class="o">-&gt;</span><span class="n">vars</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strlist__for_each</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">vl</span><span class="o">-&gt;</span><span class="n">vars</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">var</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\t&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strfilter__compare</span><span class="p">(</span><span class="n">_filter</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
					<span class="n">nvars</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">strlist__delete</span><span class="p">(</span><span class="n">vl</span><span class="o">-&gt;</span><span class="n">vars</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvars</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">(No matched variables)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">vls</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Show available variables on given probe point */</span>
<span class="kt">int</span> <span class="nf">show_available_vars</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pevs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">npevs</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">max_vls</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">strfilter</span> <span class="o">*</span><span class="n">_filter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">externs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">debuginfo</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_vmlinux</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dinfo</span> <span class="o">=</span> <span class="n">open_debuginfo</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to open debuginfo file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup_pager</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npevs</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">show_available_vars_at</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pevs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">max_vls</span><span class="p">,</span> <span class="n">_filter</span><span class="p">,</span>
					     <span class="n">externs</span><span class="p">);</span>

	<span class="n">debuginfo__delete</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else	</span><span class="cm">/* !DWARF_SUPPORT */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kprobe_convert_to_perf_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_point</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">perf_probe_point</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>

	<span class="n">sym</span> <span class="o">=</span> <span class="n">__find_kernel_function_by_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to find symbol %s in kernel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">convert_to_perf_probe_point</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_to_find_probe_trace_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">**</span><span class="n">tevs</span> <span class="n">__unused</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">max_tevs</span> <span class="n">__unused</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_probe_event_need_dwarf</span><span class="p">(</span><span class="n">pev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Debuginfo-analysis is not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">uprobes</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">convert_name_to_addr</span><span class="p">(</span><span class="n">pev</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">show_line_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">line_range</span> <span class="o">*</span><span class="n">lr</span> <span class="n">__unused</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span> <span class="n">__unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Debuginfo-analysis is not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">show_available_vars</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pevs</span> <span class="n">__unused</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">npevs</span> <span class="n">__unused</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_vls</span> <span class="n">__unused</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span> <span class="n">__unused</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">strfilter</span> <span class="o">*</span><span class="n">filter</span> <span class="n">__unused</span><span class="p">,</span>
			<span class="n">bool</span> <span class="n">externs</span> <span class="n">__unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Debuginfo-analysis is not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_line_num</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">||</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;&#39;%s&#39; is not a valid number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stuff &#39;lr&#39; according to the line range described by &#39;arg&#39;.</span>
<span class="cm"> * The line range syntax is described by:</span>
<span class="cm"> *</span>
<span class="cm"> *         SRC[:SLN[+NUM|-ELN]]</span>
<span class="cm"> *         FNC[@SRC][:SLN[+NUM|-ELN]]</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">parse_line_range_desc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">line_range</span> <span class="o">*</span><span class="n">lr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">range</span><span class="p">,</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">lr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lr</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>

	<span class="n">range</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">range</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">parse_line_num</span><span class="p">(</span><span class="o">&amp;</span><span class="n">range</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="s">&quot;start line&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">range</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">range</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">range</span><span class="o">++</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">parse_line_num</span><span class="p">(</span><span class="o">&amp;</span><span class="n">range</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lr</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="s">&quot;end line&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lr</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+=</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * Adjust the number of lines here.</span>
<span class="cm">				 * If the number of lines == 1, the</span>
<span class="cm">				 * the end of line should be equal to</span>
<span class="cm">				 * the start of line.</span>
<span class="cm">				 */</span>
				<span class="n">lr</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Line range is %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">lr</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Start line must be smaller&quot;</span>
				       <span class="s">&quot; than end line.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">range</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Tailing with invalid str &#39;%s&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">range</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">file</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;@&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">lr</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="o">++</span><span class="n">file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lr</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lr</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">))</span>
		<span class="n">lr</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lr</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check the name is good for event/group */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_event_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isalpha</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">name</span> <span class="o">!=</span> <span class="sc">&#39;_&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*++</span><span class="n">name</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isalpha</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">name</span> <span class="o">!=</span> <span class="sc">&#39;_&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Parse probepoint definition. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_perf_probe_point</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_probe_point</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * &lt;Syntax&gt;</span>
<span class="cm">	 * perf probe [EVENT=]SRC[:LN|;PTN]</span>
<span class="cm">	 * perf probe [EVENT=]FUNC[@SRC][+OFFS|%return|:LN|;PAT]</span>
<span class="cm">	 *</span>
<span class="cm">	 * TODO:Group name support</span>
<span class="cm">	 */</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">strpbrk</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;;=@+%&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Event name */</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Group name is not supported yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_event_name</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;%s is bad for event name -it must &quot;</span>
				       <span class="s">&quot;follow C symbol-naming rule.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">strpbrk</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;;:+@%&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nc</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Check arg is function or file and copy it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">))</span>	<span class="cm">/* File */</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span>			<span class="cm">/* Function */</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Parse other options */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">nc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Lazy pattern must be the last part */</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">lazy_line</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">lazy_line</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">strpbrk</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;;:+@%&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nc</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="err">&#39;</span>:<span class="err">&#39;</span><span class="o">:</span>	<span class="cm">/* Line number */</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;There is non-digit char&quot;</span>
					       <span class="s">&quot; in line number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:	<span class="cm">/* Byte offset from a symbol */</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;There is non-digit character&quot;</span>
						<span class="s">&quot; in offset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;@&#39;</span>:	<span class="cm">/* File name */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;SRC@SRC is not allowed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;%&#39;</span>:	<span class="cm">/* Probe places */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;return&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pp</span><span class="o">-&gt;</span><span class="n">retprobe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Others not supported yet */</span>
				<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;%%%s is not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="cm">/* Buggy case */</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;This program has a bug at %s:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Exclusion check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">lazy_line</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Lazy pattern can&#39;t be used with&quot;</span>
			       <span class="s">&quot; line number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">lazy_line</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Lazy pattern can&#39;t be used with offset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Offset can&#39;t be used with line number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">lazy_line</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;File always requires line number or &quot;</span>
			       <span class="s">&quot;lazy pattern.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Offset requires an entry function.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">retprobe</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Return probe requires an entry function.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">||</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">||</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">lazy_line</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">retprobe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Offset/Line/Lazy pattern can&#39;t be used with &quot;</span>
			       <span class="s">&quot;return probe.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;symbol:%s file:%s line:%d offset:%lu return:%d lazy:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">retprobe</span><span class="p">,</span>
		 <span class="n">pp</span><span class="o">-&gt;</span><span class="n">lazy_line</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Parse perf-probe event argument */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_perf_probe_arg</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_probe_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">goodname</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_probe_arg_field</span> <span class="o">**</span><span class="n">fieldp</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;parsing arg: %s into &quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">strndup</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">str</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;name:%s &quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Type setting */</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;type:%s &quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">strpbrk</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;-.[&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_c_varname</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* A variable, register, symbol or special value */</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Structure fields or array element */</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">strndup</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">goodname</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s, &quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="n">fieldp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">fieldp</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_arg_field</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fieldp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Array */</span>
			<span class="n">str</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ref</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">!=</span> <span class="sc">&#39;]&#39;</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">==</span> <span class="n">str</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Array index must be a&quot;</span>
						<span class="s">&quot; number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Structure */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">str</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ref</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">str</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ref</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Argument parse error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">str</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">strpbrk</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;-.[&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">strndup</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">str</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">!=</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span>
				<span class="n">goodname</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%d), &quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
			<span class="n">fieldp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">!=</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span>
		<span class="n">goodname</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">fieldp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>

	<span class="cm">/* If no name is specified, set the last field name (not array index)*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">goodname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Parse perf-probe event command */</span>
<span class="kt">int</span> <span class="nf">parse_perf_probe_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">argv</span> <span class="o">=</span> <span class="n">argv_split</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to split arguments.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">MAX_PROBE_ARGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Too many probe arguments (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Parse probe point */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_perf_probe_point</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Copy arguments and ensure return probe has no C argument */</span>
	<span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_perf_probe_arg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">is_c_varname</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">var</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">retprobe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;You can&#39;t specify local variable for&quot;</span>
				       <span class="s">&quot; kretprobe.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">argv_free</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return true if this perf_probe_event requires debuginfo */</span>
<span class="n">bool</span> <span class="nf">perf_probe_event_need_dwarf</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">file</span> <span class="o">||</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">line</span> <span class="o">||</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">lazy_line</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_c_varname</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">var</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Parse probe_events event into struct probe_point */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_probe_trace_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">*</span><span class="n">tev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">probe_trace_point</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">argc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Parsing probe_events: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">argv</span> <span class="o">=</span> <span class="n">argv_split</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to split arguments.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Too few probe arguments.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Scan event and group name. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;%c:%a[^/ </span><span class="se">\t</span><span class="s">]/%a[^ </span><span class="se">\t</span><span class="s">]&quot;</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">pr</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">semantic_error</span><span class="p">(</span><span class="s">&quot;Failed to parse event name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Group:%s Event:%s probe:%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">retprobe</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span><span class="p">);</span>

	<span class="cm">/* Scan module name(if there), function name and offset */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">=</span> <span class="n">strndup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span> <span class="o">-</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%a[^+]+%lu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>	<span class="cm">/* We don&#39;t need which register is assigned. */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
		<span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="cm">/* TODO: parse regs and offset */</span>
		<span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">argv_free</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compose only probe arg */</span>
<span class="kt">int</span> <span class="nf">synthesize_perf_probe_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_arg</span> <span class="o">*</span><span class="n">pa</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_probe_arg_field</span> <span class="o">*</span><span class="n">field</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s=%s&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span>
					 <span class="n">field</span><span class="o">-&gt;</span><span class="n">ref</span> <span class="o">?</span> <span class="s">&quot;-&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;:%s&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to synthesize perf probe argument: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compose only probe point (not argument) */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">synthesize_perf_probe_point</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_point</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">offs</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="n">MAX_CMDLEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">offs</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;+%lu&quot;</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;:%d&quot;</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">?</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">30</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;@%s&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">MAX_CMDLEN</span><span class="p">,</span> <span class="s">&quot;%s%s%s%s%s&quot;</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span>
				 <span class="n">offs</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">retprobe</span> <span class="o">?</span> <span class="s">&quot;%return&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
				 <span class="n">file</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">MAX_CMDLEN</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to synthesize perf probe point: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">char *synthesize_perf_probe_command(struct perf_probe_event *pev)</span>
<span class="c">{</span>
<span class="c">	char *buf;</span>
<span class="c">	int i, len, ret;</span>

<span class="c">	buf = synthesize_perf_probe_point(&amp;pev-&gt;point);</span>
<span class="c">	if (!buf)</span>
<span class="c">		return NULL;</span>

<span class="c">	len = strlen(buf);</span>
<span class="c">	for (i = 0; i &lt; pev-&gt;nargs; i++) {</span>
<span class="c">		ret = e_snprintf(&amp;buf[len], MAX_CMDLEN - len, &quot; %s&quot;,</span>
<span class="c">				 pev-&gt;args[i].name);</span>
<span class="c">		if (ret &lt;= 0) {</span>
<span class="c">			free(buf);</span>
<span class="c">			return NULL;</span>
<span class="c">		}</span>
<span class="c">		len += ret;</span>
<span class="c">	}</span>

<span class="c">	return buf;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__synthesize_probe_trace_arg_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_arg_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span>
					     <span class="kt">char</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">buflen</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">__synthesize_probe_trace_arg_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
							 <span class="n">buflen</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;%+ld(&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buflen</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">depth</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synthesize_probe_trace_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
				       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">probe_trace_arg_ref</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Argument name or separator */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot; %s=&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">buflen</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Special case: @XXX */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">)</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* Dereferencing arguments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">__synthesize_probe_trace_arg_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">buflen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">depth</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Print argument value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;%s%+ld&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
				 <span class="n">arg</span><span class="o">-&gt;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">buflen</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Closing */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">depth</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Print argument type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="s">&quot;:%s&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buf</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">synthesize_probe_trace_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">*</span><span class="n">tev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">probe_trace_point</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="n">MAX_CMDLEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">uprobes</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">MAX_CMDLEN</span><span class="p">,</span> <span class="s">&quot;%c:%s/%s %s:%s&quot;</span><span class="p">,</span>
				 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">retprobe</span> <span class="o">?</span> <span class="sc">&#39;r&#39;</span> <span class="o">:</span> <span class="sc">&#39;p&#39;</span><span class="p">,</span>
				 <span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span>
				 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">MAX_CMDLEN</span><span class="p">,</span> <span class="s">&quot;%c:%s/%s %s%s%s+%lu&quot;</span><span class="p">,</span>
				 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">retprobe</span> <span class="o">?</span> <span class="sc">&#39;r&#39;</span> <span class="o">:</span> <span class="sc">&#39;p&#39;</span><span class="p">,</span>
				 <span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span>
				 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">?</span> <span class="s">&quot;:&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">synthesize_probe_trace_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
						  <span class="n">MAX_CMDLEN</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">convert_to_perf_probe_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">*</span><span class="n">tev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_kprobe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Convert event/group name */</span>
	<span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Convert trace_point to probe_point */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_kprobe</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">kprobe_convert_to_perf_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">convert_to_perf_probe_point</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Convert trace_arg to probe_arg */</span>
	<span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span> <span class="o">=</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">;</span>
	<span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
			<span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">synthesize_probe_trace_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							  <span class="n">buf</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
			<span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">clear_perf_probe_event</span><span class="p">(</span><span class="n">pev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">clear_perf_probe_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_probe_point</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_probe_arg_field</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">lazy_line</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">lazy_line</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
			<span class="n">free</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">var</span><span class="p">)</span>
			<span class="n">free</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">)</span>
			<span class="n">free</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">field</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
				<span class="n">free</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_probe_trace_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">*</span><span class="n">tev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">probe_trace_arg_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">module</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">module</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
			<span class="n">free</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">)</span>
			<span class="n">free</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">)</span>
			<span class="n">free</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ref</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">free</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_warn_msg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_kprobe</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_kprobe</span><span class="p">)</span>
			<span class="n">config</span> <span class="o">=</span> <span class="s">&quot;CONFIG_UPROBE_EVENTS&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">config</span> <span class="o">=</span> <span class="s">&quot;CONFIG_KPROBE_EVENTS&quot;</span><span class="p">;</span>

		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s file does not exist - please rebuild kernel&quot;</span>
				<span class="s">&quot; with %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to open %s file: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_probe_events</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">trace_file</span><span class="p">,</span> <span class="n">bool</span> <span class="n">readwrite</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">is_kprobe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__debugfs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">__debugfs</span> <span class="o">=</span> <span class="n">debugfs_find_mountpoint</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__debugfs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Debugfs is not mounted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">__debugfs</span><span class="p">,</span> <span class="n">trace_file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Opening %s write=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readwrite</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">probe_event_dry_run</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="n">O_APPEND</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">print_warn_msg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">is_kprobe</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_kprobe_events</span><span class="p">(</span><span class="n">bool</span> <span class="n">readwrite</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">open_probe_events</span><span class="p">(</span><span class="s">&quot;tracing/kprobe_events&quot;</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_uprobe_events</span><span class="p">(</span><span class="n">bool</span> <span class="n">readwrite</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">open_probe_events</span><span class="p">(</span><span class="s">&quot;tracing/uprobe_events&quot;</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get raw string list of current kprobe_events  or uprobe_events */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="nf">get_probe_trace_command_rawlist</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_CMDLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>

	<span class="n">sl</span> <span class="o">=</span> <span class="n">strlist__new</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fdopen</span><span class="p">(</span><span class="n">dup</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">MAX_CMDLEN</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">strlist__add</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;strlist__add failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
			<span class="n">strlist__delete</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sl</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Show an event */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_perf_probe_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">place</span><span class="p">;</span>

	<span class="cm">/* Synthesize only event probe point */</span>
	<span class="n">place</span> <span class="o">=</span> <span class="n">synthesize_perf_probe_point</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">place</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %-20s (on %s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">place</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot; with&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">synthesize_perf_probe_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							<span class="n">buf</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">place</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__show_perf_probe_events</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_kprobe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="n">tev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="n">pev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="n">rawlist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">str_node</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tev</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pev</span><span class="p">));</span>

	<span class="n">rawlist</span> <span class="o">=</span> <span class="n">get_probe_trace_command_rawlist</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rawlist</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">strlist__for_each</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">rawlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_probe_trace_command</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">convert_to_perf_probe_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pev</span><span class="p">,</span>
								<span class="n">is_kprobe</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">show_perf_probe_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clear_perf_probe_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pev</span><span class="p">);</span>
		<span class="n">clear_probe_trace_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strlist__delete</span><span class="p">(</span><span class="n">rawlist</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* List up current perf-probe events */</span>
<span class="kt">int</span> <span class="nf">show_perf_probe_events</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">setup_pager</span><span class="p">();</span>
	<span class="n">fd</span> <span class="o">=</span> <span class="n">open_kprobe_events</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_vmlinux</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__show_perf_probe_events</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

	<span class="n">fd</span> <span class="o">=</span> <span class="n">open_uprobe_events</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__show_perf_probe_events</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get current perf-probe event names */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="nf">get_probe_trace_event_names</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">bool</span> <span class="n">include_group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="n">sl</span><span class="p">,</span> <span class="o">*</span><span class="n">rawlist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">str_node</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="n">tev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tev</span><span class="p">));</span>
	<span class="n">rawlist</span> <span class="o">=</span> <span class="n">get_probe_trace_command_rawlist</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="n">sl</span> <span class="o">=</span> <span class="n">strlist__new</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">strlist__for_each</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">rawlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_probe_trace_command</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">include_group</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="n">tev</span><span class="p">.</span><span class="n">group</span><span class="p">,</span>
					<span class="n">tev</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">strlist__add</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">strlist__add</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">tev</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
		<span class="n">clear_probe_trace_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strlist__delete</span><span class="p">(</span><span class="n">rawlist</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strlist__delete</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_probe_trace_event</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">*</span><span class="n">tev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">synthesize_probe_trace_command</span><span class="p">(</span><span class="n">tev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to synthesize probe trace event.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Writing event: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_event_dry_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to write event: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_new_event_name</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="n">namelist</span><span class="p">,</span> <span class="n">bool</span> <span class="n">allow_suffix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Try no suffix */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;snprintf() failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlist__has_entry</span><span class="p">(</span><span class="n">namelist</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allow_suffix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Error: event </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> already exists. &quot;</span>
			   <span class="s">&quot;(Use -f to force duplicates.)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to add suffix */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_EVENT_INDEX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s_%d&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;snprintf() failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlist__has_entry</span><span class="p">(</span><span class="n">namelist</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_EVENT_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Too many events are on the same function.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__add_probe_trace_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">*</span><span class="n">tevs</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">ntevs</span><span class="p">,</span> <span class="n">bool</span> <span class="n">allow_suffix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">*</span><span class="n">tev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="n">namelist</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">uprobes</span><span class="p">)</span>
		<span class="n">fd</span> <span class="o">=</span> <span class="n">open_uprobe_events</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fd</span> <span class="o">=</span> <span class="n">open_kprobe_events</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
	<span class="cm">/* Get current event names */</span>
	<span class="n">namelist</span> <span class="o">=</span> <span class="n">get_probe_trace_event_names</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">namelist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Failed to get current event list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Added new event%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ntevs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;s:&quot;</span> <span class="o">:</span> <span class="s">&quot;:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tevs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">function</span><span class="p">)</span>
				<span class="n">event</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">function</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">event</span> <span class="o">=</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span>
			<span class="n">group</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">group</span> <span class="o">=</span> <span class="n">PERFPROBE_GROUP</span><span class="p">;</span>

		<span class="cm">/* Get an unused new event name */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_new_event_name</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
					 <span class="n">namelist</span><span class="p">,</span> <span class="n">allow_suffix</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

		<span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">write_probe_trace_event</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">tev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Add added event name to namelist */</span>
		<span class="n">strlist__add</span><span class="p">(</span><span class="n">namelist</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

		<span class="cm">/* Trick here - save current event/group */</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
		<span class="n">group</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">;</span>
		<span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
		<span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">;</span>
		<span class="n">show_perf_probe_event</span><span class="p">(</span><span class="n">pev</span><span class="p">);</span>
		<span class="cm">/* Trick here - restore current event/group */</span>
		<span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">event</span><span class="p">;</span>
		<span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">group</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Probes after the first probe which comes from same</span>
<span class="cm">		 * user input are always allowed to add suffix, because</span>
<span class="cm">		 * there might be several addresses corresponding to</span>
<span class="cm">		 * one code line.</span>
<span class="cm">		 */</span>
		<span class="n">allow_suffix</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Show how to use the event. */</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">You can now use it in all perf tools, such as:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">perf record -e %s:%s -aR sleep 1</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span>
			 <span class="n">tev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">strlist__delete</span><span class="p">(</span><span class="n">namelist</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">convert_to_probe_trace_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">**</span><span class="n">tevs</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">max_tevs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">probe_trace_event</span> <span class="o">*</span><span class="n">tev</span><span class="p">;</span>

	<span class="cm">/* Convert perf_probe_event with debuginfo */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">try_to_find_probe_trace_events</span><span class="p">(</span><span class="n">pev</span><span class="p">,</span> <span class="n">tevs</span><span class="p">,</span> <span class="n">max_tevs</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>	<span class="cm">/* Found in debuginfo or got an error */</span>

	<span class="cm">/* Allocate trace event buffer */</span>
	<span class="n">tev</span> <span class="o">=</span> <span class="o">*</span><span class="n">tevs</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_event</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Copy parameters */</span>
	<span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">module</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">retprobe</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">retprobe</span><span class="p">;</span>
	<span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">;</span>
	<span class="n">tev</span><span class="o">-&gt;</span><span class="n">uprobes</span> <span class="o">=</span> <span class="n">pev</span><span class="o">-&gt;</span><span class="n">uprobes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">probe_trace_arg</span><span class="p">)</span>
				   <span class="o">*</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tev</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">var</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">uprobes</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Currently just checking function name from symbol map */</span>
	<span class="n">sym</span> <span class="o">=</span> <span class="n">__find_kernel_function_by_name</span><span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Kernel symbol </span><span class="se">\&#39;</span><span class="s">%s</span><span class="se">\&#39;</span><span class="s"> not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Offset specified is greater than size of %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">tev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">.</span><span class="n">symbol</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">clear_probe_trace_event</span><span class="p">(</span><span class="n">tev</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">tev</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tevs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">__event_package</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_probe_event</span>		<span class="o">*</span><span class="n">pev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">probe_trace_event</span>	<span class="o">*</span><span class="n">tevs</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">ntevs</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">add_perf_probe_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pevs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">npevs</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">max_tevs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force_add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__event_package</span> <span class="o">*</span><span class="n">pkgs</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkgs</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">__event_package</span><span class="p">)</span> <span class="o">*</span> <span class="n">npevs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkgs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pevs</span><span class="o">-&gt;</span><span class="n">uprobes</span><span class="p">)</span>
		<span class="cm">/* Init vmlinux path */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">init_vmlinux</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">init_user_exec</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pkgs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Loop 1: convert all events */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pevs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* Convert with or without debuginfo */</span>
		<span class="n">ret</span>  <span class="o">=</span> <span class="n">convert_to_probe_trace_events</span><span class="p">(</span><span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pev</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tevs</span><span class="p">,</span>
						     <span class="n">max_tevs</span><span class="p">,</span>
						     <span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ntevs</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Loop 2: add all events */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__add_probe_trace_events</span><span class="p">(</span><span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pev</span><span class="p">,</span> <span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tevs</span><span class="p">,</span>
						<span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ntevs</span><span class="p">,</span> <span class="n">force_add</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">end:</span>
	<span class="cm">/* Loop 3: cleanup and free trace events  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npevs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ntevs</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">clear_probe_trace_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tevs</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">free</span><span class="p">(</span><span class="n">pkgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tevs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">pkgs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__del_trace_probe_event</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">str_node</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Convert from perf-probe event to trace-probe event */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s">&quot;-:%s&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Internal error: %s should have &#39;:&#39; but not.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ent</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Writing event: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Removed event: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to delete event: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">del_trace_probe_event</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="n">namelist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">str_node</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strpbrk</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;*?&quot;</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Glob-exp */</span>
		<span class="n">strlist__for_each_safe</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">namelist</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strglobmatch</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">__del_trace_probe_event</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">strlist__remove</span><span class="p">(</span><span class="n">namelist</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="n">strlist__find</span><span class="p">(</span><span class="n">namelist</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__del_trace_probe_event</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">strlist__remove</span><span class="p">(</span><span class="n">namelist</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">del_perf_probe_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="n">dellist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ufd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">kfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">str_node</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strlist</span> <span class="o">*</span><span class="n">namelist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">unamelist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Get current event names */</span>
	<span class="n">kfd</span> <span class="o">=</span> <span class="n">open_kprobe_events</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">kfd</span><span class="p">;</span>

	<span class="n">namelist</span> <span class="o">=</span> <span class="n">get_probe_trace_event_names</span><span class="p">(</span><span class="n">kfd</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">ufd</span> <span class="o">=</span> <span class="n">open_uprobe_events</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ufd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">unamelist</span> <span class="o">=</span> <span class="n">get_probe_trace_event_names</span><span class="p">(</span><span class="n">ufd</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">namelist</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">unamelist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">strlist__for_each</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">dellist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Parsing: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">group</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">group</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span><span class="p">;</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">e_snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to copy event.&quot;</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Group: %s, Event: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">namelist</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">del_trace_probe_event</span><span class="p">(</span><span class="n">kfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">namelist</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unamelist</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">del_trace_probe_event</span><span class="p">(</span><span class="n">ufd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">unamelist</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Info: Event </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> does not exist.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strlist__delete</span><span class="p">(</span><span class="n">namelist</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">kfd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ufd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strlist__delete</span><span class="p">(</span><span class="n">unamelist</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">ufd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO: don&#39;t use a global variable for filter ... */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">strfilter</span> <span class="o">*</span><span class="n">available_func_filter</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * If a symbol corresponds to a function with global binding and</span>
<span class="cm"> * matches filter return 0. For all others return 1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">filter_available_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span> <span class="n">__unused</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">binding</span> <span class="o">==</span> <span class="n">STB_GLOBAL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strfilter__compare</span><span class="p">(</span><span class="n">available_func_filter</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__show_available_funcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map__load</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">filter_available_functions</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to load map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dso__sorted_by_name</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="n">dso__sort_by_name</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">dso__fprintf_symbols_by_name</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">available_kernel_funcs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_vmlinux</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">kernel_get_module_map</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to find %s map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="o">?</span> <span class="o">:</span> <span class="s">&quot;kernel&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">__show_available_funcs</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">available_user_funcs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_user_exec</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">dso__new_map</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__show_available_funcs</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="n">dso__delete</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">);</span>
	<span class="n">map__delete</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">show_available_funcs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strfilter</span> <span class="o">*</span><span class="n">_filter</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">setup_pager</span><span class="p">();</span>
	<span class="n">available_func_filter</span> <span class="o">=</span> <span class="n">_filter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">available_kernel_funcs</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">available_user_funcs</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * uprobe_events only accepts address:</span>
<span class="cm"> * Convert function and any offset to address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">convert_name_to_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_probe_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">exec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_probe_point</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">vaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;No function specified for uprobes&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">function</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to allocate memory by strdup.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">realpath</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Cannot find realpath for %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exec</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">dso__new_map</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Cannot find appropriate DSO for %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exec</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">available_func_filter</span> <span class="o">=</span> <span class="n">strfilter__new</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map__load</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">filter_available_functions</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to load map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sym</span> <span class="o">=</span> <span class="n">map__find_symbol_by_name</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Cannot find %s in DSO %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">exec</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
		<span class="n">vaddr</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">vaddr</span> <span class="o">+=</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">pgoff</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
		<span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr2</span><span class="p">;</span>

		<span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">ptr1</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">exec</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ptr2</span> <span class="o">=</span> <span class="n">strpbrk</span><span class="p">(</span><span class="n">ptr1</span><span class="p">,</span> <span class="s">&quot;-._&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr2</span><span class="p">)</span>
				<span class="o">*</span><span class="n">ptr2</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">e_snprintf</span><span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;%s_%s&quot;</span><span class="p">,</span> <span class="n">PERFPROBE_GROUP</span><span class="p">,</span>
					<span class="n">ptr1</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">ptr1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_PROBE_ARGS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to allocate memory by zalloc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e_snprintf</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="n">MAX_PROBE_ARGS</span><span class="p">,</span> <span class="s">&quot;0x%llx&quot;</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dso__delete</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">);</span>
		<span class="n">map__delete</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">function</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
