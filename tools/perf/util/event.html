<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › util › event.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>event.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &quot;event.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;sort.h&quot;</span>
<span class="cp">#include &quot;string.h&quot;</span>
<span class="cp">#include &quot;strlist.h&quot;</span>
<span class="cp">#include &quot;thread.h&quot;</span>
<span class="cp">#include &quot;thread_map.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">perf_event__names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>					<span class="o">=</span> <span class="s">&quot;TOTAL&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_MMAP</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;MMAP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_LOST</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;LOST&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_COMM</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;COMM&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_EXIT</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;EXIT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_THROTTLE</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;THROTTLE&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_UNTHROTTLE</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;UNTHROTTLE&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_FORK</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;FORK&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_READ</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;READ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_SAMPLE</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;SAMPLE&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_HEADER_ATTR</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;ATTR&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_HEADER_EVENT_TYPE</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;EVENT_TYPE&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_HEADER_TRACING_DATA</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRACING_DATA&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_HEADER_BUILD_ID</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;BUILD_ID&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PERF_RECORD_FINISHED_ROUND</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;FINISHED_ROUND&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">perf_event__name</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">perf_event__names</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;INVALID&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_event__names</span><span class="p">[</span><span class="n">id</span><span class="p">])</span>
		<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">perf_event__names</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_sample</span> <span class="n">synth_sample</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pid</span>	   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tid</span>	   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">time</span>	   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stream_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu</span>	   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period</span>	   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">pid_t</span> <span class="nf">perf_event__get_comm_tgid</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comm</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">bf</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">tgid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;/proc/%d/status&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;couldn&#39;t open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">comm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="n">tgid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bf</span><span class="p">),</span> <span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;couldn&#39;t get COMM and pgid, malformed %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">filename</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="s">&quot;Name:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">bf</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">))</span>
				<span class="o">++</span><span class="n">name</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">comm</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="s">&quot;Tgid:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">tgids</span> <span class="o">=</span> <span class="n">bf</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">tgids</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">tgids</span><span class="p">))</span>
				<span class="o">++</span><span class="n">tgids</span><span class="p">;</span>
			<span class="n">tgid</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">tgids</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tgid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pid_t</span> <span class="nf">perf_event__synthesize_comm</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
					 <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">full</span><span class="p">,</span>
					 <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">DIR</span> <span class="o">*</span><span class="n">tasks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dirent</span> <span class="n">dirent</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">tgid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">));</span>

	<span class="n">tgid</span> <span class="o">=</span> <span class="n">perf_event__get_comm_tgid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">tgid</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_RECORD_COMM</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">)</span> <span class="o">-</span>
				<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>

		<span class="n">process</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">synth_sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;/proc/%d/task&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

	<span class="n">tasks</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tasks</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;couldn&#39;t open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">readdir_r</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dirent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
		<span class="n">pid</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* already have tgid; jut want to update the comm */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">perf_event__get_comm_tgid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">));</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">)</span> <span class="o">-</span>
					  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span> <span class="o">+</span>
					  <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>

		<span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>

		<span class="n">process</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">synth_sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">closedir</span><span class="p">(</span><span class="n">tasks</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">tgid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_event__synthesize_mmap_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
					      <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					      <span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">tgid</span><span class="p">,</span>
					      <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;/proc/%d/maps&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We raced with a task exiting - just return:</span>
<span class="cm">		 */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;couldn&#39;t open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_RECORD_MMAP</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Just like the kernel, see __perf_event_mmap in kernel/perf_event.c</span>
<span class="cm">	 */</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_USER</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">bf</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">],</span> <span class="o">*</span><span class="n">pbf</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bf</span><span class="p">),</span> <span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* 00400000-0040c000 r-xp 00000000 fd:01 41038  /bin/cat */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">hex2u64</span><span class="p">(</span><span class="n">pbf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pbf</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">hex2u64</span><span class="p">(</span><span class="n">pbf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pbf</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pbf</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* vm_exec */</span>
			<span class="kt">char</span> <span class="n">anonstr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;//anon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">execname</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>

			<span class="cm">/* Catch VDSO */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">execname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">execname</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="s">&quot;[vdso]&quot;</span><span class="p">);</span>

			<span class="cm">/* Catch anonymous mmaps */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">execname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strstr</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">))</span>
				<span class="n">execname</span> <span class="o">=</span> <span class="n">anonstr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">execname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">pbf</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">hex2u64</span><span class="p">(</span><span class="n">pbf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pgoff</span><span class="p">);</span>

			<span class="n">size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">execname</span><span class="p">);</span>
			<span class="n">execname</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* Remove \n */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">execname</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span> <span class="o">-=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span> <span class="o">-</span>
					        <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">+=</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">;</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">tgid</span><span class="p">;</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>

			<span class="n">process</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">synth_sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_modules</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				   <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">nd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map_groups</span> <span class="o">*</span><span class="n">kmaps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kmaps</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span> <span class="o">+</span>
					  <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Not enough memory synthesizing mmap event &quot;</span>
			 <span class="s">&quot;for kernel modules</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_RECORD_MMAP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * kernel uses 0 for user space maps, see kernel/perf_event.c</span>
<span class="cm">	 * __perf_event_mmap</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine__is_host</span><span class="p">(</span><span class="n">machine</span><span class="p">))</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_KERNEL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nd</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kmaps</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">]);</span>
	     <span class="n">nd</span><span class="p">;</span> <span class="n">nd</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">map</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">kernel</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_RECORD_MMAP</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span> <span class="o">-</span>
				        <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">+=</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span>   <span class="o">=</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pid</span>   <span class="o">=</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span>
		       <span class="n">pos</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">process</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">synth_sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__event__synthesize_thread</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">comm_event</span><span class="p">,</span>
				      <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">mmap_event</span><span class="p">,</span>
				      <span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">full</span><span class="p">,</span>
					  <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pid_t</span> <span class="n">tgid</span> <span class="o">=</span> <span class="n">perf_event__synthesize_comm</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">comm_event</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">full</span><span class="p">,</span>
						 <span class="n">process</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">perf_event__synthesize_mmap_events</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">mmap_event</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">tgid</span><span class="p">,</span>
						  <span class="n">process</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_thread_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">thread_map</span> <span class="o">*</span><span class="n">threads</span><span class="p">,</span>
				      <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">comm_event</span><span class="p">,</span> <span class="o">*</span><span class="n">mmap_event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">comm_event</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">comm_event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">)</span> <span class="o">+</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comm_event</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mmap_event</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mmap_event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmap_event</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_comm</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">thread</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="o">++</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__event__synthesize_thread</span><span class="p">(</span><span class="n">comm_event</span><span class="p">,</span> <span class="n">mmap_event</span><span class="p">,</span>
					       <span class="n">threads</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="kr">thread</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="n">process</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">machine</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * comm.pid is set to thread group id by</span>
<span class="cm">		 * perf_event__synthesize_comm</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">comm_event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="n">threads</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="kr">thread</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">need_leader</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="cm">/* is thread group leader in thread_map? */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">comm_event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">threads</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">need_leader</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* if not, generate events for it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">need_leader</span> <span class="o">&amp;&amp;</span>
			    <span class="n">__event__synthesize_thread</span><span class="p">(</span><span class="n">comm_event</span><span class="p">,</span>
						      <span class="n">mmap_event</span><span class="p">,</span>
						      <span class="n">comm_event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						      <span class="n">process</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">machine</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">free</span><span class="p">(</span><span class="n">mmap_event</span><span class="p">);</span>
<span class="nl">out_free_comm:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">comm_event</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				   <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">DIR</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dirent</span> <span class="n">dirent</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">comm_event</span><span class="p">,</span> <span class="o">*</span><span class="n">mmap_event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">comm_event</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">comm_event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">)</span> <span class="o">+</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comm_event</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mmap_event</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mmap_event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmap_event</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_comm</span><span class="p">;</span>

	<span class="n">proc</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="s">&quot;/proc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_mmap</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">readdir_r</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dirent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
		<span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">dirent</span><span class="p">.</span><span class="n">d_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span> <span class="cm">/* only interested in proper numerical dirents */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">__event__synthesize_thread</span><span class="p">(</span><span class="n">comm_event</span><span class="p">,</span> <span class="n">mmap_event</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					   <span class="n">process</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">closedir</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free_mmap:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">mmap_event</span><span class="p">);</span>
<span class="nl">out_free_comm:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">comm_event</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">process_symbol_args</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u64</span>	   <span class="n">start</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_symbol_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="n">type</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">end</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">process_symbol_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Must be a function or at least an alias, as in PARISC64, where &quot;_text&quot; is</span>
<span class="cm">	 * an &#39;A&#39; to the same address as &quot;_stext&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">symbol_type__is_a</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">MAP__FUNCTION</span><span class="p">)</span> <span class="o">||</span>
	      <span class="n">type</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__synthesize_kernel_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
				       <span class="n">perf_event__handler_t</span> <span class="n">process</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbol_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">mmap_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">name_buff</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We should get this from /sys/kernel/sections/.text, but till that is</span>
<span class="cm">	 * available use this, and after it is use this as a fallback for older</span>
<span class="cm">	 * kernels.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">process_symbol_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">symbol_name</span><span class="p">,</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span> <span class="o">+</span>
					  <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Not enough memory synthesizing mmap event &quot;</span>
			 <span class="s">&quot;for kernel modules</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmap_name</span> <span class="o">=</span> <span class="n">machine__mmap_name</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">name_buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name_buff</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine__is_host</span><span class="p">(</span><span class="n">machine</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * kernel uses PERF_RECORD_MISC_USER for user space maps,</span>
<span class="cm">		 * see kernel/perf_event.c __perf_event_mmap</span>
<span class="cm">		 */</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_KERNEL</span><span class="p">;</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;/proc/kallsyms&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">machine__is_default_guest</span><span class="p">(</span><span class="n">machine</span><span class="p">))</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">symbol_conf</span><span class="p">.</span><span class="n">default_guest_kallsyms</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;%s/proc/kallsyms&quot;</span><span class="p">,</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">root_dir</span><span class="p">);</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kallsyms__parse</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="n">find_symbol_cb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">vmlinux_maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">];</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">),</span>
			<span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">mmap_name</span><span class="p">,</span> <span class="n">symbol_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_RECORD_MMAP</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">id_hdr_size</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pgoff</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span>   <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pid</span>   <span class="o">=</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">synth_sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">perf_event__fprintf_comm</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;: %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__process_comm</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span> <span class="n">__used</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">machine__findnew_thread</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dump_trace</span><span class="p">)</span>
		<span class="n">perf_event__fprintf_comm</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">thread__set_comm</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">.</span><span class="n">comm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;problem processing PERF_RECORD_COMM, skipping event.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__process_lost</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span> <span class="n">__used</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;: id:%&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot;: lost:%&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">event</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">.</span><span class="n">lost</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_event__set_kernel_mmap_len</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">map</span> <span class="o">**</span><span class="n">maps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span>   <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Be a bit paranoid here, some perf.data file came with</span>
<span class="cm">	 * a zero sized synthesized MMAP event for the kernel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_event__process_kernel_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
					   <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">kmmap_prefix</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">dso_kernel_type</span> <span class="n">kernel_type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_kernel_mmap</span><span class="p">;</span>

	<span class="n">machine__mmap_name</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">kmmap_prefix</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kmmap_prefix</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine__is_host</span><span class="p">(</span><span class="n">machine</span><span class="p">))</span>
		<span class="n">kernel_type</span> <span class="o">=</span> <span class="n">DSO_TYPE_KERNEL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">kernel_type</span> <span class="o">=</span> <span class="n">DSO_TYPE_GUEST_KERNEL</span><span class="p">;</span>

	<span class="n">is_kernel_mmap</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span>
				<span class="n">kmmap_prefix</span><span class="p">,</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">kmmap_prefix</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">is_kernel_mmap</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">))</span> <span class="p">{</span>

		<span class="kt">char</span> <span class="n">short_module_name</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">dot</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_problem</span><span class="p">;</span>

			<span class="o">++</span><span class="n">name</span><span class="p">;</span> <span class="cm">/* skip / */</span>
			<span class="n">dot</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_problem</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">short_module_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">short_module_name</span><span class="p">),</span>
					<span class="s">&quot;[%.*s]&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">dot</span> <span class="o">-</span> <span class="n">name</span><span class="p">),</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">strxfrchar</span><span class="p">(</span><span class="n">short_module_name</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="sc">&#39;_&#39;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">short_module_name</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">);</span>

		<span class="n">map</span> <span class="o">=</span> <span class="n">machine__new_module</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
					  <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_problem</span><span class="p">;</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">short_module_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_problem</span><span class="p">;</span>

		<span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">short_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">sname_alloc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_kernel_mmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbol_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span> <span class="o">+</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">kmmap_prefix</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * Should be there already, from the build-id table in</span>
<span class="cm">		 * the header.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">__dsos__findnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kernel_dsos</span><span class="p">,</span>
						     <span class="n">kmmap_prefix</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_problem</span><span class="p">;</span>

		<span class="n">kernel</span><span class="o">-&gt;</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel_type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__machine__create_kernel_maps</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_problem</span><span class="p">;</span>

		<span class="n">perf_event__set_kernel_mmap_len</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">vmlinux_maps</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Avoid using a zero address (kptr_restrict) for the ref reloc</span>
<span class="cm">		 * symbol. Effectively having zero here means that at record</span>
<span class="cm">		 * time /proc/sys/kernel/kptr_restrict was non zero.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pgoff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">maps__set_kallsyms_ref_reloc_sym</span><span class="p">(</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">vmlinux_maps</span><span class="p">,</span>
							 <span class="n">symbol_name</span><span class="p">,</span>
							 <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pgoff</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">machine__is_default_guest</span><span class="p">(</span><span class="n">machine</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * preload dso of guest kernel and modules</span>
<span class="cm">			 */</span>
			<span class="n">dso__load</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">vmlinux_maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">],</span>
				  <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_problem:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">perf_event__fprintf_mmap</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot; %d/%d: [%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;(%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;) @ %#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;]: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
		       <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pgoff</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__process_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span> <span class="n">__used</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cpumode</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">PERF_RECORD_MISC_CPUMODE_MASK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dump_trace</span><span class="p">)</span>
		<span class="n">perf_event__fprintf_mmap</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span> <span class="o">||</span>
	    <span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_KERNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">perf_event__process_kernel_mmap</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_problem</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kr">thread</span> <span class="o">=</span> <span class="n">machine__findnew_thread</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_problem</span><span class="p">;</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">map__new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">user_dsos</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pgoff</span><span class="p">,</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span>
			<span class="n">MAP__FUNCTION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_problem</span><span class="p">;</span>

	<span class="n">thread__insert_map</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_problem:</span>
	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;problem processing PERF_RECORD_MMAP, skipping event.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">perf_event__fprintf_task</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;(%d:%d):(%d:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span>
		       <span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">ppid</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">ptid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__process_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span> <span class="n">__used</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">machine__findnew_thread</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">machine__findnew_thread</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">fork</span><span class="p">.</span><span class="n">ptid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dump_trace</span><span class="p">)</span>
		<span class="n">perf_event__fprintf_task</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_RECORD_EXIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">machine__remove_thread</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">parent</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">thread__fork</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot;problem processing PERF_RECORD_FORK, skipping event.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">perf_event__fprintf</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;PERF_RECORD_%s&quot;</span><span class="p">,</span>
			     <span class="n">perf_event__name</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_COMM</span>:
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">perf_event__fprintf_comm</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_FORK</span>:
	<span class="k">case</span> <span class="n">PERF_RECORD_EXIT</span>:
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">perf_event__fprintf_task</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_MMAP</span>:
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">perf_event__fprintf_mmap</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__process</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span><span class="p">,</span> <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">,</span> <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_COMM</span>:
		<span class="n">perf_event__process_comm</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_MMAP</span>:
		<span class="n">perf_event__process_mmap</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_FORK</span>:
	<span class="k">case</span> <span class="n">PERF_RECORD_EXIT</span>:
		<span class="n">perf_event__process_task</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PERF_RECORD_LOST</span>:
		<span class="n">perf_event__process_lost</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">machine</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">thread__find_addr_map</span><span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cpumode</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">map_type</span> <span class="n">type</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">addr_location</span> <span class="o">*</span><span class="n">al</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">map_groups</span> <span class="o">*</span><span class="n">mg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">mg</span><span class="p">;</span>

	<span class="n">al</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
	<span class="n">al</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">al</span><span class="o">-&gt;</span><span class="n">cpumode</span> <span class="o">=</span> <span class="n">cpumode</span><span class="p">;</span>
	<span class="n">al</span><span class="o">-&gt;</span><span class="n">filtered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_KERNEL</span> <span class="o">&amp;&amp;</span> <span class="n">perf_host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">al</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="sc">&#39;k&#39;</span><span class="p">;</span>
		<span class="n">mg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kmaps</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_USER</span> <span class="o">&amp;&amp;</span> <span class="n">perf_host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">al</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span> <span class="o">&amp;&amp;</span> <span class="n">perf_guest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">al</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="sc">&#39;g&#39;</span><span class="p">;</span>
		<span class="n">mg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kmaps</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * &#39;u&#39; means guest os user space.</span>
<span class="cm">		 * TODO: We don&#39;t support guest user space. Might support late.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_GUEST_USER</span> <span class="o">&amp;&amp;</span> <span class="n">perf_guest</span><span class="p">)</span>
			<span class="n">al</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="sc">&#39;u&#39;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">al</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="sc">&#39;H&#39;</span><span class="p">;</span>
		<span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_GUEST_USER</span> <span class="o">||</span>
			<span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_GUEST_KERNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">perf_guest</span><span class="p">)</span>
			<span class="n">al</span><span class="o">-&gt;</span><span class="n">filtered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_USER</span> <span class="o">||</span>
			<span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_KERNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">perf_host</span><span class="p">)</span>
			<span class="n">al</span><span class="o">-&gt;</span><span class="n">filtered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">try_again:</span>
	<span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">=</span> <span class="n">map_groups__find</span><span class="p">(</span><span class="n">mg</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">al</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If this is outside of all known maps, and is a negative</span>
<span class="cm">		 * address, try to look it up in the kernel dso, as it might be</span>
<span class="cm">		 * a vsyscall or vdso (which executes in user-mode).</span>
<span class="cm">		 *</span>
<span class="cm">		 * XXX This is nasty, we should have a symbol list in the</span>
<span class="cm">		 * &quot;[vdso]&quot; dso, but for now lets use the old trick of looking</span>
<span class="cm">		 * in the whole kernel symbol list.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">al</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_USER</span> <span class="o">&amp;&amp;</span>
		    <span class="n">machine</span> <span class="o">&amp;&amp;</span> <span class="n">mg</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kmaps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">machine</span><span class="o">-&gt;</span><span class="n">kmaps</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">al</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">map_ip</span><span class="p">(</span><span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">al</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">thread__find_addr_location</span><span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span> <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">cpumode</span><span class="p">,</span> <span class="k">enum</span> <span class="n">map_type</span> <span class="n">type</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">addr_location</span> <span class="o">*</span><span class="n">al</span><span class="p">,</span>
				<span class="n">symbol_filter_t</span> <span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">thread__find_addr_map</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">cpumode</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">al</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">al</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">=</span> <span class="n">map__find_symbol</span><span class="p">(</span><span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">al</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">al</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">perf_event__preprocess_sample</span><span class="p">(</span><span class="k">const</span> <span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">addr_location</span> <span class="o">*</span><span class="n">al</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">,</span>
				  <span class="n">symbol_filter_t</span> <span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cpumode</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">PERF_RECORD_MISC_CPUMODE_MASK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">machine__findnew_thread</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">comm_list</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">strlist__has_entry</span><span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">comm_list</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_filtered</span><span class="p">;</span>

	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot; ... thread: %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Have we already created the kernel maps for this machine?</span>
<span class="cm">	 *</span>
<span class="cm">	 * This should have happened earlier, when we processed the kernel MMAP</span>
<span class="cm">	 * events, but for older perf.data files there was no such thing, so do</span>
<span class="cm">	 * it now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpumode</span> <span class="o">==</span> <span class="n">PERF_RECORD_MISC_KERNEL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">machine</span><span class="o">-&gt;</span><span class="n">vmlinux_maps</span><span class="p">[</span><span class="n">MAP__FUNCTION</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">machine__create_kernel_maps</span><span class="p">(</span><span class="n">machine</span><span class="p">);</span>

	<span class="n">thread__find_addr_map</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">cpumode</span><span class="p">,</span> <span class="n">MAP__FUNCTION</span><span class="p">,</span>
			      <span class="n">event</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">al</span><span class="p">);</span>
	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot; ...... dso: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">?</span> <span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span> <span class="o">:</span>
			<span class="n">al</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="sc">&#39;H&#39;</span> <span class="o">?</span> <span class="s">&quot;[hypervisor]&quot;</span> <span class="o">:</span> <span class="s">&quot;&lt;not found&gt;&quot;</span><span class="p">);</span>
	<span class="n">al</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">al</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dso</span> <span class="o">*</span><span class="n">dso</span> <span class="o">=</span> <span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dso</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">dso_list</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">dso</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">strlist__has_entry</span><span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">dso_list</span><span class="p">,</span>
						  <span class="n">dso</span><span class="o">-&gt;</span><span class="n">short_name</span><span class="p">)</span> <span class="o">||</span>
			       <span class="p">(</span><span class="n">dso</span><span class="o">-&gt;</span><span class="n">short_name</span> <span class="o">!=</span> <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span> <span class="o">&amp;&amp;</span>
				<span class="n">strlist__has_entry</span><span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">dso_list</span><span class="p">,</span>
						   <span class="n">dso</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">)))))</span>
			<span class="k">goto</span> <span class="n">out_filtered</span><span class="p">;</span>

		<span class="n">al</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">=</span> <span class="n">map__find_symbol</span><span class="p">(</span><span class="n">al</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">al</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">sym_list</span> <span class="o">&amp;&amp;</span> <span class="n">al</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">strlist__has_entry</span><span class="p">(</span><span class="n">symbol_conf</span><span class="p">.</span><span class="n">sym_list</span><span class="p">,</span> <span class="n">al</span><span class="o">-&gt;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_filtered</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_filtered:</span>
	<span class="n">al</span><span class="o">-&gt;</span><span class="n">filtered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
