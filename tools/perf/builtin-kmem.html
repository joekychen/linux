<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › builtin-kmem.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>builtin-kmem.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;builtin.h&quot;</span>
<span class="cp">#include &quot;perf.h&quot;</span>

<span class="cp">#include &quot;util/util.h&quot;</span>
<span class="cp">#include &quot;util/cache.h&quot;</span>
<span class="cp">#include &quot;util/symbol.h&quot;</span>
<span class="cp">#include &quot;util/thread.h&quot;</span>
<span class="cp">#include &quot;util/header.h&quot;</span>
<span class="cp">#include &quot;util/session.h&quot;</span>
<span class="cp">#include &quot;util/tool.h&quot;</span>

<span class="cp">#include &quot;util/parse-options.h&quot;</span>
<span class="cp">#include &quot;util/trace-event.h&quot;</span>

<span class="cp">#include &quot;util/debug.h&quot;</span>

<span class="cp">#include &lt;linux/rbtree.h&gt;</span>

<span class="k">struct</span> <span class="n">alloc_stat</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">sort_fn_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">input_name</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>			<span class="n">alloc_flag</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>			<span class="n">caller_flag</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>			<span class="n">alloc_lines</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>			<span class="n">caller_lines</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span>			<span class="n">raw_ip</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span>			<span class="n">default_sort_order</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;frag,hit,bytes&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>			<span class="o">*</span><span class="n">cpunode_map</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>			<span class="n">max_cpu_num</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">alloc_stat</span> <span class="p">{</span>
	<span class="n">u64</span>	<span class="n">call_site</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">ptr</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">bytes_req</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">bytes_alloc</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hit</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pingpong</span><span class="p">;</span>

	<span class="kt">short</span>	<span class="n">alloc_cpu</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rb_node</span> <span class="n">node</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">root_alloc_stat</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">root_alloc_sorted</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">root_caller_stat</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">root_caller_sorted</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_requested</span><span class="p">,</span> <span class="n">total_allocated</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_allocs</span><span class="p">,</span> <span class="n">nr_cross_allocs</span><span class="p">;</span>

<span class="cp">#define PATH_SYS_NODE	&quot;/sys/devices/system/node&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_cpunode_map</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;/sys/devices/system/cpu/kernel_max&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_cpu_num</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_cpu_num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Failed to read &#39;kernel_max&#39; from sysfs&quot;</span><span class="p">);</span>
	<span class="n">max_cpu_num</span><span class="o">++</span><span class="p">;</span>

	<span class="n">cpunode_map</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">max_cpu_num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpunode_map</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;calloc&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_cpu_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cpunode_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_cpunode_map</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">dent1</span><span class="p">,</span> <span class="o">*</span><span class="n">dent2</span><span class="p">;</span>
	<span class="kt">DIR</span> <span class="o">*</span><span class="n">dir1</span><span class="p">,</span> <span class="o">*</span><span class="n">dir2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">mem</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>

	<span class="n">init_cpunode_map</span><span class="p">();</span>

	<span class="n">dir1</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">PATH_SYS_NODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">dent1</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir1</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dent1</span><span class="o">-&gt;</span><span class="n">d_type</span> <span class="o">!=</span> <span class="n">DT_DIR</span> <span class="o">||</span>
		    <span class="n">sscanf</span><span class="p">(</span><span class="n">dent1</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&quot;node%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">PATH_SYS_NODE</span><span class="p">,</span> <span class="n">dent1</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
		<span class="n">dir2</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir2</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">dent2</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dent2</span><span class="o">-&gt;</span><span class="n">d_type</span> <span class="o">!=</span> <span class="n">DT_LNK</span> <span class="o">||</span>
			    <span class="n">sscanf</span><span class="p">(</span><span class="n">dent2</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&quot;cpu%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">cpunode_map</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">closedir</span><span class="p">(</span><span class="n">dir2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">closedir</span><span class="p">(</span><span class="n">dir1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_alloc_stat</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">call_site</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">bytes_req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytes_alloc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root_alloc_stat</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">hit</span><span class="o">++</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_req</span> <span class="o">+=</span> <span class="n">bytes_req</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span> <span class="o">+=</span> <span class="n">bytes_alloc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc&quot;</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pingpong</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">hit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_req</span> <span class="o">=</span> <span class="n">bytes_req</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span> <span class="o">=</span> <span class="n">bytes_alloc</span><span class="p">;</span>

		<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">root_alloc_stat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">call_site</span> <span class="o">=</span> <span class="n">call_site</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">alloc_cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_caller_stat</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">call_site</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">bytes_req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytes_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root_caller_stat</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">call_site</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">call_site</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">call_site</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">call_site</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">call_site</span> <span class="o">==</span> <span class="n">call_site</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">hit</span><span class="o">++</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_req</span> <span class="o">+=</span> <span class="n">bytes_req</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span> <span class="o">+=</span> <span class="n">bytes_alloc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc&quot;</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">call_site</span> <span class="o">=</span> <span class="n">call_site</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pingpong</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">hit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_req</span> <span class="o">=</span> <span class="n">bytes_req</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span> <span class="o">=</span> <span class="n">bytes_alloc</span><span class="p">;</span>

		<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">root_caller_stat</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_alloc_event</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span>
				<span class="n">u64</span> <span class="n">timestamp</span> <span class="n">__used</span><span class="p">,</span>
				<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="n">__used</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">call_site</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_alloc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">raw_field_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">call_site</span> <span class="o">=</span> <span class="n">raw_field_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;call_site&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">bytes_req</span> <span class="o">=</span> <span class="n">raw_field_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;bytes_req&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">bytes_alloc</span> <span class="o">=</span> <span class="n">raw_field_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;bytes_alloc&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">insert_alloc_stat</span><span class="p">(</span><span class="n">call_site</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">bytes_req</span><span class="p">,</span> <span class="n">bytes_alloc</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">insert_caller_stat</span><span class="p">(</span><span class="n">call_site</span><span class="p">,</span> <span class="n">bytes_req</span><span class="p">,</span> <span class="n">bytes_alloc</span><span class="p">);</span>

	<span class="n">total_requested</span> <span class="o">+=</span> <span class="n">bytes_req</span><span class="p">;</span>
	<span class="n">total_allocated</span> <span class="o">+=</span> <span class="n">bytes_alloc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">node1</span> <span class="o">=</span> <span class="n">cpunode_map</span><span class="p">[</span><span class="n">cpu</span><span class="p">];</span>
		<span class="n">node2</span> <span class="o">=</span> <span class="n">raw_field_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;node&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node1</span> <span class="o">!=</span> <span class="n">node2</span><span class="p">)</span>
			<span class="n">nr_cross_allocs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nr_allocs</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ptr_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">callsite_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="nf">search_alloc_stat</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">call_site</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
					    <span class="n">sort_fn_t</span> <span class="n">sort_fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">alloc_stat</span> <span class="n">key</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">,</span> <span class="p">.</span><span class="n">call_site</span> <span class="o">=</span> <span class="n">call_site</span> <span class="p">};</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="n">cmp</span> <span class="o">=</span> <span class="n">sort_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_free_event</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">timestamp</span> <span class="n">__used</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">s_alloc</span><span class="p">,</span> <span class="o">*</span><span class="n">s_caller</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">raw_field_value</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">s_alloc</span> <span class="o">=</span> <span class="n">search_alloc_stat</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">root_alloc_stat</span><span class="p">,</span> <span class="n">ptr_cmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s_alloc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">!=</span> <span class="n">s_alloc</span><span class="o">-&gt;</span><span class="n">alloc_cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s_alloc</span><span class="o">-&gt;</span><span class="n">pingpong</span><span class="o">++</span><span class="p">;</span>

		<span class="n">s_caller</span> <span class="o">=</span> <span class="n">search_alloc_stat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s_alloc</span><span class="o">-&gt;</span><span class="n">call_site</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">root_caller_stat</span><span class="p">,</span> <span class="n">callsite_cmp</span><span class="p">);</span>
		<span class="n">assert</span><span class="p">(</span><span class="n">s_caller</span><span class="p">);</span>
		<span class="n">s_caller</span><span class="o">-&gt;</span><span class="n">pingpong</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s_alloc</span><span class="o">-&gt;</span><span class="n">alloc_cpu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_raw_event</span><span class="p">(</span><span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">raw_event</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">timestamp</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_format</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">trace_parse_common_type</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">trace_find_event</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;kmalloc&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;kmem_cache_alloc&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">process_alloc_event</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;kmalloc_node&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;kmem_cache_alloc_node&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">process_alloc_event</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;kfree&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;kmem_cache_free&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">process_free_event</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_sample_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_tool</span> <span class="o">*</span><span class="n">tool</span> <span class="n">__used</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">perf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">machine__findnew_thread</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;problem processing %d event, skipping it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dump_printf</span><span class="p">(</span><span class="s">&quot; ... thread: %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">process_raw_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
			  <span class="n">sample</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_tool</span> <span class="n">perf_kmem</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sample</span>			<span class="o">=</span> <span class="n">process_sample_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">comm</span>			<span class="o">=</span> <span class="n">perf_event__process_comm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ordered_samples</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">double</span> <span class="nf">fragmentation</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n_req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_alloc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">n_req</span> <span class="o">/</span> <span class="n">n_alloc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__print_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">n_lines</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_caller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">machine</span> <span class="o">*</span><span class="n">machine</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.102s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">graph_dotted_line</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %-34s |&quot;</span><span class="p">,</span>  <span class="n">is_caller</span> <span class="o">?</span> <span class="s">&quot;Callsite&quot;</span><span class="o">:</span> <span class="s">&quot;Alloc Ptr&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot; Total_alloc/Per | Total_req/Per   | Hit      | Ping-pong | Frag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.102s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">graph_dotted_line</span><span class="p">);</span>

	<span class="n">next</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

	<span class="n">machine</span> <span class="o">=</span> <span class="n">perf_session__find_host_machine</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;__print_result: couldn&#39;t find kernel information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="n">n_lines</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span><span class="p">,</span>
						   <span class="n">node</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">symbol</span> <span class="o">*</span><span class="n">sym</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>
		<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_caller</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">call_site</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raw_ip</span><span class="p">)</span>
				<span class="n">sym</span> <span class="o">=</span> <span class="n">machine__find_kernel_function</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%s+%&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				 <span class="n">addr</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">unmap_ip</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%#&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %-34s |&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %9llu/%-5lu | %9llu/%-5lu | %8lu | %8lu | %6.3f%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span> <span class="o">/</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hit</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_req</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_req</span> <span class="o">/</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hit</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hit</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pingpong</span><span class="p">,</span>
		       <span class="n">fragmentation</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_req</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span><span class="p">));</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_lines</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot; ...                                | ...             | ...             | ...    | ...      | ...   </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.102s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">graph_dotted_line</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_summary</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">SUMMARY</span><span class="se">\n</span><span class="s">=======</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Total bytes requested: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_requested</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Total bytes allocated: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_allocated</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Total bytes wasted on internal fragmentation: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">total_allocated</span> <span class="o">-</span> <span class="n">total_requested</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Internal fragmentation: %f%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fragmentation</span><span class="p">(</span><span class="n">total_requested</span><span class="p">,</span> <span class="n">total_allocated</span><span class="p">));</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Cross CPU allocations: %lu/%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr_cross_allocs</span><span class="p">,</span> <span class="n">nr_allocs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caller_flag</span><span class="p">)</span>
		<span class="n">__print_result</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root_caller_sorted</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">caller_lines</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_flag</span><span class="p">)</span>
		<span class="n">__print_result</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root_alloc_sorted</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">alloc_lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">print_summary</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sort_dimension</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">sort_fn_t</span>		<span class="n">cmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">caller_sort</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">alloc_sort</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sort_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">sort_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">new</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sort_dimension</span> <span class="o">*</span><span class="n">sort</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">this</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">sort_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmp</span> <span class="o">=</span> <span class="n">sort</span><span class="o">-&gt;</span><span class="n">cmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">new</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">new</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">new</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">new</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__sort_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root_sorted</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">sort_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rb_erase</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">sort_insert</span><span class="p">(</span><span class="n">root_sorted</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sort_list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sort_result</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__sort_result</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root_alloc_stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">root_alloc_sorted</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alloc_sort</span><span class="p">);</span>
	<span class="n">__sort_result</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root_caller_stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">root_caller_sorted</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">caller_sort</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__cmd_kmem</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">perf_session__new</span><span class="p">(</span><span class="n">input_name</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">,</span>
							 <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">perf_kmem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_session__create_kernel_maps</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_delete</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_session__has_traces</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s">&quot;kmem record&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_delete</span><span class="p">;</span>

	<span class="n">setup_pager</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">perf_session__process_events</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">perf_kmem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_delete</span><span class="p">;</span>
	<span class="n">sort_result</span><span class="p">();</span>
	<span class="n">print_result</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="nl">out_delete:</span>
	<span class="n">perf_session__delete</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">kmem_usage</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;perf kmem [&lt;options&gt;] {record|stat}&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ptr_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sort_dimension</span> <span class="n">ptr_sort_dimension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ptr&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmp</span>	<span class="o">=</span> <span class="n">ptr_cmp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">callsite_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">call_site</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">call_site</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">call_site</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">call_site</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sort_dimension</span> <span class="n">callsite_sort_dimension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;callsite&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmp</span>	<span class="o">=</span> <span class="n">callsite_cmp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hit_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">hit</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">hit</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">hit</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">hit</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sort_dimension</span> <span class="n">hit_sort_dimension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;hit&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmp</span>	<span class="o">=</span> <span class="n">hit_cmp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bytes_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sort_dimension</span> <span class="n">bytes_sort_dimension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;bytes&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmp</span>	<span class="o">=</span> <span class="n">bytes_cmp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">frag_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">fragmentation</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">bytes_req</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span><span class="p">);</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">fragmentation</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">bytes_req</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bytes_alloc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sort_dimension</span> <span class="n">frag_sort_dimension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;frag&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmp</span>	<span class="o">=</span> <span class="n">frag_cmp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pingpong_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">alloc_stat</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">pingpong</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">pingpong</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">pingpong</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">pingpong</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sort_dimension</span> <span class="n">pingpong_sort_dimension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;pingpong&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmp</span>	<span class="o">=</span> <span class="n">pingpong_cmp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sort_dimension</span> <span class="o">*</span><span class="n">avail_sorts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">ptr_sort_dimension</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">callsite_sort_dimension</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hit_sort_dimension</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bytes_sort_dimension</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">frag_sort_dimension</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pingpong_sort_dimension</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define NUM_AVAIL_SORTS	\</span>
<span class="cp">	(int)(sizeof(avail_sorts) / sizeof(struct sort_dimension *))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sort_dimension__add</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sort_dimension</span> <span class="o">*</span><span class="n">sort</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_AVAIL_SORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">avail_sorts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tok</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sort</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sort</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sort</span><span class="p">)</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">avail_sorts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sort</span><span class="p">));</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_sorting</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">sort_list</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tok</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;strdup&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tok</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tok</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sort_dimension__add</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="n">sort_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span><span class="p">(</span><span class="s">&quot;Unknown --sort key: &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_sort_opt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span> <span class="n">__used</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caller_flag</span> <span class="o">&gt;</span> <span class="n">alloc_flag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">setup_sorting</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller_sort</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">setup_sorting</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alloc_sort</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_caller_opt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span> <span class="n">__used</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">caller_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">alloc_flag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_alloc_opt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span> <span class="n">__used</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">alloc_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">caller_flag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_line_opt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span> <span class="n">__used</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">lines</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caller_flag</span> <span class="o">&gt;</span> <span class="n">alloc_flag</span><span class="p">)</span>
		<span class="n">caller_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">alloc_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">kmem_options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;i&#39;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_name</span><span class="p">,</span> <span class="s">&quot;file&quot;</span><span class="p">,</span>
		   <span class="s">&quot;input file name&quot;</span><span class="p">),</span>
	<span class="n">OPT_CALLBACK_NOOPT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;caller&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			   <span class="s">&quot;show per-callsite statistics&quot;</span><span class="p">,</span>
			   <span class="n">parse_caller_opt</span><span class="p">),</span>
	<span class="n">OPT_CALLBACK_NOOPT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;alloc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			   <span class="s">&quot;show per-allocation statistics&quot;</span><span class="p">,</span>
			   <span class="n">parse_alloc_opt</span><span class="p">),</span>
	<span class="n">OPT_CALLBACK</span><span class="p">(</span><span class="sc">&#39;s&#39;</span><span class="p">,</span> <span class="s">&quot;sort&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;key[,key2...]&quot;</span><span class="p">,</span>
		     <span class="s">&quot;sort by keys: ptr, call_site, bytes, hit, pingpong, frag&quot;</span><span class="p">,</span>
		     <span class="n">parse_sort_opt</span><span class="p">),</span>
	<span class="n">OPT_CALLBACK</span><span class="p">(</span><span class="sc">&#39;l&#39;</span><span class="p">,</span> <span class="s">&quot;line&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;num&quot;</span><span class="p">,</span>
		     <span class="s">&quot;show n lines&quot;</span><span class="p">,</span>
		     <span class="n">parse_line_opt</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;raw-ip&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw_ip</span><span class="p">,</span> <span class="s">&quot;show raw ip instead of symbol&quot;</span><span class="p">),</span>
	<span class="n">OPT_END</span><span class="p">()</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">record_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;record&quot;</span><span class="p">,</span>
	<span class="s">&quot;-a&quot;</span><span class="p">,</span>
	<span class="s">&quot;-R&quot;</span><span class="p">,</span>
	<span class="s">&quot;-f&quot;</span><span class="p">,</span>
	<span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
	<span class="s">&quot;-e&quot;</span><span class="p">,</span> <span class="s">&quot;kmem:kmalloc&quot;</span><span class="p">,</span>
	<span class="s">&quot;-e&quot;</span><span class="p">,</span> <span class="s">&quot;kmem:kmalloc_node&quot;</span><span class="p">,</span>
	<span class="s">&quot;-e&quot;</span><span class="p">,</span> <span class="s">&quot;kmem:kfree&quot;</span><span class="p">,</span>
	<span class="s">&quot;-e&quot;</span><span class="p">,</span> <span class="s">&quot;kmem:kmem_cache_alloc&quot;</span><span class="p">,</span>
	<span class="s">&quot;-e&quot;</span><span class="p">,</span> <span class="s">&quot;kmem:kmem_cache_alloc_node&quot;</span><span class="p">,</span>
	<span class="s">&quot;-e&quot;</span><span class="p">,</span> <span class="s">&quot;kmem:kmem_cache_free&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__cmd_record</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rec_argc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">rec_argv</span><span class="p">;</span>

	<span class="n">rec_argc</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">record_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rec_argv</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">rec_argc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec_argv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">record_args</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rec_argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">record_args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rec_argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">cmd_record</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rec_argv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cmd_kmem</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">argc</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">kmem_options</span><span class="p">,</span> <span class="n">kmem_usage</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argc</span><span class="p">)</span>
		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">kmem_usage</span><span class="p">,</span> <span class="n">kmem_options</span><span class="p">);</span>

	<span class="n">symbol__init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;rec&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">__cmd_record</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;stat&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">setup_cpunode_map</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller_sort</span><span class="p">))</span>
			<span class="n">setup_sorting</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caller_sort</span><span class="p">,</span> <span class="n">default_sort_order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alloc_sort</span><span class="p">))</span>
			<span class="n">setup_sorting</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alloc_sort</span><span class="p">,</span> <span class="n">default_sort_order</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">__cmd_kmem</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">kmem_usage</span><span class="p">,</span> <span class="n">kmem_options</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
