<!DOCTYPE html>
<html><head><title>joekychen/linux » tools › perf › builtin-stat.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>builtin-stat.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * builtin-stat.c</span>
<span class="cm"> *</span>
<span class="cm"> * Builtin stat command: Give a precise performance counters summary</span>
<span class="cm"> * overview about any workload, CPU or specific PID.</span>
<span class="cm"> *</span>
<span class="cm"> * Sample output:</span>

<span class="cm">   $ perf stat ./hackbench 10</span>

<span class="cm">  Time: 0.118</span>

<span class="cm">  Performance counter stats for &#39;./hackbench 10&#39;:</span>

<span class="cm">       1708.761321 task-clock                #   11.037 CPUs utilized</span>
<span class="cm">            41,190 context-switches          #    0.024 M/sec</span>
<span class="cm">             6,735 CPU-migrations            #    0.004 M/sec</span>
<span class="cm">            17,318 page-faults               #    0.010 M/sec</span>
<span class="cm">     5,205,202,243 cycles                    #    3.046 GHz</span>
<span class="cm">     3,856,436,920 stalled-cycles-frontend   #   74.09% frontend cycles idle</span>
<span class="cm">     1,600,790,871 stalled-cycles-backend    #   30.75% backend  cycles idle</span>
<span class="cm">     2,603,501,247 instructions              #    0.50  insns per cycle</span>
<span class="cm">                                             #    1.48  stalled cycles per insn</span>
<span class="cm">       484,357,498 branches                  #  283.455 M/sec</span>
<span class="cm">         6,388,934 branch-misses             #    1.32% of all branches</span>

<span class="cm">        0.154822978  seconds time elapsed</span>

<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008-2011, Red Hat Inc, Ingo Molnar &lt;mingo@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Improvements and fixes by:</span>
<span class="cm"> *</span>
<span class="cm"> *   Arjan van de Ven &lt;arjan@linux.intel.com&gt;</span>
<span class="cm"> *   Yanmin Zhang &lt;yanmin.zhang@intel.com&gt;</span>
<span class="cm"> *   Wu Fengguang &lt;fengguang.wu@intel.com&gt;</span>
<span class="cm"> *   Mike Galbraith &lt;efault@gmx.de&gt;</span>
<span class="cm"> *   Paul Mackerras &lt;paulus@samba.org&gt;</span>
<span class="cm"> *   Jaswinder Singh Rajput &lt;jaswinder@kernel.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Released under the GPL v2. (and only v2, not any later version)</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;perf.h&quot;</span>
<span class="cp">#include &quot;builtin.h&quot;</span>
<span class="cp">#include &quot;util/util.h&quot;</span>
<span class="cp">#include &quot;util/parse-options.h&quot;</span>
<span class="cp">#include &quot;util/parse-events.h&quot;</span>
<span class="cp">#include &quot;util/event.h&quot;</span>
<span class="cp">#include &quot;util/evlist.h&quot;</span>
<span class="cp">#include &quot;util/evsel.h&quot;</span>
<span class="cp">#include &quot;util/debug.h&quot;</span>
<span class="cp">#include &quot;util/color.h&quot;</span>
<span class="cp">#include &quot;util/header.h&quot;</span>
<span class="cp">#include &quot;util/cpumap.h&quot;</span>
<span class="cp">#include &quot;util/thread.h&quot;</span>
<span class="cp">#include &quot;util/thread_map.h&quot;</span>

<span class="cp">#include &lt;sys/prctl.h&gt;</span>
<span class="cp">#include &lt;math.h&gt;</span>
<span class="cp">#include &lt;locale.h&gt;</span>

<span class="cp">#define DEFAULT_SEPARATOR	&quot; &quot;</span>
<span class="cp">#define CNTR_NOT_SUPPORTED	&quot;&lt;not supported&gt;&quot;</span>
<span class="cp">#define CNTR_NOT_COUNTED	&quot;&lt;not counted&gt;&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_SOFTWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_SW_TASK_CLOCK</span>		<span class="p">},</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_SOFTWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_SW_CONTEXT_SWITCHES</span>	<span class="p">},</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_SOFTWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_SW_CPU_MIGRATIONS</span>		<span class="p">},</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_SOFTWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_SW_PAGE_FAULTS</span>		<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HARDWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_CPU_CYCLES</span>		<span class="p">},</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HARDWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_STALLED_CYCLES_FRONTEND</span>	<span class="p">},</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HARDWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_STALLED_CYCLES_BACKEND</span>	<span class="p">},</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HARDWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_INSTRUCTIONS</span>		<span class="p">},</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HARDWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span>	<span class="p">},</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HARDWARE</span><span class="p">,</span> <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_BRANCH_MISSES</span>		<span class="p">},</span>

<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Detailed stats (-d), covering the L1 and last level data caches:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">detailed_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_L1D</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_ACCESS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_L1D</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_LL</span>			<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_ACCESS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_LL</span>			<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Very detailed stats (-d -d), covering the instruction cache and the TLB caches:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">very_detailed_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_L1I</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_ACCESS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_L1I</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_DTLB</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_ACCESS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_DTLB</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_ITLB</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_ACCESS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_ITLB</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span>		<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Very, very detailed stats (-d -d -d), adding prefetch events:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">very_very_detailed_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_L1D</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_PREFETCH</span>	<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_ACCESS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>

  <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HW_CACHE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">config</span> <span class="o">=</span>
	 <span class="n">PERF_COUNT_HW_CACHE_L1D</span>		<span class="o">&lt;&lt;</span>  <span class="mi">0</span>  <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_OP_PREFETCH</span>	<span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span>	<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>				<span class="p">},</span>
<span class="p">};</span>



<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_evlist</span>	<span class="o">*</span><span class="n">evsel_list</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_target</span>	<span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">uid</span>	<span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>			<span class="n">run_idx</span>				<span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>			<span class="n">run_count</span>			<span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span>			<span class="n">no_inherit</span>			<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span>			<span class="n">scale</span>				<span class="o">=</span>  <span class="nb">true</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span>			<span class="n">no_aggr</span>				<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="n">pid_t</span>			<span class="n">child_pid</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span>			<span class="n">null_run</span>			<span class="o">=</span>  <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>			<span class="n">detailed_run</span>			<span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span>			<span class="n">sync_run</span>			<span class="o">=</span>  <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span>			<span class="n">big_num</span>				<span class="o">=</span>  <span class="nb">true</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>			<span class="n">big_num_opt</span>			<span class="o">=</span>  <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">csv_sep</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span>			<span class="n">csv_output</span>			<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span>			<span class="n">group</span>				<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">output_name</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">FILE</span>			<span class="o">*</span><span class="n">output</span>				<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>			<span class="n">output_fd</span><span class="p">;</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">stats</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">n</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">M2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">perf_stat</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">stats</span>	  <span class="n">res_stats</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_evsel__alloc_stat_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_stat</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENOMEM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_evsel__free_stat_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free</span><span class="p">(</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="n">val</span> <span class="o">-</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">mean</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">mean</span> <span class="o">+=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">M2</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">mean</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">double</span> <span class="nf">avg_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">mean</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * http://en.wikipedia.org/wiki/Algorithms_for_calculating_variance</span>
<span class="cm"> *</span>
<span class="cm"> *       (\Sum n_i^2) - ((\Sum n_i)^2)/n</span>
<span class="cm"> * s^2 = -------------------------------</span>
<span class="cm"> *                  n - 1</span>
<span class="cm"> *</span>
<span class="cm"> * http://en.wikipedia.org/wiki/Stddev</span>
<span class="cm"> *</span>
<span class="cm"> * The std dev of the mean is related to the std dev by:</span>
<span class="cm"> *</span>
<span class="cm"> *             s</span>
<span class="cm"> * s_mean = -------</span>
<span class="cm"> *          sqrt(n)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">double</span> <span class="nf">stddev_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">variance</span><span class="p">,</span> <span class="n">variance_mean</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span> <span class="mf">0.0</span><span class="p">;</span>

	<span class="n">variance</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">M2</span> <span class="o">/</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">variance_mean</span> <span class="o">=</span> <span class="n">variance</span> <span class="o">/</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">variance_mean</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_nsecs_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_cycles_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_stalled_cycles_front_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_stalled_cycles_back_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_branches_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_cacherefs_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_l1_dcache_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_l1_icache_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_ll_cache_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_itlb_cache_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">runtime_dtlb_cache_stats</span><span class="p">[</span><span class="n">MAX_NR_CPUS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stats</span> <span class="n">walltime_nsecs_stats</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_perf_stat_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">first</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xyarray</span> <span class="o">*</span><span class="n">group_fd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">exclude_guest_missing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">evsel</span> <span class="o">!=</span> <span class="n">first</span><span class="p">)</span>
		<span class="n">group_fd</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scale</span><span class="p">)</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">read_format</span> <span class="o">=</span> <span class="n">PERF_FORMAT_TOTAL_TIME_ENABLED</span> <span class="o">|</span>
				    <span class="n">PERF_FORMAT_TOTAL_TIME_RUNNING</span><span class="p">;</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">inherit</span> <span class="o">=</span> <span class="o">!</span><span class="n">no_inherit</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exclude_guest_missing</span><span class="p">)</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_guest</span> <span class="o">=</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_host</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_target__has_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">perf_evsel__open_per_cpu</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span>
					       <span class="n">group</span><span class="p">,</span> <span class="n">group_fd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">check_ret</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_target__has_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">group</span> <span class="o">||</span> <span class="n">evsel</span> <span class="o">==</span> <span class="n">first</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">enable_on_exec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">perf_evsel__open_per_thread</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">threads</span><span class="p">,</span>
					  <span class="n">group</span><span class="p">,</span> <span class="n">group_fd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* fall through */</span>
<span class="nl">check_ret:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exclude_guest_missing</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_guest</span> <span class="o">||</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Old kernel, cannot exclude &quot;</span>
				 <span class="s">&quot;guest or host samples.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exclude_guest_missing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Does the counter have nsecs as a unit?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nsec_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">SOFTWARE</span><span class="p">,</span> <span class="n">SW_CPU_CLOCK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">SOFTWARE</span><span class="p">,</span> <span class="n">SW_TASK_CLOCK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update various tracking values we maintain to print</span>
<span class="cm"> * more semantic information such as miss/hit ratios,</span>
<span class="cm"> * instruction rates, etc:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_shadow_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">SOFTWARE</span><span class="p">,</span> <span class="n">SW_TASK_CLOCK</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_nsecs_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_CPU_CYCLES</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_cycles_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_STALLED_CYCLES_FRONTEND</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_stalled_cycles_front_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_STALLED_CYCLES_BACKEND</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_stalled_cycles_back_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_BRANCH_INSTRUCTIONS</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_branches_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_CACHE_REFERENCES</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_cacherefs_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HW_CACHE</span><span class="p">,</span> <span class="n">HW_CACHE_L1D</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_l1_dcache_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HW_CACHE</span><span class="p">,</span> <span class="n">HW_CACHE_L1I</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_l1_icache_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HW_CACHE</span><span class="p">,</span> <span class="n">HW_CACHE_LL</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_ll_cache_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HW_CACHE</span><span class="p">,</span> <span class="n">HW_CACHE_DTLB</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_dtlb_cache_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">HW_CACHE</span><span class="p">,</span> <span class="n">HW_CACHE_ITLB</span><span class="p">))</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_itlb_cache_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read out the results of a single counter:</span>
<span class="cm"> * aggregate counts across CPUs in system-wide mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_counter_aggr</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">counter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_stat</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">aggr</span><span class="p">.</span><span class="n">values</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__perf_evsel__read</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span>
			       <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">threads</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">res_stats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;%s: %&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot; %&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot; %&quot;</span> <span class="n">PRIu64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">event_name</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">count</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save the full runtime - to allow normalization during printout:</span>
<span class="cm">	 */</span>
	<span class="n">update_shadow_stats</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read out the results of a single counter:</span>
<span class="cm"> * do not aggregate counts across CPUs in system-wide mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">counter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">cpu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__perf_evsel__read_on_cpu</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">values</span><span class="p">;</span>

		<span class="n">update_shadow_stats</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">run_perf_stat</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span> <span class="n">__used</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">child_ready_pipe</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">go_pipe</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">const</span> <span class="n">bool</span> <span class="n">forks</span> <span class="o">=</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">forks</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">child_ready_pipe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pipe</span><span class="p">(</span><span class="n">go_pipe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;failed to create pipes&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">forks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">child_pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;failed to fork&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child_pid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">close</span><span class="p">(</span><span class="n">child_ready_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">close</span><span class="p">(</span><span class="n">go_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">fcntl</span><span class="p">(</span><span class="n">go_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="n">FD_CLOEXEC</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Do a dummy execvp to get the PLT entry resolved,</span>
<span class="cm">			 * so we avoid the resolver overhead on the real</span>
<span class="cm">			 * execvp call.</span>
<span class="cm">			 */</span>
			<span class="n">execvp</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">argv</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Tell the parent we&#39;re ready to go</span>
<span class="cm">			 */</span>
			<span class="n">close</span><span class="p">(</span><span class="n">child_ready_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Wait until the parent tells us to go.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">go_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">perror</span><span class="p">(</span><span class="s">&quot;unable to read pipe&quot;</span><span class="p">);</span>

			<span class="n">execvp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">argv</span><span class="p">);</span>

			<span class="n">perror</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">perf_target__none</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">))</span>
			<span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">threads</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_pid</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait for the child to be ready to exec.</span>
<span class="cm">		 */</span>
		<span class="n">close</span><span class="p">(</span><span class="n">child_ready_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">go_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">child_ready_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;unable to read pipe&quot;</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">child_ready_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">create_perf_stat_counter</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * PPC returns ENXIO for HW counters until 2.6.37</span>
<span class="cm">			 * (behavior changed with commit b0a873e).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINVAL</span> <span class="o">||</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">ENOSYS</span> <span class="o">||</span>
			    <span class="n">errno</span> <span class="o">==</span> <span class="n">ENOENT</span> <span class="o">||</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">EOPNOTSUPP</span> <span class="o">||</span>
			    <span class="n">errno</span> <span class="o">==</span> <span class="n">ENXIO</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
					<span class="n">ui__warning</span><span class="p">(</span><span class="s">&quot;%s event is not supported by the kernel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">event_name</span><span class="p">(</span><span class="n">counter</span><span class="p">));</span>
				<span class="n">counter</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EPERM</span> <span class="o">||</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">EACCES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">error</span><span class="p">(</span><span class="s">&quot;You may not have permission to collect %sstats.</span><span class="se">\n</span><span class="s">&quot;</span>
				      <span class="s">&quot;</span><span class="se">\t</span><span class="s"> Consider tweaking&quot;</span>
				      <span class="s">&quot; /proc/sys/kernel/perf_event_paranoid or running as root.&quot;</span><span class="p">,</span>
				      <span class="n">target</span><span class="p">.</span><span class="n">system_wide</span> <span class="o">?</span> <span class="s">&quot;system-wide &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">error</span><span class="p">(</span><span class="s">&quot;open_counter returned with %d (%s). &quot;</span>
				      <span class="s">&quot;/bin/dmesg may provide additional information.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">errno</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">kill</span><span class="p">(</span><span class="n">child_pid</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Not all events could be opened.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">counter</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evlist__set_filters</span><span class="p">(</span><span class="n">evsel_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span><span class="p">(</span><span class="s">&quot;failed to set filter with %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">,</span>
			<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable counters and exec the command:</span>
<span class="cm">	 */</span>
	<span class="n">t0</span> <span class="o">=</span> <span class="n">rdclock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">forks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close</span><span class="p">(</span><span class="n">go_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="n">psignal</span><span class="p">(</span><span class="n">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">t1</span> <span class="o">=</span> <span class="n">rdclock</span><span class="p">();</span>

	<span class="n">update_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walltime_nsecs_stats</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_aggr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_counter</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
			<span class="n">perf_evsel__close_fd</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_counter_aggr</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
			<span class="n">perf_evsel__close_fd</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span>
					     <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">threads</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_noise_pct</span><span class="p">(</span><span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">pct</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">avg</span><span class="p">)</span>
		<span class="n">pct</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">total</span><span class="o">/</span><span class="n">avg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csv_output</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;%s%.2f%%&quot;</span><span class="p">,</span> <span class="n">csv_sep</span><span class="p">,</span> <span class="n">pct</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pct</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;  ( +-%6.2f%% )&quot;</span><span class="p">,</span> <span class="n">pct</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_noise</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_stat</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">run_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">print_noise_pct</span><span class="p">(</span><span class="n">stddev_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">res_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">avg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nsec_printout</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">msecs</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cpustr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">csv_output</span> <span class="o">?</span> <span class="s">&quot;%s%.6f%s%s&quot;</span> <span class="o">:</span> <span class="s">&quot;%s%18.6f%s%-25s&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_aggr</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">cpustr</span><span class="p">,</span> <span class="s">&quot;CPU%*d%s&quot;</span><span class="p">,</span>
			<span class="n">csv_output</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span>
			<span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span> <span class="n">csv_sep</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">cpustr</span><span class="p">,</span> <span class="n">msecs</span><span class="p">,</span> <span class="n">csv_sep</span><span class="p">,</span> <span class="n">event_name</span><span class="p">(</span><span class="n">evsel</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">cgrp</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">csv_sep</span><span class="p">,</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">cgrp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csv_output</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">SOFTWARE</span><span class="p">,</span> <span class="n">SW_TASK_CLOCK</span><span class="p">))</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; # %8.3f CPUs utilized          &quot;</span><span class="p">,</span>
			<span class="n">avg</span> <span class="o">/</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walltime_nsecs_stats</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;                                   &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* used for get_ratio_color() */</span>
<span class="k">enum</span> <span class="n">grc_type</span> <span class="p">{</span>
	<span class="n">GRC_STALLED_CYCLES_FE</span><span class="p">,</span>
	<span class="n">GRC_STALLED_CYCLES_BE</span><span class="p">,</span>
	<span class="n">GRC_CACHE_MISSES</span><span class="p">,</span>
	<span class="n">GRC_MAX_NR</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_ratio_color</span><span class="p">(</span><span class="k">enum</span> <span class="n">grc_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">double</span> <span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">double</span> <span class="n">grc_table</span><span class="p">[</span><span class="n">GRC_MAX_NR</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">GRC_STALLED_CYCLES_FE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">10.0</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">GRC_STALLED_CYCLES_BE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">20.0</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">GRC_CACHE_MISSES</span><span class="p">]</span> 	<span class="o">=</span> <span class="p">{</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">5.0</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span> <span class="o">=</span> <span class="n">PERF_COLOR_NORMAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="n">grc_table</span><span class="p">[</span><span class="n">type</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">PERF_COLOR_RED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="n">grc_table</span><span class="p">[</span><span class="n">type</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">PERF_COLOR_MAGENTA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="n">grc_table</span><span class="p">[</span><span class="n">type</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">PERF_COLOR_YELLOW</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_stalled_cycles_frontend</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_cycles_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>

	<span class="n">color</span> <span class="o">=</span> <span class="n">get_ratio_color</span><span class="p">(</span><span class="n">GRC_STALLED_CYCLES_FE</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; #  &quot;</span><span class="p">);</span>
	<span class="n">color_fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot;%6.2f%%&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; frontend cycles idle   &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_stalled_cycles_backend</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_cycles_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>

	<span class="n">color</span> <span class="o">=</span> <span class="n">get_ratio_color</span><span class="p">(</span><span class="n">GRC_STALLED_CYCLES_BE</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; #  &quot;</span><span class="p">);</span>
	<span class="n">color_fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot;%6.2f%%&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; backend  cycles idle   &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_branch_misses</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_branches_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>

	<span class="n">color</span> <span class="o">=</span> <span class="n">get_ratio_color</span><span class="p">(</span><span class="n">GRC_CACHE_MISSES</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; #  &quot;</span><span class="p">);</span>
	<span class="n">color_fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot;%6.2f%%&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; of all branches        &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_l1_dcache_misses</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_l1_dcache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>

	<span class="n">color</span> <span class="o">=</span> <span class="n">get_ratio_color</span><span class="p">(</span><span class="n">GRC_CACHE_MISSES</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; #  &quot;</span><span class="p">);</span>
	<span class="n">color_fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot;%6.2f%%&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; of all L1-dcache hits  &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_l1_icache_misses</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_l1_icache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>

	<span class="n">color</span> <span class="o">=</span> <span class="n">get_ratio_color</span><span class="p">(</span><span class="n">GRC_CACHE_MISSES</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; #  &quot;</span><span class="p">);</span>
	<span class="n">color_fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot;%6.2f%%&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; of all L1-icache hits  &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_dtlb_cache_misses</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_dtlb_cache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>

	<span class="n">color</span> <span class="o">=</span> <span class="n">get_ratio_color</span><span class="p">(</span><span class="n">GRC_CACHE_MISSES</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; #  &quot;</span><span class="p">);</span>
	<span class="n">color_fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot;%6.2f%%&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; of all dTLB cache hits &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_itlb_cache_misses</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_itlb_cache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>

	<span class="n">color</span> <span class="o">=</span> <span class="n">get_ratio_color</span><span class="p">(</span><span class="n">GRC_CACHE_MISSES</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; #  &quot;</span><span class="p">);</span>
	<span class="n">color_fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot;%6.2f%%&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; of all iTLB cache hits &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_ll_cache_misses</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_ll_cache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>

	<span class="n">color</span> <span class="o">=</span> <span class="n">get_ratio_color</span><span class="p">(</span><span class="n">GRC_CACHE_MISSES</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; #  &quot;</span><span class="p">);</span>
	<span class="n">color_fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s">&quot;%6.2f%%&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; of all LL-cache hits   &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">abs_printout</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">evsel</span><span class="p">,</span> <span class="kt">double</span> <span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">double</span> <span class="n">total</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cpustr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csv_output</span><span class="p">)</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;%s%.0f%s%s&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">big_num</span><span class="p">)</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;%s%&#39;18.0f%s%-25s&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;%s%18.0f%s%-25s&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_aggr</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">cpustr</span><span class="p">,</span> <span class="s">&quot;CPU%*d%s&quot;</span><span class="p">,</span>
			<span class="n">csv_output</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span>
			<span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span> <span class="n">csv_sep</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">cpustr</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">csv_sep</span><span class="p">,</span> <span class="n">event_name</span><span class="p">(</span><span class="n">evsel</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">cgrp</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">csv_sep</span><span class="p">,</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">cgrp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csv_output</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_INSTRUCTIONS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_cycles_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
			<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span><span class="p">;</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; #   %5.2f  insns per cycle        &quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

		<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_stalled_cycles_front_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>
		<span class="n">total</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_stalled_cycles_back_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&amp;&amp;</span> <span class="n">avg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ratio</span> <span class="o">=</span> <span class="n">total</span> <span class="o">/</span> <span class="n">avg</span><span class="p">;</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">                                             #   %5.2f  stalled cycles per insn&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_BRANCH_MISSES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">runtime_branches_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_branch_misses</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_HW_CACHE</span> <span class="o">&amp;&amp;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">==</span>  <span class="p">(</span> <span class="n">PERF_COUNT_HW_CACHE_L1D</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">runtime_l1_dcache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_l1_dcache_misses</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_HW_CACHE</span> <span class="o">&amp;&amp;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">==</span>  <span class="p">(</span> <span class="n">PERF_COUNT_HW_CACHE_L1I</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">runtime_l1_icache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_l1_icache_misses</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_HW_CACHE</span> <span class="o">&amp;&amp;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">==</span>  <span class="p">(</span> <span class="n">PERF_COUNT_HW_CACHE_DTLB</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">runtime_dtlb_cache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_dtlb_cache_misses</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_HW_CACHE</span> <span class="o">&amp;&amp;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">==</span>  <span class="p">(</span> <span class="n">PERF_COUNT_HW_CACHE_ITLB</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">runtime_itlb_cache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_itlb_cache_misses</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_HW_CACHE</span> <span class="o">&amp;&amp;</span>
		<span class="n">evsel</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">==</span>  <span class="p">(</span> <span class="n">PERF_COUNT_HW_CACHE_LL</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_OP_READ</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MISS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">runtime_ll_cache_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_ll_cache_misses</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_CACHE_MISSES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">runtime_cacherefs_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_cacherefs_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
			<span class="n">ratio</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">total</span><span class="p">;</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; # %8.3f %% of all cache refs    &quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_STALLED_CYCLES_FRONTEND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">print_stalled_cycles_frontend</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_STALLED_CYCLES_BACKEND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">print_stalled_cycles_backend</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">evsel</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__match</span><span class="p">(</span><span class="n">evsel</span><span class="p">,</span> <span class="n">HARDWARE</span><span class="p">,</span> <span class="n">HW_CPU_CYCLES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_nsecs_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
			<span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span><span class="p">;</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; # %8.3f GHz                    &quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime_nsecs_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">unit</span> <span class="o">=</span> <span class="sc">&#39;M&#39;</span><span class="p">;</span>

		<span class="n">total</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime_nsecs_stats</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total</span><span class="p">)</span>
			<span class="n">ratio</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">avg</span> <span class="o">/</span> <span class="n">total</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ratio</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">unit</span> <span class="o">=</span> <span class="sc">&#39;K&#39;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; # %8.3f %c/sec                  &quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;                                   &quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print out the results of a single counter:</span>
<span class="cm"> * aggregated counts in system-wide mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_counter_aggr</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">counter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_stat</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">res_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="kt">int</span> <span class="n">scaled</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">scaled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scaled</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;%*s%s%*s&quot;</span><span class="p">,</span>
			<span class="n">csv_output</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
			<span class="n">counter</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">?</span> <span class="n">CNTR_NOT_COUNTED</span> <span class="o">:</span> <span class="n">CNTR_NOT_SUPPORTED</span><span class="p">,</span>
			<span class="n">csv_sep</span><span class="p">,</span>
			<span class="n">csv_output</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">24</span><span class="p">,</span>
			<span class="n">event_name</span><span class="p">(</span><span class="n">counter</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">cgrp</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">csv_sep</span><span class="p">,</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">cgrp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nsec_counter</span><span class="p">(</span><span class="n">counter</span><span class="p">))</span>
		<span class="n">nsec_printout</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">abs_printout</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>

	<span class="n">print_noise</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csv_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scaled</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">double</span> <span class="n">avg_enabled</span><span class="p">,</span> <span class="n">avg_running</span><span class="p">;</span>

		<span class="n">avg_enabled</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">res_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">avg_running</span> <span class="o">=</span> <span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">res_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; [%5.2f%%]&quot;</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">avg_running</span> <span class="o">/</span> <span class="n">avg_enabled</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print out the results of a single counter:</span>
<span class="cm"> * does not use aggregated count in system-wide</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">counter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ena</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">cpu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">val</span><span class="p">;</span>
		<span class="n">ena</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">ena</span><span class="p">;</span>
		<span class="n">run</span> <span class="o">=</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">run</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">run</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ena</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;CPU%*d%s%*s%s%*s&quot;</span><span class="p">,</span>
				<span class="n">csv_output</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span>
				<span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span> <span class="n">csv_sep</span><span class="p">,</span>
				<span class="n">csv_output</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
				<span class="n">counter</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">?</span> <span class="n">CNTR_NOT_COUNTED</span> <span class="o">:</span> <span class="n">CNTR_NOT_SUPPORTED</span><span class="p">,</span>
				<span class="n">csv_sep</span><span class="p">,</span>
				<span class="n">csv_output</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">24</span><span class="p">,</span>
				<span class="n">event_name</span><span class="p">(</span><span class="n">counter</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">cgrp</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span>
					<span class="n">csv_sep</span><span class="p">,</span> <span class="n">counter</span><span class="o">-&gt;</span><span class="n">cgrp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nsec_counter</span><span class="p">(</span><span class="n">counter</span><span class="p">))</span>
			<span class="n">nsec_printout</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">abs_printout</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csv_output</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_noise</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">run</span> <span class="o">!=</span> <span class="n">ena</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;  (%.2f%%)&quot;</span><span class="p">,</span>
					<span class="mf">100.0</span> <span class="o">*</span> <span class="n">run</span> <span class="o">/</span> <span class="n">ena</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_stat</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csv_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; Performance counter stats for &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_target__has_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&#39;</span><span class="s">%s&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;process id </span><span class="se">\&#39;</span><span class="s">%s&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;thread id </span><span class="se">\&#39;</span><span class="s">%s&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&#39;</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">run_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; (%d runs)&quot;</span><span class="p">,</span> <span class="n">run_count</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_aggr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
			<span class="n">print_counter</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
			<span class="n">print_counter_aggr</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csv_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">null_run</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot; %17.9f seconds time elapsed&quot;</span><span class="p">,</span>
				<span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walltime_nsecs_stats</span><span class="p">)</span><span class="o">/</span><span class="mf">1e9</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">run_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;                                        &quot;</span><span class="p">);</span>
			<span class="n">print_noise_pct</span><span class="p">(</span><span class="n">stddev_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walltime_nsecs_stats</span><span class="p">),</span>
					<span class="n">avg_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walltime_nsecs_stats</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">signr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">skip_signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">child_pid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">signr</span> <span class="o">=</span> <span class="n">signo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sig_atexit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">kill</span><span class="p">(</span><span class="n">child_pid</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">signal</span><span class="p">(</span><span class="n">signr</span><span class="p">,</span> <span class="n">SIG_DFL</span><span class="p">);</span>
	<span class="n">kill</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">signr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">stat_usage</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;perf stat [&lt;options&gt;] [&lt;command&gt;]&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stat__set_big_num</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span> <span class="n">__used</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="n">__used</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">big_num_opt</span> <span class="o">=</span> <span class="n">unset</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">append_file</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">OPT_CALLBACK</span><span class="p">(</span><span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="s">&quot;event&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="p">,</span> <span class="s">&quot;event&quot;</span><span class="p">,</span>
		     <span class="s">&quot;event selector. use &#39;perf list&#39; to list available events&quot;</span><span class="p">,</span>
		     <span class="n">parse_events_option</span><span class="p">),</span>
	<span class="n">OPT_CALLBACK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;filter&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="p">,</span> <span class="s">&quot;filter&quot;</span><span class="p">,</span>
		     <span class="s">&quot;event filter&quot;</span><span class="p">,</span> <span class="n">parse_filter</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;i&#39;</span><span class="p">,</span> <span class="s">&quot;no-inherit&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_inherit</span><span class="p">,</span>
		    <span class="s">&quot;child tasks do not inherit counters&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;p&#39;</span><span class="p">,</span> <span class="s">&quot;pid&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="s">&quot;pid&quot;</span><span class="p">,</span>
		   <span class="s">&quot;stat events on existing process id&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="s">&quot;tid&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span> <span class="s">&quot;tid&quot;</span><span class="p">,</span>
		   <span class="s">&quot;stat events on existing thread id&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="s">&quot;all-cpus&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="p">.</span><span class="n">system_wide</span><span class="p">,</span>
		    <span class="s">&quot;system-wide collection from all CPUs&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="s">&quot;group&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="p">,</span>
		    <span class="s">&quot;put the counters into a counter group&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;c&#39;</span><span class="p">,</span> <span class="s">&quot;scale&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scale</span><span class="p">,</span>
		    <span class="s">&quot;scale/normalize counters&quot;</span><span class="p">),</span>
	<span class="n">OPT_INCR</span><span class="p">(</span><span class="sc">&#39;v&#39;</span><span class="p">,</span> <span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verbose</span><span class="p">,</span>
		    <span class="s">&quot;be more verbose (show counter open errors, etc)&quot;</span><span class="p">),</span>
	<span class="n">OPT_INTEGER</span><span class="p">(</span><span class="sc">&#39;r&#39;</span><span class="p">,</span> <span class="s">&quot;repeat&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">run_count</span><span class="p">,</span>
		    <span class="s">&quot;repeat command and print average + stddev (max: 100)&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;n&#39;</span><span class="p">,</span> <span class="s">&quot;null&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">null_run</span><span class="p">,</span>
		    <span class="s">&quot;null run - dont start any counters&quot;</span><span class="p">),</span>
	<span class="n">OPT_INCR</span><span class="p">(</span><span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="s">&quot;detailed&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">detailed_run</span><span class="p">,</span>
		    <span class="s">&quot;detailed run - start a lot of events&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="s">&quot;sync&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sync_run</span><span class="p">,</span>
		    <span class="s">&quot;call sync() before starting a run&quot;</span><span class="p">),</span>
	<span class="n">OPT_CALLBACK_NOOPT</span><span class="p">(</span><span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="s">&quot;big-num&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> 
			   <span class="s">&quot;print large numbers with thousands</span><span class="se">\&#39;</span><span class="s"> separators&quot;</span><span class="p">,</span>
			   <span class="n">stat__set_big_num</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="p">.</span><span class="n">cpu_list</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">,</span>
		    <span class="s">&quot;list of cpus to monitor in system-wide&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="s">&quot;no-aggr&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_aggr</span><span class="p">,</span>
		    <span class="s">&quot;disable CPU count aggregation&quot;</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;x&#39;</span><span class="p">,</span> <span class="s">&quot;field-separator&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csv_sep</span><span class="p">,</span> <span class="s">&quot;separator&quot;</span><span class="p">,</span>
		   <span class="s">&quot;print counts with custom separator&quot;</span><span class="p">),</span>
	<span class="n">OPT_CALLBACK</span><span class="p">(</span><span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="s">&quot;cgroup&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
		     <span class="s">&quot;monitor event in cgroup name only&quot;</span><span class="p">,</span>
		     <span class="n">parse_cgroups</span><span class="p">),</span>
	<span class="n">OPT_STRING</span><span class="p">(</span><span class="sc">&#39;o&#39;</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output_name</span><span class="p">,</span> <span class="s">&quot;file&quot;</span><span class="p">,</span>
		    <span class="s">&quot;output file name&quot;</span><span class="p">),</span>
	<span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;append&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">append_file</span><span class="p">,</span> <span class="s">&quot;append to the output file&quot;</span><span class="p">),</span>
	<span class="n">OPT_INTEGER</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;log-fd&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output_fd</span><span class="p">,</span>
		    <span class="s">&quot;log output to fd, instead of stderr&quot;</span><span class="p">),</span>
	<span class="n">OPT_END</span><span class="p">()</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Add default attributes, if there were no attributes specified or</span>
<span class="cm"> * if -d/--detailed, -d -d or -d -d -d is used:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_default_attributes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set attrs if no event is selected and !null_run: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">null_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">nr_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_evlist__add_default_attrs</span><span class="p">(</span><span class="n">evsel_list</span><span class="p">,</span> <span class="n">default_attrs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Detailed events get appended to the event list: */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">detailed_run</span> <span class="o">&lt;</span>  <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Append detailed run extra attributes: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evlist__add_default_attrs</span><span class="p">(</span><span class="n">evsel_list</span><span class="p">,</span> <span class="n">detailed_attrs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">detailed_run</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Append very detailed run extra attributes: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evlist__add_default_attrs</span><span class="p">(</span><span class="n">evsel_list</span><span class="p">,</span> <span class="n">very_detailed_attrs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">detailed_run</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Append very, very detailed run extra attributes: */</span>
	<span class="k">return</span> <span class="n">perf_evlist__add_default_attrs</span><span class="p">(</span><span class="n">evsel_list</span><span class="p">,</span> <span class="n">very_very_detailed_attrs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cmd_stat</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span> <span class="n">__used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_evsel</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">setlocale</span><span class="p">(</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">evsel_list</span> <span class="o">=</span> <span class="n">perf_evlist__new</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evsel_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">argc</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">stat_usage</span><span class="p">,</span>
		<span class="n">PARSE_OPT_STOP_AT_NON_OPTION</span><span class="p">);</span>

	<span class="n">output</span> <span class="o">=</span> <span class="n">stderr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">output_name</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">))</span>
		<span class="n">output</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="o">&amp;&amp;</span> <span class="n">output_fd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;cannot use both --output and --log-fd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">stat_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">output_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;argument to --log-fd must be a &gt; 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">stat_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timespec</span> <span class="n">tm</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">append_file</span> <span class="o">?</span> <span class="s">&quot;a&quot;</span> <span class="o">:</span> <span class="s">&quot;w&quot;</span><span class="p">;</span>

		<span class="n">output</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">output_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;failed to create output file&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;# started on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">output_fd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">append_file</span> <span class="o">?</span> <span class="s">&quot;a&quot;</span> <span class="o">:</span> <span class="s">&quot;w&quot;</span><span class="p">;</span>
		<span class="n">output</span> <span class="o">=</span> <span class="n">fdopen</span><span class="p">(</span><span class="n">output_fd</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed opening logfd&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csv_sep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csv_output</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">csv_sep</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">t&quot;</span><span class="p">))</span>
			<span class="n">csv_sep</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">csv_sep</span> <span class="o">=</span> <span class="n">DEFAULT_SEPARATOR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * let the spreadsheet do the pretty-printing</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csv_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* User explicitly passed -B? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">big_num_opt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;-B option not supported with -x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">usage_with_options</span><span class="p">(</span><span class="n">stat_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* Nope, so disable big number formatting */</span>
			<span class="n">big_num</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">big_num_opt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* User passed --no-big-num */</span>
		<span class="n">big_num</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">perf_target__has_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">))</span>
		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">stat_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">run_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">stat_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>

	<span class="cm">/* no_aggr, cgroup are for system-wide only */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">no_aggr</span> <span class="o">||</span> <span class="n">nr_cgroups</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">perf_target__has_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;both cgroup and no-aggregation &quot;</span>
			<span class="s">&quot;modes only available in system-wide mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">stat_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_default_attributes</span><span class="p">())</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">perf_target__validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_evlist__create_maps</span><span class="p">(</span><span class="n">evsel_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_target__has_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Problems finding threads of monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_target__has_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="p">))</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;failed to parse CPUs map&quot;</span><span class="p">);</span>

		<span class="n">usage_with_options</span><span class="p">(</span><span class="n">stat_usage</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_evsel__alloc_stat_priv</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">perf_evsel__alloc_counts</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_fd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We dont want to block the signals - that would cause</span>
<span class="cm">	 * child tasks to inherit that and Ctrl-C would not work.</span>
<span class="cm">	 * What we want is for Ctrl-C to work in the exec()-ed</span>
<span class="cm">	 * task, but being ignored by perf stat itself:</span>
<span class="cm">	 */</span>
	<span class="n">atexit</span><span class="p">(</span><span class="n">sig_atexit</span><span class="p">);</span>
	<span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span>  <span class="n">skip_signal</span><span class="p">);</span>
	<span class="n">signal</span><span class="p">(</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">skip_signal</span><span class="p">);</span>
	<span class="n">signal</span><span class="p">(</span><span class="n">SIGABRT</span><span class="p">,</span> <span class="n">skip_signal</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">run_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">run_idx</span> <span class="o">&lt;</span> <span class="n">run_count</span><span class="p">;</span> <span class="n">run_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">run_count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">verbose</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;[ perf stat: executing run #%d ... ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">run_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sync_run</span><span class="p">)</span>
			<span class="n">sync</span><span class="p">();</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">run_perf_stat</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">print_stat</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="nl">out_free_fd:</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evsel_list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">perf_evsel__free_stat_priv</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">perf_evlist__delete_maps</span><span class="p">(</span><span class="n">evsel_list</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">perf_evlist__delete</span><span class="p">(</span><span class="n">evsel_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
