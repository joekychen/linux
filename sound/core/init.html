<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › core › init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Initialization routines</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>

<span class="cm">/* monitor files for graceful shutdown (hotplug) */</span>
<span class="k">struct</span> <span class="n">snd_monitor_file</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">disconnected_f_op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">shutdown_list</span><span class="p">;</span>	<span class="cm">/* still need to shutdown */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>	<span class="cm">/* link of monitor files */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">shutdown_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">shutdown_files</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">snd_shutdown_f_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snd_cards_lock</span><span class="p">;</span>	<span class="cm">/* locked for registering/using */</span>
<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">snd_cards</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_cards</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">snd_card_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slots</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">slots</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">slots</span><span class="p">,</span> <span class="s">&quot;Module names assigned to the slots.&quot;</span><span class="p">);</span>

<span class="cm">/* return non-zero if the given index is reserved for the given</span>
<span class="cm"> * module via slots option</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">module_slot_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef MODULE</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span> <span class="o">*</span><span class="n">s2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">module</span> <span class="o">||</span> <span class="o">!</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">||</span> <span class="o">!</span><span class="n">slots</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s1</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">s2</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s2</span> <span class="o">==</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* negative match */</span>
		<span class="n">s2</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* compare module name strings</span>
<span class="cm">	 * hyphens are handled as equivalent with underscore</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c1</span> <span class="o">=</span> <span class="o">*</span><span class="n">s1</span><span class="o">++</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">c2</span> <span class="o">=</span> <span class="o">*</span><span class="n">s2</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c1</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
			<span class="n">c1</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c2</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
			<span class="n">c2</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c1</span> <span class="o">!=</span> <span class="n">c2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">!</span><span class="n">match</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
	<span class="k">return</span> <span class="n">match</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SND_MIXER_OSS) || defined(CONFIG_SND_MIXER_OSS_MODULE)</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">snd_mixer_oss_notify_callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">free_flag</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_mixer_oss_notify_callback</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_card_id_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">init_info_for_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_info_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;unable to create card info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">proc_root</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;unable to create card entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_card_id_read</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">proc_id</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_PROC_FS */</span><span class="cp"></span>
<span class="cp">#define init_info_for_card(card)</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> *  snd_card_create - create and initialize a soundcard structure</span>
<span class="cm"> *  @idx: card index (address) [0 ... (SNDRV_CARDS-1)]</span>
<span class="cm"> *  @xid: card identification (ASCII string)</span>
<span class="cm"> *  @module: top level module for locking</span>
<span class="cm"> *  @extra_size: allocate this extra size after the main soundcard structure</span>
<span class="cm"> *  @card_ret: the pointer to store the created card instance</span>
<span class="cm"> *</span>
<span class="cm"> *  Creates and initializes a soundcard structure.</span>
<span class="cm"> *</span>
<span class="cm"> *  The function allocates snd_card instance via kzalloc with the given</span>
<span class="cm"> *  space for the driver to use freely.  The allocated struct is stored</span>
<span class="cm"> *  in the given card_ret pointer.</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns zero if successful or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_card_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xid</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span> <span class="kt">int</span> <span class="n">extra_size</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">**</span><span class="n">card_ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">idx2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">card_ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">card_ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">extra_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">extra_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">card</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xid</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx2</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">idx2</span><span class="o">++</span><span class="p">)</span>
			<span class="cm">/* idx == -1 == 0xffff means: take any free slot */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">snd_cards_lock</span> <span class="o">&amp;</span> <span class="n">idx</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">idx2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">module_slot_match</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">idx2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">idx</span> <span class="o">=</span> <span class="n">idx2</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx2</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">idx2</span><span class="o">++</span><span class="p">)</span>
			<span class="cm">/* idx == -1 == 0xffff means: take any free slot */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">snd_cards_lock</span> <span class="o">&amp;</span> <span class="n">idx</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">idx2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slots</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">||</span> <span class="o">!*</span><span class="n">slots</span><span class="p">[</span><span class="n">idx2</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">idx</span> <span class="o">=</span> <span class="n">idx2</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">snd_ecards_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cards_lock</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* invalid */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot find the slot for index %d (range 0-%i), error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">idx</span><span class="p">,</span> <span class="n">snd_ecards_limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_cards_lock</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">;</span>		<span class="cm">/* lock it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">snd_ecards_limit</span><span class="p">)</span>
		<span class="n">snd_ecards_limit</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* increase the limit */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctl_files_rwlock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctl_files</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_list</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shutdown_sleep</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">power_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">power_sleep</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* the control interface cannot be accessed from the user space until */</span>
	<span class="cm">/* snd_cards_bitmask and snd_cards are set with snd_card_register */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_create</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to register control minors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_info_card_create</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to create card info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__error_ctl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">extra_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">card</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span><span class="p">);</span>
	<span class="o">*</span><span class="n">card_ret</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">__error_ctl:</span>
	<span class="n">snd_device_free_all</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_CMD_PRE</span><span class="p">);</span>
      <span class="nl">__error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
  	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_card_create</span><span class="p">);</span>

<span class="cm">/* return non-zero if a card is already locked */</span>
<span class="kt">int</span> <span class="nf">snd_card_locked</span><span class="p">(</span><span class="kt">int</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">locked</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="n">locked</span> <span class="o">=</span> <span class="n">snd_cards_lock</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">locked</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">loff_t</span> <span class="nf">snd_disconnect_llseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">orig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_disconnect_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_disconnect_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_disconnect_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_monitor_file</span> <span class="o">*</span><span class="n">df</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">_df</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shutdown_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">_df</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shutdown_files</span><span class="p">,</span> <span class="n">shutdown_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_df</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">==</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">df</span> <span class="o">=</span> <span class="n">_df</span><span class="p">;</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">shutdown_list</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shutdown_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">FASYNC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">disconnected_f_op</span><span class="o">-&gt;</span><span class="n">fasync</span><span class="p">)</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">disconnected_f_op</span><span class="o">-&gt;</span><span class="n">fasync</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">disconnected_f_op</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s(%p, %p) failed!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_disconnect_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">POLLERR</span> <span class="o">|</span> <span class="n">POLLNVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">snd_disconnect_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_disconnect_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_disconnect_fasync</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">snd_shutdown_f_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> 	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">snd_disconnect_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> 	<span class="n">snd_disconnect_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">snd_disconnect_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">snd_disconnect_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span>		<span class="n">snd_disconnect_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">snd_disconnect_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">snd_disconnect_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>		<span class="n">snd_disconnect_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fasync</span> <span class="o">=</span>	<span class="n">snd_disconnect_fasync</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *  snd_card_disconnect - disconnect all APIs from the file-operations (user space)</span>
<span class="cm"> *  @card: soundcard structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Disconnects all APIs from the file-operations (user space).</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns zero, otherwise a negative error code.</span>
<span class="cm"> *</span>
<span class="cm"> *  Note: The current implementation replaces all active file-&gt;f_op with special</span>
<span class="cm"> *        dummy file operations (they do nothing except release).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_card_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_monitor_file</span> <span class="o">*</span><span class="n">mfile</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">shutdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>

	<span class="cm">/* phase 1: disable fops (user space) operations for ALSA API */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="n">snd_cards</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">snd_cards_lock</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	
	<span class="cm">/* phase 2: replace file-&gt;f_op with special dummy operations */</span>
	
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* it&#39;s critical part, use endless loop */</span>
		<span class="cm">/* we have no room to fail */</span>
		<span class="n">mfile</span><span class="o">-&gt;</span><span class="n">disconnected_f_op</span> <span class="o">=</span> <span class="n">mfile</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shutdown_lock</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mfile</span><span class="o">-&gt;</span><span class="n">shutdown_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shutdown_files</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shutdown_lock</span><span class="p">);</span>

		<span class="n">mfile</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_shutdown_f_ops</span><span class="p">;</span>
		<span class="n">fops_get</span><span class="p">(</span><span class="n">mfile</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>	

	<span class="cm">/* phase 3: notify all connected devices about disconnection */</span>
	<span class="cm">/* at this point, they cannot respond to any calls except release() */</span>

<span class="cp">#if defined(CONFIG_SND_MIXER_OSS) || defined(CONFIG_SND_MIXER_OSS_MODULE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_mixer_oss_notify_callback</span><span class="p">)</span>
		<span class="n">snd_mixer_oss_notify_callback</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SND_MIXER_OSS_NOTIFY_DISCONNECT</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* notify all devices that we are disconnected */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_disconnect_all</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;not all devices for card %i can be disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">snd_info_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">power_sleep</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_card_disconnect</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *  snd_card_free - frees given soundcard structure</span>
<span class="cm"> *  @card: soundcard structure</span>
<span class="cm"> *</span>
<span class="cm"> *  This function releases the soundcard structure and the all assigned</span>
<span class="cm"> *  devices automatically.  That is, you don&#39;t have to release the devices</span>
<span class="cm"> *  by yourself.</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns zero. Frees all associated devices and frees the control</span>
<span class="cm"> *  interface associated to given soundcard.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_card_do_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_SND_MIXER_OSS) || defined(CONFIG_SND_MIXER_OSS_MODULE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_mixer_oss_notify_callback</span><span class="p">)</span>
		<span class="n">snd_mixer_oss_notify_callback</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SND_MIXER_OSS_NOTIFY_FREE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_device_free_all</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_CMD_PRE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to free all devices (pre)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Fatal, but this situation should never occur */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_device_free_all</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_CMD_NORMAL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to free all devices (normal)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Fatal, but this situation should never occur */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_device_free_all</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_CMD_POST</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to free all devices (post)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Fatal, but this situation should never occur */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">proc_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;unable to free card info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Not fatal error */</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_card_free_when_closed</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">free_now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_list</span><span class="p">))</span>
		<span class="n">free_now</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">free_on_last_close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_now</span><span class="p">)</span>
		<span class="n">snd_card_do_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_card_free_when_closed</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">snd_card_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* wait, until all devices are ready for the free operation */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shutdown_sleep</span><span class="p">,</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_list</span><span class="p">));</span>
	<span class="n">snd_card_do_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_card_free</span><span class="p">);</span>

<span class="cm">/* retrieve the last word of shortname or longname */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">retrieve_id_from_card_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spos</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isalnum</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			<span class="n">spos</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">name</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">spos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return true if the given id string doesn&#39;t conflict any other card ids */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">card_id_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_info_check_reserved_words</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">snd_ecards_limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">snd_cards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">card</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">snd_cards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* copy to card-&gt;id only with valid letters from nid */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_valid_id_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">nid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isalnum</span><span class="p">(</span><span class="o">*</span><span class="n">nid</span><span class="p">))</span>
		<span class="n">nid</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">nid</span><span class="p">))</span>
		<span class="o">*</span><span class="n">id</span><span class="o">++</span> <span class="o">=</span> <span class="n">isalpha</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">src</span> <span class="o">:</span> <span class="sc">&#39;D&#39;</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">nid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">id</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="o">*</span><span class="n">nid</span><span class="p">))</span>
			<span class="o">*</span><span class="n">id</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">nid</span><span class="p">;</span>
		<span class="n">nid</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set card-&gt;id from the given string</span>
<span class="cm"> * If the string conflicts with other ids, add a suffix to make it unique.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_card_set_id_no_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">loops</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">with_suffix</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_default</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	
	<span class="n">copy_valid_id_string</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

 <span class="nl">again:</span>
	<span class="cm">/* use &quot;Default&quot; for obviously invalid strings</span>
<span class="cm">	 * (&quot;card&quot; conflicts with proc directories)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">id</span> <span class="o">||</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;card&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Default&quot;</span><span class="p">);</span>
		<span class="n">is_default</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">with_suffix</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loops</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">loops</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card_id_ok</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* OK */</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">with_suffix</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* add the &quot;_X&quot; suffix */</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">spos</span> <span class="o">=</span> <span class="n">id</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">spos</span> <span class="o">=</span> <span class="n">id</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">spos</span><span class="p">,</span> <span class="s">&quot;_1&quot;</span><span class="p">);</span>
			<span class="n">with_suffix</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* modify the existing suffix */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
				<span class="n">id</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">id</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* fallback to the default id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_default</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* last resort... */</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to set card id (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">proc_root</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">proc_root</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  snd_card_set_id - set card identification name</span>
<span class="cm"> *  @card: soundcard structure</span>
<span class="cm"> *  @nid: new identification string</span>
<span class="cm"> *</span>
<span class="cm"> *  This function sets the card identification and checks for name</span>
<span class="cm"> *  collisions.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_card_set_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check if user specified own card-&gt;id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="n">snd_card_set_id_no_lock</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_card_set_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">card_id_show_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span> <span class="o">?</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">:</span> <span class="s">&quot;(null)&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">card_id_store_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">buf1</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>
	<span class="kt">size_t</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">?</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">copy</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isalnum</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;_&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">copy</span><span class="p">);</span>
	<span class="n">buf1</span><span class="p">[</span><span class="n">copy</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card_id_ok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">buf1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">buf1</span><span class="p">);</span>
	<span class="n">snd_info_card_id_change</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">card_id_attrs</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">card_id_show_attr</span><span class="p">,</span> <span class="n">card_id_store_attr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">card_number_show_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span> <span class="o">?</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">card_number_attrs</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">card_number_show_attr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *  snd_card_register - register the soundcard</span>
<span class="cm"> *  @card: soundcard structure</span>
<span class="cm"> *</span>
<span class="cm"> *  This function registers all the devices assigned to the soundcard.</span>
<span class="cm"> *  Until calling this, the ALSA control interface is blocked from the</span>
<span class="cm"> *  external accesses.  Thus, you should call this function at the end</span>
<span class="cm"> *  of the initialization of the card.</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns zero otherwise a negative error code if the registration failed.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_card_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">sound_class</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">card</span><span class="p">,</span>
					       <span class="s">&quot;card%i&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span><span class="p">))</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_register_all</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_cards</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* already registered */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* make a unique id name from the given string */</span>
		<span class="kt">char</span> <span class="n">tmpid</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmpid</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
		<span class="n">snd_card_set_id_no_lock</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tmpid</span><span class="p">,</span> <span class="n">tmpid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* create an id from either shortname or longname */</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="o">*</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span> <span class="o">?</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span> <span class="o">:</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">;</span>
		<span class="n">snd_card_set_id_no_lock</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
					<span class="n">retrieve_id_from_card_name</span><span class="p">(</span><span class="n">src</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">snd_cards</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="n">init_info_for_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_SND_MIXER_OSS) || defined(CONFIG_SND_MIXER_OSS_MODULE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_mixer_oss_notify_callback</span><span class="p">)</span>
		<span class="n">snd_mixer_oss_notify_callback</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SND_MIXER_OSS_NOTIFY_REGISTER</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card_id_attrs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card_number_attrs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_card_register</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">snd_card_info_entry</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_card_info_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">card</span> <span class="o">=</span> <span class="n">snd_cards</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%2i [%-15s]: %s - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">idx</span><span class="p">,</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;                      %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--- no soundcards ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_OSSEMUL</span>

<span class="kt">void</span> <span class="nf">snd_card_info_read_oss</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">card</span> <span class="o">=</span> <span class="n">snd_cards</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--- no soundcards ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">snd_card_module_info_entry</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_card_module_info_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">card</span> <span class="o">=</span> <span class="n">snd_cards</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%2i %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">idx</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_card_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">snd_card_info_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_module_entry</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;cards&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_card_info_read</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_card_info_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

<span class="cp">#ifdef MODULE</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_module_entry</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;modules&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_card_module_info_read</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_card_module_info_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__exit</span> <span class="nf">snd_card_info_done</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">snd_card_info_entry</span><span class="p">);</span>
<span class="cp">#ifdef MODULE</span>
	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">snd_card_module_info_entry</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> *  snd_component_add - add a component string</span>
<span class="cm"> *  @card: soundcard structure</span>
<span class="cm"> *  @component: the component id string</span>
<span class="cm"> *</span>
<span class="cm"> *  This function adds the component id string to the supported list.</span>
<span class="cm"> *  The component can be referred from the alsa-lib.</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns zero otherwise a negative error code.</span>
<span class="cm"> */</span>
  
<span class="kt">int</span> <span class="nf">snd_component_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">component</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">component</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">components</span><span class="p">,</span> <span class="n">component</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span> <span class="n">ptr</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>	<span class="cm">/* already there */</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">components</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">components</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">components</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">components</span><span class="p">,</span> <span class="n">component</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_component_add</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *  snd_card_file_add - add the file to the file list of the card</span>
<span class="cm"> *  @card: soundcard structure</span>
<span class="cm"> *  @file: file pointer</span>
<span class="cm"> *</span>
<span class="cm"> *  This function adds the file to the file linked-list of the card.</span>
<span class="cm"> *  This linked-list is used to keep tracking the connection state,</span>
<span class="cm"> *  and to avoid the release of busy resources by hotplug.</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns zero or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_card_file_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_monitor_file</span> <span class="o">*</span><span class="n">mfile</span><span class="p">;</span>

	<span class="n">mfile</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mfile</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mfile</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">mfile</span><span class="o">-&gt;</span><span class="n">disconnected_f_op</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mfile</span><span class="o">-&gt;</span><span class="n">shutdown_list</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mfile</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mfile</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_card_file_add</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *  snd_card_file_remove - remove the file from the file list</span>
<span class="cm"> *  @card: soundcard structure</span>
<span class="cm"> *  @file: file pointer</span>
<span class="cm"> *</span>
<span class="cm"> *  This function removes the file formerly added to the card via</span>
<span class="cm"> *  snd_card_file_add() function.</span>
<span class="cm"> *  If all files are removed and snd_card_free_when_closed() was</span>
<span class="cm"> *  called beforehand, it processes the pending release of</span>
<span class="cm"> *  resources.</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns zero or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_card_file_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_monitor_file</span> <span class="o">*</span><span class="n">mfile</span><span class="p">,</span> <span class="o">*</span><span class="n">found</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mfile</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">==</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mfile</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shutdown_lock</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mfile</span><span class="o">-&gt;</span><span class="n">shutdown_list</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shutdown_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mfile</span><span class="o">-&gt;</span><span class="n">disconnected_f_op</span><span class="p">)</span>
				<span class="n">fops_put</span><span class="p">(</span><span class="n">mfile</span><span class="o">-&gt;</span><span class="n">disconnected_f_op</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">mfile</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_list</span><span class="p">))</span>
		<span class="n">last_close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">files_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shutdown_sleep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">free_on_last_close</span><span class="p">)</span>
			<span class="n">snd_card_do_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ALSA card file remove problem (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">found</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_card_file_remove</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/**</span>
<span class="cm"> *  snd_power_wait - wait until the power-state is changed.</span>
<span class="cm"> *  @card: soundcard structure</span>
<span class="cm"> *  @power_state: expected power state</span>
<span class="cm"> *</span>
<span class="cm"> *  Waits until the power-state is changed.</span>
<span class="cm"> *</span>
<span class="cm"> *  Note: the power lock must be active before call.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_power_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">power_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* fastpath */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_power_get_state</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">==</span> <span class="n">power_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">power_sleep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_power_get_state</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">==</span> <span class="n">power_state</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">snd_power_unlock</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">snd_power_lock</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">power_sleep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_power_wait</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
