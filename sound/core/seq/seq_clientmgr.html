<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › core › seq › seq_clientmgr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>seq_clientmgr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  ALSA sequencer Client Manager</span>
<span class="cm"> *  Copyright (c) 1998-2001 by Frank van de Pol &lt;fvdpol@coil.demon.nl&gt;</span>
<span class="cm"> *                             Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *                             Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/minors.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>

<span class="cp">#include &lt;sound/seq_kernel.h&gt;</span>
<span class="cp">#include &quot;seq_clientmgr.h&quot;</span>
<span class="cp">#include &quot;seq_memory.h&quot;</span>
<span class="cp">#include &quot;seq_queue.h&quot;</span>
<span class="cp">#include &quot;seq_timer.h&quot;</span>
<span class="cp">#include &quot;seq_info.h&quot;</span>
<span class="cp">#include &quot;seq_system.h&quot;</span>
<span class="cp">#include &lt;sound/seq_device.h&gt;</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/* Client Manager</span>

<span class="cm"> * this module handles the connections of userland and kernel clients</span>
<span class="cm"> * </span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * There are four ranges of client numbers (last two shared):</span>
<span class="cm"> * 0..15: global clients</span>
<span class="cm"> * 16..127: statically allocated client numbers for cards 0..27</span>
<span class="cm"> * 128..191: dynamically allocated client numbers for cards 28..31</span>
<span class="cm"> * 128..191: dynamically allocated client numbers for applications</span>
<span class="cm"> */</span>

<span class="cm">/* number of kernel non-card clients */</span>
<span class="cp">#define SNDRV_SEQ_GLOBAL_CLIENTS	16</span>
<span class="cm">/* clients per cards, for static clients */</span>
<span class="cp">#define SNDRV_SEQ_CLIENTS_PER_CARD	4</span>
<span class="cm">/* dynamically allocated client numbers (both kernel drivers and user space) */</span>
<span class="cp">#define SNDRV_SEQ_DYNAMIC_CLIENTS_BEGIN	128</span>

<span class="cp">#define SNDRV_SEQ_LFLG_INPUT	0x0001</span>
<span class="cp">#define SNDRV_SEQ_LFLG_OUTPUT	0x0002</span>
<span class="cp">#define SNDRV_SEQ_LFLG_OPEN	(SNDRV_SEQ_LFLG_INPUT|SNDRV_SEQ_LFLG_OUTPUT)</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">clients_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">register_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * client table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">clienttablock</span><span class="p">[</span><span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">clienttab</span><span class="p">[</span><span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_seq_usage</span> <span class="n">client_usage</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bounce_error_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_seq_deliver_single_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">filter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kr">inline</span> <span class="n">mm_segment_t</span> <span class="nf">snd_enter_user</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_leave_user</span><span class="p">(</span><span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_seq_file_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">FMODE_WRITE</span>:
                <span class="k">return</span> <span class="n">SNDRV_SEQ_LFLG_OUTPUT</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">FMODE_READ</span>:
                <span class="k">return</span> <span class="n">SNDRV_SEQ_LFLG_INPUT</span><span class="p">;</span>
        <span class="nl">default:</span>
                <span class="k">return</span> <span class="n">SNDRV_SEQ_LFLG_OPEN</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_seq_write_pool_allocated</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_seq_total_cells</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return pointer to client structure for specified id */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="nf">clientptr</span><span class="p">(</span><span class="kt">int</span> <span class="n">clientid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clientid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">clientid</span> <span class="o">&gt;=</span> <span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;Seq: oops. Trying to get pointer to client %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">clientid</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">clienttab</span><span class="p">[</span><span class="n">clientid</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="nf">snd_seq_client_use_ptr</span><span class="p">(</span><span class="kt">int</span> <span class="n">clientid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clientid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">clientid</span> <span class="o">&gt;=</span> <span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;Seq: oops. Trying to get pointer to client %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">clientid</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">clientptr</span><span class="p">(</span><span class="n">clientid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__lock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clienttablock</span><span class="p">[</span><span class="n">clientid</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MODULES</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">char</span> <span class="n">client_requested</span><span class="p">[</span><span class="n">SNDRV_SEQ_GLOBAL_CLIENTS</span><span class="p">];</span>
		<span class="k">static</span> <span class="kt">char</span> <span class="n">card_requested</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clientid</span> <span class="o">&lt;</span> <span class="n">SNDRV_SEQ_GLOBAL_CLIENTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client_requested</span><span class="p">[</span><span class="n">clientid</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">client_requested</span><span class="p">[</span><span class="n">clientid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">seq_client_load</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">seq_client_load</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">clientid</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;snd-seq-client-%i&quot;</span><span class="p">,</span>
							       <span class="n">clientid</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clientid</span> <span class="o">&lt;</span> <span class="n">SNDRV_SEQ_DYNAMIC_CLIENTS_BEGIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">clientid</span> <span class="o">-</span> <span class="n">SNDRV_SEQ_GLOBAL_CLIENTS</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">SNDRV_SEQ_CLIENTS_PER_CARD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">&lt;</span> <span class="n">snd_ecards_limit</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">card_requested</span><span class="p">[</span><span class="n">card</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">card_requested</span><span class="p">[</span><span class="n">card</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">snd_request_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">snd_seq_device_load_drivers</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">client</span> <span class="o">=</span> <span class="n">clientptr</span><span class="p">(</span><span class="n">clientid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__lock</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

      <span class="nl">__lock:</span>
	<span class="n">snd_use_lock_use</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">use_lock</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">client</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usage_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_usage</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">peak</span><span class="p">)</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">peak</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usage_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_usage</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">-=</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initialise data structures */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">client_init_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* zap out the client table */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clienttablock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clienttablock</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clienttab</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clienttab</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="nf">seq_create_client1</span><span class="p">(</span><span class="kt">int</span> <span class="n">client_index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">poolsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

	<span class="cm">/* init client data */</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">client</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">=</span> <span class="n">snd_seq_pool_new</span><span class="p">(</span><span class="n">poolsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">NO_CLIENT</span><span class="p">;</span>
	<span class="n">snd_use_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">use_lock</span><span class="p">);</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">ports_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">ports_mutex</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">ports_list_head</span><span class="p">);</span>

	<span class="cm">/* find free slot in the client table */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_DYNAMIC_CLIENTS_BEGIN</span><span class="p">;</span>
		     <span class="n">c</span> <span class="o">&lt;</span> <span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">;</span>
		     <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clienttab</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">||</span> <span class="n">clienttablock</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">clienttab</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">client</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clienttab</span><span class="p">[</span><span class="n">client_index</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">clienttablock</span><span class="p">[</span><span class="n">client_index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">clienttab</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">client_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">client</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_seq_pool_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* no free slot found or busy, return failure code */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">seq_free_client1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_seq_delete_all_ports</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">snd_seq_queue_client_leave</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">clienttablock</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">clienttab</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_use_lock_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">use_lock</span><span class="p">);</span>
	<span class="n">snd_seq_queue_client_termination</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">)</span>
		<span class="n">snd_seq_pool_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">clienttablock</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_free_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span> <span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NO_CLIENT</span>:
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Seq: Trying to free unused client %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USER_CLIENT</span>:
	<span class="k">case</span> <span class="n">KERNEL_CLIENT</span>:
		<span class="n">seq_free_client1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="n">usage_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_usage</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Seq: Trying to free client %d with undefined type = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">);</span>

	<span class="n">snd_seq_system_client_ev_client_exit</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/* -------------------------------------------------------- */</span>

<span class="cm">/* create a user client */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>			<span class="cm">/* client id */</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_user_client</span> <span class="o">*</span><span class="n">user</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">seq_create_client1</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SNDRV_SEQ_DEFAULT_EVENTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>	<span class="cm">/* failure code */</span>
	<span class="p">}</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">snd_seq_file_flags</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_LFLG_INPUT</span><span class="p">)</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">accept_input</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_LFLG_OUTPUT</span><span class="p">)</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">accept_output</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">user</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">;</span>
	<span class="n">user</span><span class="o">-&gt;</span><span class="n">fifo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">user</span><span class="o">-&gt;</span><span class="n">fifo_pool_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_LFLG_INPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">user</span><span class="o">-&gt;</span><span class="n">fifo_pool_size</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_DEFAULT_CLIENT_EVENTS</span><span class="p">;</span>
		<span class="n">user</span><span class="o">-&gt;</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">snd_seq_fifo_new</span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">fifo_pool_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">fifo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_free_client1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">usage_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_usage</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">USER_CLIENT</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">);</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="cm">/* fill client data */</span>
	<span class="n">user</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Client-%d&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="cm">/* make others aware this new client */</span>
	<span class="n">snd_seq_system_client_ev_client_start</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* delete a user client */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_free_client</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">)</span>
			<span class="n">snd_seq_fifo_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* handle client read() */</span>
<span class="cm">/* possible error values:</span>
<span class="cm"> *	-ENXIO	invalid client or file open mode</span>
<span class="cm"> *	-ENOSPC	FIFO overflow (the flag is cleared after this error report)</span>
<span class="cm"> *	-EINVAL	no enough user-space buffer to write the whole event</span>
<span class="cm"> *	-EFAULT	seg. fault during copy to user space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_seq_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			    <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_event_cell</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_seq_file_flags</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_LFLG_INPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* check client structures are in place */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">accept_input</span> <span class="o">||</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">overflow</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* buffer overflow is detected */</span>
		<span class="n">snd_seq_fifo_clear</span><span class="p">(</span><span class="n">fifo</span><span class="p">);</span>
		<span class="cm">/* return error code */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cell</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_seq_fifo_lock</span><span class="p">(</span><span class="n">fifo</span><span class="p">);</span>

	<span class="cm">/* while data available in queue */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nonblock</span><span class="p">;</span>

		<span class="n">nonblock</span> <span class="o">=</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">||</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_fifo_cell_out</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cell</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_ev_is_variable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="n">tmpev</span><span class="p">;</span>
			<span class="n">tmpev</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
			<span class="n">tmpev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ext</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_SEQ_EXT_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_expand_var_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
						       <span class="p">(</span><span class="kt">char</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_seq_cell_free</span><span class="p">(</span><span class="n">cell</span><span class="p">);</span>
		<span class="n">cell</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* to be sure */</span>
		<span class="n">result</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="p">)</span>
			<span class="n">snd_seq_fifo_cell_putback</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">cell</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_seq_fifo_unlock</span><span class="p">(</span><span class="n">fifo</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * check access permission to the port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_port_perm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flags</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * check if the destination client is available, and return the pointer</span>
<span class="cm"> * if filter is non-zero, client filter bitmap is tested.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="nf">get_event_dest_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
						    <span class="kt">int</span> <span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>

	<span class="n">dest</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">accept_input</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__not_avail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_FILTER_USE_EVENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">event_filter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__not_avail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">filter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__not_avail</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dest</span><span class="p">;</span> <span class="cm">/* ok - accessible */</span>
<span class="nl">__not_avail:</span>
	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Return the error event.</span>
<span class="cm"> *</span>
<span class="cm"> * If the receiver client is a user client, the original event is</span>
<span class="cm"> * encapsulated in SNDRV_SEQ_EVENT_BOUNCE as variable length event.  If</span>
<span class="cm"> * the original event is also variable length, the external data is</span>
<span class="cm"> * copied after the event record. </span>
<span class="cm"> * If the receiver client is a kernel client, the original event is</span>
<span class="cm"> * quoted in SNDRV_SEQ_EVENT_KERNEL_ERROR, since this requires no extra</span>
<span class="cm"> * kmalloc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bounce_error_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="n">bounce_ev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="o">!</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_FILTER_BOUNCE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">accept_input</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ignored */</span>

	<span class="cm">/* set up quoted error */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bounce_ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bounce_ev</span><span class="p">));</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_EVENT_KERNEL_ERROR</span><span class="p">;</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_EVENT_LENGTH_FIXED</span><span class="p">;</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_QUEUE_DIRECT</span><span class="p">;</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_CLIENT_SYSTEM</span><span class="p">;</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_PORT_SYSTEM_ANNOUNCE</span><span class="p">;</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">bounce_ev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span> <span class="cm">/* use positive value */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_deliver_single_event</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bounce_ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_lost</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * rewrite the time-stamp of the event record with the curren time</span>
<span class="cm"> * of the given queue.</span>
<span class="cm"> * return non-zero if updated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_timestamp_of_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">real_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">queueptr</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">q</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_SEQ_TIME_STAMP_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">real_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">snd_seq_timer_get_cur_time</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SNDRV_SEQ_TIME_STAMP_REAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tick</span> <span class="o">=</span> <span class="n">snd_seq_timer_get_cur_tick</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SNDRV_SEQ_TIME_STAMP_TICK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">queuefree</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * deliver an event to the specified destination.</span>
<span class="cm"> * if filter is non-zero, client filter bitmap is tested.</span>
<span class="cm"> *</span>
<span class="cm"> *  RETURN VALUE: 0 : if succeeded</span>
<span class="cm"> *		 &lt;0 : error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_deliver_single_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">filter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">dest_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direct</span><span class="p">;</span>

	<span class="n">direct</span> <span class="o">=</span> <span class="n">snd_seq_ev_is_direct</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="n">dest</span> <span class="o">=</span> <span class="n">get_event_dest_client</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__skip</span><span class="p">;</span>
	<span class="n">dest_port</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__skip</span><span class="p">;</span>

	<span class="cm">/* check permission */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">check_port_perm</span><span class="p">(</span><span class="n">dest_port</span><span class="p">,</span> <span class="n">SNDRV_SEQ_PORT_CAP_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__skip</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_port</span><span class="o">-&gt;</span><span class="n">timestamping</span><span class="p">)</span>
		<span class="n">update_timestamp_of_queue</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">dest_port</span><span class="o">-&gt;</span><span class="n">time_queue</span><span class="p">,</span>
					  <span class="n">dest_port</span><span class="o">-&gt;</span><span class="n">time_real</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USER_CLIENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_fifo_event_in</span><span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KERNEL_CLIENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dest_port</span><span class="o">-&gt;</span><span class="n">event_input</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">dest_port</span><span class="o">-&gt;</span><span class="n">event_input</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span>
						<span class="n">dest_port</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
						<span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

  <span class="nl">__skip:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_port</span><span class="p">)</span>
		<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">dest_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="p">)</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">direct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">bounce_error_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * send the event to all subscribers:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">deliver_to_subscribers</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_subscribers</span> <span class="o">*</span><span class="n">subs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="n">event_saved</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">src_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_subs_info</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>

	<span class="n">src_port</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* invalid source port */</span>
	<span class="cm">/* save original event record */</span>
	<span class="n">event_saved</span> <span class="o">=</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="n">grp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">src_port</span><span class="o">-&gt;</span><span class="n">c_src</span><span class="p">;</span>
	
	<span class="cm">/* lock list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span>
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">,</span> <span class="n">src_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">dest</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_PORT_SUBS_TIMESTAMP</span><span class="p">)</span>
			<span class="cm">/* convert time according to flag with subscription */</span>
			<span class="n">update_timestamp_of_queue</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
						  <span class="n">subs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_PORT_SUBS_TIME_REAL</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_deliver_single_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
						   <span class="mi">0</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">num_ev</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* restore original event record */</span>
		<span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">event_saved</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">list_mutex</span><span class="p">);</span>
	<span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">event_saved</span><span class="p">;</span> <span class="cm">/* restore */</span>
	<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">src_port</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">num_ev</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef SUPPORT_BROADCAST </span>
<span class="cm">/*</span>
<span class="cm"> * broadcast to all ports:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">port_broadcast_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">dest_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="n">dest_client</span> <span class="o">=</span> <span class="n">get_event_dest_client</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">SNDRV_SEQ_FILTER_BROADCAST</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no matching destination */</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_client</span><span class="o">-&gt;</span><span class="n">ports_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest_client</span><span class="o">-&gt;</span><span class="n">ports_list_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
		<span class="cm">/* pass NULL as source client to avoid error bounce */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_deliver_single_event</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
						   <span class="n">SNDRV_SEQ_FILTER_BROADCAST</span><span class="p">,</span>
						   <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">num_ev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_client</span><span class="o">-&gt;</span><span class="n">ports_lock</span><span class="p">);</span>
	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">dest_client</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_ADDRESS_BROADCAST</span><span class="p">;</span> <span class="cm">/* restore */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">num_ev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send the event to all clients:</span>
<span class="cm"> * if destination port is also ADDRESS_BROADCAST, deliver to all ports.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">broadcast_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_addr</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span> <span class="cm">/* save */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dest</span> <span class="o">&lt;</span> <span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">;</span> <span class="n">dest</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t send to itself */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dest</span> <span class="o">==</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_ADDRESS_BROADCAST</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">port_broadcast_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* pass NULL as source client to avoid error bounce */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_deliver_single_event</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
							   <span class="n">SNDRV_SEQ_FILTER_BROADCAST</span><span class="p">,</span>
							   <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">num_ev</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span> <span class="cm">/* restore */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">num_ev</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* multicast - not supported yet */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">multicast_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;seq: multicast not supported yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ignored */</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* SUPPORT_BROADCAST */</span><span class="cp"></span>


<span class="cm">/* deliver an event to the destination port(s).</span>
<span class="cm"> * if the event is to subscribers or broadcast, the event is dispatched</span>
<span class="cm"> * to multiple targets.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUE: n &gt; 0  : the number of delivered events.</span>
<span class="cm"> *               n == 0 : the event was not passed to any client.</span>
<span class="cm"> *               n &lt; 0  : error - event was not processed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_deliver_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">hop</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hop</span> <span class="o">&gt;=</span> <span class="n">SNDRV_SEQ_MAX_HOPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;too long delivery path (%d:%d-&gt;%d:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">event</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">port</span><span class="p">,</span>
			   <span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMLINK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_ADDRESS_SUBSCRIBERS</span> <span class="o">||</span>
	    <span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_ADDRESS_SUBSCRIBERS</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">deliver_to_subscribers</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_BROADCAST</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_ADDRESS_BROADCAST</span> <span class="o">||</span>
		 <span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_ADDRESS_BROADCAST</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">broadcast_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span> <span class="o">&gt;=</span> <span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">multicast_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_ADDRESS_BROADCAST</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">port_broadcast_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">else</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_deliver_single_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dispatch an event cell:</span>
<span class="cm"> * This function is called only from queue check routines in timer</span>
<span class="cm"> * interrupts or after enqueued.</span>
<span class="cm"> * The event cell shall be released or re-queued in this function.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUE: n &gt; 0  : the number of delivered events.</span>
<span class="cm"> *		 n == 0 : the event was not passed to any client.</span>
<span class="cm"> *		 n &lt; 0  : error - event was not processed.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_seq_dispatch_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event_cell</span> <span class="o">*</span><span class="n">cell</span><span class="p">,</span> <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cell</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">client</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_seq_cell_free</span><span class="p">(</span><span class="n">cell</span><span class="p">);</span> <span class="cm">/* release this cell */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_EVENT_NOTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NOTE event:</span>
<span class="cm">		 * the event cell is re-used as a NOTE-OFF event and</span>
<span class="cm">		 * enqueued again.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="n">tmpev</span><span class="p">,</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>

		<span class="cm">/* reserve this event to enqueue note-off later */</span>
		<span class="n">tmpev</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
		<span class="n">tmpev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_EVENT_NOTEON</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_deliver_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpev</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * This was originally a note event.  We now re-use the</span>
<span class="cm">		 * cell for the note-off event.</span>
<span class="cm">		 */</span>

		<span class="n">ev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_EVENT_NOTEOFF</span><span class="p">;</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SNDRV_SEQ_PRIORITY_HIGH</span><span class="p">;</span>

		<span class="cm">/* add the duration time */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_TIME_STAMP_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SNDRV_SEQ_TIME_STAMP_TICK</span>:
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tick</span> <span class="o">+=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">duration</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNDRV_SEQ_TIME_STAMP_REAL</span>:
			<span class="cm">/* unit for duration is ms */</span>
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">+=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">duration</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">+=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">duration</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">+</span>
						<span class="n">ev</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">/</span> <span class="mi">1000000000</span><span class="p">;</span>
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">%=</span> <span class="mi">1000000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">off_velocity</span><span class="p">;</span>

		<span class="cm">/* Now queue this cell as the note off event */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_enqueue_event</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snd_seq_cell_free</span><span class="p">(</span><span class="n">cell</span><span class="p">);</span> <span class="cm">/* release this cell */</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Normal events:</span>
<span class="cm">		 * event cell is freed after processing the event</span>
<span class="cm">		 */</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_deliver_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
		<span class="n">snd_seq_cell_free</span><span class="p">(</span><span class="n">cell</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Allocate a cell from client pool and enqueue it to queue:</span>
<span class="cm"> * if pool is empty and blocking is TRUE, sleep until a new cell is</span>
<span class="cm"> * available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_client_enqueue_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blocking</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_event_cell</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* special queue values - force direct passing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_ADDRESS_SUBSCRIBERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_ADDRESS_SUBSCRIBERS</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_QUEUE_DIRECT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#ifdef SUPPORT_BROADCAST</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_ADDRESS_BROADCAST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_ADDRESS_BROADCAST</span><span class="p">;</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_QUEUE_DIRECT</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_ADDRESS_SUBSCRIBERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check presence of source port */</span>
		<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">src_port</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">src_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* direct event processing without enqueued */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_ev_is_direct</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_EVENT_NOTE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* this event must be enqueued! */</span>
		<span class="k">return</span> <span class="n">snd_seq_deliver_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Not direct, normal queuing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_queue_is_used</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>  <span class="cm">/* invalid queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_seq_write_pool_allocated</span><span class="p">(</span><span class="n">client</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span> <span class="cm">/* queue is not allocated */</span>

	<span class="cm">/* allocate an event cell */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_event_dup</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cell</span><span class="p">,</span> <span class="o">!</span><span class="n">blocking</span> <span class="o">||</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* we got a cell. enqueue it. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_enqueue_event</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_seq_cell_free</span><span class="p">(</span><span class="n">cell</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * check validity of event type and data length.</span>
<span class="cm"> * return non-zero if invalid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_event_type_and_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">snd_seq_ev_length_type</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_SEQ_EVENT_LENGTH_FIXED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_ev_is_variable_type</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SEQ_EVENT_LENGTH_VARIABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_seq_ev_is_variable_type</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ext</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SNDRV_SEQ_EXT_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SNDRV_SEQ_MAX_EVENT_LEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SEQ_EVENT_LENGTH_VARUSR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_seq_ev_is_direct</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* handle write() */</span>
<span class="cm">/* possible error values:</span>
<span class="cm"> *	-ENXIO	invalid client or file open mode</span>
<span class="cm"> *	-ENOMEM	malloc failed</span>
<span class="cm"> *	-EFAULT	seg. fault during copy from user space</span>
<span class="cm"> *	-EINVAL	invalid event</span>
<span class="cm"> *	-EAGAIN	no space in output pool</span>
<span class="cm"> *	-EINTR	interrupts while sleep</span>
<span class="cm"> *	-EMLINK	too many hops</span>
<span class="cm"> *	others	depends on return value from driver callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_seq_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_seq_file_flags</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_LFLG_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* check client structures are in place */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">accept_output</span> <span class="o">||</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* allocate the pool now if the pool is not allocated yet */</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">snd_seq_write_pool_allocated</span><span class="p">(</span><span class="n">client</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_pool_init</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* only process whole events */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Read in the event header from the user */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">event</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>	<span class="cm">/* fill in client number */</span>
		<span class="cm">/* Check for extension data length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_event_type_and_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check for special events */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_EVENT_NONE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__skip_event</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_ev_is_reserved</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_ev_is_variable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">extlen</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ext</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SNDRV_SEQ_EXT_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">extlen</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* back out, will get an error this time or next */</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* set user space pointer */</span>
			<span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ext</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">extlen</span> <span class="o">|</span> <span class="n">SNDRV_SEQ_EXT_USRPTR</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ext</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span>
						<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_event</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">extlen</span><span class="p">;</span> <span class="cm">/* increment data length */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">convert32</span> <span class="o">&amp;&amp;</span> <span class="n">snd_seq_ev_is_varusr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">raw32</span><span class="p">.</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ext</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="cm">/* ok, enqueue it */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_client_enqueue_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
						   <span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">),</span>
						   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="nl">__skip_event:</span>
		<span class="cm">/* Update pointers and counts */</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">written</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">written</span> <span class="o">?</span> <span class="n">written</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * handle polling</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_seq_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check client structures are in place */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">snd_seq_file_flags</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_LFLG_INPUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* check if data is available in the outqueue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_fifo_poll_wait</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_file_flags</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_LFLG_OUTPUT</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* check if data is available in the pool */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_seq_write_pool_allocated</span><span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">snd_seq_pool_poll_wait</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*-----------------------------------------------------*/</span>


<span class="cm">/* SYSTEM_INFO ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_system_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_system_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="cm">/* fill the info fields */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">queues</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_MAX_QUEUES</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">clients</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">ports</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>	<span class="cm">/* fixed limit */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>	<span class="cm">/* fixed limit */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">cur_clients</span> <span class="o">=</span> <span class="n">client_usage</span><span class="p">.</span><span class="n">cur</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">cur_queues</span> <span class="o">=</span> <span class="n">snd_seq_queue_get_cur_queues</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* RUNNING_MODE ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_running_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_running_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* requested client number */</span>
	<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>		<span class="cm">/* don&#39;t change !!! */</span>

<span class="cp">#ifdef SNDRV_BIG_ENDIAN</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">info</span><span class="p">.</span><span class="n">big_endian</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">big_endian</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">cpu_mode</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">convert32</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">cpu_mode</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
 <span class="nl">__err:</span>
	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* CLIENT_INFO ioctl() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_client_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_seq_client_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="cm">/* fill the info fields */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">event_lost</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">event_lost</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_filter</span><span class="p">,</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">event_filter</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_client_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_info</span> <span class="n">client_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* requested client number */</span>
	<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">client_info</span><span class="p">.</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>		<span class="cm">/* don&#39;t change !!! */</span>

	<span class="n">get_client_info</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_info</span><span class="p">);</span>
	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* CLIENT_INFO ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_set_client_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_info</span> <span class="n">client_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* it is not allowed to set the info fields for an another client */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">client_info</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="cm">/* also client type must be set now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">client_info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* fill the info fields */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client_info</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">client_info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="n">client_info</span><span class="p">.</span><span class="n">filter</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_lost</span> <span class="o">=</span> <span class="n">client_info</span><span class="p">.</span><span class="n">event_lost</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_filter</span><span class="p">,</span> <span class="n">client_info</span><span class="p">.</span><span class="n">event_filter</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * CREATE PORT ioctl() </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_create_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_callback</span> <span class="o">*</span><span class="n">callback</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* it is not allowed to create the port for an another client */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">client</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">snd_seq_create_port</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_PORT_FLG_GIVEN_PORT</span><span class="p">)</span> <span class="o">?</span> <span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USER_CLIENT</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">kernel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_seq_delete_port</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">KERNEL_CLIENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">callback</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">kernel</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">)</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">callback_all</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">callback_all</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">event_input</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">event_input</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">c_src</span><span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">subscribe</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">c_src</span><span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">unsubscribe</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">c_dest</span><span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">c_dest</span><span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">unuse</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">snd_seq_set_port_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">snd_seq_system_client_ev_port_start</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * DELETE PORT ioctl() </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_delete_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* set passed parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	
	<span class="cm">/* it is not allowed to remove the port for an another client */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">client</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_delete_port</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_seq_system_client_ev_port_exit</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * GET_PORT_INFO ioctl() (on any client) </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_port_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>			<span class="cm">/* don&#39;t change */</span>
	<span class="p">}</span>

	<span class="cm">/* get port info */</span>
	<span class="n">snd_seq_get_port_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * SET_PORT_INFO ioctl() (only ports on this/own client) </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_set_port_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">client</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="cm">/* only set our own ports ! */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_seq_set_port_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * port subscription (connection)</span>
<span class="cm"> */</span>
<span class="cp">#define PERM_RD		(SNDRV_SEQ_PORT_CAP_READ|SNDRV_SEQ_PORT_CAP_SUBS_READ)</span>
<span class="cp">#define PERM_WR		(SNDRV_SEQ_PORT_CAP_WRITE|SNDRV_SEQ_PORT_CAP_SUBS_WRITE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_subscription_permission</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">dport</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_seq_port_subscribe</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">sender</span><span class="p">.</span><span class="n">client</span> <span class="o">&amp;&amp;</span>
	    <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* connection by third client - check export permission */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_port_perm</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">SNDRV_SEQ_PORT_CAP_NO_EXPORT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_port_perm</span><span class="p">(</span><span class="n">dport</span><span class="p">,</span> <span class="n">SNDRV_SEQ_PORT_CAP_NO_EXPORT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check read permission */</span>
	<span class="cm">/* if sender or receiver is the subscribing client itself,</span>
<span class="cm">	 * no permission check is necessary</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">sender</span><span class="p">.</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">check_port_perm</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">PERM_RD</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check write permission */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">check_port_perm</span><span class="p">(</span><span class="n">dport</span><span class="p">,</span> <span class="n">PERM_WR</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send an subscription notify event to user client:</span>
<span class="cm"> * client must be user client.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_seq_client_notify_subscription</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_seq_port_subscribe</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">evtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">evtype</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">connect</span><span class="p">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">connect</span><span class="p">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sender</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_seq_system_notify</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>  <span class="cm">/* non-atomic */</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * add to port&#39;s subscription list IOCTL interface </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_subscribe_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">receiver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">sender</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">dport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_subscribe</span> <span class="n">subs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subs</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">subs</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">receiver</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">subs</span><span class="p">.</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sender</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">subs</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">client</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sport</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">subs</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dport</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">subs</span><span class="p">.</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">check_subscription_permission</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>

	<span class="cm">/* connect them */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_port_connect</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">result</span><span class="p">)</span> <span class="cm">/* broadcast announce */</span>
		<span class="n">snd_seq_client_notify_subscription</span><span class="p">(</span><span class="n">SNDRV_SEQ_ADDRESS_SUBSCRIBERS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">subs</span><span class="p">,</span> <span class="n">SNDRV_SEQ_EVENT_PORT_SUBSCRIBED</span><span class="p">);</span>
      <span class="nl">__end:</span>
      	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="p">)</span>
		<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dport</span><span class="p">)</span>
		<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">dport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sender</span><span class="p">)</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">receiver</span><span class="p">)</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">receiver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * remove from port&#39;s subscription list </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_unsubscribe_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">receiver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">sender</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">dport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_subscribe</span> <span class="n">subs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subs</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">subs</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">receiver</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">subs</span><span class="p">.</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sender</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">subs</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">client</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sport</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">subs</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dport</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">subs</span><span class="p">.</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">check_subscription_permission</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_port_disconnect</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">result</span><span class="p">)</span> <span class="cm">/* broadcast announce */</span>
		<span class="n">snd_seq_client_notify_subscription</span><span class="p">(</span><span class="n">SNDRV_SEQ_ADDRESS_SUBSCRIBERS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">subs</span><span class="p">,</span> <span class="n">SNDRV_SEQ_EVENT_PORT_UNSUBSCRIBED</span><span class="p">);</span>
      <span class="nl">__end:</span>
      	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="p">)</span>
		<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dport</span><span class="p">)</span>
		<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">dport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sender</span><span class="p">)</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">receiver</span><span class="p">)</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">receiver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* CREATE_QUEUE ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_create_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				      <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_queue_alloc</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">locked</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">queueptr</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">locked</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>

	<span class="cm">/* set queue name */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;Queue-%d&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">queuefree</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DELETE_QUEUE ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_delete_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				      <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_seq_queue_delete</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* GET_QUEUE_INFO ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_queue_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">queueptr</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">info</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">locked</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">queuefree</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SET_QUEUE_INFO ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_set_queue_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* change owner/locked permission */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_queue_check_access</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_queue_set_owner</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">locked</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">locked</span><span class="p">)</span>
			<span class="n">snd_seq_queue_use</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>	

	<span class="n">q</span> <span class="o">=</span> <span class="n">queueptr</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">q</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queuefree</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">queuefree</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* GET_NAMED_QUEUE ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_named_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">snd_seq_queue_find_name</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">locked</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">;</span>
	<span class="n">queuefree</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* GET_QUEUE_STATUS ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_queue_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">queueptr</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="n">status</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	
	<span class="n">tmr</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tickq</span><span class="o">-&gt;</span><span class="n">cells</span> <span class="o">+</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">timeq</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">;</span>

	<span class="n">status</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">snd_seq_timer_get_cur_time</span><span class="p">(</span><span class="n">tmr</span><span class="p">);</span>
	<span class="n">status</span><span class="p">.</span><span class="n">tick</span> <span class="o">=</span> <span class="n">snd_seq_timer_get_cur_tick</span><span class="p">(</span><span class="n">tmr</span><span class="p">);</span>

	<span class="n">status</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">;</span>

	<span class="n">status</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">queuefree</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* GET_QUEUE_TEMPO ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_queue_tempo</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_tempo</span> <span class="n">tempo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempo</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tempo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">queueptr</span><span class="p">(</span><span class="n">tempo</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tempo</span><span class="p">));</span>
	<span class="n">tempo</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	
	<span class="n">tmr</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">;</span>

	<span class="n">tempo</span><span class="p">.</span><span class="n">tempo</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">tempo</span><span class="p">;</span>
	<span class="n">tempo</span><span class="p">.</span><span class="n">ppq</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">ppq</span><span class="p">;</span>
	<span class="n">tempo</span><span class="p">.</span><span class="n">skew_value</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">skew</span><span class="p">;</span>
	<span class="n">tempo</span><span class="p">.</span><span class="n">skew_base</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">skew_base</span><span class="p">;</span>
	<span class="n">queuefree</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tempo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* SET_QUEUE_TEMPO ioctl() */</span>
<span class="kt">int</span> <span class="nf">snd_seq_set_queue_tempo</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_queue_tempo</span> <span class="o">*</span><span class="n">tempo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_seq_queue_check_access</span><span class="p">(</span><span class="n">tempo</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">client</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_seq_queue_timer_set_tempo</span><span class="p">(</span><span class="n">tempo</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">tempo</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_seq_set_queue_tempo</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_set_queue_tempo</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_tempo</span> <span class="n">tempo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempo</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tempo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_set_queue_tempo</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">result</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* GET_QUEUE_TIMER ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_queue_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_timer</span> <span class="n">timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timer</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">queueptr</span><span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">timer_mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queuefree</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmr</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>

	<span class="n">timer</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_TIMER_ALSA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timer</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alsa</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">alsa_id</span><span class="p">;</span>
		<span class="n">timer</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alsa</span><span class="p">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">preferred_resolution</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">timer_mutex</span><span class="p">);</span>
	<span class="n">queuefree</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timer</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* SET_QUEUE_TIMER ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_set_queue_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_timer</span> <span class="n">timer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timer</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SNDRV_SEQ_TIMER_ALSA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_queue_check_access</span><span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_seq_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_seq_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">;</span>

		<span class="n">q</span> <span class="o">=</span> <span class="n">queueptr</span><span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timer_mutex</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">queuefree</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmr</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">;</span>
		<span class="n">snd_seq_queue_timer_close</span><span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">tmr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">timer</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_TIMER_ALSA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmr</span><span class="o">-&gt;</span><span class="n">alsa_id</span> <span class="o">=</span> <span class="n">timer</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alsa</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
			<span class="n">tmr</span><span class="o">-&gt;</span><span class="n">preferred_resolution</span> <span class="o">=</span> <span class="n">timer</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alsa</span><span class="p">.</span><span class="n">resolution</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_queue_timer_open</span><span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timer_mutex</span><span class="p">);</span>
		<span class="n">queuefree</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>	

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* GET_QUEUE_CLIENT ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_queue_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_client</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">snd_seq_queue_is_used</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">used</span> <span class="o">=</span> <span class="n">used</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* SET_QUEUE_CLIENT ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_set_queue_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_queue_client</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">used</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_seq_queue_use</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">used</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_seq_ioctl_get_queue_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* GET_CLIENT_POOL ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_client_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_pool</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">info</span><span class="p">.</span><span class="n">output_pool</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">output_room</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">room</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">output_free</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">output_pool</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">output_free</span> <span class="o">=</span> <span class="n">snd_seq_unused_cells</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USER_CLIENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">input_pool</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo_pool_size</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">input_free</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">input_pool</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">)</span>
			<span class="n">info</span><span class="p">.</span><span class="n">input_free</span> <span class="o">=</span> <span class="n">snd_seq_unused_cells</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">input_pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">input_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SET_CLIENT_POOL ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_set_client_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_pool</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">info</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* can&#39;t change other clients */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">output_pool</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">output_pool</span> <span class="o">&lt;=</span> <span class="n">SNDRV_SEQ_MAX_EVENTS</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span> <span class="n">snd_seq_write_pool_allocated</span><span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">info</span><span class="p">.</span><span class="n">output_pool</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_write_pool_allocated</span><span class="p">(</span><span class="n">client</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* remove all existing cells */</span>
			<span class="n">snd_seq_queue_client_leave_cells</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="n">snd_seq_pool_done</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">output_pool</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_seq_pool_init</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USER_CLIENT</span> <span class="o">&amp;&amp;</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">info</span><span class="p">.</span><span class="n">input_pool</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">info</span><span class="p">.</span><span class="n">input_pool</span> <span class="o">&lt;=</span> <span class="n">SNDRV_SEQ_MAX_CLIENT_EVENTS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">info</span><span class="p">.</span><span class="n">input_pool</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo_pool_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* change pool size */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_seq_fifo_resize</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">input_pool</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo_pool_size</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">input_pool</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">output_room</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">info</span><span class="p">.</span><span class="n">output_room</span> <span class="o">&lt;=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">room</span>  <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">output_room</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_seq_ioctl_get_client_pool</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* REMOVE_EVENTS ioctl() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_remove_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_remove_events</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Input mostly not implemented XXX.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">remove_mode</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_REMOVE_INPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No restrictions so for a user client we can clear</span>
<span class="cm">		 * the whole fifo</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USER_CLIENT</span><span class="p">)</span>
			<span class="n">snd_seq_fifo_clear</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">remove_mode</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_REMOVE_OUTPUT</span><span class="p">)</span>
		<span class="n">snd_seq_queue_remove_cells</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * get subscription info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_get_subscription</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">sender</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_subscribe</span> <span class="n">subs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_subscribers</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subs</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">subs</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sender</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">subs</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">client</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sport</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">subs</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">snd_seq_port_get_subscription</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">c_src</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subs</span><span class="p">.</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">subs</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

      <span class="nl">__end:</span>
      	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="p">)</span>
		<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sender</span><span class="p">)</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">subs</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * get subscription info - check only its presence</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_query_subs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_query_subs</span> <span class="n">subs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_subs_info</span> <span class="o">*</span><span class="n">group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subs</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">subs</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">subs</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">client</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">port</span> <span class="o">=</span> <span class="n">snd_seq_port_use_ptr</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="n">subs</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">subs</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_SEQ_QUERY_SUBS_READ</span>:
		<span class="n">group</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">c_src</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SEQ_QUERY_SUBS_WRITE</span>:
		<span class="n">group</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">c_dest</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">list_mutex</span><span class="p">);</span>
	<span class="cm">/* search for the subscriber */</span>
	<span class="n">subs</span><span class="p">.</span><span class="n">num_subs</span> <span class="o">=</span> <span class="n">group</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">==</span> <span class="n">subs</span><span class="p">.</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* found! */</span>
			<span class="k">struct</span> <span class="n">snd_seq_subscribers</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">subs</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_QUERY_SUBS_READ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_subscribers</span><span class="p">,</span> <span class="n">src_list</span><span class="p">);</span>
				<span class="n">subs</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">dest</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_subscribers</span><span class="p">,</span> <span class="n">dest_list</span><span class="p">);</span>
				<span class="n">subs</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">subs</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">subs</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">list_mutex</span><span class="p">);</span>

      <span class="nl">__end:</span>
   	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="p">)</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">subs</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * query next client</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_query_next_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					   <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* search for next client */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">client</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">client</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">info</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">info</span><span class="p">.</span><span class="n">client</span> <span class="o">&lt;</span> <span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">;</span> <span class="n">info</span><span class="p">.</span><span class="n">client</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">client</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* found */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">get_client_info</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * query next port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_ioctl_query_next_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_port_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* search for next port */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="o">++</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">snd_seq_port_query_nearest</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get port info */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">snd_seq_get_port_info</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">snd_seq_port_unlock</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">seq_ioctl_table</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span> <span class="n">ioctl_tables</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_SYSTEM_INFO</span><span class="p">,</span> <span class="n">snd_seq_ioctl_system_info</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_RUNNING_MODE</span><span class="p">,</span> <span class="n">snd_seq_ioctl_running_mode</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_CLIENT_INFO</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_client_info</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_SET_CLIENT_INFO</span><span class="p">,</span> <span class="n">snd_seq_ioctl_set_client_info</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_CREATE_PORT</span><span class="p">,</span> <span class="n">snd_seq_ioctl_create_port</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_DELETE_PORT</span><span class="p">,</span> <span class="n">snd_seq_ioctl_delete_port</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_PORT_INFO</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_port_info</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_SET_PORT_INFO</span><span class="p">,</span> <span class="n">snd_seq_ioctl_set_port_info</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_SUBSCRIBE_PORT</span><span class="p">,</span> <span class="n">snd_seq_ioctl_subscribe_port</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_UNSUBSCRIBE_PORT</span><span class="p">,</span> <span class="n">snd_seq_ioctl_unsubscribe_port</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_CREATE_QUEUE</span><span class="p">,</span> <span class="n">snd_seq_ioctl_create_queue</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_DELETE_QUEUE</span><span class="p">,</span> <span class="n">snd_seq_ioctl_delete_queue</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_QUEUE_INFO</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_queue_info</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_SET_QUEUE_INFO</span><span class="p">,</span> <span class="n">snd_seq_ioctl_set_queue_info</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_NAMED_QUEUE</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_named_queue</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_QUEUE_STATUS</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_queue_status</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_QUEUE_TEMPO</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_queue_tempo</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_SET_QUEUE_TEMPO</span><span class="p">,</span> <span class="n">snd_seq_ioctl_set_queue_tempo</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_QUEUE_TIMER</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_queue_timer</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_SET_QUEUE_TIMER</span><span class="p">,</span> <span class="n">snd_seq_ioctl_set_queue_timer</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_QUEUE_CLIENT</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_queue_client</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_SET_QUEUE_CLIENT</span><span class="p">,</span> <span class="n">snd_seq_ioctl_set_queue_client</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_CLIENT_POOL</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_client_pool</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_SET_CLIENT_POOL</span><span class="p">,</span> <span class="n">snd_seq_ioctl_set_client_pool</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_GET_SUBSCRIPTION</span><span class="p">,</span> <span class="n">snd_seq_ioctl_get_subscription</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_QUERY_NEXT_CLIENT</span><span class="p">,</span> <span class="n">snd_seq_ioctl_query_next_client</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_QUERY_NEXT_PORT</span><span class="p">,</span> <span class="n">snd_seq_ioctl_query_next_port</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_REMOVE_EVENTS</span><span class="p">,</span> <span class="n">snd_seq_ioctl_remove_events</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SNDRV_SEQ_IOCTL_QUERY_SUBS</span><span class="p">,</span> <span class="n">snd_seq_ioctl_query_subs</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_seq_do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_ioctl_table</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_SEQ_IOCTL_PVERSION</span>:
		<span class="cm">/* return sequencer version number */</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SNDRV_SEQ_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SEQ_IOCTL_CLIENT_ID</span>:
		<span class="cm">/* return the id of this client */</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">ioctl_tables</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;seq unknown ioctl() 0x%x (type=&#39;%c&#39;, number=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">cmd</span><span class="p">,</span> <span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">long</span> <span class="nf">snd_seq_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		
	<span class="k">return</span> <span class="n">snd_seq_do_ioctl</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="cp">#include &quot;seq_compat.c&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define snd_seq_ioctl_compat	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* -------------------------------------------------------- */</span>


<span class="cm">/* exported to kernel modules */</span>
<span class="kt">int</span> <span class="nf">snd_seq_create_kernel_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client_index</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name_fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">()))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">client_index</span> <span class="o">&gt;=</span> <span class="n">SNDRV_SEQ_CLIENTS_PER_CARD</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">client_index</span> <span class="o">&gt;=</span> <span class="n">SNDRV_SEQ_GLOBAL_CLIENTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">client_index</span> <span class="o">+=</span> <span class="n">SNDRV_SEQ_GLOBAL_CLIENTS</span>
			<span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">*</span> <span class="n">SNDRV_SEQ_CLIENTS_PER_CARD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client_index</span> <span class="o">&gt;=</span> <span class="n">SNDRV_SEQ_DYNAMIC_CLIENTS_BEGIN</span><span class="p">)</span>
			<span class="n">client_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* empty write queue as default */</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">seq_create_client1</span><span class="p">(</span><span class="n">client_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* failure code */</span>
	<span class="p">}</span>
	<span class="n">usage_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_usage</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">accept_input</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">accept_output</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">name_fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="n">name_fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">KERNEL_CLIENT</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">);</span>

	<span class="cm">/* make others aware this new client */</span>
	<span class="n">snd_seq_system_client_ev_client_start</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	
	<span class="cm">/* return client number to caller */</span>
	<span class="k">return</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_seq_create_kernel_client</span><span class="p">);</span>

<span class="cm">/* exported to kernel modules */</span>
<span class="kt">int</span> <span class="nf">snd_seq_delete_kernel_client</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">()))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">clientptr</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">seq_free_client</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_seq_delete_kernel_client</span><span class="p">);</span>

<span class="cm">/* skeleton to enqueue event, called from snd_seq_kernel_client_enqueue</span>
<span class="cm"> * and snd_seq_kernel_client_enqueue_blocking</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kernel_client_enqueue</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blocking</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_EVENT_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ignore this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SEQ_EVENT_KERNEL_ERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* quoted events can&#39;t be enqueued */</span>

	<span class="cm">/* fill in client number */</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_event_type_and_length</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">accept_output</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* send it */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_client_enqueue_event</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">blocking</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>

	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * exported, called by kernel clients to enqueue events (w/o blocking)</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUE: zero if succeed, negative if error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_seq_kernel_client_enqueue</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span> <span class="n">ev</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kernel_client_enqueue</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_seq_kernel_client_enqueue</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * exported, called by kernel clients to enqueue events (with blocking)</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUE: zero if succeed, negative if error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_seq_kernel_client_enqueue_blocking</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span> <span class="n">ev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kernel_client_enqueue</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_seq_kernel_client_enqueue_blocking</span><span class="p">);</span>

<span class="cm">/* </span>
<span class="cm"> * exported, called by kernel clients to dispatch events directly to other</span>
<span class="cm"> * clients, bypassing the queues.  Event time-stamp will be updated.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUE: negative = delivery failed,</span>
<span class="cm"> *		 zero, or positive: the number of delivered events</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_seq_kernel_client_dispatch</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_event</span> <span class="o">*</span> <span class="n">ev</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">atomic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* fill in client number */</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">SNDRV_SEQ_QUEUE_DIRECT</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_event_type_and_length</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">accept_output</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_deliver_event</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">atomic</span><span class="p">,</span> <span class="n">hop</span><span class="p">);</span>

	<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_seq_kernel_client_dispatch</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * exported, called by kernel clients to perform same functions as with</span>
<span class="cm"> * userland ioctl() </span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_seq_kernel_client_ctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">clientid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">client</span> <span class="o">=</span> <span class="n">clientptr</span><span class="p">(</span><span class="n">clientid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">fs</span> <span class="o">=</span> <span class="n">snd_enter_user</span><span class="p">();</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">snd_seq_do_ioctl</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">snd_leave_user</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_seq_kernel_client_ctl</span><span class="p">);</span>

<span class="cm">/* exported (for OSS emulator) */</span>
<span class="kt">int</span> <span class="nf">snd_seq_kernel_client_write_poll</span><span class="p">(</span><span class="kt">int</span> <span class="n">clientid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

	<span class="n">client</span> <span class="o">=</span> <span class="n">clientptr</span><span class="p">(</span><span class="n">clientid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_seq_write_pool_allocated</span><span class="p">(</span><span class="n">client</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_pool_poll_wait</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_seq_kernel_client_write_poll</span><span class="p">);</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cm">/*</span>
<span class="cm"> *  /proc interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_seq_info_dump_subscribers</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_seq_port_subs_info</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">is_src</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_subscribers</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">list_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">list_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_src</span><span class="p">)</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_subscribers</span><span class="p">,</span> <span class="n">src_list</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_seq_subscribers</span><span class="p">,</span> <span class="n">dest_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%d:%d&quot;</span><span class="p">,</span>
			    <span class="n">is_src</span> <span class="o">?</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">dest</span><span class="p">.</span><span class="n">client</span> <span class="o">:</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">client</span><span class="p">,</span>
			    <span class="n">is_src</span> <span class="o">?</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">dest</span><span class="p">.</span><span class="n">port</span> <span class="o">:</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_PORT_SUBS_TIMESTAMP</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;[%c:%d]&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SNDRV_SEQ_PORT_SUBS_TIME_REAL</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;r&#39;</span> <span class="o">:</span> <span class="sc">&#39;t&#39;</span><span class="p">),</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">exclusive</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;[ex]&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">list_mutex</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define FLAG_PERM_RD(perm) ((perm) &amp; SNDRV_SEQ_PORT_CAP_READ ? ((perm) &amp; SNDRV_SEQ_PORT_CAP_SUBS_READ ? &#39;R&#39; : &#39;r&#39;) : &#39;-&#39;)</span>
<span class="cp">#define FLAG_PERM_WR(perm) ((perm) &amp; SNDRV_SEQ_PORT_CAP_WRITE ? ((perm) &amp; SNDRV_SEQ_PORT_CAP_SUBS_WRITE ? &#39;W&#39; : &#39;w&#39;) : &#39;-&#39;)</span>
<span class="cp">#define FLAG_PERM_EX(perm) ((perm) &amp; SNDRV_SEQ_PORT_CAP_NO_EXPORT ? &#39;-&#39; : &#39;e&#39;)</span>

<span class="cp">#define FLAG_PERM_DUPLEX(perm) ((perm) &amp; SNDRV_SEQ_PORT_CAP_DUPLEX ? &#39;X&#39; : &#39;-&#39;)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_seq_info_dump_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_client_port</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">ports_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">ports_list_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Port %3d : </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> (%c%c%c%c)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">p</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">FLAG_PERM_RD</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">),</span>
			    <span class="n">FLAG_PERM_WR</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">),</span>
			    <span class="n">FLAG_PERM_EX</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">),</span>
			    <span class="n">FLAG_PERM_DUPLEX</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">));</span>
		<span class="n">snd_seq_info_dump_subscribers</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c_src</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;    Connecting To: &quot;</span><span class="p">);</span>
		<span class="n">snd_seq_info_dump_subscribers</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c_dest</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;    Connected From: &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">ports_mutex</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* exported to seq_info.c */</span>
<span class="kt">void</span> <span class="nf">snd_seq_info_clients_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> 
			       <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_seq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Client info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  cur  clients : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">client_usage</span><span class="p">.</span><span class="n">cur</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  peak clients : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">client_usage</span><span class="p">.</span><span class="n">peak</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  max  clients : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* list the client table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">SNDRV_SEQ_MAX_CLIENTS</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">client</span> <span class="o">=</span> <span class="n">snd_seq_client_use_ptr</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NO_CLIENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Client %3d : </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">c</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USER_CLIENT</span> <span class="o">?</span> <span class="s">&quot;User&quot;</span> <span class="o">:</span> <span class="s">&quot;Kernel&quot;</span><span class="p">);</span>
		<span class="n">snd_seq_info_dump_ports</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_write_pool_allocated</span><span class="p">(</span><span class="n">client</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Output pool :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">snd_seq_info_pool</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USER_CLIENT</span> <span class="o">&amp;&amp;</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span> <span class="o">&amp;&amp;</span>
		    <span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Input pool :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">snd_seq_info_pool</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_seq_client_unlock</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>


<span class="cm">/*</span>
<span class="cm"> *  REGISTRATION PART</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">snd_seq_f_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">snd_seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">snd_seq_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">snd_seq_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span>		<span class="n">snd_seq_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span>	<span class="n">snd_seq_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span>	<span class="n">snd_seq_ioctl_compat</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* </span>
<span class="cm"> * register sequencer device </span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">snd_sequencer_device_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_register_device</span><span class="p">(</span><span class="n">SNDRV_DEVICE_TYPE_SEQUENCER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">snd_seq_f_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;seq&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">register_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* </span>
<span class="cm"> * unregister sequencer device </span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">snd_sequencer_device_done</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_unregister_device</span><span class="p">(</span><span class="n">SNDRV_DEVICE_TYPE_SEQUENCER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
