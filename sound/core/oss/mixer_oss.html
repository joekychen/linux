<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › core › oss › mixer_oss.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mixer_oss.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  OSS emulation layer for the mixer interface</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/minors.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/mixer_oss.h&gt;</span>
<span class="cp">#include &lt;linux/soundcard.h&gt;</span>

<span class="cp">#define OSS_ALSAEMULVER         _SIOR (&#39;M&#39;, 249, int)</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Mixer OSS emulation for ALSA.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_SNDRV_MINOR</span><span class="p">(</span><span class="n">SNDRV_MINOR_OSS_MIXER</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">snd_lookup_oss_minor_data</span><span class="p">(</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
					 <span class="n">SNDRV_OSS_DEVICE_TYPE_MIXER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixer_oss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_file_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">fmixer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fmixer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmixer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_file_remove</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mixer_oss</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">fmixer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fmixer</span><span class="p">);</span>
		<span class="n">snd_card_file_remove</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmixer</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
		<span class="n">snd_card_file_remove</span><span class="p">(</span><span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fmixer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
			      <span class="n">mixer_info</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixer_info</span> <span class="n">info</span><span class="p">;</span>
	
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">mixer</span> <span class="o">&amp;&amp;</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">:</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mixer</span> <span class="o">&amp;&amp;</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">info</span><span class="p">.</span><span class="n">modify_counter</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mixer_oss_change_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_info_obsolete</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
				       <span class="n">_old_mixer_info</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="n">_old_mixer_info</span> <span class="n">info</span><span class="p">;</span>
	
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">mixer</span> <span class="o">&amp;&amp;</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">:</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mixer</span> <span class="o">&amp;&amp;</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_recsrc</span> <span class="o">&amp;&amp;</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">put_recsrc</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">SOUND_CAP_EXCL_INPUT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_devmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">chn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">chn</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">put_volume</span> <span class="o">||</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">put_recsrc</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chn</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_stereodevs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">chn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">chn</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">put_volume</span> <span class="o">&amp;&amp;</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">stereo</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chn</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_recmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">put_recsrc</span> <span class="o">&amp;&amp;</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_recsrc</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* exclusive */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">mask_recsrc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">chn</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">chn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">chn</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">put_recsrc</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chn</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_get_recsrc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">put_recsrc</span> <span class="o">&amp;&amp;</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_recsrc</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* exclusive */</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_recsrc</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">chn</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">chn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">chn</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">get_recsrc</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">get_recsrc</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">active</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span>
					<span class="n">result</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chn</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">oss_recsrc</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_set_recsrc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recsrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chn</span><span class="p">,</span> <span class="n">active</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_recsrc</span> <span class="o">&amp;&amp;</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">put_recsrc</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* exclusive input */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">recsrc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">oss_recsrc</span><span class="p">)</span>
			<span class="n">recsrc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">oss_recsrc</span><span class="p">;</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">put_recsrc</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">ffz</span><span class="p">(</span><span class="o">~</span><span class="n">recsrc</span><span class="p">));</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_recsrc</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">chn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">chn</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">put_recsrc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">recsrc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chn</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">put_recsrc</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">chn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">chn</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">get_recsrc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">get_recsrc</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">active</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span>
					<span class="n">result</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chn</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_get_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">get_volume</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">get_volume</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">stereo</span><span class="p">)</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">right</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">right</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
		<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
	 	<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">right</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_set_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">volume</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">left</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">right</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">stereo</span><span class="p">)</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">put_volume</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">put_volume</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
 	<span class="k">return</span> <span class="p">(</span><span class="n">left</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">right</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_ioctl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fmixer</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_INFO</span>:
			<span class="k">return</span> <span class="n">snd_mixer_oss_info</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">SOUND_OLD_MIXER_INFO</span>:
 			<span class="k">return</span> <span class="n">snd_mixer_oss_info_obsolete</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_WRITE_RECSRC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_mixer_oss_set_recsrc</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">OSS_GETVERSION</span>:
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SNDRV_OSS_VERSION</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">OSS_ALSAEMULVER</span>:
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_READ_DEVMASK</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_mixer_oss_devmask</span><span class="p">(</span><span class="n">fmixer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_READ_STEREODEVS</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_mixer_oss_stereodevs</span><span class="p">(</span><span class="n">fmixer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_READ_RECMASK</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_mixer_oss_recmask</span><span class="p">(</span><span class="n">fmixer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_READ_CAPS</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_mixer_oss_caps</span><span class="p">(</span><span class="n">fmixer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_READ_RECSRC</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_mixer_oss_get_recsrc</span><span class="p">(</span><span class="n">fmixer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">SIOC_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_mixer_oss_set_volume</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">SIOC_OUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_mixer_oss_get_volume</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">snd_mixer_oss_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_mixer_oss_ioctl1</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_mixer_oss_ioctl_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="n">fmixer</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixer_oss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmixer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmixer</span><span class="p">));</span>
	<span class="n">fmixer</span><span class="p">.</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">fmixer</span><span class="p">.</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mixer_oss</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_mixer_oss_ioctl1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="cm">/* all compatible */</span>
<span class="cp">#define snd_mixer_oss_ioctl_compat	snd_mixer_oss_ioctl</span>
<span class="cp">#else</span>
<span class="cp">#define snd_mixer_oss_ioctl_compat	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  REGISTRATION PART</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">snd_mixer_oss_f_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_mixer_oss_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">snd_mixer_oss_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span>	<span class="n">snd_mixer_oss_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span>	<span class="n">snd_mixer_oss_ioctl_compat</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  utilities</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">snd_mixer_oss_conv</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">long</span> <span class="n">omin</span><span class="p">,</span> <span class="kt">long</span> <span class="n">omax</span><span class="p">,</span> <span class="kt">long</span> <span class="n">nmin</span><span class="p">,</span> <span class="kt">long</span> <span class="n">nmax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">orange</span> <span class="o">=</span> <span class="n">omax</span> <span class="o">-</span> <span class="n">omin</span><span class="p">,</span> <span class="n">nrange</span> <span class="o">=</span> <span class="n">nmax</span> <span class="o">-</span> <span class="n">nmin</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">orange</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">nrange</span> <span class="o">*</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">omin</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">orange</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">orange</span> <span class="o">+</span> <span class="n">nmin</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* convert from alsa native to oss values (0-100) */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">snd_mixer_oss_conv1</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">long</span> <span class="n">min</span><span class="p">,</span> <span class="kt">long</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">snd_mixer_oss_conv</span><span class="p">(</span><span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_mixer_oss_conv</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* convert from oss to alsa native values */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">snd_mixer_oss_conv2</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">long</span> <span class="n">min</span><span class="p">,</span> <span class="kt">long</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_mixer_oss_conv</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void snd_mixer_oss_recsrce_set(struct snd_card *card, int slot)</span>
<span class="c">{</span>
<span class="c">	struct snd_mixer_oss *mixer = card-&gt;mixer_oss;</span>
<span class="c">	if (mixer)</span>
<span class="c">		mixer-&gt;mask_recsrc |= 1 &lt;&lt; slot;</span>
<span class="c">}</span>

<span class="c">static int snd_mixer_oss_recsrce_get(struct snd_card *card, int slot)</span>
<span class="c">{</span>
<span class="c">	struct snd_mixer_oss *mixer = card-&gt;mixer_oss;</span>
<span class="c">	if (mixer &amp;&amp; (mixer-&gt;mask_recsrc &amp; (1 &lt;&lt; slot)))</span>
<span class="c">		return 1;</span>
<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cp">#define SNDRV_MIXER_OSS_SIGNATURE		0x65999250</span>

<span class="cp">#define SNDRV_MIXER_OSS_ITEM_GLOBAL	0</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_GSWITCH	1</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_GROUTE	2</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_GVOLUME	3</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_PSWITCH	4</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_PROUTE	5</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_PVOLUME	6</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_CSWITCH	7</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_CROUTE	8</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_CVOLUME	9</span>
<span class="cp">#define SNDRV_MIXER_OSS_ITEM_CAPTURE	10</span>

<span class="cp">#define SNDRV_MIXER_OSS_ITEM_COUNT	11</span>

<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_GLOBAL	(1&lt;&lt;0)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_GSWITCH	(1&lt;&lt;1)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_GROUTE	(1&lt;&lt;2)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_GVOLUME	(1&lt;&lt;3)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_PSWITCH	(1&lt;&lt;4)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_PROUTE	(1&lt;&lt;5)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_PVOLUME	(1&lt;&lt;6)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_CSWITCH	(1&lt;&lt;7)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_CROUTE	(1&lt;&lt;8)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_CVOLUME	(1&lt;&lt;9)</span>
<span class="cp">#define SNDRV_MIXER_OSS_PRESENT_CAPTURE	(1&lt;&lt;10)</span>

<span class="k">struct</span> <span class="n">slot</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">signature</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">present</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_COUNT</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">capture_item</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_assign_table</span> <span class="o">*</span><span class="n">assigned</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">allocated</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define ID_UNKNOWN	((unsigned int)-1)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="nf">snd_mixer_oss_test_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">id</span><span class="p">;</span>
	
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
	<span class="n">id</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_get_volume1_vol</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numid</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">right</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">uctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numid</span> <span class="o">==</span> <span class="n">ID_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_find_numid</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">numid</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">uinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">uctl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">uctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="n">snd_mixer_oss_conv1</span><span class="p">(</span><span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">right</span> <span class="o">=</span> <span class="n">snd_mixer_oss_conv1</span><span class="p">(</span><span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="nl">__unalloc:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
      	<span class="n">kfree</span><span class="p">(</span><span class="n">uctl</span><span class="p">);</span>
      	<span class="n">kfree</span><span class="p">(</span><span class="n">uinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_get_volume1_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numid</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">right</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">route</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">uctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numid</span> <span class="o">==</span> <span class="n">ID_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_find_numid</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">numid</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">uinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">uctl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">uctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">*</span><span class="n">right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">route</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">])</span>
		<span class="o">*</span><span class="n">right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nl">__unalloc:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
      	<span class="n">kfree</span><span class="p">(</span><span class="n">uctl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">uinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_get_volume1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">right</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">right</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_PVOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_get_volume1_vol</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_PVOLUME</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GVOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_get_volume1_vol</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GVOLUME</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GLOBAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_get_volume1_vol</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GLOBAL</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_PSWITCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_get_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_PSWITCH</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GSWITCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_get_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GSWITCH</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_PROUTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_get_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_PROUTE</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GROUTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_get_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GROUTE</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_put_volume1_vol</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numid</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">uctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numid</span> <span class="o">==</span> <span class="n">ID_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_find_numid</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">numid</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">uinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">uctl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">uctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_mixer_oss_conv2</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_mixer_oss_conv2</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
      <span class="nl">__unalloc:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
      	<span class="n">kfree</span><span class="p">(</span><span class="n">uctl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">uinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numid</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">route</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">uctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numid</span> <span class="o">==</span> <span class="n">ID_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_find_numid</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">numid</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">uinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">uctl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">uctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">route</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">right</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unalloc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
      <span class="nl">__unalloc:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
      	<span class="n">kfree</span><span class="p">(</span><span class="n">uctl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">uinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_put_volume1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_PVOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_put_volume1_vol</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_PVOLUME</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CVOLUME</span><span class="p">)</span>
			<span class="n">snd_mixer_oss_put_volume1_vol</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CVOLUME</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CVOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_put_volume1_vol</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CVOLUME</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GVOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_put_volume1_vol</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GVOLUME</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GLOBAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixer_oss_put_volume1_vol</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GLOBAL</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">||</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_PSWITCH</span><span class="p">)</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_PSWITCH</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CSWITCH</span><span class="p">)</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CSWITCH</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GSWITCH</span><span class="p">)</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GSWITCH</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_PROUTE</span><span class="p">)</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_PROUTE</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CROUTE</span><span class="p">)</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CROUTE</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GROUTE</span><span class="p">)</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GROUTE</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_PSWITCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_PSWITCH</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CSWITCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CSWITCH</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GSWITCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GSWITCH</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_PROUTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_PROUTE</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CROUTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CROUTE</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_GROUTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_GROUTE</span><span class="p">],</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_get_recsrc1_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	
	<span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_mixer_oss_get_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CSWITCH</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">||</span> <span class="n">right</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_get_recsrc1_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="o">*</span><span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	
	<span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_mixer_oss_get_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CROUTE</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">||</span> <span class="n">right</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_put_recsrc1_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CSWITCH</span><span class="p">],</span> <span class="n">active</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_put_recsrc1_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="n">snd_mixer_oss_put_volume1_sw</span><span class="p">(</span><span class="n">fmixer</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">SNDRV_MIXER_OSS_ITEM_CROUTE</span><span class="p">],</span> <span class="n">active</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_get_recsrc2</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">active_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">uctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	
	<span class="n">uinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">uctl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">uctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__free_only</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_mixer_oss_test_id</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="s">&quot;Capture Source&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">kctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">mask_recsrc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">SNDRV_MIXER_OSS_SIGNATURE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CAPTURE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">capture_item</span> <span class="o">==</span> <span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">active_index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nl">__unlock:</span>
     	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
      <span class="nl">__free_only:</span>
      	<span class="n">kfree</span><span class="p">(</span><span class="n">uctl</span><span class="p">);</span>
      	<span class="n">kfree</span><span class="p">(</span><span class="n">uinfo</span><span class="p">);</span>
      	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_put_recsrc2</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_file</span> <span class="o">*</span><span class="n">fmixer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">active_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">uctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">uinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">uctl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uctl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">uctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__free_only</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_mixer_oss_test_id</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="s">&quot;Capture Source&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">kctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">mask_recsrc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">SNDRV_MIXER_OSS_SIGNATURE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CAPTURE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">active_index</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">capture_item</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">fmixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nl">__unlock:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
      <span class="nl">__free_only:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">uctl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">uinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">snd_mixer_oss_assign_table</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">oss_id</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_build_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="n">kcontrol</span> <span class="o">=</span> <span class="n">snd_mixer_oss_test_id</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">numid</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">numid</span><span class="p">;</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">item</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_slot_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">chn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chn</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_slot_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">rslot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">rslot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span> <span class="cm">/* remember this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rslot</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">)</span>
		<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">(</span><span class="n">rslot</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rslot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rslot</span><span class="p">));</span>
	<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* In a separate function to keep gcc 3.2 happy - do NOT merge this in</span>
<span class="cm">   snd_mixer_oss_build_input! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_build_test_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_mixer_oss_assign_table</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_GLOBAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s Switch&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_GSWITCH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s Route&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_GROUTE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s Volume&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_GVOLUME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s Playback Switch&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_PSWITCH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s Playback Route&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_PROUTE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s Playback Volume&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_PVOLUME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s Capture Switch&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_CSWITCH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s Capture Route&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_CROUTE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s Capture Volume&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixer_oss_build_test</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">SNDRV_MIXER_OSS_ITEM_CVOLUME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * build an OSS mixer element.</span>
<span class="cm"> * ptr_allocated means the entry is dynamically allocated (change via proc file).</span>
<span class="cm"> * when replace_old = 1, the old entry is replaced with the new one.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_build_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_mixer_oss_assign_table</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ptr_allocated</span><span class="p">,</span> <span class="kt">int</span> <span class="n">replace_old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">rslot</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>	
	
	<span class="cm">/* check if already assigned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">oss_id</span><span class="p">].</span><span class="n">get_volume</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">replace_old</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">slot</span><span class="p">.</span><span class="n">numid</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slot</span><span class="p">.</span><span class="n">numid</span><span class="p">));</span> <span class="cm">/* ID_UNKNOWN */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_mixer_oss_build_test_all</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_mixer_oss_test_id</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="s">&quot;Capture Source&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">;</span>

		<span class="n">uinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">uinfo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
			
		<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;Master&quot;</span><span class="p">))</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;Mix&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;Master Mono&quot;</span><span class="p">))</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;Mix Mono&quot;</span><span class="p">);</span>
		<span class="n">slot</span><span class="p">.</span><span class="n">capture_item</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">str</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">slot</span><span class="p">.</span><span class="n">present</span> <span class="o">|=</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CAPTURE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">slot</span><span class="p">.</span><span class="n">capture_item</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">slot</span><span class="p">.</span><span class="n">capture_item</span> <span class="o">&lt;</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">;</span> <span class="n">slot</span><span class="p">.</span><span class="n">capture_item</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">slot</span><span class="p">.</span><span class="n">capture_item</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">str</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">slot</span><span class="p">.</span><span class="n">present</span> <span class="o">|=</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CAPTURE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">uinfo</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="p">.</span><span class="n">present</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">slot</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">pslot</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pslot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">SNDRV_MIXER_OSS_SIGNATURE</span><span class="p">;</span>
		<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">assigned</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="n">ptr_allocated</span><span class="p">;</span>
		<span class="n">rslot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">oss_id</span><span class="p">];</span>
		<span class="n">mixer_slot_clear</span><span class="p">(</span><span class="n">rslot</span><span class="p">);</span>
		<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">slot</span><span class="p">.</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">get_volume</span> <span class="o">=</span> <span class="n">snd_mixer_oss_get_volume1</span><span class="p">;</span>
		<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">put_volume</span> <span class="o">=</span> <span class="n">snd_mixer_oss_put_volume1</span><span class="p">;</span>
		<span class="cm">/* note: ES18xx have both Capture Source and XX Capture Volume !!! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="p">.</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CSWITCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">get_recsrc</span> <span class="o">=</span> <span class="n">snd_mixer_oss_get_recsrc1_sw</span><span class="p">;</span>
			<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">put_recsrc</span> <span class="o">=</span> <span class="n">snd_mixer_oss_put_recsrc1_sw</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="p">.</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CROUTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">get_recsrc</span> <span class="o">=</span> <span class="n">snd_mixer_oss_get_recsrc1_route</span><span class="p">;</span>
			<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">put_recsrc</span> <span class="o">=</span> <span class="n">snd_mixer_oss_put_recsrc1_route</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="p">.</span><span class="n">present</span> <span class="o">&amp;</span> <span class="n">SNDRV_MIXER_OSS_PRESENT_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">mask_recsrc</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">oss_id</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pslot</span><span class="p">;</span>
		<span class="n">rslot</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_mixer_oss_slot_free</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="cp">#define MIXER_VOL(name) [SOUND_MIXER_##name] = #name</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oss_mixer_names</span><span class="p">[</span><span class="n">SNDRV_OSS_MAX_MIXERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">VOLUME</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">BASS</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">TREBLE</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">SYNTH</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">PCM</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">SPEAKER</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">LINE</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">MIC</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">CD</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">IMIX</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">ALTPCM</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">RECLEV</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">IGAIN</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">OGAIN</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">LINE1</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">LINE2</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">LINE3</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">DIGITAL1</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">DIGITAL2</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">DIGITAL3</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">PHONEIN</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">PHONEOUT</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">VIDEO</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">RADIO</span><span class="p">),</span>
	<span class="n">MIXER_VOL</span><span class="p">(</span><span class="n">MONITOR</span><span class="p">),</span>
<span class="p">};</span>
	
<span class="cm">/*</span>
<span class="cm"> *  /proc interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SNDRV_OSS_MAX_MIXERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">oss_mixer_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="p">)</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">oss_mixer_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">p</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				    <span class="n">p</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;\&quot;</span><span class="s"> 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">str</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">idxstr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss_assign_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_info_get_line</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_info_get_str</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">SNDRV_OSS_MAX_MIXERS</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oss_mixer_names</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">oss_mixer_names</span><span class="p">[</span><span class="n">ch</span><span class="p">],</span> <span class="n">str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="n">SNDRV_OSS_MAX_MIXERS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mixer_oss: invalid OSS volume &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">snd_info_get_str</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">cptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* remove the entry */</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
			<span class="n">mixer_slot_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_info_get_str</span><span class="p">(</span><span class="n">idxstr</span><span class="p">,</span> <span class="n">cptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idxstr</span><span class="p">));</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">idxstr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* too big */</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mixer_oss: invalid index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="p">)</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">assigned</span> <span class="o">&amp;&amp;</span>
		    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">idx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">str</span><span class="p">))</span>
			<span class="cm">/* not changed */</span>
			<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tbl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">tbl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mixer_oss: no memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">oss_id</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_mixer_oss_build_input</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="nl">__unlock:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;oss_mixer&quot;</span><span class="p">,</span>
					   <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">proc_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_mixer_oss_proc_read</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_mixer_oss_proc_write</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">mixer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">proc_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_proc_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">proc_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_PROC_FS */</span><span class="cp"></span>
<span class="cp">#define snd_mixer_oss_proc_init(mix)</span>
<span class="cp">#define snd_mixer_oss_proc_done(mix)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixer_oss_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_mixer_oss_assign_table</span> <span class="n">table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_VOLUME</span><span class="p">,</span> 	<span class="s">&quot;Master&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_VOLUME</span><span class="p">,</span> 	<span class="s">&quot;Front&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_BASS</span><span class="p">,</span>	<span class="s">&quot;Tone Control - Bass&quot;</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_TREBLE</span><span class="p">,</span>	<span class="s">&quot;Tone Control - Treble&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_SYNTH</span><span class="p">,</span>	<span class="s">&quot;Synth&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_SYNTH</span><span class="p">,</span>	<span class="s">&quot;FM&quot;</span><span class="p">,</span>			<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_SYNTH</span><span class="p">,</span>	<span class="s">&quot;Music&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_PCM</span><span class="p">,</span>	<span class="s">&quot;PCM&quot;</span><span class="p">,</span>			<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_SPEAKER</span><span class="p">,</span>	<span class="s">&quot;Beep&quot;</span><span class="p">,</span> 		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_SPEAKER</span><span class="p">,</span>	<span class="s">&quot;PC Speaker&quot;</span><span class="p">,</span> 		<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_SPEAKER</span><span class="p">,</span>	<span class="s">&quot;Speaker&quot;</span><span class="p">,</span> 		<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_LINE</span><span class="p">,</span>	<span class="s">&quot;Line&quot;</span><span class="p">,</span> 		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_MIC</span><span class="p">,</span>	<span class="s">&quot;Mic&quot;</span><span class="p">,</span> 			<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_CD</span><span class="p">,</span>	<span class="s">&quot;CD&quot;</span><span class="p">,</span> 			<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_IMIX</span><span class="p">,</span>	<span class="s">&quot;Monitor Mix&quot;</span><span class="p">,</span> 		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_ALTPCM</span><span class="p">,</span>	<span class="s">&quot;PCM&quot;</span><span class="p">,</span>			<span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_ALTPCM</span><span class="p">,</span>	<span class="s">&quot;Headphone&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_ALTPCM</span><span class="p">,</span>	<span class="s">&quot;Wave&quot;</span><span class="p">,</span>			<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_RECLEV</span><span class="p">,</span>	<span class="s">&quot;-- nothing --&quot;</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_IGAIN</span><span class="p">,</span>	<span class="s">&quot;Capture&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_OGAIN</span><span class="p">,</span>	<span class="s">&quot;Playback&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_LINE1</span><span class="p">,</span>	<span class="s">&quot;Aux&quot;</span><span class="p">,</span>			<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_LINE2</span><span class="p">,</span>	<span class="s">&quot;Aux&quot;</span><span class="p">,</span>			<span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_LINE3</span><span class="p">,</span>	<span class="s">&quot;Aux&quot;</span><span class="p">,</span>			<span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_DIGITAL1</span><span class="p">,</span>	<span class="s">&quot;Digital&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_DIGITAL1</span><span class="p">,</span>	<span class="s">&quot;IEC958&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_DIGITAL1</span><span class="p">,</span>	<span class="s">&quot;IEC958 Optical&quot;</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_DIGITAL1</span><span class="p">,</span>	<span class="s">&quot;IEC958 Coaxial&quot;</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_DIGITAL2</span><span class="p">,</span>	<span class="s">&quot;Digital&quot;</span><span class="p">,</span>		<span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_DIGITAL3</span><span class="p">,</span>	<span class="s">&quot;Digital&quot;</span><span class="p">,</span>		<span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_PHONEIN</span><span class="p">,</span>	<span class="s">&quot;Phone&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_PHONEOUT</span><span class="p">,</span>	<span class="s">&quot;Master Mono&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_PHONEOUT</span><span class="p">,</span>	<span class="s">&quot;Speaker&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span> <span class="cm">/*fallback*/</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_PHONEOUT</span><span class="p">,</span>	<span class="s">&quot;Mono&quot;</span><span class="p">,</span>			<span class="mi">0</span> <span class="p">},</span> <span class="cm">/*fallback*/</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_PHONEOUT</span><span class="p">,</span>	<span class="s">&quot;Phone&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span> <span class="cm">/* fallback */</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_VIDEO</span><span class="p">,</span>	<span class="s">&quot;Video&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_RADIO</span><span class="p">,</span>	<span class="s">&quot;Radio&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SOUND_MIXER_MONITOR</span><span class="p">,</span>	<span class="s">&quot;Monitor&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">table</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_mixer_oss_build_input</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">mask_recsrc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_recsrc</span> <span class="o">=</span> <span class="n">snd_mixer_oss_get_recsrc2</span><span class="p">;</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">put_recsrc</span> <span class="o">=</span> <span class="n">snd_mixer_oss_put_recsrc2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_free1</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
 
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mixer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">mixer</span> <span class="o">!=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mixer_oss</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">mixer_oss</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">SNDRV_OSS_MAX_MIXERS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_mixer_oss_slot</span> <span class="o">*</span><span class="n">chn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chn</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">)</span>
			<span class="n">chn</span><span class="o">-&gt;</span><span class="n">private_free</span><span class="p">(</span><span class="n">chn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mixer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixer_oss_notify_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixer_oss</span> <span class="o">*</span><span class="n">mixer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SND_MIXER_OSS_NOTIFY_REGISTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">mixer</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mixer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mixer%i%i&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_register_oss_device</span><span class="p">(</span><span class="n">SNDRV_OSS_DEVICE_TYPE_MIXER</span><span class="p">,</span>
						   <span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">snd_mixer_oss_f_ops</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span>
						   <span class="n">name</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to register OSS mixer device %i:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mixer</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">oss_dev_alloc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">)</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="cp">#ifdef SNDRV_OSS_INFO_DEV_MIXERS</span>
		<span class="n">snd_oss_info_register</span><span class="p">(</span><span class="n">SNDRV_OSS_INFO_DEV_MIXERS</span><span class="p">,</span>
				      <span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				      <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">SNDRV_OSS_MAX_MIXERS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">number</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">mixer_oss</span> <span class="o">=</span> <span class="n">mixer</span><span class="p">;</span>
		<span class="n">snd_mixer_oss_build</span><span class="p">(</span><span class="n">mixer</span><span class="p">);</span>
		<span class="n">snd_mixer_oss_proc_init</span><span class="p">(</span><span class="n">mixer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mixer</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mixer_oss</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">oss_dev_alloc</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef SNDRV_OSS_INFO_DEV_MIXERS</span>
			<span class="n">snd_oss_info_unregister</span><span class="p">(</span><span class="n">SNDRV_OSS_INFO_DEV_MIXERS</span><span class="p">,</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">snd_unregister_oss_device</span><span class="p">(</span><span class="n">SNDRV_OSS_DEVICE_TYPE_MIXER</span><span class="p">,</span> <span class="n">mixer</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">oss_dev_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SND_MIXER_OSS_NOTIFY_DISCONNECT</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">snd_mixer_oss_proc_done</span><span class="p">(</span><span class="n">mixer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">snd_mixer_oss_free1</span><span class="p">(</span><span class="n">mixer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">alsa_mixer_oss_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	
	<span class="n">snd_mixer_oss_notify_callback</span> <span class="o">=</span> <span class="n">snd_mixer_oss_notify_handler</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cards</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
			<span class="n">snd_mixer_oss_notify_handler</span><span class="p">(</span><span class="n">snd_cards</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">SND_MIXER_OSS_NOTIFY_REGISTER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">alsa_mixer_oss_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">snd_mixer_oss_notify_callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_cards</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
			<span class="n">snd_mixer_oss_notify_handler</span><span class="p">(</span><span class="n">snd_cards</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">SND_MIXER_OSS_NOTIFY_FREE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">alsa_mixer_oss_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">alsa_mixer_oss_exit</span><span class="p">)</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_mixer_oss_ioctl_card</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
