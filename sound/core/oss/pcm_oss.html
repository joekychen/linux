<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › core › oss › pcm_oss.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pcm_oss.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Digital Audio (PCM) abstract layer / OSS compatible</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define PLUGIN_DEBUG</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define OSS_DEBUG</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/math64.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/minors.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &quot;pcm_plugin.h&quot;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;linux/soundcard.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/mixer_oss.h&gt;</span>

<span class="cp">#define OSS_ALSAEMULVER		_SIOR (&#39;M&#39;, 249, int)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dsp_map</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">adsp_map</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nonblock_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;, Abramo Bagnara &lt;abramo@alsa-project.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PCM OSS emulation for ALSA.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dsp_map</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dsp_map</span><span class="p">,</span> <span class="s">&quot;PCM device number assigned to 1st OSS device.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">adsp_map</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adsp_map</span><span class="p">,</span> <span class="s">&quot;PCM device number assigned to 2nd OSS device.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nonblock_open</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nonblock_open</span><span class="p">,</span> <span class="s">&quot;Don&#39;t block opening busy PCM devices.&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_SNDRV_MINOR</span><span class="p">(</span><span class="n">SNDRV_MINOR_OSS_PCM</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_SNDRV_MINOR</span><span class="p">(</span><span class="n">SNDRV_MINOR_OSS_PCM1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_pcm_oss_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_pcm_oss_get_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_pcm_oss_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">mm_segment_t</span> <span class="nf">snd_enter_user</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_leave_user</span><span class="p">(</span><span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * helper functions to process hw_params</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_interval_refine_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="kt">int</span> <span class="n">openmin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">openmin</span> <span class="o">=</span> <span class="n">openmin</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">==</span> <span class="n">min</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">openmin</span> <span class="o">&amp;&amp;</span> <span class="n">openmin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">openmin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">openmin</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">min</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">openmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_interval_checkempty</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_interval_none</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_interval_refine_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="n">openmax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">openmax</span> <span class="o">=</span> <span class="n">openmax</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">==</span> <span class="n">max</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">openmax</span> <span class="o">&amp;&amp;</span> <span class="n">openmax</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">openmax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">openmax</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">max</span><span class="o">--</span><span class="p">;</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">openmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_interval_checkempty</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_interval_none</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_interval_refine_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">openmin</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">openmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_pcm_hw_param_value_min</span>
<span class="cm"> * @params: the hw_params instance</span>
<span class="cm"> * @var: parameter to retrieve</span>
<span class="cm"> * @dir: pointer to the direction (-1,0,1) or NULL</span>
<span class="cm"> *</span>
<span class="cm"> * Return the minimum value for field PAR.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">snd_pcm_hw_param_value_min</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			   <span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_is_mask</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_mask_min</span><span class="p">(</span><span class="n">hw_param_mask_c</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_is_interval</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw_param_interval_c</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">openmin</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_interval_min</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_pcm_hw_param_value_max</span>
<span class="cm"> * @params: the hw_params instance</span>
<span class="cm"> * @var: parameter to retrieve</span>
<span class="cm"> * @dir: pointer to the direction (-1,0,1) or NULL</span>
<span class="cm"> *</span>
<span class="cm"> * Return the maximum value for field PAR.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">snd_pcm_hw_param_value_max</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			   <span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_is_mask</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_mask_max</span><span class="p">(</span><span class="n">hw_param_mask_c</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_is_interval</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw_param_interval_c</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">openmax</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_interval_max</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_snd_pcm_hw_param_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_mask</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="n">snd_mask_refine</span><span class="p">(</span><span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">cmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">rmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_hw_param_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_mask</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">_snd_pcm_hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">rmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_refine</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_snd_pcm_hw_param_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">val</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_is_mask</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="n">snd_mask_refine_min</span><span class="p">(</span><span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span>
					      <span class="n">val</span> <span class="o">+</span> <span class="o">!!</span><span class="n">open</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw_is_interval</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="n">snd_interval_refine_min</span><span class="p">(</span><span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span>
						  <span class="n">val</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">cmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">rmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_pcm_hw_param_min</span>
<span class="cm"> * @pcm: PCM instance</span>
<span class="cm"> * @params: the hw_params instance</span>
<span class="cm"> * @var: parameter to retrieve</span>
<span class="cm"> * @val: minimal value</span>
<span class="cm"> * @dir: pointer to the direction (-1,0,1) or NULL</span>
<span class="cm"> *</span>
<span class="cm"> * Inside configuration space defined by PARAMS remove from PAR all </span>
<span class="cm"> * values &lt; VAL. Reduce configuration space accordingly.</span>
<span class="cm"> * Return new minimum or -EINVAL if the configuration space is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_hw_param_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">_snd_pcm_hw_param_min</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">dir</span> <span class="o">?</span> <span class="o">*</span><span class="n">dir</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">rmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_refine</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_param_value_min</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_snd_pcm_hw_param_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">val</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_is_mask</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">open</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_mask_none</span><span class="p">(</span><span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">));</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="n">snd_mask_refine_max</span><span class="p">(</span><span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span>
						      <span class="n">val</span> <span class="o">-</span> <span class="o">!!</span><span class="n">open</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw_is_interval</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="n">snd_interval_refine_max</span><span class="p">(</span><span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span>
						  <span class="n">val</span><span class="p">,</span> <span class="n">open</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">cmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">rmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_pcm_hw_param_max</span>
<span class="cm"> * @pcm: PCM instance</span>
<span class="cm"> * @params: the hw_params instance</span>
<span class="cm"> * @var: parameter to retrieve</span>
<span class="cm"> * @val: maximal value</span>
<span class="cm"> * @dir: pointer to the direction (-1,0,1) or NULL</span>
<span class="cm"> *</span>
<span class="cm"> * Inside configuration space defined by PARAMS remove from PAR all </span>
<span class="cm"> *  values &gt;= VAL + 1. Reduce configuration space accordingly.</span>
<span class="cm"> *  Return new maximum or -EINVAL if the configuration space is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_hw_param_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">_snd_pcm_hw_param_max</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">dir</span> <span class="o">?</span> <span class="o">*</span><span class="n">dir</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">rmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_refine</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_param_value_max</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">boundary_sub</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adir</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bdir</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adir</span> <span class="o">=</span> <span class="n">adir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">adir</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bdir</span> <span class="o">=</span> <span class="n">bdir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">bdir</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cdir</span> <span class="o">=</span> <span class="n">adir</span> <span class="o">-</span> <span class="n">bdir</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cdir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cdir</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">boundary_lt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adir</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">--</span><span class="p">;</span>
		<span class="n">adir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">adir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">--</span><span class="p">;</span>
		<span class="n">bdir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bdir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bdir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="o">||</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">adir</span> <span class="o">&lt;</span> <span class="n">bdir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return 1 if min is nearer to best than max */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">boundary_nearer</span><span class="p">(</span><span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mindir</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">best</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bestdir</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dmin</span><span class="p">,</span> <span class="n">dmindir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dmax</span><span class="p">,</span> <span class="n">dmaxdir</span><span class="p">;</span>
	<span class="n">boundary_sub</span><span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="n">bestdir</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">mindir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmindir</span><span class="p">);</span>
	<span class="n">boundary_sub</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">maxdir</span><span class="p">,</span> <span class="n">best</span><span class="p">,</span> <span class="n">bestdir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmaxdir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">boundary_lt</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">dmindir</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="n">dmaxdir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_pcm_hw_param_near</span>
<span class="cm"> * @pcm: PCM instance</span>
<span class="cm"> * @params: the hw_params instance</span>
<span class="cm"> * @var: parameter to retrieve</span>
<span class="cm"> * @best: value to set</span>
<span class="cm"> * @dir: pointer to the direction (-1,0,1) or NULL</span>
<span class="cm"> *</span>
<span class="cm"> * Inside configuration space defined by PARAMS set PAR to the available value</span>
<span class="cm"> * nearest to VAL. Reduce configuration space accordingly.</span>
<span class="cm"> * This function cannot be called for SNDRV_PCM_HW_PARAM_ACCESS,</span>
<span class="cm"> * SNDRV_PCM_HW_PARAM_FORMAT, SNDRV_PCM_HW_PARAM_SUBFORMAT.</span>
<span class="cm"> * Return the value found.</span>
<span class="cm">  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_hw_param_near</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">best</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">save</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">saved_min</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mindir</span><span class="p">,</span> <span class="n">maxdir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valdir</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">?</span> <span class="o">*</span><span class="n">dir</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* FIXME */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span>
		<span class="n">best</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">max</span> <span class="o">=</span> <span class="n">best</span><span class="p">;</span>
	<span class="n">mindir</span> <span class="o">=</span> <span class="n">maxdir</span> <span class="o">=</span> <span class="n">valdir</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxdir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">maxdir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">maxdir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">maxdir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">maxdir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">max</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">save</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">save</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">save</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="o">*</span><span class="n">save</span> <span class="o">=</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="n">saved_min</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_min</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mindir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">_end</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">min</span> <span class="o">==</span> <span class="n">saved_min</span> <span class="o">&amp;&amp;</span> <span class="n">mindir</span> <span class="o">==</span> <span class="n">valdir</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">_end</span><span class="p">;</span>
		<span class="n">params1</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params1</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">save</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">params1</span> <span class="o">=</span> <span class="o">*</span><span class="n">save</span><span class="p">;</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_max</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params1</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxdir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">params1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">_end</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boundary_nearer</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">maxdir</span><span class="p">,</span> <span class="n">best</span><span class="p">,</span> <span class="n">valdir</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">mindir</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">*</span><span class="n">params1</span><span class="p">;</span>
			<span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">params1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">*</span><span class="n">save</span><span class="p">;</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_max</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxdir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">save</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">_end:</span>
 	<span class="n">kfree</span><span class="p">(</span><span class="n">save</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_last</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_first</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_snd_pcm_hw_param_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_is_mask</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_mask</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">snd_mask_none</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">val</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">val</span><span class="o">--</span><span class="p">;</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="n">snd_mask_refine_set</span><span class="p">(</span><span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw_is_interval</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">snd_interval_none</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="n">snd_interval_refine_set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">openmin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">openmax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">t</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">t</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="n">t</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">val</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">cmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">rmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_pcm_hw_param_set</span>
<span class="cm"> * @pcm: PCM instance</span>
<span class="cm"> * @params: the hw_params instance</span>
<span class="cm"> * @var: parameter to retrieve</span>
<span class="cm"> * @val: value to set</span>
<span class="cm"> * @dir: pointer to the direction (-1,0,1) or NULL</span>
<span class="cm"> *</span>
<span class="cm"> * Inside configuration space defined by PARAMS remove from PAR all </span>
<span class="cm"> * values != VAL. Reduce configuration space accordingly.</span>
<span class="cm"> *  Return VAL or -EINVAL if the configuration space is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_hw_param_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">_snd_pcm_hw_param_set</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">rmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_refine</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_param_value</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_snd_pcm_hw_param_setinteger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					<span class="n">snd_pcm_hw_param_t</span> <span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="n">snd_interval_setinteger</span><span class="p">(</span><span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">var</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">cmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">rmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">var</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>
	
<span class="cm">/*</span>
<span class="cm"> * plugin</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_SND_PCM_OSS_PLUGINS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_plugin_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_plugin</span> <span class="o">*</span><span class="n">plugin</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	
	<span class="n">plugin</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">plugin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">snd_pcm_plugin_free</span><span class="p">(</span><span class="n">plugin</span><span class="p">);</span>
		<span class="n">plugin</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_plugin_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_plugin</span> <span class="o">*</span><span class="n">plugin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">-&gt;</span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">plugin</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="p">;</span>
	<span class="n">plugin</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_last</span> <span class="o">=</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_pcm_plugin_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_plugin</span> <span class="o">*</span><span class="n">plugin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">-&gt;</span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">plugin</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">plugin</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_last</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_last</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_last</span> <span class="o">=</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SND_PCM_OSS_PLUGINS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">snd_pcm_oss_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">long</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">frames_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_size</span> <span class="o">==</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="cp">#if BITS_PER_LONG &gt;= 64</span>
	<span class="k">return</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_bytes</span> <span class="o">*</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">buffer_size</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="p">{</span>
		<span class="n">u64</span> <span class="n">bsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_bytes</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bytes</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">bsize</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">snd_pcm_alsa_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">long</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_size</span> <span class="o">==</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="p">(</span><span class="n">buffer_size</span> <span class="o">*</span> <span class="n">bytes</span><span class="p">)</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="n">snd_pcm_uframes_t</span> <span class="nf">get_hw_ptr_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw_ptr_interrupt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* define extended formats in the recent OSS versions (if any) */</span>
<span class="cm">/* linear formats */</span>
<span class="cp">#define AFMT_S32_LE      0x00001000</span>
<span class="cp">#define AFMT_S32_BE      0x00002000</span>
<span class="cp">#define AFMT_S24_LE      0x00008000</span>
<span class="cp">#define AFMT_S24_BE      0x00010000</span>
<span class="cp">#define AFMT_S24_PACKED  0x00040000</span>

<span class="cm">/* other supported formats */</span>
<span class="cp">#define AFMT_FLOAT       0x00004000</span>
<span class="cp">#define AFMT_SPDIF_RAW   0x00020000</span>

<span class="cm">/* unsupported formats */</span>
<span class="cp">#define AFMT_AC3         0x00000400</span>
<span class="cp">#define AFMT_VORBIS      0x00000800</span>

<span class="k">static</span> <span class="n">snd_pcm_format_t</span> <span class="nf">snd_pcm_oss_format_from</span><span class="p">(</span><span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AFMT_MU_LAW</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_MU_LAW</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_A_LAW</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_A_LAW</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_IMA_ADPCM</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_IMA_ADPCM</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_U8</span>:		<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_U8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S16_LE</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S16_BE</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_S16_BE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S8</span>:		<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_S8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_U16_LE</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_U16_LE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_U16_BE</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_U16_BE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_MPEG</span>:		<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_MPEG</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S32_LE</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S32_BE</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_S32_BE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S24_LE</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_S24_LE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S24_BE</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_S24_BE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S24_PACKED</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_S24_3LE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_FLOAT</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_FLOAT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_SPDIF_RAW</span>:	<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_IEC958_SUBFRAME</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="k">return</span> <span class="n">SNDRV_PCM_FORMAT_U8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_format_to</span><span class="p">(</span><span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_MU_LAW</span>:	<span class="k">return</span> <span class="n">AFMT_MU_LAW</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_A_LAW</span>:	<span class="k">return</span> <span class="n">AFMT_A_LAW</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_IMA_ADPCM</span>:	<span class="k">return</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U8</span>:		<span class="k">return</span> <span class="n">AFMT_U8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:	<span class="k">return</span> <span class="n">AFMT_S16_LE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_BE</span>:	<span class="k">return</span> <span class="n">AFMT_S16_BE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S8</span>:		<span class="k">return</span> <span class="n">AFMT_S8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U16_LE</span>:	<span class="k">return</span> <span class="n">AFMT_U16_LE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U16_BE</span>:	<span class="k">return</span> <span class="n">AFMT_U16_BE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_MPEG</span>:		<span class="k">return</span> <span class="n">AFMT_MPEG</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span>:	<span class="k">return</span> <span class="n">AFMT_S32_LE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_BE</span>:	<span class="k">return</span> <span class="n">AFMT_S32_BE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_LE</span>:	<span class="k">return</span> <span class="n">AFMT_S24_LE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_BE</span>:	<span class="k">return</span> <span class="n">AFMT_S24_BE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_3LE</span>:	<span class="k">return</span> <span class="n">AFMT_S24_PACKED</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_FLOAT</span>:	<span class="k">return</span> <span class="n">AFMT_FLOAT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_IEC958_SUBFRAME</span>: <span class="k">return</span> <span class="n">AFMT_SPDIF_RAW</span><span class="p">;</span>
	<span class="nl">default:</span>			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_period_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> 
				   <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">oss_params</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">slave_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">oss_buffer_size</span><span class="p">,</span> <span class="n">oss_period_size</span><span class="p">,</span> <span class="n">oss_periods</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">min_period_size</span><span class="p">,</span> <span class="n">max_period_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">oss_frame_size</span><span class="p">;</span>

	<span class="n">oss_frame_size</span> <span class="o">=</span> <span class="n">snd_pcm_format_physical_width</span><span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">oss_params</span><span class="p">))</span> <span class="o">*</span>
			 <span class="n">params_channels</span><span class="p">(</span><span class="n">oss_params</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">oss_buffer_size</span> <span class="o">=</span> <span class="n">snd_pcm_plug_client_size</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
						   <span class="n">snd_pcm_hw_param_value_max</span><span class="p">(</span><span class="n">slave_params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">*</span> <span class="n">oss_frame_size</span><span class="p">;</span>
	<span class="n">oss_buffer_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ld2</span><span class="p">(</span><span class="n">oss_buffer_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oss_buffer_size</span> <span class="o">&gt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">mmap_bytes</span><span class="p">)</span>
			<span class="n">oss_buffer_size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">mmap_bytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">period_size</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">oss_period_size</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">period_size</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">fragshift</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">oss_period_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">fragshift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">&gt;</span> <span class="n">oss_buffer_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">oss_period_size</span> <span class="o">=</span> <span class="n">oss_buffer_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sd</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">bytes_per_sec</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">oss_params</span><span class="p">)</span> <span class="o">*</span> <span class="n">snd_pcm_format_physical_width</span><span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">oss_params</span><span class="p">))</span> <span class="o">*</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">oss_params</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">oss_period_size</span> <span class="o">=</span> <span class="n">oss_buffer_size</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">oss_period_size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">&gt;</span> <span class="n">bytes_per_sec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">subdivision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">/</span> <span class="n">sd</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
				<span class="n">sd</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">/</span> <span class="n">sd</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
				<span class="n">sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sd</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">subdivision</span><span class="p">;</span>
		<span class="n">oss_period_size</span> <span class="o">/=</span> <span class="n">sd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">oss_period_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">min_period_size</span> <span class="o">=</span> <span class="n">snd_pcm_plug_client_size</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
						   <span class="n">snd_pcm_hw_param_value_min</span><span class="p">(</span><span class="n">slave_params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">));</span>
	<span class="n">min_period_size</span> <span class="o">*=</span> <span class="n">oss_frame_size</span><span class="p">;</span>
	<span class="n">min_period_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ld2</span><span class="p">(</span><span class="n">min_period_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">&lt;</span> <span class="n">min_period_size</span><span class="p">)</span>
		<span class="n">oss_period_size</span> <span class="o">=</span> <span class="n">min_period_size</span><span class="p">;</span>

	<span class="n">max_period_size</span> <span class="o">=</span> <span class="n">snd_pcm_plug_client_size</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
						   <span class="n">snd_pcm_hw_param_value_max</span><span class="p">(</span><span class="n">slave_params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">));</span>
	<span class="n">max_period_size</span> <span class="o">*=</span> <span class="n">oss_frame_size</span><span class="p">;</span>
	<span class="n">max_period_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ld2</span><span class="p">(</span><span class="n">max_period_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">&gt;</span> <span class="n">max_period_size</span><span class="p">)</span>
		<span class="n">oss_period_size</span> <span class="o">=</span> <span class="n">max_period_size</span><span class="p">;</span>

	<span class="n">oss_periods</span> <span class="o">=</span> <span class="n">oss_buffer_size</span> <span class="o">/</span> <span class="n">oss_period_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">periods</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">oss_periods</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">periods</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_value_max</span><span class="p">(</span><span class="n">slave_params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">maxfrags</span> <span class="o">&amp;&amp;</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">maxfrags</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">maxfrags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oss_periods</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span>
		<span class="n">oss_periods</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_value_min</span><span class="p">(</span><span class="n">slave_params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oss_periods</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span>
		<span class="n">oss_periods</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">*</span> <span class="n">oss_periods</span> <span class="o">&gt;</span> <span class="n">oss_buffer_size</span><span class="p">)</span>
		<span class="n">oss_period_size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">=</span> <span class="n">oss_period_size</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">periods</span> <span class="o">=</span> <span class="n">oss_periods</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">choose_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">best_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="n">prev</span><span class="p">;</span>

	<span class="n">save</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">save</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">save</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="o">*</span><span class="n">save</span> <span class="o">=</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="n">it</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>

	<span class="cm">/* try multiples of the best rate */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">best_rate</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">rate</span> <span class="o">||</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">==</span> <span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">openmax</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&lt;</span> <span class="n">rate</span> <span class="o">||</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">==</span> <span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">openmin</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_set</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
						   <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
						   <span class="n">rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">save</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">*</span><span class="n">save</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">+=</span> <span class="n">best_rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="n">prev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* not found, use the nearest rate */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_param_near</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="n">best_rate</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_change_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">sparams</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_sw_params</span> <span class="o">*</span><span class="n">sw_params</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">oss_buffer_size</span><span class="p">,</span> <span class="n">oss_period_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">oss_frame_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direct</span><span class="p">;</span>
	<span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">,</span> <span class="n">sformat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mask</span> <span class="n">sformat_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mask</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="n">sw_params</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sw_params</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">params</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">sparams</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sparams</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sw_params</span> <span class="o">||</span> <span class="o">!</span><span class="n">params</span> <span class="o">||</span> <span class="o">!</span><span class="n">sparams</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;No memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span>
		<span class="n">direct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">direct</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">direct</span><span class="p">;</span>

	<span class="n">_snd_pcm_hw_params_any</span><span class="p">(</span><span class="n">sparams</span><span class="p">);</span>
	<span class="n">_snd_pcm_hw_param_setinteger</span><span class="p">(</span><span class="n">sparams</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>
	<span class="n">_snd_pcm_hw_param_min</span><span class="p">(</span><span class="n">sparams</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_mask_none</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span>
		<span class="n">snd_mask_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">SNDRV_PCM_ACCESS_MMAP_INTERLEAVED</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_mask_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">SNDRV_PCM_ACCESS_RW_INTERLEAVED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct</span><span class="p">)</span>
			<span class="n">snd_mask_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">SNDRV_PCM_ACCESS_RW_NONINTERLEAVED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_mask</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_ACCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;No usable accesses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">choose_rate</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_param_near</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">snd_pcm_oss_format_from</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>

	<span class="n">sformat_mask</span> <span class="o">=</span> <span class="o">*</span><span class="n">hw_param_mask</span><span class="p">(</span><span class="n">sparams</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_FORMAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direct</span><span class="p">)</span>
		<span class="n">sformat</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sformat</span> <span class="o">=</span> <span class="n">snd_pcm_plug_slave_format</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sformat_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">sformat</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">snd_mask_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sformat_mask</span><span class="p">,</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">sformat</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">sformat</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">snd_pcm_format_t</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
		     <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">sformat</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">SNDRV_PCM_FORMAT_LAST</span><span class="p">;</span>
		     <span class="n">sformat</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">snd_pcm_format_t</span><span class="p">)((</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">sformat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_mask_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sformat_mask</span><span class="p">,</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">sformat</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">snd_pcm_oss_format_to</span><span class="p">(</span><span class="n">sformat</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">sformat</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">SNDRV_PCM_FORMAT_LAST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;Cannot find a format!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">_snd_pcm_hw_param_set</span><span class="p">(</span><span class="n">sparams</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_FORMAT</span><span class="p">,</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">sformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">_snd_pcm_hw_params_any</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
		<span class="n">_snd_pcm_hw_param_set</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_ACCESS</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">SNDRV_PCM_ACCESS_RW_INTERLEAVED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">_snd_pcm_hw_param_set</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_FORMAT</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span><span class="n">snd_pcm_oss_format_from</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">_snd_pcm_hw_param_set</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
				      <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">_snd_pcm_hw_param_set</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				      <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pdprintf</span><span class="p">(</span><span class="s">&quot;client: access = %i, format = %i, channels = %i, rate = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">params_access</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
			 <span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">pdprintf</span><span class="p">(</span><span class="s">&quot;slave: access = %i, format = %i, channels = %i, rate = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">params_access</span><span class="p">(</span><span class="n">sparams</span><span class="p">),</span> <span class="n">params_format</span><span class="p">(</span><span class="n">sparams</span><span class="p">),</span>
		 <span class="n">params_channels</span><span class="p">(</span><span class="n">sparams</span><span class="p">),</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">sparams</span><span class="p">));</span>

	<span class="n">oss_frame_size</span> <span class="o">=</span> <span class="n">snd_pcm_format_physical_width</span><span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="o">*</span>
			 <span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SND_PCM_OSS_PLUGINS</span>
	<span class="n">snd_pcm_oss_plugin_clear</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* add necessary plugins */</span>
		<span class="n">snd_pcm_oss_plugin_clear</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_plug_format_plugins</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
						       <span class="n">params</span><span class="p">,</span> 
						       <span class="n">sparams</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;snd_pcm_plug_format_plugins failed: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">snd_pcm_oss_plugin_clear</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_pcm_plugin</span> <span class="o">*</span><span class="n">plugin</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_plugin_build_io</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plugin</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;snd_pcm_plugin_build_io failed: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="n">snd_pcm_oss_plugin_clear</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_plugin_append</span><span class="p">(</span><span class="n">plugin</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_plugin_insert</span><span class="p">(</span><span class="n">plugin</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_pcm_oss_plugin_clear</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_period_size</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">sparams</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">snd_pcm_plug_slave_size</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">/</span> <span class="n">oss_frame_size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_near</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_param_near</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">,</span>
				     <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">periods</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DROP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_HW_PARAMS</span><span class="p">,</span> <span class="n">sparams</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;HW_PARAMS failed: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sw_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">start_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">start_threshold</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span>
		<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">stop_threshold</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">stop_threshold</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">tstamp_mode</span> <span class="o">=</span> <span class="n">SNDRV_PCM_TSTAMP_NONE</span><span class="p">;</span>
	<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">period_step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">avail_min</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="o">?</span>
		<span class="mi">1</span> <span class="o">:</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">nosilence</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">silence_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">silence_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_pcm_uframes_t</span> <span class="n">frames</span><span class="p">;</span>
		<span class="n">frames</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frames</span> <span class="o">&gt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span>
			<span class="n">frames</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
		<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">silence_threshold</span> <span class="o">=</span> <span class="n">frames</span><span class="p">;</span>
		<span class="n">sw_params</span><span class="o">-&gt;</span><span class="n">silence_size</span> <span class="o">=</span> <span class="n">frames</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_SW_PARAMS</span><span class="p">,</span> <span class="n">sw_params</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;SW_PARAMS failed: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">periods</span> <span class="o">=</span> <span class="n">params_periods</span><span class="p">(</span><span class="n">sparams</span><span class="p">);</span>
	<span class="n">oss_period_size</span> <span class="o">=</span> <span class="n">snd_pcm_plug_client_size</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_period_size</span><span class="p">(</span><span class="n">sparams</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oss_period_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_SND_PCM_OSS_PLUGINS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_plug_alloc</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">oss_period_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">oss_period_size</span> <span class="o">*=</span> <span class="n">oss_frame_size</span><span class="p">;</span>

	<span class="n">oss_buffer_size</span> <span class="o">=</span> <span class="n">oss_period_size</span> <span class="o">*</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">periods</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oss_buffer_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">=</span> <span class="n">oss_period_size</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">oss_buffer_size</span><span class="p">;</span>

	<span class="n">pdprintf</span><span class="p">(</span><span class="s">&quot;oss: period bytes = %i, buffer bytes = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">,</span>
		 <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_bytes</span><span class="p">);</span>
	<span class="n">pdprintf</span><span class="p">(</span><span class="s">&quot;slave: period_size = %i, buffer_size = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">params_period_size</span><span class="p">(</span><span class="n">sparams</span><span class="p">),</span>
		 <span class="n">params_buffer_size</span><span class="p">(</span><span class="n">sparams</span><span class="p">));</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">snd_pcm_oss_format_to</span><span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">)</span>
		<span class="n">snd_pcm_format_set_silence</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span> <span class="n">bytes_to_samples</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">));</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_frames</span> <span class="o">=</span> <span class="n">snd_pcm_alsa_frames</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">oss_period_size</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">failure:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sw_params</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sparams</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_active_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">**</span><span class="n">r_substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">asubstream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">asubstream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">asubstream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_change_params</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asubstream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_substream</span><span class="p">)</span>
		<span class="o">*</span><span class="n">r_substream</span> <span class="o">=</span> <span class="n">asubstream</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_PREPARE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;snd_pcm_oss_prepare: SNDRV_PCM_IOCTL_PREPARE failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prev_hw_ptr_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_change_params</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_capture_position_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="n">snd_pcm_sframes_t</span> <span class="o">*</span><span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_uframes_t</span> <span class="n">frames</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DELAY</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">delay</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">snd_pcm_sframes_t</span><span class="p">)</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* in case of overrun, skip whole periods like OSS/Linux driver does */</span>
		<span class="cm">/* until avail(delay) &lt;= buffer_size */</span>
		<span class="n">frames</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">delay</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">frames</span> <span class="o">/=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="n">frames</span> <span class="o">*=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_FORWARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frames</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">snd_pcm_sframes_t</span> <span class="nf">snd_pcm_oss_write3</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">frames</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_kernel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_XRUN</span> <span class="o">||</span>
		    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef OSS_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_XRUN</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: write: &quot;</span>
				       <span class="s">&quot;recovering from XRUN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: write: &quot;</span>
				       <span class="s">&quot;recovering from SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_oss_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_kernel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
			<span class="n">fs</span> <span class="o">=</span> <span class="n">snd_enter_user</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_write</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
			<span class="n">snd_leave_user</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_write</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPIPE</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESTRPIPE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* test, if we can&#39;t store new data, because the stream */</span>
		<span class="cm">/* has not been started */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_PREPARED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">snd_pcm_sframes_t</span> <span class="nf">snd_pcm_oss_read3</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">frames</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_kernel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_XRUN</span> <span class="o">||</span>
		    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef OSS_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_XRUN</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: read: &quot;</span>
				       <span class="s">&quot;recovering from XRUN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: read: &quot;</span>
				       <span class="s">&quot;recovering from SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DRAIN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_SETUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_oss_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_oss_capture_position_fixup</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_kernel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
			<span class="n">fs</span> <span class="o">=</span> <span class="n">snd_enter_user</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_read</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
			<span class="n">snd_leave_user</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_read</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_DRAINING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DROP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESTRPIPE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">snd_pcm_sframes_t</span> <span class="nf">snd_pcm_oss_writev3</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">bufs</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">frames</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_kernel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_XRUN</span> <span class="o">||</span>
		    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef OSS_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_XRUN</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: writev: &quot;</span>
				       <span class="s">&quot;recovering from XRUN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: writev: &quot;</span>
				       <span class="s">&quot;recovering from SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_oss_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_kernel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
			<span class="n">fs</span> <span class="o">=</span> <span class="n">snd_enter_user</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_writev</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">**</span><span class="p">)</span><span class="n">bufs</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
			<span class="n">snd_leave_user</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_writev</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">**</span><span class="p">)</span><span class="n">bufs</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPIPE</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESTRPIPE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* test, if we can&#39;t store new data, because the stream */</span>
		<span class="cm">/* has not been started */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_PREPARED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
	
<span class="n">snd_pcm_sframes_t</span> <span class="nf">snd_pcm_oss_readv3</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">bufs</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">frames</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_kernel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_XRUN</span> <span class="o">||</span>
		    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef OSS_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_XRUN</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: readv: &quot;</span>
				       <span class="s">&quot;recovering from XRUN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: readv: &quot;</span>
				       <span class="s">&quot;recovering from SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DRAIN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STATE_SETUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_oss_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_kernel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
			<span class="n">fs</span> <span class="o">=</span> <span class="n">snd_enter_user</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_readv</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">**</span><span class="p">)</span><span class="n">bufs</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
			<span class="n">snd_leave_user</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_readv</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">**</span><span class="p">)</span><span class="n">bufs</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPIPE</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESTRPIPE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_pcm_oss_write2</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_kernel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span> <span class="n">frames</span><span class="p">,</span> <span class="n">frames1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SND_PCM_OSS_PLUGINS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_plugin_channel</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">oss_frame_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="o">-&gt;</span><span class="n">src_width</span> <span class="o">*</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="o">-&gt;</span><span class="n">src_format</span><span class="p">.</span><span class="n">channels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_kernel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__force</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">bytes</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">frames</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">oss_frame_bytes</span><span class="p">;</span>
		<span class="n">frames1</span> <span class="o">=</span> <span class="n">snd_pcm_plug_client_channels_buf</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channels</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frames1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">frames1</span><span class="p">;</span>
		<span class="n">frames1</span> <span class="o">=</span> <span class="n">snd_pcm_plug_write_transfer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">frames1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frames1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">frames1</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">frames1</span> <span class="o">*</span> <span class="n">oss_frame_bytes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">frames</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
		<span class="n">frames1</span> <span class="o">=</span> <span class="n">snd_pcm_oss_write3</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="n">in_kernel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frames1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">frames1</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">frames_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">frames1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_pcm_oss_write1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">xfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">||</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">&gt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">xfer</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">partialfrag</span> <span class="o">||</span>
			    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">==</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_pcm_oss_write2</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span><span class="p">,</span> 
							 <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span> <span class="o">%=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span> <span class="o">==</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">)</span>
					<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_pcm_oss_write2</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
						 <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span>
						 <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">xfer</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tmp</span> <span class="o">!=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xfer</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xfer</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="n">snd_pcm_sframes_t</span><span class="p">)</span><span class="n">xfer</span> <span class="o">:</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_pcm_oss_read2</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_kernel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span> <span class="n">frames</span><span class="p">,</span> <span class="n">frames1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SND_PCM_OSS_PLUGINS</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">final_dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__force</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_plugin_channel</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">oss_frame_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_last</span><span class="o">-&gt;</span><span class="n">dst_width</span> <span class="o">*</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_last</span><span class="o">-&gt;</span><span class="n">dst_format</span><span class="p">.</span><span class="n">channels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_kernel</span><span class="p">)</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span>
		<span class="n">frames</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">oss_frame_bytes</span><span class="p">;</span>
		<span class="n">frames1</span> <span class="o">=</span> <span class="n">snd_pcm_plug_client_channels_buf</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channels</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frames1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">frames1</span><span class="p">;</span>
		<span class="n">frames1</span> <span class="o">=</span> <span class="n">snd_pcm_plug_read_transfer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">frames1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frames1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">frames1</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">frames1</span> <span class="o">*</span> <span class="n">oss_frame_bytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_kernel</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">final_dst</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">frames</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
		<span class="n">frames1</span> <span class="o">=</span> <span class="n">snd_pcm_oss_read3</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="n">in_kernel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frames1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">frames1</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">frames_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">frames1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_pcm_oss_read1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">xfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">||</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_pcm_oss_read2</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">),</span> <span class="n">tmp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">xfer</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_pcm_oss_read2</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span>
						<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">xfer</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xfer</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xfer</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="n">snd_pcm_sframes_t</span><span class="p">)</span><span class="n">xfer</span> <span class="o">:</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> 
		<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">substream</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DROP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prev_hw_ptr_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_START</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* note: all errors from the start action are ignored */</span>
	<span class="cm">/* OSS apps do not know, how to handle them */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_sync1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_pcm_state_t</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>

	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
<span class="cp">#ifdef OSS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sync1: size = %li</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_pcm_oss_write2</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">snd_pcm_stream_lock_irq</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="n">snd_pcm_stream_unlock_irq</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SNDRV_PCM_STATE_RUNNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;OSS sync error - DMA timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">saved_f_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">__direct</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">snd_pcm_oss_format_from</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">snd_pcm_format_physical_width</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef OSS_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sync: buffer_used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span><span class="p">;</span>
			<span class="n">snd_pcm_format_set_silence</span><span class="p">(</span><span class="n">format</span><span class="p">,</span>
						   <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">,</span>
						   <span class="n">size</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_sync1</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef OSS_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sync: period_ptr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_ptr</span><span class="p">;</span>
			<span class="n">snd_pcm_format_set_silence</span><span class="p">(</span><span class="n">format</span><span class="p">,</span>
						   <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span>
						   <span class="n">size</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">width</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_sync1</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * The ALSA&#39;s period might be a bit large than OSS one.</span>
<span class="cm">		 * Fill the remain portion of ALSA period with zeros.</span>
<span class="cm">		 */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">appl_ptr</span> <span class="o">%</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">==</span> <span class="n">SNDRV_PCM_ACCESS_RW_INTERLEAVED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">frame_bits</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
					<span class="kt">size_t</span> <span class="n">size1</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">;</span>
					<span class="n">size</span> <span class="o">-=</span> <span class="n">size1</span><span class="p">;</span>
					<span class="n">size1</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">size1</span> <span class="o">/=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">sample_bits</span><span class="p">;</span>
					<span class="n">snd_pcm_format_set_silence</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span>
								   <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span>
								   <span class="n">size1</span><span class="p">);</span>
					<span class="n">size1</span> <span class="o">/=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="cm">/* frames */</span>
					<span class="n">fs</span> <span class="o">=</span> <span class="n">snd_enter_user</span><span class="p">();</span>
					<span class="n">snd_pcm_lib_write</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size1</span><span class="p">);</span>
					<span class="n">snd_leave_user</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">==</span> <span class="n">SNDRV_PCM_ACCESS_RW_NONINTERLEAVED</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffers</span><span class="p">[</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">];</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">buffers</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
				<span class="n">snd_pcm_lib_writev</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">buffers</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * finish sync: drain the buffer</span>
<span class="cm">		 */</span>
	      <span class="nl">__direct:</span>
		<span class="n">saved_f_flags</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">;</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">O_NONBLOCK</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DRAIN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">=</span> <span class="n">saved_f_flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DROP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">192000</span><span class="p">)</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_pcm_oss_get_rate</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_active_substream</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_set_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">channels</span> <span class="o">!=</span> <span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_pcm_oss_get_channels</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_active_substream</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">channels</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_block_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_active_substream</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direct</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">formats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mask</span> <span class="n">format_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_active_substream</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span>
		<span class="n">direct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">direct</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">direct</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_U8</span> <span class="o">|</span>
		       <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span> <span class="o">|</span>
		       <span class="n">AFMT_S8</span> <span class="o">|</span> <span class="n">AFMT_U16_LE</span> <span class="o">|</span>
		       <span class="n">AFMT_U16_BE</span> <span class="o">|</span>
			<span class="n">AFMT_S32_LE</span> <span class="o">|</span> <span class="n">AFMT_S32_BE</span> <span class="o">|</span>
			<span class="n">AFMT_S24_LE</span> <span class="o">|</span> <span class="n">AFMT_S24_BE</span> <span class="o">|</span>
			<span class="n">AFMT_S24_PACKED</span><span class="p">;</span>
	<span class="n">params</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">_snd_pcm_hw_params_any</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_refine</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="n">format_mask</span> <span class="o">=</span> <span class="o">*</span><span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_FORMAT</span><span class="p">);</span> 
	<span class="n">kfree</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fmt</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="o">++</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_mask_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format_mask</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">snd_pcm_oss_format_to</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">formats</span> <span class="o">|=</span> <span class="n">f</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">formats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">formats</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">!=</span> <span class="n">AFMT_QUERY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">formats</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_formats</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">formats</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">formats</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">formats</span> <span class="o">&amp;</span> <span class="n">format</span><span class="p">))</span>
			<span class="n">format</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span> <span class="o">!=</span> <span class="n">format</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_pcm_oss_get_format</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_active_substream</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_set_subdivide1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subdivide</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subdivide</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">subdivide</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">subdivision</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subdivide</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">subdivide</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">subdivide</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">subdivision</span> <span class="o">||</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">fragshift</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subdivide</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">subdivide</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">subdivide</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
	    <span class="n">subdivide</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">subdivide</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">subdivision</span> <span class="o">=</span> <span class="n">subdivide</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">subdivide</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_set_subdivide</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subdivide</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_set_subdivide1</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">subdivide</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_set_fragment1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">subdivision</span> <span class="o">||</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">fragshift</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">fragshift</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">maxfrags</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">fragshift</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>		<span class="cm">/* &lt; 16 */</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">fragshift</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">maxfrags</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">maxfrags</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_set_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_set_fragment1</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_nonblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_lock</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">|=</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_caps1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_CAP_DUPLEX</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DSP_CAP_MULTI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">substream_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">|=</span> <span class="n">DSP_CAP_MULTI</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* DSP_CAP_REALTIME is set all times: */</span>
	<span class="cm">/* all ALSA drivers can return actual pointer in ring buffer */</span>
<span class="cp">#if defined(DSP_CAP_REALTIME) &amp;&amp; 0</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span><span class="o">|</span><span class="n">SNDRV_PCM_INFO_BATCH</span><span class="p">))</span>
			<span class="n">res</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_CAP_REALTIME</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	
	<span class="n">result</span> <span class="o">=</span> <span class="n">DSP_CAP_TRIGGER</span> <span class="o">|</span> <span class="n">DSP_CAP_MMAP</span>	<span class="o">|</span> <span class="n">DSP_CAP_DUPLEX</span> <span class="o">|</span> <span class="n">DSP_CAP_REALTIME</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_caps1</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>	<span class="cm">/* revision - same as SB AWE 64 */</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pcm_oss_simulate_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				      <span class="n">snd_pcm_uframes_t</span> <span class="n">hw_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_uframes_t</span> <span class="n">appl_ptr</span><span class="p">;</span>
	<span class="n">appl_ptr</span> <span class="o">=</span> <span class="n">hw_ptr</span> <span class="o">+</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">appl_ptr</span> <span class="o">%=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">appl_ptr</span> <span class="o">=</span> <span class="n">appl_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_set_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trigger</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">psubstream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">csubstream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>

<span class="cp">#ifdef OSS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: trigger = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">trigger</span><span class="p">);</span>
<span class="cp">#endif</span>
	
	<span class="n">psubstream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
	<span class="n">csubstream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psubstream</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="n">psubstream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csubstream</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="n">csubstream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
      	<span class="k">if</span> <span class="p">(</span><span class="n">psubstream</span><span class="p">)</span> <span class="p">{</span>
      		<span class="n">runtime</span> <span class="o">=</span> <span class="n">psubstream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">_skip1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psubstream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span>
				<span class="n">snd_pcm_oss_simulate_fill</span><span class="p">(</span><span class="n">psubstream</span><span class="p">,</span>
						<span class="n">get_hw_ptr_period</span><span class="p">(</span><span class="n">runtime</span><span class="p">));</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">start_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">SNDRV_PCM_IOCTL_START</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">_skip1</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">start_threshold</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">SNDRV_PCM_IOCTL_DROP</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">psubstream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">_skip1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csubstream</span><span class="p">)</span> <span class="p">{</span>
      		<span class="n">runtime</span> <span class="o">=</span> <span class="n">csubstream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">_skip2</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">start_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">SNDRV_PCM_IOCTL_START</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">_skip2</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">start_threshold</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">SNDRV_PCM_IOCTL_DROP</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">csubstream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">_skip2:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">psubstream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">csubstream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">psubstream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
	<span class="n">csubstream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psubstream</span> <span class="o">&amp;&amp;</span> <span class="n">psubstream</span><span class="o">-&gt;</span><span class="n">runtime</span> <span class="o">&amp;&amp;</span> <span class="n">psubstream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csubstream</span> <span class="o">&amp;&amp;</span> <span class="n">csubstream</span><span class="o">-&gt;</span><span class="n">runtime</span> <span class="o">&amp;&amp;</span> <span class="n">csubstream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_odelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">||</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DELAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">)</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* hack for broken OSS applications */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pcm_oss_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span> <span class="k">struct</span> <span class="n">count_info</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">_info</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fixup</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">count_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_make_ready</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">||</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DELAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPIPE</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESTRPIPE</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span> <span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fixup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fixup</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_capture_position_fixup</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">);</span>
		<span class="n">fixup</span> <span class="o">=</span> <span class="o">-</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_pcm_oss_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">%</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_pcm_sframes_t</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">get_hw_ptr_period</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">delay</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prev_hw_ptr_period</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">+=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prev_hw_ptr_period</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
			<span class="n">snd_pcm_oss_simulate_fill</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">snd_pcm_oss_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_MAX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">snd_pcm_oss_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">buggyptr</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_bytes</span> <span class="o">-</span> <span class="n">delay</span> <span class="o">-</span> <span class="n">fixup</span><span class="p">)</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">info</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">delay</span> <span class="o">+</span> <span class="n">fixup</span><span class="p">)</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">bytes</span> <span class="o">-</span> <span class="n">delay</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_MAX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">delay</span> <span class="o">+=</span> <span class="n">fixup</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">delay</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+</span> <span class="n">delay</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_MAX</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span> <span class="k">struct</span> <span class="n">audio_buf_info</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span> <span class="n">avail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fixup</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audio_buf_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_change_params</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">fragstotal</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prepare</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span> <span class="o">*</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">periods</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">periods</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_kernel_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_IOCTL_DELAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avail</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPIPE</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESTRPIPE</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span> <span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">avail</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">avail</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">fixup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">avail</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="n">avail</span><span class="p">;</span>
				<span class="n">fixup</span> <span class="o">=</span> <span class="o">-</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_capture_position_fixup</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avail</span><span class="p">);</span>
			<span class="n">fixup</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer_used</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">snd_pcm_oss_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span> <span class="o">+</span> <span class="n">fixup</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_bytes</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef OSS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: space: bytes = %i, fragments = %i, &quot;</span>
	       <span class="s">&quot;fragstotal = %i, fragsize = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fragments</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fragstotal</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fragsize</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_get_mapbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffmem_desc</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">_info</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>it won't be probably implemented
snd<em>printd("TODO: snd</em>pcm<em>oss</em>get_mapbuf\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">strip_task_path</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
			<span class="n">ptrl</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ptrl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pcm_oss_look_for_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">task_name</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_oss_setup</span> <span class="o">*</span><span class="n">rsetup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">setup</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_list</span><span class="p">;</span> <span class="n">setup</span><span class="p">;</span>
		     <span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">task_name</span><span class="p">,</span> <span class="n">task_name</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">task_name</span> <span class="o">=</span> <span class="n">strip_task_path</span><span class="p">(</span><span class="n">task_name</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rsetup</span> <span class="o">=</span> <span class="o">*</span><span class="n">setup</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pcm_oss_release_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SND_PCM_OSS_PLUGINS</span>
	<span class="n">snd_pcm_oss_plugin_clear</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">oss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pcm_oss_init_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_oss_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">oss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="o">*</span><span class="n">setup</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">nonblock</span><span class="p">)</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">|=</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">)</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">SNDRV_MINOR_OSS_DEVICE</span><span class="p">(</span><span class="n">minor</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_MINOR_OSS_PCM_8</span>:
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_MINOR_OSS_PCM_16</span>:
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">AFMT_S16_LE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">AFMT_MU_LAW</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">fragshift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">maxfrags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">subdivision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm_release</span> <span class="o">=</span> <span class="n">snd_pcm_oss_release_substream</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_release_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cidx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcm_oss_file</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cidx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">cidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">cidx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="p">)</span>
			<span class="n">snd_pcm_release_substream</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_open_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">**</span><span class="n">rpcm_oss_file</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">minor</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_oss_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="n">fmode_t</span> <span class="n">f_mode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm_oss_file</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm_oss_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pcm_oss_file</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_oss_file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_READ</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">&amp;</span> <span class="n">SNDRV_PCM_INFO_HALF_DUPLEX</span><span class="p">))</span>
		<span class="n">f_mode</span> <span class="o">=</span> <span class="n">FMODE_WRITE</span><span class="p">;</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">O_APPEND</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">disable</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">substream_count</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* no matching substream */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_open_substream</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_pcm_oss_release_file</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="p">;</span>
		<span class="n">snd_pcm_oss_init_substream</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">minor</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">snd_pcm_oss_release_file</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm_oss_file</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm_oss_file</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_task_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">task</span> <span class="o">||</span> <span class="o">!</span><span class="n">name</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">name</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">name</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">task_name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_setup</span> <span class="n">setup</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">nonblock</span><span class="p">;</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcm</span> <span class="o">=</span> <span class="n">snd_lookup_oss_minor_data</span><span class="p">(</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
					<span class="n">SNDRV_OSS_DEVICE_TYPE_PCM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_file_add</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_task_name</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">task_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">task_name</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setup</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
		<span class="n">snd_pcm_oss_look_for_setup</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
					   <span class="n">task_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span>
		<span class="n">snd_pcm_oss_look_for_setup</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
					   <span class="n">task_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">nonblock</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nonblock</span><span class="p">)</span>
		<span class="n">nonblock</span> <span class="o">=</span> <span class="n">nonblock_open</span><span class="p">;</span>

	<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_open_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm_oss_file</span><span class="p">,</span>
					    <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">setup</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

      <span class="nl">__error:</span>
     	<span class="n">module_put</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
      <span class="nl">__error2:</span>
      	<span class="n">snd_card_file_remove</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
      <span class="nl">__error1:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">;</span>

	<span class="n">pcm_oss_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">substream</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">pcm</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">snd_pcm_oss_sync</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">snd_pcm_oss_release_file</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
	<span class="n">snd_card_file_remove</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">snd_pcm_oss_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">pcm_oss_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OSS_GETVERSION</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SNDRV_OSS_VERSION</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OSS_ALSAEMULVER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_SND_MIXER_OSS) || (defined(MODULE) &amp;&amp; defined(CONFIG_SND_MIXER_OSS_MODULE))</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span><span class="p">)</span>	<span class="p">{</span>	<span class="cm">/* mixer ioctl - for OSS compatibility */</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_mixer_oss_ioctl_card</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#ifdef OSS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: ioctl = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_RESET</span>:
		<span class="k">return</span> <span class="n">snd_pcm_oss_reset</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SYNC</span>:
		<span class="k">return</span> <span class="n">snd_pcm_oss_sync</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SPEED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_set_rate</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_RATE</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_rate</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_STEREO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_set_channels</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="o">--</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETBLKSIZE</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_block_size</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFMT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_set_format</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_BITS</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_format</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_CHANNELS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_set_channels</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_CHANNELS</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_channels</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_WRITE_FILTER</span>:
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_FILTER</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_POST</span>:
		<span class="k">return</span> <span class="n">snd_pcm_oss_post</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SUBDIVIDE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_set_subdivide</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFRAGMENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_pcm_oss_set_fragment</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETFMTS</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_formats</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOSPACE</span>:
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETISPACE</span>:
		<span class="k">return</span> <span class="n">snd_pcm_oss_get_space</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span>
			<span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDCTL_DSP_GETISPACE</span> <span class="o">?</span>
				<span class="n">SNDRV_PCM_STREAM_CAPTURE</span> <span class="o">:</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">audio_buf_info</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_NONBLOCK</span>:
		<span class="k">return</span> <span class="n">snd_pcm_oss_nonblock</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETCAPS</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_caps</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETTRIGGER</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_trigger</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETTRIGGER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_pcm_oss_set_trigger</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETIPTR</span>:
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOPTR</span>:
		<span class="k">return</span> <span class="n">snd_pcm_oss_get_ptr</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span>
			<span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDCTL_DSP_GETIPTR</span> <span class="o">?</span>
				<span class="n">SNDRV_PCM_STREAM_CAPTURE</span> <span class="o">:</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">count_info</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_MAPINBUF</span>:
	<span class="k">case</span> <span class="n">SNDCTL_DSP_MAPOUTBUF</span>:
		<span class="k">return</span> <span class="n">snd_pcm_oss_get_mapbuf</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">,</span>
			<span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDCTL_DSP_MAPINBUF</span> <span class="o">?</span>
				<span class="n">SNDRV_PCM_STREAM_CAPTURE</span> <span class="o">:</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">buffmem_desc</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETSYNCRO</span>:
		<span class="cm">/* stop DMA now.. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETDUPLEX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_oss_get_caps</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DSP_CAP_DUPLEX</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETODELAY</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_get_odelay</span><span class="p">(</span><span class="n">pcm_oss_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* it&#39;s for sure, some broken apps don&#39;t check for error codes */</span>
			<span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_PROFILE</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* silently ignore */</span>
	<span class="nl">default:</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;pcm_oss: unknown command = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="cm">/* all compatible */</span>
<span class="cp">#define snd_pcm_oss_ioctl_compat	snd_pcm_oss_ioctl</span>
<span class="cp">#else</span>
<span class="cp">#define snd_pcm_oss_ioctl_compat	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_pcm_oss_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>

	<span class="n">pcm_oss_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
<span class="cp">#ifndef OSS_DEBUG</span>
	<span class="k">return</span> <span class="n">snd_pcm_oss_read1</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="p">{</span>
		<span class="kt">ssize_t</span> <span class="n">res</span> <span class="o">=</span> <span class="n">snd_pcm_oss_read1</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: read %li bytes &quot;</span>
		       <span class="s">&quot;(returned %li bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">res</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_pcm_oss_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">pcm_oss_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">snd_pcm_oss_write1</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#ifdef OSS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: write %li bytes (wrote %li bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">result</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_playback_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prev_hw_ptr_period</span> <span class="o">!=</span>
						<span class="n">get_hw_ptr_period</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snd_pcm_playback_avail</span><span class="p">(</span><span class="n">runtime</span><span class="p">)</span> <span class="o">&gt;=</span>
						<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_frames</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_capture_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">mmap_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">prev_hw_ptr_period</span> <span class="o">!=</span>
						<span class="n">get_hw_ptr_period</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snd_pcm_capture_avail</span><span class="p">(</span><span class="n">runtime</span><span class="p">)</span> <span class="o">&gt;=</span>
						<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">period_frames</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">psubstream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">csubstream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	
	<span class="n">pcm_oss_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">psubstream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
	<span class="n">csubstream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">];</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psubstream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">psubstream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
		<span class="n">snd_pcm_stream_lock_irq</span><span class="p">(</span><span class="n">psubstream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SNDRV_PCM_STATE_DRAINING</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SNDRV_PCM_STATE_RUNNING</span> <span class="o">||</span>
		     <span class="n">snd_pcm_oss_playback_ready</span><span class="p">(</span><span class="n">psubstream</span><span class="p">)))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
		<span class="n">snd_pcm_stream_unlock_irq</span><span class="p">(</span><span class="n">psubstream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csubstream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">csubstream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="n">snd_pcm_state_t</span> <span class="n">ostate</span><span class="p">;</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
		<span class="n">snd_pcm_stream_lock_irq</span><span class="p">(</span><span class="n">csubstream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ostate</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SNDRV_PCM_STATE_RUNNING</span> <span class="o">||</span>
		    <span class="n">snd_pcm_oss_capture_ready</span><span class="p">(</span><span class="n">csubstream</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
		<span class="n">snd_pcm_stream_unlock_irq</span><span class="p">(</span><span class="n">csubstream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ostate</span> <span class="o">!=</span> <span class="n">SNDRV_PCM_STATE_RUNNING</span> <span class="o">&amp;&amp;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="n">ofile</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ofile</span><span class="p">));</span>
			<span class="n">ofile</span><span class="p">.</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">];</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">snd_pcm_oss_set_trigger</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofile</span><span class="p">,</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_file</span> <span class="o">*</span><span class="n">pcm_oss_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef OSS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: mmap begin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pcm_oss_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VM_READ</span> <span class="o">|</span> <span class="n">VM_WRITE</span><span class="p">)))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VM_READ</span> <span class="o">|</span> <span class="n">VM_WRITE</span>:
		<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">VM_READ</span>:
		<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VM_WRITE</span>:
		<span class="n">substream</span> <span class="o">=</span> <span class="n">pcm_oss_file</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set VM_READ access as well to fix memset() routines that do</span>
<span class="cm">	   reads before writes (to improve performance) */</span>
	<span class="n">area</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span><span class="p">)</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_PCM_ACCESS_MMAP_INTERLEAVED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_oss_change_params</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_SND_PCM_OSS_PLUGINS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">plugin_first</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_mmap_data</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">mmap_bytes</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">silence_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">silence_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef OSS_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcm_oss: mmap ok, bytes = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">mmap_bytes</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* In mmap mode we never stop */</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">stop_threshold</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_VERBOSE_PROCFS</span>
<span class="cm">/*</span>
<span class="cm"> *  /proc interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pcm_oss_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_str</span> <span class="o">*</span><span class="n">pstr</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_setup</span> <span class="o">*</span><span class="n">setup</span> <span class="o">=</span> <span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_list</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s %u %u%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">task_name</span><span class="p">,</span>
			    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">periods</span><span class="p">,</span>
			    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">,</span>
			    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">disable</span> <span class="o">?</span> <span class="s">&quot; disable&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">direct</span> <span class="o">?</span> <span class="s">&quot; direct&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">?</span> <span class="s">&quot; block&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">nonblock</span> <span class="o">?</span> <span class="s">&quot; non-block&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">partialfrag</span> <span class="o">?</span> <span class="s">&quot; partial-frag&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">nosilence</span> <span class="o">?</span> <span class="s">&quot; no-silence&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pcm_oss_proc_free_setup_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_str</span> <span class="o">*</span> <span class="n">pstr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">,</span> <span class="o">*</span><span class="n">setupn</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">setup</span> <span class="o">=</span> <span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_list</span><span class="p">,</span> <span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">setup</span><span class="p">;</span> <span class="n">setup</span> <span class="o">=</span> <span class="n">setupn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">setupn</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">task_name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">setup</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pcm_oss_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_str</span> <span class="o">*</span><span class="n">pstr</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">str</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">task_name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_oss_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">,</span> <span class="o">*</span><span class="n">setup1</span><span class="p">,</span> <span class="n">template</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_info_get_line</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">template</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_info_get_str</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">task_name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="s">&quot;clear&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="s">&quot;erase&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_pcm_oss_proc_free_setup_list</span><span class="p">(</span><span class="n">pstr</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_mutex</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">setup</span> <span class="o">=</span> <span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_list</span><span class="p">;</span> <span class="n">setup</span><span class="p">;</span> <span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">task_name</span><span class="p">,</span> <span class="n">task_name</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">template</span> <span class="o">=</span> <span class="o">*</span><span class="n">setup</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_info_get_str</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
		<span class="n">template</span><span class="p">.</span><span class="n">periods</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_info_get_str</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
		<span class="n">template</span><span class="p">.</span><span class="n">period_size</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx1</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">idx1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx1</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">template</span><span class="p">.</span><span class="n">period_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx1</span><span class="o">--</span><span class="p">;</span> <span class="n">idx1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx1</span><span class="o">--</span><span class="p">)</span>
			<span class="n">template</span><span class="p">.</span><span class="n">period_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx1</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">snd_info_get_str</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">template</span><span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;direct&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">template</span><span class="p">.</span><span class="n">direct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;block&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">template</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;non-block&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">template</span><span class="p">.</span><span class="n">nonblock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;partial-frag&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">template</span><span class="p">.</span><span class="n">partialfrag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;no-silence&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">template</span><span class="p">.</span><span class="n">nosilence</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;buggy-ptr&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">template</span><span class="p">.</span><span class="n">buggyptr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">setup</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_mutex</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_list</span> <span class="o">=</span> <span class="n">setup</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">setup1</span> <span class="o">=</span> <span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_list</span><span class="p">;</span>
				     <span class="n">setup1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">setup1</span> <span class="o">=</span> <span class="n">setup1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
				<span class="n">setup1</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">setup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">template</span><span class="p">.</span><span class="n">task_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">template</span><span class="p">.</span><span class="n">task_name</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">setup</span><span class="p">);</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_mutex</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">setup</span> <span class="o">=</span> <span class="n">template</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pcm_oss_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stream</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">stream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">stream</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">stream</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_str</span> <span class="o">*</span><span class="n">pstr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">substream_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">snd_info_create_card_entry</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;oss&quot;</span><span class="p">,</span> <span class="n">pstr</span><span class="o">-&gt;</span><span class="n">proc_root</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_TEXT</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_pcm_oss_proc_read</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_pcm_oss_proc_write</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pstr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_info_register</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
				<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">proc_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pcm_oss_proc_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stream</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">stream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">stream</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">stream</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_str</span> <span class="o">*</span><span class="n">pstr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">];</span>
		<span class="n">snd_info_free_entry</span><span class="p">(</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">proc_entry</span><span class="p">);</span>
		<span class="n">pstr</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">proc_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">snd_pcm_oss_proc_free_setup_list</span><span class="p">(</span><span class="n">pstr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_SND_VERBOSE_PROCFS */</span><span class="cp"></span>
<span class="cp">#define snd_pcm_oss_proc_init(pcm)</span>
<span class="cp">#define snd_pcm_oss_proc_done(pcm)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SND_VERBOSE_PROCFS */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *  ENTRY functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">snd_pcm_oss_f_reg</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">snd_pcm_oss_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">snd_pcm_oss_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_pcm_oss_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">snd_pcm_oss_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span>		<span class="n">snd_pcm_oss_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_oss_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_oss_ioctl_compat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>		<span class="n">snd_pcm_oss_mmap</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">register_oss_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dsp%i%i&quot;</span><span class="p">,</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_register_oss_device</span><span class="p">(</span><span class="n">SNDRV_OSS_DEVICE_TYPE_PCM</span><span class="p">,</span>
				    <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_pcm_oss_f_reg</span><span class="p">,</span>
				    <span class="n">pcm</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to register OSS PCM device %i:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_register_minor</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_map</span><span class="p">[</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">duplex</span><span class="p">;</span>
		<span class="n">register_oss_dsp</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">substream_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> 
			      <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substream_count</span> <span class="o">&amp;&amp;</span> 
			      <span class="o">!</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">&amp;</span> <span class="n">SNDRV_PCM_INFO_HALF_DUPLEX</span><span class="p">));</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">duplex</span> <span class="o">?</span> <span class="s">&quot; (DUPLEX)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="cp">#ifdef SNDRV_OSS_INFO_DEV_AUDIO</span>
		<span class="n">snd_oss_info_register</span><span class="p">(</span><span class="n">SNDRV_OSS_INFO_DEV_AUDIO</span><span class="p">,</span>
				      <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				      <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg_mask</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adsp_map</span><span class="p">[</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">register_oss_dsp</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg_mask</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">snd_pcm_oss_proc_init</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_disconnect_minor</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg_mask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">snd_unregister_oss_device</span><span class="p">(</span><span class="n">SNDRV_OSS_DEVICE_TYPE_PCM</span><span class="p">,</span>
						  <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg_mask</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">snd_unregister_oss_device</span><span class="p">(</span><span class="n">SNDRV_OSS_DEVICE_TYPE_PCM</span><span class="p">,</span>
						  <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_map</span><span class="p">[</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef SNDRV_OSS_INFO_DEV_AUDIO</span>
			<span class="n">snd_oss_info_unregister</span><span class="p">(</span><span class="n">SNDRV_OSS_INFO_DEV_AUDIO</span><span class="p">,</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">oss</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pcm_oss_unregister_minor</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pcm_oss_disconnect_minor</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">snd_pcm_oss_proc_done</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_notify</span> <span class="n">snd_pcm_oss_notify</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">n_register</span> <span class="o">=</span>	<span class="n">snd_pcm_oss_register_minor</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_disconnect</span> <span class="o">=</span> <span class="n">snd_pcm_oss_disconnect_minor</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_unregister</span> <span class="o">=</span>	<span class="n">snd_pcm_oss_unregister_minor</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">alsa_pcm_oss_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* check device map table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dsp_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">SNDRV_PCM_DEVICES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid dsp_map[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">i</span><span class="p">,</span> <span class="n">dsp_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">dsp_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adsp_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">adsp_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">SNDRV_PCM_DEVICES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid adsp_map[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">i</span><span class="p">,</span> <span class="n">adsp_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">adsp_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_pcm_oss_notify</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">alsa_pcm_oss_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pcm_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_pcm_oss_notify</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">alsa_pcm_oss_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">alsa_pcm_oss_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
