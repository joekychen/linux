<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › drivers › ml403-ac97cr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ml403-ac97cr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ALSA driver for Xilinx ML403 AC97 Controller Reference</span>
<span class="cm"> *   IP: opb_ac97_controller_ref_v1_00_a (EDK 8.1i)</span>
<span class="cm"> *   IP: opb_ac97_controller_ref_v1_00_a (EDK 9.1i)</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) by 2007  Joachim Foerster &lt;JOFT@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* Some notes / status of this driver:</span>
<span class="cm"> *</span>
<span class="cm"> * - Don&#39;t wonder about some strange implementations of things - especially the</span>
<span class="cm"> * (heavy) shadowing of codec registers, with which I tried to reduce read</span>
<span class="cm"> * accesses to a minimum, because after a variable amount of accesses, the AC97</span>
<span class="cm"> * controller doesn&#39;t raise the register access finished bit anymore ...</span>
<span class="cm"> *</span>
<span class="cm"> * - Playback support seems to be pretty stable - no issues here.</span>
<span class="cm"> * - Capture support &quot;works&quot; now, too. Overruns don&#39;t happen any longer so often.</span>
<span class="cm"> *   But there might still be some ...</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cm">/* HZ */</span>
<span class="cp">#include &lt;linux/param.h&gt;</span>
<span class="cm">/* jiffies, time_*() */</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cm">/* schedule_timeout*() */</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cm">/* spin_lock*() */</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cm">/* struct mutex, mutex_init(), mutex_*lock() */</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cm">/* snd_printk(), snd_printd() */</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>

<span class="cp">#include &quot;pcm-indirect2.h&quot;</span>


<span class="cp">#define SND_ML403_AC97CR_DRIVER &quot;ml403-ac97cr&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Joachim Foerster &lt;JOFT@gmx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Xilinx ML403 AC97 Controller Reference&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Xilinx,ML403 AC97 Controller Reference}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE</span><span class="p">;</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for ML403 AC97 Controller Reference.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for ML403 AC97 Controller Reference.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable this ML403 AC97 Controller Reference.&quot;</span><span class="p">);</span>

<span class="cm">/* Special feature options */</span>
<span class="cm">/*#define CODEC_WRITE_CHECK_RAF*/</span> <span class="cm">/* don&#39;t return after a write to a codec</span>
<span class="cm">				   * register, while RAF bit is not set</span>
<span class="cm">				   */</span>
<span class="cm">/* Debug options for code which may be removed completely in a final version */</span>
<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
<span class="cm">/*#define CODEC_STAT*/</span>            <span class="cm">/* turn on some minimal &quot;statistics&quot;</span>
<span class="cm">				   * about codec register usage</span>
<span class="cm">				   */</span>
<span class="cp">#define SND_PCM_INDIRECT2_STAT    </span><span class="cm">/* turn on some &quot;statistics&quot; about the</span>
<span class="cm">				   * process of copying bytes from the</span>
<span class="cm">				   * intermediate buffer to the hardware</span>
<span class="cm">				   * fifo and the other way round</span>
<span class="cm">				   */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/* Definition of a &quot;level/facility dependent&quot; printk(); may be removed</span>
<span class="cm"> * completely in a final version</span>
<span class="cm"> */</span>
<span class="cp">#undef PDEBUG</span>
<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
<span class="cm">/* &quot;facilities&quot; for PDEBUG */</span>
<span class="cp">#define UNKNOWN       (1&lt;&lt;0)</span>
<span class="cp">#define CODEC_SUCCESS (1&lt;&lt;1)</span>
<span class="cp">#define CODEC_FAKE    (1&lt;&lt;2)</span>
<span class="cp">#define INIT_INFO     (1&lt;&lt;3)</span>
<span class="cp">#define INIT_FAILURE  (1&lt;&lt;4)</span>
<span class="cp">#define WORK_INFO     (1&lt;&lt;5)</span>
<span class="cp">#define WORK_FAILURE  (1&lt;&lt;6)</span>

<span class="cp">#define PDEBUG_FACILITIES (UNKNOWN | INIT_FAILURE | WORK_FAILURE)</span>

<span class="cp">#define PDEBUG(fac, fmt, args...) do { \</span>
<span class="cp">		if (fac &amp; PDEBUG_FACILITIES) \</span>
<span class="cp">			snd_printd(KERN_DEBUG SND_ML403_AC97CR_DRIVER &quot;: &quot; \</span>
<span class="cp">				   fmt, ##args); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define PDEBUG(fac, fmt, args...) </span><span class="cm">/* nothing */</span><span class="cp"></span>
<span class="cp">#endif</span>



<span class="cm">/* Defines for &quot;waits&quot;/timeouts (portions of HZ=250 on arch/ppc by default) */</span>
<span class="cp">#define CODEC_TIMEOUT_ON_INIT       5	</span><span class="cm">/* timeout for checking for codec</span>
<span class="cm">					 * readiness (after insmod)</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#ifndef CODEC_WRITE_CHECK_RAF</span>
<span class="cp">#define CODEC_WAIT_AFTER_WRITE    100	</span><span class="cm">/* general, static wait after a write</span>
<span class="cm">					 * access to a codec register, may be</span>
<span class="cm">					 * 0 to completely remove wait</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define CODEC_TIMEOUT_AFTER_WRITE   5	</span><span class="cm">/* timeout after a write access to a</span>
<span class="cm">					 * codec register, if RAF bit is used</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="cp">#define CODEC_TIMEOUT_AFTER_READ    5	</span><span class="cm">/* timeout after a read access to a</span>
<span class="cm">					 * codec register (checking RAF bit)</span>
<span class="cm">					 */</span><span class="cp"></span>

<span class="cm">/* Infrastructure for codec register shadowing */</span>
<span class="cp">#define LM4550_REG_OK        (1&lt;&lt;0)   </span><span class="cm">/* register exists */</span><span class="cp"></span>
<span class="cp">#define LM4550_REG_DONEREAD  (1&lt;&lt;1)   </span><span class="cm">/* read register once, value should be</span>
<span class="cm">				       * the same currently in the register</span>
<span class="cm">				       */</span><span class="cp"></span>
<span class="cp">#define LM4550_REG_NOSAVE    (1&lt;&lt;2)   </span><span class="cm">/* values written to this register will</span>
<span class="cm">				       * not be saved in the register</span>
<span class="cm">				       */</span><span class="cp"></span>
<span class="cp">#define LM4550_REG_NOSHADOW  (1&lt;&lt;3)   </span><span class="cm">/* don&#39;t do register shadowing, use plain</span>
<span class="cm">				       * hardware access</span>
<span class="cm">				       */</span><span class="cp"></span>
<span class="cp">#define LM4550_REG_READONLY  (1&lt;&lt;4)   </span><span class="cm">/* register is read only */</span><span class="cp"></span>
<span class="cp">#define LM4550_REG_FAKEPROBE (1&lt;&lt;5)   </span><span class="cm">/* fake write _and_ read actions during</span>
<span class="cm">				       * probe() correctly</span>
<span class="cm">				       */</span><span class="cp"></span>
<span class="cp">#define LM4550_REG_FAKEREAD  (1&lt;&lt;6)   </span><span class="cm">/* fake read access, always return</span>
<span class="cm">				       * default value</span>
<span class="cm">				       */</span><span class="cp"></span>
<span class="cp">#define LM4550_REG_ALLFAKE   (LM4550_REG_FAKEREAD | LM4550_REG_FAKEPROBE)</span>

<span class="k">struct</span> <span class="n">lm4550_reg</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wmask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">def</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lm4550_reg</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">AC97_RESET</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>              <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_NOSAVE</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEREAD</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x0D50</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_MASTER</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>             <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span>
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x9F1F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_HEADPHONE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>          <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x9F1F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_MASTER_MONO</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>        <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x801F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_PC_BEEP</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>            <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x801E</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_PHONE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>              <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x801F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8008</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_MIC</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>                <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x805F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8008</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_LINE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>               <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x9F1F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8808</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_CD</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>                 <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x9F1F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8808</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_VIDEO</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>              <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x9F1F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8808</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_AUX</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>                <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x9F1F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8808</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_PCM</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>                <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x9F1F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8008</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_REC_SEL</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>            <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x707</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_REC_GAIN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x8F0F</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_GENERAL_PURPOSE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0xA380</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_3D_CONTROL</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEREAD</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_READONLY</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x0101</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_POWERDOWN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>          <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_NOSHADOW</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_NOSAVE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0xFF00</span><span class="p">},</span>
					<span class="cm">/* may not write ones to</span>
<span class="cm">					 * REF/ANL/DAC/ADC bits</span>
<span class="cm">					 * FIXME: Is this ok?</span>
<span class="cm">					 */</span>
	<span class="p">[</span><span class="n">AC97_EXTENDED_ID</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>        <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEREAD</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_READONLY</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x0201</span><span class="p">},</span> <span class="cm">/* primary codec */</span>
	<span class="p">[</span><span class="n">AC97_EXTENDED_STATUS</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_NOSHADOW</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_NOSAVE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_PCM_FRONT_DAC_RATE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0xBB80</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_PCM_LR_ADC_RATE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0xBB80</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">wmask</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_VENDOR_ID1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_READONLY</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEREAD</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x4E53</span><span class="p">},</span>
	<span class="p">[</span><span class="n">AC97_VENDOR_ID2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">LM4550_REG_OK</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_READONLY</span> \
						<span class="o">|</span> <span class="n">LM4550_REG_FAKEREAD</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mh">0x4350</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define LM4550_RF_OK(reg)    (lm4550_regfile[reg / 2].flag &amp; LM4550_REG_OK)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm4550_regfile_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">)</span>
			<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">def</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm4550_regfile_write_values_after_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">def</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_FAKE</span><span class="p">,</span> <span class="s">&quot;lm4550_regfile_write_values_after_&quot;</span>
			       <span class="s">&quot;init(): reg=0x%x value=0x%x / %d is different &quot;</span>
			       <span class="s">&quot;from def=0x%x / %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
			       <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">def</span><span class="p">,</span>
			       <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">def</span><span class="p">);</span>
			<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">ac97</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
			<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">LM4550_REG_DONEREAD</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* direct registers */</span>
<span class="cp">#define CR_REG(ml403_ac97cr, x) ((ml403_ac97cr)-&gt;port + CR_REG_##x)</span>

<span class="cp">#define CR_REG_PLAYFIFO         0x00</span>
<span class="cp">#define   CR_PLAYDATA(a)        ((a) &amp; 0xFFFF)</span>

<span class="cp">#define CR_REG_RECFIFO          0x04</span>
<span class="cp">#define   CR_RECDATA(a)         ((a) &amp; 0xFFFF)</span>

<span class="cp">#define CR_REG_STATUS           0x08</span>
<span class="cp">#define   CR_RECOVER            (1&lt;&lt;7)</span>
<span class="cp">#define   CR_PLAYUNDER          (1&lt;&lt;6)</span>
<span class="cp">#define   CR_CODECREADY         (1&lt;&lt;5)</span>
<span class="cp">#define   CR_RAF                (1&lt;&lt;4)</span>
<span class="cp">#define   CR_RECEMPTY           (1&lt;&lt;3)</span>
<span class="cp">#define   CR_RECFULL            (1&lt;&lt;2)</span>
<span class="cp">#define   CR_PLAYHALF           (1&lt;&lt;1)</span>
<span class="cp">#define   CR_PLAYFULL           (1&lt;&lt;0)</span>

<span class="cp">#define CR_REG_RESETFIFO        0x0C</span>
<span class="cp">#define   CR_RECRESET           (1&lt;&lt;1)</span>
<span class="cp">#define   CR_PLAYRESET          (1&lt;&lt;0)</span>

<span class="cp">#define CR_REG_CODEC_ADDR       0x10</span>
<span class="cm">/* UG082 says:</span>
<span class="cm"> * #define   CR_CODEC_ADDR(a)  ((a) &lt;&lt; 1)</span>
<span class="cm"> * #define   CR_CODEC_READ     (1&lt;&lt;0)</span>
<span class="cm"> * #define   CR_CODEC_WRITE    (0&lt;&lt;0)</span>
<span class="cm"> */</span>
<span class="cm">/* RefDesign example says: */</span>
<span class="cp">#define   CR_CODEC_ADDR(a)      ((a) &lt;&lt; 0)</span>
<span class="cp">#define   CR_CODEC_READ         (1&lt;&lt;7)</span>
<span class="cp">#define   CR_CODEC_WRITE        (0&lt;&lt;7)</span>

<span class="cp">#define CR_REG_CODEC_DATAREAD   0x14</span>
<span class="cp">#define   CR_CODEC_DATAREAD(v)  ((v) &amp; 0xFFFF)</span>

<span class="cp">#define CR_REG_CODEC_DATAWRITE  0x18</span>
<span class="cp">#define   CR_CODEC_DATAWRITE(v) ((v) &amp; 0xFFFF)</span>

<span class="cp">#define CR_FIFO_SIZE            32</span>

<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="p">{</span>
	<span class="cm">/* lock for access to (controller) registers */</span>
	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="cm">/* mutex for the whole sequence of accesses to (controller) registers</span>
<span class="cm">	 * which affect codec registers</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">cdc_mutex</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span> <span class="cm">/* for playback */</span>
	<span class="kt">int</span> <span class="n">enable_irq</span><span class="p">;</span>	<span class="cm">/* for playback */</span>

	<span class="kt">int</span> <span class="n">capture_irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_capture_irq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_port</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac97_fake</span><span class="p">;</span>
<span class="cp">#ifdef CODEC_STAT</span>
	<span class="kt">int</span> <span class="n">ac97_read</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac97_write</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pfdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_pcm_indirect2</span> <span class="n">ind_rec</span><span class="p">;</span> <span class="cm">/* for playback */</span>
	<span class="k">struct</span> <span class="n">snd_pcm_indirect2</span> <span class="n">capture_ind2_rec</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ml403_ac97cr_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>	            <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>          <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>	    <span class="p">(</span><span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>	    <span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>	    <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>     <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>     <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="n">CR_FIFO_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>      <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>      <span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">CR_FIFO_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>	    <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ml403_ac97cr_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>	            <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>          <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>            <span class="p">(</span><span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span>
			     <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>         <span class="mi">4000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>         <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>     <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>     <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="n">CR_FIFO_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>      <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>      <span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">CR_FIFO_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>	    <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">size_t</span>
<span class="nf">snd_ml403_ac97cr_playback_ind2_zero</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_indirect2</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied_words</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">full</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="n">CR_PLAYFULL</span><span class="p">))</span> <span class="o">!=</span> <span class="n">CR_PLAYFULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">PLAYFIFO</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">copied_words</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">copied_words</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span>
<span class="nf">snd_ml403_ac97cr_playback_ind2_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_indirect2</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied_words</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">sw_data</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">full</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span>
			 <span class="n">CR_PLAYFULL</span><span class="p">))</span> <span class="o">!=</span> <span class="n">CR_PLAYFULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">PLAYFIFO</span><span class="p">),</span>
			 <span class="n">CR_PLAYDATA</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">copied_words</span><span class="p">]));</span>
		<span class="n">copied_words</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">full</span> <span class="o">!=</span> <span class="n">CR_PLAYFULL</span><span class="p">)</span>
		<span class="n">rec</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rec</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">copied_words</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span>
<span class="nf">snd_ml403_ac97cr_capture_ind2_null</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_pcm_indirect2</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied_words</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">empty</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span>
			 <span class="n">CR_RECEMPTY</span><span class="p">))</span> <span class="o">!=</span> <span class="n">CR_RECEMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="n">u32</span> <span class="n">trash</span><span class="p">;</span>

		<span class="n">trash</span> <span class="o">=</span> <span class="n">CR_RECDATA</span><span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">RECFIFO</span><span class="p">)));</span>
		<span class="cm">/* Hmmmm, really necessary? Don&#39;t want call to in_be32()</span>
<span class="cm">		 * to be optimised away!</span>
<span class="cm">		 */</span>
		<span class="n">trash</span><span class="o">++</span><span class="p">;</span>
		<span class="n">copied_words</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">copied_words</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span>
<span class="nf">snd_ml403_ac97cr_capture_ind2_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_pcm_indirect2</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied_words</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">sw_data</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">empty</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span>
			  <span class="n">CR_RECEMPTY</span><span class="p">))</span> <span class="o">!=</span> <span class="n">CR_RECEMPTY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">copied_words</span><span class="p">]</span> <span class="o">=</span> <span class="n">CR_RECDATA</span><span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span>
							      <span class="n">RECFIFO</span><span class="p">)));</span>
		<span class="n">copied_words</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">empty</span> <span class="o">!=</span> <span class="n">CR_RECEMPTY</span><span class="p">)</span>
		<span class="n">rec</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rec</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">copied_words</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span>
<span class="nf">snd_ml403_ac97cr_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_indirect2</span> <span class="o">*</span><span class="n">ind2_rec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">)</span>
		<span class="n">ind2_rec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span>
		<span class="n">ind2_rec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ind2_rec</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_pcm_indirect2_pointer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">ind2_rec</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">snd_pcm_uframes_t</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_ml403_ac97cr_pcm_playback_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;trigger(playback): START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">.</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* clear play FIFO */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">RESETFIFO</span><span class="p">),</span> <span class="n">CR_PLAYRESET</span><span class="p">);</span>

		<span class="cm">/* enable play irq */</span>
		<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">enable_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;trigger(playback): STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">.</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef SND_PCM_INDIRECT2_STAT</span>
		<span class="n">snd_pcm_indirect2_stat</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* disable play irq */</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">enable_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;trigger(playback): (done)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_ml403_ac97cr_pcm_capture_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;trigger(capture): START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">.</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* clear record FIFO */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">RESETFIFO</span><span class="p">),</span> <span class="n">CR_RECRESET</span><span class="p">);</span>

		<span class="cm">/* enable record irq */</span>
		<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">enable_capture_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_irq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;trigger(capture): STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">.</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef SND_PCM_INDIRECT2_STAT</span>
		<span class="n">snd_pcm_indirect2_stat</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* disable capture irq */</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_irq</span><span class="p">);</span>
		<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">enable_capture_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;trigger(capture): (done)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_ml403_ac97cr_pcm_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span>
	       <span class="s">&quot;prepare(): period_bytes=%d, minperiod_bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">),</span> <span class="n">CR_FIFO_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* set sampling rate */</span>
	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span>
			  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;prepare(): rate=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="cm">/* init struct for intermediate buffer */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_indirect2</span><span class="p">));</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">.</span><span class="n">hw_buffer_size</span> <span class="o">=</span> <span class="n">CR_FIFO_SIZE</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">.</span><span class="n">sw_buffer_size</span> <span class="o">=</span>
		<span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">.</span><span class="n">min_periods</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">.</span><span class="n">min_multiple</span> <span class="o">=</span>
		<span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">CR_FIFO_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;prepare(): hw_buffer_size=%d, &quot;</span>
	       <span class="s">&quot;sw_buffer_size=%d, min_multiple=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">CR_FIFO_SIZE</span><span class="p">,</span> <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">.</span><span class="n">sw_buffer_size</span><span class="p">,</span>
	       <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">.</span><span class="n">min_multiple</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_ml403_ac97cr_pcm_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span>
	       <span class="s">&quot;prepare(capture): period_bytes=%d, minperiod_bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">),</span> <span class="n">CR_FIFO_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* set sampling rate */</span>
	<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_PCM_LR_ADC_RATE</span><span class="p">,</span>
			  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;prepare(capture): rate=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="cm">/* init struct for intermediate buffer */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_indirect2</span><span class="p">));</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">.</span><span class="n">hw_buffer_size</span> <span class="o">=</span> <span class="n">CR_FIFO_SIZE</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">.</span><span class="n">sw_buffer_size</span> <span class="o">=</span>
		<span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">.</span><span class="n">min_multiple</span> <span class="o">=</span>
		<span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">CR_FIFO_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;prepare(capture): hw_buffer_size=%d, &quot;</span>
	       <span class="s">&quot;sw_buffer_size=%d, min_multiple=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CR_FIFO_SIZE</span><span class="p">,</span>
	       <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">.</span><span class="n">sw_buffer_size</span><span class="p">,</span>
	       <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">.</span><span class="n">min_multiple</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ml403_ac97cr_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;hw_free()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_ml403_ac97cr_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;hw_params(): desired buffer bytes=%d, desired &quot;</span>
	       <span class="s">&quot;period bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span> <span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
					<span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ml403_ac97cr_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;open(playback)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_playback</span><span class="p">;</span>

	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span>
				   <span class="n">CR_FIFO_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ml403_ac97cr_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;open(capture)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_capture</span><span class="p">;</span>

	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span>
				   <span class="n">CR_FIFO_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ml403_ac97cr_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;close(playback)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ml403_ac97cr_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">WORK_INFO</span><span class="p">,</span> <span class="s">&quot;close(capture)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ml403_ac97cr_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_pcm_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_pcm_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ml403_ac97cr_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_pcm_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_pcm_capture_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_ml403_ac97cr_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pfdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp_irq</span><span class="p">;</span>

	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ml403_ac97cr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">pfdev</span> <span class="o">=</span> <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">pfdev</span><span class="p">;</span>

	<span class="cm">/* playback interrupt */</span>
	<span class="n">cmp_irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pfdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">cmp_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">enable_irq</span><span class="p">)</span>
			<span class="n">snd_pcm_indirect2_playback_interrupt</span><span class="p">(</span>
				<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ind_rec</span><span class="p">,</span>
				<span class="n">snd_ml403_ac97cr_playback_ind2_copy</span><span class="p">,</span>
				<span class="n">snd_ml403_ac97cr_playback_ind2_zero</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">__disable_irq</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* record interrupt */</span>
		<span class="n">cmp_irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pfdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">cmp_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">enable_capture_irq</span><span class="p">)</span>
				<span class="n">snd_pcm_indirect2_capture_interrupt</span><span class="p">(</span>
					<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_ind2_rec</span><span class="p">,</span>
					<span class="n">snd_ml403_ac97cr_capture_ind2_copy</span><span class="p">,</span>
					<span class="n">snd_ml403_ac97cr_capture_ind2_null</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">__disable_irq</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

<span class="nl">__disable_irq:</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;irq(): irq %d is meant to be disabled! So, now try &quot;</span>
	       <span class="s">&quot;to disable it _really_!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span>
<span class="nf">snd_ml403_ac97cr_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<span class="cp">#ifdef CODEC_STAT</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rafaccess</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">LM4550_RF_OK</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
			   <span class="s">&quot;access to unknown/unused codec register 0x%x &quot;</span>
			   <span class="s">&quot;ignored!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check if we can fake/answer this access from our shadow register */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">LM4550_REG_DONEREAD</span> <span class="o">|</span> <span class="n">LM4550_REG_ALLFAKE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LM4550_REG_NOSHADOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LM4550_REG_FAKEREAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_FAKE</span><span class="p">,</span> <span class="s">&quot;codec_read(): faking read from &quot;</span>
			       <span class="s">&quot;reg=0x%x, val=0x%x / %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">def</span><span class="p">,</span>
			       <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">def</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">def</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span>
			    <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_fake</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_FAKE</span><span class="p">,</span> <span class="s">&quot;codec_read(): faking read from &quot;</span>
			       <span class="s">&quot;reg=0x%x, val=0x%x / %d (probe)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
			       <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CODEC_STAT</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_FAKE</span><span class="p">,</span> <span class="s">&quot;codec_read(): read access &quot;</span>
			       <span class="s">&quot;answered by shadow register 0x%x (value=0x%x &quot;</span>
			       <span class="s">&quot;/ %d) (cw=%d cr=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
			       <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
			       <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_write</span><span class="p">,</span>
			       <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_read</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_FAKE</span><span class="p">,</span> <span class="s">&quot;codec_read(): read access &quot;</span>
			       <span class="s">&quot;answered by shadow register 0x%x (value=0x%x &quot;</span>
			       <span class="s">&quot;/ %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
			       <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* if we are here, we _have_ to access the codec really, no faking */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">cdc_mutex</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CODEC_STAT</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_read</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">CODEC_ADDR</span><span class="p">),</span>
		 <span class="n">CR_CODEC_ADDR</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">CR_CODEC_READ</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="n">CODEC_TIMEOUT_AFTER_READ</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifdef CODEC_STAT</span>
		<span class="n">rafaccess</span><span class="o">++</span><span class="p">;</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">CR_RAF</span><span class="p">)</span> <span class="o">==</span> <span class="n">CR_RAF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">CR_CODEC_DATAREAD</span><span class="p">(</span>
				<span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">CODEC_DATAREAD</span><span class="p">)));</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_SUCCESS</span><span class="p">,</span> <span class="s">&quot;codec_read(): (done) reg=0x%x, &quot;</span>
			       <span class="s">&quot;value=0x%x / %d (STATUS=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span>
		     <span class="n">CR_RAF</span><span class="p">)</span> <span class="o">==</span> <span class="n">CR_RAF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">CR_CODEC_DATAREAD</span><span class="p">(</span>
				<span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">CODEC_DATAREAD</span><span class="p">)));</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_SUCCESS</span><span class="p">,</span> <span class="s">&quot;codec_read(): (done) &quot;</span>
			       <span class="s">&quot;reg=0x%x, value=0x%x / %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">LM4550_REG_DONEREAD</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">cdc_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="cm">/* read the DATAREAD register anyway, see comment below */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span>
	    <span class="n">CR_CODEC_DATAREAD</span><span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">CODEC_DATAREAD</span><span class="p">)));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifdef CODEC_STAT</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
		   <span class="s">&quot;timeout while codec read! &quot;</span>
		   <span class="s">&quot;(reg=0x%x, last STATUS=0x%x, DATAREAD=0x%x / %d, %d) &quot;</span>
		   <span class="s">&quot;(cw=%d, cr=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">reg</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">rafaccess</span><span class="p">,</span>
		   <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_write</span><span class="p">,</span> <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_read</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
		   <span class="s">&quot;timeout while codec read! &quot;</span>
		   <span class="s">&quot;(reg=0x%x, DATAREAD=0x%x / %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* BUG: This is PURE speculation! But after _most_ read timeouts the</span>
<span class="cm">	 * value in the register is ok!</span>
<span class="cm">	 */</span>
	<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">LM4550_REG_DONEREAD</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">cdc_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">snd_ml403_ac97cr_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

<span class="cp">#ifdef CODEC_STAT</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rafaccess</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CODEC_WRITE_CHECK_RAF</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">LM4550_RF_OK</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
			   <span class="s">&quot;access to unknown/unused codec register 0x%x &quot;</span>
			   <span class="s">&quot;ignored!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LM4550_REG_READONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
			   <span class="s">&quot;write access to read only codec register 0x%x &quot;</span>
			   <span class="s">&quot;ignored!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">wmask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
			   <span class="s">&quot;write access to codec register 0x%x &quot;</span>
			   <span class="s">&quot;with bad value 0x%x / %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">wmask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LM4550_REG_FAKEPROBE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_fake</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LM4550_REG_NOSHADOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_FAKE</span><span class="p">,</span> <span class="s">&quot;codec_write(): faking write to reg=0x%x, &quot;</span>
		       <span class="s">&quot;val=0x%x / %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span>
						<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">wmask</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">cdc_mutex</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef CODEC_STAT</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_write</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">CODEC_DATAWRITE</span><span class="p">),</span>
		 <span class="n">CR_CODEC_DATAWRITE</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">CODEC_ADDR</span><span class="p">),</span>
		 <span class="n">CR_CODEC_ADDR</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">CR_CODEC_WRITE</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifdef CODEC_WRITE_CHECK_RAF</span>
	<span class="cm">/* check CR_CODEC_RAF bit to see if write access to register is done;</span>
<span class="cm">	 * loop until bit is set or timeout happens</span>
<span class="cm">	 */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">CODEC_TIMEOUT_AFTER_WRITE</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="cp">#ifdef CODEC_STAT</span>
		<span class="n">rafaccess</span><span class="o">++</span><span class="p">;</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">CR_RAF</span><span class="p">)</span> <span class="o">==</span> <span class="n">CR_RAF</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span>
		     <span class="n">CR_RAF</span><span class="p">)</span> <span class="o">==</span> <span class="n">CR_RAF</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_SUCCESS</span><span class="p">,</span> <span class="s">&quot;codec_write(): (done) &quot;</span>
			       <span class="s">&quot;reg=0x%x, value=%d / 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span>
			      <span class="n">LM4550_REG_NOSHADOW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span>
			      <span class="n">LM4550_REG_NOSAVE</span><span class="p">))</span>
				<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">lm4550_regfile</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">LM4550_REG_DONEREAD</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">cdc_mutex</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
<span class="cp">#ifdef CODEC_STAT</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
		   <span class="s">&quot;timeout while codec write &quot;</span>
		   <span class="s">&quot;(reg=0x%x, val=0x%x / %d, last STATUS=0x%x, %d) &quot;</span>
		   <span class="s">&quot;(cw=%d, cr=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">rafaccess</span><span class="p">,</span> <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_write</span><span class="p">,</span>
		   <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_read</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
		   <span class="s">&quot;timeout while codec write (reg=0x%x, val=0x%x / %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#else </span><span class="cm">/* CODEC_WRITE_CHECK_RAF */</span><span class="cp"></span>
<span class="cp">#if CODEC_WAIT_AFTER_WRITE &gt; 0</span>
	<span class="cm">/* officially, in AC97 spec there is no possibility for a AC97</span>
<span class="cm">	 * controller to determine, if write access is done or not - so: How</span>
<span class="cm">	 * is Xilinx able to provide a RAF bit for write access?</span>
<span class="cm">	 * =&gt; very strange, thus just don&#39;t check RAF bit (compare with</span>
<span class="cm">	 * Xilinx&#39;s example app in EDK 8.1i) and wait</span>
<span class="cm">	 */</span>
	<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="n">CODEC_WAIT_AFTER_WRITE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">CODEC_SUCCESS</span><span class="p">,</span> <span class="s">&quot;codec_write(): (done) &quot;</span>
	       <span class="s">&quot;reg=0x%x, value=%d / 0x%x (no RAF check)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">cdc_mutex</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="n">snd_ml403_ac97cr_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;chip_init():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">CODEC_TIMEOUT_ON_INIT</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CR_CODECREADY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear both hardware FIFOs */</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="n">CR_REG</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="n">RESETFIFO</span><span class="p">),</span>
				 <span class="n">CR_RECRESET</span> <span class="o">|</span> <span class="n">CR_PLAYRESET</span><span class="p">);</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;chip_init(): (done)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
		   <span class="s">&quot;timeout while waiting for codec, &quot;</span>
		   <span class="s">&quot;not ready!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_ml403_ac97cr_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;free():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* irq release */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ml403_ac97cr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_irq</span><span class="p">,</span> <span class="n">ml403_ac97cr</span><span class="p">);</span>
	<span class="cm">/* give back &quot;port&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;free(): (done)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_ml403_ac97cr_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">snddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">snddev</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;dev_free():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ml403_ac97cr_free</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="n">snd_ml403_ac97cr_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pfdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">**</span><span class="n">rml403_ac97cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_dev_free</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rml403_ac97cr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ml403_ac97cr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">cdc_mutex</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">pfdev</span> <span class="o">=</span> <span class="n">pfdev</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">enable_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">enable_capture_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">res_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;Trying to reserve resources now ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">resource</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pfdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* get &quot;port&quot; */</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					     <span class="p">(</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span>
					     <span class="p">(</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
			   <span class="s">&quot;unable to remap memory region (%pR)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">resource</span><span class="p">);</span>
		<span class="n">snd_ml403_ac97cr_free</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
		   <span class="s">&quot;remap controller memory region to &quot;</span>
		   <span class="s">&quot;0x%x done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* get irq */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pfdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_ml403_ac97cr_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ml403_ac97cr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
			   <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_ml403_ac97cr_free</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
		   <span class="s">&quot;request (playback) irq %d done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pfdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_ml403_ac97cr_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ml403_ac97cr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
			   <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_ml403_ac97cr_free</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">SND_ML403_AC97CR_DRIVER</span> <span class="s">&quot;: &quot;</span>
		   <span class="s">&quot;request (capture) irq %d done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_irq</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_chip_init</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ml403_ac97cr_free</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_FAILURE</span><span class="p">,</span> <span class="s">&quot;probe(): snd_device_new() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_ml403_ac97cr_free</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rml403_ac97cr</span> <span class="o">=</span> <span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_ml403_ac97cr_mixer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;mixer_free():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;mixer_free(): (done)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="n">snd_ml403_ac97cr_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_codec_read</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;mixer():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_fake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lm4550_regfile_init</span><span class="p">();</span>
<span class="cp">#ifdef CODEC_STAT</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_mixer_free</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">scaps</span> <span class="o">=</span> <span class="n">AC97_SCAP_AUDIO</span> <span class="o">|</span> <span class="n">AC97_SCAP_SKIP_MODEM</span> <span class="o">|</span>
	    <span class="n">AC97_SCAP_NO_SPDIF</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97_fake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lm4550_regfile_write_values_after_init</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;mixer(): (done) snd_ac97_mixer()=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="n">snd_ml403_ac97cr_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span><span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ML403AC97CR/1&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_ml403_ac97cr_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_ml403_ac97cr_capture_ops</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ML403AC97CR DAC/ADC&quot;</span><span class="p">);</span>
	<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_CONTINUOUS</span><span class="p">,</span>
					  <span class="n">snd_dma_continuous_data</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">),</span>
					  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
					  <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">snd_ml403_ac97cr_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pfdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ml403_ac97cr</span> <span class="o">*</span><span class="n">ml403_ac97cr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">pfdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pfdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_FAILURE</span><span class="p">,</span> <span class="s">&quot;probe(): create failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;probe(): create done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ml403_ac97cr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_mixer</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;probe(): mixer done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_pcm</span><span class="p">(</span><span class="n">ml403_ac97cr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;probe(): PCM done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">SND_ML403_AC97CR_DRIVER</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;ML403 AC97 Controller Reference&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s %s at 0x%lx, irq %i &amp; %i, device %i&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		<span class="n">ml403_ac97cr</span><span class="o">-&gt;</span><span class="n">capture_irq</span><span class="p">,</span> <span class="n">dev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pfdev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">INIT_INFO</span><span class="p">,</span> <span class="s">&quot;probe(): (done)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_ml403_ac97cr_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pfdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pfdev</span><span class="p">));</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pfdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* work with hotplug and coldplug */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">SND_ML403_AC97CR_DRIVER</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">snd_ml403_ac97cr_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">snd_ml403_ac97cr_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SND_ML403_AC97CR_DRIVER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">snd_ml403_ac97cr_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
