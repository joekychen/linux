<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › drivers › opl3 › opl3_synth.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>opl3_synth.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) by Uros Bizjak &lt;uros@kss-loka.si&gt;</span>
<span class="cm"> *                   </span>
<span class="cm"> *  Routines for OPL2/OPL3/OPL4 control</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify </span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;sound/opl3.h&gt;</span>
<span class="cp">#include &lt;sound/asound_fm.h&gt;</span>

<span class="cp">#if defined(CONFIG_SND_SEQUENCER) || defined(CONFIG_SND_SEQUENCER_MODULE)</span>
<span class="cp">#define OPL3_SUPPORT_SYNTH</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *    There is 18 possible 2 OP voices</span>
<span class="cm"> *      (9 in the left and 9 in the right).</span>
<span class="cm"> *      The first OP is the modulator and 2nd is the carrier.</span>
<span class="cm"> *</span>
<span class="cm"> *      The first three voices in the both sides may be connected</span>
<span class="cm"> *      with another voice to a 4 OP voice. For example voice 0</span>
<span class="cm"> *      can be connected with voice 3. The operators of voice 3 are</span>
<span class="cm"> *      used as operators 3 and 4 of the new 4 OP voice.</span>
<span class="cm"> *      In this case the 2 OP voice number 0 is the &#39;first half&#39; and</span>
<span class="cm"> *      voice 3 is the second.</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> *    Register offset table for OPL2/3 voices,</span>
<span class="cm"> *    OPL2 / one OPL3 register array side only</span>
<span class="cm"> */</span>

<span class="kt">char</span> <span class="n">snd_opl3_regmap</span><span class="p">[</span><span class="n">MAX_OPL2_VOICES</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cm">/*	  OP1   OP2   OP3   OP4		*/</span>
<span class="cm">/*	 ------------------------	*/</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0d</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>	<span class="cm">/* used by percussive voices */</span>
	<span class="p">{</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>	<span class="cm">/* if the percussive mode */</span>
	<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>	<span class="cm">/* is selected (only left reg block) */</span>
<span class="p">};</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_opl3_regmap</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_opl3_play_note</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_dm_fm_note</span> <span class="o">*</span> <span class="n">note</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_opl3_set_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_dm_fm_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_opl3_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_dm_fm_params</span> <span class="o">*</span> <span class="n">params</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_opl3_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_opl3_set_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">connection</span><span class="p">);</span>

<span class="cm">/* ------------------------------ */</span>

<span class="cm">/*</span>
<span class="cm"> * open the device exclusively</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_opl3_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span> <span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ioctl for hwdep device:</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_opl3_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span> <span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">opl3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get information */</span>
	<span class="k">case</span> <span class="n">SNDRV_DM_FM_IOCTL_INFO</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_dm_fm_info</span> <span class="n">info</span><span class="p">;</span>

			<span class="n">info</span><span class="p">.</span><span class="n">fm_mode</span> <span class="o">=</span> <span class="n">opl3</span><span class="o">-&gt;</span><span class="n">fm_mode</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">rhythm</span> <span class="o">=</span> <span class="n">opl3</span><span class="o">-&gt;</span><span class="n">rhythm</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dm_fm_info</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">SNDRV_DM_FM_IOCTL_RESET</span>:
<span class="cp">#ifdef CONFIG_SND_OSSEMUL</span>
	<span class="k">case</span> <span class="n">SNDRV_DM_FM_OSS_IOCTL_RESET</span>:
<span class="cp">#endif</span>
		<span class="n">snd_opl3_reset</span><span class="p">(</span><span class="n">opl3</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_DM_FM_IOCTL_PLAY_NOTE</span>:
<span class="cp">#ifdef CONFIG_SND_OSSEMUL</span>
	<span class="k">case</span> <span class="n">SNDRV_DM_FM_OSS_IOCTL_PLAY_NOTE</span>:
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_dm_fm_note</span> <span class="n">note</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">note</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dm_fm_note</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snd_opl3_play_note</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">note</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">SNDRV_DM_FM_IOCTL_SET_VOICE</span>:
<span class="cp">#ifdef CONFIG_SND_OSSEMUL</span>
	<span class="k">case</span> <span class="n">SNDRV_DM_FM_OSS_IOCTL_SET_VOICE</span>:
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_dm_fm_voice</span> <span class="n">voice</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">voice</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dm_fm_voice</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snd_opl3_set_voice</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">voice</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">SNDRV_DM_FM_IOCTL_SET_PARAMS</span>:
<span class="cp">#ifdef CONFIG_SND_OSSEMUL</span>
	<span class="k">case</span> <span class="n">SNDRV_DM_FM_OSS_IOCTL_SET_PARAMS</span>:
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_dm_fm_params</span> <span class="n">params</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dm_fm_params</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snd_opl3_set_params</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">SNDRV_DM_FM_IOCTL_SET_MODE</span>:
<span class="cp">#ifdef CONFIG_SND_OSSEMUL</span>
	<span class="k">case</span> <span class="n">SNDRV_DM_FM_OSS_IOCTL_SET_MODE</span>:
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">snd_opl3_set_mode</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDRV_DM_FM_IOCTL_SET_CONNECTION</span>:
<span class="cp">#ifdef CONFIG_SND_OSSEMUL</span>
	<span class="k">case</span> <span class="n">SNDRV_DM_FM_OSS_IOCTL_SET_OPL</span>:
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">snd_opl3_set_connection</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

<span class="cp">#ifdef OPL3_SUPPORT_SYNTH</span>
	<span class="k">case</span> <span class="n">SNDRV_DM_FM_IOCTL_CLEAR_PATCHES</span>:
		<span class="n">snd_opl3_clear_patches</span><span class="p">(</span><span class="n">opl3</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;unknown IOCTL: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * close the device</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_opl3_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span> <span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_opl3_reset</span><span class="p">(</span><span class="n">opl3</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef OPL3_SUPPORT_SYNTH</span>
<span class="cm">/*</span>
<span class="cm"> * write the device - load patches</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="nf">snd_opl3_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span>
		    <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbi_patch</span> <span class="n">inst</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">FM_KEY_SBI</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">FM_KEY_2OP</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">FM_PATCH_OPL2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">FM_KEY_4OP</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">FM_PATCH_OPL3</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* invalid type */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_opl3_load_patch</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">prog</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">bank</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
					  <span class="n">inst</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">extension</span><span class="p">,</span>
					  <span class="n">inst</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">result</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Patch management</span>
<span class="cm"> */</span>

<span class="cm">/* offsets for SBI params */</span>
<span class="cp">#define AM_VIB		0</span>
<span class="cp">#define KSL_LEVEL	2</span>
<span class="cp">#define ATTACK_DECAY	4</span>
<span class="cp">#define SUSTAIN_RELEASE	6</span>
<span class="cp">#define WAVE_SELECT	8</span>

<span class="cm">/* offset for SBI instrument */</span>
<span class="cp">#define CONNECTION	10</span>
<span class="cp">#define OFFSET_4OP	11</span>

<span class="cm">/*</span>
<span class="cm"> * load a patch, obviously.</span>
<span class="cm"> *</span>
<span class="cm"> * loaded on the given program and bank numbers with the given type</span>
<span class="cm"> * (FM_PATCH_OPLx).</span>
<span class="cm"> * data is the pointer of SBI record _without_ header (key and name).</span>
<span class="cm"> * name is the name string of the patch.</span>
<span class="cm"> * ext is the extension data of 7 bytes long (stored in name of SBI</span>
<span class="cm"> * data up to offset 25), or NULL to skip.</span>
<span class="cm"> * return 0 if successful or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_opl3_load_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">prog</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ext</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fm_patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">patch</span> <span class="o">=</span> <span class="n">snd_opl3_find_patch</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">patch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_vib</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">AM_VIB</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ksl_level</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">KSL_LEVEL</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attack_decay</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ATTACK_DECAY</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sustain_release</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">SUSTAIN_RELEASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wave_select</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">WAVE_SELECT</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">feedback_connection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">CONNECTION</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FM_PATCH_OPL3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">am_vib</span> <span class="o">=</span>
				<span class="n">data</span><span class="p">[</span><span class="n">OFFSET_4OP</span> <span class="o">+</span> <span class="n">AM_VIB</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
			<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ksl_level</span> <span class="o">=</span>
				<span class="n">data</span><span class="p">[</span><span class="n">OFFSET_4OP</span> <span class="o">+</span> <span class="n">KSL_LEVEL</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
			<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">attack_decay</span> <span class="o">=</span>
				<span class="n">data</span><span class="p">[</span><span class="n">OFFSET_4OP</span> <span class="o">+</span> <span class="n">ATTACK_DECAY</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
			<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">sustain_release</span> <span class="o">=</span>
				<span class="n">data</span><span class="p">[</span><span class="n">OFFSET_4OP</span> <span class="o">+</span> <span class="n">SUSTAIN_RELEASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
			<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">wave_select</span> <span class="o">=</span>
				<span class="n">data</span><span class="p">[</span><span class="n">OFFSET_4OP</span> <span class="o">+</span> <span class="n">WAVE_SELECT</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">feedback_connection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">data</span><span class="p">[</span><span class="n">OFFSET_4OP</span> <span class="o">+</span> <span class="n">CONNECTION</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">echo_delay</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">echo_atten</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">chorus_spread</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">trnsps</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">fix_dur</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">modes</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">patch</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">fix_key</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_opl3_load_patch</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * find a patch with the given program and bank numbers, returns its pointer</span>
<span class="cm"> * if no matching patch is found and create_patch is set, it creates a</span>
<span class="cm"> * new patch object.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fm_patch</span> <span class="o">*</span><span class="nf">snd_opl3_find_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prog</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">create_patch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* pretty dumb hash key */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">prog</span> <span class="o">+</span> <span class="n">bank</span><span class="p">)</span> <span class="o">%</span> <span class="n">OPL3_PATCH_HASH_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">patch</span> <span class="o">=</span> <span class="n">opl3</span><span class="o">-&gt;</span><span class="n">patch_table</span><span class="p">[</span><span class="n">key</span><span class="p">];</span> <span class="n">patch</span><span class="p">;</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">prog</span> <span class="o">==</span> <span class="n">prog</span> <span class="o">&amp;&amp;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">==</span> <span class="n">bank</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">patch</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">create_patch</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">patch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">patch</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">patch</span><span class="o">-&gt;</span><span class="n">prog</span> <span class="o">=</span> <span class="n">prog</span><span class="p">;</span>
	<span class="n">patch</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">bank</span><span class="p">;</span>
	<span class="n">patch</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">opl3</span><span class="o">-&gt;</span><span class="n">patch_table</span><span class="p">[</span><span class="n">key</span><span class="p">];</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">patch_table</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">patch</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_opl3_find_patch</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Clear all patches of the given OPL3 instance</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_opl3_clear_patches</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">OPL3_PATCH_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fm_patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">patch</span> <span class="o">=</span> <span class="n">opl3</span><span class="o">-&gt;</span><span class="n">patch_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">patch</span><span class="p">;</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">patch_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">patch_table</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* OPL3_SUPPORT_SYNTH */</span><span class="cp"></span>

<span class="cm">/* ------------------------------ */</span>

<span class="kt">void</span> <span class="nf">snd_opl3_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">opl3_reg</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg_side</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">voice_offset</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">max_voices</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">max_voices</span> <span class="o">=</span> <span class="p">(</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">&lt;</span> <span class="n">OPL3_HW_OPL3</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">MAX_OPL2_VOICES</span> <span class="o">:</span> <span class="n">MAX_OPL3_VOICES</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_voices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get register array side and offset of voice */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_OPL2_VOICES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Left register block for voices 0 .. 8 */</span>
			<span class="n">reg_side</span> <span class="o">=</span> <span class="n">OPL3_LEFT</span><span class="p">;</span>
			<span class="n">voice_offset</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Right register block for voices 9 .. 17 */</span>
			<span class="n">reg_side</span> <span class="o">=</span> <span class="n">OPL3_RIGHT</span><span class="p">;</span>
			<span class="n">voice_offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">MAX_OPL2_VOICES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_KSL_LEVEL</span> <span class="o">+</span> <span class="n">snd_opl3_regmap</span><span class="p">[</span><span class="n">voice_offset</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">OPL3_TOTAL_LEVEL_MASK</span><span class="p">);</span> <span class="cm">/* Operator 1 volume */</span>
		<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_KSL_LEVEL</span> <span class="o">+</span> <span class="n">snd_opl3_regmap</span><span class="p">[</span><span class="n">voice_offset</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">OPL3_TOTAL_LEVEL_MASK</span><span class="p">);</span> <span class="cm">/* Operator 2 volume */</span>

		<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_KEYON_BLOCK</span> <span class="o">+</span> <span class="n">voice_offset</span><span class="p">);</span>
		<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* Note off */</span>
	<span class="p">}</span>

	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">max_voices</span> <span class="o">=</span> <span class="n">MAX_OPL2_VOICES</span><span class="p">;</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">fm_mode</span> <span class="o">=</span> <span class="n">SNDRV_DM_FM_MODE_OPL2</span><span class="p">;</span>

	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">OPL3_LEFT</span> <span class="o">|</span> <span class="n">OPL3_REG_TEST</span><span class="p">,</span> <span class="n">OPL3_ENABLE_WAVE_SELECT</span><span class="p">);</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">OPL3_LEFT</span> <span class="o">|</span> <span class="n">OPL3_REG_PERCUSSION</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* Melodic mode */</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">rhythm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_opl3_reset</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_opl3_play_note</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_dm_fm_note</span> <span class="o">*</span> <span class="n">note</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg_side</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">voice_offset</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">opl3_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="cm">/* Voices 0 -  8 in OPL2 mode */</span>
	<span class="cm">/* Voices 0 - 17 in OPL3 mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">note</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">fm_mode</span> <span class="o">==</span> <span class="n">SNDRV_DM_FM_MODE_OPL3</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">MAX_OPL3_VOICES</span> <span class="o">:</span> <span class="n">MAX_OPL2_VOICES</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Get register array side and offset of voice */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">note</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">&lt;</span> <span class="n">MAX_OPL2_VOICES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Left register block for voices 0 .. 8 */</span>
		<span class="n">reg_side</span> <span class="o">=</span> <span class="n">OPL3_LEFT</span><span class="p">;</span>
		<span class="n">voice_offset</span> <span class="o">=</span> <span class="n">note</span><span class="o">-&gt;</span><span class="n">voice</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Right register block for voices 9 .. 17 */</span>
		<span class="n">reg_side</span> <span class="o">=</span> <span class="n">OPL3_RIGHT</span><span class="p">;</span>
		<span class="n">voice_offset</span> <span class="o">=</span> <span class="n">note</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">-</span> <span class="n">MAX_OPL2_VOICES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set lower 8 bits of note frequency */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">note</span><span class="o">-&gt;</span><span class="n">fnum</span><span class="p">;</span>
	<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_FNUM_LOW</span> <span class="o">+</span> <span class="n">voice_offset</span><span class="p">);</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>
	
	<span class="n">reg_val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="cm">/* Set output sound flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">note</span><span class="o">-&gt;</span><span class="n">key_on</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_KEYON_BIT</span><span class="p">;</span>
	<span class="cm">/* Set octave */</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">note</span><span class="o">-&gt;</span><span class="n">octave</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OPL3_BLOCKNUM_MASK</span><span class="p">;</span>
	<span class="cm">/* Set higher 2 bits of note frequency */</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">note</span><span class="o">-&gt;</span><span class="n">fnum</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OPL3_FNUM_HIGH_MASK</span><span class="p">;</span>

	<span class="cm">/* Set OPL3 KEYON_BLOCK register of requested voice */</span> 
	<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_KEYON_BLOCK</span> <span class="o">+</span> <span class="n">voice_offset</span><span class="p">);</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_opl3_set_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_dm_fm_voice</span> <span class="o">*</span> <span class="n">voice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg_side</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">op_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">voice_offset</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">opl3_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="cm">/* Only operators 1 and 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Voices 0 -  8 in OPL2 mode */</span>
	<span class="cm">/* Voices 0 - 17 in OPL3 mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">fm_mode</span> <span class="o">==</span> <span class="n">SNDRV_DM_FM_MODE_OPL3</span><span class="p">)</span> <span class="o">?</span>
			     <span class="n">MAX_OPL3_VOICES</span> <span class="o">:</span> <span class="n">MAX_OPL2_VOICES</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Get register array side and offset of voice */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">&lt;</span> <span class="n">MAX_OPL2_VOICES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Left register block for voices 0 .. 8 */</span>
		<span class="n">reg_side</span> <span class="o">=</span> <span class="n">OPL3_LEFT</span><span class="p">;</span>
		<span class="n">voice_offset</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">voice</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Right register block for voices 9 .. 17 */</span>
		<span class="n">reg_side</span> <span class="o">=</span> <span class="n">OPL3_RIGHT</span><span class="p">;</span>
		<span class="n">voice_offset</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">voice</span> <span class="o">-</span> <span class="n">MAX_OPL2_VOICES</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Get register offset of operator */</span>
	<span class="n">op_offset</span> <span class="o">=</span> <span class="n">snd_opl3_regmap</span><span class="p">[</span><span class="n">voice_offset</span><span class="p">][</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">];</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="cm">/* Set amplitude modulation (tremolo) effect */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">am</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_TREMOLO_ON</span><span class="p">;</span>
	<span class="cm">/* Set vibrato effect */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">vibrato</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_VIBRATO_ON</span><span class="p">;</span>
	<span class="cm">/* Set sustaining sound phase */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">do_sustain</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_SUSTAIN_ON</span><span class="p">;</span>
	<span class="cm">/* Set keyboard scaling bit */</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">kbd_scale</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_KSR</span><span class="p">;</span>
	<span class="cm">/* Set harmonic or frequency multiplier */</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">harmonic</span> <span class="o">&amp;</span> <span class="n">OPL3_MULTIPLE_MASK</span><span class="p">;</span>

	<span class="cm">/* Set OPL3 AM_VIB register of requested voice/operator */</span> 
	<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_AM_VIB</span> <span class="o">+</span> <span class="n">op_offset</span><span class="p">);</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="cm">/* Set decreasing volume of higher notes */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">scale_level</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OPL3_KSL_MASK</span><span class="p">;</span>
	<span class="cm">/* Set output volume */</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="o">~</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">volume</span> <span class="o">&amp;</span> <span class="n">OPL3_TOTAL_LEVEL_MASK</span><span class="p">;</span>

	<span class="cm">/* Set OPL3 KSL_LEVEL register of requested voice/operator */</span> 
	<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_KSL_LEVEL</span> <span class="o">+</span> <span class="n">op_offset</span><span class="p">);</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="cm">/* Set attack phase level */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">attack</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OPL3_ATTACK_MASK</span><span class="p">;</span>
	<span class="cm">/* Set decay phase level */</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">decay</span> <span class="o">&amp;</span> <span class="n">OPL3_DECAY_MASK</span><span class="p">;</span>

	<span class="cm">/* Set OPL3 ATTACK_DECAY register of requested voice/operator */</span> 
	<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_ATTACK_DECAY</span> <span class="o">+</span> <span class="n">op_offset</span><span class="p">);</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="cm">/* Set sustain phase level */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">sustain</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OPL3_SUSTAIN_MASK</span><span class="p">;</span>
	<span class="cm">/* Set release phase level */</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">&amp;</span> <span class="n">OPL3_RELEASE_MASK</span><span class="p">;</span>

	<span class="cm">/* Set OPL3 SUSTAIN_RELEASE register of requested voice/operator */</span> 
	<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_SUSTAIN_RELEASE</span> <span class="o">+</span> <span class="n">op_offset</span><span class="p">);</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="cm">/* Set inter-operator feedback */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">feedback</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OPL3_FEEDBACK_MASK</span><span class="p">;</span>
	<span class="cm">/* Set inter-operator connection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">connection</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_CONNECTION_BIT</span><span class="p">;</span>
	<span class="cm">/* OPL-3 only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">fm_mode</span> <span class="o">==</span> <span class="n">SNDRV_DM_FM_MODE_OPL3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
			<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_VOICE_TO_LEFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span>
			<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_VOICE_TO_RIGHT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Feedback/connection bits are applicable to voice */</span>
	<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_FEEDBACK_CONNECTION</span> <span class="o">+</span> <span class="n">voice_offset</span><span class="p">);</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="cm">/* Select waveform */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">waveform</span> <span class="o">&amp;</span> <span class="n">OPL3_WAVE_SELECT_MASK</span><span class="p">;</span>
	<span class="n">opl3_reg</span> <span class="o">=</span> <span class="n">reg_side</span> <span class="o">|</span> <span class="p">(</span><span class="n">OPL3_REG_WAVE_SELECT</span> <span class="o">+</span> <span class="n">op_offset</span><span class="p">);</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">opl3_reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_opl3_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_dm_fm_params</span> <span class="o">*</span> <span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="cm">/* Set keyboard split method */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">kbd_split</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_KEYBOARD_SPLIT</span><span class="p">;</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">OPL3_LEFT</span> <span class="o">|</span> <span class="n">OPL3_REG_KBD_SPLIT</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="cm">/* Set amplitude modulation (tremolo) depth */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">am_depth</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_TREMOLO_DEPTH</span><span class="p">;</span>
	<span class="cm">/* Set vibrato depth */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">vib_depth</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_VIBRATO_DEPTH</span><span class="p">;</span>
	<span class="cm">/* Set percussion mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">rhythm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_PERCUSSION_ENABLE</span><span class="p">;</span>
		<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">rhythm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">rhythm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Play percussion instruments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bass</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_BASSDRUM_ON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">snare</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_SNAREDRUM_ON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">tomtom</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_TOMTOM_ON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cymbal</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_CYMBAL_ON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">hihat</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">OPL3_HIHAT_ON</span><span class="p">;</span>

	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">OPL3_LEFT</span> <span class="o">|</span> <span class="n">OPL3_REG_PERCUSSION</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_opl3_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SNDRV_DM_FM_MODE_OPL3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">&lt;</span> <span class="n">OPL3_HW_OPL3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">fm_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">&gt;=</span> <span class="n">OPL3_HW_OPL3</span><span class="p">)</span>
		<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">OPL3_RIGHT</span> <span class="o">|</span> <span class="n">OPL3_REG_CONNECTION_SELECT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* Clear 4-op connections */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_opl3_set_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span> <span class="n">opl3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">connection</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="cm">/* OPL-3 only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opl3</span><span class="o">-&gt;</span><span class="n">fm_mode</span> <span class="o">!=</span> <span class="n">SNDRV_DM_FM_MODE_OPL3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">connection</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">OPL3_RIGHT_4OP_0</span> <span class="o">|</span> <span class="n">OPL3_RIGHT_4OP_1</span> <span class="o">|</span> <span class="n">OPL3_RIGHT_4OP_2</span> <span class="o">|</span>
				<span class="n">OPL3_LEFT_4OP_0</span> <span class="o">|</span> <span class="n">OPL3_LEFT_4OP_1</span> <span class="o">|</span> <span class="n">OPL3_LEFT_4OP_2</span><span class="p">);</span>
	<span class="cm">/* Set 4-op connections */</span>
	<span class="n">opl3</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="n">OPL3_RIGHT</span> <span class="o">|</span> <span class="n">OPL3_REG_CONNECTION_SELECT</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
