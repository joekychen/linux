<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › ppc › pmac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pmac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PMac DBDMA lowlevel functions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> * code based on dmasound.c.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &quot;pmac.h&quot;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>


<span class="cm">/* fixed frequency table for awacs, screamer, burgundy, DACA (44100 max) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">awacs_freqs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">44100</span><span class="p">,</span> <span class="mi">29400</span><span class="p">,</span> <span class="mi">22050</span><span class="p">,</span> <span class="mi">17640</span><span class="p">,</span> <span class="mi">14700</span><span class="p">,</span> <span class="mi">11025</span><span class="p">,</span> <span class="mi">8820</span><span class="p">,</span> <span class="mi">7350</span>
<span class="p">};</span>
<span class="cm">/* fixed frequency table for tumbler */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tumbler_freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">44100</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * we will allocate a single &#39;emergency&#39; dbdma cmd block to use if the</span>
<span class="cm"> * tx status comes up &quot;DEAD&quot;.  This happens on some PowerComputing Pmac</span>
<span class="cm"> * clones, either owing to a bug in dbdma or some interaction between</span>
<span class="cm"> * IDE and sound.  However, this measure would deal with DEAD status if</span>
<span class="cm"> * it appeared elsewhere.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pmac_dbdma</span> <span class="n">emergency_dbdma</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">emergency_in_use</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * allocate DBDMA command arrays</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_dbdma_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_dbdma</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rsize</span><span class="p">);</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmds</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">DBDMA_ALIGN</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">);</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmds</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_dbdma_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_dbdma</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * pcm stuff</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * look up frequency table</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_pmac_rate_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cur_freqs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_table</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_freqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ok</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">ok</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">found</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * check whether another stream is active</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">another_stream</span><span class="p">(</span><span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">SNDRV_PCM_STREAM_CAPTURE</span> <span class="o">:</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_pcm_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_pcm_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get a stream of the opposite direction</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="nf">snd_pmac_get_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span>:
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span>:
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * wait while run status is on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">snd_pmac_wait_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RUN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the format and rate to the chip.</span>
<span class="cm"> * call the lowlevel function if defined (e.g. for AWACS).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_pcm_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set up frequency and format */</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">control_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rate_index</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">byteswap</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">set_format</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">set_format</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stop the DMA transfer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_pmac_dma_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span><span class="o">|</span><span class="n">WAKE</span><span class="o">|</span><span class="n">FLUSH</span><span class="o">|</span><span class="n">PAUSE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">snd_pmac_wait_ack</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the command pointer address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_pmac_dma_set_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_dbdma</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * start the DMA</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_pmac_dma_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">status</span> <span class="o">|</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * prepare playback/capture stream</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_index</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">astr</span><span class="p">;</span>

	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">nperiods</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma_size</span> <span class="o">/</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">cur_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rate_index</span> <span class="o">=</span> <span class="n">snd_pmac_rate_index</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="cm">/* set up constraints */</span>
	<span class="n">astr</span> <span class="o">=</span> <span class="n">snd_pmac_get_stream</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">another_stream</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">astr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">astr</span><span class="o">-&gt;</span><span class="n">cur_freqs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rate_index</span><span class="p">;</span>
	<span class="n">astr</span><span class="o">-&gt;</span><span class="n">cur_formats</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rate_index</span> <span class="o">=</span> <span class="n">rate_index</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>

	<span class="cm">/* We really want to execute a DMA stop command, after the AWACS</span>
<span class="cm">	 * is initialized.</span>
<span class="cm">	 * For reasons I don&#39;t understand, it stops the hissing noise</span>
<span class="cm">	 * common to many PowerBook G3 systems and random noise otherwise</span>
<span class="cm">	 * captured on iBook2&#39;s about every third time. -ReneR</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">snd_pmac_dma_stop</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">.</span><span class="n">cmds</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">DBDMA_STOP</span><span class="p">);</span>
	<span class="n">snd_pmac_dma_set_command</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">);</span>
	<span class="n">snd_pmac_dma_run</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">RUN</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="cm">/* continuous DMA memory type doesn&#39;t provide the physical address,</span>
<span class="cm">	 * so we need to resolve the address here...</span>
<span class="cm">	 */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmds</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">nperiods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">req_count</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
		<span class="cm">/*st_le16(&amp;cp-&gt;res_count, 0);*/</span>
		<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* make loop */</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">DBDMA_NOP</span> <span class="o">+</span> <span class="n">BR_ALWAYS</span><span class="p">);</span>
	<span class="n">st_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmd_dep</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">snd_pmac_dma_stop</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
	<span class="n">snd_pmac_dma_set_command</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * PCM trigger/stop</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">command</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="o">?</span>
			   <span class="n">OUTPUT_MORE</span> <span class="o">:</span> <span class="n">INPUT_MORE</span><span class="p">)</span> <span class="o">+</span> <span class="n">INTR_ALWAYS</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">snd_pmac_beep_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_pmac_pcm_set_format</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmds</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">nperiods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cp</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
		<span class="n">snd_pmac_dma_set_command</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">snd_pmac_dma_run</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">RUN</span><span class="o">|</span><span class="n">WAKE</span><span class="p">);</span>
		<span class="n">rec</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">rec</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*printk(KERN_DEBUG &quot;stopped!!\n&quot;);*/</span>
		<span class="n">snd_pmac_dma_stop</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmds</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">nperiods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cp</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">DBDMA_STOP</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return the current pointer</span>
<span class="cm"> */</span>
<span class="kr">inline</span>
<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_pmac_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 1 </span><span class="cm">/* hmm.. how can we get the current dma pointer?? */</span><span class="cp"></span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cur_period</span><span class="p">];</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">ld_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACTIVE</span><span class="o">|</span><span class="n">DEAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">in_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">res_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">count</span> <span class="o">+=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cur_period</span> <span class="o">*</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
	<span class="cm">/*printk(KERN_DEBUG &quot;pointer=%d\n&quot;, count);*/</span>
	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * playback</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pmac_pcm_prepare</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_playback_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pmac_pcm_trigger</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">,</span> <span class="n">subs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_pmac_playback_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pmac_pcm_pointer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * capture</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pmac_pcm_prepare</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_capture_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pmac_pcm_trigger</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">subs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_pmac_capture_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pmac_pcm_pointer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Handle DEAD DMA transfers:</span>
<span class="cm"> * if the TX status comes up &quot;DEAD&quot; - reported on some Power Computing machines</span>
<span class="cm"> * we need to re-start the dbdma - but from a different physical start address</span>
<span class="cm"> * and with a different transfer length.  It would get very messy to do this</span>
<span class="cm"> * with the normal dbdma_cmd blocks - we would have to re-write the buffer start</span>
<span class="cm"> * addresses each time.  So, we will keep a single dbdma_cmd block which can be</span>
<span class="cm"> * fiddled with.</span>
<span class="cm"> * When DEAD status is first reported the content of the faulted dbdma block is</span>
<span class="cm"> * copied into the emergency buffer and we note that the buffer is in use.</span>
<span class="cm"> * we then bump the start physical address by the amount that was successfully</span>
<span class="cm"> * output before it died.</span>
<span class="cm"> * On any subsequent DEAD result we just do the bump-ups (we know that we are</span>
<span class="cm"> * already using the emergency dbdma_cmd).</span>
<span class="cm"> * CHECK: this just tries to &quot;do it&quot;.  It is possible that we should abandon</span>
<span class="cm"> * xfers when the number of residual bytes gets below a certain value - I can</span>
<span class="cm"> * see that this might cause a loop-forever if a too small transfer causes</span>
<span class="cm"> * DEAD status.  However this is a TODO for now - we&#39;ll see what gets reported.</span>
<span class="cm"> * When we get a successful transfer result with the emergency buffer we just</span>
<span class="cm"> * pretend that it completed using the original dmdma_cmd and carry on.  The</span>
<span class="cm"> * &#39;next_cmd&#39; field will already point back to the original loop of blocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_pmac_pcm_dead_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>
					  <span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">req</span><span class="p">,</span> <span class="n">res</span> <span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy</span> <span class="p">;</span>

	<span class="cm">/* printk(KERN_WARNING &quot;snd-powermac: DMA died - patching it up!\n&quot;); */</span>

	<span class="cm">/* to clear DEAD status we must first clear RUN</span>
<span class="cm">	   set it to quiescent to be on the safe side */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span><span class="o">|</span><span class="n">PAUSE</span><span class="o">|</span><span class="n">FLUSH</span><span class="o">|</span><span class="n">WAKE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emergency_in_use</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* new problem */</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">emergency_dbdma</span><span class="p">.</span><span class="n">cmds</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cp</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">));</span>
		<span class="n">emergency_in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">req_count</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">emergency_dbdma</span><span class="p">.</span><span class="n">cmds</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* now bump the values to reflect the amount</span>
<span class="cm">	   we haven&#39;t yet shifted */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ld_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">req_count</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ld_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">res_count</span><span class="p">);</span>
	<span class="n">phy</span> <span class="o">=</span> <span class="n">ld_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">);</span>
	<span class="n">phy</span> <span class="o">+=</span> <span class="p">(</span><span class="n">req</span> <span class="o">-</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">req_count</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">res_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">st_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="n">st_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmd_dep</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">addr</span>
		<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cur_period</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">nperiods</span><span class="p">));</span>

	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">OUTPUT_MORE</span> <span class="o">|</span> <span class="n">BR_ALWAYS</span> <span class="o">|</span> <span class="n">INTR_ALWAYS</span><span class="p">);</span>

	<span class="cm">/* point at our patched up command block */</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">,</span> <span class="n">emergency_dbdma</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* we must re-start the controller */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="cm">/* should complete clearing the DEAD status */</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">((</span><span class="n">RUN</span><span class="o">|</span><span class="n">WAKE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">RUN</span><span class="o">|</span><span class="n">WAKE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * update playback/capture pointer from interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_pcm_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">nperiods</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* at most all fragments */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">emergency_in_use</span><span class="p">)</span>   <span class="cm">/* already using DEAD xfer? */</span>
				<span class="n">cp</span> <span class="o">=</span> <span class="n">emergency_dbdma</span><span class="p">.</span><span class="n">cmds</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cur_period</span><span class="p">];</span>

			<span class="n">stat</span> <span class="o">=</span> <span class="n">ld_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DEAD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_pmac_pcm_dead_xfer</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* this block is still going */</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">emergency_in_use</span><span class="p">)</span>
				<span class="n">emergency_in_use</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="cm">/* done that */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ACTIVE</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*printk(KERN_DEBUG &quot;update frag %d\n&quot;, rec-&gt;cur_period);*/</span>
			<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">req_count</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
			<span class="cm">/*st_le16(&amp;cp-&gt;res_count, 0);*/</span>
			<span class="n">rec</span><span class="o">-&gt;</span><span class="n">cur_period</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cur_period</span> <span class="o">&gt;=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">nperiods</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rec</span><span class="o">-&gt;</span><span class="n">cur_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * hw info</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_pmac_playback</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_8000_44100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">7350</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">44100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mi">131072</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">256</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mi">16384</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="n">PMAC_MAX_FRAGS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_pmac_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_8000_44100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">7350</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">44100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mi">131072</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">256</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mi">16384</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="n">PMAC_MAX_FRAGS</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#if 0</span><span class="c"> // NYI</span>
<span class="c">static int snd_pmac_hw_rule_rate(struct snd_pcm_hw_params *params,</span>
<span class="c">				 struct snd_pcm_hw_rule *rule)</span>
<span class="c">{</span>
<span class="c">	struct snd_pmac *chip = rule-&gt;private;</span>
<span class="c">	struct pmac_stream *rec = snd_pmac_get_stream(chip, rule-&gt;deps[0]);</span>
<span class="c">	int i, freq_table[8], num_freqs;</span>

<span class="c">	if (! rec)</span>
<span class="c">		return -EINVAL;</span>
<span class="c">	num_freqs = 0;</span>
<span class="c">	for (i = chip-&gt;num_freqs - 1; i &gt;= 0; i--) {</span>
<span class="c">		if (rec-&gt;cur_freqs &amp; (1 &lt;&lt; i))</span>
<span class="c">			freq_table[num_freqs++] = chip-&gt;freq_table[i];</span>
<span class="c">	}</span>

<span class="c">	return snd_interval_list(hw_param_interval(params, rule-&gt;var),</span>
<span class="c">				 num_freqs, freq_table, 0);</span>
<span class="c">}</span>

<span class="c">static int snd_pmac_hw_rule_format(struct snd_pcm_hw_params *params,</span>
<span class="c">				   struct snd_pcm_hw_rule *rule)</span>
<span class="c">{</span>
<span class="c">	struct snd_pmac *chip = rule-&gt;private;</span>
<span class="c">	struct pmac_stream *rec = snd_pmac_get_stream(chip, rule-&gt;deps[0]);</span>

<span class="c">	if (! rec)</span>
<span class="c">		return -EINVAL;</span>
<span class="c">	return snd_mask_refine_set(hw_param_mask(params, SNDRV_PCM_HW_PARAM_FORMAT),</span>
<span class="c">				   rec-&gt;cur_formats);</span>
<span class="c">}</span>
<span class="cp">#endif // NYI</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* look up frequency table and fill bit mask */</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_freqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">|=</span>
				<span class="n">snd_pcm_rate_to_rate_bit</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* check for minimum and maximum rates */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_freqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_freqs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">formats_ok</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_capture</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_duplex</span><span class="p">)</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">info</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_INFO_HALF_DUPLEX</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">info</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_INFO_JOINT_DUPLEX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">subs</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"> /* FIXME: still under development.. */</span>
<span class="c">	snd_pcm_hw_rule_add(runtime, 0, SNDRV_PCM_HW_PARAM_RATE,</span>
<span class="c">			    snd_pmac_hw_rule_rate, chip, rec-&gt;stream, -1);</span>
<span class="c">	snd_pcm_hw_rule_add(runtime, 0, SNDRV_PCM_HW_PARAM_FORMAT,</span>
<span class="c">			    snd_pmac_hw_rule_format, chip, rec-&gt;stream, -1);</span>
<span class="cp">#endif</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* constraints to fix choppy sound */</span>
	<span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">astr</span><span class="p">;</span>

	<span class="n">snd_pmac_dma_stop</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>

	<span class="n">astr</span> <span class="o">=</span> <span class="n">snd_pmac_get_stream</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">another_stream</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">astr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* reset constraints */</span>
	<span class="n">astr</span><span class="o">-&gt;</span><span class="n">cur_freqs</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span><span class="p">;</span>
	<span class="n">astr</span><span class="o">-&gt;</span><span class="n">cur_formats</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">formats_ok</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>

	<span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_pmac_playback</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pmac_pcm_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>

	<span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_pmac_capture</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pmac_pcm_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_pmac_pcm_close</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_pmac_pcm_close</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">subs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_pmac_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_pmac_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_pmac_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_pmac_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_pmac_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_pmac_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_pmac_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_pmac_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_pmac_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_pmac_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_pmac_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_pmac_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_pmac_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_pmac_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_pmac_capture_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_pmac_capture_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_pmac_pcm_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_captures</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_capture</span><span class="p">)</span>
		<span class="n">num_captures</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_captures</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_pmac_playback_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_capture</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_pmac_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_JOINT_DUPLEX</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">formats_ok</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_byte_swap</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">formats_ok</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">cur_formats</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">formats_ok</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">cur_formats</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">formats_ok</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">cur_freqs</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">cur_freqs</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span><span class="p">;</span>

	<span class="cm">/* preallocate 64k buffer */</span>
	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_dbdma_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span><span class="o">|</span><span class="n">PAUSE</span><span class="o">|</span><span class="n">FLUSH</span><span class="o">|</span><span class="n">WAKE</span><span class="o">|</span><span class="n">DEAD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">snd_pmac_wait_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">);</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span><span class="o">|</span><span class="n">PAUSE</span><span class="o">|</span><span class="n">FLUSH</span><span class="o">|</span><span class="n">WAKE</span><span class="o">|</span><span class="n">DEAD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">snd_pmac_wait_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * handling beep</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_pmac_beep_dma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmac_stream</span> <span class="o">*</span><span class="n">rec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>

	<span class="n">snd_pmac_dma_stop</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">.</span><span class="n">cmds</span><span class="o">-&gt;</span><span class="n">req_count</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">.</span><span class="n">cmds</span><span class="o">-&gt;</span><span class="n">xfer_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">st_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">.</span><span class="n">cmds</span><span class="o">-&gt;</span><span class="n">cmd_dep</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">st_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">.</span><span class="n">cmds</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">.</span><span class="n">cmds</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">OUTPUT_MORE</span> <span class="o">+</span> <span class="n">BR_ALWAYS</span><span class="p">);</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1f00</span><span class="p">)</span>
		 <span class="o">|</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">byteswap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_pmac_dma_set_command</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">);</span>
	<span class="n">snd_pmac_dma_run</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">RUN</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_pmac_beep_dma_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pmac_dma_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">);</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">.</span><span class="n">cmds</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">DBDMA_STOP</span><span class="p">);</span>
	<span class="n">snd_pmac_pcm_set_format</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span> <span class="cm">/* reset format */</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * interrupt handlers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">snd_pmac_tx_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">snd_pmac_pcm_update</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">snd_pmac_rx_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">snd_pmac_pcm_update</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">snd_pmac_ctrl_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="cm">/*printk(KERN_DEBUG &quot;pmac: control interrupt.. 0x%x\n&quot;, ctrl);*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MASK_PORTCHG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* do something when headphone is plugged/unplugged? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">MASK_CNTLERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">codec_stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_ERRCODE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&lt;=</span> <span class="n">PMAC_SCREAMER</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;error %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Writing 1s to the CNTLERR and PORTCHG bits clears them... */</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * a wrapper to feature call for compatibility</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_sound_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_SOUND_CHIP_ENABLE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release resources</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* stop sounds */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pmac_dbdma_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="cm">/* disable interrupts from awacs interface */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span>
		<span class="n">snd_pmac_sound_feature</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* clean up mixer if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_free</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_pmac_detach_beep</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* release resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tx_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rx_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_pmac_dbdma_free</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">snd_pmac_dbdma_free</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">snd_pmac_dbdma_free</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">);</span>
	<span class="n">snd_pmac_dbdma_free</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emergency_dbdma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">macio_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">macio_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">latch_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">latch_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">requested</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">release_mem_region</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
						   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * free the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pmac_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * check the machine support byteswap (little-endian)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">detect_byte_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">mio</span><span class="p">;</span>

	<span class="cm">/* if seems that Keylargo can&#39;t byte-swap  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mio</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span> <span class="n">mio</span><span class="p">;</span> <span class="n">mio</span> <span class="o">=</span> <span class="n">mio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mac-io&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">mio</span><span class="p">,</span> <span class="s">&quot;Keylargo&quot;</span><span class="p">))</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_byte_swap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* it seems the Pismo &amp; iBook can&#39;t byte-swap in hardware. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,1&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook2,1&quot;</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_byte_swap</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook2,1&quot;</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * detect a sound chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_pmac_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">sound</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span> <span class="n">macio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">subframe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* all ok */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">PMAC_AWACS</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_byte_swap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_capture</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_freqs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">awacs_freqs</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_table</span> <span class="o">=</span> <span class="n">awacs_freqs</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">control_mask</span> <span class="o">=</span> <span class="n">MASK_IEPC</span> <span class="o">|</span> <span class="n">MASK_IEE</span> <span class="o">|</span> <span class="mh">0x11</span><span class="p">;</span> <span class="cm">/* default */</span>

	<span class="cm">/* check machine type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;AAPL,3400/2400&quot;</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;AAPL,3500&quot;</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_pbook_3400</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook1,1&quot;</span><span class="p">)</span>
		 <span class="o">||</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;AAPL,PowerBook1998&quot;</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_pbook_G3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;awacs&quot;</span><span class="p">);</span>
	<span class="n">sound</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * powermac G3 models have a node called &quot;davbus&quot;</span>
<span class="cm">	 * with a child called &quot;sound&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;davbus&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * if we didn&#39;t find a davbus device, try &#39;i2s-a&#39; since</span>
<span class="cm">	 * this seems to be what iBooks have</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;i2s-a&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
						 <span class="s">&quot;K2-Keylargo&quot;</span><span class="p">))</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_k2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sound</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sound</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sound&quot;</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sound</span> <span class="o">&amp;&amp;</span> <span class="n">sound</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span>
			<span class="n">sound</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;sound&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">sound</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;sub-frame&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">prop</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">subframe</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;layout-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* partly deprecate snd-powermac, for those machines</span>
<span class="cm">		 * that have a layout-id property for now */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;snd-powermac no longer handles any &quot;</span>
				 <span class="s">&quot;machines with a layout-id property &quot;</span>
				 <span class="s">&quot;in the device-tree, use snd-aoa.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">sound</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* This should be verified on older screamers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;screamer&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">PMAC_SCREAMER</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>chip->can<em>byte</em>swap = 0; /* FIXME: check this */</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;burgundy&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">PMAC_BURGUNDY</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">control_mask</span> <span class="o">=</span> <span class="n">MASK_IEPC</span> <span class="o">|</span> <span class="mh">0x11</span><span class="p">;</span> <span class="cm">/* disable IEE */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;daca&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">PMAC_DACA</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_capture</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* no capture */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>chip->can<em>byte</em>swap = 0; /* FIXME: check this */</p></td><td class="code"><div class="highlight"><pre>		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">control_mask</span> <span class="o">=</span> <span class="n">MASK_IEPC</span> <span class="o">|</span> <span class="mh">0x11</span><span class="p">;</span> <span class="cm">/* disable IEE */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;tumbler&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">PMAC_TUMBLER</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_capture</span> <span class="o">=</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac4,2&quot;</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,2&quot;</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,3&quot;</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook4,1&quot;</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook4,2&quot;</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook4,3&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">can_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>chip->can<em>byte</em>swap = 0; /* FIXME: check this */</p></td><td class="code"><div class="highlight"><pre>		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_freqs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tumbler_freqs</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_table</span> <span class="o">=</span> <span class="n">tumbler_freqs</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">control_mask</span> <span class="o">=</span> <span class="n">MASK_IEPC</span> <span class="o">|</span> <span class="mh">0x11</span><span class="p">;</span> <span class="cm">/* disable IEE */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;snapper&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">PMAC_SNAPPER</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>chip->can<em>byte</em>swap = 0; /* FIXME: check this */</p></td><td class="code"><div class="highlight"><pre>		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_freqs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tumbler_freqs</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_table</span> <span class="o">=</span> <span class="n">tumbler_freqs</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">control_mask</span> <span class="o">=</span> <span class="n">MASK_IEPC</span> <span class="o">|</span> <span class="mh">0x11</span><span class="p">;</span> <span class="cm">/* disable IEE */</span>
	<span class="p">}</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;device-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="n">dn</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;perch&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">has_iic</span> <span class="o">=</span> <span class="p">(</span><span class="n">dn</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>

	<span class="cm">/* We need the PCI device for DMA allocations, let&#39;s use a crude method</span>
<span class="cm">	 * for now ...</span>
<span class="cm">	 */</span>
	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;snd-powermac: can&#39;t locate macio !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&amp;&amp;</span> <span class="n">np</span> <span class="o">==</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;snd-powermac: can&#39;t locate macio PCI&quot;</span>
		       <span class="s">&quot; device !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">detect_byte_swap</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* look for a property saying what sample rates</span>
<span class="cm">	   are available */</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;sample-rates&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">prop</span><span class="p">)</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="s">&quot;output-frame-rates&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Apple &#39;Fixed&#39; format */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span>
				<span class="n">r</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_freqs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* assume only 44.1khz */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">freqs_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">of_node_put</span><span class="p">(</span><span class="n">sound</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef PMAC_SUPPORT_AUTOMUTE</span>
<span class="cm">/*</span>
<span class="cm"> * auto-mute</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmac_auto_mute_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_mute</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmac_auto_mute_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_mute</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_mute</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmac_hp_detect_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">detect_headphone</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">detect_headphone</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">auto_mute_controls</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Auto Mute Switch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_mono_info</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">pmac_auto_mute_get</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">pmac_auto_mute_put</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Headphone Detection&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_mono_info</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">pmac_hp_detect_get</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_pmac_add_automute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_mute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auto_mute_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chip</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd-powermac: Failed to add automute control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_detect_ctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auto_mute_controls</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_detect_ctl</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PMAC_SUPPORT_AUTOMUTE */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * create and detect a pmac chip record</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_pmac_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">**</span><span class="n">chip_return</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctrl_addr</span><span class="p">,</span> <span class="n">txdma_addr</span><span class="p">,</span> <span class="n">rxdma_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_pmac_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">chip_return</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">tx_irq</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rx_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pmac_detect</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pmac_dbdma_alloc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">PMAC_MAX_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">snd_pmac_dbdma_alloc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">PMAC_MAX_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">snd_pmac_dbdma_alloc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">extra_dma</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">snd_pmac_dbdma_alloc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emergency_dbdma</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">requested</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_k2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rnames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;Sound Control&quot;</span><span class="p">,</span> <span class="s">&quot;Sound DMA&quot;</span> <span class="p">};</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd: can&#39;t translate rsrc &quot;</span>
				       <span class="s">&quot; %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rnames</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
					       <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
					       <span class="n">rnames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd: can&#39;t request rsrc &quot;</span>
				       <span class="s">&quot; %d (%s: %pR)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span> <span class="n">rnames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">requested</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ctrl_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
		<span class="n">txdma_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
		<span class="n">rxdma_addr</span> <span class="o">=</span> <span class="n">txdma_addr</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rnames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;Sound Control&quot;</span><span class="p">,</span> <span class="s">&quot;Sound Tx DMA&quot;</span><span class="p">,</span> <span class="s">&quot;Sound Rx DMA&quot;</span> <span class="p">};</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd: can&#39;t translate rsrc &quot;</span>
				       <span class="s">&quot; %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rnames</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
					       <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
					       <span class="n">rnames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd: can&#39;t request rsrc &quot;</span>
				       <span class="s">&quot; %d (%s: %pR)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span> <span class="n">rnames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">requested</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ctrl_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
		<span class="n">txdma_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
		<span class="n">rxdma_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsrc</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">ctrl_addr</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">txdma_addr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">rxdma_addr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&lt;=</span> <span class="n">PMAC_BURGUNDY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_pmac_ctrl_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s">&quot;PMac&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pmac: unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">irq</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_pmac_tx_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;PMac Output&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="p">)){</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pmac: unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tx_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_pmac_rx_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;PMac Input&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pmac: unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rx_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">snd_pmac_sound_feature</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* reset &amp; enable interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&lt;=</span> <span class="n">PMAC_BURGUNDY</span><span class="p">)</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">control_mask</span><span class="p">);</span>

	<span class="cm">/* Powerbooks have odd ways of enabling inputs such as</span>
<span class="cm">	   an expansion-bay CD or sound from an internal modem</span>
<span class="cm">	   or a PC-card modem. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_pbook_3400</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable CD and PC-card sound inputs. */</span>
		<span class="cm">/* This is done by reading from address</span>
<span class="cm">		 * f301a000, + 0x10 to enable the expansion-bay</span>
<span class="cm">		 * CD sound input, + 0x80 to enable the PC-card</span>
<span class="cm">		 * sound input.  The 0x100 enables the SCSI bus</span>
<span class="cm">		 * terminator power.</span>
<span class="cm">		 */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">latch_base</span> <span class="o">=</span> <span class="n">ioremap</span> <span class="p">(</span><span class="mh">0xf301a000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">in_8</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">latch_base</span> <span class="o">+</span> <span class="mh">0x190</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_pbook_G3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device_node</span><span class="o">*</span> <span class="n">mio</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mio</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span> <span class="n">mio</span><span class="p">;</span> <span class="n">mio</span> <span class="o">=</span> <span class="n">mio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mac-io&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">mio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">macio_base</span> <span class="o">=</span>
						<span class="n">ioremap</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Enable CD sound input. */</span>
		<span class="cm">/* The relevant bits for writing to this byte are 0x8f.</span>
<span class="cm">		 * I haven&#39;t found out what the 0x80 bit does.</span>
<span class="cm">		 * For the 0xf bits, writing 3 or 7 enables the CD</span>
<span class="cm">		 * input, any other value disables it.  Values</span>
<span class="cm">		 * 1, 3, 5, 7 enable the microphone.  Values 0, 2,</span>
<span class="cm">		 * 4, 6, 8 - f enable the input from the modem.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">macio_base</span><span class="p">)</span>
			<span class="n">out_8</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">macio_base</span> <span class="o">+</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reset dbdma channels */</span>
	<span class="n">snd_pmac_dbdma_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">chip_return</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">__error:</span>
	<span class="n">snd_pmac_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * sleep notify for powerbook</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/*</span>
<span class="cm"> * Save state when going to sleep, restore it afterwards.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">snd_pmac_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_pmac_beep_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tx_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rx_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">);</span>
	<span class="n">snd_pmac_sound_feature</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_pmac_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pmac_sound_feature</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="cm">/* enable CD sound input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">macio_base</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_pbook_G3</span><span class="p">)</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">macio_base</span> <span class="o">+</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">is_pbook_3400</span><span class="p">)</span>
		<span class="n">in_8</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">latch_base</span> <span class="o">+</span> <span class="mh">0x190</span><span class="p">);</span>

	<span class="n">snd_pmac_pcm_set_format</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tx_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rx_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
