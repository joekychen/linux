<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › ppc › awacs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>awacs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PMac AWACS lowlevel functions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> * code based on dmasound.c.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/nvram.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &quot;pmac.h&quot;</span>


<span class="cp">#ifdef CONFIG_ADB_CUDA</span>
<span class="cp">#define PMAC_AMP_AVAIL</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef PMAC_AMP_AVAIL</span>
<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">amp_master</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">amp_vol</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">amp_tone</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define CHECK_CUDA_AMP() (sys_ctrler == SYS_CTRLER_CUDA)</span>

<span class="cp">#endif </span><span class="cm">/* PMAC_AMP_AVAIL */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_screamer_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">codec_stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;snd_pmac_screamer_wait timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write AWACS register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_pmac_awacs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_SCREAMER</span><span class="p">)</span>
		<span class="n">snd_pmac_screamer_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">codec_ctrl</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">subframe</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">codec_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_NEWECMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;snd_pmac_awacs_write timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_pmac_awacs_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pmac_awacs_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pmac_awacs_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/* Recalibrate chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">screamer_recalibrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">PMAC_SCREAMER</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Sorry for the horrible delays... I hope to get that improved</span>
<span class="cm">	 * by making the whole PM process asynchronous in a future version</span>
<span class="cm">	 */</span>
	<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="cm">/* delay for broken crystal part */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">750</span><span class="p">);</span>
	<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="n">MASK_RECALIBRATE</span> <span class="o">|</span>
				   <span class="n">MASK_CMUTE</span> <span class="o">|</span> <span class="n">MASK_AMUTE</span><span class="p">);</span>
	<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define screamer_recalibrate(chip) </span><span class="cm">/* NOP */</span><span class="cp"></span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * additional callback to set the pcm format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_awacs_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_SAMPLERATE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rate_index</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">snd_pmac_awacs_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * AWACS volume callbacks</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * volumes: 0-15 stereo</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_info_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_get_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inverted</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">lshift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inverted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span> <span class="o">-</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span> <span class="o">-</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_put_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inverted</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">oldval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0x0f</span> <span class="o">||</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0x0f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inverted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span> <span class="o">-</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span> <span class="o">-</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">oldval</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">oldval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">lshift</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">lshift</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldval</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">snd_pmac_awacs_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">oldval</span> <span class="o">!=</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define AWACS_VOLUME(xname, xreg, xshift, xinverted) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = 0, \</span>
<span class="cp">  .info = snd_pmac_awacs_info_volume, \</span>
<span class="cp">  .get = snd_pmac_awacs_get_volume, \</span>
<span class="cp">  .put = snd_pmac_awacs_put_volume, \</span>
<span class="cp">  .private_value = (xreg) | ((xshift) &lt;&lt; 8) | ((xinverted) &lt;&lt; 16) }</span>

<span class="cm">/*</span>
<span class="cm"> * mute master/ogain for AWACS: mono</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_get_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_put_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">changed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">invert</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="n">snd_pmac_awacs_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AWACS_SWITCH(xname, xreg, xshift, xinvert) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = 0, \</span>
<span class="cp">  .info = snd_pmac_boolean_mono_info, \</span>
<span class="cp">  .get = snd_pmac_awacs_get_switch, \</span>
<span class="cp">  .put = snd_pmac_awacs_put_switch, \</span>
<span class="cp">  .private_value = (xreg) | ((xshift) &lt;&lt; 8) | ((xinvert) &lt;&lt; 16) }</span>


<span class="cp">#ifdef PMAC_AMP_AVAIL</span>
<span class="cm">/*</span>
<span class="cm"> * controls for perch/whisper extension cards, e.g. G3 desktop</span>
<span class="cm"> *</span>
<span class="cm"> * TDA7433 connected via i2c address 0x45 (= 0x8a),</span>
<span class="cm"> * accessed through cuda</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">awacs_set_cuda</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">cuda_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">CUDA_PACKET</span><span class="p">,</span> <span class="n">CUDA_GET_SET_IIC</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span> <span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">cuda_poll</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * level = 0 - 14, 7 = 0 dB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">awacs_amp_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bass</span><span class="p">,</span> <span class="kt">int</span> <span class="n">treble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_tone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bass</span><span class="p">;</span>
	<span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_tone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">treble</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bass</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">bass</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span> <span class="o">-</span> <span class="n">bass</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">treble</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">treble</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span> <span class="o">-</span> <span class="n">treble</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">awacs_set_cuda</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bass</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">treble</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vol = 0 - 31 (attenuation), 32 = mute bit, stereo</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">awacs_amp_set_vol</span><span class="p">(</span><span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">lvol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rvol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_check</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_check</span> <span class="o">&amp;&amp;</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">lvol</span> <span class="o">&amp;&amp;</span>
			<span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">rvol</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">awacs_set_cuda</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">lvol</span><span class="p">);</span>
	<span class="n">awacs_set_cuda</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">rvol</span><span class="p">);</span>
	<span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lvol</span><span class="p">;</span>
	<span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rvol</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 0 = -79 dB, 79 = 0 dB, 99 = +20 dB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">awacs_amp_set_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_master</span> <span class="o">=</span> <span class="n">vol</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&lt;=</span> <span class="mi">79</span><span class="p">)</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">+</span> <span class="p">(</span><span class="mi">79</span> <span class="o">-</span> <span class="n">vol</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="p">(</span><span class="n">vol</span> <span class="o">-</span> <span class="mi">79</span><span class="p">);</span>
	<span class="n">awacs_set_cuda</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">vol</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">awacs_amp_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">amp</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * mixer controls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_info_volume_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_get_volume_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="p">(</span><span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="p">(</span><span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_put_volume_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">))</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">))</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">awacs_amp_set_vol</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_get_switch_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span>
					<span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span>
					<span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_put_switch_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">32</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">32</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">awacs_amp_set_vol</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_info_tone_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_get_tone_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_tone</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_put_tone_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_tone</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_tone</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">awacs_amp_set_tone</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_tone</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_tone</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_info_master_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_get_master_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_master</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_put_master_amp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_master</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_master</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">awacs_amp_set_master</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_master</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AMP_CH_SPK	0</span>
<span class="cp">#define AMP_CH_HD	1</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_amp_vol</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Speaker Playback Volume&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_info_volume_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_get_volume_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_put_volume_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AMP_CH_SPK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Headphone Playback Volume&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_info_volume_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_get_volume_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_put_volume_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AMP_CH_HD</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Tone Control - Bass&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_info_tone_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_get_tone_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_put_tone_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Tone Control - Treble&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_info_tone_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_get_tone_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_put_tone_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Amp Master Playback Volume&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_info_master_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_get_master_amp</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_put_master_amp</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_amp_hp_sw</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Headphone Playback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_stereo_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_get_switch_amp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_put_switch_amp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AMP_CH_HD</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_amp_spk_sw</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Speaker Playback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_stereo_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_get_switch_amp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_put_switch_amp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">AMP_CH_SPK</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* PMAC_AMP_AVAIL */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * mic boost for screamer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_screamer_mic_boost_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_screamer_mic_boost_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MASK_MIC_BOOST</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MASK_GAINLINE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_screamer_mic_boost_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val0</span><span class="p">,</span> <span class="n">val6</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val0</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MASK_GAINLINE</span><span class="p">;</span>
	<span class="n">val6</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MASK_MIC_BOOST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">val0</span> <span class="o">|=</span> <span class="n">MASK_GAINLINE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">val6</span> <span class="o">|=</span> <span class="n">MASK_MIC_BOOST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val0</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">snd_pmac_awacs_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val0</span><span class="p">);</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val6</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">snd_pmac_awacs_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">val6</span><span class="p">);</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lists of mixer elements</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_mixers</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Master Capture Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SHIFT_LOOPTHRU</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Master Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="cm">/*	AWACS_SWITCH(&quot;Unknown Playback Switch&quot;, 6, SHIFT_PAROUT0, 0), */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_screamer_mixers_beige</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Play-through Playback Volume&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Line Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;CD Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_LINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_screamer_mixers_lo</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Line out Playback Volume&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_screamer_mixers_imac</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Play-through Playback Volume&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;CD Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_CD</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_screamer_mixers_g4agp</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Line out Playback Volume&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;CD Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_CD</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Line Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_mixers_pmac7500</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Line out Playback Volume&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;CD Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_CD</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Line Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_mixers_pmac5500</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Headphone Playback Volume&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_mixers_pmac</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;CD Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_CD</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* FIXME: is this correct order?</span>
<span class="cm"> * screamer (powerbook G3 pismo) seems to have different bits...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_mixers2</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Line Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_LINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Mic Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_screamer_mixers2</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Line Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Mic Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_LINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_mixers2_pmac5500</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;CD Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_MUX_CD</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_master_sw</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SHIFT_HDMUTE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_master_sw_imac</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Line out Playback Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SHIFT_HDMUTE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_master_sw_pmac5500</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Headphone Playback Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SHIFT_HDMUTE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_mic_boost</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Mic Boost Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_GAINLINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_screamer_mic_boost</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Mic Boost Capture Volume&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_screamer_mic_boost_info</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_pmac_screamer_mic_boost_get</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_pmac_screamer_mic_boost_put</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_mic_boost_pmac7500</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Line Boost Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_GAINLINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_screamer_mic_boost_beige</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Line Boost Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_GAINLINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;CD Boost Capture Switch&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">SHIFT_MIC_BOOST</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_screamer_mic_boost_imac</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Line Boost Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_GAINLINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Mic Boost Capture Switch&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">SHIFT_MIC_BOOST</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_speaker_vol</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AWACS_VOLUME</span><span class="p">(</span><span class="s">&quot;Speaker Playback Volume&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_speaker_sw</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Speaker Playback Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SHIFT_SPKMUTE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_speaker_sw_imac1</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Speaker Playback Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SHIFT_PAROUT1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_pmac_awacs_speaker_sw_imac2</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="n">AWACS_SWITCH</span><span class="p">(</span><span class="s">&quot;Speaker Playback Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SHIFT_PAROUT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * add new mixer elements to the card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_mixers</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nums</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">mixers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * restore all registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">awacs_restore_all_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_SCREAMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_awacs_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
					     <span class="o">|</span> <span class="n">MASK_AMUTE</span> <span class="o">|</span> <span class="n">MASK_CMUTE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_awacs_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,1&quot;</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,2&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">snd_pmac_awacs_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MASK_PAROUT</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">awacs_restore_all_regs</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_SCREAMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset power bits in reg 6 */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">screamer_recalibrate</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="cp">#ifdef PMAC_AMP_AVAIL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
		<span class="n">awacs_amp_set_vol</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">awacs_amp_set_vol</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				  <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">awacs_amp_set_tone</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_tone</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_tone</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">awacs_amp_set_master</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_master</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define IS_PM7500 (of_machine_is_compatible(&quot;AAPL,7500&quot;) \</span>
<span class="cp">		|| of_machine_is_compatible(&quot;AAPL,8500&quot;) \</span>
<span class="cp">		|| of_machine_is_compatible(&quot;AAPL,9500&quot;))</span>
<span class="cp">#define IS_PM5500 (of_machine_is_compatible(&quot;AAPL,e411&quot;))</span>
<span class="cp">#define IS_BEIGE (of_machine_is_compatible(&quot;AAPL,Gossamer&quot;))</span>
<span class="cp">#define IS_IMAC1 (of_machine_is_compatible(&quot;PowerMac2,1&quot;))</span>
<span class="cp">#define IS_IMAC2 (of_machine_is_compatible(&quot;PowerMac2,2&quot;) \</span>
<span class="cp">		|| of_machine_is_compatible(&quot;PowerMac4,1&quot;))</span>
<span class="cp">#define IS_G4AGP (of_machine_is_compatible(&quot;PowerMac3,1&quot;))</span>
<span class="cp">#define IS_LOMBARD (of_machine_is_compatible(&quot;PowerBook1,1&quot;))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">imac1</span><span class="p">,</span> <span class="n">imac2</span><span class="p">;</span>

<span class="cp">#ifdef PMAC_SUPPORT_AUTOMUTE</span>
<span class="cm">/*</span>
<span class="cm"> * auto-mute stuffs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_pmac_awacs_detect_headphone</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">codec_stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_stat_mask</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef PMAC_AMP_AVAIL</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">toggle_amp_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">;</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="o">-&gt;</span><span class="n">amp_vol</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">awacs_amp_set_vol</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_pmac_awacs_update_automute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_notify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_mute</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PMAC_AMP_AVAIL</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_pmac_awacs_detect_headphone</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">changed</span> <span class="o">=</span> <span class="n">toggle_amp_mute</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">AMP_CH_HD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">changed</span> <span class="o">|=</span> <span class="n">toggle_amp_mute</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">AMP_CH_SPK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">changed</span> <span class="o">=</span> <span class="n">toggle_amp_mute</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">AMP_CH_HD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">changed</span> <span class="o">|=</span> <span class="n">toggle_amp_mute</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">AMP_CH_SPK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_notify</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">changed</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">MASK_HDMUTE</span> <span class="o">|</span> <span class="n">MASK_SPKMUTE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">imac1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_SPKMUTE</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">|=</span> <span class="n">MASK_PAROUT1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imac2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_SPKMUTE</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_PAROUT1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_pmac_awacs_detect_headphone</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_HDMUTE</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imac1</span><span class="p">)</span>
				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_PAROUT1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imac2</span><span class="p">)</span>
				<span class="n">reg</span> <span class="o">|=</span> <span class="n">MASK_PAROUT1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_SPKMUTE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_notify</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">snd_pmac_awacs_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_notify</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_detect_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PMAC_SUPPORT_AUTOMUTE */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * initialize chip</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_pmac_awacs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pm7500</span> <span class="o">=</span> <span class="n">IS_PM7500</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pm5500</span> <span class="o">=</span> <span class="n">IS_PM5500</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">beige</span> <span class="o">=</span> <span class="n">IS_BEIGE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">g4agp</span> <span class="o">=</span> <span class="n">IS_G4AGP</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lombard</span> <span class="o">=</span> <span class="n">IS_LOMBARD</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">imac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">vol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">vmaster_sw</span><span class="p">,</span> <span class="o">*</span><span class="n">vmaster_vol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">master_vol</span><span class="p">,</span> <span class="o">*</span><span class="n">speaker_vol</span><span class="p">;</span>

	<span class="n">imac1</span> <span class="o">=</span> <span class="n">IS_IMAC1</span><span class="p">;</span>
	<span class="n">imac2</span> <span class="o">=</span> <span class="n">IS_IMAC2</span><span class="p">;</span>
	<span class="n">imac</span> <span class="o">=</span> <span class="n">imac1</span> <span class="o">||</span> <span class="n">imac2</span><span class="p">;</span>
	<span class="cm">/* looks like MASK_GAINLINE triggers something, so we set here</span>
<span class="cm">	 * as start-up</span>
<span class="cm">	 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MASK_MUX_CD</span> <span class="o">|</span> <span class="mh">0xff</span> <span class="o">|</span> <span class="n">MASK_GAINLINE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MASK_CMUTE</span> <span class="o">|</span> <span class="n">MASK_AMUTE</span><span class="p">;</span>
	<span class="cm">/* FIXME: Only machines with external SRS module need MASK_PAROUT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">has_iic</span> <span class="o">||</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="mh">0x5</span> <span class="o">||</span>
	    <span class="cm">/* chip-&gt;_device_id == 0x8 || */</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="mh">0xb</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MASK_PAROUT</span><span class="p">;</span>
	<span class="cm">/* get default volume from nvram */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>vol = (~nvram<em>read</em>byte(0x1308) &amp; 7) &lt;&lt; 1;
vol = ((pmac<em>xpram</em>read( 8 ) &amp; 7 ) &lt;&lt; 1 );</p></td><td class="code"><div class="highlight"><pre>	<span class="n">vol</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span> <span class="cm">/* no, on alsa, muted as default */</span>
	<span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">+</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_SCREAMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: screamer has loopthru vol control */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">;</span>
		<span class="cm">/* FIXME: maybe should be vol &lt;&lt; 3 for PCMCIA speaker */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MASK_MIC_BOOST</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">awacs_restore_all_regs</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">codec_stat</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">screamer_recalibrate</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs</span><span class="o">-&gt;</span><span class="n">codec_stat</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
<span class="cp">#ifdef PMAC_AMP_AVAIL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">has_iic</span> <span class="o">&amp;&amp;</span> <span class="n">CHECK_CUDA_AMP</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">awacs_amp</span> <span class="o">*</span><span class="n">amp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">amp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">amp</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span> <span class="o">=</span> <span class="n">amp</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_free</span> <span class="o">=</span> <span class="n">awacs_amp_free</span><span class="p">;</span>
		<span class="cm">/* mute and zero vol */</span>
		<span class="n">awacs_amp_set_vol</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">awacs_amp_set_vol</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">awacs_amp_set_tone</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span> <span class="cm">/* 0 dB */</span>
		<span class="n">awacs_amp_set_master</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="mi">79</span><span class="p">);</span> <span class="cm">/* 0 dB */</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PMAC_AMP_AVAIL */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_stat_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set headphone-jack detection bit */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PMAC_AWACS</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_stat_mask</span> <span class="o">=</span> <span class="n">pm7500</span> <span class="o">||</span> <span class="n">pm5500</span> <span class="o">?</span> <span class="n">MASK_HDPCONN</span>
				<span class="o">:</span> <span class="n">MASK_LOCONN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PMAC_SCREAMER</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="k">case</span> <span class="mh">0x0B</span>:
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_stat_mask</span> <span class="o">=</span> <span class="n">imac</span>
					<span class="o">?</span> <span class="n">MASK_LOCONN_IMAC</span> <span class="o">|</span>
					<span class="n">MASK_HDPLCONN_IMAC</span> <span class="o">|</span>
					<span class="n">MASK_HDPRCONN_IMAC</span>
					<span class="o">:</span> <span class="n">MASK_HDPCONN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="k">case</span> <span class="mh">0x05</span>:
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_stat_mask</span> <span class="o">=</span> <span class="n">MASK_LOCONN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_stat_mask</span> <span class="o">=</span> <span class="n">MASK_HDPCONN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snd_BUG</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * build mixers</span>
<span class="cm">	 */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;PowerMac AWACS&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_awacs_mixers</span><span class="p">),</span>
				<span class="n">snd_pmac_awacs_mixers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beige</span> <span class="o">||</span> <span class="n">g4agp</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_SCREAMER</span> <span class="o">||</span> <span class="n">pm5500</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_screamer_mixers2</span><span class="p">),</span>
				   <span class="n">snd_pmac_screamer_mixers2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm7500</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_awacs_mixers2</span><span class="p">),</span>
				   <span class="n">snd_pmac_awacs_mixers2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm5500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_awacs_mixers2_pmac5500</span><span class="p">),</span>
				   <span class="n">snd_pmac_awacs_mixers2_pmac5500</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm7500</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_awacs_mixers_pmac7500</span><span class="p">),</span>
				   <span class="n">snd_pmac_awacs_mixers_pmac7500</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pm5500</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">master_vol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="n">snd_pmac_awacs_mixers_pmac5500</span><span class="p">,</span>
						<span class="n">chip</span><span class="p">)));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">beige</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_screamer_mixers_beige</span><span class="p">),</span>
				   <span class="n">snd_pmac_screamer_mixers_beige</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imac</span> <span class="o">||</span> <span class="n">lombard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">master_vol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="n">snd_pmac_screamer_mixers_lo</span><span class="p">,</span>
						<span class="n">chip</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_screamer_mixers_imac</span><span class="p">),</span>
				   <span class="n">snd_pmac_screamer_mixers_imac</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">g4agp</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_screamer_mixers_g4agp</span><span class="p">),</span>
				   <span class="n">snd_pmac_screamer_mixers_g4agp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_awacs_mixers_pmac</span><span class="p">),</span>
				   <span class="n">snd_pmac_awacs_mixers_pmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">((</span><span class="n">pm7500</span> <span class="o">||</span> <span class="n">imac</span> <span class="o">||</span> <span class="n">g4agp</span> <span class="o">||</span> <span class="n">lombard</span><span class="p">)</span>
			<span class="o">?</span> <span class="o">&amp;</span><span class="n">snd_pmac_awacs_master_sw_imac</span>
			<span class="o">:</span> <span class="n">pm5500</span>
			<span class="o">?</span> <span class="o">&amp;</span><span class="n">snd_pmac_awacs_master_sw_pmac5500</span>
			<span class="o">:</span> <span class="o">&amp;</span><span class="n">snd_pmac_awacs_master_sw</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#ifdef PMAC_AMP_AVAIL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use amplifier.  the signal is connected from route A</span>
<span class="cm">		 * to the amp.  the amp has its headphone and speaker</span>
<span class="cm">		 * volumes and mute switches, so we use them instead of</span>
<span class="cm">		 * screamer registers.</span>
<span class="cm">		 * in this case, it seems the route C is not used.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_awacs_amp_vol</span><span class="p">),</span>
					<span class="n">snd_pmac_awacs_amp_vol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* overwrite */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_pmac_awacs_amp_hp_sw</span><span class="p">,</span>
							<span class="n">chip</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_pmac_awacs_amp_spk_sw</span><span class="p">,</span>
							<span class="n">chip</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif </span><span class="cm">/* PMAC_AMP_AVAIL */</span><span class="cp"></span>
	<span class="p">{</span>
		<span class="cm">/* route A = headphone, route C = speaker */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">speaker_vol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="n">snd_pmac_awacs_speaker_vol</span><span class="p">,</span>
						<span class="n">chip</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="n">imac1</span>
				<span class="o">?</span> <span class="o">&amp;</span><span class="n">snd_pmac_awacs_speaker_sw_imac1</span>
				<span class="o">:</span> <span class="n">imac2</span>
				<span class="o">?</span> <span class="o">&amp;</span><span class="n">snd_pmac_awacs_speaker_sw_imac2</span>
				<span class="o">:</span> <span class="o">&amp;</span><span class="n">snd_pmac_awacs_speaker_sw</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm5500</span> <span class="o">||</span> <span class="n">imac</span> <span class="o">||</span> <span class="n">lombard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vmaster_sw</span> <span class="o">=</span> <span class="n">snd_ctl_make_virtual_master</span><span class="p">(</span>
			<span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add_slave_uncached</span><span class="p">(</span><span class="n">vmaster_sw</span><span class="p">,</span>
						 <span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add_slave_uncached</span><span class="p">(</span><span class="n">vmaster_sw</span><span class="p">,</span>
						  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vmaster_sw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">vmaster_vol</span> <span class="o">=</span> <span class="n">snd_ctl_make_virtual_master</span><span class="p">(</span>
			<span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add_slave</span><span class="p">(</span><span class="n">vmaster_vol</span><span class="p">,</span> <span class="n">master_vol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add_slave</span><span class="p">(</span><span class="n">vmaster_vol</span><span class="p">,</span> <span class="n">speaker_vol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vmaster_vol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beige</span> <span class="o">||</span> <span class="n">g4agp</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_screamer_mic_boost_beige</span><span class="p">),</span>
				<span class="n">snd_pmac_screamer_mic_boost_beige</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imac</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_screamer_mic_boost_imac</span><span class="p">),</span>
				<span class="n">snd_pmac_screamer_mic_boost_imac</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_SCREAMER</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_screamer_mic_boost</span><span class="p">),</span>
				<span class="n">snd_pmac_screamer_mic_boost</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pm7500</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_awacs_mic_boost_pmac7500</span><span class="p">),</span>
				<span class="n">snd_pmac_awacs_mic_boost_pmac7500</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">build_mixers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_pmac_awacs_mic_boost</span><span class="p">),</span>
				<span class="n">snd_pmac_awacs_mic_boost</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set lowlevel callbacks</span>
<span class="cm">	 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">set_format</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_set_format</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_suspend</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">resume</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_resume</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef PMAC_SUPPORT_AUTOMUTE</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pmac_add_automute</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">detect_headphone</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_detect_headphone</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span> <span class="o">=</span> <span class="n">snd_pmac_awacs_update_automute</span><span class="p">;</span>
	<span class="n">snd_pmac_awacs_update_automute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* update the status only */</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_SCREAMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">snd_pmac_awacs_write_noreg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">awacs_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
