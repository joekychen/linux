<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › ppc › tumbler.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tumbler.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PMac Tumbler/Snapper lowlevel functions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> *   Rene Rebe &lt;rene.rebe@gmx.net&gt;:</span>
<span class="cm"> *     * update from shadow registers on wakeup and headphone plug</span>
<span class="cm"> *     * automatically toggle DRC on headphone plug</span>
<span class="cm"> *	</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#include &quot;pmac.h&quot;</span>
<span class="cp">#include &quot;tumbler_volume.h&quot;</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DBG(fmt...) printk(KERN_DEBUG fmt)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(fmt...)</span>
<span class="cp">#endif</span>

<span class="cp">#define IS_G4DA (of_machine_is_compatible(&quot;PowerMac3,4&quot;))</span>

<span class="cm">/* i2c address for tumbler */</span>
<span class="cp">#define TAS_I2C_ADDR	0x34</span>

<span class="cm">/* registers */</span>
<span class="cp">#define TAS_REG_MCS	0x01	</span><span class="cm">/* main control */</span><span class="cp"></span>
<span class="cp">#define TAS_REG_DRC	0x02</span>
<span class="cp">#define TAS_REG_VOL	0x04</span>
<span class="cp">#define TAS_REG_TREBLE	0x05</span>
<span class="cp">#define TAS_REG_BASS	0x06</span>
<span class="cp">#define TAS_REG_INPUT1	0x07</span>
<span class="cp">#define TAS_REG_INPUT2	0x08</span>

<span class="cm">/* tas3001c */</span>
<span class="cp">#define TAS_REG_PCM	TAS_REG_INPUT1</span>
 
<span class="cm">/* tas3004 */</span>
<span class="cp">#define TAS_REG_LMIX	TAS_REG_INPUT1</span>
<span class="cp">#define TAS_REG_RMIX	TAS_REG_INPUT2</span>
<span class="cp">#define TAS_REG_MCS2	0x43		</span><span class="cm">/* main control 2 */</span><span class="cp"></span>
<span class="cp">#define TAS_REG_ACS	0x40		</span><span class="cm">/* analog control */</span><span class="cp"></span>

<span class="cm">/* mono volumes for tas3001c/tas3004 */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">VOL_IDX_PCM_MONO</span><span class="p">,</span> <span class="cm">/* tas3001c only */</span>
	<span class="n">VOL_IDX_BASS</span><span class="p">,</span> <span class="n">VOL_IDX_TREBLE</span><span class="p">,</span>
	<span class="n">VOL_IDX_LAST_MONO</span>
<span class="p">};</span>

<span class="cm">/* stereo volumes for tas3004 */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">VOL_IDX_PCM</span><span class="p">,</span> <span class="n">VOL_IDX_PCM2</span><span class="p">,</span> <span class="n">VOL_IDX_ADC</span><span class="p">,</span>
	<span class="n">VOL_IDX_LAST_MIX</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">inactive_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active_state</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmac_keywest</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="n">audio_reset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="n">amp_mute</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="n">line_mute</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="n">line_detect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="n">hp_mute</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="n">hp_detect</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">headphone_irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lineout_irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">save_master_vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">master_vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">save_master_switch</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">master_switch</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mono_vol</span><span class="p">[</span><span class="n">VOL_IDX_LAST_MONO</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mix_vol</span><span class="p">[</span><span class="n">VOL_IDX_LAST_MIX</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* stereo volumes for tas3004 */</span>
	<span class="kt">int</span> <span class="n">drc_range</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drc_enable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">capture_source</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">anded_reset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">auto_mute_notify</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset_on_sleep</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">acs</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_keywest</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">regs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
							<span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(W) i2c error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">regs</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_keywest</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* normal operation, SCLK=64fps, i2s output, i2s input, 16bit width */</span>
		<span class="n">TAS_REG_MCS</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="cm">/* terminator */</span>
	<span class="p">};</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) tumbler init client</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">send_init_client</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_keywest</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* normal operation, SCLK=64fps, i2s output, 16bit width */</span>
		<span class="n">TAS_REG_MCS</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* normal operation, all-pass mode */</span>
		<span class="n">TAS_REG_MCS2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">),</span>
		<span class="cm">/* normal output, no deemphasis, A input, power-up, line-in */</span>
		<span class="n">TAS_REG_ACS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="cm">/* terminator */</span>
	<span class="p">};</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) snapper init client</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">send_init_client</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>
	
<span class="cm">/*</span>
<span class="cm"> * gpio access</span>
<span class="cm"> */</span>
<span class="cp">#define do_gpio_write(gp, val) \</span>
<span class="cp">	pmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, (gp)-&gt;addr, val)</span>
<span class="cp">#define do_gpio_read(gp) \</span>
<span class="cp">	pmac_call_feature(PMAC_FTR_READ_GPIO, NULL, (gp)-&gt;addr, 0)</span>
<span class="cp">#define tumbler_gpio_free(gp) </span><span class="cm">/* NOP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_audio_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">active</span> <span class="o">=</span> <span class="n">active</span> <span class="o">?</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_val</span> <span class="o">:</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">inactive_val</span><span class="p">;</span>
	<span class="n">do_gpio_write</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) gpio %x write %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_audio_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_gpio_read</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_val</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_audio_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="o">*</span><span class="n">gp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_gpio_read</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * update master volume</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_set_master_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">block</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">left_vol</span><span class="p">,</span> <span class="n">right_vol</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">left_vol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">left_vol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left_vol</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">master_volume_table</span><span class="p">))</span>
			<span class="n">left_vol</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">master_volume_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">left_vol</span> <span class="o">=</span> <span class="n">master_volume_table</span><span class="p">[</span><span class="n">left_vol</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">right_vol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">right_vol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">right_vol</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">master_volume_table</span><span class="p">))</span>
			<span class="n">right_vol</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">master_volume_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">right_vol</span> <span class="o">=</span> <span class="n">master_volume_table</span><span class="p">[</span><span class="n">right_vol</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_vol</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_vol</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_vol</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_vol</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_vol</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_vol</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">TAS_REG_VOL</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
					   <span class="n">block</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed to set volume </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) succeeded to set volume (%u, %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">left_vol</span><span class="p">,</span> <span class="n">right_vol</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* output volume */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_info_master_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">master_volume_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_get_master_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_put_master_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">master_volume_table</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">master_volume_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">tumbler_set_master_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* output switch */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_get_master_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_put_master_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">change</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">tumbler_set_master_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * TAS3001c dynamic range compression</span>
<span class="cm"> */</span>

<span class="cp">#define TAS3001_DRC_MAX		0x5f</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_set_drc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc1</span><span class="p">;</span> <span class="cm">/* enable, 3:1 compression */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span> <span class="o">&gt;</span> <span class="n">TAS3001_DRC_MAX</span><span class="p">)</span>
			<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x91</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span> <span class="o">+</span> <span class="mh">0x91</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">TAS_REG_DRC</span><span class="p">,</span>
					   <span class="mi">2</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed to set DRC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) succeeded to set DRC (%u, %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TAS3004</span>
<span class="cm"> */</span>

<span class="cp">#define TAS3004_DRC_MAX		0xef</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_set_drc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_enable</span><span class="p">)</span>
		<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span> <span class="cm">/* 3:1 above threshold */</span>
	<span class="k">else</span>
		<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x51</span><span class="p">;</span> <span class="cm">/* disabled */</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* 1:1 below threshold */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span> <span class="o">&gt;</span> <span class="mh">0xef</span><span class="p">)</span>
		<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xef</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xb0</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">TAS_REG_DRC</span><span class="p">,</span>
					   <span class="mi">6</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed to set DRC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) succeeded to set DRC (%u, %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_info_drc_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span> <span class="o">?</span> <span class="n">TAS3001_DRC_MAX</span> <span class="o">:</span> <span class="n">TAS3004_DRC_MAX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_get_drc_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_put_drc_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">TAS3001_DRC_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">TAS3004_DRC_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span><span class="p">)</span>
			<span class="n">tumbler_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snapper_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_get_drc_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_enable</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_put_drc_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_enable</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_enable</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span><span class="p">)</span>
			<span class="n">tumbler_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snapper_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * mono volumes</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_set_mono_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
  
	<span class="n">vol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">mono_vol</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vol</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">vol</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">block</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span>
					   <span class="n">info</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed to set mono volume %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_info_mono</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_get_mono</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">mono_vol</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_put_mono</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">vol</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">mono_vol</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vol</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">mono_vol</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">;</span>
		<span class="n">tumbler_set_mono_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TAS3001c mono volumes */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="n">tumbler_pcm_vol_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">VOL_IDX_PCM_MONO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">TAS_REG_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_volume_table</span><span class="p">),</span>
	<span class="p">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">mixer_volume_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="n">tumbler_bass_vol_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">VOL_IDX_BASS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">TAS_REG_BASS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bass_volume_table</span><span class="p">),</span>
	<span class="p">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">bass_volume_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="n">tumbler_treble_vol_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">VOL_IDX_TREBLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">TAS_REG_TREBLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">treble_volume_table</span><span class="p">),</span>
	<span class="p">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">treble_volume_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* TAS3004 mono volumes */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="n">snapper_bass_vol_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">VOL_IDX_BASS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">TAS_REG_BASS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snapper_bass_volume_table</span><span class="p">),</span>
	<span class="p">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">snapper_bass_volume_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tumbler_mono_vol</span> <span class="n">snapper_treble_vol_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">VOL_IDX_TREBLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">TAS_REG_TREBLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snapper_treble_volume_table</span><span class="p">),</span>
	<span class="p">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">snapper_treble_volume_table</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#define DEFINE_MONO(xname,type) { \</span>
<span class="cp">	.iface = SNDRV_CTL_ELEM_IFACE_MIXER,\</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.info = tumbler_info_mono, \</span>
<span class="cp">	.get = tumbler_get_mono, \</span>
<span class="cp">	.put = tumbler_put_mono, \</span>
<span class="cp">	.private_value = (unsigned long)(&amp;tumbler_##type##_vol_info), \</span>
<span class="cp">}</span>

<span class="cp">#define DEFINE_SNAPPER_MONO(xname,type) { \</span>
<span class="cp">	.iface = SNDRV_CTL_ELEM_IFACE_MIXER,\</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.info = tumbler_info_mono, \</span>
<span class="cp">	.get = tumbler_get_mono, \</span>
<span class="cp">	.put = tumbler_put_mono, \</span>
<span class="cp">	.private_value = (unsigned long)(&amp;snapper_##type##_vol_info), \</span>
<span class="cp">}</span>


<span class="cm">/*</span>
<span class="cm"> * snapper mixer volumes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_set_mix_vol1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">vol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">block</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

	<span class="n">vol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">mix_vol</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">ch</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_volume_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_volume_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">mix_vol</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">mix_vol</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ch</span><span class="p">];</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="n">mixer_volume_table</span><span class="p">[</span><span class="n">vol</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">block</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="mi">2</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
					   <span class="mi">9</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed to set mono volume %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_set_mix_vol</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snapper_set_mix_vol1</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TAS_REG_LMIX</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">snapper_set_mix_vol1</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TAS_REG_RMIX</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_info_mix</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_volume_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_get_mix</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">mix_vol</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">mix_vol</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_put_mix</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_volume_table</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_volume_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">mix_vol</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">mix_vol</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">mix_vol</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">mix_vol</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">snapper_set_mix_vol</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * mute switches. FIXME: Turn that into software mute when both outputs are muted</span>
<span class="cm"> * to avoid codec reset on ibook M7</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">TUMBLER_MUTE_HP</span><span class="p">,</span> <span class="n">TUMBLER_MUTE_AMP</span><span class="p">,</span> <span class="n">TUMBLER_MUTE_LINE</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_get_mute_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUMBLER_MUTE_HP</span>:
		<span class="n">gp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUMBLER_MUTE_AMP</span>:
		<span class="n">gp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUMBLER_MUTE_LINE</span>:
		<span class="n">gp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_mute</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">gp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="n">check_audio_gpio</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_put_mute_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#ifdef PMAC_SUPPORT_AUTOMUTE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_mute</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* don&#39;t touch in the auto-mute mode */</span>
<span class="cp">#endif	</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUMBLER_MUTE_HP</span>:
		<span class="n">gp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUMBLER_MUTE_AMP</span>:
		<span class="n">gp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUMBLER_MUTE_LINE</span>:
		<span class="n">gp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_mute</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">gp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="o">!</span> <span class="n">check_audio_gpio</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="o">!</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_set_capture_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">capture_source</span><span class="p">)</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">acs</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">acs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">TAS_REG_ACS</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">acs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_info_capture_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Line&quot;</span><span class="p">,</span> <span class="s">&quot;Mic&quot;</span>
	<span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_get_capture_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">capture_source</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snapper_put_capture_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">change</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">capture_source</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">capture_source</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">snapper_set_capture_source</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DEFINE_SNAPPER_MIX(xname,idx,ofs) { \</span>
<span class="cp">	.iface = SNDRV_CTL_ELEM_IFACE_MIXER,\</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.info = snapper_info_mix, \</span>
<span class="cp">	.get = snapper_get_mix, \</span>
<span class="cp">	.put = snapper_put_mix, \</span>
<span class="cp">	.index = idx,\</span>
<span class="cp">	.private_value = ofs, \</span>
<span class="cp">}</span>


<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tumbler_mixers</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">tumbler_info_master_volume</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_master_volume</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_master_volume</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_stereo_info</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_master_switch</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_master_switch</span>
	<span class="p">},</span>
	<span class="n">DEFINE_MONO</span><span class="p">(</span><span class="s">&quot;Tone Control - Bass&quot;</span><span class="p">,</span> <span class="n">bass</span><span class="p">),</span>
	<span class="n">DEFINE_MONO</span><span class="p">(</span><span class="s">&quot;Tone Control - Treble&quot;</span><span class="p">,</span> <span class="n">treble</span><span class="p">),</span>
	<span class="n">DEFINE_MONO</span><span class="p">(</span><span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span> <span class="n">pcm</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DRC Range&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">tumbler_info_drc_value</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_drc_value</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_drc_value</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snapper_mixers</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">tumbler_info_master_volume</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_master_volume</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_master_volume</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_stereo_info</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_master_switch</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_master_switch</span>
	<span class="p">},</span>
	<span class="n">DEFINE_SNAPPER_MIX</span><span class="p">(</span><span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VOL_IDX_PCM</span><span class="p">),</span>
	<span class="cm">/* Alternative PCM is assigned to Mic analog loopback on iBook G4 */</span>
	<span class="n">DEFINE_SNAPPER_MIX</span><span class="p">(</span><span class="s">&quot;Mic Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VOL_IDX_PCM2</span><span class="p">),</span>
	<span class="n">DEFINE_SNAPPER_MIX</span><span class="p">(</span><span class="s">&quot;Monitor Mix Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VOL_IDX_ADC</span><span class="p">),</span>
	<span class="n">DEFINE_SNAPPER_MONO</span><span class="p">(</span><span class="s">&quot;Tone Control - Bass&quot;</span><span class="p">,</span> <span class="n">bass</span><span class="p">),</span>
	<span class="n">DEFINE_SNAPPER_MONO</span><span class="p">(</span><span class="s">&quot;Tone Control - Treble&quot;</span><span class="p">,</span> <span class="n">treble</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DRC Range&quot;</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">tumbler_info_drc_value</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_drc_value</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_drc_value</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Input Source&quot;</span><span class="p">,</span> <span class="cm">/* FIXME: &quot;Capture Source&quot; doesn&#39;t work properly */</span>
	  <span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snapper_info_capture_source</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snapper_get_capture_source</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snapper_put_capture_source</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tumbler_hp_sw</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Headphone Playback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_mono_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_mute_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_mute_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">TUMBLER_MUTE_HP</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tumbler_speaker_sw</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Speaker Playback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_mono_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_mute_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_mute_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">TUMBLER_MUTE_AMP</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tumbler_lineout_sw</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Line Out Playback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_mono_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_mute_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_mute_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">TUMBLER_MUTE_LINE</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tumbler_drc_sw</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DRC Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_pmac_boolean_mono_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tumbler_get_drc_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">tumbler_put_drc_switch</span>
<span class="p">};</span>


<span class="cp">#ifdef PMAC_SUPPORT_AUTOMUTE</span>
<span class="cm">/*</span>
<span class="cm"> * auto-mute stuffs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_detect_headphone</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">detect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">detect</span> <span class="o">|=</span> <span class="n">read_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">detect</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tumbler_detect_lineout</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">detect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_detect</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">detect</span> <span class="o">|=</span> <span class="n">read_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_detect</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">detect</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_notify</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">sw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_audio_gpio</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_notify</span><span class="p">)</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">work_struct</span> <span class="n">device_change</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">device_change_chip</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_change_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device_change_chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">headphone</span><span class="p">,</span> <span class="n">lineout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mix</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">headphone</span> <span class="o">=</span> <span class="n">tumbler_detect_headphone</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">lineout</span> <span class="o">=</span> <span class="n">tumbler_detect_lineout</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;headphone: %d, lineout: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">headphone</span><span class="p">,</span> <span class="n">lineout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">headphone</span> <span class="o">||</span> <span class="n">lineout</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unmute headphone/lineout &amp; mute speaker */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">headphone</span><span class="p">)</span>
			<span class="n">check_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">auto_mute_notify</span><span class="p">,</span>
				   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lineout</span> <span class="o">&amp;&amp;</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_mute</span><span class="p">.</span><span class="n">addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">check_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">auto_mute_notify</span><span class="p">,</span>
				   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lineout_sw_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">anded_reset</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">check_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">,</span> <span class="o">!</span><span class="n">IS_G4DA</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">auto_mute_notify</span><span class="p">,</span>
			   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* unmute speaker, mute others */</span>
		<span class="n">check_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">auto_mute_notify</span><span class="p">,</span>
			   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">anded_reset</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">check_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">auto_mute_notify</span><span class="p">,</span>
			   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_mute</span><span class="p">.</span><span class="n">addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">check_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">auto_mute_notify</span><span class="p">,</span>
				   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lineout_sw_ctl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">auto_mute_notify</span><span class="p">)</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_detect_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_POWERMAC_AUTO_DRC</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_enable</span> <span class="o">=</span> <span class="o">!</span> <span class="p">(</span><span class="n">headphone</span> <span class="o">||</span> <span class="n">lineout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">auto_mute_notify</span><span class="p">)</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">drc_sw_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span><span class="p">)</span>
		<span class="n">tumbler_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snapper_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* reset the master volume so the correct amplification is applied */</span>
	<span class="n">tumbler_set_master_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tumbler_update_automute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_notify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_mute</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
		<span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mix</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">auto_mute_notify</span> <span class="o">=</span> <span class="n">do_notify</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_change</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PMAC_SUPPORT_AUTOMUTE */</span><span class="cp"></span>


<span class="cm">/* interrupt - headphone plug changed */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">headphone_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* look for audio-gpio device */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="nf">find_audio_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">gpiop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
  
	<span class="n">gpiop</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;gpio&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">gpiop</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  
	<span class="k">for</span> <span class="p">(</span><span class="n">np</span> <span class="o">=</span> <span class="n">of_get_next_child</span><span class="p">(</span><span class="n">gpiop</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">np</span><span class="p">;</span>
			<span class="n">np</span> <span class="o">=</span> <span class="n">of_get_next_child</span><span class="p">(</span><span class="n">gpiop</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;audio-gpio&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>  
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">gpiop</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">np</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* look for audio-gpio device */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="nf">find_compatible_audio_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">gpiop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
  
	<span class="n">gpiop</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;gpio&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpiop</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  
	<span class="k">for</span> <span class="p">(</span><span class="n">np</span> <span class="o">=</span> <span class="n">of_get_next_child</span><span class="p">(</span><span class="n">gpiop</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">np</span><span class="p">;</span>
			<span class="n">np</span> <span class="o">=</span> <span class="n">of_get_next_child</span><span class="p">(</span><span class="n">gpiop</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>  
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">gpiop</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">np</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* find an audio device and get its address */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">tumbler_find_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">platform</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pmac_gpio</span> <span class="o">*</span><span class="n">gp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_compatible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_compatible</span><span class="p">)</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">find_compatible_audio_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">find_audio_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(W) cannot find audio device %s !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cannot find device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;AAPL,address&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(E) cannot find address for device %s !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;cannot find address for device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x50</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">gp</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="cm">/* Try to find the active state, default to 0 ! */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;audio-gpio-active-state&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_state</span> <span class="o">=</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_val</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">base</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x5</span> <span class="o">:</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">inactive_val</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">base</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x4</span> <span class="o">:</span> <span class="mh">0x5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_state</span> <span class="o">=</span> <span class="n">IS_G4DA</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;keywest-gpio1&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_val</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">inactive_val</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
		<span class="cm">/* Here are some crude hacks to extract the GPIO polarity and</span>
<span class="cm">		 * open collector informations out of the do-platform script</span>
<span class="cm">		 * as we don&#39;t yet have an interpreter for these things</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="p">)</span>
			<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">platform</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x9</span> <span class="o">&amp;&amp;</span> <span class="n">prop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x9</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_val</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span>
				<span class="n">gp</span><span class="o">-&gt;</span><span class="n">inactive_val</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1</span> <span class="o">&amp;&amp;</span> <span class="n">prop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_val</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
				<span class="n">gp</span><span class="o">-&gt;</span><span class="n">inactive_val</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) GPIO device %s found, offset: %x, active state: %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">device</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">active_state</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* reset audio */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tumbler_reset_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">anded_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) codec anded reset !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) codec normal reset !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">audio_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">audio_reset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">audio_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/* suspend mixer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tumbler_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span><span class="p">);</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">save_master_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">save_master_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">save_master_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">save_master_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tumbler_set_master_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">anded_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_SNAPPER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">acs</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span><span class="p">,</span> <span class="n">TAS_REG_ACS</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">acs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">anded_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">write_audio_gpio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">audio_reset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* resume mixer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tumbler_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">acs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">save_master_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">save_master_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">save_master_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">master_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">save_master_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">tumbler_reset_audio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">client</span> <span class="o">&amp;&amp;</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">init_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">init_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tumbler_init_client error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tumbler: i2c is not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tumbler_set_mono_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tumbler_pcm_vol_info</span><span class="p">);</span>
		<span class="n">tumbler_set_mono_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tumbler_bass_vol_info</span><span class="p">);</span>
		<span class="n">tumbler_set_mono_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tumbler_treble_vol_info</span><span class="p">);</span>
		<span class="n">tumbler_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snapper_set_mix_vol</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="n">VOL_IDX_PCM</span><span class="p">);</span>
		<span class="n">snapper_set_mix_vol</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="n">VOL_IDX_PCM2</span><span class="p">);</span>
		<span class="n">snapper_set_mix_vol</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="n">VOL_IDX_ADC</span><span class="p">);</span>
		<span class="n">tumbler_set_mono_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snapper_bass_vol_info</span><span class="p">);</span>
		<span class="n">tumbler_set_mono_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snapper_treble_vol_info</span><span class="p">);</span>
		<span class="n">snapper_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
		<span class="n">snapper_set_capture_source</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tumbler_set_master_volume</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">enable_irq</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span><span class="p">);</span>
		<span class="cm">/* activate headphone status interrupts */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">do_gpio_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">);</span>
		<span class="n">do_gpio_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* initialize tumbler */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tumbler_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;audio-hw-reset&quot;</span><span class="p">,</span>
				<span class="s">&quot;platform-do-hw-reset&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">audio_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;hw-reset&quot;</span><span class="p">,</span>
				    <span class="s">&quot;platform-do-hw-reset&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">audio_reset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;amp-mute&quot;</span><span class="p">,</span>
				<span class="s">&quot;platform-do-amp-mute&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;amp-mute&quot;</span><span class="p">,</span>
				    <span class="s">&quot;platform-do-amp-mute&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;headphone-mute&quot;</span><span class="p">,</span>
				<span class="s">&quot;platform-do-headphone-mute&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;headphone-mute&quot;</span><span class="p">,</span>
				    <span class="s">&quot;platform-do-headphone-mute&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;line-output-mute&quot;</span><span class="p">,</span>
				<span class="s">&quot;platform-do-lineout-mute&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;line-output-mute&quot;</span><span class="p">,</span>
				   <span class="s">&quot;platform-do-lineout-mute&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_mute</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;headphone-detect&quot;</span><span class="p">,</span>
				  <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;headphone-detect&quot;</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;keywest-gpio15&quot;</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
 	<span class="n">irq</span> <span class="o">=</span> <span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;line-output-detect&quot;</span><span class="p">,</span>
				  <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_detect</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;line-output-detect&quot;</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_detect</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_G4DA</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">tumbler_find_device</span><span class="p">(</span><span class="s">&quot;keywest-gpio16&quot;</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_detect</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">tumbler_reset_audio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tumbler_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">tumbler_gpio_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">audio_reset</span><span class="p">);</span>
	<span class="n">tumbler_gpio_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">amp_mute</span><span class="p">);</span>
	<span class="n">tumbler_gpio_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_mute</span><span class="p">);</span>
	<span class="n">tumbler_gpio_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">);</span>
	<span class="n">snd_pmac_keywest_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* exported */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_pmac_tumbler_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pmac</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmac_tumbler</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">paddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">tas_node</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">chipname</span><span class="p">;</span>

	<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;i2c-powermac&quot;</span><span class="p">);</span>

	<span class="n">mix</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mix</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mix</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_data</span> <span class="o">=</span> <span class="n">mix</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_free</span> <span class="o">=</span> <span class="n">tumbler_cleanup</span><span class="p">;</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">anded_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">reset_on_sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">np</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span> <span class="n">np</span><span class="p">;</span> <span class="n">np</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;sound&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;has-anded-reset&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
				<span class="n">mix</span><span class="o">-&gt;</span><span class="n">anded_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;layout-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
				<span class="n">mix</span><span class="o">-&gt;</span><span class="n">reset_on_sleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">tumbler_init</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* set up TAS */</span>
	<span class="n">tas_node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;deq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tas_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tas_node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;codec&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tas_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">paddr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">tas_node</span><span class="p">,</span> <span class="s">&quot;i2c-address&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">paddr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">tas_node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paddr</span><span class="p">)</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">paddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">TAS_I2C_ADDR</span><span class="p">;</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">tas_node</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;(I) TAS i2c address is: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">init_client</span> <span class="o">=</span> <span class="n">tumbler_init_client</span><span class="p">;</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;TAS3001c&quot;</span><span class="p">;</span>
		<span class="n">chipname</span> <span class="o">=</span> <span class="s">&quot;Tumbler&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">init_client</span> <span class="o">=</span> <span class="n">snapper_init_client</span><span class="p">;</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;TAS3004&quot;</span><span class="p">;</span>
		<span class="n">chipname</span> <span class="o">=</span> <span class="s">&quot;Snapper&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pmac_keywest_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * build mixers</span>
<span class="cm">	 */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;PowerMac %s&quot;</span><span class="p">,</span> <span class="n">chipname</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tumbler_mixers</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tumbler_mixers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snapper_mixers</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snapper_mixers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tumbler_hp_sw</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">master_sw_ctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tumbler_speaker_sw</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">speaker_sw_ctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_mute</span><span class="p">.</span><span class="n">addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lineout_sw_ctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tumbler_lineout_sw</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lineout_sw_ctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">drc_sw_ctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tumbler_drc_sw</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">drc_sw_ctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* set initial DRC range to 60% */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span><span class="p">)</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">TAS3001_DRC_MAX</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">TAS3004_DRC_MAX</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">mix</span><span class="o">-&gt;</span><span class="n">drc_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* will be changed later if AUTO_DRC is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">PMAC_TUMBLER</span><span class="p">)</span>
		<span class="n">tumbler_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snapper_set_drc</span><span class="p">(</span><span class="n">mix</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">tumbler_suspend</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">resume</span> <span class="o">=</span> <span class="n">tumbler_resume</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_change</span><span class="p">,</span> <span class="n">device_change_handler</span><span class="p">);</span>
	<span class="n">device_change_chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

<span class="cp">#ifdef PMAC_SUPPORT_AUTOMUTE</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pmac_add_automute</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">detect_headphone</span> <span class="o">=</span> <span class="n">tumbler_detect_headphone</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">update_automute</span> <span class="o">=</span> <span class="n">tumbler_update_automute</span><span class="p">;</span>
	<span class="n">tumbler_update_automute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* update the status only */</span>

	<span class="cm">/* activate headphone status interrupts */</span>
  	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">headphone_irq</span><span class="p">,</span> <span class="n">headphone_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="s">&quot;Sound Headphone Detection&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* activate headphone status interrupts */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">do_gpio_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">);</span>
		<span class="n">do_gpio_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">hp_detect</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>
  	<span class="k">if</span> <span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">lineout_irq</span><span class="p">,</span> <span class="n">headphone_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="s">&quot;Sound Lineout Detection&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* activate headphone status interrupts */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">do_gpio_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_detect</span><span class="p">);</span>
		<span class="n">do_gpio_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">line_detect</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
