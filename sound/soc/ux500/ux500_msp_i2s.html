<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › ux500 › ux500_msp_i2s.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ux500_msp_i2s.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2012</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Ola Lilja &lt;ola.o.lilja@stericsson.com&gt;,</span>
<span class="cm"> *         for ST-Ericsson.</span>
<span class="cm"> *</span>
<span class="cm"> * License terms:</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as published</span>
<span class="cm"> * by the Free Software Foundation.</span>
<span class="cm"> */</span>


<span class="cp">#ifndef UX500_MSP_I2S_H</span>
<span class="cp">#define UX500_MSP_I2S_H</span>

<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;mach/board-mop500-msp.h&gt;</span>

<span class="cp">#define MSP_INPUT_FREQ_APB 48000000</span>

<span class="cm">/*** Stereo mode. Used for APB data accesses as 16 bits accesses (mono),</span>
<span class="cm"> *   32 bits accesses (stereo).</span>
<span class="cm"> ***/</span>
<span class="k">enum</span> <span class="n">msp_stereo_mode</span> <span class="p">{</span>
	<span class="n">MSP_MONO</span><span class="p">,</span>
	<span class="n">MSP_STEREO</span>
<span class="p">};</span>

<span class="cm">/* Direction (Transmit/Receive mode) */</span>
<span class="k">enum</span> <span class="n">msp_direction</span> <span class="p">{</span>
	<span class="n">MSP_TX</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MSP_RX</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">};</span>

<span class="cm">/* Transmit and receive configuration register */</span>
<span class="cp">#define MSP_BIG_ENDIAN           0x00000000</span>
<span class="cp">#define MSP_LITTLE_ENDIAN        0x00001000</span>
<span class="cp">#define MSP_UNEXPECTED_FS_ABORT  0x00000000</span>
<span class="cp">#define MSP_UNEXPECTED_FS_IGNORE 0x00008000</span>
<span class="cp">#define MSP_NON_MODE_BIT_MASK    0x00009000</span>

<span class="cm">/* Global configuration register */</span>
<span class="cp">#define RX_ENABLE             0x00000001</span>
<span class="cp">#define RX_FIFO_ENABLE        0x00000002</span>
<span class="cp">#define RX_SYNC_SRG           0x00000010</span>
<span class="cp">#define RX_CLK_POL_RISING     0x00000020</span>
<span class="cp">#define RX_CLK_SEL_SRG        0x00000040</span>
<span class="cp">#define TX_ENABLE             0x00000100</span>
<span class="cp">#define TX_FIFO_ENABLE        0x00000200</span>
<span class="cp">#define TX_SYNC_SRG_PROG      0x00001800</span>
<span class="cp">#define TX_SYNC_SRG_AUTO      0x00001000</span>
<span class="cp">#define TX_CLK_POL_RISING     0x00002000</span>
<span class="cp">#define TX_CLK_SEL_SRG        0x00004000</span>
<span class="cp">#define TX_EXTRA_DELAY_ENABLE 0x00008000</span>
<span class="cp">#define SRG_ENABLE            0x00010000</span>
<span class="cp">#define FRAME_GEN_ENABLE      0x00100000</span>
<span class="cp">#define SRG_CLK_SEL_APB       0x00000000</span>
<span class="cp">#define RX_FIFO_SYNC_HI       0x00000000</span>
<span class="cp">#define TX_FIFO_SYNC_HI       0x00000000</span>
<span class="cp">#define SPI_CLK_MODE_NORMAL   0x00000000</span>

<span class="cp">#define MSP_FRAME_SIZE_AUTO -1</span>

<span class="cp">#define MSP_DR		0x00</span>
<span class="cp">#define MSP_GCR		0x04</span>
<span class="cp">#define MSP_TCF		0x08</span>
<span class="cp">#define MSP_RCF		0x0c</span>
<span class="cp">#define MSP_SRG		0x10</span>
<span class="cp">#define MSP_FLR		0x14</span>
<span class="cp">#define MSP_DMACR	0x18</span>

<span class="cp">#define MSP_IMSC	0x20</span>
<span class="cp">#define MSP_RIS		0x24</span>
<span class="cp">#define MSP_MIS		0x28</span>
<span class="cp">#define MSP_ICR		0x2c</span>
<span class="cp">#define MSP_MCR		0x30</span>
<span class="cp">#define MSP_RCV		0x34</span>
<span class="cp">#define MSP_RCM		0x38</span>

<span class="cp">#define MSP_TCE0	0x40</span>
<span class="cp">#define MSP_TCE1	0x44</span>
<span class="cp">#define MSP_TCE2	0x48</span>
<span class="cp">#define MSP_TCE3	0x4c</span>

<span class="cp">#define MSP_RCE0	0x60</span>
<span class="cp">#define MSP_RCE1	0x64</span>
<span class="cp">#define MSP_RCE2	0x68</span>
<span class="cp">#define MSP_RCE3	0x6c</span>
<span class="cp">#define MSP_IODLY	0x70</span>

<span class="cp">#define MSP_ITCR	0x80</span>
<span class="cp">#define MSP_ITIP	0x84</span>
<span class="cp">#define MSP_ITOP	0x88</span>
<span class="cp">#define MSP_TSTDR	0x8c</span>

<span class="cp">#define MSP_PID0	0xfe0</span>
<span class="cp">#define MSP_PID1	0xfe4</span>
<span class="cp">#define MSP_PID2	0xfe8</span>
<span class="cp">#define MSP_PID3	0xfec</span>

<span class="cp">#define MSP_CID0	0xff0</span>
<span class="cp">#define MSP_CID1	0xff4</span>
<span class="cp">#define MSP_CID2	0xff8</span>
<span class="cp">#define MSP_CID3	0xffc</span>

<span class="cm">/* Protocol dependant parameters list */</span>
<span class="cp">#define RX_ENABLE_MASK		BIT(0)</span>
<span class="cp">#define RX_FIFO_ENABLE_MASK	BIT(1)</span>
<span class="cp">#define RX_FSYNC_MASK		BIT(2)</span>
<span class="cp">#define DIRECT_COMPANDING_MASK	BIT(3)</span>
<span class="cp">#define RX_SYNC_SEL_MASK	BIT(4)</span>
<span class="cp">#define RX_CLK_POL_MASK		BIT(5)</span>
<span class="cp">#define RX_CLK_SEL_MASK		BIT(6)</span>
<span class="cp">#define LOOPBACK_MASK		BIT(7)</span>
<span class="cp">#define TX_ENABLE_MASK		BIT(8)</span>
<span class="cp">#define TX_FIFO_ENABLE_MASK	BIT(9)</span>
<span class="cp">#define TX_FSYNC_MASK		BIT(10)</span>
<span class="cp">#define TX_MSP_TDR_TSR		BIT(11)</span>
<span class="cp">#define TX_SYNC_SEL_MASK	(BIT(12) | BIT(11))</span>
<span class="cp">#define TX_CLK_POL_MASK		BIT(13)</span>
<span class="cp">#define TX_CLK_SEL_MASK		BIT(14)</span>
<span class="cp">#define TX_EXTRA_DELAY_MASK	BIT(15)</span>
<span class="cp">#define SRG_ENABLE_MASK		BIT(16)</span>
<span class="cp">#define SRG_CLK_POL_MASK	BIT(17)</span>
<span class="cp">#define SRG_CLK_SEL_MASK	(BIT(19) | BIT(18))</span>
<span class="cp">#define FRAME_GEN_EN_MASK	BIT(20)</span>
<span class="cp">#define SPI_CLK_MODE_MASK	(BIT(22) | BIT(21))</span>
<span class="cp">#define SPI_BURST_MODE_MASK	BIT(23)</span>

<span class="cp">#define RXEN_SHIFT		0</span>
<span class="cp">#define RFFEN_SHIFT		1</span>
<span class="cp">#define RFSPOL_SHIFT		2</span>
<span class="cp">#define DCM_SHIFT		3</span>
<span class="cp">#define RFSSEL_SHIFT		4</span>
<span class="cp">#define RCKPOL_SHIFT		5</span>
<span class="cp">#define RCKSEL_SHIFT		6</span>
<span class="cp">#define LBM_SHIFT		7</span>
<span class="cp">#define TXEN_SHIFT		8</span>
<span class="cp">#define TFFEN_SHIFT		9</span>
<span class="cp">#define TFSPOL_SHIFT		10</span>
<span class="cp">#define TFSSEL_SHIFT		11</span>
<span class="cp">#define TCKPOL_SHIFT		13</span>
<span class="cp">#define TCKSEL_SHIFT		14</span>
<span class="cp">#define TXDDL_SHIFT		15</span>
<span class="cp">#define SGEN_SHIFT		16</span>
<span class="cp">#define SCKPOL_SHIFT		17</span>
<span class="cp">#define SCKSEL_SHIFT		18</span>
<span class="cp">#define FGEN_SHIFT		20</span>
<span class="cp">#define SPICKM_SHIFT		21</span>
<span class="cp">#define TBSWAP_SHIFT		28</span>

<span class="cp">#define RCKPOL_MASK		BIT(0)</span>
<span class="cp">#define TCKPOL_MASK		BIT(0)</span>
<span class="cp">#define SPICKM_MASK		(BIT(1) | BIT(0))</span>
<span class="cp">#define MSP_RX_CLKPOL_BIT(n)     ((n &amp; RCKPOL_MASK) &lt;&lt; RCKPOL_SHIFT)</span>
<span class="cp">#define MSP_TX_CLKPOL_BIT(n)     ((n &amp; TCKPOL_MASK) &lt;&lt; TCKPOL_SHIFT)</span>

<span class="cp">#define P1ELEN_SHIFT		0</span>
<span class="cp">#define P1FLEN_SHIFT		3</span>
<span class="cp">#define DTYP_SHIFT		10</span>
<span class="cp">#define ENDN_SHIFT		12</span>
<span class="cp">#define DDLY_SHIFT		13</span>
<span class="cp">#define FSIG_SHIFT		15</span>
<span class="cp">#define P2ELEN_SHIFT		16</span>
<span class="cp">#define P2FLEN_SHIFT		19</span>
<span class="cp">#define P2SM_SHIFT		26</span>
<span class="cp">#define P2EN_SHIFT		27</span>
<span class="cp">#define FSYNC_SHIFT		15</span>

<span class="cp">#define P1ELEN_MASK		0x00000007</span>
<span class="cp">#define P2ELEN_MASK		0x00070000</span>
<span class="cp">#define P1FLEN_MASK		0x00000378</span>
<span class="cp">#define P2FLEN_MASK		0x03780000</span>
<span class="cp">#define DDLY_MASK		0x00003000</span>
<span class="cp">#define DTYP_MASK		0x00000600</span>
<span class="cp">#define P2SM_MASK		0x04000000</span>
<span class="cp">#define P2EN_MASK		0x08000000</span>
<span class="cp">#define ENDN_MASK		0x00001000</span>
<span class="cp">#define TFSPOL_MASK		0x00000400</span>
<span class="cp">#define TBSWAP_MASK		0x30000000</span>
<span class="cp">#define COMPANDING_MODE_MASK	0x00000c00</span>
<span class="cp">#define FSYNC_MASK		0x00008000</span>

<span class="cp">#define MSP_P1_ELEM_LEN_BITS(n)		(n &amp; P1ELEN_MASK)</span>
<span class="cp">#define MSP_P2_ELEM_LEN_BITS(n)		(((n) &lt;&lt; P2ELEN_SHIFT) &amp; P2ELEN_MASK)</span>
<span class="cp">#define MSP_P1_FRAME_LEN_BITS(n)	(((n) &lt;&lt; P1FLEN_SHIFT) &amp; P1FLEN_MASK)</span>
<span class="cp">#define MSP_P2_FRAME_LEN_BITS(n)	(((n) &lt;&lt; P2FLEN_SHIFT) &amp; P2FLEN_MASK)</span>
<span class="cp">#define MSP_DATA_DELAY_BITS(n)		(((n) &lt;&lt; DDLY_SHIFT) &amp; DDLY_MASK)</span>
<span class="cp">#define MSP_DATA_TYPE_BITS(n)		(((n) &lt;&lt; DTYP_SHIFT) &amp; DTYP_MASK)</span>
<span class="cp">#define MSP_P2_START_MODE_BIT(n)	((n &lt;&lt; P2SM_SHIFT) &amp; P2SM_MASK)</span>
<span class="cp">#define MSP_P2_ENABLE_BIT(n)		((n &lt;&lt; P2EN_SHIFT) &amp; P2EN_MASK)</span>
<span class="cp">#define MSP_SET_ENDIANNES_BIT(n)	((n &lt;&lt; ENDN_SHIFT) &amp; ENDN_MASK)</span>
<span class="cp">#define MSP_FSYNC_POL(n)		((n &lt;&lt; TFSPOL_SHIFT) &amp; TFSPOL_MASK)</span>
<span class="cp">#define MSP_DATA_WORD_SWAP(n)		((n &lt;&lt; TBSWAP_SHIFT) &amp; TBSWAP_MASK)</span>
<span class="cp">#define MSP_SET_COMPANDING_MODE(n)	((n &lt;&lt; DTYP_SHIFT) &amp; \</span>
<span class="cp">						COMPANDING_MODE_MASK)</span>
<span class="cp">#define MSP_SET_FSYNC_IGNORE(n)		((n &lt;&lt; FSYNC_SHIFT) &amp; FSYNC_MASK)</span>

<span class="cm">/* Flag register */</span>
<span class="cp">#define RX_BUSY			BIT(0)</span>
<span class="cp">#define RX_FIFO_EMPTY		BIT(1)</span>
<span class="cp">#define RX_FIFO_FULL		BIT(2)</span>
<span class="cp">#define TX_BUSY			BIT(3)</span>
<span class="cp">#define TX_FIFO_EMPTY		BIT(4)</span>
<span class="cp">#define TX_FIFO_FULL		BIT(5)</span>

<span class="cp">#define RBUSY_SHIFT		0</span>
<span class="cp">#define RFE_SHIFT		1</span>
<span class="cp">#define RFU_SHIFT		2</span>
<span class="cp">#define TBUSY_SHIFT		3</span>
<span class="cp">#define TFE_SHIFT		4</span>
<span class="cp">#define TFU_SHIFT		5</span>

<span class="cm">/* Multichannel control register */</span>
<span class="cp">#define RMCEN_SHIFT		0</span>
<span class="cp">#define RMCSF_SHIFT		1</span>
<span class="cp">#define RCMPM_SHIFT		3</span>
<span class="cp">#define TMCEN_SHIFT		5</span>
<span class="cp">#define TNCSF_SHIFT		6</span>

<span class="cm">/* Sample rate generator register */</span>
<span class="cp">#define SCKDIV_SHIFT		0</span>
<span class="cp">#define FRWID_SHIFT		10</span>
<span class="cp">#define FRPER_SHIFT		16</span>

<span class="cp">#define SCK_DIV_MASK		0x0000003FF</span>
<span class="cp">#define FRAME_WIDTH_BITS(n)	(((n) &lt;&lt; FRWID_SHIFT)  &amp; 0x0000FC00)</span>
<span class="cp">#define FRAME_PERIOD_BITS(n)	(((n) &lt;&lt; FRPER_SHIFT) &amp; 0x1FFF0000)</span>

<span class="cm">/* DMA controller register */</span>
<span class="cp">#define RX_DMA_ENABLE		BIT(0)</span>
<span class="cp">#define TX_DMA_ENABLE		BIT(1)</span>

<span class="cp">#define RDMAE_SHIFT		0</span>
<span class="cp">#define TDMAE_SHIFT		1</span>

<span class="cm">/* Interrupt Register */</span>
<span class="cp">#define RX_SERVICE_INT		BIT(0)</span>
<span class="cp">#define RX_OVERRUN_ERROR_INT	BIT(1)</span>
<span class="cp">#define RX_FSYNC_ERR_INT	BIT(2)</span>
<span class="cp">#define RX_FSYNC_INT		BIT(3)</span>
<span class="cp">#define TX_SERVICE_INT		BIT(4)</span>
<span class="cp">#define TX_UNDERRUN_ERR_INT	BIT(5)</span>
<span class="cp">#define TX_FSYNC_ERR_INT	BIT(6)</span>
<span class="cp">#define TX_FSYNC_INT		BIT(7)</span>
<span class="cp">#define ALL_INT			0x000000ff</span>

<span class="cm">/* MSP test control register */</span>
<span class="cp">#define MSP_ITCR_ITEN		BIT(0)</span>
<span class="cp">#define MSP_ITCR_TESTFIFO	BIT(1)</span>

<span class="cp">#define RMCEN_BIT   0</span>
<span class="cp">#define RMCSF_BIT   1</span>
<span class="cp">#define RCMPM_BIT   3</span>
<span class="cp">#define TMCEN_BIT   5</span>
<span class="cp">#define TNCSF_BIT   6</span>

<span class="cm">/* Single or dual phase mode */</span>
<span class="k">enum</span> <span class="n">msp_phase_mode</span> <span class="p">{</span>
	<span class="n">MSP_SINGLE_PHASE</span><span class="p">,</span>
	<span class="n">MSP_DUAL_PHASE</span>
<span class="p">};</span>

<span class="cm">/* Frame length */</span>
<span class="k">enum</span> <span class="n">msp_frame_length</span> <span class="p">{</span>
	<span class="n">MSP_FRAME_LEN_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_FRAME_LEN_2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MSP_FRAME_LEN_4</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">MSP_FRAME_LEN_8</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">MSP_FRAME_LEN_12</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">MSP_FRAME_LEN_16</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
	<span class="n">MSP_FRAME_LEN_20</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span>
	<span class="n">MSP_FRAME_LEN_32</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
	<span class="n">MSP_FRAME_LEN_48</span> <span class="o">=</span> <span class="mi">47</span><span class="p">,</span>
	<span class="n">MSP_FRAME_LEN_64</span> <span class="o">=</span> <span class="mi">63</span>
<span class="p">};</span>

<span class="cm">/* Element length */</span>
<span class="k">enum</span> <span class="n">msp_elem_length</span> <span class="p">{</span>
	<span class="n">MSP_ELEM_LEN_8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_ELEM_LEN_10</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MSP_ELEM_LEN_12</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">MSP_ELEM_LEN_14</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">MSP_ELEM_LEN_16</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">MSP_ELEM_LEN_20</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">MSP_ELEM_LEN_24</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">MSP_ELEM_LEN_32</span> <span class="o">=</span> <span class="mi">7</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_data_xfer_width</span> <span class="p">{</span>
	<span class="n">MSP_DATA_TRANSFER_WIDTH_BYTE</span><span class="p">,</span>
	<span class="n">MSP_DATA_TRANSFER_WIDTH_HALFWORD</span><span class="p">,</span>
	<span class="n">MSP_DATA_TRANSFER_WIDTH_WORD</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_frame_sync</span> <span class="p">{</span>
	<span class="n">MSP_FSYNC_UNIGNORE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_FSYNC_IGNORE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_phase2_start_mode</span> <span class="p">{</span>
	<span class="n">MSP_PHASE2_START_MODE_IMEDIATE</span><span class="p">,</span>
	<span class="n">MSP_PHASE2_START_MODE_FSYNC</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_btf</span> <span class="p">{</span>
	<span class="n">MSP_BTF_MS_BIT_FIRST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_BTF_LS_BIT_FIRST</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_fsync_pol</span> <span class="p">{</span>
	<span class="n">MSP_FSYNC_POL_ACT_HI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_FSYNC_POL_ACT_LO</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cm">/* Data delay (in bit clock cycles) */</span>
<span class="k">enum</span> <span class="n">msp_delay</span> <span class="p">{</span>
	<span class="n">MSP_DELAY_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_DELAY_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MSP_DELAY_2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">MSP_DELAY_3</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="cm">/* Configurations of clocks (transmit, receive or sample rate generator) */</span>
<span class="k">enum</span> <span class="n">msp_edge</span> <span class="p">{</span>
	<span class="n">MSP_FALLING_EDGE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_RISING_EDGE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_hws</span> <span class="p">{</span>
	<span class="n">MSP_SWAP_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_SWAP_BYTE_PER_WORD</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MSP_SWAP_BYTE_PER_HALF_WORD</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">MSP_SWAP_HALF_WORD_PER_WORD</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_compress_mode</span> <span class="p">{</span>
	<span class="n">MSP_COMPRESS_MODE_LINEAR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_COMPRESS_MODE_MU_LAW</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">MSP_COMPRESS_MODE_A_LAW</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_spi_burst_mode</span> <span class="p">{</span>
	<span class="n">MSP_SPI_BURST_MODE_DISABLE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_SPI_BURST_MODE_ENABLE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_expand_mode</span> <span class="p">{</span>
	<span class="n">MSP_EXPAND_MODE_LINEAR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_EXPAND_MODE_LINEAR_SIGNED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MSP_EXPAND_MODE_MU_LAW</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">MSP_EXPAND_MODE_A_LAW</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="cp">#define MSP_FRAME_PERIOD_IN_MONO_MODE 256</span>
<span class="cp">#define MSP_FRAME_PERIOD_IN_STEREO_MODE 32</span>
<span class="cp">#define MSP_FRAME_WIDTH_IN_STEREO_MODE 16</span>

<span class="k">enum</span> <span class="n">msp_protocol</span> <span class="p">{</span>
	<span class="n">MSP_I2S_PROTOCOL</span><span class="p">,</span>
	<span class="n">MSP_PCM_PROTOCOL</span><span class="p">,</span>
	<span class="n">MSP_PCM_COMPAND_PROTOCOL</span><span class="p">,</span>
	<span class="n">MSP_INVALID_PROTOCOL</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * No of registers to backup during</span>
<span class="cm"> * suspend resume</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_MSP_BACKUP_REGS 36</span>

<span class="k">enum</span> <span class="n">enum_i2s_controller</span> <span class="p">{</span>
	<span class="n">MSP_0_I2S_CONTROLLER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_1_I2S_CONTROLLER</span><span class="p">,</span>
	<span class="n">MSP_2_I2S_CONTROLLER</span><span class="p">,</span>
	<span class="n">MSP_3_I2S_CONTROLLER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">i2s_direction_t</span> <span class="p">{</span>
	<span class="n">MSP_DIR_TX</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">MSP_DIR_RX</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_data_size</span> <span class="p">{</span>
	<span class="n">MSP_DATA_BITS_DEFAULT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">MSP_DATA_BITS_8</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">MSP_DATA_BITS_10</span><span class="p">,</span>
	<span class="n">MSP_DATA_BITS_12</span><span class="p">,</span>
	<span class="n">MSP_DATA_BITS_14</span><span class="p">,</span>
	<span class="n">MSP_DATA_BITS_16</span><span class="p">,</span>
	<span class="n">MSP_DATA_BITS_20</span><span class="p">,</span>
	<span class="n">MSP_DATA_BITS_24</span><span class="p">,</span>
	<span class="n">MSP_DATA_BITS_32</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_state</span> <span class="p">{</span>
	<span class="n">MSP_STATE_IDLE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_STATE_CONFIGURED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MSP_STATE_RUNNING</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">msp_rx_comparison_enable_mode</span> <span class="p">{</span>
	<span class="n">MSP_COMPARISON_DISABLED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MSP_COMPARISON_NONEQUAL_ENABLED</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">MSP_COMPARISON_EQUAL_ENABLED</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">msp_multichannel_config</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">rx_multichannel_enable</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_multichannel_enable</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">msp_rx_comparison_enable_mode</span> <span class="n">rx_comparison_enable_mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">comparison_value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">comparison_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_channel_0_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_channel_1_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_channel_2_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_channel_3_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_channel_0_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_channel_1_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_channel_2_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_channel_3_enable</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">msp_protdesc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">rx_phase_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_phase_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_phase2_start_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_phase2_start_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_byte_order</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_byte_order</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_frame_len_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_frame_len_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_frame_len_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_frame_len_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_elem_len_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_elem_len_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_elem_len_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_elem_len_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_data_delay</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_data_delay</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_clk_pol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_clk_pol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_fsync_pol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_fsync_pol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_half_word_swap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_half_word_swap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">compression_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">expansion_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frame_sync_ignore</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frame_period</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frame_width</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clocks_per_frame</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2s_message</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">i2s_direction_t</span> <span class="n">i2s_direction</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">txdata</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rxdata</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">txbytes</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rxbytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_offset</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cyclic_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">buf_addr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">period_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2s_controller</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">class</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2s_algorithm</span> <span class="o">*</span><span class="n">algo</span><span class="p">;</span> <span class="cm">/* the algorithm to access the bus */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">bus_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="n">dev</span><span class="p">;</span> <span class="cm">/* the controller device */</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ux500_msp_config</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f_inputclk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_clk_sel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_clk_sel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">srg_clk_sel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_fsync_pol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_fsync_pol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_fsync_sel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_fsync_sel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_fifo_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_fifo_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spi_clk_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spi_burst_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loopback_enable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_data_enable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">default_protdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msp_protdesc</span> <span class="n">protdesc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">multichannel_configured</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msp_multichannel_config</span> <span class="n">multichannel_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_size</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">msp_data_size</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">def_elem_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iodelay</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tx_callback_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rx_callback_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ux500_msp</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">enum_i2s_controller</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">registers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2s_controller</span> <span class="o">*</span><span class="n">i2s_cont</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">dma_cfg_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">dma_cfg_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">tx_pipeid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">rx_pipeid</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">msp_state</span> <span class="n">msp_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">transfer</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2s_message</span> <span class="o">*</span><span class="n">message</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">plat_init</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">plat_exit</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">notify_timer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">def_elem_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir_busy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loopback_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">backup_regs</span><span class="p">[</span><span class="n">MAX_MSP_BACKUP_REGS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f_bitclk</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ux500_msp_dma_params</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">dma_cfg</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">ux500_msp_i2s_init_msp</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">**</span><span class="n">msp_p</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">msp_i2s_platform_data</span> <span class="o">*</span><span class="n">platform_data</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ux500_msp_i2s_cleanup_msp</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ux500_msp_i2s_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ux500_msp_config</span> <span class="o">*</span><span class="n">config</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ux500_msp_i2s_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ux500_msp_i2s_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">direction</span><span class="p">);</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
/span> <span class="o">+</span> <span class="n">MSP_RCE0</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">mcfg</span><span class="o">-&gt;</span><span class="n">rx_channel_1_enable</span><span class="p">,</span>
					<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCE1</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">mcfg</span><span class="o">-&gt;</span><span class="n">rx_channel_2_enable</span><span class="p">,</span>
					<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCE2</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">mcfg</span><span class="o">-&gt;</span><span class="n">rx_channel_3_enable</span><span class="p">,</span>
					<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCE3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: ERROR: Only single-phase supported (RX-mode: %d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">protdesc</span><span class="o">-&gt;</span><span class="n">rx_phase_mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcfg</span><span class="o">-&gt;</span><span class="n">rx_comparison_enable_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_val_MCR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_MCR</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_MCR</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">mcfg</span><span class="o">-&gt;</span><span class="n">rx_comparison_enable_mode</span> <span class="o">&lt;&lt;</span> <span class="n">RCMPM_BIT</span><span class="p">),</span>
				<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_MCR</span><span class="p">);</span>

			<span class="n">writel</span><span class="p">(</span><span class="n">mcfg</span><span class="o">-&gt;</span><span class="n">comparison_mask</span><span class="p">,</span>
					<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCM</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">mcfg</span><span class="o">-&gt;</span><span class="n">comparison_value</span><span class="p">,</span>
					<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCV</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_msp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ux500_msp_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_val_DMACR</span><span class="p">,</span> <span class="n">reg_val_GCR</span><span class="p">;</span>

	<span class="cm">/* Check msp state whether in RUN or CONFIGURED Mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">msp_state</span> <span class="o">==</span> <span class="n">MSP_STATE_IDLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">plat_init</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">plat_init</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ERROR: Failed to init MSP (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Configure msp with protocol dependent settings */</span>
	<span class="n">configure_protocol</span><span class="p">(</span><span class="n">msp</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="n">setup_bitclk</span><span class="p">(</span><span class="n">msp</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">multichannel_configured</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">configure_multichannel</span><span class="p">(</span><span class="n">msp</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: WARN: configure_multichannel failed (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure the correct DMA-directions are configured */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">&amp;</span> <span class="n">MSP_DIR_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dma_cfg_rx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ERROR: MSP RX-mode is not configured!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">MSP_DIR_TX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dma_cfg_tx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ERROR: MSP TX-mode is not configured!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg_val_DMACR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_DMACR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">&amp;</span> <span class="n">MSP_DIR_RX</span><span class="p">)</span>
		<span class="n">reg_val_DMACR</span> <span class="o">|=</span> <span class="n">RX_DMA_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">&amp;</span> <span class="n">MSP_DIR_TX</span><span class="p">)</span>
		<span class="n">reg_val_DMACR</span> <span class="o">|=</span> <span class="n">TX_DMA_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_DMACR</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_DMACR</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">iodelay</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_IODLY</span><span class="p">);</span>

	<span class="cm">/* Enable frame generation logic */</span>
	<span class="n">reg_val_GCR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_GCR</span> <span class="o">|</span> <span class="n">FRAME_GEN_ENABLE</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_fifo_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val_DR</span><span class="p">,</span> <span class="n">reg_val_GCR</span><span class="p">,</span> <span class="n">reg_val_FLR</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">reg_val_GCR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_GCR</span> <span class="o">|</span> <span class="n">RX_ENABLE</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>

	<span class="n">reg_val_FLR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_FLR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg_val_FLR</span> <span class="o">&amp;</span> <span class="n">RX_FIFO_EMPTY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_val_DR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_DR</span><span class="p">);</span>
		<span class="n">reg_val_FLR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_FLR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_GCR</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_fifo_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val_TSTDR</span><span class="p">,</span> <span class="n">reg_val_GCR</span><span class="p">,</span> <span class="n">reg_val_FLR</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">reg_val_GCR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_GCR</span> <span class="o">|</span> <span class="n">TX_ENABLE</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MSP_ITCR_ITEN</span> <span class="o">|</span> <span class="n">MSP_ITCR_TESTFIFO</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_ITCR</span><span class="p">);</span>

	<span class="n">reg_val_FLR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_FLR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg_val_FLR</span> <span class="o">&amp;</span> <span class="n">TX_FIFO_EMPTY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_val_TSTDR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_TSTDR</span><span class="p">);</span>
		<span class="n">reg_val_FLR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_FLR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_ITCR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_GCR</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ux500_msp_i2s_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ux500_msp_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">old_reg</span><span class="p">,</span> <span class="n">new_reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_sel</span><span class="p">,</span> <span class="n">rx_sel</span><span class="p">,</span> <span class="n">tx_busy</span><span class="p">,</span> <span class="n">rx_busy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: ERROR: Open called in interrupt context!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">&amp;</span> <span class="n">MSP_DIR_TX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">&amp;</span> <span class="n">MSP_DIR_RX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_sel</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rx_sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Error: No direction selected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_busy</span> <span class="o">=</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dir_busy</span> <span class="o">&amp;</span> <span class="n">MSP_DIR_TX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_busy</span> <span class="o">=</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dir_busy</span> <span class="o">&amp;</span> <span class="n">MSP_DIR_RX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_busy</span> <span class="o">&amp;&amp;</span> <span class="n">tx_sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Error: TX is in use!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_busy</span> <span class="o">&amp;&amp;</span> <span class="n">rx_sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Error: RX is in use!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">dir_busy</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tx_sel</span> <span class="o">?</span> <span class="n">MSP_DIR_TX</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rx_sel</span> <span class="o">?</span> <span class="n">MSP_DIR_RX</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* First do the global config register */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">RX_CLK_SEL_MASK</span> <span class="o">|</span> <span class="n">TX_CLK_SEL_MASK</span> <span class="o">|</span> <span class="n">RX_FSYNC_MASK</span> <span class="o">|</span>
	    <span class="n">TX_FSYNC_MASK</span> <span class="o">|</span> <span class="n">RX_SYNC_SEL_MASK</span> <span class="o">|</span> <span class="n">TX_SYNC_SEL_MASK</span> <span class="o">|</span>
	    <span class="n">RX_FIFO_ENABLE_MASK</span> <span class="o">|</span> <span class="n">TX_FIFO_ENABLE_MASK</span> <span class="o">|</span> <span class="n">SRG_CLK_SEL_MASK</span> <span class="o">|</span>
	    <span class="n">LOOPBACK_MASK</span> <span class="o">|</span> <span class="n">TX_EXTRA_DELAY_MASK</span><span class="p">;</span>

	<span class="n">new_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_clk_sel</span> <span class="o">|</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_clk_sel</span> <span class="o">|</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_fsync_pol</span> <span class="o">|</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fsync_pol</span> <span class="o">|</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_fsync_sel</span> <span class="o">|</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fsync_sel</span> <span class="o">|</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_fifo_config</span> <span class="o">|</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_config</span> <span class="o">|</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">srg_clk_sel</span> <span class="o">|</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">loopback_enable</span> <span class="o">|</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_data_enable</span><span class="p">);</span>

	<span class="n">old_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">old_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">new_reg</span> <span class="o">|=</span> <span class="n">old_reg</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">new_reg</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">enable_msp</span><span class="p">(</span><span class="n">msp</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ERROR: enable_msp failed (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">loopback_enable</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">loopback_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Flush FIFOs */</span>
	<span class="n">flush_fifo_tx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>
	<span class="n">flush_fifo_rx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">msp_state</span> <span class="o">=</span> <span class="n">MSP_STATE_CONFIGURED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_msp_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val_GCR</span><span class="p">,</span> <span class="n">reg_val_DMACR</span><span class="p">,</span> <span class="n">reg_val_IMSC</span><span class="p">;</span>

	<span class="n">reg_val_GCR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_GCR</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RX_ENABLE</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">reg_val_DMACR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_DMACR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_DMACR</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RX_DMA_ENABLE</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_DMACR</span><span class="p">);</span>
	<span class="n">reg_val_IMSC</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_IMSC</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_IMSC</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">RX_SERVICE_INT</span> <span class="o">|</span> <span class="n">RX_OVERRUN_ERROR_INT</span><span class="p">),</span>
			<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_IMSC</span><span class="p">);</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">dir_busy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSP_DIR_RX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_msp_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val_GCR</span><span class="p">,</span> <span class="n">reg_val_DMACR</span><span class="p">,</span> <span class="n">reg_val_IMSC</span><span class="p">;</span>

	<span class="n">reg_val_GCR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_GCR</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TX_ENABLE</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">reg_val_DMACR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_DMACR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_DMACR</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TX_DMA_ENABLE</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_DMACR</span><span class="p">);</span>
	<span class="n">reg_val_IMSC</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_IMSC</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_IMSC</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">TX_SERVICE_INT</span> <span class="o">|</span> <span class="n">TX_UNDERRUN_ERR_INT</span><span class="p">),</span>
			<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_IMSC</span><span class="p">);</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">dir_busy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSP_DIR_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">disable_msp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val_GCR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">disable_tx</span><span class="p">,</span> <span class="n">disable_rx</span><span class="p">;</span>

	<span class="n">reg_val_GCR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
	<span class="n">disable_tx</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">&amp;</span> <span class="n">MSP_DIR_TX</span><span class="p">;</span>
	<span class="n">disable_rx</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">&amp;</span> <span class="n">MSP_DIR_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable_tx</span> <span class="o">&amp;&amp;</span> <span class="n">disable_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_val_GCR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_GCR</span> <span class="o">|</span> <span class="n">LOOPBACK_MASK</span><span class="p">,</span>
				<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>

		<span class="cm">/* Flush TX-FIFO */</span>
		<span class="n">flush_fifo_tx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>

		<span class="cm">/* Disable TX-channel */</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">)</span> <span class="o">&amp;</span>
			       <span class="p">(</span><span class="o">~</span><span class="n">TX_ENABLE</span><span class="p">)),</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>

		<span class="cm">/* Flush RX-FIFO */</span>
		<span class="n">flush_fifo_rx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>

		<span class="cm">/* Disable Loopback and Receive channel */</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">RX_ENABLE</span> <span class="o">|</span> <span class="n">LOOPBACK_MASK</span><span class="p">))),</span>
				<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>

		<span class="n">disable_msp_tx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>
		<span class="n">disable_msp_rx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disable_tx</span><span class="p">)</span>
		<span class="n">disable_msp_tx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disable_rx</span><span class="p">)</span>
		<span class="n">disable_msp_rx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ux500_msp_i2s_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val_GCR</span><span class="p">,</span> <span class="n">enable_bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">msp_state</span> <span class="o">==</span> <span class="n">MSP_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ERROR: MSP is not configured!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
			<span class="n">enable_bit</span> <span class="o">=</span> <span class="n">TX_ENABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">enable_bit</span> <span class="o">=</span> <span class="n">RX_ENABLE</span><span class="p">;</span>
		<span class="n">reg_val_GCR</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_val_GCR</span> <span class="o">|</span> <span class="n">enable_bit</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
			<span class="n">disable_msp_tx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">disable_msp_rx</span><span class="p">(</span><span class="n">msp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ux500_msp_i2s_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Enter (dir = 0x%01x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">disable_msp</span><span class="p">(</span><span class="n">msp</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dir_busy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable sample rate and frame generators */</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">msp_state</span> <span class="o">=</span> <span class="n">MSP_STATE_IDLE</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">)</span> <span class="o">&amp;</span>
			       <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FRAME_GEN_ENABLE</span> <span class="o">|</span> <span class="n">SRG_ENABLE</span><span class="p">))),</span>
			      <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">plat_exit</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">plat_exit</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: WARN: ux500_msp_i2s_exit failed (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_GCR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_TCF</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCF</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_DMACR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_SRG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_MCR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCM</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCV</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_TCE0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_TCE1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_TCE2</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_TCE3</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCE0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCE1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCE2</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">+</span> <span class="n">MSP_RCE3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ux500_msp_i2s_init_msp</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">**</span><span class="n">msp_p</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">msp_i2s_platform_data</span> <span class="o">*</span><span class="n">platform_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2s_controller</span> <span class="o">*</span><span class="n">i2s_cont</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Enter (name: %s, id: %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="o">*</span><span class="n">msp_p</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_msp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">msp</span> <span class="o">=</span> <span class="o">*</span><span class="n">msp_p</span><span class="p">;</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">plat_init</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">msp_i2s_init</span><span class="p">;</span>
	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">plat_exit</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">msp_i2s_exit</span><span class="p">;</span>
	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">dma_cfg_rx</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">msp_i2s_dma_rx</span><span class="p">;</span>
	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">dma_cfg_tx</span> <span class="o">=</span> <span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">msp_i2s_dma_tx</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ERROR: Unable to get resource!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ERROR: ioremap failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">msp_state</span> <span class="o">=</span> <span class="n">MSP_STATE_IDLE</span><span class="p">;</span>
	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">loopback_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* I2S-controller is allocated and added in I2S controller class. */</span>
	<span class="n">i2s_cont</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">i2s_cont</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2s_cont</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: ERROR: Failed to allocate I2S-controller!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_i2s_cont</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i2s_cont</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">i2s_cont</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">msp</span><span class="p">;</span>
	<span class="n">i2s_cont</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">i2s_cont</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i2s_cont</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;ux500-msp-i2s.%04x&quot;</span><span class="p">,</span>
		<span class="n">msp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;I2S device-name: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2s_cont</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">msp</span><span class="o">-&gt;</span><span class="n">i2s_cont</span> <span class="o">=</span> <span class="n">i2s_cont</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_i2s_cont:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">);</span>

<span class="nl">err_res:</span>
	<span class="n">devm_kfree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">msp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ux500_msp_i2s_cleanup_msp</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ux500_msp</span> <span class="o">*</span><span class="n">msp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Enter (id = %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">i2s_cont</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">devm_kfree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">msp</span><span class="o">-&gt;</span><span class="n">i2s_cont</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">msp</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">);</span>

	<span class="n">devm_kfree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">msp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPLv2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
