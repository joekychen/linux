<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › samsung › neo1973_wm8753.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>neo1973_wm8753.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * neo1973_wm8753.c  --  SoC audio for Openmoko Neo1973 and Freerunner devices</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2007 Openmoko Inc</span>
<span class="cm"> * Author: Graeme Gregory &lt;graeme@openmoko.org&gt;</span>
<span class="cm"> * Copyright 2007 Wolfson Microelectronics PLC.</span>
<span class="cm"> * Author: Graeme Gregory</span>
<span class="cm"> *         graeme.gregory@wolfsonmicro.com or linux@wolfsonmicro.com</span>
<span class="cm"> * Copyright 2009 Wolfson Microelectronics</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> *  under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>

<span class="cp">#include &lt;sound/soc.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;plat/regs-iis.h&gt;</span>
<span class="cp">#include &lt;mach/gta02.h&gt;</span>

<span class="cp">#include &quot;../codecs/wm8753.h&quot;</span>
<span class="cp">#include &quot;s3c24xx-i2s.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">neo1973_hifi_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pll_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iis_clkrate</span><span class="p">;</span>

	<span class="n">iis_clkrate</span> <span class="o">=</span> <span class="n">s3c24xx_i2s_get_clockrate</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8000</span>:
	<span class="k">case</span> <span class="mi">16000</span>:
		<span class="n">pll_out</span> <span class="o">=</span> <span class="mi">12288000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">bclk</span> <span class="o">=</span> <span class="n">WM8753_BCLK_DIV_4</span><span class="p">;</span>
		<span class="n">pll_out</span> <span class="o">=</span> <span class="mi">12288000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>:
		<span class="n">bclk</span> <span class="o">=</span> <span class="n">WM8753_BCLK_DIV_2</span><span class="p">;</span>
		<span class="n">pll_out</span> <span class="o">=</span> <span class="mi">12288000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11025</span>:
		<span class="n">bclk</span> <span class="o">=</span> <span class="n">WM8753_BCLK_DIV_16</span><span class="p">;</span>
		<span class="n">pll_out</span> <span class="o">=</span> <span class="mi">11289600</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">22050</span>:
		<span class="n">bclk</span> <span class="o">=</span> <span class="n">WM8753_BCLK_DIV_8</span><span class="p">;</span>
		<span class="n">pll_out</span> <span class="o">=</span> <span class="mi">11289600</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">bclk</span> <span class="o">=</span> <span class="n">WM8753_BCLK_DIV_4</span><span class="p">;</span>
		<span class="n">pll_out</span> <span class="o">=</span> <span class="mi">11289600</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">88200</span>:
		<span class="n">bclk</span> <span class="o">=</span> <span class="n">WM8753_BCLK_DIV_2</span><span class="p">;</span>
		<span class="n">pll_out</span> <span class="o">=</span> <span class="mi">11289600</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set codec DAI configuration */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_fmt</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span>
		<span class="n">SND_SOC_DAIFMT_I2S</span> <span class="o">|</span> <span class="n">SND_SOC_DAIFMT_NB_NF</span> <span class="o">|</span>
		<span class="n">SND_SOC_DAIFMT_CBM_CFM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set cpu DAI configuration */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_fmt</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">,</span>
		<span class="n">SND_SOC_DAIFMT_I2S</span> <span class="o">|</span> <span class="n">SND_SOC_DAIFMT_NB_NF</span> <span class="o">|</span>
		<span class="n">SND_SOC_DAIFMT_CBM_CFM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set the codec system clock for DAC and ADC */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_sysclk</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">WM8753_MCLK</span><span class="p">,</span> <span class="n">pll_out</span><span class="p">,</span>
		<span class="n">SND_SOC_CLOCK_IN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set MCLK division for sample rate */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_clkdiv</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="n">S3C24XX_DIV_MCLK</span><span class="p">,</span>
		<span class="n">S3C2410_IISMOD_32FS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set codec BCLK division for sample rate */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_clkdiv</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">WM8753_BCLKDIV</span><span class="p">,</span> <span class="n">bclk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set prescaler division for sample rate */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_clkdiv</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="n">S3C24XX_DIV_PRESCALER</span><span class="p">,</span>
		<span class="n">S3C24XX_PRESCALE</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* codec PLL input is PCLK/4 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_pll</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">WM8753_PLL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">iis_clkrate</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pll_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">neo1973_hifi_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>

	<span class="cm">/* disable the PLL */</span>
	<span class="k">return</span> <span class="n">snd_soc_dai_set_pll</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">WM8753_PLL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Neo1973 WM8753 HiFi DAI opserations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_ops</span> <span class="n">neo1973_hifi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">neo1973_hifi_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">neo1973_hifi_hw_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">neo1973_voice_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pcmdiv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iis_clkrate</span><span class="p">;</span>

	<span class="n">iis_clkrate</span> <span class="o">=</span> <span class="n">s3c24xx_i2s_get_clockrate</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pcmdiv</span> <span class="o">=</span> <span class="n">WM8753_PCM_DIV_6</span><span class="p">;</span> <span class="cm">/* 2.048 MHz */</span>

	<span class="cm">/* todo: gg check mode (DSP_B) against CSR datasheet */</span>
	<span class="cm">/* set codec DAI configuration */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_fmt</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">SND_SOC_DAIFMT_DSP_B</span> <span class="o">|</span>
		<span class="n">SND_SOC_DAIFMT_NB_NF</span> <span class="o">|</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set the codec system clock for DAC and ADC */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_sysclk</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">WM8753_PCMCLK</span><span class="p">,</span> <span class="mi">12288000</span><span class="p">,</span>
		<span class="n">SND_SOC_CLOCK_IN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set codec PCM division for sample rate */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_clkdiv</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">WM8753_PCMDIV</span><span class="p">,</span> <span class="n">pcmdiv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* configure and enable PLL for 12.288MHz output */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_pll</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">WM8753_PLL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">iis_clkrate</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12288000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">neo1973_voice_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>

	<span class="cm">/* disable the PLL */</span>
	<span class="k">return</span> <span class="n">snd_soc_dai_set_pll</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">WM8753_PLL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_ops</span> <span class="n">neo1973_voice_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">neo1973_voice_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">neo1973_voice_hw_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Shared routes and controls */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">neo1973_wm8753_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_SOC_DAPM_LINE</span><span class="p">(</span><span class="s">&quot;GSM Line Out&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_LINE</span><span class="p">(</span><span class="s">&quot;GSM Line In&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIC</span><span class="p">(</span><span class="s">&quot;Headset Mic&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIC</span><span class="p">(</span><span class="s">&quot;Handset Mic&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">neo1973_wm8753_routes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Connections to the GSM Module */</span>
	<span class="p">{</span><span class="s">&quot;GSM Line Out&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;MONO1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;GSM Line Out&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;MONO2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;RXP&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;GSM Line In&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;RXN&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;GSM Line In&quot;</span><span class="p">},</span>

	<span class="cm">/* Connections to Headset */</span>
	<span class="p">{</span><span class="s">&quot;MIC1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Mic Bias&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Mic Bias&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Headset Mic&quot;</span><span class="p">},</span>

	<span class="cm">/* Call Mic */</span>
	<span class="p">{</span><span class="s">&quot;MIC2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Mic Bias&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MIC2N&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Mic Bias&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Mic Bias&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Handset Mic&quot;</span><span class="p">},</span>

	<span class="cm">/* Connect the ALC pins */</span>
	<span class="p">{</span><span class="s">&quot;ACIN&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ACOP&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">neo1973_wm8753_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_PIN_SWITCH</span><span class="p">(</span><span class="s">&quot;GSM Line Out&quot;</span><span class="p">),</span>
	<span class="n">SOC_DAPM_PIN_SWITCH</span><span class="p">(</span><span class="s">&quot;GSM Line In&quot;</span><span class="p">),</span>
	<span class="n">SOC_DAPM_PIN_SWITCH</span><span class="p">(</span><span class="s">&quot;Headset Mic&quot;</span><span class="p">),</span>
	<span class="n">SOC_DAPM_PIN_SWITCH</span><span class="p">(</span><span class="s">&quot;Handset Mic&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* GTA02 specific routes and controls */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gta02_speaker_enabled</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm4853_set_spk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gta02_speaker_enabled</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GTA02_GPIO_HP_IN</span><span class="p">,</span> <span class="o">!</span><span class="n">gta02_speaker_enabled</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm4853_get_spk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gta02_speaker_enabled</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm4853_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GTA02_GPIO_AMP_SHUT</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_EVENT_OFF</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">neo1973_gta02_routes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Connections to the amp */</span>
	<span class="p">{</span><span class="s">&quot;Stereo Out&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;LOUT1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Stereo Out&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ROUT1&quot;</span><span class="p">},</span>

	<span class="cm">/* Call Speaker */</span>
	<span class="p">{</span><span class="s">&quot;Handset Spk&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;LOUT2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Handset Spk&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ROUT2&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">neo1973_gta02_wm8753_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_PIN_SWITCH</span><span class="p">(</span><span class="s">&quot;Handset Spk&quot;</span><span class="p">),</span>
	<span class="n">SOC_DAPM_PIN_SWITCH</span><span class="p">(</span><span class="s">&quot;Stereo Out&quot;</span><span class="p">),</span>

	<span class="n">SOC_SINGLE_BOOL_EXT</span><span class="p">(</span><span class="s">&quot;Amp Spk Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">lm4853_get_spk</span><span class="p">,</span>
		<span class="n">lm4853_set_spk</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">neo1973_gta02_wm8753_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_SOC_DAPM_SPK</span><span class="p">(</span><span class="s">&quot;Handset Spk&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SPK</span><span class="p">(</span><span class="s">&quot;Stereo Out&quot;</span><span class="p">,</span> <span class="n">lm4853_event</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">neo1973_gta02_wm8753_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">neo1973_gta02_wm8753_dapm_widgets</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_gta02_wm8753_dapm_widgets</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">neo1973_gta02_routes</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_gta02_routes</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_add_card_controls</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">neo1973_gta02_wm8753_controls</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_gta02_wm8753_controls</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Stereo Out&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Handset Spk&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_ignore_suspend</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Stereo Out&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_ignore_suspend</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Handset Spk&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">neo1973_wm8753_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set up NC codec pins */</span>
	<span class="n">snd_soc_dapm_nc_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;OUT3&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_nc_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;OUT4&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_nc_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;LINE1&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_nc_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;LINE2&quot;</span><span class="p">);</span>

	<span class="cm">/* Add neo1973 specific widgets */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">neo1973_wm8753_dapm_widgets</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_wm8753_dapm_widgets</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* add neo1973 specific controls */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_add_card_controls</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">neo1973_wm8753_controls</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_wm8753_controls</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set up neo1973 specific audio routes */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">neo1973_wm8753_routes</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_wm8753_routes</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set endpoints to default off mode */</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;GSM Line Out&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;GSM Line In&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Headset Mic&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Handset Mic&quot;</span><span class="p">);</span>

	<span class="cm">/* allow audio paths from the GSM modem to run during suspend */</span>
	<span class="n">snd_soc_dapm_ignore_suspend</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;GSM Line Out&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_ignore_suspend</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;GSM Line In&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_ignore_suspend</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Headset Mic&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_ignore_suspend</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Handset Mic&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_neo1973_gta02</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">neo1973_gta02_wm8753_init</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_link</span> <span class="n">neo1973_dai</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="cm">/* Hifi Playback - for similatious use with voice below */</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;WM8753&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;WM8753 HiFi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform_name</span> <span class="o">=</span> <span class="s">&quot;samsung-audio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_dai_name</span> <span class="o">=</span> <span class="s">&quot;s3c24xx-iis&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_dai_name</span> <span class="o">=</span> <span class="s">&quot;wm8753-hifi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_name</span> <span class="o">=</span> <span class="s">&quot;wm8753.0-001a&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">neo1973_wm8753_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">neo1973_hifi_ops</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span> <span class="cm">/* Voice via BT */</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Bluetooth&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_dai_name</span> <span class="o">=</span> <span class="s">&quot;dfbmcs320-pcm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_dai_name</span> <span class="o">=</span> <span class="s">&quot;wm8753-voice&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_name</span> <span class="o">=</span> <span class="s">&quot;wm8753.0-001a&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">neo1973_voice_ops</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_aux_dev</span> <span class="n">neo1973_aux_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dfbmcs320&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">codec_name</span> <span class="o">=</span> <span class="s">&quot;dfbmcs320.0&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_codec_conf</span> <span class="n">neo1973_codec_conf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="s">&quot;lm4857.0-007c&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name_prefix</span> <span class="o">=</span> <span class="s">&quot;Amp&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gpio</span> <span class="n">neo1973_gta02_gpios</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">GTA02_GPIO_HP_IN</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_HIGH</span><span class="p">,</span> <span class="s">&quot;GTA02_HP_IN&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GTA02_GPIO_AMP_SHUT</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_HIGH</span><span class="p">,</span> <span class="s">&quot;GTA02_AMP_SHUT&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="n">neo1973</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;neo1973&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_link</span> <span class="o">=</span> <span class="n">neo1973_dai</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_links</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_dai</span><span class="p">),</span>
	<span class="p">.</span><span class="n">aux_dev</span> <span class="o">=</span> <span class="n">neo1973_aux_devs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_aux_devs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_aux_devs</span><span class="p">),</span>
	<span class="p">.</span><span class="n">codec_conf</span> <span class="o">=</span> <span class="n">neo1973_codec_conf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_configs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_codec_conf</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">neo1973_snd_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">neo1973_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is_neo1973_gta02</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_neo1973_gta02</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">neo1973</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;neo1973gta02&quot;</span><span class="p">;</span>
		<span class="n">neo1973</span><span class="p">.</span><span class="n">num_aux_devs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request_array</span><span class="p">(</span><span class="n">neo1973_gta02_gpios</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_gta02_gpios</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">neo1973_snd_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;soc-audio&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">neo1973_snd_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_gpio_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">neo1973_snd_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">neo1973</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">neo1973_snd_device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_device</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_put_device:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">neo1973_snd_device</span><span class="p">);</span>
<span class="nl">err_gpio_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_neo1973_gta02</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">gpio_free_array</span><span class="p">(</span><span class="n">neo1973_gta02_gpios</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_gta02_gpios</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">neo1973_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">neo1973_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">neo1973_snd_device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_neo1973_gta02</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">gpio_free_array</span><span class="p">(</span><span class="n">neo1973_gta02_gpios</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">neo1973_gta02_gpios</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">neo1973_exit</span><span class="p">);</span>

<span class="cm">/* Module information */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Graeme Gregory, graeme@openmoko.org, www.openmoko.org&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ALSA SoC WM8753 Neo1973 and Frerunner&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
