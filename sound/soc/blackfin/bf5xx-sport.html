<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › blackfin › bf5xx-sport.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bf5xx-sport.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * File:         bf5xx_sport.c</span>
<span class="cm"> * Based on:</span>
<span class="cm"> * Author:       Roy Huang &lt;roy.huang@analog.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Created:      Tue Sep 21 10:52:42 CEST 2004</span>
<span class="cm"> * Description:</span>
<span class="cm"> *               Blackfin SPORT Driver</span>
<span class="cm"> *</span>
<span class="cm"> *               Copyright 2004-2007 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Bugs:         Enter bugs at http://blackfin.uclinux.org/</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, see the file COPYING, or write</span>
<span class="cm"> * to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/portmux.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/blackfin.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>

<span class="cp">#include &quot;bf5xx-sport.h&quot;</span>
<span class="cm">/* delay between frame sync pulse and first data bit in multichannel mode */</span>
<span class="cp">#define FRAME_DELAY (1&lt;&lt;12)</span>

<span class="cm">/* note: multichannel is in units of 8 channels,</span>
<span class="cm"> * tdm_count is # channels NOT / 8 ! */</span>
<span class="kt">int</span> <span class="nf">sport_set_multichannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">tdm_count</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">packed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s tdm_count=%d mask:0x%08x packed=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">tdm_count</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">packed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr1</span> <span class="o">&amp;</span> <span class="n">TSPEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rcr1</span> <span class="o">&amp;</span> <span class="n">RSPEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tdm_count</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tdm_count</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* Only support less than 32 channels now */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tdm_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcmc1</span> <span class="o">=</span> <span class="p">((</span><span class="n">tdm_count</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcmc2</span> <span class="o">=</span> <span class="n">FRAME_DELAY</span> <span class="o">|</span> <span class="n">MCMEN</span> <span class="o">|</span> \
				<span class="p">(</span><span class="n">packed</span> <span class="o">?</span> <span class="p">(</span><span class="n">MCDTXPE</span><span class="o">|</span><span class="n">MCDRXPE</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mtcs0</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mrcs0</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mtcs1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mrcs1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mtcs2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mrcs2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mtcs3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mrcs3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcmc1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcmc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mtcs0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mrcs0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mtcs1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mtcs2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mtcs3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mrcs1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mrcs2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mrcs3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_set_multichannel</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sport_config_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rcr1</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rcr2</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clkdiv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fsdiv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr1</span> <span class="o">&amp;</span> <span class="n">TSPEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rcr1</span> <span class="o">&amp;</span> <span class="n">RSPEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rcr1</span> <span class="o">=</span> <span class="n">rcr1</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rcr2</span> <span class="o">=</span> <span class="n">rcr2</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rclkdiv</span> <span class="o">=</span> <span class="n">clkdiv</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rfsdiv</span> <span class="o">=</span> <span class="n">fsdiv</span><span class="p">;</span>

	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_config_rx</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sport_config_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcr1</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcr2</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clkdiv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fsdiv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr1</span> <span class="o">&amp;</span> <span class="n">TSPEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rcr1</span> <span class="o">&amp;</span> <span class="n">RSPEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr1</span> <span class="o">=</span> <span class="n">tcr1</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr2</span> <span class="o">=</span> <span class="n">tcr2</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tclkdiv</span> <span class="o">=</span> <span class="n">clkdiv</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tfsdiv</span> <span class="o">=</span> <span class="n">fsdiv</span><span class="p">;</span>

	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_config_tx</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fragcount</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">fragsize</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x_count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ycount</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">wdsize</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fragcount</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_desc_addr</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">fragsize</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x_count</span> <span class="o">=</span> <span class="n">x_count</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x_modify</span> <span class="o">=</span> <span class="n">wdsize</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y_count</span> <span class="o">=</span> <span class="n">ycount</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y_modify</span> <span class="o">=</span> <span class="n">wdsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make circular */</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">fragcount</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;setup desc: desc0=%p, next0=%p, desc1=%p,&quot;</span>
		<span class="s">&quot;next1=%p</span><span class="se">\n</span><span class="s">x_count=%x,y_count=%x,addr=0x%lx,cfs=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">desc</span><span class="p">,</span> <span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">next_desc_addr</span><span class="p">,</span>
		<span class="n">desc</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">next_desc_addr</span><span class="p">,</span>
		<span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">x_count</span><span class="p">,</span> <span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">y_count</span><span class="p">,</span>
		<span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sport_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rcr1</span> <span class="o">|=</span> <span class="n">RSPEN</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr1</span> <span class="o">|=</span> <span class="n">TSPEN</span><span class="p">;</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sport_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSPEN</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rcr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RSPEN</span><span class="p">;</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="n">disable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sport_hook_rx_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmasg</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">temp_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span> <span class="o">==</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">);</span>

	<span class="cm">/* Maybe the dummy buffer descriptor ring is damaged */</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">get_dma_next_desc_ptr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
	<span class="cm">/* Copy the descriptor which will be damaged to backup */</span>
	<span class="n">temp_desc</span> <span class="o">=</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">x_count</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">y_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Waiting for dummy buffer descriptor is already hooked*/</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">get_dma_curr_desc_ptr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">))</span> <span class="o">!=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">)</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">;</span>
	<span class="cm">/* Restore the damaged descriptor */</span>
	<span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">temp_desc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sport_rx_dma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dummy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">;</span>

	<span class="n">set_dma_next_desc_addr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span><span class="p">);</span>
	<span class="n">set_dma_x_count</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_dma_x_modify</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_dma_config</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="p">(</span><span class="n">DMAFLOW_LARGE</span> <span class="o">|</span> <span class="n">NDSIZE_9</span> <span class="o">|</span> \
				<span class="n">WDSIZE_32</span> <span class="o">|</span> <span class="n">WNR</span><span class="p">));</span>
	<span class="n">set_dma_curr_addr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span><span class="o">-&gt;</span><span class="n">start_addr</span><span class="p">);</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sport_tx_dma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dummy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">;</span>

	<span class="n">set_dma_next_desc_addr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span><span class="p">);</span>
	<span class="n">set_dma_x_count</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_dma_x_modify</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_dma_config</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span>
			<span class="p">(</span><span class="n">DMAFLOW_LARGE</span> <span class="o">|</span> <span class="n">NDSIZE_9</span> <span class="o">|</span> <span class="n">WDSIZE_32</span><span class="p">));</span>
	<span class="n">set_dma_curr_addr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span><span class="o">-&gt;</span><span class="n">start_addr</span><span class="p">);</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sport_rx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* tx is running, rx is not running */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span> <span class="o">!=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">);</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">get_dma_curr_desc_ptr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">))</span> <span class="o">!=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sport_tx_dma_start</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sport_rx_dma_start</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sport_start</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_run</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_rx_start</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sport_rx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TX dma is still running, hook the dummy buffer */</span>
		<span class="n">sport_hook_rx_dummy</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Both rx and tx dma will be stopped */</span>
		<span class="n">sport_stop</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_rx_stop</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sport_hook_tx_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmasg</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">temp_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span> <span class="o">==</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">);</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Shorten the time on last normal descriptor */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">get_dma_next_desc_ptr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
	<span class="cm">/* Store the descriptor which will be damaged */</span>
	<span class="n">temp_desc</span> <span class="o">=</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">x_count</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">y_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Waiting for dummy buffer descriptor is already hooked*/</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">get_dma_curr_desc_ptr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">)</span> <span class="o">-</span> \
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">))</span> <span class="o">!=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">)</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">;</span>
	<span class="cm">/* Restore the damaged descriptor */</span>
	<span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">temp_desc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sport_tx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: tx_run:%d, rx_run:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_run</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_run</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span> <span class="o">!=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">);</span>
		<span class="cm">/* Hook the normal buffer descriptor */</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">get_dma_curr_desc_ptr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">))</span> <span class="o">!=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">sport_tx_dma_start</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* Let rx dma run the dummy buffer */</span>
		<span class="n">sport_rx_dma_start</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sport_start</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_run</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_tx_start</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sport_tx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RX is still running, hook the dummy buffer */</span>
		<span class="n">sport_hook_tx_dummy</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Both rx and tx dma stopped */</span>
		<span class="n">sport_stop</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_tx_stop</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">compute_wdsize</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">wdsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wdsize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">WDSIZE_8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">WDSIZE_16</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">WDSIZE_32</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sport_config_rx_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">fragcount</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">fragsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s buf:%p, frag:%d, fragsize:0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> \
			<span class="n">buf</span><span class="p">,</span> <span class="n">fragcount</span><span class="p">,</span> <span class="n">fragsize</span><span class="p">);</span>

	<span class="n">x_count</span> <span class="o">=</span> <span class="n">fragsize</span> <span class="o">/</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">;</span>
	<span class="n">y_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* for fragments larger than 64k words we use 2d dma,</span>
<span class="cm">	 * denote fragecount as two numbers&#39; mutliply and both of them</span>
<span class="cm">	 * are less than 64k.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x_count</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">x_count</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">x_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">y_count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">y_count</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s(x_count:0x%x, y_count:0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">x_count</span><span class="p">,</span> <span class="n">y_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_desc_bytes</span><span class="p">,</span>
					<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Allocate a new descritor ring as current one. */</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> \
			<span class="n">fragcount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_desc_bytes</span> <span class="o">=</span> <span class="n">fragcount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to allocate memory for rx desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_fragsize</span> <span class="o">=</span> <span class="n">fragsize</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_frags</span> <span class="o">=</span> <span class="n">fragcount</span><span class="p">;</span>

	<span class="n">cfg</span>     <span class="o">=</span> <span class="mh">0x7000</span> <span class="o">|</span> <span class="n">DI_EN</span> <span class="o">|</span> <span class="n">compute_wdsize</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">)</span> <span class="o">|</span> <span class="n">WNR</span> <span class="o">|</span> \
		  <span class="p">(</span><span class="n">DESC_ELEMENT_COUNT</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* large descriptor mode */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">DMA2D</span><span class="p">;</span>

	<span class="n">setup_desc</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fragcount</span><span class="p">,</span> <span class="n">fragsize</span><span class="p">,</span>
			<span class="n">cfg</span><span class="o">|</span><span class="n">DMAEN</span><span class="p">,</span> <span class="n">x_count</span><span class="p">,</span> <span class="n">y_count</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_config_rx_dma</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sport_config_tx_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> \
		<span class="kt">int</span> <span class="n">fragcount</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">fragsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s buf:%p, fragcount:%d, fragsize:0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fragcount</span><span class="p">,</span> <span class="n">fragsize</span><span class="p">);</span>

	<span class="n">x_count</span> <span class="o">=</span> <span class="n">fragsize</span><span class="o">/</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">;</span>
	<span class="n">y_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* for fragments larger than 64k words we use 2d dma,</span>
<span class="cm">	 * denote fragecount as two numbers&#39; mutliply and both of them</span>
<span class="cm">	 * are less than 64k.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x_count</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">x_count</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">x_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">y_count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">y_count</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s x_count:0x%x, y_count:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">x_count</span><span class="p">,</span> <span class="n">y_count</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_desc_bytes</span><span class="p">,</span> \
				<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> \
			<span class="n">fragcount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_desc_bytes</span> <span class="o">=</span> <span class="n">fragcount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to allocate memory for tx desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_fragsize</span> <span class="o">=</span> <span class="n">fragsize</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_frags</span> <span class="o">=</span> <span class="n">fragcount</span><span class="p">;</span>
	<span class="n">cfg</span>     <span class="o">=</span> <span class="mh">0x7000</span> <span class="o">|</span> <span class="n">DI_EN</span> <span class="o">|</span> <span class="n">compute_wdsize</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">)</span> <span class="o">|</span> \
		  <span class="p">(</span><span class="n">DESC_ELEMENT_COUNT</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* large descriptor mode */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">DMA2D</span><span class="p">;</span>

	<span class="n">setup_desc</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fragcount</span><span class="p">,</span> <span class="n">fragsize</span><span class="p">,</span>
			<span class="n">cfg</span><span class="o">|</span><span class="n">DMAEN</span><span class="p">,</span> <span class="n">x_count</span><span class="p">,</span> <span class="n">y_count</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_config_tx_dma</span><span class="p">);</span>

<span class="cm">/* setup dummy dma descriptor ring, which don&#39;t generate interrupts,</span>
<span class="cm"> * the x_modify is set to 0 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sport_config_rx_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmasg</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">config</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">L1_DATA_A_LENGTH</span><span class="p">)</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">l1_data_sram_zalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to allocate memory for dummy rx desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_buf</span><span class="p">;</span>
	<span class="n">config</span> <span class="o">=</span> <span class="n">DMAFLOW_LARGE</span> <span class="o">|</span> <span class="n">NDSIZE_9</span> <span class="o">|</span> <span class="n">compute_wdsize</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">)</span>
		 <span class="o">|</span> <span class="n">WNR</span> <span class="o">|</span> <span class="n">DMAEN</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">x_count</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_count</span><span class="o">/</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">x_modify</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">y_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">y_modify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">desc</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sport_config_tx_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmasg</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">L1_DATA_A_LENGTH</span><span class="p">)</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">l1_data_sram_zalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to allocate memory for dummy tx desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_buf</span> <span class="o">+</span> \
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_count</span><span class="p">;</span>
	<span class="n">config</span> <span class="o">=</span> <span class="n">DMAFLOW_LARGE</span> <span class="o">|</span> <span class="n">NDSIZE_9</span> <span class="o">|</span>
		 <span class="n">compute_wdsize</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">)</span> <span class="o">|</span> <span class="n">DMAEN</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">x_count</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_count</span><span class="o">/</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">x_modify</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">y_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">y_modify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">desc</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">next_desc_addr</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sport_curr_offset_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr</span> <span class="o">=</span> <span class="n">get_dma_curr_addr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">curr</span> <span class="o">-</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_curr_offset_rx</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sport_curr_offset_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr</span> <span class="o">=</span> <span class="n">get_dma_curr_addr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">curr</span> <span class="o">-</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_curr_offset_tx</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sport_incfrag</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">frag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">frag</span> <span class="o">==</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_frags</span><span class="p">)</span>
		<span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">frag</span> <span class="o">==</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_frags</span><span class="p">)</span>
		<span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_incfrag</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sport_decfrag</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">frag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">--</span><span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_frags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_frags</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_decfrag</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sport_check_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sport_stat</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rx_stat</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tx_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sport_stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SSYNC</span><span class="p">();</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TOVF</span><span class="o">|</span><span class="n">TUVF</span><span class="o">|</span><span class="n">ROVF</span><span class="o">|</span><span class="n">RUVF</span><span class="p">))</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TOVF</span><span class="o">|</span><span class="n">TUVF</span><span class="o">|</span><span class="n">ROVF</span><span class="o">|</span><span class="n">RUVF</span><span class="p">));</span>
		<span class="n">SSYNC</span><span class="p">();</span>
		<span class="o">*</span><span class="n">sport_stat</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SSYNC</span><span class="p">();</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">get_dma_curr_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMA_DONE</span><span class="o">|</span><span class="n">DMA_ERR</span><span class="p">))</span>
			<span class="n">clear_dma_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
		<span class="n">SSYNC</span><span class="p">();</span>
		<span class="o">*</span><span class="n">rx_stat</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SSYNC</span><span class="p">();</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">get_dma_curr_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMA_DONE</span><span class="o">|</span><span class="n">DMA_ERR</span><span class="p">))</span>
			<span class="n">clear_dma_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
		<span class="n">SSYNC</span><span class="p">();</span>
		<span class="o">*</span><span class="n">tx_stat</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>  <span class="nf">sport_dump_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;sts: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;rx dma %d sts: 0x%04x tx dma %d sts: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span>
			<span class="n">get_dma_curr_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">),</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span>
			<span class="n">get_dma_curr_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">));</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;curr_rx_desc:0x%p, curr_tx_desc:0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;dma_rx_desc:0x%p, dma_tx_desc:0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;dummy_rx_desc:0x%p, dummy_tx_desc:0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_rx_desc</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">curr_tx_desc</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">rx_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">sport_check_status</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_stat</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_stat</span> <span class="o">&amp;</span> <span class="n">DMA_DONE</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;rx dma is already stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_callback</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tx_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">sport_check_status</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_stat</span> <span class="o">&amp;</span> <span class="n">DMA_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;tx dma is already stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_callback</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">err_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport_check_status</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error checking status ??&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TOVF</span><span class="o">|</span><span class="n">TUVF</span><span class="o">|</span><span class="n">ROVF</span><span class="o">|</span><span class="n">RUVF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;sport status error:%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">status</span> <span class="o">&amp;</span> <span class="n">TOVF</span> <span class="o">?</span> <span class="s">&quot; TOVF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">status</span> <span class="o">&amp;</span> <span class="n">TUVF</span> <span class="o">?</span> <span class="s">&quot; TUVF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">status</span> <span class="o">&amp;</span> <span class="n">ROVF</span> <span class="o">?</span> <span class="s">&quot; ROVF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">status</span> <span class="o">&amp;</span> <span class="n">RUVF</span> <span class="o">?</span> <span class="s">&quot; RUVF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TOVF</span> <span class="o">||</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">TUVF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_run</span><span class="p">)</span>
				<span class="n">sport_tx_dma_start</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sport_tx_dma_start</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">enable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">disable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_run</span><span class="p">)</span>
				<span class="n">sport_rx_dma_start</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sport_rx_dma_start</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">enable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TOVF</span><span class="o">|</span><span class="n">TUVF</span><span class="o">|</span><span class="n">ROVF</span><span class="o">|</span><span class="n">RUVF</span><span class="p">))</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TOVF</span><span class="o">|</span><span class="n">TUVF</span><span class="o">|</span><span class="n">ROVF</span><span class="o">|</span><span class="n">RUVF</span><span class="p">));</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_callback</span><span class="p">)</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_callback</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sport_set_rx_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rx_callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rx_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rx_callback</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_callback</span> <span class="o">=</span> <span class="n">rx_callback</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_data</span> <span class="o">=</span> <span class="n">rx_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_set_rx_callback</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sport_set_tx_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">tx_callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tx_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tx_callback</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_callback</span> <span class="o">=</span> <span class="n">tx_callback</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_data</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_set_tx_callback</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sport_set_err_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">err_callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">err_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">err_callback</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_callback</span> <span class="o">=</span> <span class="n">err_callback</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_data</span> <span class="o">=</span> <span class="n">err_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_set_err_callback</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sport_config_pdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sport_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Extract settings from platform data */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfin_snd_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">pin_req</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">pin_req</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no MEM resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sport_register</span> <span class="o">*</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="cm">/* first RX, then TX */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no rx DMA resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no tx DMA resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no irq resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">err_irq</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="nf">sport_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wdsize</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dummy_count</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">priv_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sport_param</span> <span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">param</span><span class="p">.</span><span class="n">wdsize</span> <span class="o">=</span> <span class="n">wdsize</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">dummy_count</span> <span class="o">=</span> <span class="n">dummy_count</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">wdsize</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">param</span><span class="p">.</span><span class="n">dummy_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sport_config_pdev</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peripheral_request_list</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">pin_req</span><span class="p">,</span> <span class="s">&quot;soc-audio&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;requesting Peripherals failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sport</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sport</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate for sport device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__init_err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">dma_rx_chan</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">dma_tx_chan</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_irq</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">err_irq</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">pin_req</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">pin_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="s">&quot;SPORT RX Data&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request RX dma %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__init_err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_dma_callback</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="n">rx_handler</span><span class="p">,</span> <span class="n">sport</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request RX irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__init_err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="s">&quot;SPORT TX Data&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request TX dma %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__init_err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_dma_callback</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="n">tx_handler</span><span class="p">,</span> <span class="n">sport</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request TX irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__init_err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">,</span> <span class="n">err_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;SPORT err&quot;</span><span class="p">,</span>
			<span class="n">sport</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request err irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__init_err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma rx:%d tx:%d, err irq:%d, regs:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">wdsize</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">wdsize</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_count</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">dummy_count</span><span class="p">;</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">priv_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not alloc priv data %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__init_err4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">L1_DATA_A_LENGTH</span><span class="p">)</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_buf</span> <span class="o">=</span> <span class="n">l1_data_sram_zalloc</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">dummy_count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">dummy_count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate dummy buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__error1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sport_config_rx_dummy</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to config rx dummy ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__error2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sport_config_tx_dummy</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to config tx dummy ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__error3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sport</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sport</span><span class="p">;</span>
<span class="nl">__error3:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">L1_DATA_A_LENGTH</span><span class="p">)</span>
		<span class="n">l1_data_sram_free</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">),</span>
				<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">__error2:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">L1_DATA_A_LENGTH</span><span class="p">)</span>
		<span class="n">l1_data_sram_free</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_buf</span><span class="p">);</span>
<span class="nl">__error1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
<span class="nl">__init_err4:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">,</span> <span class="n">sport</span><span class="p">);</span>
<span class="nl">__init_err3:</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
<span class="nl">__init_err2:</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
<span class="nl">__init_err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
<span class="nl">__init_err0:</span>
	<span class="n">peripheral_free_list</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">pin_req</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sport_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sport_stop</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">rx_desc_bytes</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_desc_bytes</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#if L1_DATA_A_LENGTH != 0</span>
	<span class="n">l1_data_sram_free</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">);</span>
	<span class="n">l1_data_sram_free</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">);</span>
	<span class="n">l1_data_sram_free</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_buf</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">),</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_rx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmasg</span><span class="p">),</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_tx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dummy_buf</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">,</span> <span class="n">sport</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">peripheral_free_list</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">pin_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_done</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">* It is only used to send several bytes when dma is not enabled</span>
<span class="cm"> * sport controller is configured but not enabled.</span>
<span class="cm"> * Multichannel cannot works with pio mode */</span>
<span class="cm">/* Used by ac97 to write and read codec register */</span>
<span class="kt">int</span> <span class="nf">sport_send_and_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sport_device</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out_data</span><span class="p">,</span> \
		<span class="n">u8</span> <span class="o">*</span><span class="n">in_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dma_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s enter, out_data:%p, in_data:%p len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> \
			<span class="n">__func__</span><span class="p">,</span> <span class="n">out_data</span><span class="p">,</span> <span class="n">in_data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcr1:0x%04x, tcr2:0x%04x, tclkdiv:0x%04x, tfsdiv:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;mcmc1:0x%04x, mcmc2:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr1</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr2</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tclkdiv</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tfsdiv</span><span class="p">,</span>
			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcmc1</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcmc2</span><span class="p">);</span>
	<span class="n">flush_dcache_range</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">out_data</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">out_data</span> <span class="o">+</span> <span class="n">len</span><span class="p">));</span>

	<span class="cm">/* Enable tx dma */</span>
	<span class="n">dma_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">RESTART</span> <span class="o">|</span> <span class="n">WDSIZE_16</span> <span class="o">|</span> <span class="n">DI_EN</span><span class="p">);</span>
	<span class="n">set_dma_start_addr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">out_data</span><span class="p">);</span>
	<span class="n">set_dma_x_count</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="n">len</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">set_dma_x_modify</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">set_dma_config</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">,</span> <span class="n">dma_config</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">in_data</span><span class="p">,</span> \
				<span class="p">(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">in_data</span> <span class="o">+</span> <span class="n">len</span><span class="p">));</span>
		<span class="cm">/* Enable rx dma */</span>
		<span class="n">dma_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">RESTART</span> <span class="o">|</span> <span class="n">WDSIZE_16</span> <span class="o">|</span> <span class="n">WNR</span> <span class="o">|</span> <span class="n">DI_EN</span><span class="p">);</span>
		<span class="n">set_dma_start_addr</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">in_data</span><span class="p">);</span>
		<span class="n">set_dma_x_count</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="n">len</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">set_dma_x_modify</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">set_dma_config</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">,</span> <span class="n">dma_config</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr1</span> <span class="o">|=</span> <span class="n">TSPEN</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rcr1</span> <span class="o">|=</span> <span class="n">RSPEN</span><span class="p">;</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">get_dma_curr_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DMA_RUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">get_dma_curr_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;DMA status:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__over</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">;</span>
	<span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TXHRE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sport status:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__over</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Wait for the last byte sent out */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sport status:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

<span class="nl">__over:</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tcr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSPEN</span><span class="p">;</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rcr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RSPEN</span><span class="p">;</span>
	<span class="n">SSYNC</span><span class="p">();</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
	<span class="cm">/* Clear the status */</span>
	<span class="n">clear_dma_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_tx_chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
		<span class="n">clear_dma_irqstat</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">dma_rx_chan</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">SSYNC</span><span class="p">();</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sport_send_and_recv</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Roy Huang&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SPORT driver for ADI Blackfin&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
