<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › soc-pcm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>soc-pcm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * soc-pcm.c  --  ALSA SoC PCM</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005 Wolfson Microelectronics PLC.</span>
<span class="cm"> * Copyright 2005 Openedhand Ltd.</span>
<span class="cm"> * Copyright (C) 2010 Slimlogic Ltd.</span>
<span class="cm"> * Copyright (C) 2010 Texas Instruments Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Liam Girdwood &lt;lrg@ti.com&gt;</span>
<span class="cm"> *          Mark Brown &lt;broonie@opensource.wolfsonmicro.com&gt;       </span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> *  under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/soc-dpcm.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#define DPCM_MAX_BE_USERS	8</span>

<span class="cm">/* DPCM stream event, send event to FE and all active BEs. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_dapm_stream_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pm: BE %s event %d dir %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

		<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcm_apply_symmetry</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">soc_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">soc_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">symmetric_rates</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">symmetric_rates</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This can happen if multiple streams are starting simultaneously -</span>
<span class="cm">	 * the second can need to get its constraints before the first has</span>
<span class="cm">	 * picked a rate.  Complain and allow the application to carry on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">soc_dai</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">soc_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Not enforcing symmetric_rates due to race</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">soc_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Symmetry forces %dHz rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">soc_dai</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span>
					   <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
					   <span class="n">soc_dai</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="n">soc_dai</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">soc_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unable to apply rate symmetry constraint: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * List of sample sizes that might go over the bus for parameter</span>
<span class="cm"> * application.  There ought to be a wildcard sample size for things</span>
<span class="cm"> * like the DAC/ADC resolution to use but there isn&#39;t right now.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sample_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_pcm_apply_msb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">sig_bits</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">sig_bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bits</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;=</span> <span class="n">sample_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						   <span class="n">sample_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bits</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Failed to set MSB %d/%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">bits</span><span class="p">,</span> <span class="n">sample_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by ALSA when a PCM substream is opened, the runtime-&gt;hw record is</span>
<span class="cm"> * then initialized and any private data can be allocated. This also calls</span>
<span class="cm"> * startup for the cpu DAI, platform, machine and codec DAI.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">cpu_dai_drv</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">codec_dai_drv</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">,</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_subclass</span><span class="p">);</span>

	<span class="cm">/* startup the audio subsystem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">startup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">startup</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t open interface %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t open platform %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">platform_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">startup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">startup</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t open codec %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">codec_dai_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">startup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">startup</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: %s startup failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">machine_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Dynamic PCM DAI links compat checks use dynamic capabilities */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">dynamic</span> <span class="o">||</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">no_pcm</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">dynamic</span><span class="p">;</span>

	<span class="cm">/* Check that the codec and cpu DAIs are compatible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>
			<span class="n">max</span><span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rate_min</span><span class="p">,</span>
			    <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rate_min</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rate_max</span><span class="p">,</span>
			    <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rate_max</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>
			<span class="n">max</span><span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_min</span><span class="p">,</span>
				<span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_min</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_max</span><span class="p">,</span>
				<span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_max</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">=</span>
			<span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">formats</span> <span class="o">&amp;</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">formats</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span>
			<span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rates</span> <span class="o">&amp;</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rates</span>
			   <span class="o">&amp;</span> <span class="p">(</span><span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">))</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">|=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rates</span>
			   <span class="o">&amp;</span> <span class="p">(</span><span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">))</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">|=</span> <span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>
			<span class="n">max</span><span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rate_min</span><span class="p">,</span>
			    <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rate_min</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rate_max</span><span class="p">,</span>
			    <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rate_max</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>
			<span class="n">max</span><span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_min</span><span class="p">,</span>
				<span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_min</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_max</span><span class="p">,</span>
				<span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_max</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">=</span>
			<span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">formats</span> <span class="o">&amp;</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">formats</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span>
			<span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rates</span> <span class="o">&amp;</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rates</span>
			   <span class="o">&amp;</span> <span class="p">(</span><span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">))</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">|=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rates</span>
			   <span class="o">&amp;</span> <span class="p">(</span><span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">))</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">|=</span> <span class="n">codec_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">snd_pcm_limit_hw_rates</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;asoc: %s &lt;-&gt; %s No matching rates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">config_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;asoc: %s &lt;-&gt; %s No matching formats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">config_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">||</span> <span class="o">!</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">||</span>
	    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">&gt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;asoc: %s &lt;-&gt; %s No matching channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">config_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">soc_pcm_apply_msb</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>
	<span class="n">soc_pcm_apply_msb</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>

	<span class="cm">/* Symmetry only applies if we&#39;ve already got an active stream. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_apply_symmetry</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">config_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_apply_symmetry</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">config_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;asoc: %s &lt;-&gt; %s info:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;asoc: rate mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;asoc: min ch %d max ch %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span><span class="p">,</span>
		 <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;asoc: min rate %d max rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span><span class="p">,</span>
		 <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span><span class="p">);</span>

<span class="nl">dynamic:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">playback_active</span><span class="o">++</span><span class="p">;</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">playback_active</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">capture_active</span><span class="o">++</span><span class="p">;</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">capture_active</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">++</span><span class="p">;</span>
	<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">config_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

<span class="nl">machine_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>

<span class="nl">codec_dai_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)</span>
		<span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

<span class="nl">platform_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">);</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Power down the audio subsystem pmdown_time msecs after close is called.</span>
<span class="cm"> * This is to ensure there are no pops or clicks in between any music tracks</span>
<span class="cm"> * due to DAPM power cycling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_delayed_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span><span class="p">,</span> <span class="n">delayed_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">,</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_subclass</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pop wq checking: %s status: %s waiting: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">stream_name</span><span class="p">,</span>
		 <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">playback_active</span> <span class="o">?</span> <span class="s">&quot;active&quot;</span> <span class="o">:</span> <span class="s">&quot;inactive&quot;</span><span class="p">,</span>
		 <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">pop_wait</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="cm">/* are we waiting on this codec DAI stream */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">pop_wait</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">pop_wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="n">rtd</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
					  <span class="n">SND_SOC_DAPM_STREAM_STOP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by ALSA when a PCM substream is closed. Private data can be</span>
<span class="cm"> * freed here. The cpu DAI, codec DAI, machine and platform are also</span>
<span class="cm"> * shutdown.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">,</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_subclass</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">playback_active</span><span class="o">--</span><span class="p">;</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">playback_active</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">capture_active</span><span class="o">--</span><span class="p">;</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">capture_active</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">--</span><span class="p">;</span>
	<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">--</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* clear the corresponding DAIs rate when inactive */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Muting the DAC suppresses artifacts caused during digital</span>
<span class="cm">	 * shutdown, for example from stopping clocks.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">snd_soc_dai_digital_mute</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)</span>
		<span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">runtime</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pmdown_time</span> <span class="o">||</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">ignore_pmdown_time</span> <span class="o">||</span>
		    <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_pmdown_time</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* powered down playback stream now */</span>
			<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="n">rtd</span><span class="p">,</span>
						  <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
						  <span class="n">SND_SOC_DAPM_STREAM_STOP</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* start delayed pop wq here for playback streams */</span>
			<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">pop_wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pmdown_time</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* capture streams can be powered down now */</span>
		<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="n">rtd</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
					  <span class="n">SND_SOC_DAPM_STREAM_STOP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">);</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by ALSA when the PCM substream is prepared, can set format, sample</span>
<span class="cm"> * rate, etc.  This function is non atomic and can be called multiple times,</span>
<span class="cm"> * it can refer to the runtime info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">,</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_subclass</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: machine prepare error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform prepare error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DAI prepare error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DAI prepare error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* cancel any delayed stream shutdown that is pending */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">pop_wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">pop_wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="n">rtd</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_STREAM_START</span><span class="p">);</span>

	<span class="n">snd_soc_dai_digital_mute</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by ALSA when the hardware params are set by application. This</span>
<span class="cm"> * function can also be called multiple times and can allocate buffers</span>
<span class="cm"> * (using snd_pcm_lib_* ). It&#39;s non-atomic.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcm_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">,</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_subclass</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: machine hw_params failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t set %s hw params: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">codec_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s hw params failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">interface_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s hw params failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">platform_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* store the rate for each DAIs */</span>
	<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">platform_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">)</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>

<span class="nl">interface_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">)</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>

<span class="nl">codec_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">)</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Frees resources allocated by hw_params, can be called multiple times</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcm_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">,</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_subclass</span><span class="p">);</span>

	<span class="cm">/* apply codec digital mute */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">snd_soc_dai_digital_mute</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* free any machine hw params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">)</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="cm">/* free any DMA resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">)</span>
		<span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="cm">/* now free hw params for the DAIs  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">)</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">)</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcm_bespoke_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bespoke_trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bespoke_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">bespoke_trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">bespoke_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bespoke_trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bespoke_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * soc level wrapper for pointer callback</span>
<span class="cm"> * If cpu_dai, codec_dai, platform driver has the delay callback, than</span>
<span class="cm"> * the runtime-&gt;delay will be updated accordingly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">soc_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_pcm_uframes_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">)</span>
		<span class="n">delay</span> <span class="o">+=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">)</span>
		<span class="n">delay</span> <span class="o">+=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">)</span>
		<span class="n">delay</span> <span class="o">+=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">codec_dai</span><span class="p">);</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* connect a FE and BE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_be_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>

	<span class="cm">/* only add new dpcms */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span> <span class="o">==</span> <span class="n">be</span> <span class="o">&amp;&amp;</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">==</span> <span class="n">fe</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dpcm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dpcm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpcm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span> <span class="o">=</span> <span class="n">be</span><span class="p">;</span>
	<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">fe</span><span class="p">;</span>
	<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_LINK_STATE_NEW</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">list_be</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">list_fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">fe_clients</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  connected new DPCM %s path %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span>  <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;&lt;-&quot;</span> <span class="o">:</span> <span class="s">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">debugfs_state</span> <span class="o">=</span> <span class="n">debugfs_create_u32</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">debugfs_dpcm_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* reparent a BE onto another FE */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpcm_be_reparent</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">fe_substream</span><span class="p">,</span> <span class="o">*</span><span class="n">be_substream</span><span class="p">;</span>

	<span class="cm">/* reparent if BE is connected to other FEs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">be_substream</span> <span class="o">=</span> <span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">fe_clients</span><span class="p">,</span> <span class="n">list_fe</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">==</span> <span class="n">fe</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  reparent %s path %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span>
			<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;&lt;-&quot;</span> <span class="o">:</span> <span class="s">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">fe_substream</span> <span class="o">=</span> <span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
		<span class="n">be_substream</span><span class="o">-&gt;</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* disconnect a BE and FE */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpcm_be_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BE %s disconnect check for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span>
				<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_LINK_STATE_FREE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  freed DSP %s path %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;&lt;-&quot;</span> <span class="o">:</span> <span class="s">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="cm">/* BEs still alive need new FE */</span>
		<span class="n">dpcm_be_reparent</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">debugfs_state</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">list_be</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">list_fe</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dpcm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* get BE for DAI widget and stream */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="nf">dpcm_get_be</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">be</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">no_pcm</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span> <span class="o">==</span> <span class="n">widget</span> <span class="o">||</span>
				<span class="n">be</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span> <span class="o">==</span> <span class="n">widget</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">be</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">be</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">no_pcm</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span> <span class="o">==</span> <span class="n">widget</span> <span class="o">||</span>
				<span class="n">be</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span> <span class="o">==</span> <span class="n">widget</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">be</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get %s BE for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span>
	<span class="nf">rtd_get_cpu_widget</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span>
	<span class="nf">rtd_get_codec_widget</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">widget_in_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span> <span class="o">==</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_path_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">stream</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">**</span><span class="n">list_</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">paths</span><span class="p">;</span>

	<span class="n">list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* get number of valid DAI paths and their widgets */</span>
	<span class="n">paths</span> <span class="o">=</span> <span class="n">snd_soc_dapm_dai_get_connected_widgets</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found %d audio %s paths</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">list_</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">paths</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dpcm_path_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_prune_paths</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">**</span><span class="n">list_</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="o">*</span><span class="n">list_</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prune</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Destroy any old FE &lt;--&gt; BE connections */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* is there a valid CPU DAI widget for this BE */</span>
		<span class="n">widget</span> <span class="o">=</span> <span class="n">rtd_get_cpu_widget</span><span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="cm">/* prune the BE if it&#39;s no longer in our active list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span> <span class="o">&amp;&amp;</span> <span class="n">widget_in_list</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">widget</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* is there a valid CODEC DAI widget for this BE */</span>
		<span class="n">widget</span> <span class="o">=</span> <span class="n">rtd_get_codec_widget</span><span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="cm">/* prune the BE if it&#39;s no longer in our active list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span> <span class="o">&amp;&amp;</span> <span class="n">widget_in_list</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">widget</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pruning %s BE %s for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span>
			<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_LINK_STATE_FREE</span><span class="p">;</span>
		<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_BE</span><span class="p">;</span>
		<span class="n">prune</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found %d old BE paths for pruning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prune</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">prune</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_add_paths</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">**</span><span class="n">list_</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="o">*</span><span class="n">list_</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Create any new FE &lt;--&gt; BE connections */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_dai</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* is there a valid BE rtd for this widget */</span>
		<span class="n">be</span> <span class="o">=</span> <span class="n">dpcm_get_be</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no BE found for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">list</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* make sure BE is a real BE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">no_pcm</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* don&#39;t connect if FE is not running */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* newly connected FE and BE */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dpcm_be_connect</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t connect %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">list</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* already connected */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* new */</span>
		<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_BE</span><span class="p">;</span>
		<span class="n">new</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found %d new BE paths</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find the corresponding BE DAIs that source or sink audio to this</span>
<span class="cm"> * FE substream.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_process_paths</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">stream</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dpcm_add_paths</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dpcm_prune_paths</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpcm_clear_pending_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span>
		<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span>
						<span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpcm_be_dai_startup_unwind</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>

	<span class="cm">/* disable any enabled and non active backends */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">be_substream</span> <span class="o">=</span>
			<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no users %s at close - state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span>
				<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_OPEN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">soc_pcm_close</span><span class="p">(</span><span class="n">be_substream</span><span class="p">);</span>
		<span class="n">be_substream</span><span class="o">-&gt;</span><span class="n">runtime</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_CLOSE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_be_dai_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* only startup BE DAIs that are either sinks or sources to this FE DAI */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">be_substream</span> <span class="o">=</span>
			<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="cm">/* is this op for this BE ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_be_can_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* first time the dpcm is open ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span> <span class="o">==</span> <span class="n">DPCM_MAX_BE_USERS</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;too many users %s at open %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span>
				<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span><span class="o">++</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_NEW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_CLOSE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: open BE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">be_substream</span><span class="o">-&gt;</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">soc_pcm_open</span><span class="p">(</span><span class="n">be_substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BE open failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no users %s at unwind %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span>
					<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">);</span>

			<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_CLOSE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_OPEN</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">unwind:</span>
	<span class="cm">/* disable any enabled and non active backends */</span>
	<span class="n">list_for_each_entry_continue_reverse</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">be_substream</span> <span class="o">=</span>
			<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_be_can_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no users %s at close %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span>
				<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_OPEN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">soc_pcm_close</span><span class="p">(</span><span class="n">be_substream</span><span class="p">);</span>
		<span class="n">be_substream</span><span class="o">-&gt;</span><span class="n">runtime</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_CLOSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpcm_set_fe_runtime</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">cpu_dai_drv</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rate_min</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rate_max</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_min</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_max</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">&amp;=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">formats</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rate_min</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rate_max</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_min</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_max</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">&amp;=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">formats</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">cpu_dai_drv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_fe_dai_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">fe_substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_FE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_be_dai_startup</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: failed to start some BEs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">be_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: open FE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* start the DAI frontend */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_open</span><span class="p">(</span><span class="n">fe_substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: failed to start FE %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_OPEN</span><span class="p">;</span>

	<span class="n">dpcm_set_fe_runtime</span><span class="p">(</span><span class="n">fe_substream</span><span class="p">);</span>
	<span class="n">snd_pcm_limit_hw_rates</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unwind:</span>
	<span class="n">dpcm_be_dai_startup_unwind</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
<span class="nl">be_err:</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_be_dai_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>

	<span class="cm">/* only shutdown BEs that are either sinks or sources to this FE DAI */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">be_substream</span> <span class="o">=</span>
			<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="cm">/* is this op for this BE ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_be_can_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no users %s at close - state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span>
				<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">users</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_HW_FREE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_OPEN</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: close BE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">soc_pcm_close</span><span class="p">(</span><span class="n">be_substream</span><span class="p">);</span>
		<span class="n">be_substream</span><span class="o">-&gt;</span><span class="n">runtime</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_CLOSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_fe_dai_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_FE</span><span class="p">;</span>

	<span class="cm">/* shutdown the BEs */</span>
	<span class="n">dpcm_be_dai_shutdown</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: close FE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* now shutdown the frontend */</span>
	<span class="n">soc_pcm_close</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="cm">/* run the stream event for each BE */</span>
	<span class="n">dpcm_dapm_stream_event</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_STREAM_STOP</span><span class="p">);</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_CLOSE</span><span class="p">;</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_be_dai_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>

	<span class="cm">/* only hw_params backends that are either sinks or sources</span>
<span class="cm">	 * to this frontend DAI */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">be_substream</span> <span class="o">=</span>
			<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="cm">/* is this op for this BE ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_be_can_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* only free hw when no longer used - check all FEs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_can_be_free_stop</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_PREPARE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_HW_FREE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: hw_free BE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">soc_pcm_hw_free</span><span class="p">(</span><span class="n">be_substream</span><span class="p">);</span>

		<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_HW_FREE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_fe_dai_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="n">SND_SOC_CARD_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_FE</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: hw_free FE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* call hw_free on the frontend */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">soc_pcm_hw_free</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: hw_free FE %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* only hw_params backends that are either sinks or sources</span>
<span class="cm">	 * to this frontend DAI */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dpcm_be_dai_hw_free</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_HW_FREE</span><span class="p">;</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_be_dai_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">be_substream</span> <span class="o">=</span>
			<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="cm">/* is this op for this BE ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_be_can_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* only allow hw_params() if no connected FEs are running */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_can_be_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_OPEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_HW_FREE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: hw_params BE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="cm">/* copy params for each dpcm */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">hw_params</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span><span class="p">));</span>

		<span class="cm">/* perform any hw_params fixups */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">be_hw_params_fixup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">be_hw_params_fixup</span><span class="p">(</span><span class="n">be</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;dpcm: hw_params BE fixup failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_hw_params</span><span class="p">(</span><span class="n">be_substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;dpcm: hw_params BE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unwind:</span>
	<span class="cm">/* disable any enabled and non active backends */</span>
	<span class="n">list_for_each_entry_continue_reverse</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">be_substream</span> <span class="o">=</span>
			<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_be_can_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* only allow hw_free() if no connected FEs are running */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_can_be_free_stop</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_OPEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_HW_FREE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">soc_pcm_hw_free</span><span class="p">(</span><span class="n">be_substream</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_fe_dai_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="n">SND_SOC_CARD_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_FE</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">].</span><span class="n">hw_params</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_be_dai_hw_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: hw_params BE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: hw_params FE %s rate %d chan %x fmt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
			<span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="cm">/* call hw_params on the frontend */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_hw_params</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: hw_params FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">dpcm_be_dai_hw_free</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	 <span class="p">}</span> <span class="k">else</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_do_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: trigger BE %s cmd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: trigger BE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_be_dai_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">be_substream</span> <span class="o">=</span>
			<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="cm">/* is this op for this BE ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_be_can_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_PREPARE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_do_trigger</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="n">be_substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_START</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_SUSPEND</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_do_trigger</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="n">be_substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_START</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_PAUSED</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_do_trigger</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="n">be_substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_START</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_START</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_can_be_free_stop</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_do_trigger</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="n">be_substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_can_be_free_stop</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_do_trigger</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="n">be_substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_SUSPEND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_START</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_can_be_free_stop</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_do_trigger</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="n">be_substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_PAUSED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dpcm_be_dai_trigger</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_fe_dai_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">snd_soc_dpcm_trigger</span> <span class="n">trigger</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">[</span><span class="n">stream</span><span class="p">];</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_FE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">trigger</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_TRIGGER_PRE</span>:
		<span class="cm">/* call trigger on the frontend before the backend. */</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: pre trigger FE %s cmd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: trigger FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_be_dai_trigger</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_TRIGGER_POST</span>:
		<span class="cm">/* call trigger on the frontend after the backend. */</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_be_dai_trigger</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: trigger FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: post trigger FE %s cmd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_TRIGGER_BESPOKE</span>:
		<span class="cm">/* bespoke trigger() - handles both FE and BEs */</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: bespoke trigger FE %s cmd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_bespoke_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: trigger FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: invalid trigger cmd %d for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_START</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_be_dai_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">be_substream</span> <span class="o">=</span>
			<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

		<span class="cm">/* is this op for this BE ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dpcm_be_can_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: prepare BE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_prepare</span><span class="p">(</span><span class="n">be_substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: backend prepare failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_PREPARE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_fe_dai_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="n">SND_SOC_CARD_CLASS_RUNTIME</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: prepare FE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_FE</span><span class="p">;</span>

	<span class="cm">/* there is no point preparing this FE if there are no BEs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: no backend DAIs enabled for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_be_dai_prepare</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* call prepare on the frontend */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: prepare FE %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* run the stream event for each BE */</span>
	<span class="n">dpcm_dapm_stream_event</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_STREAM_START</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_STATE_PREPARE</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcm_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_run_update_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span>
		<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">snd_soc_dpcm_trigger</span> <span class="n">trigger</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">[</span><span class="n">stream</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;runtime %s close on FE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_TRIGGER_BESPOKE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* call bespoke trigger - FE takes care of all BE triggers */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: bespoke trigger FE %s cmd stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">soc_pcm_bespoke_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: trigger FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: trigger FE %s cmd stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">dpcm_be_dai_trigger</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: trigger FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dpcm_be_dai_hw_free</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: hw_free FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dpcm_be_dai_shutdown</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: shutdown FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="cm">/* run the stream event for each BE */</span>
	<span class="n">dpcm_dapm_stream_event</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_STREAM_NOP</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_run_update_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span>
		<span class="n">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">snd_soc_dpcm_trigger</span> <span class="n">trigger</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">[</span><span class="n">stream</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;runtime %s open on FE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Only start the BE if the FE is ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_HW_FREE</span> <span class="o">||</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_CLOSE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* startup must always be called for new BEs */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_be_dai_startup</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* keep going if FE state is &gt; open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_OPEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_be_dai_hw_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">close</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* keep going if FE state is &gt; hw_params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_be_dai_prepare</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">hw_free</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* run the stream event for each BE */</span>
	<span class="n">dpcm_dapm_stream_event</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_STREAM_NOP</span><span class="p">);</span>

	<span class="cm">/* keep going if FE state is &gt; prepare */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_PREPARE</span> <span class="o">||</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_TRIGGER_BESPOKE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* call trigger on the frontend - FE takes care of all BE triggers */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: bespoke trigger FE %s cmd start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcm_bespoke_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: bespoke trigger FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">hw_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dpcm: trigger FE %s cmd start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_be_dai_trigger</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span>
					<span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;dpcm: trigger FE failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">hw_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">hw_free:</span>
	<span class="n">dpcm_be_dai_hw_free</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
<span class="nl">close:</span>
	<span class="n">dpcm_be_dai_shutdown</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
<span class="nl">disconnect:</span>
	<span class="cm">/* disconnect any non started BEs */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SND_SOC_DPCM_STATE_START</span><span class="p">)</span>
				<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_LINK_STATE_FREE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_run_new_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_BE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_run_update_startup</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to startup some BEs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_run_old_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_BE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_run_update_shutdown</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to shutdown some BEs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_UPDATE_NO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called by DAPM mixer/mux changes to update audio routing between PCMs and</span>
<span class="cm"> * any DAI links.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">soc_dpcm_runtime_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">paths</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">)</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="n">SND_SOC_CARD_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* make sure link is FE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* only check active links */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* DAPM sync will call this to update DSP paths */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DPCM runtime update for FE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="cm">/* skip if FE doesn&#39;t have playback capability */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_min</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">capture</span><span class="p">;</span>

		<span class="n">paths</span> <span class="o">=</span> <span class="n">dpcm_path_get</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">paths</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s no valid %s path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>  <span class="s">&quot;playback&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">paths</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* update any new playback paths */</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">dpcm_process_paths</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dpcm_run_new_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">);</span>
			<span class="n">dpcm_clear_pending_state</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">);</span>
			<span class="n">dpcm_be_disconnect</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* update any old playback paths */</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">dpcm_process_paths</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dpcm_run_old_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">);</span>
			<span class="n">dpcm_clear_pending_state</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">);</span>
			<span class="n">dpcm_be_disconnect</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">);</span>
		<span class="p">}</span>

<span class="nl">capture:</span>
		<span class="cm">/* skip if FE doesn&#39;t have capture capability */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_min</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">paths</span> <span class="o">=</span> <span class="n">dpcm_path_get</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">paths</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s no valid %s path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>  <span class="s">&quot;capture&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">paths</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* update any new capture paths */</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">dpcm_process_paths</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dpcm_run_new_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">);</span>
			<span class="n">dpcm_clear_pending_state</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">);</span>
			<span class="n">dpcm_be_disconnect</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* update any old capture paths */</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">dpcm_process_paths</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dpcm_run_old_update</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">);</span>
			<span class="n">dpcm_clear_pending_state</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">);</span>
			<span class="n">dpcm_be_disconnect</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dpcm_path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">soc_dpcm_be_digital_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">clients</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">be_clients</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="n">clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span> <span class="o">=</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BE digital mute %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">digital_mute</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">playback_active</span><span class="p">)</span>
				<span class="n">drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">digital_mute</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">mute</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_fe_dai_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">fe_substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="n">SND_SOC_CARD_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpcm_path_get</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;asoc: %s no valid %s route</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;capture&quot;</span> <span class="o">:</span> <span class="s">&quot;playback&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* calculate valid and active FE &lt;-&gt; BE dpcms */</span>
	<span class="n">dpcm_process_paths</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_fe_dai_startup</span><span class="p">(</span><span class="n">fe_substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clean up all links */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span>
			<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_LINK_STATE_FREE</span><span class="p">;</span>

		<span class="n">dpcm_be_disconnect</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dpcm_clear_pending_state</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="n">dpcm_path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpcm_fe_dai_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">fe_substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">fe_substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="n">SND_SOC_CARD_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dpcm_fe_dai_shutdown</span><span class="p">(</span><span class="n">fe_substream</span><span class="p">);</span>

	<span class="cm">/* mark FE&#39;s links ready to prune */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span>
		<span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SND_SOC_DPCM_LINK_STATE_FREE</span><span class="p">;</span>

	<span class="n">dpcm_be_disconnect</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create a new pcm */</span>
<span class="kt">int</span> <span class="nf">soc_new_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">new_name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">playback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">capture</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">dynamic</span> <span class="o">||</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">no_pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_min</span><span class="p">)</span>
			<span class="n">playback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_min</span><span class="p">)</span>
			<span class="n">capture</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_min</span><span class="p">)</span>
			<span class="n">playback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_min</span><span class="p">)</span>
			<span class="n">capture</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create the PCM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">no_pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_name</span><span class="p">),</span> <span class="s">&quot;(%s)&quot;</span><span class="p">,</span>
			<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">stream_name</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_new_internal</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span>
				<span class="n">playback</span><span class="p">,</span> <span class="n">capture</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_name</span><span class="p">),</span> <span class="s">&quot;%s (*)&quot;</span><span class="p">,</span>
				<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">stream_name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_name</span><span class="p">),</span> <span class="s">&quot;%s %s-%d&quot;</span><span class="p">,</span>
				<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">playback</span><span class="p">,</span>
			<span class="n">capture</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;asoc: can&#39;t create pcm for codec %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registered pcm #%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">num</span><span class="p">,</span> <span class="n">new_name</span><span class="p">);</span>

	<span class="cm">/* DAPM dai link stream work */</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">,</span> <span class="n">close_delayed_work</span><span class="p">);</span>

	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">rtd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">no_pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">playback</span><span class="p">)</span>
			<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">rtd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capture</span><span class="p">)</span>
			<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">rtd</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ASoC PCM operations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dpcm_fe_dai_open</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">dpcm_fe_dai_hw_params</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span> <span class="n">dpcm_fe_dai_prepare</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">trigger</span>	<span class="o">=</span> <span class="n">dpcm_fe_dai_trigger</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">hw_free</span>	<span class="o">=</span> <span class="n">dpcm_fe_dai_hw_free</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">dpcm_fe_dai_close</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">pointer</span>	<span class="o">=</span> <span class="n">soc_pcm_pointer</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">soc_pcm_ioctl</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">soc_pcm_open</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">soc_pcm_hw_params</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span> <span class="n">soc_pcm_prepare</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">trigger</span>	<span class="o">=</span> <span class="n">soc_pcm_trigger</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">hw_free</span>	<span class="o">=</span> <span class="n">soc_pcm_hw_free</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">soc_pcm_close</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">pointer</span>	<span class="o">=</span> <span class="n">soc_pcm_pointer</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">soc_pcm_ioctl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ack</span>		<span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">copy</span>		<span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">copy</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">silence</span>	<span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">silence</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">page</span>		<span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">playback</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">capture</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pcm_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pcm_new</span><span class="p">(</span><span class="n">rtd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: platform pcm constructor failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pcm_free</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;asoc: %s &lt;-&gt; %s mapping ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* is the current PCM operation for this FE ? */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dpcm_fe_can_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_UPDATE_FE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dpcm_fe_can_update</span><span class="p">);</span>

<span class="cm">/* is the current PCM operation for this BE ? */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dpcm_be_can_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_UPDATE_FE</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">((</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_UPDATE_BE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">runtime_update</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dpcm_be_can_update</span><span class="p">);</span>

<span class="cm">/* get the substream for this BE */</span>
<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span>
	<span class="nf">snd_soc_dpcm_get_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">substream</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dpcm_get_substream</span><span class="p">);</span>

<span class="cm">/* get the BE runtime state */</span>
<span class="k">enum</span> <span class="n">snd_soc_dpcm_state</span>
	<span class="nf">snd_soc_dpcm_be_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dpcm_be_get_state</span><span class="p">);</span>

<span class="cm">/* set the BE runtime state */</span>
<span class="kt">void</span> <span class="nf">snd_soc_dpcm_be_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">stream</span><span class="p">,</span> <span class="k">enum</span> <span class="n">snd_soc_dpcm_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dpcm_be_set_state</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * We can only hw_free, stop, pause or suspend a BE DAI if any of it&#39;s FE</span>
<span class="cm"> * are not running, paused or suspended for the specified stream direction.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dpcm_can_be_free_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">fe_clients</span><span class="p">,</span> <span class="n">list_fe</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">==</span> <span class="n">fe</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">state</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_START</span> <span class="o">||</span>
			<span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_PAUSED</span> <span class="o">||</span>
			<span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_SUSPEND</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* it&#39;s safe to free/stop this BE DAI */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dpcm_can_be_free_stop</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * We can only change hw params a BE DAI if any of it&#39;s FE are not prepared,</span>
<span class="cm"> * running, paused or suspended for the specified stream direction.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dpcm_can_be_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">fe_clients</span><span class="p">,</span> <span class="n">list_fe</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">==</span> <span class="n">fe</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">state</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_START</span> <span class="o">||</span>
			<span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_PAUSED</span> <span class="o">||</span>
			<span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_SUSPEND</span> <span class="o">||</span>
			<span class="n">state</span> <span class="o">==</span> <span class="n">SND_SOC_DPCM_STATE_PREPARE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* it&#39;s safe to change hw_params */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dpcm_can_be_params</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">snd_soc_platform_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_platform_trigger</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dpcm_state_string</span><span class="p">(</span><span class="k">enum</span> <span class="n">snd_soc_dpcm_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_NEW</span>:
		<span class="k">return</span> <span class="s">&quot;new&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_OPEN</span>:
		<span class="k">return</span> <span class="s">&quot;open&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span>:
		<span class="k">return</span> <span class="s">&quot;hw_params&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_PREPARE</span>:
		<span class="k">return</span> <span class="s">&quot;prepare&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_START</span>:
		<span class="k">return</span> <span class="s">&quot;start&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span>:
		<span class="k">return</span> <span class="s">&quot;stop&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_SUSPEND</span>:
		<span class="k">return</span> <span class="s">&quot;suspend&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_PAUSED</span>:
		<span class="k">return</span> <span class="s">&quot;paused&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_HW_FREE</span>:
		<span class="k">return</span> <span class="s">&quot;hw_free&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DPCM_STATE_CLOSE</span>:
		<span class="k">return</span> <span class="s">&quot;close&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dpcm_show_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">stream</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">hw_params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dpcm</span> <span class="o">*</span><span class="n">dpcm</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* FE state */</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
			<span class="s">&quot;[%s - %s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">stream</span> <span class="o">?</span> <span class="s">&quot;Capture&quot;</span> <span class="o">:</span> <span class="s">&quot;Playback&quot;</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="s">&quot;State: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	                <span class="n">dpcm_state_string</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">&lt;=</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
				<span class="s">&quot;Hardware Params: &quot;</span>
				<span class="s">&quot;Format = %s, Channels = %d, Rate = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">snd_pcm_format_name</span><span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">)),</span>
				<span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
				<span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="cm">/* BEs state */</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="s">&quot;Backends:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
				<span class="s">&quot; No active DSP links</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dpcm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">be_clients</span><span class="p">,</span> <span class="n">list_be</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">;</span>
		<span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpcm</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
				<span class="s">&quot;- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
				<span class="s">&quot;   State: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dpcm_state_string</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">SND_SOC_DPCM_STATE_HW_PARAMS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">state</span> <span class="o">&lt;=</span> <span class="n">SND_SOC_DPCM_STATE_STOP</span><span class="p">))</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
				<span class="s">&quot;   Hardware Params: &quot;</span>
				<span class="s">&quot;Format = %s, Channels = %d, Rate = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">snd_pcm_format_name</span><span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">)),</span>
				<span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
				<span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dpcm_state_read_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">out_count</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">out_count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_min</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">dpcm_show_state</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
					<span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">out_count</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_min</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">dpcm_show_state</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
					<span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">out_count</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dpcm_state_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dpcm_state_read_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">soc_dpcm_debugfs_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">debugfs_dpcm_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_card_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">debugfs_dpcm_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;ASoC: Failed to create dpcm debugfs directory %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">debugfs_dpcm_state</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;state&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
						<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">debugfs_dpcm_root</span><span class="p">,</span>
						<span class="n">rtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpcm_state_fops</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
