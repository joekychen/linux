<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › omap › ams-delta.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ams-delta.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ams-delta.c  --  SoC audio for Amstrad E3 (Delta) videophone</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Janusz Krzysztofik &lt;jkrzyszt@tis.icnet.pl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Initially based on sound/soc/omap/osk5912.x</span>
<span class="cm"> * Copyright (C) 2008 Mistral Solutions</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/jack.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>

<span class="cp">#include &lt;plat/board-ams-delta.h&gt;</span>
<span class="cp">#include &lt;plat/mcbsp.h&gt;</span>

<span class="cp">#include &quot;omap-mcbsp.h&quot;</span>
<span class="cp">#include &quot;omap-pcm.h&quot;</span>
<span class="cp">#include &quot;../codecs/cx20442.h&quot;</span>


<span class="cm">/* Board specific DAPM widgets */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">ams_delta_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Handset */</span>
	<span class="n">SND_SOC_DAPM_MIC</span><span class="p">(</span><span class="s">&quot;Mouthpiece&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_HP</span><span class="p">(</span><span class="s">&quot;Earpiece&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="cm">/* Handsfree/Speakerphone */</span>
	<span class="n">SND_SOC_DAPM_MIC</span><span class="p">(</span><span class="s">&quot;Microphone&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SPK</span><span class="p">(</span><span class="s">&quot;Speaker&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* How they are connected to codec pins */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">ams_delta_audio_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;TELIN&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Mouthpiece&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Earpiece&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;TELOUT&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;MIC&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Microphone&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Speaker&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;SPKOUT&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Controls, functional after the modem line discipline is activated.</span>
<span class="cm"> */</span>

<span class="cm">/* Virtual switch: audio input/output constellations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ams_delta_audio_mode</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span><span class="s">&quot;Mixed&quot;</span><span class="p">,</span> <span class="s">&quot;Handset&quot;</span><span class="p">,</span> <span class="s">&quot;Handsfree&quot;</span><span class="p">,</span> <span class="s">&quot;Speakerphone&quot;</span><span class="p">};</span>

<span class="cm">/* Selection &lt;-&gt; pin translation */</span>
<span class="cp">#define AMS_DELTA_MOUTHPIECE	0</span>
<span class="cp">#define AMS_DELTA_EARPIECE	1</span>
<span class="cp">#define AMS_DELTA_MICROPHONE	2</span>
<span class="cp">#define AMS_DELTA_SPEAKER	3</span>
<span class="cp">#define AMS_DELTA_AGC		4</span>

<span class="cp">#define AMS_DELTA_MIXED		((1 &lt;&lt; AMS_DELTA_EARPIECE) | \</span>
<span class="cp">						(1 &lt;&lt; AMS_DELTA_MICROPHONE))</span>
<span class="cp">#define AMS_DELTA_HANDSET	((1 &lt;&lt; AMS_DELTA_MOUTHPIECE) | \</span>
<span class="cp">						(1 &lt;&lt; AMS_DELTA_EARPIECE))</span>
<span class="cp">#define AMS_DELTA_HANDSFREE	((1 &lt;&lt; AMS_DELTA_MICROPHONE) | \</span>
<span class="cp">						(1 &lt;&lt; AMS_DELTA_SPEAKER))</span>
<span class="cp">#define AMS_DELTA_SPEAKERPHONE	(AMS_DELTA_HANDSFREE | (1 &lt;&lt; AMS_DELTA_AGC))</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ams_delta_audio_mode_pins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AMS_DELTA_MIXED</span><span class="p">,</span>
	<span class="n">AMS_DELTA_HANDSET</span><span class="p">,</span>
	<span class="n">AMS_DELTA_HANDSFREE</span><span class="p">,</span>
	<span class="n">AMS_DELTA_SPEAKERPHONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ams_delta_audio_agc</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ams_delta_set_audio_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span>  <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pins</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Refuse any mode changes if we are not able to control the codec. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">hw_write</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EUNATCH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Translate selection to bitmap */</span>
	<span class="n">pins</span> <span class="o">=</span> <span class="n">ams_delta_audio_mode_pins</span><span class="p">[</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>

	<span class="cm">/* Setup pins after corresponding bits if changed */</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AMS_DELTA_MOUTHPIECE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Mouthpiece&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pin</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Mouthpiece&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Mouthpiece&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AMS_DELTA_EARPIECE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Earpiece&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pin</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Earpiece&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Earpiece&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AMS_DELTA_MICROPHONE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Microphone&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pin</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Microphone&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Microphone&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AMS_DELTA_SPEAKER</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Speaker&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pin</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Speaker&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Speaker&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AMS_DELTA_AGC</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">!=</span> <span class="n">ams_delta_audio_agc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ams_delta_audio_agc</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pin</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;AGCIN&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;AGCIN&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="n">dapm</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ams_delta_get_audio_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span>  <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pins</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">pins</span> <span class="o">=</span> <span class="p">((</span><span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Mouthpiece&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
							<span class="n">AMS_DELTA_MOUTHPIECE</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Earpiece&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
							<span class="n">AMS_DELTA_EARPIECE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span><span class="p">)</span>
		<span class="n">pins</span> <span class="o">|=</span> <span class="p">(</span><span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Microphone&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
							<span class="n">AMS_DELTA_MICROPHONE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pins</span> <span class="o">=</span> <span class="p">((</span><span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Microphone&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
							<span class="n">AMS_DELTA_MICROPHONE</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Speaker&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
							<span class="n">AMS_DELTA_SPEAKER</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">ams_delta_audio_agc</span> <span class="o">&lt;&lt;</span> <span class="n">AMS_DELTA_AGC</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ams_delta_audio_mode</span><span class="p">);</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">==</span> <span class="n">ams_delta_audio_mode_pins</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ams_delta_audio_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">ams_delta_audio_enum</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_ENUM_SINGLE_EXT</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ams_delta_audio_mode</span><span class="p">),</span>
						<span class="n">ams_delta_audio_mode</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">ams_delta_audio_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_ENUM_EXT</span><span class="p">(</span><span class="s">&quot;Audio Mode&quot;</span><span class="p">,</span> <span class="n">ams_delta_audio_enum</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ams_delta_get_audio_mode</span><span class="p">,</span> <span class="n">ams_delta_set_audio_mode</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Hook switch */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_jack</span> <span class="n">ams_delta_hook_switch</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_jack_gpio</span> <span class="n">ams_delta_hook_switch_gpios</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hook_switch&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">SND_JACK_HEADSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_time</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* After we are able to control the codec over the modem,</span>
<span class="cm"> * the hook switch can be used for dynamic DAPM reconfiguration. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_jack_pin</span> <span class="n">ams_delta_hook_switch_pins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Handset */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">pin</span> <span class="o">=</span> <span class="s">&quot;Mouthpiece&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">SND_JACK_MICROPHONE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">pin</span> <span class="o">=</span> <span class="s">&quot;Earpiece&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">SND_JACK_HEADPHONE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Handsfree */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">pin</span> <span class="o">=</span> <span class="s">&quot;Microphone&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">SND_JACK_MICROPHONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">pin</span> <span class="o">=</span> <span class="s">&quot;Speaker&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">SND_JACK_HEADPHONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Modem line discipline, required for making above controls functional.</span>
<span class="cm"> * Activated from userspace with ldattach, possibly invoked from udev rule.</span>
<span class="cm"> */</span>

<span class="cm">/* To actually apply any modem controlled configuration changes to the codec,</span>
<span class="cm"> * we must connect codec DAI pins to the modem for a moment.  Be careful not</span>
<span class="cm"> * to interfere with our digital mute function that shares the same hardware. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">cx81801_timer</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">cx81801_cmd_pending</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ams_delta_muted</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ams_delta_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx81801_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">muted</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_lock</span><span class="p">);</span>
	<span class="n">cx81801_cmd_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">muted</span> <span class="o">=</span> <span class="n">ams_delta_muted</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_lock</span><span class="p">);</span>

	<span class="cm">/* Reconnect the codec DAI back from the modem to the CPU DAI</span>
<span class="cm">	 * only if digital mute still off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">muted</span><span class="p">)</span>
		<span class="n">ams_delta_latch2_write</span><span class="p">(</span><span class="n">AMS_DELTA_LATCH2_MODEM_CODEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Used for passing a codec structure pointer</span>
<span class="cm"> * from the board initialization code to the tty line discipline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">cx20442_codec</span><span class="p">;</span>

<span class="cm">/* Line discipline .open() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx81801_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cx20442_codec</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pass the codec structure pointer for use by other ldisc callbacks,</span>
<span class="cm">	 * both the card and the codec specific parts.</span>
<span class="cm">	 */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="n">cx20442_codec</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v253_ops</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Line discipline .close() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx81801_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx81801_timer</span><span class="p">);</span>

	<span class="cm">/* Prevent the hook switch from further changing the DAPM pins */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_hook_switch</span><span class="p">.</span><span class="n">pins</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">v253_ops</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* Revert back to default audio input/output constellation */</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Mouthpiece&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Earpiece&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Microphone&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Speaker&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;AGCIN&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="n">dapm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Line discipline .hangup() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx81801_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cx81801_close</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Line discipline .receive_buf() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx81801_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">apply</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">hw_write</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First modem response, complete setup procedure */</span>

		<span class="cm">/* Initialize timer used for config pulse generation */</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx81801_timer</span><span class="p">,</span> <span class="n">cx81801_timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">v253_ops</span><span class="p">.</span><span class="n">receive_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="cm">/* Link hook switch to DAPM pins */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_jack_add_pins</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_hook_switch</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ams_delta_hook_switch_pins</span><span class="p">),</span>
					<span class="n">ams_delta_hook_switch_pins</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to link hook switch to DAPM pins, &quot;</span>
				<span class="s">&quot;will continue with hook switch unlinked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v253_ops</span><span class="p">.</span><span class="n">receive_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">cp</span><span class="p">;</span> <span class="n">c</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Complete modem response received, apply config to codec */</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_lock</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx81801_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">150</span><span class="p">));</span>
		<span class="n">apply</span> <span class="o">=</span> <span class="o">!</span><span class="n">ams_delta_muted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cx81801_cmd_pending</span><span class="p">;</span>
		<span class="n">cx81801_cmd_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_lock</span><span class="p">);</span>

		<span class="cm">/* Apply config pulse by connecting the codec to the modem</span>
<span class="cm">		 * if not already done */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">apply</span><span class="p">)</span>
			<span class="n">ams_delta_latch2_write</span><span class="p">(</span><span class="n">AMS_DELTA_LATCH2_MODEM_CODEC</span><span class="p">,</span>
						<span class="n">AMS_DELTA_LATCH2_MODEM_CODEC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Line discipline .write_wakeup() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx81801_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v253_ops</span><span class="p">.</span><span class="n">write_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_ldisc_ops</span> <span class="n">cx81801_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">TTY_LDISC_MAGIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cx81801&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">cx81801_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">cx81801_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">cx81801_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">receive_buf</span> <span class="o">=</span> <span class="n">cx81801_receive</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_wakeup</span> <span class="o">=</span> <span class="n">cx81801_wakeup</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Even if not very useful, the sound card can still work without any of the</span>
<span class="cm"> * above functonality activated.  You can still control its audio input/output</span>
<span class="cm"> * constellation and speakerphone gain from userspace by issuing AT commands</span>
<span class="cm"> * over the modem port.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ams_delta_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* Set cpu DAI configuration */</span>
	<span class="k">return</span> <span class="n">snd_soc_dai_set_fmt</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">,</span>
				   <span class="n">SND_SOC_DAIFMT_DSP_A</span> <span class="o">|</span>
				   <span class="n">SND_SOC_DAIFMT_NB_NF</span> <span class="o">|</span>
				   <span class="n">SND_SOC_DAIFMT_CBM_CFM</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_ops</span> <span class="n">ams_delta_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">ams_delta_hw_params</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* Digital mute implemented using modem/CPU multiplexer.</span>
<span class="cm"> * Shares hardware with codec config pulse generation */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ams_delta_muted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ams_delta_digital_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ams_delta_muted</span> <span class="o">==</span> <span class="n">mute</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_lock</span><span class="p">);</span>
	<span class="n">ams_delta_muted</span> <span class="o">=</span> <span class="n">mute</span><span class="p">;</span>
	<span class="n">apply</span> <span class="o">=</span> <span class="o">!</span><span class="n">cx81801_cmd_pending</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apply</span><span class="p">)</span>
		<span class="n">ams_delta_latch2_write</span><span class="p">(</span><span class="n">AMS_DELTA_LATCH2_MODEM_CODEC</span><span class="p">,</span>
				<span class="n">mute</span> <span class="o">?</span> <span class="n">AMS_DELTA_LATCH2_MODEM_CODEC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Our codec DAI probably doesn&#39;t have its own .ops structure */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">ams_delta_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">digital_mute</span> <span class="o">=</span> <span class="n">ams_delta_digital_mute</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Will be used if the codec ever has its own digital_mute function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ams_delta_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ams_delta_digital_mute</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ams_delta_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ams_delta_digital_mute</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Card initialization</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ams_delta_cx20442_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* Codec is ready, now add/activate board specific controls */</span>

	<span class="cm">/* Store a pointer to the codec structure for tty ldisc use */</span>
	<span class="n">cx20442_codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>

	<span class="cm">/* Set up digital mute if not provided by the codec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ams_delta_dai_ops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ams_delta_ops</span><span class="p">.</span><span class="n">startup</span> <span class="o">=</span> <span class="n">ams_delta_startup</span><span class="p">;</span>
		<span class="n">ams_delta_ops</span><span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ams_delta_shutdown</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add hook switch - can be used to control the codec from userspace</span>
<span class="cm">	 * even if line discipline fails */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_jack_new</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="s">&quot;hook_switch&quot;</span><span class="p">,</span>
				<span class="n">SND_JACK_HEADSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ams_delta_hook_switch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to allocate resources for hook switch, &quot;</span>
				<span class="s">&quot;will continue without one.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_jack_add_gpios</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_hook_switch</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ams_delta_hook_switch_gpios</span><span class="p">),</span>
					<span class="n">ams_delta_hook_switch_gpios</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to set up hook switch GPIO line, &quot;</span>
				<span class="s">&quot;will continue with hook switch inactive.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register optional line discipline for over the modem control */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tty_register_ldisc</span><span class="p">(</span><span class="n">N_V253</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx81801_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to register line discipline, &quot;</span>
				<span class="s">&quot;will continue without any controls.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add board specific DAPM widgets and routes */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">ams_delta_dapm_widgets</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ams_delta_dapm_widgets</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to register DAPM controls, &quot;</span>
				<span class="s">&quot;will continue without any.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">ams_delta_audio_map</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ams_delta_audio_map</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to set up DAPM routes, &quot;</span>
				<span class="s">&quot;will continue with codec default map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up initial pin constellation */</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Mouthpiece&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Earpiece&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Microphone&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;Speaker&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;AGCIN&quot;</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;AGCOUT&quot;</span><span class="p">);</span>

	<span class="cm">/* Add virtual switch */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ams_delta_audio_controls</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ams_delta_audio_controls</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to register audio mode control, &quot;</span>
				<span class="s">&quot;will continue without it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DAI glue - connects codec &lt;--&gt; CPU */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_link</span> <span class="n">ams_delta_dai_link</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CX20442&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;CX20442&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_dai_name</span> <span class="o">=</span> <span class="s">&quot;omap-mcbsp.1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_dai_name</span> <span class="o">=</span> <span class="s">&quot;cx20442-voice&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">ams_delta_cx20442_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform_name</span> <span class="o">=</span> <span class="s">&quot;omap-pcm-audio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_name</span> <span class="o">=</span> <span class="s">&quot;cx20442-codec&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ams_delta_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio card driver */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="n">ams_delta_audio_card</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AMS_DELTA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ams_delta_dai_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_links</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Module init/exit */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ams_delta_audio_platform_device</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">cx20442_platform_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ams_delta_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">machine_is_ams_delta</span><span class="p">()))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ams_delta_audio_platform_device</span> <span class="o">=</span>
			<span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;soc-audio&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ams_delta_audio_platform_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">ams_delta_audio_platform_device</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ams_delta_audio_card</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">ams_delta_audio_platform_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Codec platform device could be registered from elsewhere (board?),</span>
<span class="cm">	 * but I do it here as it makes sense only if used with the card.</span>
<span class="cm">	 */</span>
	<span class="n">cx20442_platform_device</span> <span class="o">=</span>
		<span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;cx20442-codec&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">ams_delta_audio_platform_device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">ams_delta_module_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ams_delta_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_unregister_ldisc</span><span class="p">(</span><span class="n">N_V253</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_audio_platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed to unregister V253 line discipline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_soc_jack_free_gpios</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ams_delta_hook_switch</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ams_delta_hook_switch_gpios</span><span class="p">),</span>
			<span class="n">ams_delta_hook_switch_gpios</span><span class="p">);</span>

	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">cx20442_platform_device</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">ams_delta_audio_platform_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ams_delta_module_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Janusz Krzysztofik &lt;jkrzyszt@tis.icnet.pl&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ALSA SoC driver for Amstrad E3 (Delta) videophone&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
