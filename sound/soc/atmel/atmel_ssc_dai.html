<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › atmel › atmel_ssc_dai.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>atmel_ssc_dai.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * atmel_ssc_dai.c  --  ALSA SoC ATMEL SSC Audio Layer Platform driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 SAN People</span>
<span class="cm"> * Copyright (C) 2008 Atmel</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Sedji Gaouaou &lt;sedji.gaouaou@atmel.com&gt;</span>
<span class="cm"> *         ATMEL CORP.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on at91-ssc.c by</span>
<span class="cm"> * Frank Mandarino &lt;fmandarino@endrelia.com&gt;</span>
<span class="cm"> * Based on pxa2xx Platform drivers by</span>
<span class="cm"> * Liam Girdwood &lt;lrg@slimlogic.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/atmel_pdc.h&gt;</span>

<span class="cp">#include &lt;linux/atmel-ssc.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>

<span class="cp">#include &quot;atmel-pcm.h&quot;</span>
<span class="cp">#include &quot;atmel_ssc_dai.h&quot;</span>


<span class="cp">#if defined(CONFIG_ARCH_AT91SAM9260) || defined(CONFIG_ARCH_AT91SAM9G20)</span>
<span class="cp">#define NUM_SSC_DEVICES		1</span>
<span class="cp">#else</span>
<span class="cp">#define NUM_SSC_DEVICES		3</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * SSC PDC registers required by the PCM DMA engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_pdc_regs</span> <span class="n">pdc_tx_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xpr</span>		<span class="o">=</span> <span class="n">ATMEL_PDC_TPR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcr</span>		<span class="o">=</span> <span class="n">ATMEL_PDC_TCR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xnpr</span>		<span class="o">=</span> <span class="n">ATMEL_PDC_TNPR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xncr</span>		<span class="o">=</span> <span class="n">ATMEL_PDC_TNCR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_pdc_regs</span> <span class="n">pdc_rx_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xpr</span>		<span class="o">=</span> <span class="n">ATMEL_PDC_RPR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcr</span>		<span class="o">=</span> <span class="n">ATMEL_PDC_RCR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xnpr</span>		<span class="o">=</span> <span class="n">ATMEL_PDC_RNPR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xncr</span>		<span class="o">=</span> <span class="n">ATMEL_PDC_RNCR</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SSC &amp; PDC status bits for transmit and receive.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_ssc_mask</span> <span class="n">ssc_tx_mask</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ssc_enable</span>	<span class="o">=</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_TXEN</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ssc_disable</span>	<span class="o">=</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_TXDIS</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ssc_endx</span>	<span class="o">=</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">SR_ENDTX</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ssc_endbuf</span>	<span class="o">=</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">SR_TXBUFE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">pdc_enable</span>	<span class="o">=</span> <span class="n">ATMEL_PDC_TXTEN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pdc_disable</span>	<span class="o">=</span> <span class="n">ATMEL_PDC_TXTDIS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_ssc_mask</span> <span class="n">ssc_rx_mask</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ssc_enable</span>	<span class="o">=</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_RXEN</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ssc_disable</span>	<span class="o">=</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_RXDIS</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ssc_endx</span>	<span class="o">=</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">SR_ENDRX</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ssc_endbuf</span>	<span class="o">=</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">SR_RXBUFF</span><span class="p">),</span>
	<span class="p">.</span><span class="n">pdc_enable</span>	<span class="o">=</span> <span class="n">ATMEL_PDC_RXTEN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pdc_disable</span>	<span class="o">=</span> <span class="n">ATMEL_PDC_RXTDIS</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * DMA parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_pcm_dma_params</span> <span class="n">ssc_dma_params</span><span class="p">[</span><span class="n">NUM_SSC_DEVICES</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SSC0 PCM out&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pdc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdc_tx_reg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_tx_mask</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SSC0 PCM in&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pdc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdc_rx_reg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_rx_mask</span><span class="p">,</span>
	<span class="p">}</span> <span class="p">},</span>
<span class="cp">#if NUM_SSC_DEVICES == 3</span>
	<span class="p">{{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SSC1 PCM out&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pdc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdc_tx_reg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_tx_mask</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SSC1 PCM in&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pdc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdc_rx_reg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_rx_mask</span><span class="p">,</span>
	<span class="p">}</span> <span class="p">},</span>
	<span class="p">{{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SSC2 PCM out&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pdc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdc_tx_reg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_tx_mask</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SSC2 PCM in&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pdc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdc_rx_reg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_rx_mask</span><span class="p">,</span>
	<span class="p">}</span> <span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="n">ssc_info</span><span class="p">[</span><span class="n">NUM_SSC_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ssc0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock</span>		<span class="o">=</span> <span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">ssc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dir_mask</span>	<span class="o">=</span> <span class="n">SSC_DIR_MASK_UNUSED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">initialized</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#if NUM_SSC_DEVICES == 3</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ssc1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock</span>		<span class="o">=</span> <span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">ssc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">lock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dir_mask</span>	<span class="o">=</span> <span class="n">SSC_DIR_MASK_UNUSED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">initialized</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ssc2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock</span>		<span class="o">=</span> <span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">ssc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">lock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dir_mask</span>	<span class="o">=</span> <span class="n">SSC_DIR_MASK_UNUSED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">initialized</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * SSC interrupt handler.  Passes PDC interrupts to the DMA</span>
<span class="cm"> * interrupt handler in the PCM driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">atmel_ssc_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_pcm_dma_params</span> <span class="o">*</span><span class="n">dma_params</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ssc_sr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ssc_substream_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ssc_sr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop through the substreams attached to this SSC.  If</span>
<span class="cm">	 * a DMA-related interrupt occurred on that substream, call</span>
<span class="cm">	 * the DMA interrupt handler function, if one has been</span>
<span class="cm">	 * registered in the dma_params structure by the PCM driver.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dma_params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_params</span> <span class="o">=</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dma_params</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dma_params</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">dma_intr_handler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ssc_substream_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">ssc_endx</span> <span class="o">|</span>
					<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">ssc_endbuf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssc_sr</span> <span class="o">&amp;</span> <span class="n">ssc_substream_mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">dma_intr_handler</span><span class="p">(</span><span class="n">ssc_sr</span><span class="p">,</span>
						<span class="n">dma_params</span><span class="o">-&gt;</span>
						<span class="n">substream</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*\</span>
<span class="cm"> * DAI functions</span>
<span class="cm">\*-------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Startup.  Only that one substream allowed in each direction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ssc_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_info</span><span class="p">[</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">dir_mask</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;atmel_ssc_startup: SSC_SR=0x%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">dir_mask</span> <span class="o">=</span> <span class="n">SSC_DIR_MASK_PLAYBACK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dir_mask</span> <span class="o">=</span> <span class="n">SSC_DIR_MASK_CAPTURE</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dir_mask</span> <span class="o">&amp;</span> <span class="n">dir_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dir_mask</span> <span class="o">|=</span> <span class="n">dir_mask</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Shutdown.  Clear DMA parameters and shutdown the SSC if there</span>
<span class="cm"> * are no other substreams open.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_ssc_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_info</span><span class="p">[</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">atmel_pcm_dma_params</span> <span class="o">*</span><span class="n">dma_params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dir_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dma_params</span> <span class="o">=</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dma_params</span><span class="p">[</span><span class="n">dir</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_params</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">CR</span><span class="p">,</span> <span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">ssc_disable</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;atmel_ssc_shutdown: %s disabled SSC_SR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dir</span> <span class="o">?</span> <span class="s">&quot;receive&quot;</span> <span class="o">:</span> <span class="s">&quot;transmit&quot;</span><span class="p">),</span>
			<span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR</span><span class="p">));</span>

		<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">ssc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dma_params</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dir_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dir</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dir_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dir_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dir_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Shutdown the SSC clock. */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;atmel_ssc_dau: Stopping clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clk_disable</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

			<span class="n">free_irq</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ssc_p</span><span class="p">);</span>
			<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Reset the SSC */</span>
		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">CR</span><span class="p">,</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_SWRST</span><span class="p">));</span>
		<span class="cm">/* Clear the SSC dividers */</span>
		<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">cmr_div</span> <span class="o">=</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">tcmr_period</span> <span class="o">=</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">rcmr_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Record the DAI format for use in hw_params().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ssc_set_dai_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_info</span><span class="p">[</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">daifmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Record SSC clock dividers for use in hw_params().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ssc_set_dai_clkdiv</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">div_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_info</span><span class="p">[</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">div_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATMEL_SSC_CMR_DIV</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The same master clock divider is used for both</span>
<span class="cm">		 * transmit and receive, so if a value has already</span>
<span class="cm">		 * been set, it must match this value.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">cmr_div</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">cmr_div</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">!=</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">cmr_div</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATMEL_SSC_TCMR_PERIOD</span>:
		<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">tcmr_period</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATMEL_SSC_RCMR_PERIOD</span>:
		<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">rcmr_period</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the SSC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ssc_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_info</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">atmel_pcm_dma_params</span> <span class="o">*</span><span class="n">dma_params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tfmr</span><span class="p">,</span> <span class="n">rfmr</span><span class="p">,</span> <span class="n">tcmr</span><span class="p">,</span> <span class="n">rcmr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Currently, there is only one set of dma params for</span>
<span class="cm">	 * each direction.  If more are added, this code will</span>
<span class="cm">	 * have to be changed to select the proper set.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dma_params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_dma_params</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">dir</span><span class="p">];</span>
	<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">ssc</span> <span class="o">=</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="p">;</span>
	<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dma_params</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_params</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The snd_soc_pcm_stream-&gt;dma_data field is only used to communicate</span>
<span class="cm">	 * the appropriate DMA parameters to the pcm driver hw_params()</span>
<span class="cm">	 * function.  It should not be used for other purposes</span>
<span class="cm">	 * as it is common to all substreams.</span>
<span class="cm">	 */</span>
	<span class="n">snd_soc_dai_set_dma_data</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">dma_params</span><span class="p">);</span>

	<span class="n">channels</span> <span class="o">=</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine sample size in bits and the PDC increment.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S8</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">pdc_xfer_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">pdc_xfer_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_LE</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">pdc_xfer_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">pdc_xfer_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;atmel_ssc_dai: unsupported PCM format&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The SSC only supports up to 16-bit samples in I2S format, due</span>
<span class="cm">	 * to the size of the Frame Mode Register FSLEN field.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">daifmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SND_SOC_DAIFMT_I2S</span>
		<span class="o">&amp;&amp;</span> <span class="n">bits</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;atmel_ssc_dai: sample size %d &quot;</span>
				<span class="s">&quot;is too large for I2S</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute SSC register settings.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">daifmt</span>
		<span class="o">&amp;</span> <span class="p">(</span><span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span> <span class="o">|</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">))</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span> <span class="o">|</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * I2S format, SSC provides BCLK and LRC clocks.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The SSC transmit and receive clocks are generated</span>
<span class="cm">		 * from the MCK divider, and the BCLK signal</span>
<span class="cm">		 * is output on the SSC TK line.</span>
<span class="cm">		 */</span>
		<span class="n">rcmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_PERIOD</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">rcmr_period</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_STTDLY</span><span class="p">,</span> <span class="n">START_DELAY</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_START</span><span class="p">,</span> <span class="n">SSC_START_FALLING_RF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_CKI</span><span class="p">,</span> <span class="n">SSC_CKI_RISING</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_CKO</span><span class="p">,</span> <span class="n">SSC_CKO_NONE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_CKS</span><span class="p">,</span> <span class="n">SSC_CKS_DIV</span><span class="p">);</span>

		<span class="n">rfmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_FSEDGE</span><span class="p">,</span> <span class="n">SSC_FSEDGE_POSITIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_FSOS</span><span class="p">,</span> <span class="n">SSC_FSOS_NEGATIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_FSLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_DATNB</span><span class="p">,</span> <span class="p">(</span><span class="n">channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="o">|</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">RFMR_MSBF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_LOOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_DATLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">tcmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_PERIOD</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">tcmr_period</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_STTDLY</span><span class="p">,</span> <span class="n">START_DELAY</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_START</span><span class="p">,</span> <span class="n">SSC_START_FALLING_RF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_CKI</span><span class="p">,</span> <span class="n">SSC_CKI_FALLING</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_CKO</span><span class="p">,</span> <span class="n">SSC_CKO_CONTINUOUS</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_CKS</span><span class="p">,</span> <span class="n">SSC_CKS_DIV</span><span class="p">);</span>

		<span class="n">tfmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSEDGE</span><span class="p">,</span> <span class="n">SSC_FSEDGE_POSITIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSDEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSOS</span><span class="p">,</span> <span class="n">SSC_FSOS_NEGATIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_DATNB</span><span class="p">,</span> <span class="p">(</span><span class="n">channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="o">|</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">TFMR_MSBF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_DATDEF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_DATLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span> <span class="o">|</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
		<span class="cm">/*</span>
<span class="cm">		 * I2S format, CODEC supplies BCLK and LRC clocks.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The SSC transmit clock is obtained from the BCLK signal on</span>
<span class="cm">		 * on the TK line, and the SSC receive clock is</span>
<span class="cm">		 * generated from the transmit clock.</span>
<span class="cm">		 *</span>
<span class="cm">		 *  For single channel data, one sample is transferred</span>
<span class="cm">		 * on the falling edge of the LRC clock.</span>
<span class="cm">		 * For two channel data, one sample is</span>
<span class="cm">		 * transferred on both edges of the LRC clock.</span>
<span class="cm">		 */</span>
		<span class="n">start_event</span> <span class="o">=</span> <span class="p">((</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">SSC_START_FALLING_RF</span>
				<span class="o">:</span> <span class="n">SSC_START_EDGE_RF</span><span class="p">);</span>

		<span class="n">rcmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_PERIOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_STTDLY</span><span class="p">,</span> <span class="n">START_DELAY</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_START</span><span class="p">,</span> <span class="n">start_event</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_CKI</span><span class="p">,</span> <span class="n">SSC_CKI_RISING</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_CKO</span><span class="p">,</span> <span class="n">SSC_CKO_NONE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_CKS</span><span class="p">,</span> <span class="n">SSC_CKS_CLOCK</span><span class="p">);</span>

		<span class="n">rfmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_FSEDGE</span><span class="p">,</span> <span class="n">SSC_FSEDGE_POSITIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_FSOS</span><span class="p">,</span> <span class="n">SSC_FSOS_NONE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_FSLEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_DATNB</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">RFMR_MSBF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_LOOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_DATLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">tcmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_PERIOD</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_STTDLY</span><span class="p">,</span> <span class="n">START_DELAY</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_START</span><span class="p">,</span> <span class="n">start_event</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_CKI</span><span class="p">,</span> <span class="n">SSC_CKI_FALLING</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_CKO</span><span class="p">,</span> <span class="n">SSC_CKO_NONE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_CKS</span><span class="p">,</span> <span class="n">SSC_CKS_PIN</span><span class="p">);</span>

		<span class="n">tfmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSEDGE</span><span class="p">,</span> <span class="n">SSC_FSEDGE_POSITIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSDEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSOS</span><span class="p">,</span> <span class="n">SSC_FSOS_NONE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSLEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_DATNB</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">TFMR_MSBF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_DATDEF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_DATLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_A</span> <span class="o">|</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * DSP/PCM Mode A format, SSC provides BCLK and LRC clocks.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The SSC transmit and receive clocks are generated from the</span>
<span class="cm">		 * MCK divider, and the BCLK signal is output</span>
<span class="cm">		 * on the SSC TK line.</span>
<span class="cm">		 */</span>
		<span class="n">rcmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_PERIOD</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">rcmr_period</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_STTDLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_START</span><span class="p">,</span> <span class="n">SSC_START_RISING_RF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_CKI</span><span class="p">,</span> <span class="n">SSC_CKI_RISING</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_CKO</span><span class="p">,</span> <span class="n">SSC_CKO_NONE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RCMR_CKS</span><span class="p">,</span> <span class="n">SSC_CKS_DIV</span><span class="p">);</span>

		<span class="n">rfmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_FSEDGE</span><span class="p">,</span> <span class="n">SSC_FSEDGE_POSITIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_FSOS</span><span class="p">,</span> <span class="n">SSC_FSOS_POSITIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_FSLEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_DATNB</span><span class="p">,</span> <span class="p">(</span><span class="n">channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="o">|</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">RFMR_MSBF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_LOOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">RFMR_DATLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">tcmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_PERIOD</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">tcmr_period</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_STTDLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_START</span><span class="p">,</span> <span class="n">SSC_START_RISING_RF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_CKI</span><span class="p">,</span> <span class="n">SSC_CKI_RISING</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_CKO</span><span class="p">,</span> <span class="n">SSC_CKO_CONTINUOUS</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TCMR_CKS</span><span class="p">,</span> <span class="n">SSC_CKS_DIV</span><span class="p">);</span>

		<span class="n">tfmr</span> <span class="o">=</span>	  <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSEDGE</span><span class="p">,</span> <span class="n">SSC_FSEDGE_POSITIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSDEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSOS</span><span class="p">,</span> <span class="n">SSC_FSOS_POSITIVE</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_FSLEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_DATNB</span><span class="p">,</span> <span class="p">(</span><span class="n">channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="o">|</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">TFMR_MSBF</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_DATDEF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">SSC_BF</span><span class="p">(</span><span class="n">TFMR_DATLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_A</span> <span class="o">|</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;atmel_ssc_dai: unsupported DAI format 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">daifmt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;atmel_ssc_hw_params: &quot;</span>
			<span class="s">&quot;RCMR=%08x RFMR=%08x TCMR=%08x TFMR=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rcmr</span><span class="p">,</span> <span class="n">rfmr</span><span class="p">,</span> <span class="n">tcmr</span><span class="p">,</span> <span class="n">tfmr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Enable PMC peripheral clock for this SSC */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;atmel_ssc_dai: Starting clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

		<span class="cm">/* Reset the SSC and its PDC registers */</span>
		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">CR</span><span class="p">,</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_SWRST</span><span class="p">));</span>

		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">PDC_RPR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">PDC_RCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">PDC_RNPR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">PDC_RNCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">PDC_TPR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">PDC_TCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">PDC_TNPR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">PDC_TNCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">atmel_ssc_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ssc_p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					<span class="s">&quot;atmel_ssc_dai: request_irq failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Atmel_ssc_dai: Stoping clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clk_disable</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set SSC clock mode register */</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">CMR</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">cmr_div</span><span class="p">);</span>

	<span class="cm">/* set receive clock mode and format */</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">RCMR</span><span class="p">,</span> <span class="n">rcmr</span><span class="p">);</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">RFMR</span><span class="p">,</span> <span class="n">rfmr</span><span class="p">);</span>

	<span class="cm">/* set transmit clock mode and format */</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">TCMR</span><span class="p">,</span> <span class="n">tcmr</span><span class="p">);</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">TFMR</span><span class="p">,</span> <span class="n">tfmr</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;atmel_ssc_dai,hw_params: SSC initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ssc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_info</span><span class="p">[</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">atmel_pcm_dma_params</span> <span class="o">*</span><span class="n">dma_params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dma_params</span> <span class="o">=</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">dma_params</span><span class="p">[</span><span class="n">dir</span><span class="p">];</span>

	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">CR</span><span class="p">,</span> <span class="n">dma_params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">ssc_enable</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s enabled SSC_SR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dir</span> <span class="o">?</span> <span class="s">&quot;receive&quot;</span> <span class="o">:</span> <span class="s">&quot;transmit&quot;</span><span class="p">,</span>
			<span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ssc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ssc_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_info</span><span class="p">[</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="cm">/* Save the status register before disabling transmit and receive */</span>
	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_sr</span> <span class="o">=</span> <span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">CR</span><span class="p">,</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_TXDIS</span><span class="p">)</span> <span class="o">|</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_RXDIS</span><span class="p">));</span>

	<span class="cm">/* Save the current interrupt mask, then disable unmasked interrupts */</span>
	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_imr</span> <span class="o">=</span> <span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">IMR</span><span class="p">);</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">IDR</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_imr</span><span class="p">);</span>

	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_cmr</span> <span class="o">=</span> <span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">CMR</span><span class="p">);</span>
	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_rcmr</span> <span class="o">=</span> <span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">RCMR</span><span class="p">);</span>
	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_rfmr</span> <span class="o">=</span> <span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">RFMR</span><span class="p">);</span>
	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_tcmr</span> <span class="o">=</span> <span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">TCMR</span><span class="p">);</span>
	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_tfmr</span> <span class="o">=</span> <span class="n">ssc_readl</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">TFMR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ssc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ssc_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_info</span><span class="p">[</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="cm">/* restore SSC register settings */</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">TFMR</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_tfmr</span><span class="p">);</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">TCMR</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_tcmr</span><span class="p">);</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">RFMR</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_rfmr</span><span class="p">);</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">RCMR</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_rcmr</span><span class="p">);</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">CMR</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_cmr</span><span class="p">);</span>

	<span class="cm">/* re-enable interrupts */</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">IER</span><span class="p">,</span> <span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_imr</span><span class="p">);</span>

	<span class="cm">/* Re-enable receive and transmit as appropriate */</span>
	<span class="n">cr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cr</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_sr</span> <span class="o">&amp;</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">SR_RXEN</span><span class="p">))</span> <span class="o">?</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_RXEN</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cr</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc_state</span><span class="p">.</span><span class="n">ssc_sr</span> <span class="o">&amp;</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">SR_TXEN</span><span class="p">))</span> <span class="o">?</span> <span class="n">SSC_BIT</span><span class="p">(</span><span class="n">CR_TXEN</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ssc_writel</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">CR</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
<span class="cp">#  define atmel_ssc_suspend	NULL</span>
<span class="cp">#  define atmel_ssc_resume	NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ssc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_info</span><span class="p">[</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_soc_dai_set_drvdata</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">ssc_p</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Request SSC device</span>
<span class="cm">	 */</span>
	<span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span> <span class="o">=</span> <span class="n">ssc_request</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ASoC: Failed to request SSC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ssc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_ssc_info</span> <span class="o">*</span><span class="n">ssc_p</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>

	<span class="n">ssc_free</span><span class="p">(</span><span class="n">ssc_p</span><span class="o">-&gt;</span><span class="n">ssc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ATMEL_SSC_RATES (SNDRV_PCM_RATE_8000_96000)</span>

<span class="cp">#define ATMEL_SSC_FORMATS (SNDRV_PCM_FMTBIT_S8     | SNDRV_PCM_FMTBIT_S16_LE |\</span>
<span class="cp">			  SNDRV_PCM_FMTBIT_S24_LE | SNDRV_PCM_FMTBIT_S32_LE)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">atmel_ssc_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">atmel_ssc_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">atmel_ssc_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span> <span class="n">atmel_ssc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">atmel_ssc_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">atmel_ssc_set_dai_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_clkdiv</span>	<span class="o">=</span> <span class="n">atmel_ssc_set_dai_clkdiv</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">atmel_ssc_dai</span><span class="p">[</span><span class="n">NUM_SSC_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;atmel-ssc-dai.0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">atmel_ssc_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">atmel_ssc_remove</span><span class="p">,</span>
		<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">atmel_ssc_suspend</span><span class="p">,</span>
		<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">atmel_ssc_resume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">ATMEL_SSC_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">ATMEL_SSC_FORMATS</span><span class="p">,},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">ATMEL_SSC_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">ATMEL_SSC_FORMATS</span><span class="p">,},</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_ssc_dai_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#if NUM_SSC_DEVICES == 3</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;atmel-ssc-dai.1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">atmel_ssc_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">atmel_ssc_remove</span><span class="p">,</span>
		<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">atmel_ssc_suspend</span><span class="p">,</span>
		<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">atmel_ssc_resume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">ATMEL_SSC_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">ATMEL_SSC_FORMATS</span><span class="p">,},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">ATMEL_SSC_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">ATMEL_SSC_FORMATS</span><span class="p">,},</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_ssc_dai_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;atmel-ssc-dai.2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">atmel_ssc_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">atmel_ssc_remove</span><span class="p">,</span>
		<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">atmel_ssc_suspend</span><span class="p">,</span>
		<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">atmel_ssc_resume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">ATMEL_SSC_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">ATMEL_SSC_FORMATS</span><span class="p">,},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">ATMEL_SSC_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">ATMEL_SSC_FORMATS</span><span class="p">,},</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_ssc_dai_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">asoc_ssc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_ssc_dai</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">snd_soc_register_dai</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmel_ssc_dai</span><span class="p">[</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">asoc_ssc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_unregister_dai</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">asoc_ssc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;atmel-ssc-dai&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">asoc_ssc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">asoc_ssc_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * atmel_ssc_set_audio - Allocate the specified SSC for audio use.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">atmel_ssc_set_audio</span><span class="p">(</span><span class="kt">int</span> <span class="n">ssc_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssc_device</span> <span class="o">*</span><span class="n">ssc</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dma_pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ssc_pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssc_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ssc_id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_ssc_dai</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Allocate a dummy device for DMA if we don&#39;t have one already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel-pcm-audio&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_pdev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">dma_pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">platform_device_put</span><span class="p">(</span><span class="n">dma_pdev</span><span class="p">);</span>
			<span class="n">dma_pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ssc_pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel-ssc-dai&quot;</span><span class="p">,</span> <span class="n">ssc_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssc_pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* If we can grab the SSC briefly to parent the DAI device off it */</span>
	<span class="n">ssc</span> <span class="o">=</span> <span class="n">ssc_request</span><span class="p">(</span><span class="n">ssc_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ssc</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unable to parent ASoC SSC DAI on SSC: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ssc</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ssc_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ssc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ssc_free</span><span class="p">(</span><span class="n">ssc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">ssc_pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">platform_device_put</span><span class="p">(</span><span class="n">ssc_pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">atmel_ssc_set_audio</span><span class="p">);</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">asoc_ssc_driver</span><span class="p">);</span>

<span class="cm">/* Module information */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sedji Gaouaou, sedji.gaouaou@atmel.com, www.atmel.com&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ATMEL SSC ASoC Interface&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
