<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › codecs › da7210.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>da7210.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * DA7210 ALSA Soc codec driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 Dialog Semiconductor</span>
<span class="cm"> * Written by David Chen &lt;Dajun.chen@diasemi.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Renesas Solutions Corp.</span>
<span class="cm"> * Cleanups by Kuninori Morimoto &lt;morimoto.kuninori@renesas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Tested on SuperH Ecovec24 board with S16/S24 LE in 48KHz using I2S</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/regmap.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>

<span class="cm">/* DA7210 register space */</span>
<span class="cp">#define DA7210_PAGE_CONTROL		0x00</span>
<span class="cp">#define DA7210_CONTROL			0x01</span>
<span class="cp">#define DA7210_STATUS			0x02</span>
<span class="cp">#define DA7210_STARTUP1			0x03</span>
<span class="cp">#define DA7210_STARTUP2			0x04</span>
<span class="cp">#define DA7210_STARTUP3			0x05</span>
<span class="cp">#define DA7210_MIC_L			0x07</span>
<span class="cp">#define DA7210_MIC_R			0x08</span>
<span class="cp">#define DA7210_AUX1_L			0x09</span>
<span class="cp">#define DA7210_AUX1_R			0x0A</span>
<span class="cp">#define DA7210_AUX2			0x0B</span>
<span class="cp">#define DA7210_IN_GAIN			0x0C</span>
<span class="cp">#define DA7210_INMIX_L			0x0D</span>
<span class="cp">#define DA7210_INMIX_R			0x0E</span>
<span class="cp">#define DA7210_ADC_HPF			0x0F</span>
<span class="cp">#define DA7210_ADC			0x10</span>
<span class="cp">#define DA7210_ADC_EQ1_2		0X11</span>
<span class="cp">#define DA7210_ADC_EQ3_4		0x12</span>
<span class="cp">#define DA7210_ADC_EQ5			0x13</span>
<span class="cp">#define DA7210_DAC_HPF			0x14</span>
<span class="cp">#define DA7210_DAC_L			0x15</span>
<span class="cp">#define DA7210_DAC_R			0x16</span>
<span class="cp">#define DA7210_DAC_SEL			0x17</span>
<span class="cp">#define DA7210_SOFTMUTE			0x18</span>
<span class="cp">#define DA7210_DAC_EQ1_2		0x19</span>
<span class="cp">#define DA7210_DAC_EQ3_4		0x1A</span>
<span class="cp">#define DA7210_DAC_EQ5			0x1B</span>
<span class="cp">#define DA7210_OUTMIX_L			0x1C</span>
<span class="cp">#define DA7210_OUTMIX_R			0x1D</span>
<span class="cp">#define DA7210_OUT1_L			0x1E</span>
<span class="cp">#define DA7210_OUT1_R			0x1F</span>
<span class="cp">#define DA7210_OUT2			0x20</span>
<span class="cp">#define DA7210_HP_L_VOL			0x21</span>
<span class="cp">#define DA7210_HP_R_VOL			0x22</span>
<span class="cp">#define DA7210_HP_CFG			0x23</span>
<span class="cp">#define DA7210_ZERO_CROSS		0x24</span>
<span class="cp">#define DA7210_DAI_SRC_SEL		0x25</span>
<span class="cp">#define DA7210_DAI_CFG1			0x26</span>
<span class="cp">#define DA7210_DAI_CFG3			0x28</span>
<span class="cp">#define DA7210_PLL_DIV1			0x29</span>
<span class="cp">#define DA7210_PLL_DIV2			0x2A</span>
<span class="cp">#define DA7210_PLL_DIV3			0x2B</span>
<span class="cp">#define DA7210_PLL			0x2C</span>
<span class="cp">#define DA7210_ALC_MAX			0x83</span>
<span class="cp">#define DA7210_ALC_MIN			0x84</span>
<span class="cp">#define DA7210_ALC_NOIS			0x85</span>
<span class="cp">#define DA7210_ALC_ATT			0x86</span>
<span class="cp">#define DA7210_ALC_REL			0x87</span>
<span class="cp">#define DA7210_ALC_DEL			0x88</span>
<span class="cp">#define DA7210_A_HID_UNLOCK		0x8A</span>
<span class="cp">#define DA7210_A_TEST_UNLOCK		0x8B</span>
<span class="cp">#define DA7210_A_PLL1			0x90</span>
<span class="cp">#define DA7210_A_CP_MODE		0xA7</span>

<span class="cm">/* STARTUP1 bit fields */</span>
<span class="cp">#define DA7210_SC_MST_EN		(1 &lt;&lt; 0)</span>

<span class="cm">/* MIC_L bit fields */</span>
<span class="cp">#define DA7210_MICBIAS_EN		(1 &lt;&lt; 6)</span>
<span class="cp">#define DA7210_MIC_L_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* MIC_R bit fields */</span>
<span class="cp">#define DA7210_MIC_R_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* INMIX_L bit fields */</span>
<span class="cp">#define DA7210_IN_L_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* INMIX_R bit fields */</span>
<span class="cp">#define DA7210_IN_R_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* ADC bit fields */</span>
<span class="cp">#define DA7210_ADC_ALC_EN		(1 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_ADC_L_EN			(1 &lt;&lt; 3)</span>
<span class="cp">#define DA7210_ADC_R_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* DAC/ADC HPF fields */</span>
<span class="cp">#define DA7210_VOICE_F0_MASK		(0x7 &lt;&lt; 4)</span>
<span class="cp">#define DA7210_VOICE_F0_25		(1 &lt;&lt; 4)</span>
<span class="cp">#define DA7210_VOICE_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* DAC_SEL bit fields */</span>
<span class="cp">#define DA7210_DAC_L_SRC_DAI_L		(4 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_DAC_L_EN			(1 &lt;&lt; 3)</span>
<span class="cp">#define DA7210_DAC_R_SRC_DAI_R		(5 &lt;&lt; 4)</span>
<span class="cp">#define DA7210_DAC_R_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* OUTMIX_L bit fields */</span>
<span class="cp">#define DA7210_OUT_L_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* OUTMIX_R bit fields */</span>
<span class="cp">#define DA7210_OUT_R_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* HP_CFG bit fields */</span>
<span class="cp">#define DA7210_HP_2CAP_MODE		(1 &lt;&lt; 1)</span>
<span class="cp">#define DA7210_HP_SENSE_EN		(1 &lt;&lt; 2)</span>
<span class="cp">#define DA7210_HP_L_EN			(1 &lt;&lt; 3)</span>
<span class="cp">#define DA7210_HP_MODE			(1 &lt;&lt; 6)</span>
<span class="cp">#define DA7210_HP_R_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/* DAI_SRC_SEL bit fields */</span>
<span class="cp">#define DA7210_DAI_OUT_L_SRC		(6 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_DAI_OUT_R_SRC		(7 &lt;&lt; 4)</span>

<span class="cm">/* DAI_CFG1 bit fields */</span>
<span class="cp">#define DA7210_DAI_WORD_S16_LE		(0 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_DAI_WORD_S20_3LE		(1 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_DAI_WORD_S24_LE		(2 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_DAI_WORD_S32_LE		(3 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_DAI_FLEN_64BIT		(1 &lt;&lt; 2)</span>
<span class="cp">#define DA7210_DAI_MODE_SLAVE		(0 &lt;&lt; 7)</span>
<span class="cp">#define DA7210_DAI_MODE_MASTER		(1 &lt;&lt; 7)</span>

<span class="cm">/* DAI_CFG3 bit fields */</span>
<span class="cp">#define DA7210_DAI_FORMAT_I2SMODE	(0 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_DAI_FORMAT_LEFT_J	(1 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_DAI_FORMAT_RIGHT_J	(2 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_DAI_OE			(1 &lt;&lt; 3)</span>
<span class="cp">#define DA7210_DAI_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/*PLL_DIV3 bit fields */</span>
<span class="cp">#define DA7210_PLL_DIV_L_MASK		(0xF &lt;&lt; 0)</span>
<span class="cp">#define DA7210_MCLK_RANGE_10_20_MHZ	(1 &lt;&lt; 4)</span>
<span class="cp">#define DA7210_PLL_BYP			(1 &lt;&lt; 6)</span>

<span class="cm">/* PLL bit fields */</span>
<span class="cp">#define DA7210_PLL_FS_MASK		(0xF &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_8000		(0x1 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_11025		(0x2 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_12000		(0x3 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_16000		(0x5 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_22050		(0x6 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_24000		(0x7 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_32000		(0x9 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_44100		(0xA &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_48000		(0xB &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_88200		(0xE &lt;&lt; 0)</span>
<span class="cp">#define DA7210_PLL_FS_96000		(0xF &lt;&lt; 0)</span>
<span class="cp">#define DA7210_MCLK_DET_EN		(0x1 &lt;&lt; 5)</span>
<span class="cp">#define DA7210_MCLK_SRM_EN		(0x1 &lt;&lt; 6)</span>
<span class="cp">#define DA7210_PLL_EN			(0x1 &lt;&lt; 7)</span>

<span class="cm">/* SOFTMUTE bit fields */</span>
<span class="cp">#define DA7210_RAMP_EN			(1 &lt;&lt; 6)</span>

<span class="cm">/* CONTROL bit fields */</span>
<span class="cp">#define DA7210_REG_EN			(1 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_BIAS_EN			(1 &lt;&lt; 2)</span>
<span class="cp">#define DA7210_NOISE_SUP_EN		(1 &lt;&lt; 3)</span>

<span class="cm">/* IN_GAIN bit fields */</span>
<span class="cp">#define DA7210_INPGA_L_VOL		(0x0F &lt;&lt; 0)</span>
<span class="cp">#define DA7210_INPGA_R_VOL		(0xF0 &lt;&lt; 0)</span>

<span class="cm">/* ZERO_CROSS bit fields */</span>
<span class="cp">#define DA7210_AUX1_L_ZC		(1 &lt;&lt; 0)</span>
<span class="cp">#define DA7210_AUX1_R_ZC		(1 &lt;&lt; 1)</span>
<span class="cp">#define DA7210_HP_L_ZC			(1 &lt;&lt; 6)</span>
<span class="cp">#define DA7210_HP_R_ZC			(1 &lt;&lt; 7)</span>

<span class="cm">/* AUX1_L bit fields */</span>
<span class="cp">#define DA7210_AUX1_L_VOL		(0x3F &lt;&lt; 0)</span>
<span class="cp">#define DA7210_AUX1_L_EN		(1 &lt;&lt; 7)</span>

<span class="cm">/* AUX1_R bit fields */</span>
<span class="cp">#define DA7210_AUX1_R_VOL		(0x3F &lt;&lt; 0)</span>
<span class="cp">#define DA7210_AUX1_R_EN		(1 &lt;&lt; 7)</span>

<span class="cm">/* AUX2 bit fields */</span>
<span class="cp">#define DA7210_AUX2_EN			(1 &lt;&lt; 3)</span>

<span class="cm">/* Minimum INPGA and AUX1 volume to enable noise suppression */</span>
<span class="cp">#define DA7210_INPGA_MIN_VOL_NS		0x0A  </span><span class="cm">/* 10.5dB */</span><span class="cp"></span>
<span class="cp">#define DA7210_AUX1_MIN_VOL_NS		0x35  </span><span class="cm">/* 6dB */</span><span class="cp"></span>

<span class="cm">/* OUT1_L bit fields */</span>
<span class="cp">#define DA7210_OUT1_L_EN		(1 &lt;&lt; 7)</span>

<span class="cm">/* OUT1_R bit fields */</span>
<span class="cp">#define DA7210_OUT1_R_EN		(1 &lt;&lt; 7)</span>

<span class="cm">/* OUT2 bit fields */</span>
<span class="cp">#define DA7210_OUT2_OUTMIX_R		(1 &lt;&lt; 5)</span>
<span class="cp">#define DA7210_OUT2_OUTMIX_L		(1 &lt;&lt; 6)</span>
<span class="cp">#define DA7210_OUT2_EN			(1 &lt;&lt; 7)</span>

<span class="k">struct</span> <span class="n">pll_div</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">fref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fout</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">div1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">div2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">div3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>	<span class="cm">/* 0 = slave, 1 = master */</span>
<span class="p">};</span>

<span class="cm">/* PLL dividers table */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pll_div</span> <span class="n">da7210_pll_div</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* for MASTER mode, fs = 44.1Khz */</span>
	<span class="p">{</span> <span class="mi">12000000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=12Mhz */</span>
	<span class="p">{</span> <span class="mi">13000000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xC</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=13Mhz */</span>
	<span class="p">{</span> <span class="mi">13500000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xD</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=13.5Mhz */</span>
	<span class="p">{</span> <span class="mi">14400000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=14.4Mhz */</span>
	<span class="p">{</span> <span class="mi">19200000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=19.2Mhz */</span>
	<span class="p">{</span> <span class="mi">19680000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=19.68Mhz */</span>
	<span class="p">{</span> <span class="mi">19800000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0xB</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=19.8Mhz */</span>
	<span class="cm">/* for MASTER mode, fs = 48Khz */</span>
	<span class="p">{</span> <span class="mi">12000000</span><span class="p">,</span> <span class="mi">3072000</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=12Mhz */</span>
	<span class="p">{</span> <span class="mi">13000000</span><span class="p">,</span> <span class="mi">3072000</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=13Mhz */</span>
	<span class="p">{</span> <span class="mi">13500000</span><span class="p">,</span> <span class="mi">3072000</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=13.5Mhz */</span>
	<span class="p">{</span> <span class="mi">14400000</span><span class="p">,</span> <span class="mi">3072000</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=14.4Mhz */</span>
	<span class="p">{</span> <span class="mi">19200000</span><span class="p">,</span> <span class="mi">3072000</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=19.2Mhz */</span>
	<span class="p">{</span> <span class="mi">19680000</span><span class="p">,</span> <span class="mi">3072000</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=19.68Mhz */</span>
	<span class="p">{</span> <span class="mi">19800000</span><span class="p">,</span> <span class="mi">3072000</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* MCLK=19.8Mhz */</span>
	<span class="cm">/* for SLAVE mode with SRM */</span>
	<span class="p">{</span> <span class="mi">12000000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* MCLK=12Mhz */</span>
	<span class="p">{</span> <span class="mi">13000000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* MCLK=13Mhz */</span>
	<span class="p">{</span> <span class="mi">13500000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* MCLK=13.5Mhz */</span>
	<span class="p">{</span> <span class="mi">14400000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* MCLK=14.4Mhz */</span>
	<span class="p">{</span> <span class="mi">19200000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* MCLK=19.2Mhz */</span>
	<span class="p">{</span> <span class="mi">19680000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0xD</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* MCLK=19.68Mhz */</span>
	<span class="p">{</span> <span class="mi">19800000</span><span class="p">,</span> <span class="mi">2822400</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* MCLK=19.8Mhz  */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">clk_src</span> <span class="p">{</span>
	<span class="n">DA7210_CLKSRC_MCLK</span>
<span class="p">};</span>

<span class="cp">#define DA7210_VERSION &quot;0.0.1&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Playback Volume</span>
<span class="cm"> *</span>
<span class="cm"> * max		: 0x3F (+15.0 dB)</span>
<span class="cm"> *		   (1.5 dB step)</span>
<span class="cm"> * min		: 0x11 (-54.0 dB)</span>
<span class="cm"> * mute		: 0x10</span>
<span class="cm"> * reserved	: 0x00 - 0x0F</span>
<span class="cm"> *</span>
<span class="cm"> * Reserved area are considered as &quot;mute&quot;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hp_out_tlv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="n">TLV_DB_GAIN_MUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="cm">/* -54 dB to +15 dB */</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">5400</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lineout_vol_tlv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="n">TLV_DB_GAIN_MUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="cm">/* -54dB to 15dB */</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">5400</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mono_vol_tlv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">1800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="cm">/* -18dB to 6dB */</span>
	<span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">1800</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aux1_vol_tlv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="n">TLV_DB_GAIN_MUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="cm">/* -48dB to 21dB */</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">4800</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">eq_gain_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">1050</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">adc_eq_master_gain_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">1800</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">dac_gain_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">7725</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">mic_vol_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">aux2_vol_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">inpga_gain_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">450</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* ADC and DAC high pass filter f0 value */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">da7210_hpf_cutoff_txt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Fs/8192*pi&quot;</span><span class="p">,</span> <span class="s">&quot;Fs/4096*pi&quot;</span><span class="p">,</span> <span class="s">&quot;Fs/2048*pi&quot;</span><span class="p">,</span> <span class="s">&quot;Fs/1024*pi&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">da7210_dac_hpf_cutoff</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">DA7210_DAC_HPF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">da7210_hpf_cutoff_txt</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">da7210_adc_hpf_cutoff</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">DA7210_ADC_HPF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">da7210_hpf_cutoff_txt</span><span class="p">);</span>

<span class="cm">/* ADC and DAC voice (8kHz) high pass cutoff value */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">da7210_vf_cutoff_txt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;2.5Hz&quot;</span><span class="p">,</span> <span class="s">&quot;25Hz&quot;</span><span class="p">,</span> <span class="s">&quot;50Hz&quot;</span><span class="p">,</span> <span class="s">&quot;100Hz&quot;</span><span class="p">,</span> <span class="s">&quot;150Hz&quot;</span><span class="p">,</span> <span class="s">&quot;200Hz&quot;</span><span class="p">,</span> <span class="s">&quot;300Hz&quot;</span><span class="p">,</span> <span class="s">&quot;400Hz&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">da7210_dac_vf_cutoff</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">DA7210_DAC_HPF</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">da7210_vf_cutoff_txt</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">da7210_adc_vf_cutoff</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">DA7210_ADC_HPF</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">da7210_vf_cutoff_txt</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">da7210_hp_mode_txt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Class H&quot;</span><span class="p">,</span> <span class="s">&quot;Class G&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">da7210_hp_mode_sel</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">DA7210_HP_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">da7210_hp_mode_txt</span><span class="p">);</span>

<span class="cm">/* ALC can be enabled only if noise suppression is disabled */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">da7210_put_alc_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Check if noise suppression is enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DA7210_NOISE_SUP_EN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Disable noise suppression to enable ALC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* If all conditions are met or we are actually disabling ALC */</span>
	<span class="k">return</span> <span class="n">snd_soc_put_volsw</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Noise suppression can be enabled only if following conditions are met</span>
<span class="cm"> *  ALC disabled</span>
<span class="cm"> *  ZC enabled for HP and AUX1 PGA</span>
<span class="cm"> *  INPGA_L_VOL and INPGA_R_VOL &gt;= 10.5 dB</span>
<span class="cm"> *  AUX1_L_VOL and AUX1_R_VOL &gt;= 6 dB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">da7210_put_noise_sup_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Check if ALC is enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_ADC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DA7210_ADC_ALC_EN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* Check ZC for HP and AUX1 PGA */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_ZERO_CROSS</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">DA7210_AUX1_L_ZC</span> <span class="o">|</span> <span class="n">DA7210_AUX1_R_ZC</span> <span class="o">|</span> <span class="n">DA7210_HP_L_ZC</span> <span class="o">|</span>
			<span class="n">DA7210_HP_R_ZC</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">DA7210_AUX1_L_ZC</span> <span class="o">|</span>
			<span class="n">DA7210_AUX1_R_ZC</span> <span class="o">|</span> <span class="n">DA7210_HP_L_ZC</span> <span class="o">|</span> <span class="n">DA7210_HP_R_ZC</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* Check INPGA_L_VOL and INPGA_R_VOL */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_IN_GAIN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DA7210_INPGA_L_VOL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">DA7210_INPGA_MIN_VOL_NS</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DA7210_INPGA_R_VOL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span>
			<span class="n">DA7210_INPGA_MIN_VOL_NS</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* Check AUX1_L_VOL and AUX1_R_VOL */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_AUX1_L</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DA7210_AUX1_L_VOL</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">DA7210_AUX1_MIN_VOL_NS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_AUX1_R</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DA7210_AUX1_R_VOL</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">DA7210_AUX1_MIN_VOL_NS</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If all conditions are met or we are actually disabling Noise sup */</span>
	<span class="k">return</span> <span class="n">snd_soc_put_volsw</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">da7210_snd_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;HeadPhone Playback Volume&quot;</span><span class="p">,</span>
			 <span class="n">DA7210_HP_L_VOL</span><span class="p">,</span> <span class="n">DA7210_HP_R_VOL</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hp_out_tlv</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;Digital Playback Volume&quot;</span><span class="p">,</span>
			 <span class="n">DA7210_DAC_L</span><span class="p">,</span> <span class="n">DA7210_DAC_R</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dac_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;Lineout Playback Volume&quot;</span><span class="p">,</span>
			 <span class="n">DA7210_OUT1_L</span><span class="p">,</span> <span class="n">DA7210_OUT1_R</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lineout_vol_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;Mono Playback Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_OUT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">mono_vol_tlv</span><span class="p">),</span>

	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;Mic Capture Volume&quot;</span><span class="p">,</span>
			 <span class="n">DA7210_MIC_L</span><span class="p">,</span> <span class="n">DA7210_MIC_R</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mic_vol_tlv</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;Aux1 Capture Volume&quot;</span><span class="p">,</span>
			 <span class="n">DA7210_AUX1_L</span><span class="p">,</span> <span class="n">DA7210_AUX1_R</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aux1_vol_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;Aux2 Capture Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_AUX2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">aux2_vol_tlv</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;In PGA Capture Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_IN_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">inpga_gain_tlv</span><span class="p">),</span>

	<span class="cm">/* DAC Equalizer  controls */</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC EQ Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_DAC_EQ5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC EQ1 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_DAC_EQ1_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC EQ2 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_DAC_EQ1_2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC EQ3 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_DAC_EQ3_4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC EQ4 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_DAC_EQ3_4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC EQ5 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_DAC_EQ5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>

	<span class="cm">/* ADC Equalizer  controls */</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ADC EQ Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC_EQ5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;ADC EQ Master Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC_EQ5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span>
		       <span class="mi">1</span><span class="p">,</span> <span class="n">adc_eq_master_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;ADC EQ1 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC_EQ1_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;ADC EQ2 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC_EQ1_2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;ADC EQ3 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC_EQ3_4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;ADC EQ4 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC_EQ3_4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;ADC EQ5 Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC_EQ5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">eq_gain_tlv</span><span class="p">),</span>

	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC HPF Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_DAC_HPF</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;DAC HPF Cutoff&quot;</span><span class="p">,</span> <span class="n">da7210_dac_hpf_cutoff</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC Voice Mode Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_DAC_HPF</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;DAC Voice Cutoff&quot;</span><span class="p">,</span> <span class="n">da7210_dac_vf_cutoff</span><span class="p">),</span>

	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ADC HPF Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC_HPF</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;ADC HPF Cutoff&quot;</span><span class="p">,</span> <span class="n">da7210_adc_hpf_cutoff</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ADC Voice Mode Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC_HPF</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;ADC Voice Cutoff&quot;</span><span class="p">,</span> <span class="n">da7210_adc_vf_cutoff</span><span class="p">),</span>

	<span class="cm">/* Mute controls */</span>
	<span class="n">SOC_DOUBLE_R</span><span class="p">(</span><span class="s">&quot;Mic Capture Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_MIC_L</span><span class="p">,</span> <span class="n">DA7210_MIC_R</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux2 Capture Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_AUX2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;ADC Capture Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Digital Soft Mute Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_SOFTMUTE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Digital Soft Mute Rate&quot;</span><span class="p">,</span> <span class="n">DA7210_SOFTMUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Zero cross controls */</span>
	<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;Aux1 ZC Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_ZERO_CROSS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;In PGA ZC Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_ZERO_CROSS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;Lineout ZC Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_ZERO_CROSS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;Headphone ZC Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_ZERO_CROSS</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Headphone Class&quot;</span><span class="p">,</span> <span class="n">da7210_hp_mode_sel</span><span class="p">),</span>

	<span class="cm">/* ALC controls */</span>
	<span class="n">SOC_SINGLE_EXT</span><span class="p">(</span><span class="s">&quot;ALC Enable Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_ADC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">snd_soc_get_volsw</span><span class="p">,</span> <span class="n">da7210_put_alc_sw</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Capture Max Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_ALC_MAX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Capture Min Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_ALC_MIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Capture Noise Volume&quot;</span><span class="p">,</span> <span class="n">DA7210_ALC_NOIS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Capture Attack Rate&quot;</span><span class="p">,</span> <span class="n">DA7210_ALC_ATT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Capture Release Rate&quot;</span><span class="p">,</span> <span class="n">DA7210_ALC_REL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ALC Capture Release Delay&quot;</span><span class="p">,</span> <span class="n">DA7210_ALC_DEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">SOC_SINGLE_EXT</span><span class="p">(</span><span class="s">&quot;Noise Suppression Enable Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_CONTROL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="n">snd_soc_get_volsw</span><span class="p">,</span> <span class="n">da7210_put_noise_sup_sw</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * DAPM Controls</span>
<span class="cm"> *</span>
<span class="cm"> * Current DAPM implementation covers almost all codec components e.g. IOs,</span>
<span class="cm"> * mixers, PGAs,ADC and DAC.</span>
<span class="cm"> */</span>
<span class="cm">/* In Mixer Left */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">da7210_dapm_inmixl_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux1 Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux2 Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Outmix Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_L</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* In Mixer Right */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">da7210_dapm_inmixr_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_R</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_R</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux1 Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_R</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux2 Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_R</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Outmix Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_R</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Out Mixer Left */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">da7210_dapm_outmixl_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux1 Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux2 Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;INPGA Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;INPGA Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_L</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Out Mixer Right */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">da7210_dapm_outmixr_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux1 Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_R</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Aux2 Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_R</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;INPGA Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_R</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;INPGA Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_R</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_R</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Mono Mixer */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">da7210_dapm_monomix_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;INPGA Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUT2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;INPGA Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUT2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Outmix Right Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUT2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Outmix Left Switch&quot;</span><span class="p">,</span> <span class="n">DA7210_OUT2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* DAPM widgets */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">da7210_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Input Side */</span>
	<span class="cm">/* Input Lines */</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;MICL&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;MICR&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;AUX1L&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;AUX1R&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;AUX2&quot;</span><span class="p">),</span>

	<span class="cm">/* Input PGAs */</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Mic Left&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Mic Right&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Aux1 Left&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Aux1 Right&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Aux2 Mono&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;INPGA Left&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_L</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;INPGA Right&quot;</span><span class="p">,</span> <span class="n">DA7210_INMIX_R</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* MICBIAS */</span>
	<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;Mic Bias&quot;</span><span class="p">,</span> <span class="n">DA7210_MIC_L</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Input Mixers */</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;In Mixer Left&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">da7210_dapm_inmixl_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_dapm_inmixl_controls</span><span class="p">)),</span>

	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;In Mixer Right&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">da7210_dapm_inmixr_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_dapm_inmixr_controls</span><span class="p">)),</span>

	<span class="cm">/* ADCs */</span>
	<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;ADC Left&quot;</span><span class="p">,</span> <span class="s">&quot;Capture&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;ADC Right&quot;</span><span class="p">,</span> <span class="s">&quot;Capture&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

	<span class="cm">/* Output Side */</span>
	<span class="cm">/* DACs */</span>
	<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC Left&quot;</span><span class="p">,</span> <span class="s">&quot;Playback&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC Right&quot;</span><span class="p">,</span> <span class="s">&quot;Playback&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

	<span class="cm">/* Output Mixers */</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Out Mixer Left&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">da7210_dapm_outmixl_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_dapm_outmixl_controls</span><span class="p">)),</span>

	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Out Mixer Right&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">da7210_dapm_outmixr_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_dapm_outmixr_controls</span><span class="p">)),</span>

	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Mono Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">da7210_dapm_monomix_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_dapm_monomix_controls</span><span class="p">)),</span>

	<span class="cm">/* Output PGAs */</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;OUTPGA Left Enable&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_L</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;OUTPGA Right Enable&quot;</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_R</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Out1 Left&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Out1 Right&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Out2 Mono&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Headphone Left&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Headphone Right&quot;</span><span class="p">,</span> <span class="n">DA7210_STARTUP2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Output Lines */</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;OUT1L&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;OUT1R&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;HPL&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;HPR&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;OUT2&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* DAPM audio route definition */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">da7210_audio_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Dest       Connecting Widget    source */</span>
	<span class="cm">/* Input path */</span>
	<span class="p">{</span><span class="s">&quot;Mic Left&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;MICL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Mic Right&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;MICR&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Aux1 Left&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AUX1L&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Aux1 Right&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AUX1R&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Aux2 Mono&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AUX2&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;In Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;Mic Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Mic Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;In Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;Mic Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Mic Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;In Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;Aux1 Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Aux1 Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;In Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;Aux2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Aux2 Mono&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;In Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;Outmix Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Out Mixer Left&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;In Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;Mic Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Mic Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;In Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;Mic Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Mic Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;In Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;Aux1 Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Aux1 Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;In Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;Aux2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Aux2 Mono&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;In Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;Outmix Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Out Mixer Right&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;INPGA Left&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;In Mixer Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Left&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;INPGA Left&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;INPGA Right&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;In Mixer Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Right&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;INPGA Right&quot;</span><span class="p">},</span>

	<span class="cm">/* Output path */</span>
	<span class="p">{</span><span class="s">&quot;Out Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;Aux1 Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Aux1 Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Out Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;Aux2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Aux2 Mono&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Out Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Out Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Out Mixer Left&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Left&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Out Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;Aux1 Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Aux1 Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Out Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;Aux2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Aux2 Mono&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Out Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Out Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Out Mixer Right&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Right&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Mono Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Mono Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;INPGA Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Mono Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Outmix Right Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Out Mixer Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Mono Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Outmix Left Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Out Mixer Left&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;OUTPGA Left Enable&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Out Mixer Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;OUTPGA Right Enable&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Out Mixer Right&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Out1 Left&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;OUTPGA Left Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;OUT1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Out1 Left&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Out1 Right&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;OUTPGA Right Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;OUT1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Out1 Right&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Headphone Left&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;OUTPGA Left Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HPL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Headphone Left&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Headphone Right&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;OUTPGA Right Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HPR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Headphone Right&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Out2 Mono&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Mono Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;OUT2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Out2 Mono&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Codec private data */</span>
<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">regmap</span> <span class="o">*</span><span class="n">regmap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mclk_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">master</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">reg_default</span> <span class="n">da7210_reg_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x54</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x76</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">da7210_readable_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DA7210_A_HID_UNLOCK</span>:
	<span class="k">case</span> <span class="n">DA7210_A_TEST_UNLOCK</span>:
	<span class="k">case</span> <span class="n">DA7210_A_PLL1</span>:
	<span class="k">case</span> <span class="n">DA7210_A_CP_MODE</span>:
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">da7210_volatile_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DA7210_STATUS</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set PCM DAI word length.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">da7210_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="o">*</span><span class="n">da7210</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dai_cfg1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fs</span><span class="p">,</span> <span class="n">sysclk</span><span class="p">;</span>

	<span class="cm">/* set DAI source to Left and Right ADC */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAI_SRC_SEL</span><span class="p">,</span>
		     <span class="n">DA7210_DAI_OUT_R_SRC</span> <span class="o">|</span> <span class="n">DA7210_DAI_OUT_L_SRC</span><span class="p">);</span>

	<span class="cm">/* Enable DAI */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAI_CFG3</span><span class="p">,</span> <span class="n">DA7210_DAI_OE</span> <span class="o">|</span> <span class="n">DA7210_DAI_EN</span><span class="p">);</span>

	<span class="n">dai_cfg1</span> <span class="o">=</span> <span class="mh">0xFC</span> <span class="o">&amp;</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAI_CFG1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="n">dai_cfg1</span> <span class="o">|=</span> <span class="n">DA7210_DAI_WORD_S16_LE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S20_3LE</span>:
		<span class="n">dai_cfg1</span> <span class="o">|=</span> <span class="n">DA7210_DAI_WORD_S20_3LE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_LE</span>:
		<span class="n">dai_cfg1</span> <span class="o">|=</span> <span class="n">DA7210_DAI_WORD_S24_LE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span>:
		<span class="n">dai_cfg1</span> <span class="o">|=</span> <span class="n">DA7210_DAI_WORD_S32_LE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAI_CFG1</span><span class="p">,</span> <span class="n">dai_cfg1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8000</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_8000</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">3072000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11025</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_11025</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">2822400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12000</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_12000</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">3072000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16000</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_16000</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">3072000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">22050</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_22050</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">2822400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32000</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_32000</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">3072000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_44100</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">2822400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_48000</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">3072000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">88200</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_88200</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">2822400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>:
		<span class="n">fs</span>		<span class="o">=</span> <span class="n">DA7210_PLL_FS_96000</span><span class="p">;</span>
		<span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">3072000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable active mode */</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_STARTUP1</span><span class="p">,</span> <span class="n">DA7210_SC_MST_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL</span><span class="p">,</span> <span class="n">DA7210_PLL_FS_MASK</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">mclk_rate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">mclk_rate</span> <span class="o">!=</span> <span class="n">sysclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* PLL mode, disable PLL bypass */</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL_DIV3</span><span class="p">,</span> <span class="n">DA7210_PLL_BYP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PLL slave mode, also enable SRM */</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">DA7210_MCLK_SRM_EN</span> <span class="o">|</span>
						    <span class="n">DA7210_MCLK_DET_EN</span><span class="p">),</span>
						   <span class="p">(</span><span class="n">DA7210_MCLK_SRM_EN</span> <span class="o">|</span>
						    <span class="n">DA7210_MCLK_DET_EN</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* PLL bypass mode, enable PLL bypass and Auto Detection */</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL</span><span class="p">,</span> <span class="n">DA7210_MCLK_DET_EN</span><span class="p">,</span>
						       <span class="n">DA7210_MCLK_DET_EN</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL_DIV3</span><span class="p">,</span> <span class="n">DA7210_PLL_BYP</span><span class="p">,</span>
							    <span class="n">DA7210_PLL_BYP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Enable active mode */</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_STARTUP1</span><span class="p">,</span>
			    <span class="n">DA7210_SC_MST_EN</span><span class="p">,</span> <span class="n">DA7210_SC_MST_EN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set DAI mode and Format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">da7210_set_dai_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="o">*</span><span class="n">da7210</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dai_cfg1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dai_cfg3</span><span class="p">;</span>

	<span class="n">dai_cfg1</span> <span class="o">=</span> <span class="mh">0x7f</span> <span class="o">&amp;</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAI_CFG1</span><span class="p">);</span>
	<span class="n">dai_cfg3</span> <span class="o">=</span> <span class="mh">0xfc</span> <span class="o">&amp;</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAI_CFG3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DA7210_PLL_EN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL_DIV3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DA7210_PLL_BYP</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
		<span class="n">da7210</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dai_cfg1</span> <span class="o">|=</span> <span class="n">DA7210_DAI_MODE_MASTER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>:
		<span class="n">da7210</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dai_cfg1</span> <span class="o">|=</span> <span class="n">DA7210_DAI_MODE_SLAVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME</span>
<span class="cm">	 *</span>
<span class="cm">	 * It support I2S only now</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span>:
		<span class="n">dai_cfg3</span> <span class="o">|=</span> <span class="n">DA7210_DAI_FORMAT_I2SMODE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_LEFT_J</span>:
		<span class="n">dai_cfg3</span> <span class="o">|=</span> <span class="n">DA7210_DAI_FORMAT_LEFT_J</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_RIGHT_J</span>:
		<span class="n">dai_cfg3</span> <span class="o">|=</span> <span class="n">DA7210_DAI_FORMAT_RIGHT_J</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME</span>
<span class="cm">	 *</span>
<span class="cm">	 * It support 64bit data transmission only now</span>
<span class="cm">	 */</span>
	<span class="n">dai_cfg1</span> <span class="o">|=</span> <span class="n">DA7210_DAI_FLEN_64BIT</span><span class="p">;</span>

	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAI_CFG1</span><span class="p">,</span> <span class="n">dai_cfg1</span><span class="p">);</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAI_CFG3</span><span class="p">,</span> <span class="n">dai_cfg3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da7210_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mute_reg</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAC_HPF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span>
		<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAC_HPF</span><span class="p">,</span> <span class="n">mute_reg</span> <span class="o">|</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAC_HPF</span><span class="p">,</span> <span class="n">mute_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DA7210_FORMATS (SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S20_3LE |\</span>
<span class="cp">			SNDRV_PCM_FMTBIT_S24_LE | SNDRV_PCM_FMTBIT_S32_LE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da7210_set_dai_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">clk_id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="o">*</span><span class="n">da7210</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clk_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DA7210_CLKSRC_MCLK</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">12000000</span>:
		<span class="k">case</span> <span class="mi">13000000</span>:
		<span class="k">case</span> <span class="mi">13500000</span>:
		<span class="k">case</span> <span class="mi">14400000</span>:
		<span class="k">case</span> <span class="mi">19200000</span>:
		<span class="k">case</span> <span class="mi">19680000</span>:
		<span class="k">case</span> <span class="mi">19800000</span>:
			<span class="n">da7210</span><span class="o">-&gt;</span><span class="n">mclk_rate</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unsupported MCLK value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">freq</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown clock source %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clk_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * da7210_set_dai_pll	:Configure the codec PLL</span>
<span class="cm"> * @param codec_dai	: pointer to codec DAI</span>
<span class="cm"> * @param pll_id	: da7210 has only one pll, so pll_id is always zero</span>
<span class="cm"> * @param fref		: MCLK frequency, should be &lt; 20MHz</span>
<span class="cm"> * @param fout		: FsDM value, Refer page 44 &amp; 45 of datasheet</span>
<span class="cm"> * @return int		: Zero for success, negative error code for error</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Supported PLL input frequencies are 12MHz, 13MHz, 13.5MHz, 14.4MHz,</span>
<span class="cm"> *       19.2MHz, 19.6MHz and 19.8MHz</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">da7210_set_dai_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pll_id</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">source</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fref</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="o">*</span><span class="n">da7210</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">u8</span> <span class="n">pll_div1</span><span class="p">,</span> <span class="n">pll_div2</span><span class="p">,</span> <span class="n">pll_div3</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/* In slave mode, there is only one set of divisors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">fout</span> <span class="o">=</span> <span class="mi">2822400</span><span class="p">;</span>

	<span class="cm">/* Search pll div array for correct divisors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_pll_div</span><span class="p">);</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check fref, mode  and fout */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fref</span> <span class="o">==</span> <span class="n">da7210_pll_div</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">fref</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">==</span>  <span class="n">da7210_pll_div</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">fout</span> <span class="o">==</span> <span class="n">da7210_pll_div</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">fout</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* all match, pick up divisors */</span>
			<span class="n">pll_div1</span> <span class="o">=</span> <span class="n">da7210_pll_div</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">div1</span><span class="p">;</span>
			<span class="n">pll_div2</span> <span class="o">=</span> <span class="n">da7210_pll_div</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">div2</span><span class="p">;</span>
			<span class="n">pll_div3</span> <span class="o">=</span> <span class="n">da7210_pll_div</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">div3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_pll_div</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Disable active mode */</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_STARTUP1</span><span class="p">,</span> <span class="n">DA7210_SC_MST_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Write PLL dividers */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL_DIV1</span><span class="p">,</span> <span class="n">pll_div1</span><span class="p">);</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL_DIV2</span><span class="p">,</span> <span class="n">pll_div2</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL_DIV3</span><span class="p">,</span>
				   <span class="n">DA7210_PLL_DIV_L_MASK</span><span class="p">,</span> <span class="n">pll_div3</span><span class="p">);</span>

	<span class="cm">/* Enable PLL */</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL</span><span class="p">,</span> <span class="n">DA7210_PLL_EN</span><span class="p">,</span> <span class="n">DA7210_PLL_EN</span><span class="p">);</span>

	<span class="cm">/* Enable active mode */</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_STARTUP1</span><span class="p">,</span> <span class="n">DA7210_SC_MST_EN</span><span class="p">,</span>
						    <span class="n">DA7210_SC_MST_EN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unsupported PLL input frequency %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fref</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DAI operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">da7210_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">da7210_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">da7210_set_dai_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_sysclk</span>	<span class="o">=</span> <span class="n">da7210_set_dai_sysclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pll</span>	<span class="o">=</span> <span class="n">da7210_set_dai_pll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">digital_mute</span>	<span class="o">=</span> <span class="n">da7210_mute</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">da7210_dai</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;da7210-hifi&quot;</span><span class="p">,</span>
	<span class="cm">/* playback capabilities */</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;Playback&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_96000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">DA7210_FORMATS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* capture capabilities */</span>
	<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;Capture&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_96000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">DA7210_FORMATS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da7210_dai_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">symmetric_rates</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da7210_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="o">*</span><span class="n">da7210</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DA7210 Audio Codec %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DA7210_VERSION</span><span class="p">);</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">control_data</span> <span class="o">=</span> <span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_codec_set_cache_io</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SND_SOC_REGMAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set cache I/O: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">da7210</span><span class="o">-&gt;</span><span class="n">mclk_rate</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* This will be set from set_sysclk() */</span>
	<span class="n">da7210</span><span class="o">-&gt;</span><span class="n">master</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* This will be set from set_fmt() */</span>

	<span class="cm">/* Enable internal regulator &amp; bias current */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_CONTROL</span><span class="p">,</span> <span class="n">DA7210_REG_EN</span> <span class="o">|</span> <span class="n">DA7210_BIAS_EN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ADC settings</span>
<span class="cm">	 */</span>

	<span class="cm">/* Enable Left &amp; Right MIC PGA and Mic Bias */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_MIC_L</span><span class="p">,</span> <span class="n">DA7210_MIC_L_EN</span> <span class="o">|</span> <span class="n">DA7210_MICBIAS_EN</span><span class="p">);</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_MIC_R</span><span class="p">,</span> <span class="n">DA7210_MIC_R_EN</span><span class="p">);</span>

	<span class="cm">/* Enable Left and Right input PGA */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_INMIX_L</span><span class="p">,</span> <span class="n">DA7210_IN_L_EN</span><span class="p">);</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_INMIX_R</span><span class="p">,</span> <span class="n">DA7210_IN_R_EN</span><span class="p">);</span>

	<span class="cm">/* Enable Left and Right ADC */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_ADC</span><span class="p">,</span> <span class="n">DA7210_ADC_L_EN</span> <span class="o">|</span> <span class="n">DA7210_ADC_R_EN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * DAC settings</span>
<span class="cm">	 */</span>

	<span class="cm">/* Enable Left and Right DAC */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_DAC_SEL</span><span class="p">,</span>
		     <span class="n">DA7210_DAC_L_SRC_DAI_L</span> <span class="o">|</span> <span class="n">DA7210_DAC_L_EN</span> <span class="o">|</span>
		     <span class="n">DA7210_DAC_R_SRC_DAI_R</span> <span class="o">|</span> <span class="n">DA7210_DAC_R_EN</span><span class="p">);</span>

	<span class="cm">/* Enable Left and Right out PGA */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_L</span><span class="p">,</span> <span class="n">DA7210_OUT_L_EN</span><span class="p">);</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_OUTMIX_R</span><span class="p">,</span> <span class="n">DA7210_OUT_R_EN</span><span class="p">);</span>

	<span class="cm">/* Enable Left and Right HeadPhone PGA */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_HP_CFG</span><span class="p">,</span>
		     <span class="n">DA7210_HP_2CAP_MODE</span> <span class="o">|</span> <span class="n">DA7210_HP_SENSE_EN</span> <span class="o">|</span>
		     <span class="n">DA7210_HP_L_EN</span> <span class="o">|</span> <span class="n">DA7210_HP_MODE</span> <span class="o">|</span> <span class="n">DA7210_HP_R_EN</span><span class="p">);</span>

	<span class="cm">/* Enable ramp mode for DAC gain update */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_SOFTMUTE</span><span class="p">,</span> <span class="n">DA7210_RAMP_EN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For DA7210 codec, there are two ways to enable/disable analog IOs</span>
<span class="cm">	 * and ADC/DAC,</span>
<span class="cm">	 * (1) Using &quot;Enable Bit&quot; of register associated with that IO</span>
<span class="cm">	 * (or ADC/DAC)</span>
<span class="cm">	 *	e.g. Mic Left can be enabled using bit 7 of MIC_L(0x7) reg</span>
<span class="cm">	 *</span>
<span class="cm">	 * (2) Using &quot;Standby Bit&quot; of STARTUP2 or STARTUP3 register</span>
<span class="cm">	 *	e.g. Mic left can be put to STANDBY using bit 0 of STARTUP3(0x5)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Out of these two methods, the one using STANDBY bits is preferred</span>
<span class="cm">	 * way to enable/disable individual blocks. This is because STANDBY</span>
<span class="cm">	 * registers are part of system controller which allows system power</span>
<span class="cm">	 * up/down in a controlled, pop-free manner. Also, as per application</span>
<span class="cm">	 * note of DA7210, STANDBY register bits are only effective if a</span>
<span class="cm">	 * particular IO (or ADC/DAC) is already enabled using enable/disable</span>
<span class="cm">	 * register bits. Keeping these things in mind, current DAPM</span>
<span class="cm">	 * implementation manipulates only STANDBY bits.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Overall implementation can be outlined as below,</span>
<span class="cm">	 *</span>
<span class="cm">	 * - &quot;Enable bit&quot; of an IO or ADC/DAC is used to enable it in probe()</span>
<span class="cm">	 * - &quot;STANDBY bit&quot; is controlled by DAPM</span>
<span class="cm">	 */</span>

	<span class="cm">/* Enable Line out amplifiers */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_OUT1_L</span><span class="p">,</span> <span class="n">DA7210_OUT1_L_EN</span><span class="p">);</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_OUT1_R</span><span class="p">,</span> <span class="n">DA7210_OUT1_R_EN</span><span class="p">);</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_OUT2</span><span class="p">,</span> <span class="n">DA7210_OUT2_EN</span> <span class="o">|</span>
		     <span class="n">DA7210_OUT2_OUTMIX_L</span> <span class="o">|</span> <span class="n">DA7210_OUT2_OUTMIX_R</span><span class="p">);</span>

	<span class="cm">/* Enable Aux1 */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_AUX1_L</span><span class="p">,</span> <span class="n">DA7210_AUX1_L_EN</span><span class="p">);</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_AUX1_R</span><span class="p">,</span> <span class="n">DA7210_AUX1_R_EN</span><span class="p">);</span>
	<span class="cm">/* Enable Aux2 */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_AUX2</span><span class="p">,</span> <span class="n">DA7210_AUX2_EN</span><span class="p">);</span>

	<span class="cm">/* Set PLL Master clock range 10-20 MHz, enable PLL bypass */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL_DIV3</span><span class="p">,</span> <span class="n">DA7210_MCLK_RANGE_10_20_MHZ</span> <span class="o">|</span>
					      <span class="n">DA7210_PLL_BYP</span><span class="p">);</span>

	<span class="cm">/* Diable PLL and bypass it */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_PLL</span><span class="p">,</span> <span class="n">DA7210_PLL_FS_48000</span><span class="p">);</span>

	<span class="cm">/* Activate all enabled subsystem */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">DA7210_STARTUP1</span><span class="p">,</span> <span class="n">DA7210_SC_MST_EN</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DA7210 Audio Codec %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DA7210_VERSION</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_codec_driver</span> <span class="n">soc_codec_dev_da7210</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>			<span class="o">=</span> <span class="n">da7210_probe</span><span class="p">,</span>

	<span class="p">.</span><span class="n">controls</span>		<span class="o">=</span> <span class="n">da7210_snd_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_controls</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_snd_controls</span><span class="p">),</span>

	<span class="p">.</span><span class="n">dapm_widgets</span>		<span class="o">=</span> <span class="n">da7210_dapm_widgets</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_dapm_widgets</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_dapm_widgets</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dapm_routes</span>		<span class="o">=</span> <span class="n">da7210_audio_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_dapm_routes</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_audio_map</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_I2C) || defined(CONFIG_I2C_MODULE)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">reg_default</span> <span class="n">da7210_regmap_i2c_patch</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="cm">/* System controller master disable */</span>
	<span class="p">{</span> <span class="n">DA7210_STARTUP1</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="cm">/* Set PLL Master clock range 10-20 MHz */</span>
	<span class="p">{</span> <span class="n">DA7210_PLL_DIV3</span><span class="p">,</span> <span class="n">DA7210_MCLK_RANGE_10_20_MHZ</span> <span class="p">},</span>

	<span class="cm">/* to unlock */</span>
	<span class="p">{</span> <span class="n">DA7210_A_HID_UNLOCK</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">DA7210_A_TEST_UNLOCK</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">DA7210_A_PLL1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">DA7210_A_CP_MODE</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">},</span>
	<span class="cm">/* to re-lock */</span>
	<span class="p">{</span> <span class="n">DA7210_A_HID_UNLOCK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">DA7210_A_TEST_UNLOCK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regmap_config</span> <span class="n">da7210_regmap_config_i2c</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reg_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">val_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>

	<span class="p">.</span><span class="n">reg_defaults</span> <span class="o">=</span> <span class="n">da7210_reg_defaults</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_reg_defaults</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_reg_defaults</span><span class="p">),</span>
	<span class="p">.</span><span class="n">volatile_reg</span> <span class="o">=</span> <span class="n">da7210_volatile_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readable_reg</span> <span class="o">=</span> <span class="n">da7210_readable_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_type</span> <span class="o">=</span> <span class="n">REGCACHE_RBTREE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">da7210_i2c_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span>
			   	      <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="o">*</span><span class="n">da7210</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">da7210</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">da7210_priv</span><span class="p">),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">da7210</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">da7210</span><span class="p">);</span>

	<span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span> <span class="o">=</span> <span class="n">regmap_init_i2c</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da7210_regmap_config_i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;regmap_init() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_register_patch</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">da7210_regmap_i2c_patch</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_regmap_i2c_patch</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to apply regmap patch: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span>  <span class="n">snd_soc_register_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">soc_codec_dev_da7210</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da7210_dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to register codec: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_regmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_regmap:</span>
	<span class="n">regmap_exit</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">da7210_i2c_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="o">*</span><span class="n">da7210</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">snd_soc_unregister_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regmap_exit</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">da7210_i2c_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;da7210&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">da7210_i2c_id</span><span class="p">);</span>

<span class="cm">/* I2C codec control layer */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">da7210_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;da7210&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">da7210_i2c_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">da7210_i2c_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">da7210_i2c_id</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_SPI_MASTER)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">reg_default</span> <span class="n">da7210_regmap_spi_patch</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Dummy read to give two pulses over nCS for SPI */</span>
	<span class="p">{</span> <span class="n">DA7210_AUX2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DA7210_AUX2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>

	<span class="cm">/* System controller master disable */</span>
	<span class="p">{</span> <span class="n">DA7210_STARTUP1</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="cm">/* Set PLL Master clock range 10-20 MHz */</span>
	<span class="p">{</span> <span class="n">DA7210_PLL_DIV3</span><span class="p">,</span> <span class="n">DA7210_MCLK_RANGE_10_20_MHZ</span> <span class="p">},</span>

	<span class="cm">/* to set PAGE1 of SPI register space */</span>
	<span class="p">{</span> <span class="n">DA7210_PAGE_CONTROL</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="cm">/* to unlock */</span>
	<span class="p">{</span> <span class="n">DA7210_A_HID_UNLOCK</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">DA7210_A_TEST_UNLOCK</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">DA7210_A_PLL1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">DA7210_A_CP_MODE</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">},</span>
	<span class="cm">/* to re-lock */</span>
	<span class="p">{</span> <span class="n">DA7210_A_HID_UNLOCK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">DA7210_A_TEST_UNLOCK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="cm">/* to set back PAGE0 of SPI register space */</span>
	<span class="p">{</span> <span class="n">DA7210_PAGE_CONTROL</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regmap_config</span> <span class="n">da7210_regmap_config_spi</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reg_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">val_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_flag_mask</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_flag_mask</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="p">.</span><span class="n">reg_defaults</span> <span class="o">=</span> <span class="n">da7210_reg_defaults</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_reg_defaults</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_reg_defaults</span><span class="p">),</span>
	<span class="p">.</span><span class="n">volatile_reg</span> <span class="o">=</span> <span class="n">da7210_volatile_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readable_reg</span> <span class="o">=</span> <span class="n">da7210_readable_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_type</span> <span class="o">=</span> <span class="n">REGCACHE_RBTREE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">da7210_spi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="o">*</span><span class="n">da7210</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">da7210</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">da7210_priv</span><span class="p">),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">da7210</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spi_set_drvdata</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="n">da7210</span><span class="p">);</span>
	<span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span> <span class="o">=</span> <span class="n">devm_regmap_init_spi</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da7210_regmap_config_spi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to register regmap: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_register_patch</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">da7210_regmap_spi_patch</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da7210_regmap_spi_patch</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to apply regmap patch: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span>  <span class="n">snd_soc_register_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">soc_codec_dev_da7210</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da7210_dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_regmap</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_regmap:</span>
	<span class="n">regmap_exit</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">da7210_spi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da7210_priv</span> <span class="o">*</span><span class="n">da7210</span> <span class="o">=</span> <span class="n">spi_get_drvdata</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
	<span class="n">snd_soc_unregister_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regmap_exit</span><span class="p">(</span><span class="n">da7210</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_driver</span> <span class="n">da7210_spi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;da7210&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">da7210_spi_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">da7210_spi_remove</span><span class="p">)</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">da7210_modinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_I2C) || defined(CONFIG_I2C_MODULE)</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da7210_i2c_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_SPI_MASTER)</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da7210_spi_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to register da7210 SPI driver: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">da7210_modinit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">da7210_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_I2C) || defined(CONFIG_I2C_MODULE)</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da7210_i2c_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_SPI_MASTER)</span>
	<span class="n">spi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da7210_spi_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">da7210_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ASoC DA7210 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Chen, Kuninori Morimoto&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
