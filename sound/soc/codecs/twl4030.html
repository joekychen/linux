<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › codecs › twl4030.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>twl4030.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ALSA SoC TWL4030 codec driver</span>
<span class="cm"> *</span>
<span class="cm"> * Author:      Steve Sakoman, &lt;steve@sakoman.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/twl.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>

<span class="cm">/* Register descriptions are here */</span>
<span class="cp">#include &lt;linux/mfd/twl4030-audio.h&gt;</span>

<span class="cm">/* Shadow register used by the audio driver */</span>
<span class="cp">#define TWL4030_REG_SW_SHADOW		0x4A</span>
<span class="cp">#define TWL4030_CACHEREGNUM	(TWL4030_REG_SW_SHADOW + 1)</span>

<span class="cm">/* TWL4030_REG_SW_SHADOW (0x4A) Fields */</span>
<span class="cp">#define TWL4030_HFL_EN			0x01</span>
<span class="cp">#define TWL4030_HFR_EN			0x02</span>

<span class="cm">/*</span>
<span class="cm"> * twl4030 register cache &amp; default register settings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">twl4030_reg</span><span class="p">[</span><span class="n">TWL4030_CACHEREGNUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* this register not used		*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_CODEC_MODE		(0x1)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_OPTION		(0x2)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_UNKNOWN		(0x3)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_MICBIAS_CTL	(0x4)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_ANAMICL		(0x5)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_ANAMICR		(0x6)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_AVADC_CTL		(0x7)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_ADCMICSEL		(0x8)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_DIGMIXING		(0x9)	*/</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="cm">/* REG_ATXL1PGA		(0xA)	*/</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="cm">/* REG_ATXR1PGA		(0xB)	*/</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="cm">/* REG_AVTXL2PGA		(0xC)	*/</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="cm">/* REG_AVTXR2PGA		(0xD)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_AUDIO_IF		(0xE)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_VOICE_IF		(0xF)	*/</span>
	<span class="mh">0x3f</span><span class="p">,</span> <span class="cm">/* REG_ARXR1PGA		(0x10)	*/</span>
	<span class="mh">0x3f</span><span class="p">,</span> <span class="cm">/* REG_ARXL1PGA		(0x11)	*/</span>
	<span class="mh">0x3f</span><span class="p">,</span> <span class="cm">/* REG_ARXR2PGA		(0x12)	*/</span>
	<span class="mh">0x3f</span><span class="p">,</span> <span class="cm">/* REG_ARXL2PGA		(0x13)	*/</span>
	<span class="mh">0x25</span><span class="p">,</span> <span class="cm">/* REG_VRXPGA		(0x14)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_VSTPGA		(0x15)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_VRX2ARXPGA		(0x16)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_AVDAC_CTL		(0x17)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_ARX2VTXPGA		(0x18)	*/</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="cm">/* REG_ARXL1_APGA_CTL	(0x19)	*/</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="cm">/* REG_ARXR1_APGA_CTL	(0x1A)	*/</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="cm">/* REG_ARXL2_APGA_CTL	(0x1B)	*/</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="cm">/* REG_ARXR2_APGA_CTL	(0x1C)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_ATX2ARXPGA		(0x1D)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_BT_IF		(0x1E)	*/</span>
	<span class="mh">0x55</span><span class="p">,</span> <span class="cm">/* REG_BTPGA		(0x1F)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_BTSTPGA		(0x20)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_EAR_CTL		(0x21)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_HS_SEL		(0x22)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_HS_GAIN_SET	(0x23)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_HS_POPN_SET	(0x24)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_PREDL_CTL		(0x25)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_PREDR_CTL		(0x26)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_PRECKL_CTL		(0x27)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_PRECKR_CTL		(0x28)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_HFL_CTL		(0x29)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_HFR_CTL		(0x2A)	*/</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="cm">/* REG_ALC_CTL		(0x2B)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_ALC_SET1		(0x2C)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_ALC_SET2		(0x2D)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_BOOST_CTL		(0x2E)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_SOFTVOL_CTL	(0x2F)	*/</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="cm">/* REG_DTMF_FREQSEL	(0x30)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_DTMF_TONEXT1H	(0x31)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_DTMF_TONEXT1L	(0x32)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_DTMF_TONEXT2H	(0x33)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_DTMF_TONEXT2L	(0x34)	*/</span>
	<span class="mh">0x79</span><span class="p">,</span> <span class="cm">/* REG_DTMF_TONOFF	(0x35)	*/</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="cm">/* REG_DTMF_WANONOFF	(0x36)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_I2S_RX_SCRAMBLE_H	(0x37)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_I2S_RX_SCRAMBLE_M	(0x38)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_I2S_RX_SCRAMBLE_L	(0x39)	*/</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="cm">/* REG_APLL_CTL		(0x3A)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_DTMF_CTL		(0x3B)	*/</span>
	<span class="mh">0x44</span><span class="p">,</span> <span class="cm">/* REG_DTMF_PGA_CTL2	(0x3C)	*/</span>
	<span class="mh">0x69</span><span class="p">,</span> <span class="cm">/* REG_DTMF_PGA_CTL1	(0x3D)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_MISC_SET_1		(0x3E)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_PCMBTMUX		(0x3F)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* not used		(0x40)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* not used		(0x41)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* not used		(0x42)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_RX_PATH_SEL	(0x43)	*/</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="cm">/* REG_VDL_APGA_CTL	(0x44)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_VIBRA_CTL		(0x45)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_VIBRA_SET		(0x46)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_VIBRA_PWM_SET	(0x47)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_ANAMIC_GAIN	(0x48)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_MISC_SET_2		(0x49)	*/</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* REG_SW_SHADOW		(0x4A)	- Shadow, non HW register */</span>
<span class="p">};</span>

<span class="cm">/* codec private data */</span>
<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="n">codec</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec_powered</span><span class="p">;</span>

	<span class="cm">/* reference counts of AIF/APLL users */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">apll_enabled</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">master_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">slave_substream</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">configured</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sample_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sysclk</span><span class="p">;</span>

	<span class="cm">/* Output (with associated amp) states */</span>
	<span class="n">u8</span> <span class="n">hsl_enabled</span><span class="p">,</span> <span class="n">hsr_enabled</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">earpiece_enabled</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">predrivel_enabled</span><span class="p">,</span> <span class="n">predriver_enabled</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">carkitl_enabled</span><span class="p">,</span> <span class="n">carkitr_enabled</span><span class="p">;</span>

	<span class="cm">/* Delay needed after enabling the digimic interface */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">digimic_delay</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * read twl4030 register cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">twl4030_read_reg_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">TWL4030_CACHEREGNUM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write twl4030 register cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">twl4030_write_reg_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
						<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">TWL4030_CACHEREGNUM</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cache</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write to the twl4030 register space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">write_to_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">twl4030_write_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="n">TWL4030_REG_SW_SHADOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Decide if the given register can be written */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TWL4030_REG_EAR_CTL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">earpiece_enabled</span><span class="p">)</span>
				<span class="n">write_to_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TWL4030_REG_PREDL_CTL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">predrivel_enabled</span><span class="p">)</span>
				<span class="n">write_to_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TWL4030_REG_PREDR_CTL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">predriver_enabled</span><span class="p">)</span>
				<span class="n">write_to_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TWL4030_REG_PRECKL_CTL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">carkitl_enabled</span><span class="p">)</span>
				<span class="n">write_to_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TWL4030_REG_PRECKR_CTL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">carkitr_enabled</span><span class="p">)</span>
				<span class="n">write_to_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TWL4030_REG_HS_GAIN_SET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsl_enabled</span> <span class="o">||</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsr_enabled</span><span class="p">)</span>
				<span class="n">write_to_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* All other register can be written */</span>
			<span class="n">write_to_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_to_reg</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_AUDIO_VOICE</span><span class="p">,</span>
						    <span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">twl4030_wait_ms</span><span class="p">(</span><span class="kt">int</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">time</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">time</span> <span class="o">+</span> <span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_codec_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">codec_powered</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">twl4030_audio_enable_resource</span><span class="p">(</span><span class="n">TWL4030_AUDIO_RES_POWER</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">twl4030_audio_disable_resource</span><span class="p">(</span><span class="n">TWL4030_AUDIO_RES_POWER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">twl4030_write_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">codec_powered</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* REVISIT: this delay is present in TI sample drivers */</span>
	<span class="cm">/* but there seems to be no TRM requirement for it     */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">twl4030_check_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">difference</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Checking TWL audio default configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TWL4030_REG_MISC_SET_2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">twl_i2c_read_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_AUDIO_VOICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">twl4030_reg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">difference</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Reg 0x%02x: chip: 0x%02x driver: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">twl4030_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Found %d non-matching registers. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">difference</span><span class="p">,</span> <span class="n">difference</span> <span class="o">?</span> <span class="s">&quot;Not OK&quot;</span> <span class="o">:</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">twl4030_reset_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set all audio section registers to reasonable defaults */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TWL4030_REG_OPTION</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TWL4030_REG_MISC_SET_2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">TWL4030_REG_APLL_CTL</span><span class="p">)</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">twl4030_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_init_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_codec_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">byte</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check defaults, if instructed before anything else */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">check_defaults</span><span class="p">)</span>
		<span class="n">twl4030_check_defaults</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="cm">/* Reset registers, if no setup data or if instructed to do so */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span> <span class="o">||</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_registers</span><span class="p">))</span>
		<span class="n">twl4030_reset_registers</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="cm">/* Refresh APLL_CTL register from HW */</span>
	<span class="n">twl_i2c_read_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_AUDIO_VOICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span>
			    <span class="n">TWL4030_REG_APLL_CTL</span><span class="p">);</span>
	<span class="n">twl4030_write_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_APLL_CTL</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

	<span class="cm">/* anti-pop when changing analog gain */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_MISC_SET_1</span><span class="p">);</span>
	<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_MISC_SET_1</span><span class="p">,</span>
		<span class="n">reg</span> <span class="o">|</span> <span class="n">TWL4030_SMOOTH_ANAVOL_EN</span><span class="p">);</span>

	<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_OPTION</span><span class="p">,</span>
		<span class="n">TWL4030_ATXL1_EN</span> <span class="o">|</span> <span class="n">TWL4030_ATXR1_EN</span> <span class="o">|</span>
		<span class="n">TWL4030_ARXL2_EN</span> <span class="o">|</span> <span class="n">TWL4030_ARXR2_EN</span><span class="p">);</span>

	<span class="cm">/* REG_ARXR2_APGA_CTL reset according to the TRM: 0dB, DA_EN */</span>
	<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR2_APGA_CTL</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>

	<span class="cm">/* Machine dependent setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">digimic_delay</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">digimic_delay</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_RAMP_DELAY</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ramp_delay_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">twl4030_write_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* initiate offset cancellation */</span>
	<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_ANAMICL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_OFFSET_CNCL_SEL</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">offset_cncl_path</span><span class="p">;</span>
	<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_ANAMICL</span><span class="p">,</span>
		<span class="n">reg</span> <span class="o">|</span> <span class="n">TWL4030_CNCL_OFFSET_START</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for offset cancellation to complete.</span>
<span class="cm">	 * Since this takes a while, do not slam the i2c.</span>
<span class="cm">	 * Start polling the status after ~20ms.</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="n">twl_i2c_read_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_AUDIO_VOICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span>
				    <span class="n">TWL4030_REG_ANAMICL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">((</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="n">TWL4030_CNCL_OFFSET_START</span><span class="p">)</span> <span class="o">==</span>
		  <span class="n">TWL4030_CNCL_OFFSET_START</span><span class="p">));</span>

	<span class="cm">/* Make sure that the reg_cache has the same value as the HW */</span>
	<span class="n">twl4030_write_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_ANAMICL</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

	<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_apll_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">apll_enabled</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">apll_enabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">twl4030_audio_enable_resource</span><span class="p">(</span>
							<span class="n">TWL4030_AUDIO_RES_APLL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">apll_enabled</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">apll_enabled</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">twl4030_audio_disable_resource</span><span class="p">(</span>
							<span class="n">TWL4030_AUDIO_RES_APLL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">twl4030_write_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_APLL_CTL</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Earpiece */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_earpiece_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_EAR_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_EAR_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_EAR_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_EAR_CTL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* PreDrive Left */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_predrivel_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDL_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDL_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDL_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDL_CTL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* PreDrive Right */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_predriver_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDR_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDR_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDR_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDR_CTL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Headset Left */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_hsol_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_SEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_SEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_SEL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Headset Right */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_hsor_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_SEL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_SEL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_SEL</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Carkit Left */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_carkitl_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PRECKL_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PRECKL_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PRECKL_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Carkit Right */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_carkitr_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PRECKR_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PRECKR_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_PRECKR_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Handsfree Left */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_handsfreel_texts</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_handsfreel_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_HFL_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_handsfreel_texts</span><span class="p">),</span>
			<span class="n">twl4030_handsfreel_texts</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_handsfreel_control</span> <span class="o">=</span>
<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;Route&quot;</span><span class="p">,</span> <span class="n">twl4030_handsfreel_enum</span><span class="p">);</span>

<span class="cm">/* Handsfree Left virtual mute */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_handsfreelmute_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_SW_SHADOW</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Handsfree Right */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_handsfreer_texts</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_handsfreer_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_HFR_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_handsfreer_texts</span><span class="p">),</span>
			<span class="n">twl4030_handsfreer_texts</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_handsfreer_control</span> <span class="o">=</span>
<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;Route&quot;</span><span class="p">,</span> <span class="n">twl4030_handsfreer_enum</span><span class="p">);</span>

<span class="cm">/* Handsfree Right virtual mute */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_handsfreermute_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_SW_SHADOW</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Vibra */</span>
<span class="cm">/* Vibra audio path selection */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_vibra_texts</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_vibra_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_VIBRA_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_vibra_texts</span><span class="p">),</span>
			<span class="n">twl4030_vibra_texts</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_vibra_control</span> <span class="o">=</span>
<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;Route&quot;</span><span class="p">,</span> <span class="n">twl4030_vibra_enum</span><span class="p">);</span>

<span class="cm">/* Vibra path selection: local vibrator (PWM) or audio driven */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_vibrapath_texts</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;Local vibrator&quot;</span><span class="p">,</span> <span class="s">&quot;Audio&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_vibrapath_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_VIBRA_CTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_vibrapath_texts</span><span class="p">),</span>
			<span class="n">twl4030_vibrapath_texts</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_vibrapath_control</span> <span class="o">=</span>
<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;Route&quot;</span><span class="p">,</span> <span class="n">twl4030_vibrapath_enum</span><span class="p">);</span>

<span class="cm">/* Left analog microphone selection */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_analoglmic_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Main Mic Capture Switch&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ANAMICL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Headset Mic Capture Switch&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ANAMICL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AUXL Capture Switch&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ANAMICL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Carkit Mic Capture Switch&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ANAMICL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Right analog microphone selection */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_analogrmic_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Sub Mic Capture Switch&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_ANAMICR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AUXR Capture Switch&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_ANAMICR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* TX1 L/R Analog/Digital microphone selection */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_micpathtx1_texts</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;Analog&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic0&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_micpathtx1_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_ADCMICSEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_micpathtx1_texts</span><span class="p">),</span>
			<span class="n">twl4030_micpathtx1_texts</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_micpathtx1_control</span> <span class="o">=</span>
<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;Route&quot;</span><span class="p">,</span> <span class="n">twl4030_micpathtx1_enum</span><span class="p">);</span>

<span class="cm">/* TX2 L/R Analog/Digital microphone selection */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_micpathtx2_texts</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;Analog&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic1&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_micpathtx2_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_ADCMICSEL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_micpathtx2_texts</span><span class="p">),</span>
			<span class="n">twl4030_micpathtx2_texts</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_micpathtx2_control</span> <span class="o">=</span>
<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;Route&quot;</span><span class="p">,</span> <span class="n">twl4030_micpathtx2_enum</span><span class="p">);</span>

<span class="cm">/* Analog bypass for AudioR1 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_abypassr1_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR1_APGA_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Analog bypass for AudioL1 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_abypassl1_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXL1_APGA_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Analog bypass for AudioR2 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_abypassr2_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR2_APGA_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Analog bypass for AudioL2 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_abypassl2_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXL2_APGA_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Analog bypass for Voice */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_abypassv_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_VDL_APGA_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Digital bypass gain, mute instead of -30dB */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">twl4030_dapm_dbypass_tlv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TLV_DB_RANGE_HEAD</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">2400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">TLV_DB_SCALE_ITEM</span><span class="p">(</span><span class="o">-</span><span class="mi">1800</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Digital bypass left (TX1L -&gt; RX2L) */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_dbypassl_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;Volume&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ATX2ARXPGA</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">twl4030_dapm_dbypass_tlv</span><span class="p">);</span>

<span class="cm">/* Digital bypass right (TX1R -&gt; RX2R) */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_dbypassr_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;Volume&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ATX2ARXPGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">twl4030_dapm_dbypass_tlv</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Voice Sidetone GAIN volume control:</span>
<span class="cm"> * from -51 to -10 dB in 1 dB steps (mute instead of -51 dB)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">twl4030_dapm_dbypassv_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">5100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cm">/* Digital bypass voice: sidetone (VUL -&gt; VDL)*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_dapm_dbypassv_control</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;Volume&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_VSTPGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">twl4030_dapm_dbypassv_tlv</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Output PGA builder:</span>
<span class="cm"> * Handle the muting and unmuting of the given output (turning off the</span>
<span class="cm"> * amplifier associated with the output pin)</span>
<span class="cm"> * On mute bypass the reg_cache and write 0 to the register</span>
<span class="cm"> * On unmute: restore the register content from the reg_cache</span>
<span class="cm"> * Outputs handled in this way:  Earpiece, PreDrivL/R, CarkitL/R</span>
<span class="cm"> */</span>
<span class="cp">#define TWL4030_OUTPUT_PGA(pin_name, reg, mask)				\</span>
<span class="cp">static int pin_name##pga_event(struct snd_soc_dapm_widget *w,		\</span>
<span class="cp">		struct snd_kcontrol *kcontrol, int event)		\</span>
<span class="cp">{									\</span>
<span class="cp">	struct twl4030_priv *twl4030 = snd_soc_codec_get_drvdata(w-&gt;codec); \</span>
<span class="cp">									\</span>
<span class="cp">	switch (event) {						\</span>
<span class="cp">	case SND_SOC_DAPM_POST_PMU:					\</span>
<span class="cp">		twl4030-&gt;pin_name##_enabled = 1;			\</span>
<span class="cp">		twl4030_write(w-&gt;codec, reg,				\</span>
<span class="cp">			twl4030_read_reg_cache(w-&gt;codec, reg));		\</span>
<span class="cp">		break;							\</span>
<span class="cp">	case SND_SOC_DAPM_POST_PMD:					\</span>
<span class="cp">		twl4030-&gt;pin_name##_enabled = 0;			\</span>
<span class="cp">		twl_i2c_write_u8(TWL4030_MODULE_AUDIO_VOICE,		\</span>
<span class="cp">					0, reg);			\</span>
<span class="cp">		break;							\</span>
<span class="cp">	}								\</span>
<span class="cp">	return 0;							\</span>
<span class="cp">}</span>

<span class="n">TWL4030_OUTPUT_PGA</span><span class="p">(</span><span class="n">earpiece</span><span class="p">,</span> <span class="n">TWL4030_REG_EAR_CTL</span><span class="p">,</span> <span class="n">TWL4030_EAR_GAIN</span><span class="p">);</span>
<span class="n">TWL4030_OUTPUT_PGA</span><span class="p">(</span><span class="n">predrivel</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDL_CTL</span><span class="p">,</span> <span class="n">TWL4030_PREDL_GAIN</span><span class="p">);</span>
<span class="n">TWL4030_OUTPUT_PGA</span><span class="p">(</span><span class="n">predriver</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDR_CTL</span><span class="p">,</span> <span class="n">TWL4030_PREDR_GAIN</span><span class="p">);</span>
<span class="n">TWL4030_OUTPUT_PGA</span><span class="p">(</span><span class="n">carkitl</span><span class="p">,</span> <span class="n">TWL4030_REG_PRECKL_CTL</span><span class="p">,</span> <span class="n">TWL4030_PRECKL_GAIN</span><span class="p">);</span>
<span class="n">TWL4030_OUTPUT_PGA</span><span class="p">(</span><span class="n">carkitr</span><span class="p">,</span> <span class="n">TWL4030_REG_PRECKR_CTL</span><span class="p">,</span> <span class="n">TWL4030_PRECKR_GAIN</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handsfree_ramp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ramp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hs_ctl</span><span class="p">;</span>

	<span class="n">hs_ctl</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ramp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HF ramp-up */</span>
		<span class="n">hs_ctl</span> <span class="o">|=</span> <span class="n">TWL4030_HF_CTL_REF_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">hs_ctl</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">hs_ctl</span> <span class="o">|=</span> <span class="n">TWL4030_HF_CTL_RAMP_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">hs_ctl</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="n">hs_ctl</span> <span class="o">|=</span> <span class="n">TWL4030_HF_CTL_LOOP_EN</span><span class="p">;</span>
		<span class="n">hs_ctl</span> <span class="o">|=</span> <span class="n">TWL4030_HF_CTL_HB_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">hs_ctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* HF ramp-down */</span>
		<span class="n">hs_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_HF_CTL_LOOP_EN</span><span class="p">;</span>
		<span class="n">hs_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_HF_CTL_HB_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">hs_ctl</span><span class="p">);</span>
		<span class="n">hs_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_HF_CTL_RAMP_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">hs_ctl</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="n">hs_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_HF_CTL_REF_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">hs_ctl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handsfreelpga_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMU</span>:
		<span class="n">handsfree_ramp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HFL_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">handsfree_ramp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HFL_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handsfreerpga_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMU</span>:
		<span class="n">handsfree_ramp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HFR_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">handsfree_ramp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HFR_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vibramux_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">twl4030_write</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_VIBRA_SET</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">apll_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="n">twl4030_apll_enable</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">twl4030_apll_enable</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aif_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">audio_if</span><span class="p">;</span>

	<span class="n">audio_if</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="cm">/* Enable AIF */</span>
		<span class="cm">/* enable the PLL before we use it to clock the DAI */</span>
		<span class="n">twl4030_apll_enable</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">,</span>
						<span class="n">audio_if</span> <span class="o">|</span> <span class="n">TWL4030_AIF_EN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="cm">/* disable the DAI before we stop it&#39;s source PLL */</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">,</span>
						<span class="n">audio_if</span> <span class="o">&amp;</span>  <span class="o">~</span><span class="n">TWL4030_AIF_EN</span><span class="p">);</span>
		<span class="n">twl4030_apll_enable</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">headset_ramp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ramp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_codec_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hs_gain</span><span class="p">,</span> <span class="n">hs_pop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="cm">/* Base values for ramp delay calculation: 2^19 - 2^26 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ramp_base</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">524288</span><span class="p">,</span> <span class="mi">1048576</span><span class="p">,</span> <span class="mi">2097152</span><span class="p">,</span> <span class="mi">4194304</span><span class="p">,</span>
				    <span class="mi">8388608</span><span class="p">,</span> <span class="mi">16777216</span><span class="p">,</span> <span class="mi">33554432</span><span class="p">,</span> <span class="mi">67108864</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">;</span>

	<span class="n">hs_gain</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_GAIN_SET</span><span class="p">);</span>
	<span class="n">hs_pop</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">);</span>
	<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">ramp_base</span><span class="p">[(</span><span class="n">hs_pop</span> <span class="o">&amp;</span> <span class="n">TWL4030_RAMP_DELAY</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span>
		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sysclk</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Enable external mute control, this dramatically reduces</span>
<span class="cm">	 * the pop-noise */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hs_extmute</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_hs_extmute</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_hs_extmute</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hs_pop</span> <span class="o">|=</span> <span class="n">TWL4030_EXTMUTE</span><span class="p">;</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">,</span> <span class="n">hs_pop</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ramp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Headset ramp-up according to the TRM */</span>
		<span class="n">hs_pop</span> <span class="o">|=</span> <span class="n">TWL4030_VMID_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">,</span> <span class="n">hs_pop</span><span class="p">);</span>
		<span class="cm">/* Actually write to the register */</span>
		<span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_AUDIO_VOICE</span><span class="p">,</span>
					<span class="n">hs_gain</span><span class="p">,</span>
					<span class="n">TWL4030_REG_HS_GAIN_SET</span><span class="p">);</span>
		<span class="n">hs_pop</span> <span class="o">|=</span> <span class="n">TWL4030_RAMP_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">,</span> <span class="n">hs_pop</span><span class="p">);</span>
		<span class="cm">/* Wait ramp delay time + 1, so the VMID can settle */</span>
		<span class="n">twl4030_wait_ms</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Headset ramp-down _not_ according to</span>
<span class="cm">		 * the TRM, but in a way that it is working */</span>
		<span class="n">hs_pop</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_RAMP_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">,</span> <span class="n">hs_pop</span><span class="p">);</span>
		<span class="cm">/* Wait ramp delay time + 1, so the VMID can settle */</span>
		<span class="n">twl4030_wait_ms</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
		<span class="cm">/* Bypass the reg_cache to mute the headset */</span>
		<span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_AUDIO_VOICE</span><span class="p">,</span>
					<span class="n">hs_gain</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x0f</span><span class="p">),</span>
					<span class="n">TWL4030_REG_HS_GAIN_SET</span><span class="p">);</span>

		<span class="n">hs_pop</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_VMID_EN</span><span class="p">;</span>
		<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">,</span> <span class="n">hs_pop</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable external mute */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hs_extmute</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_hs_extmute</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_hs_extmute</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hs_pop</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_EXTMUTE</span><span class="p">;</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">,</span> <span class="n">hs_pop</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">headsetlpga_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMU</span>:
		<span class="cm">/* Do the ramp-up only once */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsr_enabled</span><span class="p">)</span>
			<span class="n">headset_ramp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsl_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="cm">/* Do the ramp-down only if both headsetL/R is disabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsr_enabled</span><span class="p">)</span>
			<span class="n">headset_ramp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsl_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">headsetrpga_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMU</span>:
		<span class="cm">/* Do the ramp-up only once */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsl_enabled</span><span class="p">)</span>
			<span class="n">headset_ramp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsr_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="cm">/* Do the ramp-down only if both headsetL/R is disabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsl_enabled</span><span class="p">)</span>
			<span class="n">headset_ramp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">hsr_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">digimic_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">digimic_delay</span><span class="p">)</span>
		<span class="n">twl4030_wait_ms</span><span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">digimic_delay</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some of the gain controls in TWL (mostly those which are associated with</span>
<span class="cm"> * the outputs) are implemented in an interesting way:</span>
<span class="cm"> * 0x0 : Power down (mute)</span>
<span class="cm"> * 0x1 : 6dB</span>
<span class="cm"> * 0x2 : 0 dB</span>
<span class="cm"> * 0x3 : -6 dB</span>
<span class="cm"> * Inverting not going to help with these.</span>
<span class="cm"> * Custom volsw and volsw_2r get/put functions to handle these gain bits.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_get_volsw_twl4030</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fls</span><span class="p">(</span><span class="n">max</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="n">rshift</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">rshift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_put_volsw_twl4030</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fls</span><span class="p">(</span><span class="n">max</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">val_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="n">rshift</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">val_mask</span> <span class="o">|=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val2</span><span class="p">)</span>
			<span class="n">val2</span> <span class="o">=</span> <span class="n">max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">val2</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">val2</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_get_volsw_r2_twl4030</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rreg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">fls</span><span class="p">(</span><span class="n">max</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_put_volsw_r2_twl4030</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rreg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fls</span><span class="p">(</span><span class="n">max</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">;</span>

	<span class="n">val_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val2</span><span class="p">)</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">val2</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="n">val2</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg2</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Codec operation modes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_op_modes_texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Option 2 (voice/audio)&quot;</span><span class="p">,</span> <span class="s">&quot;Option 1 (audio)&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_op_modes_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_op_modes_texts</span><span class="p">),</span>
			<span class="n">twl4030_op_modes_texts</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_put_twl4030_opmode_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;operation mode cannot be changed on-the-fly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FGAIN volume control:</span>
<span class="cm"> * from -62 to 0 dB in 1 dB steps (mute instead of -63 dB)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">digital_fine_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">6300</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * CGAIN volume control:</span>
<span class="cm"> * 0 dB to 12 dB in 6 dB steps</span>
<span class="cm"> * value 2 and 3 means 12 dB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">digital_coarse_tlv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Voice Downlink GAIN volume control:</span>
<span class="cm"> * from -37 to 12 dB in 1 dB steps (mute instead of -37 dB)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">digital_voice_downlink_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">3700</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Analog playback gain</span>
<span class="cm"> * -24 dB to 12 dB in 2 dB steps</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">analog_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">2400</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Gain controls tied to outputs</span>
<span class="cm"> * -6 dB to 6 dB in 6 dB steps (mute instead of -12)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">output_tvl</span><span class="p">,</span> <span class="o">-</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Gain control for earpiece amplifier</span>
<span class="cm"> * 0 dB to 12 dB in 6 dB steps (mute instead of -6)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">output_ear_tvl</span><span class="p">,</span> <span class="o">-</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Capture gain after the ADCs</span>
<span class="cm"> * from 0 dB to 31 dB in 1 dB steps</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">digital_capture_tlv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Gain control for input amplifiers</span>
<span class="cm"> * 0 dB to 30 dB in 6 dB steps</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">input_gain_tlv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* AVADC clock priority */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_avadc_clk_priority_texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Voice high priority&quot;</span><span class="p">,</span> <span class="s">&quot;HiFi high priority&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_avadc_clk_priority_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_AVADC_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_avadc_clk_priority_texts</span><span class="p">),</span>
			<span class="n">twl4030_avadc_clk_priority_texts</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_rampdelay_texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;27/20/14 ms&quot;</span><span class="p">,</span> <span class="s">&quot;55/40/27 ms&quot;</span><span class="p">,</span> <span class="s">&quot;109/81/55 ms&quot;</span><span class="p">,</span> <span class="s">&quot;218/161/109 ms&quot;</span><span class="p">,</span>
	<span class="s">&quot;437/323/218 ms&quot;</span><span class="p">,</span> <span class="s">&quot;874/645/437 ms&quot;</span><span class="p">,</span> <span class="s">&quot;1748/1291/874 ms&quot;</span><span class="p">,</span>
	<span class="s">&quot;3495/2581/1748 ms&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_rampdelay_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_HS_POPN_SET</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_rampdelay_texts</span><span class="p">),</span>
			<span class="n">twl4030_rampdelay_texts</span><span class="p">);</span>

<span class="cm">/* Vibra H-bridge direction mode */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_vibradirmode_texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Vibra H-bridge direction&quot;</span><span class="p">,</span> <span class="s">&quot;Audio data MSB&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_vibradirmode_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_VIBRA_CTL</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_vibradirmode_texts</span><span class="p">),</span>
			<span class="n">twl4030_vibradirmode_texts</span><span class="p">);</span>

<span class="cm">/* Vibra H-bridge direction */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_vibradir_texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Positive polarity&quot;</span><span class="p">,</span> <span class="s">&quot;Negative polarity&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_vibradir_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_VIBRA_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_vibradir_texts</span><span class="p">),</span>
			<span class="n">twl4030_vibradir_texts</span><span class="p">);</span>

<span class="cm">/* Digimic Left and right swapping */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twl4030_digimicswap_texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Not swapped&quot;</span><span class="p">,</span> <span class="s">&quot;Swapped&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">twl4030_digimicswap_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">TWL4030_REG_MISC_SET_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_digimicswap_texts</span><span class="p">),</span>
			<span class="n">twl4030_digimicswap_texts</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">twl4030_snd_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Codec operation mode control */</span>
	<span class="n">SOC_ENUM_EXT</span><span class="p">(</span><span class="s">&quot;Codec Operation Mode&quot;</span><span class="p">,</span> <span class="n">twl4030_op_modes_enum</span><span class="p">,</span>
		<span class="n">snd_soc_get_enum_double</span><span class="p">,</span>
		<span class="n">snd_soc_put_twl4030_opmode_enum_double</span><span class="p">),</span>

	<span class="cm">/* Common playback gain controls */</span>
	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;DAC1 Digital Fine Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ARXL1PGA</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR1PGA</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_fine_tlv</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;DAC2 Digital Fine Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ARXL2PGA</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR2PGA</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_fine_tlv</span><span class="p">),</span>

	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;DAC1 Digital Coarse Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ARXL1PGA</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR1PGA</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_coarse_tlv</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;DAC2 Digital Coarse Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ARXL2PGA</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR2PGA</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_coarse_tlv</span><span class="p">),</span>

	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;DAC1 Analog Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ARXL1_APGA_CTL</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR1_APGA_CTL</span><span class="p">,</span>
		<span class="mi">3</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">analog_tlv</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;DAC2 Analog Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ARXL2_APGA_CTL</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR2_APGA_CTL</span><span class="p">,</span>
		<span class="mi">3</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">analog_tlv</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_R</span><span class="p">(</span><span class="s">&quot;DAC1 Analog Playback Switch&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ARXL1_APGA_CTL</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR1_APGA_CTL</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_R</span><span class="p">(</span><span class="s">&quot;DAC2 Analog Playback Switch&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ARXL2_APGA_CTL</span><span class="p">,</span> <span class="n">TWL4030_REG_ARXR2_APGA_CTL</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Common voice downlink gain controls */</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC Voice Digital Downlink Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_VRXPGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_voice_downlink_tlv</span><span class="p">),</span>

	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC Voice Analog Downlink Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_VDL_APGA_CTL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">analog_tlv</span><span class="p">),</span>

	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC Voice Analog Downlink Switch&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_VDL_APGA_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Separate output gain controls */</span>
	<span class="n">SOC_DOUBLE_R_EXT_TLV</span><span class="p">(</span><span class="s">&quot;PreDriv Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_PREDL_CTL</span><span class="p">,</span> <span class="n">TWL4030_REG_PREDR_CTL</span><span class="p">,</span>
		<span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">snd_soc_get_volsw_r2_twl4030</span><span class="p">,</span>
		<span class="n">snd_soc_put_volsw_r2_twl4030</span><span class="p">,</span> <span class="n">output_tvl</span><span class="p">),</span>

	<span class="n">SOC_DOUBLE_EXT_TLV</span><span class="p">(</span><span class="s">&quot;Headset Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_HS_GAIN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">snd_soc_get_volsw_twl4030</span><span class="p">,</span>
		<span class="n">snd_soc_put_volsw_twl4030</span><span class="p">,</span> <span class="n">output_tvl</span><span class="p">),</span>

	<span class="n">SOC_DOUBLE_R_EXT_TLV</span><span class="p">(</span><span class="s">&quot;Carkit Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_PRECKL_CTL</span><span class="p">,</span> <span class="n">TWL4030_REG_PRECKR_CTL</span><span class="p">,</span>
		<span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">snd_soc_get_volsw_r2_twl4030</span><span class="p">,</span>
		<span class="n">snd_soc_put_volsw_r2_twl4030</span><span class="p">,</span> <span class="n">output_tvl</span><span class="p">),</span>

	<span class="n">SOC_SINGLE_EXT_TLV</span><span class="p">(</span><span class="s">&quot;Earpiece Playback Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_EAR_CTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">snd_soc_get_volsw_twl4030</span><span class="p">,</span>
		<span class="n">snd_soc_put_volsw_twl4030</span><span class="p">,</span> <span class="n">output_ear_tvl</span><span class="p">),</span>

	<span class="cm">/* Common capture gain controls */</span>
	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;TX1 Digital Capture Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ATXL1PGA</span><span class="p">,</span> <span class="n">TWL4030_REG_ATXR1PGA</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_capture_tlv</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;TX2 Digital Capture Volume&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_AVTXL2PGA</span><span class="p">,</span> <span class="n">TWL4030_REG_AVTXR2PGA</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_capture_tlv</span><span class="p">),</span>

	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Analog Capture Volume&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_ANAMIC_GAIN</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">input_gain_tlv</span><span class="p">),</span>

	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AVADC Clock Priority&quot;</span><span class="p">,</span> <span class="n">twl4030_avadc_clk_priority_enum</span><span class="p">),</span>

	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;HS ramp delay&quot;</span><span class="p">,</span> <span class="n">twl4030_rampdelay_enum</span><span class="p">),</span>

	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Vibra H-bridge mode&quot;</span><span class="p">,</span> <span class="n">twl4030_vibradirmode_enum</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Vibra H-bridge direction&quot;</span><span class="p">,</span> <span class="n">twl4030_vibradir_enum</span><span class="p">),</span>

	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Digimic LR Swap&quot;</span><span class="p">,</span> <span class="n">twl4030_digimicswap_enum</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">twl4030_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Left channel inputs */</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;MAINMIC&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;HSMIC&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;AUXL&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;CARKITMIC&quot;</span><span class="p">),</span>
	<span class="cm">/* Right channel inputs */</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;SUBMIC&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;AUXR&quot;</span><span class="p">),</span>
	<span class="cm">/* Digital microphones (Stereo) */</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;DIGIMIC0&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;DIGIMIC1&quot;</span><span class="p">),</span>

	<span class="cm">/* Outputs */</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;EARPIECE&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;PREDRIVEL&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;PREDRIVER&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;HSOL&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;HSOR&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;CARKITL&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;CARKITR&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;HFL&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;HFR&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;VIBRA&quot;</span><span class="p">),</span>

	<span class="cm">/* AIF and APLL clocks for running DAIs (including loopback) */</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;Virtual HiFi OUT&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;Virtual HiFi IN&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;Virtual Voice OUT&quot;</span><span class="p">),</span>

	<span class="cm">/* DACs */</span>
	<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC Right1&quot;</span><span class="p">,</span> <span class="s">&quot;Right Front HiFi Playback&quot;</span><span class="p">,</span>
			<span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC Left1&quot;</span><span class="p">,</span> <span class="s">&quot;Left Front HiFi Playback&quot;</span><span class="p">,</span>
			<span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC Right2&quot;</span><span class="p">,</span> <span class="s">&quot;Right Rear HiFi Playback&quot;</span><span class="p">,</span>
			<span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC Left2&quot;</span><span class="p">,</span> <span class="s">&quot;Left Rear HiFi Playback&quot;</span><span class="p">,</span>
			<span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Voice Playback&quot;</span><span class="p">,</span>
			<span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Analog bypasses */</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;Right1 Analog Loopback&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_abypassr1_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;Left1 Analog Loopback&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_abypassl1_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;Right2 Analog Loopback&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_abypassr2_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;Left2 Analog Loopback&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_abypassl2_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;Voice Analog Loopback&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_abypassv_control</span><span class="p">),</span>

	<span class="cm">/* Master analog loopback switch */</span>
	<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;FM Loop Enable&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_MISC_SET_1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Digital bypasses */</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;Left Digital Loopback&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_dbypassl_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;Right Digital Loopback&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_dbypassr_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;Voice Digital Loopback&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_dbypassv_control</span><span class="p">),</span>

	<span class="cm">/* Digital mixers, power control for the physical DACs */</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Digital R1 Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_AVDAC_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Digital L1 Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_AVDAC_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Digital R2 Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_AVDAC_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Digital L2 Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_AVDAC_CTL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Digital Voice Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_AVDAC_CTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Analog mixers, power control for the physical PGAs */</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Analog R1 Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ARXR1_APGA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Analog L1 Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ARXL1_APGA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Analog R2 Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ARXR2_APGA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_ARXL2_APGA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">,</span>
			<span class="n">TWL4030_REG_VDL_APGA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;APLL Enable&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">apll_event</span><span class="p">,</span>
			    <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>

	<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;AIF Enable&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aif_event</span><span class="p">,</span>
			    <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>

	<span class="cm">/* Output MIXER controls */</span>
	<span class="cm">/* Earpiece */</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Earpiece Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_earpiece_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_earpiece_controls</span><span class="p">)),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;Earpiece PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">earpiecepga_event</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_POST_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
	<span class="cm">/* PreDrivL/R */</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;PredriveL Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_predrivel_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_predrivel_controls</span><span class="p">)),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;PredriveL PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">predrivelpga_event</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_POST_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;PredriveR Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_predriver_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_predriver_controls</span><span class="p">)),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;PredriveR PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">predriverpga_event</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_POST_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
	<span class="cm">/* HeadsetL/R */</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;HeadsetL Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_hsol_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_hsol_controls</span><span class="p">)),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;HeadsetL PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">headsetlpga_event</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_POST_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;HeadsetR Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_hsor_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_hsor_controls</span><span class="p">)),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;HeadsetR PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">headsetrpga_event</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_POST_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
	<span class="cm">/* CarkitL/R */</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;CarkitL Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_carkitl_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_carkitl_controls</span><span class="p">)),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;CarkitL PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">carkitlpga_event</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_POST_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;CarkitR Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_carkitr_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_carkitr_controls</span><span class="p">)),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;CarkitR PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">carkitrpga_event</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_POST_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>

	<span class="cm">/* Output MUX controls */</span>
	<span class="cm">/* HandsfreeL/R */</span>
	<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;HandsfreeL Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">twl4030_dapm_handsfreel_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;HandsfreeL&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_handsfreelmute_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;HandsfreeL PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">handsfreelpga_event</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_POST_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;HandsfreeR Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">twl4030_dapm_handsfreer_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SWITCH</span><span class="p">(</span><span class="s">&quot;HandsfreeR&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">twl4030_dapm_handsfreermute_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;HandsfreeR PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">handsfreerpga_event</span><span class="p">,</span>
			<span class="n">SND_SOC_DAPM_POST_PMU</span><span class="o">|</span><span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
	<span class="cm">/* Vibra */</span>
	<span class="n">SND_SOC_DAPM_MUX_E</span><span class="p">(</span><span class="s">&quot;Vibra Mux&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_VIBRA_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">twl4030_dapm_vibra_control</span><span class="p">,</span> <span class="n">vibramux_event</span><span class="p">,</span>
			   <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;Vibra Route&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">twl4030_dapm_vibrapath_control</span><span class="p">),</span>

	<span class="cm">/* Introducing four virtual ADC, since TWL4030 have four channel for</span>
<span class="cm">	   capture */</span>
	<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;ADC Virtual Left1&quot;</span><span class="p">,</span> <span class="s">&quot;Left Front Capture&quot;</span><span class="p">,</span>
		<span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;ADC Virtual Right1&quot;</span><span class="p">,</span> <span class="s">&quot;Right Front Capture&quot;</span><span class="p">,</span>
		<span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;ADC Virtual Left2&quot;</span><span class="p">,</span> <span class="s">&quot;Left Rear Capture&quot;</span><span class="p">,</span>
		<span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;ADC Virtual Right2&quot;</span><span class="p">,</span> <span class="s">&quot;Right Rear Capture&quot;</span><span class="p">,</span>
		<span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Analog/Digital mic path selection.</span>
<span class="cm">	   TX1 Left/Right: either analog Left/Right or Digimic0</span>
<span class="cm">	   TX2 Left/Right: either analog Left/Right or Digimic1 */</span>
	<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;TX1 Capture Route&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">twl4030_dapm_micpathtx1_control</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;TX2 Capture Route&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">twl4030_dapm_micpathtx2_control</span><span class="p">),</span>

	<span class="cm">/* Analog input mixers for the capture amplifiers */</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Analog Left&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ANAMICL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">twl4030_dapm_analoglmic_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_analoglmic_controls</span><span class="p">)),</span>
	<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;Analog Right&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ANAMICR</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">twl4030_dapm_analogrmic_controls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_analogrmic_controls</span><span class="p">)),</span>

	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;ADC Physical Left&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_AVADC_CTL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;ADC Physical Right&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_AVADC_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;Digimic0 Enable&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ADCMICSEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">digimic_event</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMU</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;Digimic1 Enable&quot;</span><span class="p">,</span>
		<span class="n">TWL4030_REG_ADCMICSEL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">digimic_event</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMU</span><span class="p">),</span>

	<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;micbias1 select&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_MICBIAS_CTL</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;micbias2 select&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_MICBIAS_CTL</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">SND_SOC_DAPM_MICBIAS</span><span class="p">(</span><span class="s">&quot;Mic Bias 1&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_MICBIAS_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MICBIAS</span><span class="p">(</span><span class="s">&quot;Mic Bias 2&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_MICBIAS_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_MICBIAS</span><span class="p">(</span><span class="s">&quot;Headset Mic Bias&quot;</span><span class="p">,</span> <span class="n">TWL4030_REG_MICBIAS_CTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">intercon</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;Digital L1 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC Left1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Digital R1 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC Right1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Digital L2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC Left2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Digital R2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC Right2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Digital Voice Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC Voice&quot;</span><span class="p">},</span>

	<span class="cm">/* Supply for the digital part (APLL) */</span>
	<span class="p">{</span><span class="s">&quot;Digital Voice Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;APLL Enable&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;DAC Left1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DAC Right1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DAC Left2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DAC Right1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Digital R2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Digital L2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Analog L1 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Digital L1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog R1 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Digital R1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Digital L2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog R2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Digital R2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Digital Voice Playback Mixer&quot;</span><span class="p">},</span>

	<span class="cm">/* Internal playback routings */</span>
	<span class="cm">/* Earpiece */</span>
	<span class="p">{</span><span class="s">&quot;Earpiece Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Earpiece Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Earpiece Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Earpiece Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Earpiece PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Earpiece Mixer&quot;</span><span class="p">},</span>
	<span class="cm">/* PreDrivL */</span>
	<span class="p">{</span><span class="s">&quot;PredriveL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PredriveL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PredriveL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PredriveL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PredriveL PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;PredriveL Mixer&quot;</span><span class="p">},</span>
	<span class="cm">/* PreDrivR */</span>
	<span class="p">{</span><span class="s">&quot;PredriveR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PredriveR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PredriveR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PredriveR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PredriveR PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;PredriveR Mixer&quot;</span><span class="p">},</span>
	<span class="cm">/* HeadsetL */</span>
	<span class="p">{</span><span class="s">&quot;HeadsetL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HeadsetL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HeadsetL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HeadsetL PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;HeadsetL Mixer&quot;</span><span class="p">},</span>
	<span class="cm">/* HeadsetR */</span>
	<span class="p">{</span><span class="s">&quot;HeadsetR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HeadsetR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HeadsetR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HeadsetR PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;HeadsetR Mixer&quot;</span><span class="p">},</span>
	<span class="cm">/* CarkitL */</span>
	<span class="p">{</span><span class="s">&quot;CarkitL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CarkitL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CarkitL Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CarkitL PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CarkitL Mixer&quot;</span><span class="p">},</span>
	<span class="cm">/* CarkitR */</span>
	<span class="p">{</span><span class="s">&quot;CarkitR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CarkitR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CarkitR Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CarkitR PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CarkitR Mixer&quot;</span><span class="p">},</span>
	<span class="cm">/* HandsfreeL */</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeL Mux&quot;</span><span class="p">,</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeL Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeL Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeL Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeL&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="s">&quot;HandsfreeL Mux&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeL PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;HandsfreeL&quot;</span><span class="p">},</span>
	<span class="cm">/* HandsfreeR */</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeR Mux&quot;</span><span class="p">,</span> <span class="s">&quot;Voice&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeR Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R1 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeR Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog R2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeR Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeR&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="s">&quot;HandsfreeR Mux&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HandsfreeR PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;HandsfreeR&quot;</span><span class="p">},</span>
	<span class="cm">/* Vibra */</span>
	<span class="p">{</span><span class="s">&quot;Vibra Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL1&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Left1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Vibra Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR1&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Right1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Vibra Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioL2&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Left2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Vibra Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AudioR2&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Right2&quot;</span><span class="p">},</span>

	<span class="cm">/* outputs */</span>
	<span class="cm">/* Must be always connected (for AIF and APLL) */</span>
	<span class="p">{</span><span class="s">&quot;Virtual HiFi OUT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC Left1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Virtual HiFi OUT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC Right1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Virtual HiFi OUT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC Left2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Virtual HiFi OUT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC Right2&quot;</span><span class="p">},</span>
	<span class="cm">/* Must be always connected (for APLL) */</span>
	<span class="p">{</span><span class="s">&quot;Virtual Voice OUT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Digital Voice Playback Mixer&quot;</span><span class="p">},</span>
	<span class="cm">/* Physical outputs */</span>
	<span class="p">{</span><span class="s">&quot;EARPIECE&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Earpiece PGA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PREDRIVEL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;PredriveL PGA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PREDRIVER&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;PredriveR PGA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HSOL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;HeadsetL PGA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HSOR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;HeadsetR PGA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CARKITL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CarkitL PGA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CARKITR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CarkitR PGA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HFL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;HandsfreeL PGA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HFR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;HandsfreeR PGA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Vibra Route&quot;</span><span class="p">,</span> <span class="s">&quot;Audio&quot;</span><span class="p">,</span> <span class="s">&quot;Vibra Mux&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;VIBRA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Vibra Route&quot;</span><span class="p">},</span>

	<span class="cm">/* Capture path */</span>
	<span class="cm">/* Must be always connected (for AIF and APLL) */</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Left1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Virtual HiFi IN&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Right1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Virtual HiFi IN&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Left2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Virtual HiFi IN&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Right2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Virtual HiFi IN&quot;</span><span class="p">},</span>
	<span class="cm">/* Physical inputs */</span>
	<span class="p">{</span><span class="s">&quot;Analog Left&quot;</span><span class="p">,</span> <span class="s">&quot;Main Mic Capture Switch&quot;</span><span class="p">,</span> <span class="s">&quot;MAINMIC&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog Left&quot;</span><span class="p">,</span> <span class="s">&quot;Headset Mic Capture Switch&quot;</span><span class="p">,</span> <span class="s">&quot;HSMIC&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog Left&quot;</span><span class="p">,</span> <span class="s">&quot;AUXL Capture Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AUXL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog Left&quot;</span><span class="p">,</span> <span class="s">&quot;Carkit Mic Capture Switch&quot;</span><span class="p">,</span> <span class="s">&quot;CARKITMIC&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Analog Right&quot;</span><span class="p">,</span> <span class="s">&quot;Sub Mic Capture Switch&quot;</span><span class="p">,</span> <span class="s">&quot;SUBMIC&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog Right&quot;</span><span class="p">,</span> <span class="s">&quot;AUXR Capture Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AUXR&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;ADC Physical Left&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Analog Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Physical Right&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Analog Right&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Digimic0 Enable&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DIGIMIC0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Digimic1 Enable&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DIGIMIC1&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;DIGIMIC0&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;micbias1 select&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DIGIMIC1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;micbias2 select&quot;</span><span class="p">},</span>

	<span class="cm">/* TX1 Left capture path */</span>
	<span class="p">{</span><span class="s">&quot;TX1 Capture Route&quot;</span><span class="p">,</span> <span class="s">&quot;Analog&quot;</span><span class="p">,</span> <span class="s">&quot;ADC Physical Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;TX1 Capture Route&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic0&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic0 Enable&quot;</span><span class="p">},</span>
	<span class="cm">/* TX1 Right capture path */</span>
	<span class="p">{</span><span class="s">&quot;TX1 Capture Route&quot;</span><span class="p">,</span> <span class="s">&quot;Analog&quot;</span><span class="p">,</span> <span class="s">&quot;ADC Physical Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;TX1 Capture Route&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic0&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic0 Enable&quot;</span><span class="p">},</span>
	<span class="cm">/* TX2 Left capture path */</span>
	<span class="p">{</span><span class="s">&quot;TX2 Capture Route&quot;</span><span class="p">,</span> <span class="s">&quot;Analog&quot;</span><span class="p">,</span> <span class="s">&quot;ADC Physical Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;TX2 Capture Route&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic1&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic1 Enable&quot;</span><span class="p">},</span>
	<span class="cm">/* TX2 Right capture path */</span>
	<span class="p">{</span><span class="s">&quot;TX2 Capture Route&quot;</span><span class="p">,</span> <span class="s">&quot;Analog&quot;</span><span class="p">,</span> <span class="s">&quot;ADC Physical Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;TX2 Capture Route&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic1&quot;</span><span class="p">,</span> <span class="s">&quot;Digimic1 Enable&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;ADC Virtual Left1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;TX1 Capture Route&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Right1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;TX1 Capture Route&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Left2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;TX2 Capture Route&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Right2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;TX2 Capture Route&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;ADC Virtual Left1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Right1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Left2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADC Virtual Right2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF Enable&quot;</span><span class="p">},</span>

	<span class="cm">/* Analog bypass routes */</span>
	<span class="p">{</span><span class="s">&quot;Right1 Analog Loopback&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Left1 Analog Loopback&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Right2 Analog Loopback&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Right&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Left2 Analog Loopback&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Left&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Voice Analog Loopback&quot;</span><span class="p">,</span> <span class="s">&quot;Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Analog Left&quot;</span><span class="p">},</span>

	<span class="cm">/* Supply for the Analog loopbacks */</span>
	<span class="p">{</span><span class="s">&quot;Right1 Analog Loopback&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;FM Loop Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Left1 Analog Loopback&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;FM Loop Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Right2 Analog Loopback&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;FM Loop Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Left2 Analog Loopback&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;FM Loop Enable&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Voice Analog Loopback&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;FM Loop Enable&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Analog R1 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Right1 Analog Loopback&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog L1 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Left1 Analog Loopback&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog R2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Right2 Analog Loopback&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog L2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Left2 Analog Loopback&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Analog Voice Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Voice Analog Loopback&quot;</span><span class="p">},</span>

	<span class="cm">/* Digital bypass routes */</span>
	<span class="p">{</span><span class="s">&quot;Right Digital Loopback&quot;</span><span class="p">,</span> <span class="s">&quot;Volume&quot;</span><span class="p">,</span> <span class="s">&quot;TX1 Capture Route&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Left Digital Loopback&quot;</span><span class="p">,</span> <span class="s">&quot;Volume&quot;</span><span class="p">,</span> <span class="s">&quot;TX1 Capture Route&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Voice Digital Loopback&quot;</span><span class="p">,</span> <span class="s">&quot;Volume&quot;</span><span class="p">,</span> <span class="s">&quot;TX2 Capture Route&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;Digital R2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Right Digital Loopback&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Digital L2 Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Left Digital Loopback&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Digital Voice Playback Mixer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Voice Digital Loopback&quot;</span><span class="p">},</span>

<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_set_bias_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">snd_soc_bias_level</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_ON</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_PREPARE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_STANDBY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">)</span>
			<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_OFF</span>:
		<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">mst_substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">slv_substream</span><span class="p">;</span>

	<span class="cm">/* Pick the stream, which need to be constrained */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mst_substream</span> <span class="o">==</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">master_substream</span><span class="p">)</span>
		<span class="n">slv_substream</span> <span class="o">=</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">slave_substream</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mst_substream</span> <span class="o">==</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">slave_substream</span><span class="p">)</span>
		<span class="n">slv_substream</span> <span class="o">=</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">master_substream</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* This should not happen.. */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Set the constraints according to the already configured stream */</span>
	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">slv_substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span>
				<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">slv_substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_SAMPLE_BITS</span><span class="p">,</span>
				<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sample_bits</span><span class="p">,</span>
				<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sample_bits</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">slv_substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
				<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span>
				<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* In case of 4 channel mode, the RX1 L/R for playback and the TX2 L/R for</span>
<span class="cm"> * capture has to be enabled/disabled. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_tdm_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_OPTION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">TWL4030_ARXL1_VRX_EN</span> <span class="o">|</span> <span class="n">TWL4030_ARXR1_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">TWL4030_ATXL2_VTXL_EN</span> <span class="o">|</span> <span class="n">TWL4030_ATXR2_VTXR_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_OPTION</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">master_substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">slave_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="cm">/* The DAI has one configuration for playback and capture, so</span>
<span class="cm">		 * if the DAI has been already configured then constrain this</span>
<span class="cm">		 * substream to match it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span>
			<span class="n">twl4030_constraints</span><span class="p">(</span><span class="n">twl4030</span><span class="p">,</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">master_substream</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">TWL4030_OPTION_1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* In option2 4 channel is not supported, set the</span>
<span class="cm">			 * constraint for the first stream for channels, the</span>
<span class="cm">			 * second stream will &#39;inherit&#39; this cosntraint */</span>
			<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span>
						<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
						<span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">master_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">master_substream</span> <span class="o">==</span> <span class="n">substream</span><span class="p">)</span>
		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">master_substream</span> <span class="o">=</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">slave_substream</span><span class="p">;</span>

	<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">slave_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If all streams are closed, or the remaining stream has not yet</span>
<span class="cm">	 * been configured than set the DAI as not configured. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">master_substream</span><span class="p">)</span>
		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">master_substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
		<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	 <span class="cm">/* If the closing substream had 4 channel, do the necessary cleanup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">twl4030_tdm_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">,</span> <span class="n">old_mode</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">old_format</span><span class="p">;</span>

	 <span class="cm">/* If the substream has 4 channel, do the necessary setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">);</span>

		<span class="cm">/* Safety check: are we in the correct operating mode and</span>
<span class="cm">		 * the interface is in TDM mode? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">TWL4030_OPTION_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">TWL4030_AIF_FORMAT</span><span class="p">)</span> <span class="o">==</span> <span class="n">TWL4030_AIF_FORMAT_TDM</span><span class="p">))</span>
			<span class="n">twl4030_tdm_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span>
		<span class="cm">/* Ignoring hw_params for already configured DAI */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* bit rate */</span>
	<span class="n">old_mode</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
			<span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TWL4030_CODECPDZ</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">old_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TWL4030_APLL_RATE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8000</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_8000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11025</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_11025</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12000</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_12000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16000</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_16000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">22050</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_22050</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24000</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_24000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32000</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_32000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_44100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_48000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_APLL_RATE_96000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unknown rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sample size */</span>
	<span class="n">old_format</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">);</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">old_format</span><span class="p">;</span>
	<span class="n">format</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_DATA_WIDTH</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="n">format</span> <span class="o">|=</span> <span class="n">TWL4030_DATA_WIDTH_16S_16W</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span>:
		<span class="n">format</span> <span class="o">|=</span> <span class="n">TWL4030_DATA_WIDTH_32S_24W</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unknown format %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">!=</span> <span class="n">old_format</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">old_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">codec_powered</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the codec is powered, than we need to toggle the</span>
<span class="cm">			 * codec power.</span>
<span class="cm">			 */</span>
			<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
			<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Store the important parameters for the DAI configuration and set</span>
<span class="cm">	 * the DAI as configured */</span>
	<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sample_bits</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
					<span class="n">SNDRV_PCM_HW_PARAM_SAMPLE_BITS</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

	<span class="cm">/* If both playback and capture streams are open, and one of them</span>
<span class="cm">	 * is setting the hw parameters right now (since we are here), set</span>
<span class="cm">	 * constraints to the other stream to match the current one. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">slave_substream</span><span class="p">)</span>
		<span class="n">twl4030_constraints</span><span class="p">(</span><span class="n">twl4030</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_set_dai_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">clk_id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">19200000</span>:
	<span class="k">case</span> <span class="mi">26000000</span>:
	<span class="k">case</span> <span class="mi">38400000</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unsupported HFCLKIN: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">!=</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sysclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Mismatch in HFCLKIN: %u (configured: %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">freq</span><span class="p">,</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sysclk</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_set_dai_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">old_format</span><span class="p">,</span> <span class="n">format</span><span class="p">;</span>

	<span class="cm">/* get format */</span>
	<span class="n">old_format</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">);</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">old_format</span><span class="p">;</span>

	<span class="cm">/* set master/slave audio interface */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
		<span class="n">format</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TWL4030_AIF_SLAVE_EN</span><span class="p">);</span>
		<span class="n">format</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TWL4030_CLK256FS_EN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>:
		<span class="n">format</span> <span class="o">|=</span> <span class="n">TWL4030_AIF_SLAVE_EN</span><span class="p">;</span>
		<span class="n">format</span> <span class="o">|=</span> <span class="n">TWL4030_CLK256FS_EN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* interface format */</span>
	<span class="n">format</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_AIF_FORMAT</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span>:
		<span class="n">format</span> <span class="o">|=</span> <span class="n">TWL4030_AIF_FORMAT_CODEC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_A</span>:
		<span class="n">format</span> <span class="o">|=</span> <span class="n">TWL4030_AIF_FORMAT_TDM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">!=</span> <span class="n">old_format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">codec_powered</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the codec is powered, than we need to toggle the</span>
<span class="cm">			 * codec power.</span>
<span class="cm">			 */</span>
			<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
			<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_set_tristate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tristate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tristate</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">TWL4030_AIF_TRI_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_AIF_TRI_EN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_AUDIO_IF</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* In case of voice mode, the RX1 L(VRX) for downlink and the TX2 L/R</span>
<span class="cm"> * (VTXL, VTXR) for uplink has to be enabled/disabled. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_voice_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_OPTION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">TWL4030_ARXL1_VRX_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">TWL4030_ATXL2_VTXL_EN</span> <span class="o">|</span> <span class="n">TWL4030_ATXR2_VTXR_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_OPTION</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_voice_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* If the system master clock is not 26MHz, the voice PCM interface is</span>
<span class="cm">	 * not available.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sysclk</span> <span class="o">!=</span> <span class="mi">26000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: HFCLKIN is %u KHz, voice interface needs 26MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sysclk</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the codec mode is not option2, the voice PCM interface is not</span>
<span class="cm">	 * available.</span>
<span class="cm">	 */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">TWL4030_OPT_MODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">TWL4030_OPTION_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: the codec mode is not option2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_voice_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>

	<span class="cm">/* Enable voice digital filters */</span>
	<span class="n">twl4030_voice_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_voice_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">old_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* Enable voice digital filters */</span>
	<span class="n">twl4030_voice_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* bit rate */</span>
	<span class="n">old_mode</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TWL4030_CODECPDZ</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">old_mode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8000</span>:
		<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TWL4030_SEL_16K</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16000</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">TWL4030_SEL_16K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unknown rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">old_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">codec_powered</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the codec is powered, than we need to toggle the</span>
<span class="cm">			 * codec power.</span>
<span class="cm">			 */</span>
			<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_CODEC_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_voice_set_dai_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">clk_id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">!=</span> <span class="mi">26000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: HFCLKIN is %u KHz, voice interface needs 26MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">freq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">!=</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sysclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Mismatch in HFCLKIN: %u (configured: %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">freq</span><span class="p">,</span> <span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sysclk</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_voice_set_dai_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">old_format</span><span class="p">,</span> <span class="n">format</span><span class="p">;</span>

	<span class="cm">/* get format */</span>
	<span class="n">old_format</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_VOICE_IF</span><span class="p">);</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">old_format</span><span class="p">;</span>

	<span class="cm">/* set master/slave audio interface */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
		<span class="n">format</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TWL4030_VIF_SLAVE_EN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>:
		<span class="n">format</span> <span class="o">|=</span> <span class="n">TWL4030_VIF_SLAVE_EN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clock inversion */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_INV_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_IB_NF</span>:
		<span class="n">format</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TWL4030_VIF_FORMAT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_NB_IF</span>:
		<span class="n">format</span> <span class="o">|=</span> <span class="n">TWL4030_VIF_FORMAT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">!=</span> <span class="n">old_format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">codec_powered</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the codec is powered, than we need to toggle the</span>
<span class="cm">			 * codec power.</span>
<span class="cm">			 */</span>
			<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_VOICE_IF</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
			<span class="n">twl4030_codec_enable</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_VOICE_IF</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_voice_set_tristate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tristate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_VOICE_IF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tristate</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">TWL4030_VIF_TRI_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TWL4030_VIF_TRI_EN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">twl4030_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">TWL4030_REG_VOICE_IF</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define TWL4030_RATES	 (SNDRV_PCM_RATE_8000_48000)</span>
<span class="cp">#define TWL4030_FORMATS	 (SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S32_LE)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">twl4030_dai_hifi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">twl4030_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">twl4030_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">twl4030_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_sysclk</span>	<span class="o">=</span> <span class="n">twl4030_set_dai_sysclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">twl4030_set_dai_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tristate</span>	<span class="o">=</span> <span class="n">twl4030_set_tristate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">twl4030_dai_voice_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">twl4030_voice_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">twl4030_voice_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">twl4030_voice_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_sysclk</span>	<span class="o">=</span> <span class="n">twl4030_voice_set_dai_sysclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">twl4030_voice_set_dai_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tristate</span>	<span class="o">=</span> <span class="n">twl4030_voice_set_tristate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">twl4030_dai</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;twl4030-hifi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;HiFi Playback&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">TWL4030_RATES</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_96000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">TWL4030_FORMATS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sig_bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,},</span>
	<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;Capture&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">TWL4030_RATES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">TWL4030_FORMATS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sig_bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,},</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl4030_dai_hifi_ops</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;twl4030-voice&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;Voice Playback&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_16000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,},</span>
	<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;Capture&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_16000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,},</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl4030_dai_voice_ops</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_soc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">twl4030_set_bias_level</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_soc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">twl4030_set_bias_level</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_soc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span><span class="p">;</span>

	<span class="n">twl4030</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">twl4030_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl4030</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can not allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_soc_codec_set_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">twl4030</span><span class="p">);</span>
	<span class="cm">/* Set the defaults, and power up the codec */</span>
	<span class="n">twl4030</span><span class="o">-&gt;</span><span class="n">sysclk</span> <span class="o">=</span> <span class="n">twl4030_audio_get_mclk</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">twl4030_init_chip</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_soc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_priv</span> <span class="o">*</span><span class="n">twl4030</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="cm">/* Reset registers to their chip default before leaving */</span>
	<span class="n">twl4030_reset_registers</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">twl4030_set_bias_level</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">twl4030</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_codec_driver</span> <span class="n">soc_codec_dev_twl4030</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">twl4030_soc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">twl4030_soc_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">twl4030_soc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">twl4030_soc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">twl4030_read_reg_cache</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">twl4030_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bias_level</span> <span class="o">=</span> <span class="n">twl4030_set_bias_level</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idle_bias_off</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg_cache_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">twl4030_reg</span><span class="p">),</span>
	<span class="p">.</span><span class="n">reg_word_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
	<span class="p">.</span><span class="n">reg_cache_default</span> <span class="o">=</span> <span class="n">twl4030_reg</span><span class="p">,</span>

	<span class="p">.</span><span class="n">controls</span> <span class="o">=</span> <span class="n">twl4030_snd_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_controls</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_snd_controls</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dapm_widgets</span> <span class="o">=</span> <span class="n">twl4030_dapm_widgets</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_dapm_widgets</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dapm_widgets</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dapm_routes</span> <span class="o">=</span> <span class="n">intercon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_dapm_routes</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intercon</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">twl4030_codec_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_codec_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform_data is missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_soc_register_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">soc_codec_dev_twl4030</span><span class="p">,</span>
			<span class="n">twl4030_dai</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twl4030_dai</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">twl4030_codec_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_unregister_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:twl4030-codec&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">twl4030_codec_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">twl4030_codec_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">twl4030_codec_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;twl4030-codec&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">twl4030_codec_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ASoC TWL4030 codec driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Steve Sakoman&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
