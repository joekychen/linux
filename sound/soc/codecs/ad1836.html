<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › codecs › ad1836.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ad1836.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Audio Codec driver supporting:</span>
<span class="cm"> *  AD1835A, AD1836, AD1837A, AD1838A, AD1839A</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009-2011 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2 or later.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __AD1836_H__</span>
<span class="cp">#define __AD1836_H__</span>

<span class="cp">#define AD1836_DAC_CTRL1               0</span>
<span class="cp">#define AD1836_DAC_POWERDOWN           2</span>
<span class="cp">#define AD1836_DAC_SERFMT_MASK         0xE0</span>
<span class="cp">#define AD1836_DAC_SERFMT_PCK256       (0x4 &lt;&lt; 5)</span>
<span class="cp">#define AD1836_DAC_SERFMT_PCK128       (0x5 &lt;&lt; 5)</span>
<span class="cp">#define AD1836_DAC_WORD_LEN_MASK       0x18</span>
<span class="cp">#define AD1836_DAC_WORD_LEN_OFFSET     3</span>

<span class="cp">#define AD1836_DAC_CTRL2               1</span>

<span class="cm">/* These macros are one-based. So AD183X_MUTE_LEFT(1) will return the mute bit</span>
<span class="cm"> * for the first ADC/DAC */</span>
<span class="cp">#define AD1836_MUTE_LEFT(x) (((x) * 2) - 2)</span>
<span class="cp">#define AD1836_MUTE_RIGHT(x) (((x) * 2) - 1)</span>

<span class="cp">#define AD1836_DAC_L_VOL(x) ((x) * 2)</span>
<span class="cp">#define AD1836_DAC_R_VOL(x) (1 + ((x) * 2))</span>

<span class="cp">#define AD1836_ADC_CTRL1               12</span>
<span class="cp">#define AD1836_ADC_POWERDOWN           7</span>
<span class="cp">#define AD1836_ADC_HIGHPASS_FILTER     8</span>

<span class="cp">#define AD1836_ADC_CTRL2               13</span>
<span class="cp">#define AD1836_ADC_WORD_LEN_MASK       0x30</span>
<span class="cp">#define AD1836_ADC_WORD_OFFSET         4</span>
<span class="cp">#define AD1836_ADC_SERFMT_MASK         (7 &lt;&lt; 6)</span>
<span class="cp">#define AD1836_ADC_SERFMT_PCK256       (0x4 &lt;&lt; 6)</span>
<span class="cp">#define AD1836_ADC_SERFMT_PCK128       (0x5 &lt;&lt; 6)</span>
<span class="cp">#define AD1836_ADC_AUX                 (0x6 &lt;&lt; 6)</span>

<span class="cp">#define AD1836_ADC_CTRL3               14</span>

<span class="cp">#define AD1836_NUM_REGS                16</span>

<span class="cp">#define AD1836_WORD_LEN_24 0x0</span>
<span class="cp">#define AD1836_WORD_LEN_20 0x1</span>
<span class="cp">#define AD1836_WORD_LEN_16 0x2</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
<span class="cp">#define AD1836_DAC_SWITCH(x) \</span>
<span class="cp">	SOC_DOUBLE(&quot;DAC&quot; #x &quot; Playback Switch&quot;, AD1836_DAC_CTRL2, \</span>
<span class="cp">			AD1836_MUTE_LEFT(x), AD1836_MUTE_RIGHT(x), 1, 1)</span>

<span class="cp">#define AD1836_ADC_SWITCH(x) \</span>
<span class="cp">	SOC_DOUBLE(&quot;ADC&quot; #x &quot; Capture Switch&quot;, AD1836_ADC_CTRL2, \</span>
<span class="cp">		AD1836_MUTE_LEFT(x), AD1836_MUTE_RIGHT(x), 1, 1)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">ad183x_dac_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AD1836_DAC_VOLUME</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">AD1836_DAC_SWITCH</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">AD1836_DAC_VOLUME</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="n">AD1836_DAC_SWITCH</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="n">AD1836_DAC_VOLUME</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="n">AD1836_DAC_SWITCH</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="n">AD1836_DAC_VOLUME</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	<span class="n">AD1836_DAC_SWITCH</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">ad183x_dac_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;DAC1OUT&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;DAC2OUT&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;DAC3OUT&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_OUTPUT</span><span class="p">(</span><span class="s">&quot;DAC4OUT&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">ad183x_dac_routes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;DAC1OUT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2OUT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC3OUT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC4OUT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">ad183x_adc_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AD1836_ADC_SWITCH</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">AD1836_ADC_SWITCH</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="n">AD1836_ADC_SWITCH</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">ad183x_adc_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;ADC1IN&quot;</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;ADC2IN&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">ad183x_adc_routes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ADC&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ADC1IN&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ADC&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ADC2IN&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">ad183x_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* ADC high-pass filter */</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;ADC High Pass Filter Switch&quot;</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL1</span><span class="p">,</span>
			<span class="n">AD1836_ADC_HIGHPASS_FILTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* DAC de-emphasis */</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Playback Deemphasis&quot;</span><span class="p">,</span> <span class="n">ad1836_deemp_enum</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">ad183x_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC&quot;</span><span class="p">,</span> <span class="s">&quot;Playback&quot;</span><span class="p">,</span> <span class="n">AD1836_DAC_CTRL1</span><span class="p">,</span>
				<span class="n">AD1836_DAC_POWERDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;ADC&quot;</span><span class="p">,</span> <span class="s">&quot;Capture&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;ADC_PWR&quot;</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL1</span><span class="p">,</span>
				<span class="n">AD1836_ADC_POWERDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">ad183x_dapm_routes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;DAC&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ADC_PWR&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ADC&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ADC_PWR&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">ad1836_in_tlv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">ad1836_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;ADC2 Capture Volume&quot;</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">ad1836_in_tlv</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * DAI ops entries</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1836_set_dai_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* at present, we support adc aux mode to interface with</span>
<span class="cm">	 * blackfin sport tdm mode</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_A</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_INV_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_IB_IF</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* ALCLK,ABCLK are both output, AD1836 can only be master */</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1836_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">word_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>

	<span class="cm">/* bit size */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="n">word_len</span> <span class="o">=</span> <span class="n">AD1836_WORD_LEN_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S20_3LE</span>:
		<span class="n">word_len</span> <span class="o">=</span> <span class="n">AD1836_WORD_LEN_20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_LE</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span>:
		<span class="n">word_len</span> <span class="o">=</span> <span class="n">AD1836_WORD_LEN_24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_DAC_CTRL1</span><span class="p">,</span> <span class="n">AD1836_DAC_WORD_LEN_MASK</span><span class="p">,</span>
		<span class="n">word_len</span> <span class="o">&lt;&lt;</span> <span class="n">AD1836_DAC_WORD_LEN_OFFSET</span><span class="p">);</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL2</span><span class="p">,</span> <span class="n">AD1836_ADC_WORD_LEN_MASK</span><span class="p">,</span>
		<span class="n">word_len</span> <span class="o">&lt;&lt;</span> <span class="n">AD1836_ADC_WORD_OFFSET</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">ad1836_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">ad1836_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span> <span class="o">=</span> <span class="n">ad1836_set_dai_fmt</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define AD183X_DAI(_name, num_dacs, num_adcs) \</span>
<span class="cp">{ \</span>
<span class="cp">	.name = _name &quot;-hifi&quot;, \</span>
<span class="cp">	.playback = { \</span>
<span class="cp">		.stream_name = &quot;Playback&quot;, \</span>
<span class="cp">		.channels_min = 2, \</span>
<span class="cp">		.channels_max = (num_dacs) * 2, \</span>
<span class="cp">		.rates = SNDRV_PCM_RATE_48000,  \</span>
<span class="cp">		.formats = SNDRV_PCM_FMTBIT_S32_LE | SNDRV_PCM_FMTBIT_S16_LE | \</span>
<span class="cp">			SNDRV_PCM_FMTBIT_S20_3LE | SNDRV_PCM_FMTBIT_S24_LE, \</span>
<span class="cp">	}, \</span>
<span class="cp">	.capture = { \</span>
<span class="cp">		.stream_name = &quot;Capture&quot;, \</span>
<span class="cp">		.channels_min = 2, \</span>
<span class="cp">		.channels_max = (num_adcs) * 2, \</span>
<span class="cp">		.rates = SNDRV_PCM_RATE_48000, \</span>
<span class="cp">		.formats = SNDRV_PCM_FMTBIT_S32_LE | SNDRV_PCM_FMTBIT_S16_LE | \</span>
<span class="cp">			SNDRV_PCM_FMTBIT_S20_3LE | SNDRV_PCM_FMTBIT_S24_LE, \</span>
<span class="cp">	}, \</span>
<span class="cp">	.ops = &amp;ad1836_dai_ops, \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">ad183x_dais</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">AD1835</span><span class="p">]</span> <span class="o">=</span> <span class="n">AD183X_DAI</span><span class="p">(</span><span class="s">&quot;ad1835&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">[</span><span class="n">AD1836</span><span class="p">]</span> <span class="o">=</span> <span class="n">AD183X_DAI</span><span class="p">(</span><span class="s">&quot;ad1836&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="p">[</span><span class="n">AD1838</span><span class="p">]</span> <span class="o">=</span> <span class="n">AD183X_DAI</span><span class="p">(</span><span class="s">&quot;ad1838&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1836_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset clock control mode */</span>
	<span class="k">return</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL2</span><span class="p">,</span>
		<span class="n">AD1836_ADC_SERFMT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1836_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* restore clock control mode */</span>
	<span class="k">return</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL2</span><span class="p">,</span>
		<span class="n">AD1836_ADC_SERFMT_MASK</span><span class="p">,</span> <span class="n">AD1836_ADC_AUX</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ad1836_suspend NULL</span>
<span class="cp">#define ad1836_resume  NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1836_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad1836_priv</span> <span class="o">*</span><span class="n">ad1836</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_dacs</span><span class="p">,</span> <span class="n">num_adcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">num_dacs</span> <span class="o">=</span> <span class="n">ad183x_dais</span><span class="p">[</span><span class="n">ad1836</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">].</span><span class="n">playback</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">num_adcs</span> <span class="o">=</span> <span class="n">ad183x_dais</span><span class="p">[</span><span class="n">ad1836</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">].</span><span class="n">capture</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_codec_set_cache_io</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">SND_SOC_SPI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to set cache I/O: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* default setting for ad1836 */</span>
	<span class="cm">/* de-emphasis: 48kHz, power-on dac */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_DAC_CTRL1</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">);</span>
	<span class="cm">/* unmute dac channels */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_DAC_CTRL2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="cm">/* high-pass filter enable, power-on adc */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL1</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="cm">/* unmute adc channles, adc aux mode */</span>
	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL2</span><span class="p">,</span> <span class="mh">0x180</span><span class="p">);</span>
	<span class="cm">/* volume */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">num_dacs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_DAC_L_VOL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mh">0x3FF</span><span class="p">);</span>
		<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_DAC_R_VOL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mh">0x3FF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ad1836</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">AD1836</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* left/right diff:PGA/MUX */</span>
		<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL3</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ad1836_controls</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ad1836_controls</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ad183x_dac_controls</span><span class="p">,</span> <span class="n">num_dacs</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ad183x_adc_controls</span><span class="p">,</span> <span class="n">num_adcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">ad183x_dac_dapm_widgets</span><span class="p">,</span> <span class="n">num_dacs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">ad183x_adc_dapm_widgets</span><span class="p">,</span> <span class="n">num_adcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">ad183x_dac_routes</span><span class="p">,</span> <span class="n">num_dacs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">ad183x_adc_routes</span><span class="p">,</span> <span class="n">num_adcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* power down chip */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1836_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset clock control mode */</span>
	<span class="k">return</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AD1836_ADC_CTRL2</span><span class="p">,</span>
		<span class="n">AD1836_ADC_SERFMT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_codec_driver</span> <span class="n">soc_codec_dev_ad1836</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ad1836_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ad1836_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ad1836_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ad1836_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg_cache_size</span> <span class="o">=</span> <span class="n">AD1836_NUM_REGS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg_word_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span>

	<span class="p">.</span><span class="n">controls</span> <span class="o">=</span> <span class="n">ad183x_controls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_controls</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ad183x_controls</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dapm_widgets</span> <span class="o">=</span> <span class="n">ad183x_dapm_widgets</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_dapm_widgets</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ad183x_dapm_widgets</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dapm_routes</span> <span class="o">=</span> <span class="n">ad183x_dapm_routes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_dapm_routes</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ad183x_dapm_routes</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ad1836_spi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad1836_priv</span> <span class="o">*</span><span class="n">ad1836</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ad1836</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad1836_priv</span><span class="p">),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ad1836</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ad1836</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">spi_get_device_id</span><span class="p">(</span><span class="n">spi</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">spi_set_drvdata</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="n">ad1836</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_register_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">soc_codec_dev_ad1836</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad183x_dais</span><span class="p">[</span><span class="n">ad1836</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ad1836_spi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_unregister_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">spi_device_id</span> <span class="n">ad1836_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ad1835&quot;</span><span class="p">,</span> <span class="n">AD1835</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ad1836&quot;</span><span class="p">,</span> <span class="n">AD1836</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ad1837&quot;</span><span class="p">,</span> <span class="n">AD1835</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ad1838&quot;</span><span class="p">,</span> <span class="n">AD1838</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ad1839&quot;</span><span class="p">,</span> <span class="n">AD1838</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="n">ad1836_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_driver</span> <span class="n">ad1836_spi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ad1836&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ad1836_spi_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ad1836_spi_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">ad1836_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ad1836_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">spi_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad1836_spi_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ad1836_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ad1836_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad1836_spi_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ad1836_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ASoC ad1836 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Barry Song &lt;21cnbao@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
