<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › codecs › tlv320aic26.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tlv320aic26.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Texas Instruments TLV320AIC26 low power audio CODEC</span>
<span class="cm"> * ALSA SoC CODEC driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Secret Lab Technologies Ltd.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &quot;tlv320aic26.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ASoC TLV320AIC26 codec driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Grant Likely &lt;grant.likely@secretlab.ca&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* AIC26 driver private data */</span>
<span class="k">struct</span> <span class="n">aic26</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">master</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">datfm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mclk</span><span class="p">;</span>

	<span class="cm">/* Keyclick parameters */</span>
	<span class="kt">int</span> <span class="n">keyclick_amplitude</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keyclick_freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keyclick_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Register access routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">aic26_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aic26</span> <span class="o">*</span><span class="n">aic26</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">AIC26_NUM_REGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do SPI transfer; first 16bits are command; remaining is</span>
<span class="cm">	 * register contents */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">AIC26_READ_COMMAND_WORD</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">spi_write_then_read</span><span class="p">(</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIC26 reg read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Update the cache before returning with the value */</span>
	<span class="n">cache</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">aic26_reg_read_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">AIC26_NUM_REGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic26_reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aic26</span> <span class="o">*</span><span class="n">aic26</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">AIC26_NUM_REGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do SPI transfer; first 16bits are command; remaining is data</span>
<span class="cm">	 * to write into register */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">AIC26_WRITE_COMMAND_WORD</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">spi_write</span><span class="p">(</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIC26 reg read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update cache before returning */</span>
	<span class="n">cache</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Digital Audio Interface Operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic26_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic26</span> <span class="o">*</span><span class="n">aic26</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">fsref</span><span class="p">,</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">jval</span><span class="p">,</span> <span class="n">dval</span><span class="p">,</span> <span class="n">qval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;aic26_hw_params(substream=%p, params=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rate=%i format=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
		<span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8000</span>:  <span class="n">fsref</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">AIC26_DIV_6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11025</span>: <span class="n">fsref</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">AIC26_DIV_4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12000</span>: <span class="n">fsref</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">AIC26_DIV_4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16000</span>: <span class="n">fsref</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">AIC26_DIV_3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">22050</span>: <span class="n">fsref</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">AIC26_DIV_2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24000</span>: <span class="n">fsref</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">AIC26_DIV_2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32000</span>: <span class="n">fsref</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">AIC26_DIV_1_5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>: <span class="n">fsref</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">AIC26_DIV_1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>: <span class="n">fsref</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">AIC26_DIV_1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* select data word length */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S8</span>:     <span class="n">wlen</span> <span class="o">=</span> <span class="n">AIC26_WLEN_16</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_BE</span>: <span class="n">wlen</span> <span class="o">=</span> <span class="n">AIC26_WLEN_16</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_BE</span>: <span class="n">wlen</span> <span class="o">=</span> <span class="n">AIC26_WLEN_24</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_BE</span>: <span class="n">wlen</span> <span class="o">=</span> <span class="n">AIC26_WLEN_32</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Configure PLL</span>
<span class="cm">	 * fsref = (mclk * PLLM) / 2048</span>
<span class="cm">	 * where PLLM = J.DDDD (DDDD register ranges from 0 to 9999, decimal)</span>
<span class="cm">	 */</span>
	<span class="n">pval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* compute J portion of multiplier */</span>
	<span class="n">jval</span> <span class="o">=</span> <span class="n">fsref</span> <span class="o">/</span> <span class="p">(</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">2048</span><span class="p">);</span>
	<span class="cm">/* compute fractional DDDD component of multiplier */</span>
	<span class="n">dval</span> <span class="o">=</span> <span class="n">fsref</span> <span class="o">-</span> <span class="p">(</span><span class="n">jval</span> <span class="o">*</span> <span class="p">(</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">2048</span><span class="p">));</span>
	<span class="n">dval</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="n">dval</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">2048</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Setting PLLM to %d.%04d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jval</span><span class="p">,</span> <span class="n">dval</span><span class="p">);</span>
	<span class="n">qval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">|</span> <span class="n">qval</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span> <span class="o">|</span> <span class="n">pval</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">jval</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">aic26_reg_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_PLL_PROG1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dval</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">aic26_reg_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_PLL_PROG2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Audio Control 3 (master mode, fsref rate) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">aic26_reg_read_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL3</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf800</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x0800</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsref</span> <span class="o">==</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="n">aic26_reg_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL3</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Audio Control 1 (FSref divisor) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">aic26_reg_read_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0fff</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">wlen</span> <span class="o">|</span> <span class="n">aic26</span><span class="o">-&gt;</span><span class="n">datfm</span> <span class="o">|</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">divisor</span><span class="p">;</span>
	<span class="n">aic26_reg_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * aic26_mute - Mute control to reduce noise when changing audio format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic26_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic26</span> <span class="o">*</span><span class="n">aic26</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">aic26_reg_read_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_DAC_GAIN</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;aic26_mute(dai=%p, mute=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dai</span><span class="p">,</span> <span class="n">mute</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x8080</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x8080</span><span class="p">;</span>
	<span class="n">aic26_reg_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_DAC_GAIN</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic26_set_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">clk_id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic26</span> <span class="o">*</span><span class="n">aic26</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;aic26_set_sysclk(dai=%p, clk_id==%i,&quot;</span>
		<span class="s">&quot; freq=%i, dir=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">codec_dai</span><span class="p">,</span> <span class="n">clk_id</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

	<span class="cm">/* MCLK needs to fall between 2MHz and 50 MHz */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">50000000</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aic26</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic26_set_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic26</span> <span class="o">*</span><span class="n">aic26</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;aic26_set_fmt(dai=%p, fmt==%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">codec_dai</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="cm">/* set master/slave audio interface */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>: <span class="n">aic26</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>: <span class="n">aic26</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* interface format */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span>:     <span class="n">aic26</span><span class="o">-&gt;</span><span class="n">datfm</span> <span class="o">=</span> <span class="n">AIC26_DATFM_I2S</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_A</span>:   <span class="n">aic26</span><span class="o">-&gt;</span><span class="n">datfm</span> <span class="o">=</span> <span class="n">AIC26_DATFM_DSP</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_RIGHT_J</span>: <span class="n">aic26</span><span class="o">-&gt;</span><span class="n">datfm</span> <span class="o">=</span> <span class="n">AIC26_DATFM_RIGHTJ</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_LEFT_J</span>:  <span class="n">aic26</span><span class="o">-&gt;</span><span class="n">datfm</span> <span class="o">=</span> <span class="n">AIC26_DATFM_LEFTJ</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Digital Audio Interface Definition</span>
<span class="cm"> */</span>
<span class="cp">#define AIC26_RATES	(SNDRV_PCM_RATE_8000  | SNDRV_PCM_RATE_11025 |\</span>
<span class="cp">			 SNDRV_PCM_RATE_16000 | SNDRV_PCM_RATE_22050 |\</span>
<span class="cp">			 SNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_44100 |\</span>
<span class="cp">			 SNDRV_PCM_RATE_48000)</span>
<span class="cp">#define AIC26_FORMATS	(SNDRV_PCM_FMTBIT_S8     | SNDRV_PCM_FMTBIT_S16_BE |\</span>
<span class="cp">			 SNDRV_PCM_FMTBIT_S24_BE | SNDRV_PCM_FMTBIT_S32_BE)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">aic26_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">aic26_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">digital_mute</span>	<span class="o">=</span> <span class="n">aic26_mute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_sysclk</span>	<span class="o">=</span> <span class="n">aic26_set_sysclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">aic26_set_fmt</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">aic26_dai</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tlv320aic26-hifi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;Playback&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">AIC26_RATES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">AIC26_FORMATS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;Capture&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">AIC26_RATES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">AIC26_FORMATS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aic26_dai_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * ALSA controls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aic26_capture_src_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Mic&quot;</span><span class="p">,</span> <span class="s">&quot;Aux&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aic26_capture_src_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">AIC26_REG_AUDIO_CTRL1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aic26_capture_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aic26_snd_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Output */</span>
	<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span> <span class="n">AIC26_REG_DAC_GAIN</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;PCM Playback Switch&quot;</span><span class="p">,</span> <span class="n">AIC26_REG_DAC_GAIN</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;PCM Capture Volume&quot;</span><span class="p">,</span> <span class="n">AIC26_REG_ADC_GAIN</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;PCM Capture Mute&quot;</span><span class="p">,</span> <span class="n">AIC26_REG_ADC_GAIN</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Keyclick activate&quot;</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Keyclick amplitude&quot;</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Keyclick frequency&quot;</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Keyclick period&quot;</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Capture Source&quot;</span><span class="p">,</span> <span class="n">aic26_capture_src_enum</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * SPI device portion of driver: sysfs files for debugging</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aic26_keyclick_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aic26</span> <span class="o">*</span><span class="n">aic26</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">aic26_reg_read_cache</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL2</span><span class="p">);</span>
	<span class="n">amp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="mi">125</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;amp=%x freq=%iHz len=%iclks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Any write to the keyclick attribute will trigger the keyclick event */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aic26_keyclick_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aic26</span> <span class="o">*</span><span class="n">aic26</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">aic26_reg_read_cache</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL2</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">aic26_reg_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL2</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">keyclick</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">aic26_keyclick_show</span><span class="p">,</span> <span class="n">aic26_keyclick_set</span><span class="p">);</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * SoC CODEC portion of driver: probe and release routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic26_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Probing AIC26 SoC CODEC driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Reset the codec to power on defaults */</span>
	<span class="n">aic26_reg_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_RESET</span><span class="p">,</span> <span class="mh">0xBB00</span><span class="p">);</span>

	<span class="cm">/* Power up CODEC */</span>
	<span class="n">aic26_reg_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_POWER_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Audio Control 3 (master mode, fsref rate) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">aic26_reg_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL3</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf800</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x0800</span><span class="p">;</span> <span class="cm">/* set master mode */</span>
	<span class="n">aic26_reg_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AIC26_REG_AUDIO_CTRL3</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Fill register cache */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_cache_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">aic26_reg_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Register the sysfs files for debugging */</span>
	<span class="cm">/* Create SysFS files */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_keyclick</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error creating sysfs files</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* register controls */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Registering controls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">aic26_snd_controls</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aic26_snd_controls</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_codec_driver</span> <span class="n">aic26_soc_codec_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">aic26_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">aic26_reg_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">aic26_reg_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg_cache_size</span> <span class="o">=</span> <span class="n">AIC26_NUM_REGS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg_word_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * SPI device portion of driver: probe and release routines and SPI</span>
<span class="cm"> * 				 driver registration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic26_spi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aic26</span> <span class="o">*</span><span class="n">aic26</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probing tlv320aic26 spi device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Allocate driver data */</span>
	<span class="n">aic26</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">aic26</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aic26</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Initialize the driver data */</span>
	<span class="n">aic26</span><span class="o">-&gt;</span><span class="n">spi</span> <span class="o">=</span> <span class="n">spi</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">aic26</span><span class="p">);</span>
	<span class="n">aic26</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_register_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">aic26_soc_codec_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic26_dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic26_spi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_unregister_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_driver</span> <span class="n">aic26_spi</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tlv320aic26-codec&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">aic26_spi_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">aic26_spi_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aic26_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">spi_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26_spi</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">aic26_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">aic26_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic26_spi</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">aic26_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
