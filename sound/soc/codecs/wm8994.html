<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › codecs › wm8994.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wm8994.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * wm8994.c  --  WM8994 ALSA SoC Audio driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009 Wolfson Microelectronics plc</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Mark Brown &lt;broonie@opensource.wolfsonmicro.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/jack.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &lt;trace/events/asoc.h&gt;</span>

<span class="cp">#include &lt;linux/mfd/wm8994/core.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/wm8994/registers.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/wm8994/pdata.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/wm8994/gpio.h&gt;</span>

<span class="cp">#include &quot;wm8994.h&quot;</span>
<span class="cp">#include &quot;wm_hubs.h&quot;</span>

<span class="cp">#define WM1811_JACKDET_MODE_NONE  0x0000</span>
<span class="cp">#define WM1811_JACKDET_MODE_JACK  0x0100</span>
<span class="cp">#define WM1811_JACKDET_MODE_MIC   0x0080</span>
<span class="cp">#define WM1811_JACKDET_MODE_AUDIO 0x0180</span>

<span class="cp">#define WM8994_NUM_DRC 3</span>
<span class="cp">#define WM8994_NUM_EQ  3</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span> <span class="n">wm8994_vu_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">WM8994_LEFT_LINE_INPUT_1_2_VOLUME</span><span class="p">,</span> <span class="n">WM8994_IN1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_RIGHT_LINE_INPUT_1_2_VOLUME</span><span class="p">,</span> <span class="n">WM8994_IN1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_LEFT_LINE_INPUT_3_4_VOLUME</span><span class="p">,</span> <span class="n">WM8994_IN2_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_RIGHT_LINE_INPUT_3_4_VOLUME</span><span class="p">,</span> <span class="n">WM8994_IN2_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_SPEAKER_VOLUME_LEFT</span><span class="p">,</span> <span class="n">WM8994_SPKOUT_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_SPEAKER_VOLUME_RIGHT</span><span class="p">,</span> <span class="n">WM8994_SPKOUT_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_LEFT_OUTPUT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_HPOUT1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_RIGHT_OUTPUT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_HPOUT1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_LEFT_OPGA_VOLUME</span><span class="p">,</span> <span class="n">WM8994_MIXOUT_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_RIGHT_OPGA_VOLUME</span><span class="p">,</span> <span class="n">WM8994_MIXOUT_VU</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">WM8994_AIF1_DAC1_LEFT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF1DAC1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF1_DAC1_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF1DAC1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF1_DAC2_LEFT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF1DAC2_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF1_DAC2_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF1DAC2_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF2_DAC_LEFT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF2DAC_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF2_DAC_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF2DAC_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF1_ADC1_LEFT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF1ADC1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF1_ADC1_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF1ADC1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF1_ADC2_LEFT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF1ADC2_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF1_ADC2_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF1ADC2_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF2_ADC_LEFT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF2ADC_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_AIF2_ADC_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_AIF1ADC2_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_DAC1_LEFT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_DAC1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_DAC1_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_DAC1_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_DAC2_LEFT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_DAC2_VU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WM8994_DAC2_RIGHT_VOLUME</span><span class="p">,</span> <span class="n">WM8994_DAC2_VU</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wm8994_drc_base</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">WM8994_AIF1_DRC1_1</span><span class="p">,</span>
	<span class="n">WM8994_AIF1_DRC2_1</span><span class="p">,</span>
	<span class="n">WM8994_AIF2_DRC_1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wm8994_retune_mobile_base</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">WM8994_AIF1_DAC1_EQ_GAINS_1</span><span class="p">,</span>
	<span class="n">WM8994_AIF1_DAC2_EQ_GAINS_1</span><span class="p">,</span>
	<span class="n">WM8994_AIF2_EQ_GAINS_1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">wm8958_default_micdet</span><span class="p">(</span><span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">wm8958_micd_rate</span> <span class="n">micdet_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">32768</span><span class="p">,</span>       <span class="nb">true</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">32768</span><span class="p">,</span>       <span class="nb">false</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">44100</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">44100</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">wm8958_micd_rate</span> <span class="n">jackdet_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">32768</span><span class="p">,</span>       <span class="nb">true</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">32768</span><span class="p">,</span>       <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">44100</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">44100</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm8958_micd_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">best</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sysclk</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">idle</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">wm8958_micd_rate</span> <span class="o">*</span><span class="n">rates</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_rates</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micd_rates</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb</span> <span class="o">!=</span> <span class="n">wm8958_default_micdet</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">idle</span> <span class="o">=</span> <span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_mic</span><span class="p">;</span>

	<span class="n">sysclk</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysclk</span> <span class="o">&amp;</span> <span class="n">WM8994_SYSCLK_SRC</span><span class="p">)</span>
		<span class="n">sysclk</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">sysclk</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micd_rates</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micd_rates</span><span class="p">;</span>
		<span class="n">num_rates</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_micd_rates</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="n">jackdet_rates</span><span class="p">;</span>
		<span class="n">num_rates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">jackdet_rates</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="n">micdet_rates</span><span class="p">;</span>
		<span class="n">num_rates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">micdet_rates</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_rates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idle</span> <span class="o">!=</span> <span class="n">idle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sysclk</span> <span class="o">-</span> <span class="n">sysclk</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">abs</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">sysclk</span> <span class="o">-</span> <span class="n">sysclk</span><span class="p">))</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">idle</span> <span class="o">!=</span> <span class="n">idle</span><span class="p">)</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">start</span> <span class="o">&lt;&lt;</span> <span class="n">WM8958_MICD_BIAS_STARTTIME_SHIFT</span>
		<span class="o">|</span> <span class="n">rates</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="n">WM8958_MICD_RATE_SHIFT</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MICD rate %d,%d for %dHz %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">rates</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">rate</span><span class="p">,</span> <span class="n">sysclk</span><span class="p">,</span>
		<span class="n">idle</span> <span class="o">?</span> <span class="s">&quot;idle&quot;</span> <span class="o">:</span> <span class="s">&quot;active&quot;</span><span class="p">);</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_1</span><span class="p">,</span>
			    <span class="n">WM8958_MICD_BIAS_STARTTIME_MASK</span> <span class="o">|</span>
			    <span class="n">WM8958_MICD_RATE_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">configure_aif_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aif</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">sysclk</span><span class="p">[</span><span class="n">aif</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994_SYSCLK_MCLK1</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8994_SYSCLK_MCLK2</span>:
		<span class="n">reg1</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8994_SYSCLK_FLL1</span>:
		<span class="n">reg1</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8994_SYSCLK_FLL2</span>:
		<span class="n">reg1</span> <span class="o">|=</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">13500000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">reg1</span> <span class="o">|=</span> <span class="n">WM8994_AIF1CLK_DIV</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dividing AIF%d clock to %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">aif</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="n">aif</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF1_CLOCKING_1</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			    <span class="n">WM8994_AIF1CLK_SRC_MASK</span> <span class="o">|</span> <span class="n">WM8994_AIF1CLK_DIV</span><span class="p">,</span>
			    <span class="n">reg1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">configure_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>

	<span class="cm">/* Bring up the AIF clocks first */</span>
	<span class="n">configure_aif_clock</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">configure_aif_clock</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Then switch CLK_SYS over to the higher of them; a change</span>
<span class="cm">	 * can only happen as a result of a clocking change which can</span>
<span class="cm">	 * only be made outside of DAPM so we can safely redo the</span>
<span class="cm">	 * clocking.</span>
<span class="cm">	 */</span>

	<span class="cm">/* If they&#39;re equal it doesn&#39;t matter which is used */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">wm8958_micd_set_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">WM8994_SYSCLK_SRC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">change</span> <span class="o">=</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">,</span>
				     <span class="n">WM8994_SYSCLK_SRC</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="n">wm8958_micd_set_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_clk_sys</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">sink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="cm">/* Check what we&#39;re currently using for CLK_SYS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_SYSCLK_SRC</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="s">&quot;AIF2CLK&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="s">&quot;AIF1CLK&quot;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">clk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sidetone_hpf_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;2.7kHz&quot;</span><span class="p">,</span> <span class="s">&quot;1.35kHz&quot;</span><span class="p">,</span> <span class="s">&quot;675Hz&quot;</span><span class="p">,</span> <span class="s">&quot;370Hz&quot;</span><span class="p">,</span> <span class="s">&quot;180Hz&quot;</span><span class="p">,</span> <span class="s">&quot;90Hz&quot;</span><span class="p">,</span> <span class="s">&quot;45Hz&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">sidetone_hpf</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_SIDETONE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">sidetone_hpf_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">adc_hpf_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;HiFi&quot;</span><span class="p">,</span> <span class="s">&quot;Voice 1&quot;</span><span class="p">,</span> <span class="s">&quot;Voice 2&quot;</span><span class="p">,</span> <span class="s">&quot;Voice 3&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif1adc1_hpf</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF1_ADC1_FILTERS</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">adc_hpf_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif1adc2_hpf</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF1_ADC2_FILTERS</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">adc_hpf_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif2adc_hpf</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF2_ADC_FILTERS</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">adc_hpf_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">aif_tlv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">digital_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">7200</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">st_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">wm8994_3d_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">eq_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">ng_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">10200</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">mixin_boost_tlv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#define WM8994_DRC_SWITCH(xname, reg, shift) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span>
<span class="cp">	.info = snd_soc_info_volsw, .get = snd_soc_get_volsw,\</span>
<span class="cp">	.put = wm8994_put_drc_sw, \</span>
<span class="cp">	.private_value =  SOC_SINGLE_VALUE(reg, shift, 1, 0) }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_put_drc_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Can&#39;t enable both ADC and DAC paths simultaneously */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">==</span> <span class="n">WM8994_AIF1DAC1_DRC_ENA_SHIFT</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">WM8994_AIF1ADC1L_DRC_ENA_MASK</span> <span class="o">|</span>
			<span class="n">WM8994_AIF1ADC1R_DRC_ENA_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">WM8994_AIF1DAC1_DRC_ENA_MASK</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_soc_put_volsw</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm8994_set_drc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">wm8994_drc_base</span><span class="p">[</span><span class="n">drc</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_cfg</span><span class="p">[</span><span class="n">drc</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">save</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Save any enables; the configuration should clear them. */</span>
	<span class="n">save</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">save</span> <span class="o">&amp;=</span> <span class="n">WM8994_AIF1DAC1_DRC_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1ADC1L_DRC_ENA</span> <span class="o">|</span>
		<span class="n">WM8994_AIF1ADC1R_DRC_ENA</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WM8994_DRC_REGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
				    <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">drc_cfgs</span><span class="p">[</span><span class="n">cfg</span><span class="p">].</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">WM8994_AIF1DAC1_DRC_ENA</span> <span class="o">|</span>
			     <span class="n">WM8994_AIF1ADC1L_DRC_ENA</span> <span class="o">|</span>
			     <span class="n">WM8994_AIF1ADC1R_DRC_ENA</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Icky as hell but saves code duplication */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_get_drc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;AIF1DRC1 Mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;AIF1DRC2 Mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;AIF2DRC Mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_put_drc_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drc</span> <span class="o">=</span> <span class="n">wm8994_get_drc</span><span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">drc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_drc_cfgs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_cfg</span><span class="p">[</span><span class="n">drc</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">wm8994_set_drc</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">drc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_get_drc_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">drc</span> <span class="o">=</span> <span class="n">wm8994_get_drc</span><span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_cfg</span><span class="p">[</span><span class="n">drc</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm8994_set_retune_mobile</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">wm8994_retune_mobile_base</span><span class="p">[</span><span class="n">block</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">iface</span><span class="p">,</span> <span class="n">best</span><span class="p">,</span> <span class="n">best_val</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span> <span class="o">||</span> <span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_texts</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">iface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">iface</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find the version of the currently selected configuration</span>
<span class="cm">	 * with the nearest sample rate. */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfg</span><span class="p">[</span><span class="n">block</span><span class="p">];</span>
	<span class="n">best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">best_val</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_cfgs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_texts</span><span class="p">[</span><span class="n">cfg</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">abs</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate</span>
			<span class="o">-</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">dac_rates</span><span class="p">[</span><span class="n">iface</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">best_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">best_val</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate</span>
				       <span class="o">-</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">dac_rates</span><span class="p">[</span><span class="n">iface</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ReTune Mobile %d %s/%dHz for %dHz sample rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">block</span><span class="p">,</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfgs</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfgs</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">rate</span><span class="p">,</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">dac_rates</span><span class="p">[</span><span class="n">iface</span><span class="p">]);</span>

	<span class="cm">/* The EQ will be disabled while reconfiguring it, remember the</span>
<span class="cm">	 * current configuration.</span>
<span class="cm">	 */</span>
	<span class="n">save</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">save</span> <span class="o">&amp;=</span> <span class="n">WM8994_AIF1DAC1_EQ_ENA</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WM8994_EQ_REGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfgs</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">WM8994_AIF1DAC1_EQ_ENA</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Icky as hell but saves code duplication */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_get_retune_mobile_block</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;AIF1.1 EQ Mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;AIF1.2 EQ Mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;AIF2 EQ Mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_put_retune_mobile_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block</span> <span class="o">=</span> <span class="n">wm8994_get_retune_mobile_block</span><span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">block</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_cfgs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfg</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">wm8994_set_retune_mobile</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_get_retune_mobile_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">block</span> <span class="o">=</span> <span class="n">wm8994_get_retune_mobile_block</span><span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfg</span><span class="p">[</span><span class="n">block</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aif_chan_src_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Left&quot;</span><span class="p">,</span> <span class="s">&quot;Right&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif1adcl_src</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF1_CONTROL_1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif_chan_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif1adcr_src</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF1_CONTROL_1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif_chan_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif2adcl_src</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF2_CONTROL_1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif_chan_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif2adcr_src</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF2_CONTROL_1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif_chan_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif1dacl_src</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF1_CONTROL_2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif_chan_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif1dacr_src</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF1_CONTROL_2</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif_chan_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif2dacl_src</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF2_CONTROL_2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif_chan_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif2dacr_src</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_AIF2_CONTROL_2</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif_chan_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">osr_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Low Power&quot;</span><span class="p">,</span> <span class="s">&quot;High Performance&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">dac_osr</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_OVERSAMPLING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">osr_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">adc_osr</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_OVERSAMPLING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">osr_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm8994_snd_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;AIF1ADC1 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC1_LEFT_VOLUME</span><span class="p">,</span>
		 <span class="n">WM8994_AIF1_ADC1_RIGHT_VOLUME</span><span class="p">,</span>
		 <span class="mi">1</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_tlv</span><span class="p">),</span>
<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;AIF1ADC2 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC2_LEFT_VOLUME</span><span class="p">,</span>
		 <span class="n">WM8994_AIF1_ADC2_RIGHT_VOLUME</span><span class="p">,</span>
		 <span class="mi">1</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_tlv</span><span class="p">),</span>
<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;AIF2ADC Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_ADC_LEFT_VOLUME</span><span class="p">,</span>
		 <span class="n">WM8994_AIF2_ADC_RIGHT_VOLUME</span><span class="p">,</span>
		 <span class="mi">1</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_tlv</span><span class="p">),</span>

<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF1ADCL Source&quot;</span><span class="p">,</span> <span class="n">aif1adcl_src</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF1ADCR Source&quot;</span><span class="p">,</span> <span class="n">aif1adcr_src</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2ADCL Source&quot;</span><span class="p">,</span> <span class="n">aif2adcl_src</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2ADCR Source&quot;</span><span class="p">,</span> <span class="n">aif2adcr_src</span><span class="p">),</span>

<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF1DACL Source&quot;</span><span class="p">,</span> <span class="n">aif1dacl_src</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF1DACR Source&quot;</span><span class="p">,</span> <span class="n">aif1dacr_src</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2DACL Source&quot;</span><span class="p">,</span> <span class="n">aif2dacl_src</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2DACR Source&quot;</span><span class="p">,</span> <span class="n">aif2dacr_src</span><span class="p">),</span>

<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_LEFT_VOLUME</span><span class="p">,</span>
		 <span class="n">WM8994_AIF1_DAC1_RIGHT_VOLUME</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_tlv</span><span class="p">),</span>
<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_LEFT_VOLUME</span><span class="p">,</span>
		 <span class="n">WM8994_AIF1_DAC2_RIGHT_VOLUME</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_tlv</span><span class="p">),</span>
<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;AIF2DAC Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_DAC_LEFT_VOLUME</span><span class="p">,</span>
		 <span class="n">WM8994_AIF2_DAC_RIGHT_VOLUME</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_tlv</span><span class="p">),</span>

<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1 Boost Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_CONTROL_2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aif_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF2 Boost Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_CONTROL_2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aif_tlv</span><span class="p">),</span>

<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 EQ Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 EQ Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF2 EQ Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">WM8994_DRC_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 DRC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DRC1_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="n">WM8994_DRC_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1ADC1L DRC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DRC1_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WM8994_DRC_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1ADC1R DRC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DRC1_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">WM8994_DRC_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 DRC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DRC2_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="n">WM8994_DRC_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1ADC2L DRC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DRC2_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WM8994_DRC_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1ADC2R DRC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DRC2_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">WM8994_DRC_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF2DAC DRC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_DRC_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="n">WM8994_DRC_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF2ADCL DRC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_DRC_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WM8994_DRC_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF2ADCR DRC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_DRC_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC1 Right Sidetone Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_MIXER_VOLUMES</span><span class="p">,</span>
	       <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC1 Left Sidetone Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_MIXER_VOLUMES</span><span class="p">,</span>
	       <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC2 Right Sidetone Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_MIXER_VOLUMES</span><span class="p">,</span>
	       <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC2 Left Sidetone Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_MIXER_VOLUMES</span><span class="p">,</span>
	       <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st_tlv</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Sidetone HPF Mux&quot;</span><span class="p">,</span> <span class="n">sidetone_hpf</span><span class="p">),</span>
<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Sidetone HPF Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SIDETONE</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF1ADC1 HPF Mode&quot;</span><span class="p">,</span> <span class="n">aif1adc1_hpf</span><span class="p">),</span>
<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;AIF1ADC1 HPF Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC1_FILTERS</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF1ADC2 HPF Mode&quot;</span><span class="p">,</span> <span class="n">aif1adc2_hpf</span><span class="p">),</span>
<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;AIF1ADC2 HPF Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC2_FILTERS</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2ADC HPF Mode&quot;</span><span class="p">,</span> <span class="n">aif2adc_hpf</span><span class="p">),</span>
<span class="n">SOC_DOUBLE</span><span class="p">(</span><span class="s">&quot;AIF2ADC HPF Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_ADC_FILTERS</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;ADC OSR&quot;</span><span class="p">,</span> <span class="n">adc_osr</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;DAC OSR&quot;</span><span class="p">,</span> <span class="n">dac_osr</span><span class="p">),</span>

<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;DAC1 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_LEFT_VOLUME</span><span class="p">,</span>
		 <span class="n">WM8994_DAC1_RIGHT_VOLUME</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_tlv</span><span class="p">),</span>
<span class="n">SOC_DOUBLE_R</span><span class="p">(</span><span class="s">&quot;DAC1 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_LEFT_VOLUME</span><span class="p">,</span>
	     <span class="n">WM8994_DAC1_RIGHT_VOLUME</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">SOC_DOUBLE_R_TLV</span><span class="p">(</span><span class="s">&quot;DAC2 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_LEFT_VOLUME</span><span class="p">,</span>
		 <span class="n">WM8994_DAC2_RIGHT_VOLUME</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digital_tlv</span><span class="p">),</span>
<span class="n">SOC_DOUBLE_R</span><span class="p">(</span><span class="s">&quot;DAC2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_LEFT_VOLUME</span><span class="p">,</span>
	     <span class="n">WM8994_DAC2_RIGHT_VOLUME</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;SPKL DAC2 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_SPKMIXL_ATTENUATION</span><span class="p">,</span>
	       <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wm_hubs_spkmix_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;SPKL DAC1 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_SPKMIXL_ATTENUATION</span><span class="p">,</span>
	       <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wm_hubs_spkmix_tlv</span><span class="p">),</span>

<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;SPKR DAC2 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_SPKMIXR_ATTENUATION</span><span class="p">,</span>
	       <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wm_hubs_spkmix_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;SPKR DAC1 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_SPKMIXR_ATTENUATION</span><span class="p">,</span>
	       <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wm_hubs_spkmix_tlv</span><span class="p">),</span>

<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 3D Stereo Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_FILTERS_2</span><span class="p">,</span>
	       <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wm8994_3d_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 3D Stereo Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_FILTERS_2</span><span class="p">,</span>
	   <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 3D Stereo Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_FILTERS_2</span><span class="p">,</span>
	       <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wm8994_3d_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 3D Stereo Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_FILTERS_2</span><span class="p">,</span>
	   <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF2DAC 3D Stereo Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_DAC_FILTERS_2</span><span class="p">,</span>
	       <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wm8994_3d_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF2DAC 3D Stereo Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_DAC_FILTERS_2</span><span class="p">,</span>
	   <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm8994_eq_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 EQ1 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 EQ2 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 EQ3 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 EQ4 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_EQ_GAINS_2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 EQ5 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_EQ_GAINS_2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>

<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 EQ1 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 EQ2 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 EQ3 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 EQ4 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_EQ_GAINS_2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 EQ5 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_EQ_GAINS_2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>

<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF2 EQ1 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF2 EQ2 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF2 EQ3 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_EQ_GAINS_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF2 EQ4 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_EQ_GAINS_2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF2 EQ5 Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_EQ_GAINS_2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">eq_tlv</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">wm8958_ng_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;30ms&quot;</span><span class="p">,</span> <span class="s">&quot;125ms&quot;</span><span class="p">,</span> <span class="s">&quot;250ms&quot;</span><span class="p">,</span> <span class="s">&quot;500ms&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">wm8958_aif1dac1_ng_hold</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8958_AIF1_DAC1_NOISE_GATE</span><span class="p">,</span>
			<span class="n">WM8958_AIF1DAC1_NG_THR_SHIFT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm8958_ng_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">wm8958_aif1dac2_ng_hold</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8958_AIF1_DAC2_NOISE_GATE</span><span class="p">,</span>
			<span class="n">WM8958_AIF1DAC2_NG_THR_SHIFT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm8958_ng_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">wm8958_aif2dac_ng_hold</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8958_AIF2_DAC_NOISE_GATE</span><span class="p">,</span>
			<span class="n">WM8958_AIF2DAC_NG_THR_SHIFT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wm8958_ng_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm8958_snd_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF3 Boost Volume&quot;</span><span class="p">,</span> <span class="n">WM8958_AIF3_CONTROL_2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aif_tlv</span><span class="p">),</span>

<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 Noise Gate Switch&quot;</span><span class="p">,</span> <span class="n">WM8958_AIF1_DAC1_NOISE_GATE</span><span class="p">,</span>
	   <span class="n">WM8958_AIF1DAC1_NG_ENA_SHIFT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 Noise Gate Hold Time&quot;</span><span class="p">,</span> <span class="n">wm8958_aif1dac1_ng_hold</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC1 Noise Gate Threshold Volume&quot;</span><span class="p">,</span>
	       <span class="n">WM8958_AIF1_DAC1_NOISE_GATE</span><span class="p">,</span> <span class="n">WM8958_AIF1DAC1_NG_THR_SHIFT</span><span class="p">,</span>
	       <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ng_tlv</span><span class="p">),</span>

<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 Noise Gate Switch&quot;</span><span class="p">,</span> <span class="n">WM8958_AIF1_DAC2_NOISE_GATE</span><span class="p">,</span>
	   <span class="n">WM8958_AIF1DAC2_NG_ENA_SHIFT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 Noise Gate Hold Time&quot;</span><span class="p">,</span> <span class="n">wm8958_aif1dac2_ng_hold</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF1DAC2 Noise Gate Threshold Volume&quot;</span><span class="p">,</span>
	       <span class="n">WM8958_AIF1_DAC2_NOISE_GATE</span><span class="p">,</span> <span class="n">WM8958_AIF1DAC2_NG_THR_SHIFT</span><span class="p">,</span>
	       <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ng_tlv</span><span class="p">),</span>

<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF2DAC Noise Gate Switch&quot;</span><span class="p">,</span> <span class="n">WM8958_AIF2_DAC_NOISE_GATE</span><span class="p">,</span>
	   <span class="n">WM8958_AIF2DAC_NG_ENA_SHIFT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2DAC Noise Gate Hold Time&quot;</span><span class="p">,</span> <span class="n">wm8958_aif2dac_ng_hold</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;AIF2DAC Noise Gate Threshold Volume&quot;</span><span class="p">,</span>
	       <span class="n">WM8958_AIF2_DAC_NOISE_GATE</span><span class="p">,</span> <span class="n">WM8958_AIF2DAC_NG_THR_SHIFT</span><span class="p">,</span>
	       <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ng_tlv</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm1811_snd_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;MIXINL IN1LP Boost Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_INPUT_MIXER_1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">mixin_boost_tlv</span><span class="p">),</span>
<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;MIXINL IN1RP Boost Volume&quot;</span><span class="p">,</span> <span class="n">WM8994_INPUT_MIXER_1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">mixin_boost_tlv</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* We run all mode setting through a function to enforce audio mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm1811_jackdet_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span> <span class="o">||</span> <span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">active_refcount</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">WM1811_JACKDET_MODE_AUDIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet_mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* Always use audio mode to detect while the system is active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WM1811_JACKDET_MODE_NONE</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">WM1811_JACKDET_MODE_AUDIO</span><span class="p">;</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
			    <span class="n">WM1811_JACKDET_MODE_MASK</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">active_reference</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">active_refcount</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Active refcount incremented, now %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">active_refcount</span><span class="p">);</span>

	<span class="cm">/* If we&#39;re using jack detection go into audio mode */</span>
	<span class="n">wm1811_jackdet_set_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM1811_JACKDET_MODE_AUDIO</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">active_dereference</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">active_refcount</span><span class="o">--</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Active refcount decremented, now %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">active_refcount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">active_refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Go into appropriate detection only mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_mic</span> <span class="o">||</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_detecting</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">WM1811_JACKDET_MODE_MIC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">WM1811_JACKDET_MODE_JACK</span><span class="p">;</span>

		<span class="n">wm1811_jackdet_set_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clk_sys_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="k">return</span> <span class="n">configure_clock</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">configure_clock</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vmid_reference</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_refcount</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Referencing VMID, refcount is now %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_refcount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_refcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_1</span><span class="p">,</span>
				    <span class="n">WM8994_LINEOUT1_DISCH</span> <span class="o">|</span>
				    <span class="n">WM8994_LINEOUT2_DISCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">wm_hubs_vmid_ena</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="s">&quot;Invalid VMID mode&quot;</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">WM8994_VMID_NORMAL</span>:
			<span class="cm">/* Startup bias, VMID ramp &amp; buffer */</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
					    <span class="n">WM8994_BIAS_SRC</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_DISCH</span> <span class="o">|</span>
					    <span class="n">WM8994_STARTUP_BIAS_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_BUF_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_RAMP_MASK</span><span class="p">,</span>
					    <span class="n">WM8994_BIAS_SRC</span> <span class="o">|</span>
					    <span class="n">WM8994_STARTUP_BIAS_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_BUF_ENA</span> <span class="o">|</span>
					    <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_VMID_RAMP_SHIFT</span><span class="p">));</span>

			<span class="cm">/* Main bias enable, VMID=2x40k */</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_1</span><span class="p">,</span>
					    <span class="n">WM8994_BIAS_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_SEL_MASK</span><span class="p">,</span>
					    <span class="n">WM8994_BIAS_ENA</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>

			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
					    <span class="n">WM8994_VMID_RAMP_MASK</span> <span class="o">|</span>
					    <span class="n">WM8994_BIAS_SRC</span><span class="p">,</span>
					    <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WM8994_VMID_FORCE</span>:
			<span class="cm">/* Startup bias, slow VMID ramp &amp; buffer */</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
					    <span class="n">WM8994_BIAS_SRC</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_DISCH</span> <span class="o">|</span>
					    <span class="n">WM8994_STARTUP_BIAS_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_BUF_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_RAMP_MASK</span><span class="p">,</span>
					    <span class="n">WM8994_BIAS_SRC</span> <span class="o">|</span>
					    <span class="n">WM8994_STARTUP_BIAS_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_BUF_ENA</span> <span class="o">|</span>
					    <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_VMID_RAMP_SHIFT</span><span class="p">));</span>

			<span class="cm">/* Main bias enable, VMID=2x40k */</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_1</span><span class="p">,</span>
					    <span class="n">WM8994_BIAS_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_VMID_SEL_MASK</span><span class="p">,</span>
					    <span class="n">WM8994_BIAS_ENA</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>

			<span class="n">msleep</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>

			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
					    <span class="n">WM8994_VMID_RAMP_MASK</span> <span class="o">|</span>
					    <span class="n">WM8994_BIAS_SRC</span><span class="p">,</span>
					    <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vmid_dereference</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_refcount</span><span class="o">--</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dereferencing VMID, refcount is now %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_refcount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">lineout1_se</span><span class="p">)</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_3</span><span class="p">,</span>
					    <span class="n">WM8994_LINEOUT1N_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_LINEOUT1P_ENA</span><span class="p">,</span>
					    <span class="n">WM8994_LINEOUT1N_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_LINEOUT1P_ENA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">lineout2_se</span><span class="p">)</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_3</span><span class="p">,</span>
					    <span class="n">WM8994_LINEOUT2N_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_LINEOUT2P_ENA</span><span class="p">,</span>
					    <span class="n">WM8994_LINEOUT2N_ENA</span> <span class="o">|</span>
					    <span class="n">WM8994_LINEOUT2P_ENA</span><span class="p">);</span>

		<span class="cm">/* Start discharging VMID */</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
				    <span class="n">WM8994_BIAS_SRC</span> <span class="o">|</span>
				    <span class="n">WM8994_VMID_DISCH</span><span class="p">,</span>
				    <span class="n">WM8994_BIAS_SRC</span> <span class="o">|</span>
				    <span class="n">WM8994_VMID_DISCH</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WM8994_VMID_FORCE</span>:
			<span class="n">msleep</span><span class="p">(</span><span class="mi">350</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ADDITIONAL_CONTROL</span><span class="p">,</span>
				    <span class="n">WM8994_VROI</span><span class="p">,</span> <span class="n">WM8994_VROI</span><span class="p">);</span>

		<span class="cm">/* Active discharge */</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_1</span><span class="p">,</span>
				    <span class="n">WM8994_LINEOUT1_DISCH</span> <span class="o">|</span>
				    <span class="n">WM8994_LINEOUT2_DISCH</span><span class="p">,</span>
				    <span class="n">WM8994_LINEOUT1_DISCH</span> <span class="o">|</span>
				    <span class="n">WM8994_LINEOUT2_DISCH</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_3</span><span class="p">,</span>
				    <span class="n">WM8994_LINEOUT1N_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_LINEOUT1P_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_LINEOUT2N_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_LINEOUT2P_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ADDITIONAL_CONTROL</span><span class="p">,</span>
				    <span class="n">WM8994_VROI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Switch off startup biases */</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
				    <span class="n">WM8994_BIAS_SRC</span> <span class="o">|</span>
				    <span class="n">WM8994_STARTUP_BIAS_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_VMID_BUF_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_VMID_RAMP_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_1</span><span class="p">,</span>
				    <span class="n">WM8994_BIAS_ENA</span> <span class="o">|</span> <span class="n">WM8994_VMID_SEL_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
				    <span class="n">WM8994_VMID_RAMP_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vmid_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="n">vmid_reference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">vmid_dereference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">wm8994_check_class_w_digital</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* GCC flow analysis can&#39;t track enable */</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">reg_r</span><span class="p">;</span>

	<span class="cm">/* We also need the same AIF source for L/R and only one path */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_DAC1_LEFT_MIXER_ROUTING</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994_AIF2DACL_TO_DAC1L</span>:
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Class W source AIF2DAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">source</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_CP_DYN_SRC_SEL_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM8994_AIF1DAC2L_TO_DAC1L</span>:
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Class W source AIF1DAC2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">source</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_CP_DYN_SRC_SEL_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM8994_AIF1DAC1L_TO_DAC1L</span>:
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Class W source AIF1DAC1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">source</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_CP_DYN_SRC_SEL_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DAC mixer setting: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg_r</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_DAC1_RIGHT_MIXER_ROUTING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_r</span> <span class="o">!=</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Left and right DAC mixers different</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the source up */</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLASS_W_1</span><span class="p">,</span>
			    <span class="n">WM8994_CP_DYN_SRC_SEL_MASK</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aif1clk_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">control_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">WM8994_AIF1DAC1L_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1DAC1R_ENA</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994</span>:
	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">WM8994_AIF1DAC2L_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1DAC2R_ENA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF1_CONTROL_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1ADCL_SRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1ADCR_SRC</span><span class="p">))</span>
			<span class="n">adc</span> <span class="o">=</span> <span class="n">WM8994_AIF1ADC1R_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1ADC2R_ENA</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1ADCL_SRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1ADCR_SRC</span><span class="p">))</span>
			<span class="n">adc</span> <span class="o">=</span> <span class="n">WM8994_AIF1ADC1L_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1ADC2L_ENA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">adc</span> <span class="o">=</span> <span class="n">WM8994_AIF1ADC1R_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1ADC2R_ENA</span> <span class="o">|</span>
				<span class="n">WM8994_AIF1ADC1L_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1ADC2L_ENA</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF1_CONTROL_2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1DACL_SRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1DACR_SRC</span><span class="p">))</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">WM8994_AIF1DAC1R_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1DAC2R_ENA</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1DACL_SRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1DACR_SRC</span><span class="p">))</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">WM8994_AIF1DAC1L_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1DAC2L_ENA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">WM8994_AIF1DAC1R_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1DAC2R_ENA</span> <span class="o">|</span>
				<span class="n">WM8994_AIF1DAC1L_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF1DAC2L_ENA</span><span class="p">;</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span>
				    <span class="n">mask</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span>
				    <span class="n">mask</span><span class="p">,</span> <span class="n">dac</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">,</span>
				    <span class="n">WM8994_AIF1DSPCLK_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_SYSDSPCLK_ENA</span><span class="p">,</span>
				    <span class="n">WM8994_AIF1DSPCLK_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_SYSDSPCLK_ENA</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
				    <span class="n">WM8994_AIF1ADC1R_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF1ADC1L_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF1ADC2R_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF1ADC2L_ENA</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
				    <span class="n">WM8994_AIF1DAC1R_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF1DAC1L_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF1DAC2R_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF1DAC2L_ENA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMU</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_vu_bits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">wm8994_vu_bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span>
				      <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
						   <span class="n">wm8994_vu_bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span>:
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span>
				    <span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span>
				    <span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF2DSPCLK_ENA</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">WM8994_SYSDSPCLK_ENA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">,</span>
				    <span class="n">WM8994_SYSDSPCLK_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF1DSPCLK_ENA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aif2clk_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF2_CONTROL_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF2ADCL_SRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF2ADCR_SRC</span><span class="p">))</span>
			<span class="n">adc</span> <span class="o">=</span> <span class="n">WM8994_AIF2ADCR_ENA</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF2ADCL_SRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF2ADCR_SRC</span><span class="p">))</span>
			<span class="n">adc</span> <span class="o">=</span> <span class="n">WM8994_AIF2ADCL_ENA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">adc</span> <span class="o">=</span> <span class="n">WM8994_AIF2ADCL_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF2ADCR_ENA</span><span class="p">;</span>


		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF2_CONTROL_2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF2DACL_SRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF2DACR_SRC</span><span class="p">))</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">WM8994_AIF2DACR_ENA</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF2DACL_SRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF2DACR_SRC</span><span class="p">))</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">WM8994_AIF2DACL_ENA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">WM8994_AIF2DACL_ENA</span> <span class="o">|</span> <span class="n">WM8994_AIF2DACR_ENA</span><span class="p">;</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2ADCL_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF2ADCR_ENA</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2DACL_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF2DACR_ENA</span><span class="p">,</span> <span class="n">dac</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2DSPCLK_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_SYSDSPCLK_ENA</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2DSPCLK_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_SYSDSPCLK_ENA</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2ADCL_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF2ADCR_ENA</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2ADCL_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF2ADCR_ENA</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2DACL_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF2DACR_ENA</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2DACL_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF2DACR_ENA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMU</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_vu_bits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">wm8994_vu_bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span>
				      <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
						   <span class="n">wm8994_vu_bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span>:
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2DACL_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF2DACR_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span>
				    <span class="n">WM8994_AIF2ADCL_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF2ADCR_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1DSPCLK_ENA</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">WM8994_SYSDSPCLK_ENA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">,</span>
				    <span class="n">WM8994_SYSDSPCLK_ENA</span> <span class="o">|</span>
				    <span class="n">WM8994_AIF2DSPCLK_ENA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aif1clk_late_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif1clk_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif1clk_disable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aif2clk_late_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif2clk_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif2clk_disable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">late_enable_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif1clk_enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aif1clk_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">);</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF1_CLOCKING_1</span><span class="p">,</span>
					    <span class="n">WM8994_AIF1CLK_ENA_MASK</span><span class="p">,</span>
					    <span class="n">WM8994_AIF1CLK_ENA</span><span class="p">);</span>
			<span class="n">aif1clk_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMU</span><span class="p">);</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif1clk_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif2clk_enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aif2clk_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">);</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF2_CLOCKING_1</span><span class="p">,</span>
					    <span class="n">WM8994_AIF2CLK_ENA_MASK</span><span class="p">,</span>
					    <span class="n">WM8994_AIF2CLK_ENA</span><span class="p">);</span>
			<span class="n">aif2clk_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMU</span><span class="p">);</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif2clk_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We may also have postponed startup of DSP, handle that. */</span>
	<span class="n">wm8958_aif_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">late_disable_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif1clk_disable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aif1clk_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">);</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF1_CLOCKING_1</span><span class="p">,</span>
					    <span class="n">WM8994_AIF1CLK_ENA_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">aif1clk_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">);</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif1clk_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif2clk_disable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aif2clk_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">);</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF2_CLOCKING_1</span><span class="p">,</span>
					    <span class="n">WM8994_AIF2CLK_ENA_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">aif2clk_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">);</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aif2clk_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adc_mux_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">late_enable_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">micbias_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">late_enable_ev</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dac_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span>
			    <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">adc_mux_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ADC&quot;</span><span class="p">,</span>
	<span class="s">&quot;DMIC&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">adc_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">adc_mux_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">adcl_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM_VIRT</span><span class="p">(</span><span class="s">&quot;ADCL Mux&quot;</span><span class="p">,</span> <span class="n">adc_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">adcr_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM_VIRT</span><span class="p">(</span><span class="s">&quot;ADCR Mux&quot;</span><span class="p">,</span> <span class="n">adc_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">left_speaker_mixer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Input Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;IN1LP Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Output Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC1 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">right_speaker_mixer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Input Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;IN1RP Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Output Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC1 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_SPEAKER_MIXER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Debugging; dump chip status after DAPM transitions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">post_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SRC status: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
			     <span class="n">WM8994_RATE_STATUS</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif1adc1l_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;ADC/DMIC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC1_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC1_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif1adc1r_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;ADC/DMIC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC1_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC1_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif1adc2l_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;DMIC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC2_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC2_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif1adc2r_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;DMIC Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC2_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_ADC2_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif2dac2l_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Right Sidetone Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Left Sidetone Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1.2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1.1 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif2dac2r_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Right Sidetone Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;Left Sidetone Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1.2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SOC_DAPM_SINGLE</span><span class="p">(</span><span class="s">&quot;AIF1.1 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC2_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define WM8994_CLASS_W_SWITCH(xname, reg, shift, max, invert) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, \</span>
<span class="cp">	.info = snd_soc_info_volsw, \</span>
<span class="cp">	.get = snd_soc_dapm_get_volsw, .put = wm8994_put_class_w, \</span>
<span class="cp">	.private_value =  SOC_SINGLE_VALUE(reg, shift, max, invert) }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_put_class_w</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_put_volsw</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">ucontrol</span><span class="p">);</span>

	<span class="n">wm_hubs_update_class_w</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">dac1l_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;Right Sidetone Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;Left Sidetone Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1.2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1.1 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_LEFT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">dac1r_mix</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;Right Sidetone Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;Left Sidetone Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1.2 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WM8994_CLASS_W_SWITCH</span><span class="p">(</span><span class="s">&quot;AIF1.1 Switch&quot;</span><span class="p">,</span> <span class="n">WM8994_DAC1_RIGHT_MIXER_ROUTING</span><span class="p">,</span>
		      <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sidetone_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ADC/DMIC1&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC2&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">sidetone1_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_SIDETONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sidetone_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">sidetone1_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;Left Sidetone Mux&quot;</span><span class="p">,</span> <span class="n">sidetone1_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">sidetone2_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_SIDETONE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sidetone_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">sidetone2_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;Right Sidetone Mux&quot;</span><span class="p">,</span> <span class="n">sidetone2_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aif1dac_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;AIF1DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif1dac_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_POWER_MANAGEMENT_6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif1dac_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif1dac_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;AIF1DAC Mux&quot;</span><span class="p">,</span> <span class="n">aif1dac_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aif2dac_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;AIF2DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif2dac_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_POWER_MANAGEMENT_6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif2dac_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif2dac_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2DAC Mux&quot;</span><span class="p">,</span> <span class="n">aif2dac_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aif2adc_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;AIF2ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif2adc_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_POWER_MANAGEMENT_6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif2adc_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif2adc_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2ADC Mux&quot;</span><span class="p">,</span> <span class="n">aif2adc_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aif3adc_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;Mono PCM&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">wm8994_aif3adc_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_POWER_MANAGEMENT_6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">aif3adc_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm8994_aif3adc_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;AIF3ADC Mux&quot;</span><span class="p">,</span> <span class="n">wm8994_aif3adc_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">wm8958_aif3adc_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_POWER_MANAGEMENT_6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">aif3adc_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">wm8958_aif3adc_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;AIF3ADC Mux&quot;</span><span class="p">,</span> <span class="n">wm8958_aif3adc_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mono_pcm_out_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCL&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCR&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">mono_pcm_out_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_POWER_MANAGEMENT_6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mono_pcm_out_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">mono_pcm_out_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;Mono PCM Out Mux&quot;</span><span class="p">,</span> <span class="n">mono_pcm_out_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aif2dac_src_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;AIF2&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Note that these two control shouldn&#39;t be simultaneously switched to AIF3 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif2dacl_src_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_POWER_MANAGEMENT_6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif2dac_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif2dacl_src_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2DACL Mux&quot;</span><span class="p">,</span> <span class="n">aif2dacl_src_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">aif2dacr_src_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">WM8994_POWER_MANAGEMENT_6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">aif2dac_src_text</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">aif2dacr_src_mux</span> <span class="o">=</span>
	<span class="n">SOC_DAPM_ENUM</span><span class="p">(</span><span class="s">&quot;AIF2DACR Mux&quot;</span><span class="p">,</span> <span class="n">aif2dacr_src_enum</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">wm8994_lateclk_revd_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;AIF1CLK&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aif1clk_late_ev</span><span class="p">,</span>
	<span class="n">SND_SOC_DAPM_PRE_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;AIF2CLK&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aif2clk_late_ev</span><span class="p">,</span>
	<span class="n">SND_SOC_DAPM_PRE_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;Late DAC1L Enable PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">late_enable_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;Late DAC1R Enable PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">late_enable_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;Late DAC2L Enable PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">late_enable_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;Late DAC2R Enable PGA&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">late_enable_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_PGA_E</span><span class="p">(</span><span class="s">&quot;Direct Voice&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">late_enable_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_MIXER_E</span><span class="p">(</span><span class="s">&quot;SPKL&quot;</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">left_speaker_mixer</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">left_speaker_mixer</span><span class="p">),</span>
		     <span class="n">late_enable_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MIXER_E</span><span class="p">(</span><span class="s">&quot;SPKR&quot;</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">right_speaker_mixer</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">right_speaker_mixer</span><span class="p">),</span>
		     <span class="n">late_enable_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX_E</span><span class="p">(</span><span class="s">&quot;Left Headphone Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm_hubs_hpl_mux</span><span class="p">,</span>
		   <span class="n">late_enable_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX_E</span><span class="p">(</span><span class="s">&quot;Right Headphone Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm_hubs_hpr_mux</span><span class="p">,</span>
		   <span class="n">late_enable_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_POST</span><span class="p">(</span><span class="s">&quot;Late Disable PGA&quot;</span><span class="p">,</span> <span class="n">late_disable_ev</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">wm8994_lateclk_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;AIF1CLK&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF1_CLOCKING_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aif1clk_ev</span><span class="p">,</span>
		    <span class="n">SND_SOC_DAPM_PRE_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span>
		    <span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;AIF2CLK&quot;</span><span class="p">,</span> <span class="n">WM8994_AIF2_CLOCKING_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aif2clk_ev</span><span class="p">,</span>
		    <span class="n">SND_SOC_DAPM_PRE_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span>
		    <span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_PGA</span><span class="p">(</span><span class="s">&quot;Direct Voice&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;SPKL&quot;</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">left_speaker_mixer</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">left_speaker_mixer</span><span class="p">)),</span>
<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;SPKR&quot;</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">right_speaker_mixer</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">right_speaker_mixer</span><span class="p">)),</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;Left Headphone Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm_hubs_hpl_mux</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;Right Headphone Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm_hubs_hpr_mux</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">wm8994_dac_revd_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SND_SOC_DAPM_DAC_E</span><span class="p">(</span><span class="s">&quot;DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">dac_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_DAC_E</span><span class="p">(</span><span class="s">&quot;DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">dac_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_DAC_E</span><span class="p">(</span><span class="s">&quot;DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">dac_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_DAC_E</span><span class="p">(</span><span class="s">&quot;DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">dac_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">wm8994_dac_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_DAC</span><span class="p">(</span><span class="s">&quot;DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">wm8994_adc_revd_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SND_SOC_DAPM_VIRT_MUX_E</span><span class="p">(</span><span class="s">&quot;ADCL Mux&quot;</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adcl_mux</span><span class="p">,</span>
			<span class="n">adc_mux_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_VIRT_MUX_E</span><span class="p">(</span><span class="s">&quot;ADCR Mux&quot;</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adcr_mux</span><span class="p">,</span>
			<span class="n">adc_mux_ev</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">wm8994_adc_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SND_SOC_DAPM_VIRT_MUX</span><span class="p">(</span><span class="s">&quot;ADCL Mux&quot;</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adcl_mux</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_VIRT_MUX</span><span class="p">(</span><span class="s">&quot;ADCR Mux&quot;</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adcr_mux</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">wm8994_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;DMIC1DAT&quot;</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;DMIC2DAT&quot;</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_INPUT</span><span class="p">(</span><span class="s">&quot;Clock&quot;</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_SUPPLY_S</span><span class="p">(</span><span class="s">&quot;MICBIAS Supply&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">micbias_ev</span><span class="p">,</span>
		      <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;VMID&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vmid_event</span><span class="p">,</span>
		    <span class="n">SND_SOC_DAPM_PRE_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;CLK_SYS&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clk_sys_event</span><span class="p">,</span>
		    <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;DSP1CLK&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;DSP2CLK&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;DSPINTCLK&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_AIF_OUT</span><span class="p">(</span><span class="s">&quot;AIF1ADC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		     <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_OUT</span><span class="p">(</span><span class="s">&quot;AIF1ADC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		     <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_IN_E</span><span class="p">(</span><span class="s">&quot;AIF1DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wm8958_aif_ev</span><span class="p">,</span>
		      <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_IN_E</span><span class="p">(</span><span class="s">&quot;AIF1DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wm8958_aif_ev</span><span class="p">,</span>
		      <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_AIF_OUT</span><span class="p">(</span><span class="s">&quot;AIF1ADC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		     <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_OUT</span><span class="p">(</span><span class="s">&quot;AIF1ADC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		     <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_IN_E</span><span class="p">(</span><span class="s">&quot;AIF1DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wm8958_aif_ev</span><span class="p">,</span>
		      <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_IN_E</span><span class="p">(</span><span class="s">&quot;AIF1DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wm8958_aif_ev</span><span class="p">,</span>
		      <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;AIF1ADC1L Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">aif1adc1l_mix</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aif1adc1l_mix</span><span class="p">)),</span>
<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;AIF1ADC1R Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">aif1adc1r_mix</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aif1adc1r_mix</span><span class="p">)),</span>

<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;AIF1ADC2L Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">aif1adc2l_mix</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aif1adc2l_mix</span><span class="p">)),</span>
<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;AIF1ADC2R Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">aif1adc2r_mix</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aif1adc2r_mix</span><span class="p">)),</span>

<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;AIF2DAC2L Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">aif2dac2l_mix</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aif2dac2l_mix</span><span class="p">)),</span>
<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;AIF2DAC2R Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">aif2dac2r_mix</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aif2dac2r_mix</span><span class="p">)),</span>

<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;Left Sidetone&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sidetone1_mux</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;Right Sidetone&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sidetone2_mux</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;DAC1L Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">dac1l_mix</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dac1l_mix</span><span class="p">)),</span>
<span class="n">SND_SOC_DAPM_MIXER</span><span class="p">(</span><span class="s">&quot;DAC1R Mixer&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">dac1r_mix</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dac1r_mix</span><span class="p">)),</span>

<span class="n">SND_SOC_DAPM_AIF_OUT</span><span class="p">(</span><span class="s">&quot;AIF2ADCL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_OUT</span><span class="p">(</span><span class="s">&quot;AIF2ADCR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_IN_E</span><span class="p">(</span><span class="s">&quot;AIF2DACL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wm8958_aif_ev</span><span class="p">,</span>
		      <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_IN_E</span><span class="p">(</span><span class="s">&quot;AIF2DACR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wm8958_aif_ev</span><span class="p">,</span>
		      <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_AIF_IN</span><span class="p">(</span><span class="s">&quot;AIF1DACDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_IN</span><span class="p">(</span><span class="s">&quot;AIF2DACDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_OUT</span><span class="p">(</span><span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_OUT</span><span class="p">(</span><span class="s">&quot;AIF2ADCDAT&quot;</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;AIF1DAC Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aif1dac_mux</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;AIF2DAC Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aif2dac_mux</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;AIF2ADC Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aif2adc_mux</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_AIF_IN</span><span class="p">(</span><span class="s">&quot;AIF3DACDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_AIF_OUT</span><span class="p">(</span><span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;TOCLK&quot;</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;DMIC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;DMIC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;DMIC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;DMIC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="cm">/* Power is done with the muxes since the ADC power also controls the</span>
<span class="cm"> * downsampling chain, the chip will automatically manage the analogue</span>
<span class="cm"> * specific portions.</span>
<span class="cm"> */</span>
<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;ADCL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_ADC</span><span class="p">(</span><span class="s">&quot;ADCR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

<span class="n">SND_SOC_DAPM_POST</span><span class="p">(</span><span class="s">&quot;Debug log&quot;</span><span class="p">,</span> <span class="n">post_ev</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">wm8994_specific_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;AIF3ADC Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm8994_aif3adc_mux</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">wm8958_dapm_widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SND_SOC_DAPM_SUPPLY</span><span class="p">(</span><span class="s">&quot;AIF3&quot;</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;Mono PCM Out Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mono_pcm_out_mux</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;AIF2DACL Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aif2dacl_src_mux</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;AIF2DACR Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aif2dacr_src_mux</span><span class="p">),</span>
<span class="n">SND_SOC_DAPM_MUX</span><span class="p">(</span><span class="s">&quot;AIF3ADC Mux&quot;</span><span class="p">,</span> <span class="n">SND_SOC_NOPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm8958_aif3adc_mux</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">intercon</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;CLK_SYS&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span><span class="p">,</span> <span class="n">check_clk_sys</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CLK_SYS&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2CLK&quot;</span><span class="p">,</span> <span class="n">check_clk_sys</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;DSP1CLK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DSP2CLK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DSPINTCLK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1ADC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1ADC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF2ADCL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2ADCL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2ADCR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2ADCR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2ADCR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF2DACL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;DMIC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DMIC1DAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DMIC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DMIC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DMIC1DAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DMIC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DMIC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DMIC2DAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DMIC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DMIC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DMIC2DAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DMIC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;ADCL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ADCL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ADCL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;ADCR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ADCR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ADCR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;ADCL Mux&quot;</span><span class="p">,</span> <span class="s">&quot;ADC&quot;</span><span class="p">,</span> <span class="s">&quot;ADCL&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ADCL Mux&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC1L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ADCR Mux&quot;</span><span class="p">,</span> <span class="s">&quot;ADC&quot;</span><span class="p">,</span> <span class="s">&quot;ADCR&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ADCR Mux&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC1R&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP1CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DACR&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSP2CLK&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DSPINTCLK&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;TOCLK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1DACDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1 Playback&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2 Playback&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3DACDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF3 Playback&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1 Capture&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADCDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2 Capture&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2ADCDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3 Capture&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF3ADCDAT&quot;</span> <span class="p">},</span>

	<span class="cm">/* AIF1 outputs */</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADC1L Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC1L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;ADC/DMIC Switch&quot;</span><span class="p">,</span> <span class="s">&quot;ADCL Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC1L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACL&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1ADC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADC1R Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC1R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;ADC/DMIC Switch&quot;</span><span class="p">,</span> <span class="s">&quot;ADCR Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC1R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACR&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1ADC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADC2L Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC2L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC2L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC2L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACL&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1ADC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADC2R Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC2R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC2R&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADC2R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACR&quot;</span> <span class="p">},</span>

	<span class="cm">/* Pin level routing for AIF3 */</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1DAC Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1DAC Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1DAC Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1DAC Mux&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1DAC Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DACDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DAC Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2ADC Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCL&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2ADC Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCR&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2ADC Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3ADCDAT&quot;</span> <span class="p">},</span>

	<span class="cm">/* DAC1 inputs */</span>
	<span class="p">{</span> <span class="s">&quot;DAC1L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACL&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1.2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DAC2L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1.1 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DAC1L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Left Sidetone Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Left Sidetone&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Right Sidetone Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Right Sidetone&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;DAC1R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACR&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1.2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DAC2R&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1.1 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DAC1R&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Left Sidetone Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Left Sidetone&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Right Sidetone Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Right Sidetone&quot;</span> <span class="p">},</span>

	<span class="cm">/* DAC2/AIF2 outputs  */</span>
	<span class="p">{</span> <span class="s">&quot;AIF2ADCL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DAC2L Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACL&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1.2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DAC2L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1.1 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DAC1L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Left Sidetone Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Left Sidetone&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2L Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Right Sidetone Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Right Sidetone&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF2ADCR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DAC2R Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACR&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1.2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DAC2R&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1.1 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1DAC1R&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Left Sidetone Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Left Sidetone&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DAC2R Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;Right Sidetone Switch&quot;</span><span class="p">,</span> <span class="s">&quot;Right Sidetone&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADC1L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADC1R&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADC2L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADC2R&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF2ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2ADC Mux&quot;</span> <span class="p">},</span>

	<span class="cm">/* AIF3 output */</span>
	<span class="p">{</span> <span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1ADC1L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1ADC1R&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1ADC2L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF1ADC2R&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCL&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCR&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACL&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACDAT&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DACR&quot;</span> <span class="p">},</span>

	<span class="cm">/* Sidetone */</span>
	<span class="p">{</span> <span class="s">&quot;Left Sidetone&quot;</span><span class="p">,</span> <span class="s">&quot;ADC/DMIC1&quot;</span><span class="p">,</span> <span class="s">&quot;ADCL Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Left Sidetone&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC2&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC2L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Right Sidetone&quot;</span><span class="p">,</span> <span class="s">&quot;ADC/DMIC1&quot;</span><span class="p">,</span> <span class="s">&quot;ADCR Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Right Sidetone&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC2&quot;</span><span class="p">,</span> <span class="s">&quot;DMIC2R&quot;</span> <span class="p">},</span>

	<span class="cm">/* Output stages */</span>
	<span class="p">{</span> <span class="s">&quot;Left Output Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DAC1L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Right Output Mixer&quot;</span><span class="p">,</span> <span class="s">&quot;DAC Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DAC1R&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;SPKL&quot;</span><span class="p">,</span> <span class="s">&quot;DAC1 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DAC1L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SPKL&quot;</span><span class="p">,</span> <span class="s">&quot;DAC2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DAC2L&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;SPKR&quot;</span><span class="p">,</span> <span class="s">&quot;DAC1 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DAC1R&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SPKR&quot;</span><span class="p">,</span> <span class="s">&quot;DAC2 Switch&quot;</span><span class="p">,</span> <span class="s">&quot;DAC2R&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;Left Headphone Mux&quot;</span><span class="p">,</span> <span class="s">&quot;DAC&quot;</span><span class="p">,</span> <span class="s">&quot;DAC1L&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Right Headphone Mux&quot;</span><span class="p">,</span> <span class="s">&quot;DAC&quot;</span><span class="p">,</span> <span class="s">&quot;DAC1R&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">wm8994_lateclk_revd_intercon</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Late DAC1L Enable PGA&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Late DAC1L Enable PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC1L Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Late DAC1R Enable PGA&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Late DAC1R Enable PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC1R Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Late DAC2L Enable PGA&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Late DAC2L Enable PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DAC2L Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Late DAC2R Enable PGA&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Late DAC2R Enable PGA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DAC2R Mixer&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">wm8994_lateclk_intercon</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;DAC1L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC1L Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC1R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;DAC1R Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2L&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DAC2L Mixer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DAC2R&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DAC2R Mixer&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">wm8994_revd_intercon</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;AIF1DACDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DACDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1DACDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF1ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2ADCDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF1ADCDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MICBIAS1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MICBIAS1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;MICBIAS Supply&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MICBIAS2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MICBIAS2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;MICBIAS Supply&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">wm8994_intercon</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DAC Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DAC Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MICBIAS1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;VMID&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MICBIAS2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;VMID&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">wm8958_intercon</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DACL Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACR&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF2DACR Mux&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF2DACL Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DAC Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACL Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACR Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2DAC Mux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF2DACR Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3&quot;</span><span class="p">,</span> <span class="s">&quot;AIF3DACDAT&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF3DACDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AIF3ADCDAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;AIF3&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;Mono PCM Out Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCL&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCL&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Mono PCM Out Mux&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCR&quot;</span><span class="p">,</span> <span class="s">&quot;AIF2ADCR&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;AIF3ADC Mux&quot;</span><span class="p">,</span> <span class="s">&quot;Mono PCM&quot;</span><span class="p">,</span> <span class="s">&quot;Mono PCM Out Mux&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* The size in bits of the FLL divide multiplied by 10</span>
<span class="cm"> * to allow rounding later */</span>
<span class="cp">#define FIXED_FLL_SIZE ((1 &lt;&lt; 16) * 10)</span>

<span class="k">struct</span> <span class="n">fll_div</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">outdiv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clk_ref_div</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fll_fratio</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_get_fll_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fll_div</span> <span class="o">*</span><span class="n">fll</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">freq_in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">Kpart</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">K</span><span class="p">,</span> <span class="n">Ndiv</span><span class="p">,</span> <span class="n">Nmod</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;FLL input=%dHz, output=%dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq_in</span><span class="p">,</span> <span class="n">freq_out</span><span class="p">);</span>

	<span class="cm">/* Scale the input frequency down to &lt;= 13.5MHz */</span>
	<span class="n">fll</span><span class="o">-&gt;</span><span class="n">clk_ref_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">freq_in</span> <span class="o">&gt;</span> <span class="mi">13500000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fll</span><span class="o">-&gt;</span><span class="n">clk_ref_div</span><span class="o">++</span><span class="p">;</span>
		<span class="n">freq_in</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fll</span><span class="o">-&gt;</span><span class="n">clk_ref_div</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;CLK_REF_DIV=%d, Fref=%dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fll</span><span class="o">-&gt;</span><span class="n">clk_ref_div</span><span class="p">,</span> <span class="n">freq_in</span><span class="p">);</span>

	<span class="cm">/* Scale the output to give 90MHz&lt;=Fvco&lt;=100MHz */</span>
	<span class="n">fll</span><span class="o">-&gt;</span><span class="n">outdiv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">freq_out</span> <span class="o">*</span> <span class="p">(</span><span class="n">fll</span><span class="o">-&gt;</span><span class="n">outdiv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">90000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fll</span><span class="o">-&gt;</span><span class="n">outdiv</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fll</span><span class="o">-&gt;</span><span class="n">outdiv</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">freq_out</span> <span class="o">*=</span> <span class="n">fll</span><span class="o">-&gt;</span><span class="n">outdiv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;OUTDIV=%d, Fvco=%dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fll</span><span class="o">-&gt;</span><span class="n">outdiv</span><span class="p">,</span> <span class="n">freq_out</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq_in</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fll</span><span class="o">-&gt;</span><span class="n">fll_fratio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq_in</span> <span class="o">&gt;</span> <span class="mi">256000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fll</span><span class="o">-&gt;</span><span class="n">fll_fratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">freq_in</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq_in</span> <span class="o">&gt;</span> <span class="mi">128000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fll</span><span class="o">-&gt;</span><span class="n">fll_fratio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">freq_in</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq_in</span> <span class="o">&gt;</span> <span class="mi">64000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fll</span><span class="o">-&gt;</span><span class="n">fll_fratio</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">freq_in</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fll</span><span class="o">-&gt;</span><span class="n">fll_fratio</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">freq_in</span> <span class="o">*=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;FLL_FRATIO=%d, Fref=%dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fll</span><span class="o">-&gt;</span><span class="n">fll_fratio</span><span class="p">,</span> <span class="n">freq_in</span><span class="p">);</span>

	<span class="cm">/* Now, calculate N.K */</span>
	<span class="n">Ndiv</span> <span class="o">=</span> <span class="n">freq_out</span> <span class="o">/</span> <span class="n">freq_in</span><span class="p">;</span>

	<span class="n">fll</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="n">Ndiv</span><span class="p">;</span>
	<span class="n">Nmod</span> <span class="o">=</span> <span class="n">freq_out</span> <span class="o">%</span> <span class="n">freq_in</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Nmod=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Nmod</span><span class="p">);</span>

	<span class="cm">/* Calculate fractional part - scale up so we can round. */</span>
	<span class="n">Kpart</span> <span class="o">=</span> <span class="n">FIXED_FLL_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">Nmod</span><span class="p">;</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">Kpart</span><span class="p">,</span> <span class="n">freq_in</span><span class="p">);</span>

	<span class="n">K</span> <span class="o">=</span> <span class="n">Kpart</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">K</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">K</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* Move down to proper range now rounding is done */</span>
	<span class="n">fll</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">=</span> <span class="n">K</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;N=%x K=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fll</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="n">fll</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_wm8994_set_fll</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fll_div</span> <span class="n">fll</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clk1</span><span class="p">,</span> <span class="n">aif_reg</span><span class="p">,</span> <span class="n">aif_src</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">was_enabled</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994_FLL1</span>:
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">aif_src</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM8994_FLL2</span>:
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">aif_src</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_FLL1_CONTROL_1</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">);</span>
	<span class="n">was_enabled</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_FLL1_ENA</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Allow no source specification when stopping */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq_out</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">src</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM8994_FLL_SRC_MCLK1</span>:
	<span class="k">case</span> <span class="n">WM8994_FLL_SRC_MCLK2</span>:
	<span class="k">case</span> <span class="n">WM8994_FLL_SRC_LRCLK</span>:
	<span class="k">case</span> <span class="n">WM8994_FLL_SRC_BCLK</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Are we changing anything? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="n">src</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">in</span> <span class="o">==</span> <span class="n">freq_in</span> <span class="o">&amp;&amp;</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">out</span> <span class="o">==</span> <span class="n">freq_out</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If we&#39;re stopping the FLL redo the old config - no</span>
<span class="cm">	 * registers will actually be written but we avoid GCC flow</span>
<span class="cm">	 * analysis bugs spewing warnings.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq_out</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wm8994_get_fll_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fll</span><span class="p">,</span> <span class="n">freq_in</span><span class="p">,</span> <span class="n">freq_out</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wm8994_get_fll_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fll</span><span class="p">,</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">in</span><span class="p">,</span>
					    <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Make sure that we&#39;re not providing SYSCLK right now */</span>
	<span class="n">clk1</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk1</span> <span class="o">&amp;</span> <span class="n">WM8994_SYSCLK_SRC</span><span class="p">)</span>
		<span class="n">aif_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2_CLOCKING_1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">aif_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1_CLOCKING_1</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">aif_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1CLK_ENA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_AIF1CLK_SRC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">aif_src</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FLL%d is currently providing SYSCLK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We always need to disable the FLL while reconfiguring */</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_FLL1_CONTROL_1</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">,</span>
			    <span class="n">WM8994_FLL1_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_byp</span> <span class="o">&amp;&amp;</span> <span class="n">src</span> <span class="o">==</span> <span class="n">WM8994_FLL_SRC_BCLK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">freq_in</span> <span class="o">==</span> <span class="n">freq_out</span> <span class="o">&amp;&amp;</span> <span class="n">freq_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Bypassing FLL%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_FLL1_CONTROL_5</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">,</span>
				    <span class="n">WM8958_FLL1_BYP</span><span class="p">,</span> <span class="n">WM8958_FLL1_BYP</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">fll</span><span class="p">.</span><span class="n">outdiv</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_FLL1_OUTDIV_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">fll</span><span class="p">.</span><span class="n">fll_fratio</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_FLL1_FRATIO_SHIFT</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_FLL1_CONTROL_2</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">,</span>
			    <span class="n">WM8994_FLL1_OUTDIV_MASK</span> <span class="o">|</span>
			    <span class="n">WM8994_FLL1_FRATIO_MASK</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_FLL1_CONTROL_3</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">,</span>
			    <span class="n">WM8994_FLL1_K_MASK</span><span class="p">,</span> <span class="n">fll</span><span class="p">.</span><span class="n">k</span><span class="p">);</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_FLL1_CONTROL_4</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">,</span>
			    <span class="n">WM8994_FLL1_N_MASK</span><span class="p">,</span>
				    <span class="n">fll</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_FLL1_N_SHIFT</span><span class="p">);</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_FLL1_CONTROL_5</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">,</span>
			    <span class="n">WM8958_FLL1_BYP</span> <span class="o">|</span>
			    <span class="n">WM8994_FLL1_REFCLK_DIV_MASK</span> <span class="o">|</span>
			    <span class="n">WM8994_FLL1_REFCLK_SRC_MASK</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">fll</span><span class="p">.</span><span class="n">clk_ref_div</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_FLL1_REFCLK_DIV_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">src</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Clear any pending completion from a previous failure */</span>
	<span class="n">try_wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>

	<span class="cm">/* Enable (with fractional mode if required) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable VMID if we need it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">was_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">active_reference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WM8994</span>:
				<span class="n">vmid_reference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WM8958</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">vmid_reference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fll</span><span class="p">.</span><span class="n">k</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">WM8994_FLL1_ENA</span> <span class="o">|</span> <span class="n">WM8994_FLL1_FRAC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">WM8994_FLL1_ENA</span><span class="p">;</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_FLL1_CONTROL_1</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">,</span>
				    <span class="n">WM8994_FLL1_ENA</span> <span class="o">|</span> <span class="n">WM8994_FLL1_FRAC</span><span class="p">,</span>
				    <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">[</span><span class="n">id</span><span class="p">],</span>
							      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;Timed out waiting for FLL lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">was_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WM8994</span>:
				<span class="n">vmid_dereference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WM8958</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">vmid_dereference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">active_dereference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">in</span> <span class="o">=</span> <span class="n">freq_in</span><span class="p">;</span>
	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">out</span> <span class="o">=</span> <span class="n">freq_out</span><span class="p">;</span>
	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>

	<span class="n">configure_clock</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wm8994_fll_locked_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">completion</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">opclk_divs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">160</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_set_fll</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_wm8994_set_fll</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">freq_in</span><span class="p">,</span> <span class="n">freq_out</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_set_dai_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">clk_id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* AIF3 shares clocking with AIF1/2 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clk_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994_SYSCLK_MCLK1</span>:
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">sysclk</span><span class="p">[</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">WM8994_SYSCLK_MCLK1</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIF%d using MCLK1 at %uHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8994_SYSCLK_MCLK2</span>:
		<span class="cm">/* TODO: Set GPIO AF */</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">sysclk</span><span class="p">[</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">WM8994_SYSCLK_MCLK2</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIF%d using MCLK2 at %uHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8994_SYSCLK_FLL1</span>:
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">sysclk</span><span class="p">[</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">WM8994_SYSCLK_FLL1</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIF%d using FLL1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8994_SYSCLK_FLL2</span>:
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">sysclk</span><span class="p">[</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">WM8994_SYSCLK_FLL2</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIF%d using FLL2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8994_SYSCLK_OPCLK</span>:
		<span class="cm">/* Special case - a division (times 10) is given and</span>
<span class="cm">		 * no effect on main clocking.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">opclk_divs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">opclk_divs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">freq</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">opclk_divs</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CLOCKING_2</span><span class="p">,</span>
					    <span class="n">WM8994_OPCLK_DIV_MASK</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_2</span><span class="p">,</span>
					    <span class="n">WM8994_OPCLK_ENA</span><span class="p">,</span> <span class="n">WM8994_OPCLK_ENA</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_2</span><span class="p">,</span>
					    <span class="n">WM8994_OPCLK_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">configure_clock</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_set_bias_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">snd_soc_bias_level</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">;</span>

	<span class="n">wm_hubs_set_bias_level</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_ON</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_BIAS_PREPARE</span>:
		<span class="cm">/* MICBIAS into regulating mode */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="k">case</span> <span class="n">WM1811</span>:
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS1</span><span class="p">,</span>
					    <span class="n">WM8958_MICB1_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS2</span><span class="p">,</span>
					    <span class="n">WM8958_MICB2_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">)</span>
			<span class="n">active_reference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_BIAS_STANDBY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WM8958</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Optimise performance for rev A */</span>
					<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
							    <span class="n">WM8958_CHARGE_PUMP_2</span><span class="p">,</span>
							    <span class="n">WM8958_CP_DISCH</span><span class="p">,</span>
							    <span class="n">WM8958_CP_DISCH</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Discharge LINEOUT1 &amp; 2 */</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_1</span><span class="p">,</span>
					    <span class="n">WM8994_LINEOUT1_DISCH</span> <span class="o">|</span>
					    <span class="n">WM8994_LINEOUT2_DISCH</span><span class="p">,</span>
					    <span class="n">WM8994_LINEOUT1_DISCH</span> <span class="o">|</span>
					    <span class="n">WM8994_LINEOUT2_DISCH</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_PREPARE</span><span class="p">)</span>
			<span class="n">active_dereference</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

		<span class="cm">/* MICBIAS into bypass mode on newer devices */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="k">case</span> <span class="n">WM1811</span>:
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS1</span><span class="p">,</span>
					    <span class="n">WM8958_MICB1_MODE</span><span class="p">,</span>
					    <span class="n">WM8958_MICB1_MODE</span><span class="p">);</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS2</span><span class="p">,</span>
					    <span class="n">WM8958_MICB2_MODE</span><span class="p">,</span>
					    <span class="n">WM8958_MICB2_MODE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_BIAS_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">)</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">cur_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wm8994_vmid_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wm8994_vmid_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994_VMID_NORMAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">lineout1_se</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						 <span class="s">&quot;LINEOUT1N Driver&quot;</span><span class="p">);</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						 <span class="s">&quot;LINEOUT1P Driver&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">lineout2_se</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						 <span class="s">&quot;LINEOUT2N Driver&quot;</span><span class="p">);</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						 <span class="s">&quot;LINEOUT2P Driver&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Do the sync with the old mode to allow it to clean up */</span>
		<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8994_VMID_FORCE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">lineout1_se</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_force_enable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						      <span class="s">&quot;LINEOUT1N Driver&quot;</span><span class="p">);</span>
			<span class="n">snd_soc_dapm_force_enable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						      <span class="s">&quot;LINEOUT1P Driver&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">lineout2_se</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_force_enable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						      <span class="s">&quot;LINEOUT2N Driver&quot;</span><span class="p">);</span>
			<span class="n">snd_soc_dapm_force_enable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						      <span class="s">&quot;LINEOUT2P Driver&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">vmid_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_set_dai_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ms_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aif1_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aif1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ms_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1_MASTER_SLAVE</span><span class="p">;</span>
		<span class="n">aif1_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1_CONTROL_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ms_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2_MASTER_SLAVE</span><span class="p">;</span>
		<span class="n">aif1_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2_CONTROL_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
		<span class="n">ms</span> <span class="o">=</span> <span class="n">WM8994_AIF1_MSTR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_B</span>:
		<span class="n">aif1</span> <span class="o">|=</span> <span class="n">WM8994_AIF1_LRCLK_INV</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_A</span>:
		<span class="n">aif1</span> <span class="o">|=</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span>:
		<span class="n">aif1</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_RIGHT_J</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_LEFT_J</span>:
		<span class="n">aif1</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_A</span>:
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_B</span>:
		<span class="cm">/* frame inversion not valid for DSP modes */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_INV_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_NB_NF</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_IB_NF</span>:
			<span class="n">aif1</span> <span class="o">|=</span> <span class="n">WM8994_AIF1_BCLK_INV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span>:
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_RIGHT_J</span>:
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_LEFT_J</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_INV_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_NB_NF</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_IB_IF</span>:
			<span class="n">aif1</span> <span class="o">|=</span> <span class="n">WM8994_AIF1_BCLK_INV</span> <span class="o">|</span> <span class="n">WM8994_AIF1_LRCLK_INV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_IB_NF</span>:
			<span class="n">aif1</span> <span class="o">|=</span> <span class="n">WM8994_AIF1_BCLK_INV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_NB_IF</span>:
			<span class="n">aif1</span> <span class="o">|=</span> <span class="n">WM8994_AIF1_LRCLK_INV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The AIF2 format configuration needs to be mirrored to AIF3</span>
<span class="cm">	 * on WM8958 if it&#39;s in use so just do it all the time. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM1811</span>:
	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_AIF3_CONTROL_1</span><span class="p">,</span>
					    <span class="n">WM8994_AIF1_LRCLK_INV</span> <span class="o">|</span>
					    <span class="n">WM8958_AIF3_FMT_MASK</span><span class="p">,</span> <span class="n">aif1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">aif1_reg</span><span class="p">,</span>
			    <span class="n">WM8994_AIF1_BCLK_INV</span> <span class="o">|</span> <span class="n">WM8994_AIF1_LRCLK_INV</span> <span class="o">|</span>
			    <span class="n">WM8994_AIF1_FMT_MASK</span><span class="p">,</span>
			    <span class="n">aif1</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">ms_reg</span><span class="p">,</span> <span class="n">WM8994_AIF1_MSTR</span><span class="p">,</span>
			    <span class="n">ms</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span> <span class="n">srs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">8000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">11025</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">12000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">16000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">22050</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">24000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">6</span><span class="p">,</span>  <span class="mi">32000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">44100</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">48000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span>  <span class="mi">88200</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">96000</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fs_ratios</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">348</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1408</span><span class="p">,</span> <span class="mi">1536</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">bclk_divs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">440</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span>
	<span class="mi">640</span><span class="p">,</span> <span class="mi">880</span><span class="p">,</span> <span class="mi">960</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1760</span><span class="p">,</span> <span class="mi">1920</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">aif1_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aif2_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bclk_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lrclk_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aif1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aif2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lrclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cur_val</span><span class="p">,</span> <span class="n">best_val</span><span class="p">,</span> <span class="n">bclk_rate</span><span class="p">,</span> <span class="n">best</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">aif1_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1_CONTROL_1</span><span class="p">;</span>
		<span class="n">aif2_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1_CONTROL_2</span><span class="p">;</span>
		<span class="n">bclk_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1_BCLK</span><span class="p">;</span>
		<span class="n">rate_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1_RATE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="o">||</span>
		    <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">lrclk_shared</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">lrclk_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1DAC_LRCLK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lrclk_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1ADC_LRCLK</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIF1 using split LRCLK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">aif1_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2_CONTROL_1</span><span class="p">;</span>
		<span class="n">aif2_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2_CONTROL_2</span><span class="p">;</span>
		<span class="n">bclk_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2_BCLK</span><span class="p">;</span>
		<span class="n">rate_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2_RATE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="o">||</span>
		    <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">lrclk_shared</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">lrclk_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2DAC_LRCLK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lrclk_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2ADC_LRCLK</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIF2 using split LRCLK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bclk_rate</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="n">bclk_rate</span> <span class="o">*=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S20_3LE</span>:
		<span class="n">bclk_rate</span> <span class="o">*=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">aif1</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_LE</span>:
		<span class="n">bclk_rate</span> <span class="o">*=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">aif1</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span>:
		<span class="n">bclk_rate</span> <span class="o">*=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">aif1</span> <span class="o">|=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to find an appropriate sample rate; look for an exact match. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">srs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate</span> <span class="o">==</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">srs</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">rate_val</span> <span class="o">|=</span> <span class="n">srs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_AIF1_SR_SHIFT</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Sample rate is %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIF%dCLK is %dHz, target BCLK %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="n">id</span><span class="p">],</span> <span class="n">bclk_rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">aif1_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x18</span><span class="p">)</span>
		<span class="n">aif2</span> <span class="o">|=</span> <span class="n">WM8994_AIF1_MONO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AIF%dCLK not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* AIFCLK/fs ratio; look for a close match in either direction */</span>
	<span class="n">best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">best_val</span> <span class="o">=</span> <span class="n">abs</span><span class="p">((</span><span class="n">fs_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
		       <span class="o">-</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fs_ratios</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_val</span> <span class="o">=</span> <span class="n">abs</span><span class="p">((</span><span class="n">fs_ratios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
			      <span class="o">-</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_val</span> <span class="o">&gt;=</span> <span class="n">best_val</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">best</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">best_val</span> <span class="o">=</span> <span class="n">cur_val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Selected AIF%dCLK/fs = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">fs_ratios</span><span class="p">[</span><span class="n">best</span><span class="p">]);</span>
	<span class="n">rate_val</span> <span class="o">|=</span> <span class="n">best</span><span class="p">;</span>

	<span class="cm">/* We may not get quite the right frequency if using</span>
<span class="cm">	 * approximate clocks so look for the closest match that is</span>
<span class="cm">	 * higher than the target (we need to ensure that there enough</span>
<span class="cm">	 * BCLKs to clock out the samples).</span>
<span class="cm">	 */</span>
	<span class="n">best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bclk_divs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="n">bclk_divs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">bclk_rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* BCLK table is sorted */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">best</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bclk_rate</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">aifclk</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="n">bclk_divs</span><span class="p">[</span><span class="n">best</span><span class="p">];</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Using BCLK_DIV %d for actual BCLK %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bclk_divs</span><span class="p">[</span><span class="n">best</span><span class="p">],</span> <span class="n">bclk_rate</span><span class="p">);</span>
	<span class="n">bclk</span> <span class="o">|=</span> <span class="n">best</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_AIF1_BCLK_DIV_SHIFT</span><span class="p">;</span>

	<span class="n">lrclk</span> <span class="o">=</span> <span class="n">bclk_rate</span> <span class="o">/</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lrclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to generate LRCLK from %dHz BCLK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bclk_rate</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Using LRCLK rate %d for actual LRCLK %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lrclk</span><span class="p">,</span> <span class="n">bclk_rate</span> <span class="o">/</span> <span class="n">lrclk</span><span class="p">);</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">aif1_reg</span><span class="p">,</span> <span class="n">WM8994_AIF1_WL_MASK</span><span class="p">,</span> <span class="n">aif1</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">aif2_reg</span><span class="p">,</span> <span class="n">WM8994_AIF1_MONO</span><span class="p">,</span> <span class="n">aif2</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">bclk_reg</span><span class="p">,</span> <span class="n">WM8994_AIF1_BCLK_DIV_MASK</span><span class="p">,</span> <span class="n">bclk</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">lrclk_reg</span><span class="p">,</span> <span class="n">WM8994_AIF1DAC_RATE_MASK</span><span class="p">,</span>
			    <span class="n">lrclk</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">rate_reg</span><span class="p">,</span> <span class="n">WM8994_AIF1_SR_MASK</span> <span class="o">|</span>
			    <span class="n">WM8994_AIF1CLK_RATE_MASK</span><span class="p">,</span> <span class="n">rate_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">dac_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
			<span class="n">wm8994_set_retune_mobile</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wm8994_set_retune_mobile</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">dac_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
			<span class="n">wm8994_set_retune_mobile</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_aif3_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aif1_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aif1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WM1811</span>:
		<span class="k">case</span> <span class="n">WM8958</span>:
			<span class="n">aif1_reg</span> <span class="o">=</span> <span class="n">WM8958_AIF3_CONTROL_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S20_3LE</span>:
		<span class="n">aif1</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_LE</span>:
		<span class="n">aif1</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span>:
		<span class="n">aif1</span> <span class="o">|=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">aif1_reg</span><span class="p">,</span> <span class="n">WM8994_AIF1_WL_MASK</span><span class="p">,</span> <span class="n">aif1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_aif_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mute_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">mute_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1_DAC1_FILTERS_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">mute_reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2_DAC_FILTERS_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1DAC1_MUTE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">mute_reg</span><span class="p">,</span> <span class="n">WM8994_AIF1DAC1_MUTE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_set_tristate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tristate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">WM8994_AIF1_MASTER_SLAVE</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">WM8994_AIF1_TRI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">WM8994_AIF2_MASTER_SLAVE</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">WM8994_AIF2_TRI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tristate</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_aif2_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>

	<span class="cm">/* Disable the pulls on the AIF if we&#39;re using it to save power. */</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_GPIO_3</span><span class="p">,</span>
			    <span class="n">WM8994_GPN_PU</span> <span class="o">|</span> <span class="n">WM8994_GPN_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_GPIO_4</span><span class="p">,</span>
			    <span class="n">WM8994_GPN_PU</span> <span class="o">|</span> <span class="n">WM8994_GPN_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_GPIO_5</span><span class="p">,</span>
			    <span class="n">WM8994_GPN_PU</span> <span class="o">|</span> <span class="n">WM8994_GPN_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WM8994_RATES SNDRV_PCM_RATE_8000_96000</span>

<span class="cp">#define WM8994_FORMATS (SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S20_3LE |\</span>
<span class="cp">			SNDRV_PCM_FMTBIT_S24_LE | SNDRV_PCM_FMTBIT_S32_LE)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">wm8994_aif1_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_sysclk</span>	<span class="o">=</span> <span class="n">wm8994_set_dai_sysclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">wm8994_set_dai_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">wm8994_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">digital_mute</span>	<span class="o">=</span> <span class="n">wm8994_aif_mute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pll</span>	<span class="o">=</span> <span class="n">wm8994_set_fll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tristate</span>	<span class="o">=</span> <span class="n">wm8994_set_tristate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">wm8994_aif2_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_sysclk</span>	<span class="o">=</span> <span class="n">wm8994_set_dai_sysclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">wm8994_set_dai_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">wm8994_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">digital_mute</span>   <span class="o">=</span> <span class="n">wm8994_aif_mute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pll</span>	<span class="o">=</span> <span class="n">wm8994_set_fll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tristate</span>	<span class="o">=</span> <span class="n">wm8994_set_tristate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">wm8994_aif3_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">wm8994_aif3_hw_params</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">wm8994_dai</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wm8994-aif1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;AIF1 Playback&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">WM8994_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">WM8994_FORMATS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sig_bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;AIF1 Capture&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">WM8994_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">WM8994_FORMATS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sig_bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		 <span class="p">},</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wm8994_aif1_dai_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wm8994-aif2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;AIF2 Playback&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">WM8994_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">WM8994_FORMATS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sig_bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;AIF2 Capture&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">WM8994_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">WM8994_FORMATS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sig_bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">wm8994_aif2_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wm8994_aif2_dai_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wm8994-aif3&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;AIF3 Playback&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">WM8994_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">WM8994_FORMATS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sig_bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;AIF3 Capture&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">WM8994_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">WM8994_FORMATS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sig_bits</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		 <span class="p">},</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wm8994_aif3_dai_ops</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_codec_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994</span>:
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_MICBIAS</span><span class="p">,</span> <span class="n">WM8994_MICD_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM1811</span>:
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
				    <span class="n">WM1811_JACKDET_MODE_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_1</span><span class="p">,</span>
				    <span class="n">WM8958_MICD_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_suspend</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm8994_fll_config</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_wm8994_set_fll</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to stop FLL%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wm8994_set_bias_level</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_codec_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* force a HW read */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_read</span><span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span>
				  <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="cm">/* modify the cache only */</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">cache_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span>  <span class="n">WM8994_DAC1R_ENA</span> <span class="o">|</span> <span class="n">WM8994_DAC1L_ENA</span> <span class="o">|</span>
			<span class="n">WM8994_DAC2R_ENA</span> <span class="o">|</span> <span class="n">WM8994_DAC2L_ENA</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_POWER_MANAGEMENT_5</span><span class="p">,</span>
				    <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">cache_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_suspend</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">out</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">_wm8994_set_fll</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_suspend</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span><span class="p">,</span>
				     <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_suspend</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in</span><span class="p">,</span>
				     <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_suspend</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to restore FLL%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span> <span class="o">||</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">jack</span><span class="p">)</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_MICBIAS</span><span class="p">,</span>
					    <span class="n">WM8994_MICD_ENA</span><span class="p">,</span> <span class="n">WM8994_MICD_ENA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM1811</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span> <span class="o">&amp;&amp;</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Restart from idle */</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
					    <span class="n">WM1811_JACKDET_MODE_MASK</span><span class="p">,</span>
					    <span class="n">WM1811_JACKDET_MODE_JACK</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb</span><span class="p">)</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_1</span><span class="p">,</span>
					    <span class="n">WM8958_MICD_ENA</span><span class="p">,</span> <span class="n">WM8958_MICD_ENA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define wm8994_codec_suspend NULL</span>
<span class="cp">#define wm8994_codec_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm8994_handle_retune_mobile_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">SOC_ENUM_EXT</span><span class="p">(</span><span class="s">&quot;AIF1.1 EQ Mode&quot;</span><span class="p">,</span>
			     <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_enum</span><span class="p">,</span>
			     <span class="n">wm8994_get_retune_mobile_enum</span><span class="p">,</span>
			     <span class="n">wm8994_put_retune_mobile_enum</span><span class="p">),</span>
		<span class="n">SOC_ENUM_EXT</span><span class="p">(</span><span class="s">&quot;AIF1.2 EQ Mode&quot;</span><span class="p">,</span>
			     <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_enum</span><span class="p">,</span>
			     <span class="n">wm8994_get_retune_mobile_enum</span><span class="p">,</span>
			     <span class="n">wm8994_put_retune_mobile_enum</span><span class="p">),</span>
		<span class="n">SOC_ENUM_EXT</span><span class="p">(</span><span class="s">&quot;AIF2 EQ Mode&quot;</span><span class="p">,</span>
			     <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_enum</span><span class="p">,</span>
			     <span class="n">wm8994_get_retune_mobile_enum</span><span class="p">,</span>
			     <span class="n">wm8994_put_retune_mobile_enum</span><span class="p">),</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">t</span><span class="p">;</span>

	<span class="cm">/* We need an array of texts for the enum API but the number</span>
<span class="cm">	 * of texts is likely to be less than the number of</span>
<span class="cm">	 * configurations due to the sample rate dependency of the</span>
<span class="cm">	 * configurations. */</span>
	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_texts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_texts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_cfgs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_texts</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				   <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_texts</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_texts</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Expand the array... */</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">krealloc</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_texts</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
			     <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_texts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
			     <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* ...store the new entry... */</span>
		<span class="n">t</span><span class="p">[</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_texts</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">retune_mobile_cfgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>

		<span class="cm">/* ...and remember the new version. */</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_texts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_texts</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Allocated %d unique ReTune Mobile names</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_texts</span><span class="p">);</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_enum</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_texts</span><span class="p">;</span>
	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_enum</span><span class="p">.</span><span class="n">texts</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_texts</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">controls</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">controls</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to add ReTune Mobile controls: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm8994_handle_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wm_hubs_handle_analogue_pdata</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lineout1_diff</span><span class="p">,</span>
				      <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lineout2_diff</span><span class="p">,</span>
				      <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lineout1fb</span><span class="p">,</span>
				      <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lineout2fb</span><span class="p">,</span>
				      <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">jd_scthr</span><span class="p">,</span>
				      <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">jd_thr</span><span class="p">,</span>
				      <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micbias1_lvl</span><span class="p">,</span>
				      <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micbias2_lvl</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d DRC configurations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_drc_cfgs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_drc_cfgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">SOC_ENUM_EXT</span><span class="p">(</span><span class="s">&quot;AIF1DRC1 Mode&quot;</span><span class="p">,</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_enum</span><span class="p">,</span>
				     <span class="n">wm8994_get_drc_enum</span><span class="p">,</span> <span class="n">wm8994_put_drc_enum</span><span class="p">),</span>
			<span class="n">SOC_ENUM_EXT</span><span class="p">(</span><span class="s">&quot;AIF1DRC2 Mode&quot;</span><span class="p">,</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_enum</span><span class="p">,</span>
				     <span class="n">wm8994_get_drc_enum</span><span class="p">,</span> <span class="n">wm8994_put_drc_enum</span><span class="p">),</span>
			<span class="n">SOC_ENUM_EXT</span><span class="p">(</span><span class="s">&quot;AIF2DRC Mode&quot;</span><span class="p">,</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_enum</span><span class="p">,</span>
				     <span class="n">wm8994_get_drc_enum</span><span class="p">,</span> <span class="n">wm8994_put_drc_enum</span><span class="p">),</span>
		<span class="p">};</span>

		<span class="cm">/* We need an array of texts for the enum API */</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_texts</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_drc_cfgs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_texts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to allocate %d DRC config texts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_drc_cfgs</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_drc_cfgs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_texts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">drc_cfgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>

		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_enum</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_drc_cfgs</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_enum</span><span class="p">.</span><span class="n">texts</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">drc_texts</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">controls</span><span class="p">,</span>
					   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">controls</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to add DRC mode controls: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WM8994_NUM_DRC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wm8994_set_drc</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d ReTune Mobile configurations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_cfgs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_retune_mobile_cfgs</span><span class="p">)</span>
		<span class="n">wm8994_handle_retune_mobile_pdata</span><span class="p">(</span><span class="n">wm8994</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">wm8994_eq_controls</span><span class="p">,</span>
				     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_eq_controls</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micbias</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micbias</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micbias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wm8994_mic_detect - Enable microphone detection via the WM8994 IRQ</span>
<span class="cm"> *</span>
<span class="cm"> * @codec:   WM8994 codec</span>
<span class="cm"> * @jack:    jack to report detection events on</span>
<span class="cm"> * @micbias: microphone bias to detect on</span>
<span class="cm"> *</span>
<span class="cm"> * Enable microphone detection via IRQ on the WM8994.  If GPIOs are</span>
<span class="cm"> * being used to bring out signals to the processor then only platform</span>
<span class="cm"> * data configuration is needed for WM8994 and processor GPIOs should</span>
<span class="cm"> * be configured using snd_soc_jack_add_gpios() instead.</span>
<span class="cm"> *</span>
<span class="cm"> * Configuration of detection levels is available via the micbias1_lvl</span>
<span class="cm"> * and micbias2_lvl platform data members.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wm8994_mic_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_jack</span> <span class="o">*</span><span class="n">jack</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">micbias</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_micdet</span> <span class="o">*</span><span class="n">micdet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">WM8994</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not a WM8994</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">micbias</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">micdet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jack</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_force_enable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
							    <span class="s">&quot;MICBIAS1&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						       <span class="s">&quot;MICBIAS1&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">micdet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jack</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_force_enable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
							    <span class="s">&quot;MICBIAS1&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						       <span class="s">&quot;MICBIAS1&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid MICBIAS %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">micbias</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to configure MICBIAS%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">micbias</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Configuring microphone detection on %d %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">micbias</span><span class="p">,</span> <span class="n">jack</span><span class="p">);</span>

	<span class="cm">/* Store the configuration */</span>
	<span class="n">micdet</span><span class="o">-&gt;</span><span class="n">jack</span> <span class="o">=</span> <span class="n">jack</span><span class="p">;</span>
	<span class="n">micdet</span><span class="o">-&gt;</span><span class="n">detecting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* If either of the jacks is set up then enable detection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span> <span class="o">||</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">jack</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">WM8994_MICD_ENA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_MICBIAS</span><span class="p">,</span> <span class="n">WM8994_MICD_ENA</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm8994_mic_detect</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm8994_mic_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">wm8994_priv</span><span class="p">,</span>
						<span class="n">mic_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">regmap</span> <span class="o">*</span><span class="n">regmap</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">report</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_read</span><span class="p">(</span><span class="n">regmap</span><span class="p">,</span> <span class="n">WM8994_INTERRUPT_RAW_STATUS_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read microphone status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Microphone status: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_MIC1_DET_STS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">detecting</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">SND_JACK_HEADSET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_MIC1_SHRT_STS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">detecting</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">SND_JACK_HEADPHONE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">report</span> <span class="o">|=</span> <span class="n">SND_JACK_BTN_0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">detecting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">detecting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">snd_soc_jack_report</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span>
			    <span class="n">SND_JACK_HEADSET</span> <span class="o">|</span> <span class="n">SND_JACK_BTN_0</span><span class="p">);</span>

	<span class="n">report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_MIC2_DET_STS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">detecting</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">SND_JACK_HEADSET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_MIC2_SHRT_STS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">detecting</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">SND_JACK_HEADPHONE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">report</span> <span class="o">|=</span> <span class="n">SND_JACK_BTN_0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">detecting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">detecting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">snd_soc_jack_report</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">jack</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span>
			    <span class="n">SND_JACK_HEADSET</span> <span class="o">|</span> <span class="n">SND_JACK_BTN_0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wm8994_mic_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_SND_SOC_WM8994_MODULE</span>
	<span class="n">trace_snd_soc_jack_irq</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">pm_wakeup_event</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mic_work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Default microphone detection handler for WM8958 - the user can</span>
<span class="cm"> * override this if they wish.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm8958_default_micdet</span><span class="p">(</span><span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">report</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MICDET %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Either nothing present or just starting detection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">WM8958_MICD_STS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If nothing present then clear our statuses */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detected open circuit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_mic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_detecting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="n">wm8958_micd_set_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

			<span class="n">snd_soc_jack_report</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">btn_mask</span> <span class="o">|</span>
					     <span class="n">SND_JACK_HEADSET</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the measurement is showing a high impedence we&#39;ve got a</span>
<span class="cm">	 * microphone.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_detecting</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x600</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detected microphone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_detecting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_mic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">wm8958_micd_set_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

		<span class="n">snd_soc_jack_report</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span><span class="p">,</span> <span class="n">SND_JACK_HEADSET</span><span class="p">,</span>
				    <span class="n">SND_JACK_HEADSET</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_detecting</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detected headphone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_detecting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">wm8958_micd_set_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

		<span class="cm">/* If we have jackdet that will detect removal */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>

			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_1</span><span class="p">,</span>
					    <span class="n">WM8958_MICD_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">wm1811_jackdet_set_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
						<span class="n">WM1811_JACKDET_MODE_JACK</span><span class="p">);</span>

			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">jd_ext_cap</span><span class="p">)</span>
				<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
							 <span class="s">&quot;MICBIAS2&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">snd_soc_jack_report</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span><span class="p">,</span> <span class="n">SND_JACK_HEADPHONE</span><span class="p">,</span>
				    <span class="n">SND_JACK_HEADSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Report short circuit as a button */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_mic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">|=</span> <span class="n">SND_JACK_BTN_0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">|=</span> <span class="n">SND_JACK_BTN_1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">|=</span> <span class="n">SND_JACK_BTN_2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">|=</span> <span class="n">SND_JACK_BTN_3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">|=</span> <span class="n">SND_JACK_BTN_4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">|=</span> <span class="n">SND_JACK_BTN_5</span><span class="p">;</span>

		<span class="n">snd_soc_jack_report</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span>
				    <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">btn_mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wm1811_jackdet_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">present</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM1811_JACKDET_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read jack status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;JACKDET %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">present</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM1811_JACKDET_LVL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Jack detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">wm8958_micd_set_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS2</span><span class="p">,</span>
				    <span class="n">WM8958_MICB2_DISCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Disable debounce while inserted */</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM1811_JACKDET_CTRL</span><span class="p">,</span>
				    <span class="n">WM1811_JACKDET_DB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Start off measument of microphone impedence to find</span>
<span class="cm">		 * out what&#39;s actually there.</span>
<span class="cm">		 */</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_detecting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">wm1811_jackdet_set_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM1811_JACKDET_MODE_MIC</span><span class="p">);</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_1</span><span class="p">,</span>
				    <span class="n">WM8958_MICD_ENA</span><span class="p">,</span> <span class="n">WM8958_MICD_ENA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Jack not detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS2</span><span class="p">,</span>
				    <span class="n">WM8958_MICB2_DISCH</span><span class="p">,</span> <span class="n">WM8958_MICB2_DISCH</span><span class="p">);</span>

		<span class="cm">/* Enable debounce while removed */</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM1811_JACKDET_CTRL</span><span class="p">,</span>
				    <span class="n">WM1811_JACKDET_DB</span><span class="p">,</span> <span class="n">WM1811_JACKDET_DB</span><span class="p">);</span>

		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_detecting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_mic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_1</span><span class="p">,</span>
				    <span class="n">WM8958_MICD_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wm1811_jackdet_set_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM1811_JACKDET_MODE_JACK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>

	<span class="cm">/* If required for an external cap force MICBIAS on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">jd_ext_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_force_enable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						      <span class="s">&quot;MICBIAS2&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;MICBIAS2&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span>
		<span class="n">snd_soc_jack_report</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span><span class="p">,</span>
				    <span class="n">SND_JACK_MECHANICAL</span><span class="p">,</span> <span class="n">SND_JACK_MECHANICAL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_soc_jack_report</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">SND_JACK_MECHANICAL</span> <span class="o">|</span> <span class="n">SND_JACK_HEADSET</span> <span class="o">|</span>
				    <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">btn_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wm8958_mic_detect - Enable microphone detection via the WM8958 IRQ</span>
<span class="cm"> *</span>
<span class="cm"> * @codec:   WM8958 codec</span>
<span class="cm"> * @jack:    jack to report detection events on</span>
<span class="cm"> *</span>
<span class="cm"> * Enable microphone detection functionality for the WM8958.  By</span>
<span class="cm"> * default simple detection which supports the detection of up to 6</span>
<span class="cm"> * buttons plus video and microphone functionality is supported.</span>
<span class="cm"> *</span>
<span class="cm"> * The WM8958 has an advanced jack detection facility which is able to</span>
<span class="cm"> * support complex accessory detection, especially when used in</span>
<span class="cm"> * conjunction with external circuitry.  In order to provide maximum</span>
<span class="cm"> * flexiblity a callback is provided which allows a completely custom</span>
<span class="cm"> * detection algorithm.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wm8958_mic_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_jack</span> <span class="o">*</span><span class="n">jack</span><span class="p">,</span>
		      <span class="n">wm8958_micdet_cb</span> <span class="n">cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cb_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">micd_lvl_sel</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM1811</span>:
	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jack</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Using default micdet callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="n">wm8958_default_micdet</span><span class="p">;</span>
			<span class="n">cb_data</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snd_soc_dapm_force_enable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span><span class="p">);</span>
		<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">jack</span> <span class="o">=</span> <span class="n">jack</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb_data</span> <span class="o">=</span> <span class="n">cb_data</span><span class="p">;</span>

		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_detecting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_mic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">wm8958_micd_set_rate</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

		<span class="cm">/* Detect microphones and short circuits by default */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micd_lvl_sel</span><span class="p">)</span>
			<span class="n">micd_lvl_sel</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micd_lvl_sel</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">micd_lvl_sel</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>

		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">btn_mask</span> <span class="o">=</span> <span class="n">SND_JACK_BTN_0</span> <span class="o">|</span> <span class="n">SND_JACK_BTN_1</span> <span class="o">|</span>
			<span class="n">SND_JACK_BTN_2</span> <span class="o">|</span> <span class="n">SND_JACK_BTN_3</span> <span class="o">|</span>
			<span class="n">SND_JACK_BTN_4</span> <span class="o">|</span> <span class="n">SND_JACK_BTN_5</span><span class="p">;</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_2</span><span class="p">,</span>
				    <span class="n">WM8958_MICD_LVL_SEL_MASK</span><span class="p">,</span> <span class="n">micd_lvl_sel</span><span class="p">);</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">&gt;</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we can use jack detection start off with that,</span>
<span class="cm">		 * otherwise jump straight to microphone detection.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS2</span><span class="p">,</span>
					    <span class="n">WM8958_MICB2_DISCH</span><span class="p">,</span>
					    <span class="n">WM8958_MICB2_DISCH</span><span class="p">);</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_LDO_1</span><span class="p">,</span>
					    <span class="n">WM8994_LDO1_DISCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wm1811_jackdet_set_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span>
						<span class="n">WM1811_JACKDET_MODE_JACK</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_1</span><span class="p">,</span>
					    <span class="n">WM8958_MICD_ENA</span><span class="p">,</span> <span class="n">WM8958_MICD_ENA</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_1</span><span class="p">,</span>
				    <span class="n">WM8958_MICD_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wm1811_jackdet_set_mode</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM1811_JACKDET_MODE_NONE</span><span class="p">);</span>
		<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="s">&quot;CLK_SYS&quot;</span><span class="p">);</span>
		<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm8958_mic_detect</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wm8958_mic_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Jack detection may have detected a removal simulataneously</span>
<span class="cm">	 * with an update of the MICDET status; if so it will have</span>
<span class="cm">	 * stopped detection and we can ignore this interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WM8958_MICD_ENA</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="cm">/* We may occasionally read a detection without an impedence</span>
<span class="cm">	 * range being provided - if that happens loop again.</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MIC_DETECT_3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to read mic detect status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8958_MICD_VALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mic detect data not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8958_MICD_STS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8958_MICD_LVL_MASK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No impedence range reported for jack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_SND_SOC_WM8994_MODULE</span>
	<span class="n">trace_snd_soc_jack_irq</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb</span><span class="p">)</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb_data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Accessory detection with no callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wm8994_fifo_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FIFO error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wm8994_temp_warn</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Thermal warning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wm8994_temp_shut</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">dev_crit</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Thermal shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_codec_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">control_data</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">;</span>

	<span class="n">snd_soc_codec_set_cache_io</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SND_SOC_REGMAP</span><span class="p">);</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">accdet_lock</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mic_work</span><span class="p">,</span> <span class="n">wm8994_mic_work</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">)</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">)</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span>
				     <span class="n">WM8994_IRQ_MIC1_DET</span><span class="p">;</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_idle</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* By default use idle_bias_off, will override for WM8994 */</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">idle_bias_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set revision-specific configuration */</span>
	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_CHIP_REVISION</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994</span>:
		<span class="cm">/* Single ended line outputs should have VMID on. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lineout1_diff</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lineout2_diff</span><span class="p">)</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">idle_bias_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">dcs_codes_l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">dcs_codes_r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">hp_startup_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">dcs_readback_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">series_startup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">dcs_readback_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">dcs_readback_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">hp_startup_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_byp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM1811</span>:
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">dcs_readback_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">no_series_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">hp_startup_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">no_cache_dac_hp_direct</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_byp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">dcs_codes_l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span><span class="p">;</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">dcs_codes_r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_ANALOGUE_HP_1</span><span class="p">,</span>
				    <span class="n">WM1811_HPOUT1_ATTN</span><span class="p">,</span> <span class="n">WM1811_HPOUT1_ATTN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wm8994_request_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_FIFOS_ERR</span><span class="p">,</span>
			   <span class="n">wm8994_fifo_error</span><span class="p">,</span> <span class="s">&quot;FIFO error&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="n">wm8994_request_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_TEMP_WARN</span><span class="p">,</span>
			   <span class="n">wm8994_temp_warn</span><span class="p">,</span> <span class="s">&quot;Thermal warning&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="n">wm8994_request_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_TEMP_SHUT</span><span class="p">,</span>
			   <span class="n">wm8994_temp_shut</span><span class="p">,</span> <span class="s">&quot;Thermal shutdown&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wm8994_request_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_DCS_DONE</span><span class="p">,</span>
				 <span class="n">wm_hubs_dcs_done</span><span class="p">,</span> <span class="s">&quot;DC servo done&quot;</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">dcs_done_irq</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						   <span class="n">wm8994_mic_irq</span><span class="p">,</span>
						   <span class="n">IRQF_TRIGGER_RISING</span><span class="p">,</span>
						   <span class="s">&quot;Mic1 detect&quot;</span><span class="p">,</span>
						   <span class="n">wm8994</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;Failed to request Mic1 detect IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wm8994_request_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span>
					 <span class="n">WM8994_IRQ_MIC1_SHRT</span><span class="p">,</span>
					 <span class="n">wm8994_mic_irq</span><span class="p">,</span> <span class="s">&quot;Mic 1 short&quot;</span><span class="p">,</span>
					 <span class="n">wm8994</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Failed to request Mic1 short IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ret</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wm8994_request_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span>
					 <span class="n">WM8994_IRQ_MIC2_DET</span><span class="p">,</span>
					 <span class="n">wm8994_mic_irq</span><span class="p">,</span> <span class="s">&quot;Mic 2 detect&quot;</span><span class="p">,</span>
					 <span class="n">wm8994</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Failed to request Mic2 detect IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ret</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wm8994_request_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span>
					 <span class="n">WM8994_IRQ_MIC2_SHRT</span><span class="p">,</span>
					 <span class="n">wm8994_mic_irq</span><span class="p">,</span> <span class="s">&quot;Mic 2 short&quot;</span><span class="p">,</span>
					 <span class="n">wm8994</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Failed to request Mic2 short IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ret</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM8958</span>:
	<span class="k">case</span> <span class="n">WM1811</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						   <span class="n">wm8958_mic_irq</span><span class="p">,</span>
						   <span class="n">IRQF_TRIGGER_RISING</span><span class="p">,</span>
						   <span class="s">&quot;Mic detect&quot;</span><span class="p">,</span>
						   <span class="n">wm8994</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;Failed to request Mic detect IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM1811</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wm8994_request_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span>
						 <span class="n">WM8994_IRQ_GPIO</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
						 <span class="n">wm1811_jackdet_irq</span><span class="p">,</span> <span class="s">&quot;JACKDET&quot;</span><span class="p">,</span>
						 <span class="n">wm8994</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked_irq</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wm8994_request_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span>
					 <span class="n">WM8994_IRQ_FLL1_LOCK</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					 <span class="n">wm8994_fll_locked_irq</span><span class="p">,</span> <span class="s">&quot;FLL lock&quot;</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked_irq</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure we can read from the GPIOs if they&#39;re inputs */</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Remember if AIFnLRCLK is configured as a GPIO.  This should be</span>
<span class="cm">	 * configured on init - if a system wants to do this dynamically</span>
<span class="cm">	 * at runtime we can deal with that then.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_read</span><span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">WM8994_GPIO_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read GPIO1 state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_GPN_FN_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WM8994_GP_FN_PIN_SPECIFIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">lrclk_shared</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wm8994_dai</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">symmetric_rates</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">lrclk_shared</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_read</span><span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">WM8994_GPIO_6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read GPIO6 state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">WM8994_GPN_FN_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WM8994_GP_FN_PIN_SPECIFIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">lrclk_shared</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wm8994_dai</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">symmetric_rates</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">lrclk_shared</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Latch volume update bits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_vu_bits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">wm8994_vu_bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span>
				    <span class="n">wm8994_vu_bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span>
				    <span class="n">wm8994_vu_bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">);</span>

	<span class="cm">/* Set the low bit of the 3D stereo depth so TLV matches */</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC1_FILTERS_2</span><span class="p">,</span>
			    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_AIF1DAC1_3D_GAIN_SHIFT</span><span class="p">,</span>
			    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_AIF1DAC1_3D_GAIN_SHIFT</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF1_DAC2_FILTERS_2</span><span class="p">,</span>
			    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_AIF1DAC2_3D_GAIN_SHIFT</span><span class="p">,</span>
			    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_AIF1DAC2_3D_GAIN_SHIFT</span><span class="p">);</span>
	<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF2_DAC_FILTERS_2</span><span class="p">,</span>
			    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_AIF2DAC_3D_GAIN_SHIFT</span><span class="p">,</span>
			    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WM8994_AIF2DAC_3D_GAIN_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Unconditionally enable AIF1 ADC TDM mode on chips which can</span>
<span class="cm">	 * use this; it only affects behaviour on idle TDM clock</span>
<span class="cm">	 * cycles. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994</span>:
	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8994_AIF1_CONTROL_1</span><span class="p">,</span>
				    <span class="n">WM8994_AIF1ADC_TDM</span><span class="p">,</span> <span class="n">WM8994_AIF1ADC_TDM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Put MICBIAS into bypass mode by default on newer devices */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8958</span>:
	<span class="k">case</span> <span class="n">WM1811</span>:
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS1</span><span class="p">,</span>
				    <span class="n">WM8958_MICB1_MODE</span><span class="p">,</span> <span class="n">WM8958_MICB1_MODE</span><span class="p">);</span>
		<span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">WM8958_MICBIAS2</span><span class="p">,</span>
				    <span class="n">WM8958_MICB2_MODE</span><span class="p">,</span> <span class="n">WM8958_MICB2_MODE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">.</span><span class="n">check_class_w_digital</span> <span class="o">=</span> <span class="n">wm8994_check_class_w_digital</span><span class="p">;</span>
	<span class="n">wm_hubs_update_class_w</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">wm8994_handle_pdata</span><span class="p">(</span><span class="n">wm8994</span><span class="p">);</span>

	<span class="n">wm_hubs_add_analogue_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">wm8994_snd_controls</span><span class="p">,</span>
			     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_snd_controls</span><span class="p">));</span>
	<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_dapm_widgets</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_dapm_widgets</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994</span>:
		<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_specific_dapm_widgets</span><span class="p">,</span>
					  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_specific_dapm_widgets</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_revd_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_revd_widgets</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_adc_revd_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_adc_revd_widgets</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_dac_revd_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_dac_revd_widgets</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_widgets</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_adc_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_adc_widgets</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_dac_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_dac_widgets</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">wm8958_snd_controls</span><span class="p">,</span>
				     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8958_snd_controls</span><span class="p">));</span>
		<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8958_dapm_widgets</span><span class="p">,</span>
					  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8958_dapm_widgets</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_revd_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_revd_widgets</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_adc_revd_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_adc_revd_widgets</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_dac_revd_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_dac_revd_widgets</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_widgets</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_adc_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_adc_widgets</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_dac_widgets</span><span class="p">,</span>
						  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_dac_widgets</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM1811</span>:
		<span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">wm8958_snd_controls</span><span class="p">,</span>
				     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8958_snd_controls</span><span class="p">));</span>
		<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8958_dapm_widgets</span><span class="p">,</span>
					  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8958_dapm_widgets</span><span class="p">));</span>
		<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_widgets</span><span class="p">,</span>
					  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_widgets</span><span class="p">));</span>
		<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_adc_widgets</span><span class="p">,</span>
					  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_adc_widgets</span><span class="p">));</span>
		<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_dac_widgets</span><span class="p">,</span>
					  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_dac_widgets</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wm_hubs_add_analogue_routes</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">intercon</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intercon</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994</span>:
		<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_intercon</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_intercon</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_revd_intercon</span><span class="p">,</span>
						<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_revd_intercon</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_revd_intercon</span><span class="p">,</span>
						<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_revd_intercon</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_intercon</span><span class="p">,</span>
						<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_intercon</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_revd_intercon</span><span class="p">,</span>
						<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_revd_intercon</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_revd_intercon</span><span class="p">,</span>
						<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_revd_intercon</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_intercon</span><span class="p">,</span>
						<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_intercon</span><span class="p">));</span>
			<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8958_intercon</span><span class="p">,</span>
						<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8958_intercon</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">wm8958_dsp2_init</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM1811</span>:
		<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8994_lateclk_intercon</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_lateclk_intercon</span><span class="p">));</span>
		<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wm8958_intercon</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8958_intercon</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_irq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span><span class="p">)</span>
		<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_GPIO</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">wm8994</span><span class="p">);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_MIC2_SHRT</span><span class="p">,</span> <span class="n">wm8994</span><span class="p">);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_MIC2_DET</span><span class="p">,</span> <span class="n">wm8994</span><span class="p">);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_MIC1_SHRT</span><span class="p">,</span> <span class="n">wm8994</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">,</span> <span class="n">wm8994</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_FLL1_LOCK</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_DCS_DONE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_FIFOS_ERR</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_TEMP_SHUT</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_TEMP_WARN</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_codec_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">snd_soc_codec_get_drvdata</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wm8994</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wm8994_set_bias_level</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">);</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_FLL1_LOCK</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">fll_locked</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_DCS_DONE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">hubs</span><span class="p">);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_FIFOS_ERR</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_TEMP_SHUT</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_TEMP_WARN</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span><span class="p">)</span>
		<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_GPIO</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">wm8994</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WM8994</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">,</span> <span class="n">wm8994</span><span class="p">);</span>
		<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_MIC2_DET</span><span class="p">,</span>
				<span class="n">wm8994</span><span class="p">);</span>
		<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_MIC1_SHRT</span><span class="p">,</span>
				<span class="n">wm8994</span><span class="p">);</span>
		<span class="n">wm8994_free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="p">,</span> <span class="n">WM8994_IRQ_MIC1_DET</span><span class="p">,</span>
				<span class="n">wm8994</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WM1811</span>:
	<span class="k">case</span> <span class="n">WM8958</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">micdet_irq</span><span class="p">,</span> <span class="n">wm8994</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mbc</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">mbc_vss</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">enh_eq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">retune_mobile_texts</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_codec_driver</span> <span class="n">soc_codec_dev_wm8994</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">wm8994_codec_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">wm8994_codec_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">wm8994_codec_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">wm8994_codec_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bias_level</span> <span class="o">=</span> <span class="n">wm8994_set_bias_level</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wm8994_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span><span class="p">;</span>

	<span class="n">wm8994</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm8994_priv</span><span class="p">),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">wm8994</span><span class="p">);</span>

	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_soc_register_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">soc_codec_dev_wm8994</span><span class="p">,</span>
			<span class="n">wm8994_dai</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wm8994_dai</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">wm8994_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_unregister_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Drop down to power saving mode when system is suspended */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">active_refcount</span><span class="p">)</span>
		<span class="n">regmap_update_bits</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
				   <span class="n">WM1811_JACKDET_MODE_MASK</span><span class="p">,</span>
				   <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm8994_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm8994_priv</span> <span class="o">*</span><span class="n">wm8994</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jackdet</span> <span class="o">&amp;&amp;</span> <span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">jack_cb</span><span class="p">)</span>
		<span class="n">regmap_update_bits</span><span class="p">(</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">wm8994</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">WM8994_ANTIPOP_2</span><span class="p">,</span>
				   <span class="n">WM1811_JACKDET_MODE_MASK</span><span class="p">,</span>
				   <span class="n">WM1811_JACKDET_MODE_AUDIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">wm8994_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SET_SYSTEM_SLEEP_PM_OPS</span><span class="p">(</span><span class="n">wm8994_suspend</span><span class="p">,</span> <span class="n">wm8994_resume</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">wm8994_codec_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wm8994-codec&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wm8994_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">wm8994_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">wm8994_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">wm8994_codec_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ASoC WM8994 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mark Brown &lt;broonie@opensource.wolfsonmicro.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:wm8994-codec&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
