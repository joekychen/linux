<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › codecs › stac9766.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>stac9766.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * stac9766.h  --  STAC9766 Soc Audio driver</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _STAC9766_H</span>
<span class="cp">#define _STAC9766_H</span>

<span class="cp">#define AC97_STAC_PAGE0 0x1000</span>
<span class="cp">#define AC97_STAC_DA_CONTROL (AC97_STAC_PAGE0 | 0x6A)</span>
<span class="cp">#define AC97_STAC_ANALOG_SPECIAL (AC97_STAC_PAGE0 | 0x6E)</span>
<span class="cp">#define AC97_STAC_STEREO_MIC 0x78</span>

<span class="cm">/* STAC9766 DAI ID&#39;s */</span>
<span class="cp">#define STAC9766_DAI_AC97_ANALOG		0</span>
<span class="cp">#define STAC9766_DAI_AC97_DIGITAL		1</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
ass="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>

<span class="cp">#include &quot;stac9766.h&quot;</span>

<span class="cp">#define STAC9766_VERSION &quot;0.10&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * STAC9766 register cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">stac9766_reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x6A90</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="cm">/* 6 */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8008</span><span class="p">,</span> <span class="mh">0x8008</span><span class="p">,</span> <span class="cm">/* e */</span>
	<span class="mh">0x8808</span><span class="p">,</span> <span class="mh">0x8808</span><span class="p">,</span> <span class="mh">0x8808</span><span class="p">,</span> <span class="mh">0x8808</span><span class="p">,</span> <span class="cm">/* 16 */</span>
	<span class="mh">0x8808</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* 1e */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">,</span> <span class="cm">/* 26 */</span>
	<span class="mh">0x0a05</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">,</span> <span class="mh">0xbb80</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* 2e */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xbb80</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* 36 */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="cm">/* 3e */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* 46 */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="cm">/* 4e */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* 56 */</span>
	<span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* 5e */</span>
	<span class="mh">0x1201</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* 66 */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* 6e */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="cm">/* 76 */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="cm">/* 7e */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stac9766_record_mux</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Mic&quot;</span><span class="p">,</span> <span class="s">&quot;CD&quot;</span><span class="p">,</span> <span class="s">&quot;Video&quot;</span><span class="p">,</span> <span class="s">&quot;AUX&quot;</span><span class="p">,</span>
			<span class="s">&quot;Line&quot;</span><span class="p">,</span> <span class="s">&quot;Stereo Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Mono Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Phone&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stac9766_mono_mux</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Mix&quot;</span><span class="p">,</span> <span class="s">&quot;Mic&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stac9766_mic_mux</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Mic1&quot;</span><span class="p">,</span> <span class="s">&quot;Mic2&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stac9766_SPDIF_mux</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;PCM&quot;</span><span class="p">,</span> <span class="s">&quot;ADC Record&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stac9766_popbypass_mux</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Normal&quot;</span><span class="p">,</span> <span class="s">&quot;Bypass Mixer&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stac9766_record_all_mux</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;All analog&quot;</span><span class="p">,</span>
	<span class="s">&quot;Analog plus DAC&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stac9766_boost1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;0dB&quot;</span><span class="p">,</span> <span class="s">&quot;10dB&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stac9766_boost2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;0dB&quot;</span><span class="p">,</span> <span class="s">&quot;20dB&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stac9766_stereo_mic</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Off&quot;</span><span class="p">,</span> <span class="s">&quot;On&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">stac9766_record_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_DOUBLE</span><span class="p">(</span><span class="n">AC97_REC_SEL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">stac9766_record_mux</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">stac9766_mono_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stac9766_mono_mux</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">stac9766_mic_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stac9766_mic_mux</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">stac9766_SPDIF_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_STAC_DA_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stac9766_SPDIF_mux</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">stac9766_popbypass_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stac9766_popbypass_mux</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">stac9766_record_all_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_STAC_ANALOG_SPECIAL</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">stac9766_record_all_mux</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">stac9766_boost1_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stac9766_boost1</span><span class="p">);</span> <span class="cm">/* 0/10dB */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">stac9766_boost2_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_STAC_ANALOG_SPECIAL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stac9766_boost2</span><span class="p">);</span> <span class="cm">/* 0/20dB */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="n">stac9766_stereo_mic_enum</span> <span class="o">=</span>
	<span class="n">SOC_ENUM_SINGLE</span><span class="p">(</span><span class="n">AC97_STAC_STEREO_MIC</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stac9766_stereo_mic</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_LINEAR</span><span class="p">(</span><span class="n">master_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">4600</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_LINEAR</span><span class="p">(</span><span class="n">record_tlv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2250</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_LINEAR</span><span class="p">(</span><span class="n">beep_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">4500</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_LINEAR</span><span class="p">(</span><span class="n">mix_tlv</span><span class="p">,</span> <span class="o">-</span><span class="mi">3450</span><span class="p">,</span> <span class="mi">1200</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">stac9766_snd_ac97_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Speaker Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">master_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Speaker Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Headphone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_HEADPHONE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">master_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_HEADPHONE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;Mono Out Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_MONO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">master_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono Out Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MASTER_MONO</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Record Volume&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">record_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Record Switch&quot;</span><span class="p">,</span> <span class="n">AC97_REC_GAIN</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>


	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;Beep Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">beep_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep Frequency&quot;</span><span class="p">,</span> <span class="n">AC97_PC_BEEP</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;Phone Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mix_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Phone Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PHONE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Mic Boost1&quot;</span><span class="p">,</span> <span class="n">stac9766_boost1_enum</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Mic Boost2&quot;</span><span class="p">,</span> <span class="n">stac9766_boost2_enum</span><span class="p">),</span>
	<span class="n">SOC_SINGLE_TLV</span><span class="p">(</span><span class="s">&quot;Mic Volume&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mix_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Switch&quot;</span><span class="p">,</span> <span class="n">AC97_MIC</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Stereo Mic&quot;</span><span class="p">,</span> <span class="n">stac9766_stereo_mic_enum</span><span class="p">),</span>

	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Line Volume&quot;</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mix_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Line Switch&quot;</span><span class="p">,</span> <span class="n">AC97_LINE</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;CD Volume&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mix_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;CD Switch&quot;</span><span class="p">,</span> <span class="n">AC97_CD</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;AUX Volume&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mix_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;AUX Switch&quot;</span><span class="p">,</span> <span class="n">AC97_AUX</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;Video Volume&quot;</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mix_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Video Switch&quot;</span><span class="p">,</span> <span class="n">AC97_VIDEO</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

	<span class="n">SOC_DOUBLE_TLV</span><span class="p">(</span><span class="s">&quot;DAC Volume&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mix_tlv</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;DAC Switch&quot;</span><span class="p">,</span> <span class="n">AC97_PCM</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;Loopback Test Switch&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Volume&quot;</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SOC_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Switch&quot;</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;SPDIF Mux&quot;</span><span class="p">,</span> <span class="n">stac9766_SPDIF_enum</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Mic1/2 Mux&quot;</span><span class="p">,</span> <span class="n">stac9766_mic_enum</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Record All Mux&quot;</span><span class="p">,</span> <span class="n">stac9766_record_all_enum</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Record Mux&quot;</span><span class="p">,</span> <span class="n">stac9766_record_enum</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Mono Mux&quot;</span><span class="p">,</span> <span class="n">stac9766_mono_enum</span><span class="p">),</span>
	<span class="n">SOC_ENUM</span><span class="p">(</span><span class="s">&quot;Pop Bypass Mux&quot;</span><span class="p">,</span> <span class="n">stac9766_popbypass_enum</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stac9766_ac97_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="n">AC97_STAC_PAGE0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stac9766_reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">cache</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">stac9766_ac97_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="n">AC97_STAC_PAGE0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span> <span class="o">-</span> <span class="n">AC97_STAC_PAGE0</span><span class="p">);</span>
		<span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_INT_PAGING</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stac9766_reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_RESET</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_GPIO_STATUS</span> <span class="o">||</span>
		<span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_INT_PAGING</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_VENDOR_ID1</span> <span class="o">||</span>
		<span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">reg</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_analog_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="n">vra</span><span class="p">;</span>

	<span class="n">vra</span> <span class="o">=</span> <span class="n">stac9766_ac97_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">);</span>

	<span class="n">vra</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* enable variable rate audio */</span>
	<span class="n">vra</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">;</span> <span class="cm">/* disable SPDIF output */</span>

	<span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">vra</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AC97_PCM_LR_ADC_RATE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac97_digital_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="n">vra</span><span class="p">;</span>

	<span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_SPDIF</span><span class="p">,</span> <span class="mh">0x2002</span><span class="p">);</span>

	<span class="n">vra</span> <span class="o">=</span> <span class="n">stac9766_ac97_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">);</span>
	<span class="n">vra</span> <span class="o">|=</span> <span class="mh">0x5</span><span class="p">;</span> <span class="cm">/* Enable VRA and SPDIF out */</span>

	<span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="n">vra</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stac9766_set_bias_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">snd_soc_bias_level</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_ON</span>: <span class="cm">/* full On */</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_PREPARE</span>: <span class="cm">/* partial On */</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_STANDBY</span>: <span class="cm">/* Off, with power */</span>
		<span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_OFF</span>: <span class="cm">/* Off, without power */</span>
		<span class="cm">/* disable everything including AC link */</span>
		<span class="n">stac9766_ac97_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">AC97_POWERDOWN</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stac9766_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">try_warm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">try_warm</span> <span class="o">&amp;&amp;</span> <span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">warm_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">warm_reset</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stac9766_ac97_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">stac9766_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">warm_reset</span><span class="p">)</span>
		<span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">warm_reset</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stac9766_ac97_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">stac9766_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stac9766_codec_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stac9766_set_bias_level</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stac9766_codec_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="n">reset</span><span class="p">;</span>

	<span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* give the codec an AC97 warm reset to start the link */</span>
<span class="nl">reset:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;stac9766 failed to resume&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">warm_reset</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">soc_ac97_ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0x4c13</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stac9766_reset</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">reset</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">stac9766_set_bias_level</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">stac9766_dai_ops_analog</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">ac97_analog_prepare</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">stac9766_dai_ops_digital</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">ac97_digital_prepare</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">stac9766_dai</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;stac9766-hifi-analog&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ac97_control</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* stream cababilities */</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;stac9766 analog&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SND_SOC_STD_AC97_FMTS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;stac9766 analog&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SND_SOC_STD_AC97_FMTS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* alsa ops */</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stac9766_dai_ops_analog</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;stac9766-hifi-IEC958&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ac97_control</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* stream cababilities */</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stream_name</span> <span class="o">=</span> <span class="s">&quot;stac9766 IEC958&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span> \
			<span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FORMAT_IEC958_SUBFRAME_BE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* alsa ops */</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stac9766_dai_ops_digital</span><span class="p">,</span>
<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stac9766_codec_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;STAC9766 SoC Audio Codec %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STAC9766_VERSION</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_new_ac97_codec</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">soc_ac97_ops</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">codec_err</span><span class="p">;</span>

	<span class="cm">/* do a cold reset for the controller and then try</span>
<span class="cm">	 * a warm reset followed by an optional cold reset for codec */</span>
	<span class="n">stac9766_reset</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">stac9766_reset</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to reset STAC9766: AC97 link error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">codec_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stac9766_set_bias_level</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">);</span>

	<span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">stac9766_snd_ac97_controls</span><span class="p">,</span>
			     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stac9766_snd_ac97_controls</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">codec_err:</span>
	<span class="n">snd_soc_free_ac97_codec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stac9766_codec_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_free_ac97_codec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_codec_driver</span> <span class="n">soc_codec_dev_stac9766</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">stac9766_ac97_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">stac9766_ac97_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bias_level</span> <span class="o">=</span> <span class="n">stac9766_set_bias_level</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">stac9766_codec_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">stac9766_codec_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">stac9766_codec_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">stac9766_codec_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg_cache_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stac9766_reg</span><span class="p">),</span>
	<span class="p">.</span><span class="n">reg_word_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span>
	<span class="p">.</span><span class="n">reg_cache_step</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg_cache_default</span> <span class="o">=</span> <span class="n">stac9766_reg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">stac9766_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_soc_register_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">soc_codec_dev_stac9766</span><span class="p">,</span> <span class="n">stac9766_dai</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stac9766_dai</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">stac9766_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_unregister_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">stac9766_codec_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;stac9766-codec&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">stac9766_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">stac9766_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">stac9766_codec_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ASoC stac9766 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jon Smirl &lt;jonsmirl@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
