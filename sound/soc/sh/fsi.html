<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › sh › fsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Fifo-attached Serial Interface (FSI) support for SH7724</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Renesas Solutions Corp.</span>
<span class="cm"> * Kuninori Morimoto &lt;morimoto.kuninori@renesas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on ssi.c</span>
<span class="cm"> * Copyright (c) 2007 Manuel Lauss &lt;mano@roarinelk.homelinux.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/sh_dma.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/sh_fsi.h&gt;</span>

<span class="cm">/* PortA/PortB register */</span>
<span class="cp">#define REG_DO_FMT	0x0000</span>
<span class="cp">#define REG_DOFF_CTL	0x0004</span>
<span class="cp">#define REG_DOFF_ST	0x0008</span>
<span class="cp">#define REG_DI_FMT	0x000C</span>
<span class="cp">#define REG_DIFF_CTL	0x0010</span>
<span class="cp">#define REG_DIFF_ST	0x0014</span>
<span class="cp">#define REG_CKG1	0x0018</span>
<span class="cp">#define REG_CKG2	0x001C</span>
<span class="cp">#define REG_DIDT	0x0020</span>
<span class="cp">#define REG_DODT	0x0024</span>
<span class="cp">#define REG_MUTE_ST	0x0028</span>
<span class="cp">#define REG_OUT_DMAC	0x002C</span>
<span class="cp">#define REG_OUT_SEL	0x0030</span>
<span class="cp">#define REG_IN_DMAC	0x0038</span>

<span class="cm">/* master register */</span>
<span class="cp">#define MST_CLK_RST	0x0210</span>
<span class="cp">#define MST_SOFT_RST	0x0214</span>
<span class="cp">#define MST_FIFO_SZ	0x0218</span>

<span class="cm">/* core register (depend on FSI version) */</span>
<span class="cp">#define A_MST_CTLR	0x0180</span>
<span class="cp">#define B_MST_CTLR	0x01A0</span>
<span class="cp">#define CPU_INT_ST	0x01F4</span>
<span class="cp">#define CPU_IEMSK	0x01F8</span>
<span class="cp">#define CPU_IMSK	0x01FC</span>
<span class="cp">#define INT_ST		0x0200</span>
<span class="cp">#define IEMSK		0x0204</span>
<span class="cp">#define IMSK		0x0208</span>

<span class="cm">/* DO_FMT */</span>
<span class="cm">/* DI_FMT */</span>
<span class="cp">#define CR_BWS_MASK	(0x3 &lt;&lt; 20) </span><span class="cm">/* FSI2 */</span><span class="cp"></span>
<span class="cp">#define CR_BWS_24	(0x0 &lt;&lt; 20) </span><span class="cm">/* FSI2 */</span><span class="cp"></span>
<span class="cp">#define CR_BWS_16	(0x1 &lt;&lt; 20) </span><span class="cm">/* FSI2 */</span><span class="cp"></span>
<span class="cp">#define CR_BWS_20	(0x2 &lt;&lt; 20) </span><span class="cm">/* FSI2 */</span><span class="cp"></span>

<span class="cp">#define CR_DTMD_PCM		(0x0 &lt;&lt; 8) </span><span class="cm">/* FSI2 */</span><span class="cp"></span>
<span class="cp">#define CR_DTMD_SPDIF_PCM	(0x1 &lt;&lt; 8) </span><span class="cm">/* FSI2 */</span><span class="cp"></span>
<span class="cp">#define CR_DTMD_SPDIF_STREAM	(0x2 &lt;&lt; 8) </span><span class="cm">/* FSI2 */</span><span class="cp"></span>

<span class="cp">#define CR_MONO		(0x0 &lt;&lt; 4)</span>
<span class="cp">#define CR_MONO_D	(0x1 &lt;&lt; 4)</span>
<span class="cp">#define CR_PCM		(0x2 &lt;&lt; 4)</span>
<span class="cp">#define CR_I2S		(0x3 &lt;&lt; 4)</span>
<span class="cp">#define CR_TDM		(0x4 &lt;&lt; 4)</span>
<span class="cp">#define CR_TDM_D	(0x5 &lt;&lt; 4)</span>

<span class="cm">/* OUT_DMAC */</span>
<span class="cm">/* IN_DMAC */</span>
<span class="cp">#define VDMD_MASK	(0x3 &lt;&lt; 4)</span>
<span class="cp">#define VDMD_FRONT	(0x0 &lt;&lt; 4) </span><span class="cm">/* Package in front */</span><span class="cp"></span>
<span class="cp">#define VDMD_BACK	(0x1 &lt;&lt; 4) </span><span class="cm">/* Package in back */</span><span class="cp"></span>
<span class="cp">#define VDMD_STREAM	(0x2 &lt;&lt; 4) </span><span class="cm">/* Stream mode(16bit * 2) */</span><span class="cp"></span>

<span class="cp">#define DMA_ON		(0x1 &lt;&lt; 0)</span>

<span class="cm">/* DOFF_CTL */</span>
<span class="cm">/* DIFF_CTL */</span>
<span class="cp">#define IRQ_HALF	0x00100000</span>
<span class="cp">#define FIFO_CLR	0x00000001</span>

<span class="cm">/* DOFF_ST */</span>
<span class="cp">#define ERR_OVER	0x00000010</span>
<span class="cp">#define ERR_UNDER	0x00000001</span>
<span class="cp">#define ST_ERR		(ERR_OVER | ERR_UNDER)</span>

<span class="cm">/* CKG1 */</span>
<span class="cp">#define ACKMD_MASK	0x00007000</span>
<span class="cp">#define BPFMD_MASK	0x00000700</span>
<span class="cp">#define DIMD		(1 &lt;&lt; 4)</span>
<span class="cp">#define DOMD		(1 &lt;&lt; 0)</span>

<span class="cm">/* A/B MST_CTLR */</span>
<span class="cp">#define BP	(1 &lt;&lt; 4)	</span><span class="cm">/* Fix the signal of Biphase output */</span><span class="cp"></span>
<span class="cp">#define SE	(1 &lt;&lt; 0)	</span><span class="cm">/* Fix the master clock */</span><span class="cp"></span>

<span class="cm">/* CLK_RST */</span>
<span class="cp">#define CRB	(1 &lt;&lt; 4)</span>
<span class="cp">#define CRA	(1 &lt;&lt; 0)</span>

<span class="cm">/* IO SHIFT / MACRO */</span>
<span class="cp">#define BI_SHIFT	12</span>
<span class="cp">#define BO_SHIFT	8</span>
<span class="cp">#define AI_SHIFT	4</span>
<span class="cp">#define AO_SHIFT	0</span>
<span class="cp">#define AB_IO(param, shift)	(param &lt;&lt; shift)</span>

<span class="cm">/* SOFT_RST */</span>
<span class="cp">#define PBSR		(1 &lt;&lt; 12) </span><span class="cm">/* Port B Software Reset */</span><span class="cp"></span>
<span class="cp">#define PASR		(1 &lt;&lt;  8) </span><span class="cm">/* Port A Software Reset */</span><span class="cp"></span>
<span class="cp">#define IR		(1 &lt;&lt;  4) </span><span class="cm">/* Interrupt Reset */</span><span class="cp"></span>
<span class="cp">#define FSISR		(1 &lt;&lt;  0) </span><span class="cm">/* Software Reset */</span><span class="cp"></span>

<span class="cm">/* OUT_SEL (FSI2) */</span>
<span class="cp">#define DMMD		(1 &lt;&lt; 4) </span><span class="cm">/* SPDIF output timing 0: Biphase only */</span><span class="cp"></span>
				 <span class="cm">/*			1: Biphase and serial */</span>

<span class="cm">/* FIFO_SZ */</span>
<span class="cp">#define FIFO_SZ_MASK	0x7</span>

<span class="cp">#define FSI_RATES SNDRV_PCM_RATE_8000_96000</span>

<span class="cp">#define FSI_FMTS (SNDRV_PCM_FMTBIT_S24_LE | SNDRV_PCM_FMTBIT_S16_LE)</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_rate_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * bus options</span>
<span class="cm"> *</span>
<span class="cm"> * 0x000000BA</span>
<span class="cm"> *</span>
<span class="cm"> * A : sample widtht 16bit setting</span>
<span class="cm"> * B : sample widtht 24bit setting</span>
<span class="cm"> */</span>

<span class="cp">#define SHIFT_16DATA		0</span>
<span class="cp">#define SHIFT_24DATA		4</span>

<span class="cp">#define PACKAGE_24BITBUS_BACK		0</span>
<span class="cp">#define PACKAGE_24BITBUS_FRONT		1</span>
<span class="cp">#define PACKAGE_16BITBUS_STREAM		2</span>

<span class="cp">#define BUSOP_SET(s, a)	((a) &lt;&lt; SHIFT_ ## s ## DATA)</span>
<span class="cp">#define BUSOP_GET(s, a)	(((a) &gt;&gt; SHIFT_ ## s ## DATA) &amp; 0xF)</span>

<span class="cm">/*</span>
<span class="cm"> * FSI driver use below type name for variable</span>
<span class="cm"> *</span>
<span class="cm"> * xxx_num	: number of data</span>
<span class="cm"> * xxx_pos	: position of data</span>
<span class="cm"> * xxx_capa	: capacity of data</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	period/frame/sample image</span>
<span class="cm"> *</span>
<span class="cm"> * ex) PCM (2ch)</span>
<span class="cm"> *</span>
<span class="cm"> * period pos					   period pos</span>
<span class="cm"> *   [n]					     [n + 1]</span>
<span class="cm"> *   |&lt;-------------------- period---------------------&gt;|</span>
<span class="cm"> * ==|============================================ ... =|==</span>
<span class="cm"> *   |							|</span>
<span class="cm"> *   ||&lt;-----  frame -----&gt;|&lt;------ frame -----&gt;|  ...	|</span>
<span class="cm"> *   |+--------------------+--------------------+- ...	|</span>
<span class="cm"> *   ||[ sample ][ sample ]|[ sample ][ sample ]|  ...	|</span>
<span class="cm"> *   |+--------------------+--------------------+- ...	|</span>
<span class="cm"> * ==|============================================ ... =|==</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	FSI FIFO image</span>
<span class="cm"> *</span>
<span class="cm"> *	|	     |</span>
<span class="cm"> *	|	     |</span>
<span class="cm"> *	| [ sample ] |</span>
<span class="cm"> *	| [ sample ] |</span>
<span class="cm"> *	| [ sample ] |</span>
<span class="cm"> *	| [ sample ] |</span>
<span class="cm"> *		--&gt; go to codecs</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *		struct</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">fsi_stream_handler</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * these are initialized by fsi_stream_init()</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_sample_capa</span><span class="p">;</span>	<span class="cm">/* sample capacity of FSI FIFO */</span>
	<span class="kt">int</span> <span class="n">buff_sample_capa</span><span class="p">;</span>	<span class="cm">/* sample capacity of ALSA buffer */</span>
	<span class="kt">int</span> <span class="n">buff_sample_pos</span><span class="p">;</span>	<span class="cm">/* sample position of ALSA buffer */</span>
	<span class="kt">int</span> <span class="n">period_samples</span><span class="p">;</span>	<span class="cm">/* sample number / 1 period */</span>
	<span class="kt">int</span> <span class="n">period_pos</span><span class="p">;</span>		<span class="cm">/* current period position */</span>
	<span class="kt">int</span> <span class="n">sample_width</span><span class="p">;</span>	<span class="cm">/* sample width */</span>
	<span class="kt">int</span> <span class="n">uerr_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oerr_num</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * bus options</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">bus_option</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * thse are initialized by fsi_handler_init()</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">fsi_stream_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span>		<span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * these are for DMAEngine</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>		<span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_dmae_slave</span>	<span class="n">slave</span><span class="p">;</span> <span class="cm">/* see fsi_handler_init() */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>	<span class="n">tasklet</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">dma</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_fsi_port_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="n">playback</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="n">capture</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">chan_num</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clk_master</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spdif</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fsi_stream_handler</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">quit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">transfer</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">start_stop</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">};</span>
<span class="cp">#define fsi_stream_handler_call(io, func, args...)	\</span>
<span class="cp">	(!(io) ? -ENODEV :				\</span>
<span class="cp">	 !((io)-&gt;handler-&gt;func) ? 0 :			\</span>
<span class="cp">	 (io)-&gt;handler-&gt;func(args))</span>

<span class="k">struct</span> <span class="n">fsi_core</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ver</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">int_st</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iemsk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">imsk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">a_mclk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">b_mclk</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fsi_master</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="n">fsia</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="n">fsib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_core</span> <span class="o">*</span><span class="n">core</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fsi_stream_is_play</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *		basic read write function</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__fsi_reg_write</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* valid data area is 24bit */</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0x00ffffff</span><span class="p">;</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__fsi_reg_read</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__fsi_reg_mask_set</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">__fsi_reg_read</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">__fsi_reg_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define fsi_reg_write(p, r, d)\</span>
<span class="cp">	__fsi_reg_write((p-&gt;base + REG_##r), d)</span>

<span class="cp">#define fsi_reg_read(p, r)\</span>
<span class="cp">	__fsi_reg_read((p-&gt;base + REG_##r))</span>

<span class="cp">#define fsi_reg_mask_set(p, r, m, d)\</span>
<span class="cp">	__fsi_reg_mask_set((p-&gt;base + REG_##r), m, d)</span>

<span class="cp">#define fsi_master_read(p, r) _fsi_master_read(p, MST_##r)</span>
<span class="cp">#define fsi_core_read(p, r)   _fsi_master_read(p, p-&gt;core-&gt;r)</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">_fsi_master_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__fsi_reg_read</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define fsi_master_mask_set(p, r, m, d) _fsi_master_mask_set(p, MST_##r, m, d)</span>
<span class="cp">#define fsi_core_mask_set(p, r, m, d)  _fsi_master_mask_set(p, p-&gt;core-&gt;r, m, d)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_fsi_master_mask_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__fsi_reg_mask_set</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		basic function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="nf">fsi_get_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_is_clk_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">clk_master</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_is_port_a</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_is_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_is_play</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="nf">fsi_get_dai</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span>  <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="nf">fsi_get_priv_frm_dai</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="nf">fsi_get_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fsi_get_priv_frm_dai</span><span class="p">(</span><span class="n">fsi_get_dai</span><span class="p">(</span><span class="n">substream</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">set_rate_func</span> <span class="nf">fsi_get_info_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">set_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fsi_get_info_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fsi_get_port_shift</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_play</span> <span class="o">=</span> <span class="n">fsi_stream_is_play</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_porta</span> <span class="o">=</span> <span class="n">fsi_is_port_a</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_porta</span><span class="p">)</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="n">is_play</span> <span class="o">?</span> <span class="n">AO_SHIFT</span> <span class="o">:</span> <span class="n">AI_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="n">is_play</span> <span class="o">?</span> <span class="n">BO_SHIFT</span> <span class="o">:</span> <span class="n">BI_SHIFT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_frame2sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">frames</span> <span class="o">*</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">chan_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_sample2frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">samples</span> <span class="o">/</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">chan_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_get_current_fifo_samples</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_play</span> <span class="o">=</span> <span class="n">fsi_stream_is_play</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frames</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">is_play</span> <span class="o">?</span>
		<span class="n">fsi_reg_read</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DOFF_ST</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">fsi_reg_read</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DIFF_ST</span><span class="p">);</span>

	<span class="n">frames</span> <span class="o">=</span> <span class="mh">0x1ff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fsi_frame2sample</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_count_fifo_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ostatus</span> <span class="o">=</span> <span class="n">fsi_reg_read</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DOFF_ST</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">istatus</span> <span class="o">=</span> <span class="n">fsi_reg_read</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DIFF_ST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ostatus</span> <span class="o">&amp;</span> <span class="n">ERR_OVER</span><span class="p">)</span>
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">oerr_num</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ostatus</span> <span class="o">&amp;</span> <span class="n">ERR_UNDER</span><span class="p">)</span>
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">uerr_num</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span> <span class="n">ERR_OVER</span><span class="p">)</span>
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">oerr_num</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span> <span class="n">ERR_UNDER</span><span class="p">)</span>
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">uerr_num</span><span class="o">++</span><span class="p">;</span>

	<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DOFF_ST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DIFF_ST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		fsi_stream_xx() function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fsi_stream_is_play</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span> <span class="o">==</span> <span class="n">io</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="nf">fsi_stream_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fsi_is_play</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_stream_is_working</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">&amp;&amp;</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="nf">fsi_stream_to_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_stream_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span>	<span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_capa</span>	<span class="o">=</span> <span class="n">fsi_frame2sample</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">period_samples</span>	<span class="o">=</span> <span class="n">fsi_frame2sample</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">period_pos</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">sample_width</span>	<span class="o">=</span> <span class="n">samples_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">bus_option</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">oerr_num</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* ignore 1st err */</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">uerr_num</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* ignore 1st err */</span>
	<span class="n">fsi_stream_handler_call</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_stream_quit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span> <span class="o">=</span> <span class="n">fsi_get_dai</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">oerr_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;over_run = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">oerr_num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">uerr_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;under_run = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">uerr_num</span><span class="p">);</span>

	<span class="n">fsi_stream_handler_call</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">quit</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_capa</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">period_samples</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">period_pos</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">sample_width</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">bus_option</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">oerr_num</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">uerr_num</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_stream_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span> <span class="o">=</span> <span class="n">fsi_stream_to_priv</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fsi_stream_handler_call</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define fsi_stream_start(fsi, io)\</span>
<span class="cp">	fsi_stream_handler_call(io, start_stop, fsi, io, 1)</span>

<span class="cp">#define fsi_stream_stop(fsi, io)\</span>
<span class="cp">	fsi_stream_handler_call(io, start_stop, fsi, io, 0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_stream_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret1</span><span class="p">,</span> <span class="n">ret2</span><span class="p">;</span>

	<span class="n">io</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="n">ret1</span> <span class="o">=</span> <span class="n">fsi_stream_handler_call</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="n">io</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
	<span class="n">ret2</span> <span class="o">=</span> <span class="n">fsi_stream_handler_call</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_stream_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret1</span><span class="p">,</span> <span class="n">ret2</span><span class="p">;</span>

	<span class="n">io</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="n">ret1</span> <span class="o">=</span> <span class="n">fsi_stream_handler_call</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="n">io</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
	<span class="n">ret2</span> <span class="o">=</span> <span class="n">fsi_stream_handler_call</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	format/bus/dma setting</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_format_bus_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_play</span> <span class="o">=</span> <span class="n">fsi_stream_is_play</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fmt</span> <span class="o">=</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsi_version</span><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * FSI2 needs DMA/Bus setting</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PACKAGE_24BITBUS_FRONT</span>:
			<span class="n">fmt</span> <span class="o">|=</span> <span class="n">CR_BWS_24</span><span class="p">;</span>
			<span class="n">dma</span> <span class="o">|=</span> <span class="n">VDMD_FRONT</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;24bit bus / package in front</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PACKAGE_16BITBUS_STREAM</span>:
			<span class="n">fmt</span> <span class="o">|=</span> <span class="n">CR_BWS_16</span><span class="p">;</span>
			<span class="n">dma</span> <span class="o">|=</span> <span class="n">VDMD_STREAM</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;16bit bus / stream mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PACKAGE_24BITBUS_BACK</span>:
		<span class="nl">default:</span>
			<span class="n">fmt</span> <span class="o">|=</span> <span class="n">CR_BWS_24</span><span class="p">;</span>
			<span class="n">dma</span> <span class="o">|=</span> <span class="n">VDMD_BACK</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;24bit bus / package in back</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_play</span><span class="p">)</span>
			<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">OUT_DMAC</span><span class="p">,</span>	<span class="n">dma</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">IN_DMAC</span><span class="p">,</span>	<span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_play</span><span class="p">)</span>
		<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DO_FMT</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DI_FMT</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		irq function</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="n">AB_IO</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fsi_get_port_shift</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>

	<span class="n">fsi_core_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">imsk</span><span class="p">,</span>  <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">fsi_core_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">iemsk</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="n">AB_IO</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fsi_get_port_shift</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>

	<span class="n">fsi_core_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">imsk</span><span class="p">,</span>  <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fsi_core_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">iemsk</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fsi_irq_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fsi_core_read</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">int_st</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_irq_clear_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">|=</span> <span class="n">AB_IO</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fsi_get_port_shift</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">));</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">AB_IO</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fsi_get_port_shift</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">));</span>

	<span class="cm">/* clear interrupt factor */</span>
	<span class="n">fsi_core_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">int_st</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		SPDIF master clock function</span>
<span class="cm"> *</span>
<span class="cm"> * These functions are used later FSI2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_spdif_clk_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">BP</span> <span class="o">|</span> <span class="n">SE</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">mask</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fsi_is_port_a</span><span class="p">(</span><span class="n">fsi</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">fsi_core_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">a_mclk</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">fsi_core_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">b_mclk</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		clock function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_set_master_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
			      <span class="kt">long</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_rate_func</span> <span class="n">set_rate</span> <span class="o">=</span> <span class="n">fsi_get_info_set_rate</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_rate</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_rate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* error */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">SH_FSI_ACKMD_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="cm">/* FALL THROUGH */</span>
		<span class="k">case</span> <span class="n">SH_FSI_ACKMD_512</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SH_FSI_ACKMD_256</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SH_FSI_ACKMD_128</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SH_FSI_ACKMD_64</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SH_FSI_ACKMD_32</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">SH_FSI_BPFMD_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="cm">/* FALL THROUGH */</span>
		<span class="k">case</span> <span class="n">SH_FSI_BPFMD_32</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SH_FSI_BPFMD_64</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SH_FSI_BPFMD_128</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SH_FSI_BPFMD_256</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SH_FSI_BPFMD_512</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x4</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SH_FSI_BPFMD_16</span>:
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fsi_reg_mask_set</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">CKG1</span><span class="p">,</span> <span class="p">(</span><span class="n">ACKMD_MASK</span> <span class="o">|</span> <span class="n">BPFMD_MASK</span><span class="p">)</span> <span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		pio data transfer handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_pio_push16</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">enable_stream</span> <span class="o">=</span> <span class="n">fsi_get_info_flags</span><span class="p">(</span><span class="n">fsi</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SH_FSI_ENABLE_STREAM_MODE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_stream</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * stream mode</span>
<span class="cm">		 * see</span>
<span class="cm">		 *	fsi_pio_push_init()</span>
<span class="cm">		 */</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">_buf</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">samples</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DODT</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* normal mode */</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">_buf</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DODT</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_pio_pop16</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">fsi_reg_read</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DIDT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_pio_push32</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DODT</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_pio_pop32</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">fsi_reg_read</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DIDT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">fsi_pio_get_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span>
		<span class="n">samples_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_pio_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">run16</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">samples</span><span class="p">),</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">run32</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">samples</span><span class="p">),</span>
		<span class="kt">int</span> <span class="n">samples</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">over_period</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsi_stream_is_working</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">over_period</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">substream</span>	<span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span>		<span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="cm">/* FSI FIFO has limit.</span>
<span class="cm">	 * So, this driver can not send periods data at a time</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span> <span class="o">&gt;=</span>
	    <span class="n">io</span><span class="o">-&gt;</span><span class="n">period_samples</span> <span class="o">*</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">over_period</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">period_pos</span><span class="p">)</span>
			<span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">fsi_pio_get_area</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">sample_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">run16</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">samples</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">run32</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">samples</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update buff_sample_pos */</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span> <span class="o">+=</span> <span class="n">samples</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">over_period</span><span class="p">)</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_pio_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sample_residues</span><span class="p">;</span>	<span class="cm">/* samples in FSI fifo */</span>
	<span class="kt">int</span> <span class="n">sample_space</span><span class="p">;</span>	<span class="cm">/* ALSA free samples space */</span>
	<span class="kt">int</span> <span class="n">samples</span><span class="p">;</span>

	<span class="n">sample_residues</span>	<span class="o">=</span> <span class="n">fsi_get_current_fifo_samples</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">sample_space</span>	<span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_capa</span> <span class="o">-</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span><span class="p">;</span>

	<span class="n">samples</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sample_residues</span><span class="p">,</span> <span class="n">sample_space</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fsi_pio_transfer</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span>
				  <span class="n">fsi_pio_pop16</span><span class="p">,</span>
				  <span class="n">fsi_pio_pop32</span><span class="p">,</span>
				  <span class="n">samples</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_pio_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sample_residues</span><span class="p">;</span>	<span class="cm">/* ALSA residue samples */</span>
	<span class="kt">int</span> <span class="n">sample_space</span><span class="p">;</span>	<span class="cm">/* FSI fifo free samples space */</span>
	<span class="kt">int</span> <span class="n">samples</span><span class="p">;</span>

	<span class="n">sample_residues</span>	<span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_capa</span> <span class="o">-</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span><span class="p">;</span>
	<span class="n">sample_space</span>	<span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">fifo_sample_capa</span> <span class="o">-</span>
		<span class="n">fsi_get_current_fifo_samples</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="n">samples</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sample_residues</span><span class="p">,</span> <span class="n">sample_space</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fsi_pio_transfer</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span>
				  <span class="n">fsi_pio_push16</span><span class="p">,</span>
				  <span class="n">fsi_pio_push32</span><span class="p">,</span>
				  <span class="n">samples</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_pio_start_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">clk</span>  <span class="o">=</span> <span class="n">fsi_is_port_a</span><span class="p">(</span><span class="n">fsi</span><span class="p">)</span> <span class="o">?</span> <span class="n">CRA</span>  <span class="o">:</span> <span class="n">CRB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">fsi_irq_enable</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fsi_irq_disable</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsi_is_clk_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">))</span>
		<span class="n">fsi_master_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">CLK_RST</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="o">?</span> <span class="n">clk</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_pio_push_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">enable_stream</span> <span class="o">=</span> <span class="n">fsi_get_info_flags</span><span class="p">(</span><span class="n">fsi</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SH_FSI_ENABLE_STREAM_MODE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we can use 16bit stream mode</span>
<span class="cm">	 * when &quot;playback&quot; and &quot;16bit data&quot;</span>
<span class="cm">	 * and platform allows &quot;stream mode&quot;</span>
<span class="cm">	 * see</span>
<span class="cm">	 *	fsi_pio_push16()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_stream</span><span class="p">)</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">bus_option</span> <span class="o">=</span> <span class="n">BUSOP_SET</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">PACKAGE_24BITBUS_BACK</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">BUSOP_SET</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">PACKAGE_16BITBUS_STREAM</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">bus_option</span> <span class="o">=</span> <span class="n">BUSOP_SET</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">PACKAGE_24BITBUS_BACK</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">BUSOP_SET</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">PACKAGE_24BITBUS_BACK</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_pio_pop_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * always 24bit bus, package back when &quot;capture&quot;</span>
<span class="cm">	 */</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">bus_option</span> <span class="o">=</span> <span class="n">BUSOP_SET</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">PACKAGE_24BITBUS_BACK</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">BUSOP_SET</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">PACKAGE_24BITBUS_BACK</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsi_stream_handler</span> <span class="n">fsi_pio_push_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">fsi_pio_push_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">transfer</span>	<span class="o">=</span> <span class="n">fsi_pio_push</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_stop</span>	<span class="o">=</span> <span class="n">fsi_pio_start_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsi_stream_handler</span> <span class="n">fsi_pio_pop_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">fsi_pio_pop_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">transfer</span>	<span class="o">=</span> <span class="n">fsi_pio_pop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_stop</span>	<span class="o">=</span> <span class="n">fsi_pio_start_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">fsi_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_st</span> <span class="o">=</span> <span class="n">fsi_irq_get_status</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="cm">/* clear irq status */</span>
	<span class="n">fsi_master_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">SOFT_RST</span><span class="p">,</span> <span class="n">IR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fsi_master_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">SOFT_RST</span><span class="p">,</span> <span class="n">IR</span><span class="p">,</span> <span class="n">IR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">AB_IO</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">AO_SHIFT</span><span class="p">))</span>
		<span class="n">fsi_stream_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">.</span><span class="n">playback</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">AB_IO</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">BO_SHIFT</span><span class="p">))</span>
		<span class="n">fsi_stream_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">.</span><span class="n">playback</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">AB_IO</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">AI_SHIFT</span><span class="p">))</span>
		<span class="n">fsi_stream_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">.</span><span class="n">capture</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_st</span> <span class="o">&amp;</span> <span class="n">AB_IO</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">BI_SHIFT</span><span class="p">))</span>
		<span class="n">fsi_stream_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">.</span><span class="n">capture</span><span class="p">);</span>

	<span class="n">fsi_count_fifo_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">);</span>
	<span class="n">fsi_count_fifo_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">);</span>

	<span class="n">fsi_irq_clear_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">);</span>
	<span class="n">fsi_irq_clear_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		dma data transfer handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_dma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span> <span class="o">=</span> <span class="n">fsi_get_dai</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">fsi_stream_is_play</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DMA_TO_DEVICE</span> <span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 24bit data : 24bit bus / package in back</span>
<span class="cm">	 * 16bit data : 16bit bus / stream mode</span>
<span class="cm">	 */</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">bus_option</span> <span class="o">=</span> <span class="n">BUSOP_SET</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">PACKAGE_24BITBUS_BACK</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">BUSOP_SET</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">PACKAGE_16BITBUS_STREAM</span><span class="p">);</span>

	<span class="n">io</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span>
				 <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">),</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_dma_quit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span> <span class="o">=</span> <span class="n">fsi_get_dai</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">fsi_stream_is_play</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">DMA_TO_DEVICE</span> <span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
			 <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">),</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">fsi_dma_get_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="n">samples_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_dma_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span> <span class="o">=</span> <span class="n">fsi_stream_to_priv</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span> <span class="o">=</span> <span class="n">fsi_get_dai</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">fsi_stream_is_play</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">DMA_TO_DEVICE</span> <span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

	<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fsi_dma_get_area</span><span class="p">(</span><span class="n">io</span><span class="p">),</span>
			<span class="n">samples_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">period_samples</span><span class="p">),</span> <span class="n">dir</span><span class="p">);</span>

	<span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span> <span class="o">+=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">period_samples</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">period_pos</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">&gt;=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsi_count_fifo_err</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="n">fsi_stream_transfer</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>

	<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_dma_do_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span> <span class="o">=</span> <span class="n">fsi_stream_to_priv</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_play</span> <span class="o">=</span> <span class="n">fsi_stream_is_play</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsi_stream_is_working</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dai</span>	<span class="o">=</span> <span class="n">fsi_get_dai</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">chan</span>	<span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">runtime</span>	<span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">dir</span>	<span class="o">=</span> <span class="n">is_play</span> <span class="o">?</span> <span class="n">DMA_TO_DEVICE</span> <span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
	<span class="n">len</span>	<span class="o">=</span> <span class="n">samples_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">period_samples</span><span class="p">);</span>
	<span class="n">buf</span>	<span class="o">=</span> <span class="n">fsi_dma_get_area</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>

	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">pfn_to_page</span><span class="p">(</span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">buf</span><span class="p">)),</span>
		    <span class="n">len</span> <span class="p">,</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
				       <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dmaengine_prep_slave_sg() fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span>		<span class="o">=</span> <span class="n">fsi_dma_complete</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span>	<span class="o">=</span> <span class="n">io</span><span class="p">;</span>

	<span class="n">cookie</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx_submit() fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME</span>
<span class="cm">	 *</span>
<span class="cm">	 * In DMAEngine case, codec and FSI cannot be started simultaneously</span>
<span class="cm">	 * since FSI is using tasklet.</span>
<span class="cm">	 * Therefore, in capture case, probably FSI FIFO will have got</span>
<span class="cm">	 * overflow error in this point.</span>
<span class="cm">	 * in that case, DMA cannot start transfer until error was cleared.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_play</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ERR_OVER</span> <span class="o">&amp;</span> <span class="n">fsi_reg_read</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DIFF_ST</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fsi_reg_mask_set</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DIFF_CTL</span><span class="p">,</span> <span class="n">FIFO_CLR</span><span class="p">,</span> <span class="n">FIFO_CLR</span><span class="p">);</span>
			<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">DIFF_ST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">fsi_dma_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_dmae_slave</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_dma_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_dma_push_start_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">clk</span>  <span class="o">=</span> <span class="n">fsi_is_port_a</span><span class="p">(</span><span class="n">fsi</span><span class="p">)</span> <span class="o">?</span> <span class="n">CRA</span>  <span class="o">:</span> <span class="n">CRB</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">enable</span> <span class="o">=</span> <span class="n">start</span> <span class="o">?</span> <span class="n">DMA_ON</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fsi_reg_mask_set</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">OUT_DMAC</span><span class="p">,</span> <span class="n">DMA_ON</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">dmaengine_terminate_all</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsi_is_clk_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">))</span>
		<span class="n">fsi_master_mask_set</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">CLK_RST</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="o">?</span> <span class="n">clk</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_dma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">io</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">fsi_dma_filter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">fsi_dma_do_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">io</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_dma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="n">fsi_stream_stop</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">io</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsi_stream_handler</span> <span class="n">fsi_dma_push_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">fsi_dma_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quit</span>		<span class="o">=</span> <span class="n">fsi_dma_quit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">fsi_dma_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">transfer</span>	<span class="o">=</span> <span class="n">fsi_dma_transfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">fsi_dma_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_stop</span>	<span class="o">=</span> <span class="n">fsi_dma_push_start_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		dai ops</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_fifo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_play</span> <span class="o">=</span> <span class="n">fsi_stream_is_play</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">shift</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frame_capa</span><span class="p">;</span>

	<span class="cm">/* get on-chip RAM capacity */</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">fsi_master_read</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">FIFO_SZ</span><span class="p">);</span>
	<span class="n">shift</span> <span class="o">&gt;&gt;=</span> <span class="n">fsi_get_port_shift</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">shift</span> <span class="o">&amp;=</span> <span class="n">FIFO_SZ_MASK</span><span class="p">;</span>
	<span class="n">frame_capa</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fifo = %d words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frame_capa</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The maximum number of sample data varies depending</span>
<span class="cm">	 * on the number of channels selected for the format.</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIFOs are used in 4-channel units in 3-channel mode</span>
<span class="cm">	 * and in 8-channel units in 5- to 7-channel mode</span>
<span class="cm">	 * meaning that more FIFOs than the required size of DPRAM</span>
<span class="cm">	 * are used.</span>
<span class="cm">	 *</span>
<span class="cm">	 * ex) if 256 words of DP-RAM is connected</span>
<span class="cm">	 * 1 channel:  256 (256 x 1 = 256)</span>
<span class="cm">	 * 2 channels: 128 (128 x 2 = 256)</span>
<span class="cm">	 * 3 channels:  64 ( 64 x 3 = 192)</span>
<span class="cm">	 * 4 channels:  64 ( 64 x 4 = 256)</span>
<span class="cm">	 * 5 channels:  32 ( 32 x 5 = 160)</span>
<span class="cm">	 * 6 channels:  32 ( 32 x 6 = 192)</span>
<span class="cm">	 * 7 channels:  32 ( 32 x 7 = 224)</span>
<span class="cm">	 * 8 channels:  32 ( 32 x 8 = 256)</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">chan_num</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">frame_capa</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d channel %d store</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">chan_num</span><span class="p">,</span> <span class="n">frame_capa</span><span class="p">);</span>

	<span class="n">io</span><span class="o">-&gt;</span><span class="n">fifo_sample_capa</span> <span class="o">=</span> <span class="n">fsi_frame2sample</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">frame_capa</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set interrupt generation factor</span>
<span class="cm">	 * clear FIFO</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_play</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span>	<span class="n">DOFF_CTL</span><span class="p">,</span> <span class="n">IRQ_HALF</span><span class="p">);</span>
		<span class="n">fsi_reg_mask_set</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span>	<span class="n">DOFF_CTL</span><span class="p">,</span> <span class="n">FIFO_CLR</span><span class="p">,</span> <span class="n">FIFO_CLR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span>	<span class="n">DIFF_CTL</span><span class="p">,</span> <span class="n">IRQ_HALF</span><span class="p">);</span>
		<span class="n">fsi_reg_mask_set</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span>	<span class="n">DIFF_CTL</span><span class="p">,</span> <span class="n">FIFO_CLR</span><span class="p">,</span> <span class="n">FIFO_CLR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_hw_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">fsi_get_info_flags</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clock setting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsi_is_clk_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">))</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">DIMD</span> <span class="o">|</span> <span class="n">DOMD</span><span class="p">;</span>

	<span class="n">fsi_reg_mask_set</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">CKG1</span><span class="p">,</span> <span class="p">(</span><span class="n">DIMD</span> <span class="o">|</span> <span class="n">DOMD</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* clock inversion (CKG2) */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SH_FSI_LRM_INV</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SH_FSI_BRM_INV</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SH_FSI_LRS_INV</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SH_FSI_BRS_INV</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fsi_reg_write</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">CKG2</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* spdif ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsi_is_spdif</span><span class="p">(</span><span class="n">fsi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fsi_spdif_clk_ctrl</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fsi_reg_mask_set</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">OUT_SEL</span><span class="p">,</span> <span class="n">DMMD</span><span class="p">,</span> <span class="n">DMMD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * get bus settings</span>
<span class="cm">	 */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">sample_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">BUSOP_GET</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">bus_option</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">BUSOP_GET</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">bus_option</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fsi_format_bus_setup</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* irq clear */</span>
	<span class="n">fsi_irq_disable</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">fsi_irq_clear_status</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>

	<span class="cm">/* fifo init */</span>
	<span class="n">fsi_fifo_init</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_hw_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsi_is_clk_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">))</span>
		<span class="n">fsi_set_master_clk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_dai_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span> <span class="o">=</span> <span class="n">fsi_get_priv</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_dai_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span> <span class="o">=</span> <span class="n">fsi_get_priv</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_dai_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span> <span class="o">=</span> <span class="n">fsi_get_priv</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="n">fsi_stream_get</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="n">fsi_stream_init</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
		<span class="n">fsi_hw_startup</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fsi_stream_transfer</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">fsi_stream_start</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">fsi_hw_shutdown</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">fsi_stream_stop</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
		<span class="n">fsi_stream_quit</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_set_fmt_dai</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span>:
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">CR_I2S</span><span class="p">;</span>
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">chan_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_LEFT_J</span>:
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">CR_PCM</span><span class="p">;</span>
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">chan_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_set_fmt_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">fsi_get_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsi_version</span><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">CR_DTMD_SPDIF_PCM</span> <span class="o">|</span> <span class="n">CR_PCM</span><span class="p">;</span>
	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">chan_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">spdif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_dai_set_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span> <span class="o">=</span> <span class="n">fsi_get_priv_frm_dai</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>
	<span class="n">set_rate_func</span> <span class="n">set_rate</span> <span class="o">=</span> <span class="n">fsi_get_info_set_rate</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">fsi_get_info_flags</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set master/slave audio interface */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">clk_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsi_is_clk_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">set_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform doesn&#39;t have set_rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set format */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_FSI_FMT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SH_FSI_FMT_DAI</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fsi_set_fmt_dai</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SH_FSI_FMT_SPDIF</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fsi_set_fmt_spdif</span><span class="p">(</span><span class="n">fsi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_dai_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span> <span class="o">=</span> <span class="n">fsi_get_priv</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsi_is_clk_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fsi_set_master_clk</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">fsi_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">fsi_dai_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">fsi_dai_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>	<span class="o">=</span> <span class="n">fsi_dai_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">fsi_dai_set_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">fsi_dai_hw_params</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		pcm ops</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">fsi_pcm_hardware</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_INFO_INTERLEAVED</span>	<span class="o">|</span>
			<span class="n">SNDRV_PCM_INFO_MMAP</span>		<span class="o">|</span>
			<span class="n">SNDRV_PCM_INFO_MMAP_VALID</span>	<span class="o">|</span>
			<span class="n">SNDRV_PCM_INFO_PAUSE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span>		<span class="o">=</span> <span class="n">FSI_FMTS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span>			<span class="o">=</span> <span class="n">FSI_RATES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span>		<span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span>		<span class="o">=</span> <span class="mi">192000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span>	<span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span>	<span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span>		<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_soc_set_runtime_hwparams</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsi_pcm_hardware</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					    <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
					<span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">fsi_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span> <span class="o">=</span> <span class="n">fsi_get_priv</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="n">fsi_stream_get</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fsi_sample2frame</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">buff_sample_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">fsi_pcm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">fsi_pcm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">fsi_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span>	<span class="o">=</span> <span class="n">fsi_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span>	<span class="o">=</span> <span class="n">fsi_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		snd_soc_platform</span>
<span class="cm"> */</span>

<span class="cp">#define PREALLOC_BUFFER		(32 * 1024)</span>
<span class="cp">#define PREALLOC_BUFFER_MAX	(32 * 1024)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_pcm_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_pcm_lib_preallocate_free_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_pcm_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * dont use SNDRV_DMA_TYPE_DEV, since it will oops the SH kernel</span>
<span class="cm">	 * in MMAP mode (i.e. aplay -M)</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span>
		<span class="n">pcm</span><span class="p">,</span>
		<span class="n">SNDRV_DMA_TYPE_CONTINUOUS</span><span class="p">,</span>
		<span class="n">snd_dma_continuous_data</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">),</span>
		<span class="n">PREALLOC_BUFFER</span><span class="p">,</span> <span class="n">PREALLOC_BUFFER_MAX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		alsa struct</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">fsi_soc_dai</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;fsia-dai&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">rates</span>		<span class="o">=</span> <span class="n">FSI_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span>	<span class="o">=</span> <span class="n">FSI_FMTS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">rates</span>		<span class="o">=</span> <span class="n">FSI_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span>	<span class="o">=</span> <span class="n">FSI_FMTS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi_dai_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;fsib-dai&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">rates</span>		<span class="o">=</span> <span class="n">FSI_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span>	<span class="o">=</span> <span class="n">FSI_FMTS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">rates</span>		<span class="o">=</span> <span class="n">FSI_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span>	<span class="o">=</span> <span class="n">FSI_FMTS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_min</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi_dai_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_platform_driver</span> <span class="n">fsi_soc_platform</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi_pcm_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_new</span>	<span class="o">=</span> <span class="n">fsi_pcm_new</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_free</span>	<span class="o">=</span> <span class="n">fsi_pcm_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		platform function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsi_handler_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi_pio_push_handler</span><span class="p">;</span> <span class="cm">/* default PIO */</span>
	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">priv</span>	<span class="o">=</span> <span class="n">fsi</span><span class="p">;</span>
	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi_pio_pop_handler</span><span class="p">;</span>  <span class="cm">/* default PIO */</span>
	<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">priv</span>	<span class="o">=</span> <span class="n">fsi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsi</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">slave</span><span class="p">.</span><span class="n">slave_id</span>	<span class="o">=</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_id</span><span class="p">;</span>
		<span class="n">fsi</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">handler</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi_dma_push_handler</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span>	<span class="o">*</span><span class="n">id_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_fsi_platform_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">id_entry</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id_entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown fsi device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">||</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough FSI platform resources.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">master</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">master</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not allocate master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">master</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to ioremap FSI registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* master setting */</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">irq</span>		<span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">core</span>		<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fsi_core</span> <span class="o">*</span><span class="p">)</span><span class="n">id_entry</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* FSI A setting */</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">.</span><span class="n">base</span>	<span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">.</span><span class="n">master</span>	<span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">.</span><span class="n">info</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_a</span><span class="p">;</span>
	<span class="n">fsi_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fsi_stream_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSIA stream probe failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FSI B setting */</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">.</span><span class="n">base</span>	<span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">.</span><span class="n">master</span>	<span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">.</span><span class="n">info</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_b</span><span class="p">;</span>
	<span class="n">fsi_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fsi_stream_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSIB stream probe failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_fsia</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">master</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsi_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">id_entry</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq request err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_fsib</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_register_platform</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsi_soc_platform</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot snd soc register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_register_dais</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fsi_soc_dai</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fsi_soc_dai</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot snd dai register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_snd_soc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">exit_snd_soc:</span>
	<span class="n">snd_soc_unregister_platform</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">exit_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">master</span><span class="p">);</span>
<span class="nl">exit_fsib:</span>
	<span class="n">fsi_stream_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">);</span>
<span class="nl">exit_fsia:</span>
	<span class="n">fsi_stream_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">);</span>
<span class="nl">exit_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">exit_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">master</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>

	<span class="n">master</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">master</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">snd_soc_unregister_dais</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fsi_soc_dai</span><span class="p">));</span>
	<span class="n">snd_soc_unregister_platform</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">fsi_stream_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">);</span>
	<span class="n">fsi_stream_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__fsi_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsi_stream_is_working</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fsi_stream_stop</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">fsi_hw_shutdown</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__fsi_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsi</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">fsi_stream</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsi_stream_is_working</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fsi_hw_startup</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsi_is_clk_master</span><span class="p">(</span><span class="n">fsi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span>
		<span class="n">fsi_set_master_clk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fsi</span><span class="p">,</span> <span class="n">fsi</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">fsi_stream_start</span><span class="p">(</span><span class="n">fsi</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsia</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">;</span>

	<span class="n">__fsi_suspend</span><span class="p">(</span><span class="n">fsia</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsia</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">__fsi_suspend</span><span class="p">(</span><span class="n">fsia</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsia</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">__fsi_suspend</span><span class="p">(</span><span class="n">fsib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsib</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">__fsi_suspend</span><span class="p">(</span><span class="n">fsib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsib</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsia</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsia</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsi_priv</span> <span class="o">*</span><span class="n">fsib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">fsib</span><span class="p">;</span>

	<span class="n">__fsi_resume</span><span class="p">(</span><span class="n">fsia</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsia</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">__fsi_resume</span><span class="p">(</span><span class="n">fsia</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsia</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">__fsi_resume</span><span class="p">(</span><span class="n">fsib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsib</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">__fsi_resume</span><span class="p">(</span><span class="n">fsib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsib</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">fsi_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">fsi_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>			<span class="o">=</span> <span class="n">fsi_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsi_core</span> <span class="n">fsi1_core</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ver</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* Interrupt */</span>
	<span class="p">.</span><span class="n">int_st</span>	<span class="o">=</span> <span class="n">INT_ST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iemsk</span>	<span class="o">=</span> <span class="n">IEMSK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">imsk</span>	<span class="o">=</span> <span class="n">IMSK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsi_core</span> <span class="n">fsi2_core</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ver</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>

	<span class="cm">/* Interrupt */</span>
	<span class="p">.</span><span class="n">int_st</span>	<span class="o">=</span> <span class="n">CPU_INT_ST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iemsk</span>	<span class="o">=</span> <span class="n">CPU_IEMSK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">imsk</span>	<span class="o">=</span> <span class="n">CPU_IMSK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">a_mclk</span>	<span class="o">=</span> <span class="n">A_MST_CTLR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">b_mclk</span>	<span class="o">=</span> <span class="n">B_MST_CTLR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">fsi_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;sh_fsi&quot;</span><span class="p">,</span>	<span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fsi1_core</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sh_fsi2&quot;</span><span class="p">,</span>	<span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fsi2_core</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">fsi_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">fsi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> 	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;fsi-pcm-audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">fsi_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">fsi_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">fsi_id_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">fsi_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SuperH onchip FSI audio driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kuninori Morimoto &lt;morimoto.kuninori@renesas.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:fsi-pcm-audio&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
