<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › sh › siu_dai.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>siu_dai.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * siu_dai.c - ALSA SoC driver for Renesas SH7343, SH7722 SIU peripheral.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009-2010 Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;</span>
<span class="cm"> * Copyright (C) 2006 Carlos Munoz &lt;carlos@kenati.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;asm/clock.h&gt;</span>
<span class="cp">#include &lt;asm/siu.h&gt;</span>

<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>

<span class="cp">#include &quot;siu.h&quot;</span>

<span class="cm">/* Board specifics */</span>
<span class="cp">#if defined(CONFIG_CPU_SUBTYPE_SH7722)</span>
<span class="cp"># define SIU_MAX_VOLUME		0x1000</span>
<span class="cp">#else</span>
<span class="cp"># define SIU_MAX_VOLUME		0x7fff</span>
<span class="cp">#endif</span>

<span class="cp">#define PRAM_SIZE	0x2000</span>
<span class="cp">#define XRAM_SIZE	0x800</span>
<span class="cp">#define YRAM_SIZE	0x800</span>

<span class="cp">#define XRAM_OFFSET	0x4000</span>
<span class="cp">#define YRAM_OFFSET	0x6000</span>
<span class="cp">#define REG_OFFSET	0xc000</span>

<span class="cp">#define PLAYBACK_ENABLED	1</span>
<span class="cp">#define CAPTURE_ENABLED		2</span>

<span class="cp">#define VOLUME_CAPTURE		0</span>
<span class="cp">#define VOLUME_PLAYBACK		1</span>
<span class="cp">#define DFLT_VOLUME_LEVEL	0x08000800</span>

<span class="cm">/*</span>
<span class="cm"> * SPDIF is only available on port A and on some SIU implementations it is only</span>
<span class="cm"> * available for input. Due to the lack of hardware to test it, SPDIF is left</span>
<span class="cm"> * disabled in this driver version</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">format_flag</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">i2s</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pcm</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">spdif</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">port_flag</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">format_flag</span>	<span class="n">playback</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">format_flag</span>	<span class="n">capture</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">siu_i2s_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">port_flag</span> <span class="n">siu_flags</span><span class="p">[</span><span class="n">SIU_PORT_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SIU_PORT_A</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">i2s</span>	<span class="o">=</span> <span class="mh">0x50000000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pcm</span>	<span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">spdif</span>	<span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>	<span class="cm">/* not on all SIU versions */</span>
			<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0xd0000000</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">i2s</span>	<span class="o">=</span> <span class="mh">0x05000000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pcm</span>	<span class="o">=</span> <span class="mh">0x04000000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">spdif</span>	<span class="o">=</span> <span class="mh">0x08000000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x0d000000</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SIU_PORT_B</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">i2s</span>	<span class="o">=</span> <span class="mh">0x00500000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pcm</span>	<span class="o">=</span> <span class="mh">0x00400000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">spdif</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* impossible - turn off */</span>
			<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x00500000</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">i2s</span>	<span class="o">=</span> <span class="mh">0x00050000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pcm</span>	<span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">spdif</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* impossible - turn off */</span>
			<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x00050000</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_dai_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Issue software reset to siu */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SRCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Wait for the reset to take effect */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">stfifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">trdat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* portA, portB, SIU operate */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SRCTL</span><span class="p">,</span> <span class="mh">0x301</span><span class="p">);</span>

	<span class="cm">/* portA=256fs, portB=256fs */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_CKCTL</span><span class="p">,</span> <span class="mh">0x40400000</span><span class="p">);</span>

	<span class="cm">/* portA&#39;s BRG does not divide SIUCKA */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_BRGASEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_BRRA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* portB&#39;s BRG divides SIUCKB by half */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_BRGBSEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_BRRB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_IFCTL</span><span class="p">,</span> <span class="mh">0x44440000</span><span class="p">);</span>

	<span class="cm">/* portA: 32 bit/fs, master; portB: 32 bit/fs, master */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SFORM</span><span class="p">,</span> <span class="mh">0x0c0c0000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Volume levels: looks like the DSP firmware implements volume controls</span>
<span class="cm">	 * differently from what&#39;s described in the datasheet</span>
<span class="cm">	 */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBDVCA</span><span class="p">,</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">volume</span><span class="p">);</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBDVCB</span><span class="p">,</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">volume</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_dai_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* SIU software reset */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SRCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_dai_spbAselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ydef</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">yram0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/* path A use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* portA */</span>
	<span class="k">else</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* portB */</span>

	<span class="n">ydef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ab1a</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ab0a</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">dir</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ydef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">yram0</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* 0x03000300 */</span>
	<span class="n">ydef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">ydef</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">yram0</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* 0 */</span>
	<span class="n">ydef</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">yram0</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* 0 */</span>
	<span class="n">ydef</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">event</span><span class="p">;</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">stfifo</span> <span class="o">|=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">stfifo</span><span class="p">;</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">trdat</span> <span class="o">|=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">trdat</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_dai_spbBselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ydef</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">yram0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/* path B use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>		<span class="cm">/* portA */</span>
	<span class="k">else</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>		<span class="cm">/* portB */</span>

	<span class="n">ydef</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ab1a</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ab0a</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ydef</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">event</span><span class="p">;</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">stfifo</span> <span class="o">|=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">stfifo</span><span class="p">;</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">trdat</span> <span class="o">|=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">spbpar</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">trdat</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_dai_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">srctl</span><span class="p">,</span> <span class="n">ifctl</span><span class="p">;</span>

	<span class="n">srctl</span> <span class="o">=</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SRCTL</span><span class="p">);</span>
	<span class="n">ifctl</span> <span class="o">=</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_IFCTL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIU_PORT_A</span>:
		<span class="cm">/* portA operates */</span>
		<span class="n">srctl</span> <span class="o">|=</span> <span class="mh">0x200</span><span class="p">;</span>
		<span class="n">ifctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xc2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIU_PORT_B</span>:
		<span class="cm">/* portB operates */</span>
		<span class="n">srctl</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">ifctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x31</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SRCTL</span><span class="p">,</span> <span class="n">srctl</span><span class="p">);</span>
	<span class="cm">/* Unmute and configure portA */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_IFCTL</span><span class="p">,</span> <span class="n">ifctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * At the moment only fixed Left-upper, Left-lower, Right-upper, Right-lower</span>
<span class="cm"> * packing is supported</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_dai_pcmdatapack</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpak</span><span class="p">;</span>

	<span class="n">dpak</span> <span class="o">=</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_DPAK</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIU_PORT_A</span>:
		<span class="n">dpak</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xc0000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIU_PORT_B</span>:
		<span class="n">dpak</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00c00000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_DPAK</span><span class="p">,</span> <span class="n">dpak</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_dai_spbstart</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ydef</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">yram0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">add</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* Load SPB Program in PRAM */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">pram0</span><span class="p">;</span>
	<span class="n">add</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pram</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">PRAM0_SIZE</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">add</span><span class="o">++</span><span class="p">,</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">siu_write32</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">pram1</span><span class="p">;</span>
	<span class="n">add</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pram</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x0100</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">PRAM1_SIZE</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">add</span><span class="o">++</span><span class="p">,</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">siu_write32</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

	<span class="cm">/* XRAM initialization */</span>
	<span class="n">add</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xram</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">XRAM0_SIZE</span> <span class="o">+</span> <span class="n">XRAM1_SIZE</span> <span class="o">+</span> <span class="n">XRAM2_SIZE</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">add</span><span class="o">++</span><span class="p">)</span>
		<span class="n">siu_write32</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* YRAM variable area initialization */</span>
	<span class="n">add</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">yram</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">YRAM_DEF_SIZE</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">add</span><span class="o">++</span><span class="p">)</span>
		<span class="n">siu_write32</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">ydef</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>

	<span class="cm">/* YRAM FIR coefficient area initialization */</span>
	<span class="n">add</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">yram</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x0200</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">YRAM_FIR_SIZE</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">add</span><span class="o">++</span><span class="p">)</span>
		<span class="n">siu_write32</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">yram_fir_coeff</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>

	<span class="cm">/* YRAM IIR coefficient area initialization */</span>
	<span class="n">add</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">yram</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x0600</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">YRAM_IIR_SIZE</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">add</span><span class="o">++</span><span class="p">)</span>
		<span class="n">siu_write32</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_TRDAT</span><span class="p">,</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">trdat</span><span class="p">);</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">trdat</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>


	<span class="cm">/* SPB start condition: software */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBACTIV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Start SPB */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBCTL</span><span class="p">,</span> <span class="mh">0xc0000000</span><span class="p">);</span>
	<span class="cm">/* Wait for program to halt */</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBCTL</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80000000</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* SPB program start address setting */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBPSET</span><span class="p">,</span> <span class="mh">0x00400000</span><span class="p">);</span>
	<span class="cm">/* SPB hardware start(FIFOCTL source) */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBACTIV</span><span class="p">,</span> <span class="mh">0xc0000000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_dai_spbstop</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBACTIV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* SPB stop */</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">stfifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*		API functions		*/</span>

<span class="cm">/* Playback and capture hardware properties are identical */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">siu_dai_pcm_hw</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span>		<span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span>			<span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span>		<span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span>		<span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span>	<span class="o">=</span> <span class="n">SIU_BUFFER_BYTES_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span>	<span class="o">=</span> <span class="n">SIU_PERIOD_BYTES_MIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span>	<span class="o">=</span> <span class="n">SIU_PERIOD_BYTES_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span>		<span class="o">=</span> <span class="n">SIU_PERIODS_MIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span>		<span class="o">=</span> <span class="n">SIU_PERIODS_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_dai_info_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctrl</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kctrl</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">SIU_MAX_VOLUME</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_dai_get_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctrl</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">kctrl</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VOLUME_PLAYBACK</span>:
		<span class="cm">/* Playback is always on port 0 */</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">volume</span><span class="p">;</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VOLUME_CAPTURE</span>:
		<span class="cm">/* Capture is always on port 1 */</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">volume</span><span class="p">;</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s() invalid private_value=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">kctrl</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_dai_put_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctrl</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_vol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_vol</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">SIU_MAX_VOLUME</span> <span class="o">||</span>
	    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">SIU_MAX_VOLUME</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">new_vol</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* See comment above - DSP firmware implementation */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">kctrl</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VOLUME_PLAYBACK</span>:
		<span class="cm">/* Playback is always on port 0 */</span>
		<span class="n">cur_vol</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">volume</span><span class="p">;</span>
		<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBDVCA</span><span class="p">,</span> <span class="n">new_vol</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">new_vol</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VOLUME_CAPTURE</span>:
		<span class="cm">/* Capture is always on port 1 */</span>
		<span class="n">cur_vol</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">volume</span><span class="p">;</span>
		<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBDVCB</span><span class="p">,</span> <span class="n">new_vol</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">new_vol</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s() invalid private_value=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">kctrl</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_vol</span> <span class="o">!=</span> <span class="n">new_vol</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">playback_controls</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span>		<span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>		<span class="o">=</span> <span class="n">siu_dai_info_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>		<span class="o">=</span> <span class="n">siu_dai_get_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span>		<span class="o">=</span> <span class="n">siu_dai_put_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span>	<span class="o">=</span> <span class="n">VOLUME_PLAYBACK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">capture_controls</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span>		<span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;PCM Capture Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>		<span class="o">=</span> <span class="n">siu_dai_info_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>		<span class="o">=</span> <span class="n">siu_dai_get_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span>		<span class="o">=</span> <span class="n">siu_dai_put_volume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span>	<span class="o">=</span> <span class="n">VOLUME_CAPTURE</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">siu_init_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">siu_port</span> <span class="o">**</span><span class="n">port_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">**</span><span class="n">port_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">port_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: port #%d@%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">port_info</span><span class="p">);</span>

	<span class="p">(</span><span class="o">*</span><span class="n">port_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">DFLT_VOLUME_LEVEL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">port_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">DFLT_VOLUME_LEVEL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add mixer support. The SPB is used to change the volume. Both</span>
<span class="cm">	 * ports use the same SPB. Therefore, we only register one</span>
<span class="cm">	 * control instance since it will be used by both channels.</span>
<span class="cm">	 * In error case we continue without controls.</span>
<span class="cm">	 */</span>
	<span class="n">kctrl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">playback_controls</span><span class="p">,</span> <span class="o">*</span><span class="n">port_info</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed to add playback controls %p port=%d err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">kctrl</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">kctrl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">capture_controls</span><span class="p">,</span> <span class="o">*</span><span class="n">port_info</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed to add capture controls %p port=%d err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">kctrl</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">siu_free_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_dai_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_port</span>	<span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: port=%d@%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>

	<span class="n">snd_soc_set_runtime_hwparams</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siu_dai_pcm_hw</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">siu_dai_start</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_dai_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">siu_port</span>	<span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: port=%d@%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">play_cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLAYBACK_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">play_cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CAPTURE_ENABLED</span><span class="p">;</span>

	<span class="cm">/* Stop the siu if the other stream is not using it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">play_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* during stmread or stmwrite ? */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">rw_flg</span> <span class="o">||</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">rw_flg</span><span class="p">);</span>
		<span class="n">siu_dai_spbstop</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
		<span class="n">siu_dai_stop</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* PCM part of siu_dai_playback_prepare() / siu_dai_capture_prepare() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_dai_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: port %d, active streams %lx, %d channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">play_cap</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">self</span> <span class="o">=</span> <span class="n">PLAYBACK_ENABLED</span><span class="p">;</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">self</span> <span class="o">=</span> <span class="n">CAPTURE_ENABLED</span><span class="p">;</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up the siu if not already done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">play_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* stream-data transfer flag */</span>

		<span class="n">siu_dai_spbAselect</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
		<span class="n">siu_dai_spbBselect</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>

		<span class="n">siu_dai_open</span><span class="p">(</span><span class="n">siu_stream</span><span class="p">);</span>

		<span class="n">siu_dai_pcmdatapack</span><span class="p">(</span><span class="n">siu_stream</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">siu_dai_spbstart</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">play_cap</span> <span class="o">|=</span> <span class="n">self</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SIU can set bus format to I2S / PCM / SPDIF independently for playback and</span>
<span class="cm"> * capture, however, the current API sets the bus format globally for a DAI.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_dai_set_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ifctl</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: fmt 0x%x on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Here select between I2S / PCM / SPDIF */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span>:
		<span class="n">ifctl</span> <span class="o">=</span> <span class="n">siu_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">].</span><span class="n">playback</span><span class="p">.</span><span class="n">i2s</span> <span class="o">|</span>
			<span class="n">siu_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">].</span><span class="n">capture</span><span class="p">.</span><span class="n">i2s</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_LEFT_J</span>:
		<span class="n">ifctl</span> <span class="o">=</span> <span class="n">siu_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">].</span><span class="n">playback</span><span class="p">.</span><span class="n">pcm</span> <span class="o">|</span>
			<span class="n">siu_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">].</span><span class="n">capture</span><span class="p">.</span><span class="n">pcm</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* SPDIF disabled - see comment at the top */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ifctl</span> <span class="o">|=</span> <span class="o">~</span><span class="p">(</span><span class="n">siu_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">].</span><span class="n">playback</span><span class="p">.</span><span class="n">mask</span> <span class="o">|</span>
		   <span class="n">siu_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">].</span><span class="n">capture</span><span class="p">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_IFCTL</span><span class="p">);</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_IFCTL</span><span class="p">,</span> <span class="n">ifctl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_dai_set_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clk_id</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">siu_clk</span><span class="p">,</span> <span class="o">*</span><span class="n">parent_clk</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">siu_name</span><span class="p">,</span> <span class="o">*</span><span class="n">parent_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">SND_SOC_CLOCK_IN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: using clock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">clk_id</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clk_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIU_CLKA_PLL</span>:
		<span class="n">siu_name</span> <span class="o">=</span> <span class="s">&quot;siua_clk&quot;</span><span class="p">;</span>
		<span class="n">parent_name</span> <span class="o">=</span> <span class="s">&quot;pll_clk&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIU_CLKA_EXT</span>:
		<span class="n">siu_name</span> <span class="o">=</span> <span class="s">&quot;siua_clk&quot;</span><span class="p">;</span>
		<span class="n">parent_name</span> <span class="o">=</span> <span class="s">&quot;siumcka_clk&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIU_CLKB_PLL</span>:
		<span class="n">siu_name</span> <span class="o">=</span> <span class="s">&quot;siub_clk&quot;</span><span class="p">;</span>
		<span class="n">parent_name</span> <span class="o">=</span> <span class="s">&quot;pll_clk&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIU_CLKB_EXT</span>:
		<span class="n">siu_name</span> <span class="o">=</span> <span class="s">&quot;siub_clk&quot;</span><span class="p">;</span>
		<span class="n">parent_name</span> <span class="o">=</span> <span class="s">&quot;siumckb_clk&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">siu_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">siu_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">siu_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cannot get a SIU clock: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">siu_clk</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">siu_clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">parent_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">parent_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">parent_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">parent_clk</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot get a SIU clock parent: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">epclkget</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_parent</span><span class="p">(</span><span class="n">siu_clk</span><span class="p">,</span> <span class="n">parent_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot reparent the SIU clock: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eclksetp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="n">siu_clk</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot set SIU clock rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* TODO: when clkdev gets reference counting we&#39;ll move these to siu_dai_shutdown() */</span>
<span class="nl">eclksetp:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">parent_clk</span><span class="p">);</span>
<span class="nl">epclkget:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">siu_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">siu_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">siu_dai_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">siu_dai_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span> <span class="n">siu_dai_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_sysclk</span>	<span class="o">=</span> <span class="n">siu_dai_set_sysclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">siu_dai_set_fmt</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">siu_i2s_dai</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;siu-i2s-dai&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">siu_dai_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">siu_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">siu_i2s_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="s">&quot;siu_spb.bin&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ereqfw</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loaded firmware is &quot;const&quot; - read only, but we have to modify it in</span>
<span class="cm">	 * snd_siu_sh7343_spbAselect() and snd_siu_sh7343_spbBselect()</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">egetres</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">region</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
				    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">region</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SIU region already claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ereqmemreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pram</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">PRAM_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pram</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">emappram</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xram</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">XRAM_OFFSET</span><span class="p">,</span> <span class="n">XRAM_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xram</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">emapxram</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">yram</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">YRAM_OFFSET</span><span class="p">,</span> <span class="n">YRAM_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">yram</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">emapyram</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">REG_OFFSET</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span>
			    <span class="n">REG_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">emapreg</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="cm">/* register using ARRAY version so we can keep dai name */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_register_dais</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siu_i2s_dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">edaiinit</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_register_platform</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siu_platform</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">esocregp</span><span class="p">;</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">esocregp:</span>
	<span class="n">snd_soc_unregister_dai</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">edaiinit:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
<span class="nl">emapreg:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">yram</span><span class="p">);</span>
<span class="nl">emapyram:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xram</span><span class="p">);</span>
<span class="nl">emapxram:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pram</span><span class="p">);</span>
<span class="nl">emappram:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
<span class="nl">ereqmemreg:</span>
<span class="nl">egetres:</span>
<span class="nl">ereqfw:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">siu_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">snd_soc_unregister_platform</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">snd_soc_unregister_dai</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">yram</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xram</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pram</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">siu_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> 	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;siu-pcm-audio&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">siu_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">siu_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">siu_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Carlos Munoz &lt;carlos@kenati.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ALSA SoC SH7722 SIU driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
