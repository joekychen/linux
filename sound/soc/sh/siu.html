<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › sh › siu.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>siu.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * siu.h - ALSA SoC driver for Renesas SH7343, SH7722 SIU peripheral.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009-2010 Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;</span>
<span class="cm"> * Copyright (C) 2006 Carlos Munoz &lt;carlos@kenati.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef SIU_H</span>
<span class="cp">#define SIU_H</span>

<span class="cm">/* Common kernel and user-space firmware-building defines and types */</span>

<span class="cp">#define YRAM0_SIZE		(0x0040 / 4)		</span><span class="cm">/* 16 */</span><span class="cp"></span>
<span class="cp">#define YRAM1_SIZE		(0x0080 / 4)		</span><span class="cm">/* 32 */</span><span class="cp"></span>
<span class="cp">#define YRAM2_SIZE		(0x0040 / 4)		</span><span class="cm">/* 16 */</span><span class="cp"></span>
<span class="cp">#define YRAM3_SIZE		(0x0080 / 4)		</span><span class="cm">/* 32 */</span><span class="cp"></span>
<span class="cp">#define YRAM4_SIZE		(0x0080 / 4)		</span><span class="cm">/* 32 */</span><span class="cp"></span>
<span class="cp">#define YRAM_DEF_SIZE		(YRAM0_SIZE + YRAM1_SIZE + YRAM2_SIZE + \</span>
<span class="cp">				 YRAM3_SIZE + YRAM4_SIZE)</span>
<span class="cp">#define YRAM_FIR_SIZE		(0x0400 / 4)		</span><span class="cm">/* 256 */</span><span class="cp"></span>
<span class="cp">#define YRAM_IIR_SIZE		(0x0200 / 4)		</span><span class="cm">/* 128 */</span><span class="cp"></span>

<span class="cp">#define XRAM0_SIZE		(0x0400 / 4)		</span><span class="cm">/* 256 */</span><span class="cp"></span>
<span class="cp">#define XRAM1_SIZE		(0x0200 / 4)		</span><span class="cm">/* 128 */</span><span class="cp"></span>
<span class="cp">#define XRAM2_SIZE		(0x0200 / 4)		</span><span class="cm">/* 128 */</span><span class="cp"></span>

<span class="cm">/* PRAM program array size */</span>
<span class="cp">#define PRAM0_SIZE		(0x0100 / 4)		</span><span class="cm">/* 64 */</span><span class="cp"></span>
<span class="cp">#define PRAM1_SIZE		((0x2000 - 0x0100) / 4)	</span><span class="cm">/* 1984 */</span><span class="cp"></span>

<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="k">struct</span> <span class="n">siu_spb_param</span> <span class="p">{</span>
	<span class="n">__u32</span>	<span class="n">ab1a</span><span class="p">;</span>	<span class="cm">/* input FIFO address */</span>
	<span class="n">__u32</span>	<span class="n">ab0a</span><span class="p">;</span>	<span class="cm">/* output FIFO address */</span>
	<span class="n">__u32</span>	<span class="n">dir</span><span class="p">;</span>	<span class="cm">/* 0=the ather except CPUOUTPUT, 1=CPUINPUT */</span>
	<span class="n">__u32</span>	<span class="n">event</span><span class="p">;</span>	<span class="cm">/* SPB program starting conditions */</span>
	<span class="n">__u32</span>	<span class="n">stfifo</span><span class="p">;</span>	<span class="cm">/* STFIFO register setting value */</span>
	<span class="n">__u32</span>	<span class="n">trdat</span><span class="p">;</span>	<span class="cm">/* TRDAT register setting value */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">siu_firmware</span> <span class="p">{</span>
	<span class="n">__u32</span>			<span class="n">yram_fir_coeff</span><span class="p">[</span><span class="n">YRAM_FIR_SIZE</span><span class="p">];</span>
	<span class="n">__u32</span>			<span class="n">pram0</span><span class="p">[</span><span class="n">PRAM0_SIZE</span><span class="p">];</span>
	<span class="n">__u32</span>			<span class="n">pram1</span><span class="p">[</span><span class="n">PRAM1_SIZE</span><span class="p">];</span>
	<span class="n">__u32</span>			<span class="n">yram0</span><span class="p">[</span><span class="n">YRAM0_SIZE</span><span class="p">];</span>
	<span class="n">__u32</span>			<span class="n">yram1</span><span class="p">[</span><span class="n">YRAM1_SIZE</span><span class="p">];</span>
	<span class="n">__u32</span>			<span class="n">yram2</span><span class="p">[</span><span class="n">YRAM2_SIZE</span><span class="p">];</span>
	<span class="n">__u32</span>			<span class="n">yram3</span><span class="p">[</span><span class="n">YRAM3_SIZE</span><span class="p">];</span>
	<span class="n">__u32</span>			<span class="n">yram4</span><span class="p">[</span><span class="n">YRAM4_SIZE</span><span class="p">];</span>
	<span class="n">__u32</span>			<span class="n">spbpar_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_spb_param</span>	<span class="n">spbpar</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/sh_dma.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>

<span class="cp">#define SIU_PERIOD_BYTES_MAX	8192		</span><span class="cm">/* DMA transfer/period size */</span><span class="cp"></span>
<span class="cp">#define SIU_PERIOD_BYTES_MIN	256		</span><span class="cm">/* DMA transfer/period size */</span><span class="cp"></span>
<span class="cp">#define SIU_PERIODS_MAX		64		</span><span class="cm">/* Max periods in buffer */</span><span class="cp"></span>
<span class="cp">#define SIU_PERIODS_MIN		4		</span><span class="cm">/* Min periods in buffer */</span><span class="cp"></span>
<span class="cp">#define SIU_BUFFER_BYTES_MAX	(SIU_PERIOD_BYTES_MAX * SIU_PERIODS_MAX)</span>

<span class="cm">/* SIU ports: only one can be used at a time */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">SIU_PORT_A</span><span class="p">,</span>
	<span class="n">SIU_PORT_B</span><span class="p">,</span>
	<span class="n">SIU_PORT_NUM</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* SIU clock configuration */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">SIU_CLKA_PLL</span><span class="p">,</span>
	<span class="n">SIU_CLKA_EXT</span><span class="p">,</span>
	<span class="n">SIU_CLKB_PLL</span><span class="p">,</span>
	<span class="n">SIU_CLKB_EXT</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">device</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">siu_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">port_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">pram</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">xram</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">yram</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_firmware</span>	<span class="n">fw</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">siu_stream</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>		<span class="n">tasklet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span>	<span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="n">snd_pcm_format_t</span>		<span class="n">format</span><span class="p">;</span>
	<span class="kt">size_t</span>				<span class="n">buf_bytes</span><span class="p">;</span>
	<span class="kt">size_t</span>				<span class="n">period_bytes</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">cur_period</span><span class="p">;</span>	<span class="cm">/* Period currently in dma */</span>
	<span class="n">u32</span>				<span class="n">volume</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span>		<span class="n">xfer_cnt</span><span class="p">;</span>	<span class="cm">/* Number of frames */</span>
	<span class="n">u8</span>				<span class="n">rw_flg</span><span class="p">;</span>		<span class="cm">/* transfer status */</span>
	<span class="cm">/* DMA status */</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="o">*</span><span class="n">chan</span><span class="p">;</span>		<span class="cm">/* DMA channel */</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span>			<span class="n">cookie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_dmae_slave</span>		<span class="n">param</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">siu_port</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">play_cap</span><span class="p">;</span>	<span class="cm">/* Used to track full duplex */</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span>		<span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_stream</span>	<span class="n">playback</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_stream</span>	<span class="n">capture</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">stfifo</span><span class="p">;</span>		<span class="cm">/* STFIFO value from firmware */</span>
	<span class="n">u32</span>			<span class="n">trdat</span><span class="p">;</span>		<span class="cm">/* TRDAT value from firmware */</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">siu_ports</span><span class="p">[</span><span class="n">SIU_PORT_NUM</span><span class="p">];</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="nf">siu_port_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span>
		<span class="n">to_platform_device</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">siu_ports</span><span class="p">[</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* Register access */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">siu_write32</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">siu_read32</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SIU registers */</span>
<span class="cp">#define SIU_IFCTL	(0x000 / sizeof(u32))</span>
<span class="cp">#define SIU_SRCTL	(0x004 / sizeof(u32))</span>
<span class="cp">#define SIU_SFORM	(0x008 / sizeof(u32))</span>
<span class="cp">#define SIU_CKCTL	(0x00c / sizeof(u32))</span>
<span class="cp">#define SIU_TRDAT	(0x010 / sizeof(u32))</span>
<span class="cp">#define SIU_STFIFO	(0x014 / sizeof(u32))</span>
<span class="cp">#define SIU_DPAK	(0x01c / sizeof(u32))</span>
<span class="cp">#define SIU_CKREV	(0x020 / sizeof(u32))</span>
<span class="cp">#define SIU_EVNTC	(0x028 / sizeof(u32))</span>
<span class="cp">#define SIU_SBCTL	(0x040 / sizeof(u32))</span>
<span class="cp">#define SIU_SBPSET	(0x044 / sizeof(u32))</span>
<span class="cp">#define SIU_SBFSTS	(0x068 / sizeof(u32))</span>
<span class="cp">#define SIU_SBDVCA	(0x06c / sizeof(u32))</span>
<span class="cp">#define SIU_SBDVCB	(0x070 / sizeof(u32))</span>
<span class="cp">#define SIU_SBACTIV	(0x074 / sizeof(u32))</span>
<span class="cp">#define SIU_DMAIA	(0x090 / sizeof(u32))</span>
<span class="cp">#define SIU_DMAIB	(0x094 / sizeof(u32))</span>
<span class="cp">#define SIU_DMAOA	(0x098 / sizeof(u32))</span>
<span class="cp">#define SIU_DMAOB	(0x09c / sizeof(u32))</span>
<span class="cp">#define SIU_DMAML	(0x0a0 / sizeof(u32))</span>
<span class="cp">#define SIU_SPSTS	(0x0cc / sizeof(u32))</span>
<span class="cp">#define SIU_SPCTL	(0x0d0 / sizeof(u32))</span>
<span class="cp">#define SIU_BRGASEL	(0x100 / sizeof(u32))</span>
<span class="cp">#define SIU_BRRA	(0x104 / sizeof(u32))</span>
<span class="cp">#define SIU_BRGBSEL	(0x108 / sizeof(u32))</span>
<span class="cp">#define SIU_BRRB	(0x10c / sizeof(u32))</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">snd_soc_platform_driver</span> <span class="n">siu_platform</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">siu_i2s_data</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">siu_init_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">siu_port</span> <span class="o">**</span><span class="n">port_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">siu_free_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* SIU_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
