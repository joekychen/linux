<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › sh › siu_pcm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>siu_pcm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * siu_pcm.c - ALSA driver for Renesas SH7343, SH7722 SIU peripheral.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009-2010 Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;</span>
<span class="cm"> * Copyright (C) 2006 Carlos Munoz &lt;carlos@kenati.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>

<span class="cp">#include &lt;asm/siu.h&gt;</span>

<span class="cp">#include &quot;siu.h&quot;</span>

<span class="cp">#define GET_MAX_PERIODS(buf_bytes, period_bytes) \</span>
<span class="cp">				((buf_bytes) / (period_bytes))</span>
<span class="cp">#define PERIOD_OFFSET(buf_addr, period_num, period_bytes) \</span>
<span class="cp">				((buf_addr) + ((period_num) * (period_bytes)))</span>

<span class="cp">#define RWF_STM_RD		0x01		</span><span class="cm">/* Read in progress */</span><span class="cp"></span>
<span class="cp">#define RWF_STM_WT		0x02		</span><span class="cm">/* Write in progress */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">siu_ports</span><span class="p">[</span><span class="n">SIU_PORT_NUM</span><span class="p">];</span>

<span class="cm">/* transfersize is number of u32 dma transfers per period */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_stmwrite_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stfifo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* output FIFO disable */</span>
	<span class="n">stfifo</span> <span class="o">=</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_STFIFO</span><span class="p">);</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_STFIFO</span><span class="p">,</span> <span class="n">stfifo</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0c180c18</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: STFIFO %x -&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">stfifo</span><span class="p">,</span> <span class="n">stfifo</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0c180c18</span><span class="p">);</span>

	<span class="cm">/* during stmwrite clear */</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_stmwrite_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* Current period in buffer */</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">cur_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* during stmwrite flag set */</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span> <span class="o">=</span> <span class="n">RWF_STM_WT</span><span class="p">;</span>

	<span class="cm">/* DMA transfer start */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_dma_tx_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Update completed period count */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cur_period</span> <span class="o">&gt;=</span>
	    <span class="n">GET_MAX_PERIODS</span><span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">,</span>
			    <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">))</span>
		<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cur_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: done period #%d (%u/%u bytes), cookie %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cur_period</span><span class="p">,</span>
		<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cur_period</span> <span class="o">*</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">,</span>
		<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">,</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="cm">/* Notify alsa: a period is done */</span>
	<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_wr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">,</span>
			  <span class="n">dma_addr_t</span> <span class="n">buff</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stfifo</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">pfn_to_page</span><span class="p">(</span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">buff</span><span class="p">)),</span>
		    <span class="n">size</span><span class="p">,</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
	<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">buff</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">,</span> <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate a dma descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">siu_dma_tx_complete</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">siu_stream</span><span class="p">;</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to submit a dma transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">tx_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* only output FIFO enable */</span>
	<span class="n">stfifo</span> <span class="o">=</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_STFIFO</span><span class="p">);</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_STFIFO</span><span class="p">,</span> <span class="n">stfifo</span> <span class="o">|</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">stfifo</span> <span class="o">&amp;</span> <span class="mh">0x0c180c18</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: STFIFO %x -&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">stfifo</span><span class="p">,</span> <span class="n">stfifo</span> <span class="o">|</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">stfifo</span> <span class="o">&amp;</span> <span class="mh">0x0c180c18</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_rd_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">,</span>
			  <span class="n">dma_addr_t</span> <span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stfifo</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %u@%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">buff</span><span class="p">);</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">pfn_to_page</span><span class="p">(</span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">buff</span><span class="p">)),</span>
		    <span class="n">size</span><span class="p">,</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
	<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">buff</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">,</span> <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate dma descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">siu_dma_tx_complete</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">siu_stream</span><span class="p">;</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to submit dma descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">tx_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* only input FIFO enable */</span>
	<span class="n">stfifo</span> <span class="o">=</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_STFIFO</span><span class="p">);</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_STFIFO</span><span class="p">,</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_STFIFO</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">stfifo</span> <span class="o">&amp;</span> <span class="mh">0x13071307</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: STFIFO %x -&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">stfifo</span><span class="p">,</span> <span class="n">stfifo</span> <span class="o">|</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">stfifo</span> <span class="o">&amp;</span> <span class="mh">0x13071307</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_io_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span> <span class="o">=</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: flags %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: stream inactive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">buff</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">virt</span><span class="p">;</span>

		<span class="n">buff</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">PERIOD_OFFSET</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
						<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cur_period</span><span class="p">,</span>
						<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>
		<span class="n">virt</span> <span class="o">=</span> <span class="n">PERIOD_OFFSET</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span>
				     <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cur_period</span><span class="p">,</span>
				     <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">;</span>

		<span class="cm">/* DMA transfer start */</span>
		<span class="n">siu_pcm_rd_set</span><span class="p">(</span><span class="n">port_info</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">siu_pcm_wr_set</span><span class="p">(</span><span class="n">port_info</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">PERIOD_OFFSET</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
						<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cur_period</span><span class="p">,</span>
						<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">),</span>
			       <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Capture */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_stmread_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">xfer_cnt</span> <span class="o">&gt;</span> <span class="mh">0x1000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* Current period in buffer */</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cur_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* during stmread flag set */</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span> <span class="o">=</span> <span class="n">RWF_STM_RD</span><span class="p">;</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_stmread_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stfifo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* input FIFO disable */</span>
	<span class="n">stfifo</span> <span class="o">=</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_STFIFO</span><span class="p">);</span>
	<span class="n">siu_write32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_STFIFO</span><span class="p">,</span> <span class="n">stfifo</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x13071307</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: STFIFO %x -&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">stfifo</span><span class="p">,</span> <span class="n">stfifo</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x13071307</span><span class="p">);</span>

	<span class="cm">/* during stmread flag clear */</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">rw_flg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;snd_pcm_lib_malloc_pages() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_port</span>	<span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_dmae_slave</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: slave ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">slave_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">!=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Playback / Capture */</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_platform</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_dmae_slave</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s, port=%d@%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
		<span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">slave_id</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_slave_tx_b</span> <span class="o">:</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_slave_tx_a</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>
		<span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">slave_id</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_slave_rx_b</span> <span class="o">:</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_slave_rx_a</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">;</span>
	<span class="cm">/* Get DMA channel */</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA channel allocation failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">ss</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>

	<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> 	<span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span><span class="p">;</span>
	<span class="n">snd_pcm_sframes_t</span> <span class="n">xfer_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">buf_bytes</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: port=%d, %d channels, period=%u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>

	<span class="cm">/* We only support buffers that are multiples of the period */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">buf_bytes</span> <span class="o">%</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s() - buffer=%d not multiple of period=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">,</span>
		       <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfer_cnt</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfer_cnt</span> <span class="o">||</span> <span class="n">xfer_cnt</span> <span class="o">&gt;</span> <span class="mh">0x1000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
	<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">xfer_cnt</span> <span class="o">=</span> <span class="n">xfer_cnt</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;port=%d buf=%lx buf_bytes=%d period_bytes=%d &quot;</span>
		<span class="s">&quot;format=%d channels=%d xfer_cnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">,</span>
		<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">,</span>
		<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xfer_cnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: port=%d@%p, cmd=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">port_info</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">siu_pcm_stmwrite_start</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">siu_pcm_stmread_start</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: start failed on port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
			<span class="n">siu_pcm_stmwrite_stop</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">siu_pcm_stmread_stop</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s() unsupported cmd=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * So far only resolution of one period is supported, subject to extending the</span>
<span class="cm"> * dmangine API</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">siu_pcm_pointer_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_port_info</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_stream</span> <span class="o">*</span><span class="n">siu_stream</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">siu_stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ptr is the offset into the buffer where the dma is currently at. We</span>
<span class="cm">	 * check if the dma buffer has just wrapped.</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">PERIOD_OFFSET</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			    <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cur_period</span><span class="p">,</span>
			    <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">)</span> <span class="o">-</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: port=%d, events %x, FSTS %x, xferred %u/%u, cookie %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_EVNTC</span><span class="p">),</span>
		<span class="n">siu_read32</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SIU_SBFSTS</span><span class="p">),</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">,</span>
		<span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">siu_stream</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">siu_pcm_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* card-&gt;dev == socdev-&gt;dev, see snd_soc_new_pcms() */</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siu_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">siu_i2s_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* pdev-&gt;id selects between SIUA and SIUB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">SIU_PORT_NUM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * While the siu has 2 ports, only one port can be on at a time (only 1</span>
<span class="cm">	 * SPB). So far all the boards using the siu had only one of the ports</span>
<span class="cm">	 * wired to a codec. To simplify things, we only register one port with</span>
<span class="cm">	 * alsa. In case both ports are needed, it should be changed here</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">**</span><span class="n">port_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">siu_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">siu_init_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">port_info</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span>
				<span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">SIU_BUFFER_BYTES_MAX</span><span class="p">,</span> <span class="n">SIU_BUFFER_BYTES_MAX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="s">&quot;snd_pcm_lib_preallocate_pages_for_all() err=%d&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="p">(</span><span class="o">*</span><span class="n">port_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

		<span class="cm">/* IO tasklets */</span>
		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">port_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">siu_io_tasklet</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">port_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">);</span>
		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">port_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">siu_io_tasklet</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">port_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SuperH SIU driver initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">siu_free_port</span><span class="p">(</span><span class="n">siu_ports</span><span class="p">[</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SIU: failed to initialize.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">siu_pcm_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">siu_port</span> <span class="o">*</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">siu_ports</span><span class="p">[</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="n">siu_free_port</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
	<span class="n">snd_pcm_lib_preallocate_free_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">siu_pcm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">siu_pcm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">siu_pcm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">siu_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span>	<span class="o">=</span> <span class="n">siu_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span> <span class="n">siu_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>	<span class="o">=</span> <span class="n">siu_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span>	<span class="o">=</span> <span class="n">siu_pcm_pointer_dma</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snd_soc_platform_driver</span> <span class="n">siu_platform</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">siu_pcm_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_new</span>	<span class="o">=</span> <span class="n">siu_pcm_new</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_free</span>	<span class="o">=</span> <span class="n">siu_pcm_free</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">siu_platform</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
