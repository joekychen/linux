<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › sh › hac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Hitachi Audio Controller (AC97) support for SH7760/SH7780</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2007 Manuel Lauss &lt;mano@roarinelk.homelinux.net&gt;</span>
<span class="cm"> *  licensed under the terms outlined in the file COPYING at the root</span>
<span class="cm"> *  of the linux kernel sources.</span>
<span class="cm"> *</span>
<span class="cm"> * dont forget to set IPSEL/OMSEL register bits (in your board code) to</span>
<span class="cm"> * enable HAC output pins!</span>
<span class="cm"> */</span>

<span class="cm">/* BIG FAT FIXME: although the SH7760 has 2 independent AC97 units, only</span>
<span class="cm"> * the FIRST can be used since ASoC does not pass any information to the</span>
<span class="cm"> * ac97_read/write() functions regarding WHICH unit to use.  You&#39;ll have</span>
<span class="cm"> * to edit the code a bit to use the other AC97 unit.		--mlau</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>

<span class="cm">/* regs and bits */</span>
<span class="cp">#define HACCR		0x08</span>
<span class="cp">#define HACCSAR		0x20</span>
<span class="cp">#define HACCSDR		0x24</span>
<span class="cp">#define HACPCML		0x28</span>
<span class="cp">#define HACPCMR		0x2C</span>
<span class="cp">#define HACTIER		0x50</span>
<span class="cp">#define	HACTSR		0x54</span>
<span class="cp">#define HACRIER		0x58</span>
<span class="cp">#define HACRSR		0x5C</span>
<span class="cp">#define HACACR		0x60</span>

<span class="cp">#define CR_CR		(1 &lt;&lt; 15)	</span><span class="cm">/* &quot;codec-ready&quot; indicator */</span><span class="cp"></span>
<span class="cp">#define CR_CDRT		(1 &lt;&lt; 11)	</span><span class="cm">/* cold reset */</span><span class="cp"></span>
<span class="cp">#define CR_WMRT		(1 &lt;&lt; 10)	</span><span class="cm">/* warm reset */</span><span class="cp"></span>
<span class="cp">#define CR_B9		(1 &lt;&lt; 9)	</span><span class="cm">/* the mysterious &quot;bit 9&quot; */</span><span class="cp"></span>
<span class="cp">#define CR_ST		(1 &lt;&lt; 5)	</span><span class="cm">/* AC97 link start bit */</span><span class="cp"></span>

<span class="cp">#define CSAR_RD		(1 &lt;&lt; 19)	</span><span class="cm">/* AC97 data read bit */</span><span class="cp"></span>
<span class="cp">#define CSAR_WR		(0)</span>

<span class="cp">#define TSR_CMDAMT	(1 &lt;&lt; 31)</span>
<span class="cp">#define TSR_CMDDMT	(1 &lt;&lt; 30)</span>

<span class="cp">#define RSR_STARY	(1 &lt;&lt; 22)</span>
<span class="cp">#define RSR_STDRY	(1 &lt;&lt; 21)</span>

<span class="cp">#define ACR_DMARX16	(1 &lt;&lt; 30)</span>
<span class="cp">#define ACR_DMATX16	(1 &lt;&lt; 29)</span>
<span class="cp">#define ACR_TX12ATOM	(1 &lt;&lt; 26)</span>
<span class="cp">#define ACR_DMARX20	((1 &lt;&lt; 24) | (1 &lt;&lt; 22))</span>
<span class="cp">#define ACR_DMATX20	((1 &lt;&lt; 23) | (1 &lt;&lt; 21))</span>

<span class="cp">#define CSDR_SHIFT	4</span>
<span class="cp">#define CSDR_MASK	(0xffff &lt;&lt; CSDR_SHIFT)</span>
<span class="cp">#define CSAR_SHIFT	12</span>
<span class="cp">#define CSAR_MASK	(0x7f &lt;&lt; CSAR_SHIFT)</span>

<span class="cp">#define AC97_WRITE_RETRY	1</span>
<span class="cp">#define AC97_READ_RETRY		5</span>

<span class="cm">/* manual-suggested AC97 codec access timeouts (us) */</span>
<span class="cp">#define TMO_E1	500	</span><span class="cm">/* 21 &lt; E1 &lt; 1000 */</span><span class="cp"></span>
<span class="cp">#define TMO_E2	13	</span><span class="cm">/* 13 &lt; E2 */</span><span class="cp"></span>
<span class="cp">#define TMO_E3	21	</span><span class="cm">/* 21 &lt; E3 */</span><span class="cp"></span>
<span class="cp">#define TMO_E4	500	</span><span class="cm">/* 21 &lt; E4 &lt; 1000 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">hac_priv</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmio</span><span class="p">;</span>	<span class="cm">/* HAC base address */</span>
<span class="p">}</span> <span class="n">hac_cpu_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_CPU_SUBTYPE_SH7760)</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">mmio</span>	<span class="o">=</span> <span class="mh">0xFE240000</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">mmio</span>	<span class="o">=</span> <span class="mh">0xFE250000</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#elif defined(CONFIG_CPU_SUBTYPE_SH7780)</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">mmio</span>	<span class="o">=</span> <span class="mh">0xFFE40000</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unsupported SuperH SoC&quot;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#define HACREG(reg)	(*(unsigned long *)(hac-&gt;mmio + (reg)))</span>

<span class="cm">/*</span>
<span class="cm"> * AC97 read/write flow as outlined in the SH7760 manual (pages 903-906)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hac_get_codec_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hac_priv</span> <span class="o">*</span><span class="n">hac</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">r</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">to1</span><span class="p">,</span> <span class="n">to2</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">adr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">AC97_READ_RETRY</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* wait for HAC to receive something from the codec */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">to1</span> <span class="o">=</span> <span class="n">TMO_E4</span><span class="p">;</span>
		     <span class="n">to1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">HACREG</span><span class="p">(</span><span class="n">HACRSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RSR_STARY</span><span class="p">);</span>
		     <span class="o">--</span><span class="n">to1</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">to2</span> <span class="o">=</span> <span class="n">TMO_E4</span><span class="p">;</span> 
		     <span class="n">to2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">HACREG</span><span class="p">(</span><span class="n">HACRSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RSR_STDRY</span><span class="p">);</span>
		     <span class="o">--</span><span class="n">to2</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">to2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* codec comm is down */</span>

		<span class="n">adr</span> <span class="o">=</span> <span class="p">((</span><span class="n">HACREG</span><span class="p">(</span><span class="n">HACCSAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSAR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CSAR_SHIFT</span><span class="p">);</span>
		<span class="o">*</span><span class="n">v</span>  <span class="o">=</span> <span class="p">((</span><span class="n">HACREG</span><span class="p">(</span><span class="n">HACCSDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CSDR_SHIFT</span><span class="p">);</span>

		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACRSR</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RSR_STDRY</span> <span class="o">|</span> <span class="n">RSR_STARY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">adr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* manual says: wait at least 21 usec before retrying */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">21</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">HACREG</span><span class="p">(</span><span class="n">HACRSR</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RSR_STDRY</span> <span class="o">|</span> <span class="n">RSR_STARY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">hac_read_codec_aux</span><span class="p">(</span><span class="k">struct</span> <span class="n">hac_priv</span> <span class="o">*</span><span class="n">hac</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">AC97_READ_RETRY</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send_read_request */</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACTSR</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSR_CMDAMT</span><span class="p">);</span>
		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACCSAR</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">CSAR_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">CSAR_RD</span><span class="p">;</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">TMO_E3</span><span class="p">;</span>
		     <span class="n">to</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">HACREG</span><span class="p">(</span><span class="n">HACTSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TSR_CMDAMT</span><span class="p">);</span>
		     <span class="o">--</span><span class="n">to</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACTSR</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSR_CMDAMT</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hac_get_codec_data</span><span class="p">(</span><span class="n">hac</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span> <span class="o">?</span> <span class="n">val</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hac_ac97_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unit_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/* ac97-&gt;private_data */</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hac_priv</span> <span class="o">*</span><span class="n">hac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hac_cpu_data</span><span class="p">[</span><span class="n">unit_id</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>
	<span class="cm">/* write_codec_aux */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">AC97_WRITE_RETRY</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send_write_request */</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACTSR</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSR_CMDDMT</span> <span class="o">|</span> <span class="n">TSR_CMDAMT</span><span class="p">);</span>
		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACCSDR</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">CSDR_SHIFT</span><span class="p">);</span>
		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACCSAR</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">CSAR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">CSAR_RD</span><span class="p">);</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>

		<span class="cm">/* poll-wait for CMDAMT and CMDDMT */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">TMO_E1</span><span class="p">;</span>
		     <span class="n">to</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">HACREG</span><span class="p">(</span><span class="n">HACTSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSR_CMDAMT</span><span class="o">|</span><span class="n">TSR_CMDDMT</span><span class="p">));</span>
		     <span class="o">--</span><span class="n">to</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACTSR</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSR_CMDAMT</span> <span class="o">|</span> <span class="n">TSR_CMDDMT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* timeout, try again */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">hac_ac97_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unit_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/* ac97-&gt;private_data */</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hac_priv</span> <span class="o">*</span><span class="n">hac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hac_cpu_data</span><span class="p">[</span><span class="n">unit_id</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">hac_read_codec_aux</span><span class="p">(</span><span class="n">hac</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hac_ac97_warmrst</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unit_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/* ac97-&gt;private_data */</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hac_priv</span> <span class="o">*</span><span class="n">hac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hac_cpu_data</span><span class="p">[</span><span class="n">unit_id</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmo</span><span class="p">;</span>

	<span class="n">HACREG</span><span class="p">(</span><span class="n">HACCR</span><span class="p">)</span> <span class="o">=</span> <span class="n">CR_WMRT</span> <span class="o">|</span> <span class="n">CR_ST</span> <span class="o">|</span> <span class="n">CR_B9</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">HACREG</span><span class="p">(</span><span class="n">HACCR</span><span class="p">)</span> <span class="o">=</span> <span class="n">CR_ST</span> <span class="o">|</span> <span class="n">CR_B9</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmo</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="p">(</span><span class="n">tmo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">HACREG</span><span class="p">(</span><span class="n">HACCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CR_CR</span><span class="p">);</span> <span class="n">tmo</span><span class="o">--</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmo</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hac: reset: AC97 link down!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* settings this bit lets us have a conversation with codec */</span>
	<span class="n">HACREG</span><span class="p">(</span><span class="n">HACACR</span><span class="p">)</span> <span class="o">|=</span> <span class="n">ACR_TX12ATOM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hac_ac97_coldrst</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unit_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/* ac97-&gt;private_data */</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hac_priv</span> <span class="o">*</span><span class="n">hac</span><span class="p">;</span>
	<span class="n">hac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hac_cpu_data</span><span class="p">[</span><span class="n">unit_id</span><span class="p">];</span>

	<span class="n">HACREG</span><span class="p">(</span><span class="n">HACCR</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">HACREG</span><span class="p">(</span><span class="n">HACCR</span><span class="p">)</span> <span class="o">=</span> <span class="n">CR_CDRT</span> <span class="o">|</span> <span class="n">CR_ST</span> <span class="o">|</span> <span class="n">CR_B9</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">hac_ac97_warmrst</span><span class="p">(</span><span class="n">ac97</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">soc_ac97_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>	<span class="o">=</span> <span class="n">hac_ac97_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">hac_ac97_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>	<span class="o">=</span> <span class="n">hac_ac97_coldrst</span><span class="p">,</span>
	<span class="p">.</span><span class="n">warm_reset</span> <span class="o">=</span> <span class="n">hac_ac97_warmrst</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">soc_ac97_ops</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hac_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hac_priv</span> <span class="o">*</span><span class="n">hac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hac_cpu_data</span><span class="p">[</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">msbits</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACACR</span><span class="p">)</span> <span class="o">|=</span> <span class="n">d</span> <span class="o">?</span>  <span class="n">ACR_DMARX16</span> <span class="o">:</span>  <span class="n">ACR_DMATX16</span><span class="p">;</span>
		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACACR</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="n">d</span> <span class="o">?</span> <span class="o">~</span><span class="n">ACR_DMARX20</span> <span class="o">:</span> <span class="o">~</span><span class="n">ACR_DMATX20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">20</span>:
		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACACR</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="n">d</span> <span class="o">?</span> <span class="o">~</span><span class="n">ACR_DMARX16</span> <span class="o">:</span> <span class="o">~</span><span class="n">ACR_DMATX16</span><span class="p">;</span>
		<span class="n">HACREG</span><span class="p">(</span><span class="n">HACACR</span><span class="p">)</span> <span class="o">|=</span> <span class="n">d</span> <span class="o">?</span>  <span class="n">ACR_DMARX20</span> <span class="o">:</span>  <span class="n">ACR_DMATX20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;hac: invalid depth %d bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">msbits</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AC97_RATES	\</span>
<span class="cp">	SNDRV_PCM_RATE_8000_192000</span>

<span class="cp">#define AC97_FMTS	\</span>
<span class="cp">	SNDRV_PCM_FMTBIT_S16_LE</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">hac_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">hac_hw_params</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">sh4_hac_dai</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;hac-dai.0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ac97_control</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rates</span>		<span class="o">=</span> <span class="n">AC97_RATES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span>	<span class="o">=</span> <span class="n">AC97_FMTS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rates</span>		<span class="o">=</span> <span class="n">AC97_RATES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span>	<span class="o">=</span> <span class="n">AC97_FMTS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hac_dai_ops</span><span class="p">,</span>
<span class="p">},</span>
<span class="cp">#ifdef CONFIG_CPU_SUBTYPE_SH7760</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;hac-dai.1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rates</span>		<span class="o">=</span> <span class="n">AC97_RATES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span>	<span class="o">=</span> <span class="n">AC97_FMTS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rates</span>		<span class="o">=</span> <span class="n">AC97_RATES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">formats</span>	<span class="o">=</span> <span class="n">AC97_FMTS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_min</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channels_max</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hac_dai_ops</span><span class="p">,</span>

<span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hac_soc_platform_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_soc_register_dais</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sh4_hac_dai</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sh4_hac_dai</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">hac_soc_platform_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_unregister_dais</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sh4_hac_dai</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">hac_pcm_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hac-pcm-audio&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">hac_soc_platform_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">hac_soc_platform_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">hac_pcm_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SuperH onchip HAC (AC97) audio driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Manuel Lauss &lt;mano@roarinelk.homelinux.net&gt;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
