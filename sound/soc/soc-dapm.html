<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › soc-dapm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>soc-dapm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * soc-dapm.c  --  ALSA SoC Dynamic Audio Power Management</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005 Wolfson Microelectronics PLC.</span>
<span class="cm"> * Author: Liam Girdwood &lt;lrg@slimlogic.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> *  under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  Features:</span>
<span class="cm"> *    o Changes power status of internal codec blocks depending on the</span>
<span class="cm"> *      dynamic configuration of codec internal audio paths and active</span>
<span class="cm"> *      DACs/ADCs.</span>
<span class="cm"> *    o Platform power domain - can support external components i.e. amps and</span>
<span class="cm"> *      mic/headphone insertion events.</span>
<span class="cm"> *    o Automatic Mic Bias support</span>
<span class="cm"> *    o Jack insertion power event initiation - e.g. hp insertion will enable</span>
<span class="cm"> *      sinks, dacs, etc</span>
<span class="cm"> *    o Delayed power down of audio subsystem to reduce pops between a quick</span>
<span class="cm"> *      device reopen.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/async.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &lt;trace/events/asoc.h&gt;</span>

<span class="cp">#define DAPM_UPDATE_STAT(widget, val) widget-&gt;dapm-&gt;card-&gt;dapm_stats.val++;</span>

<span class="cm">/* dapm power sequences - make this per codec in the future */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dapm_up_seq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_pre</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_supply</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_regulator_supply</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_micbias</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_dai_link</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_dai</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_aif_in</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_aif_out</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_mic</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_mux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_virt_mux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_value_mux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_dac</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_mixer</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_mixer_named_ctl</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_pga</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_adc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_out_drv</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_hp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_spk</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_line</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_post</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dapm_down_seq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_pre</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_adc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_hp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_spk</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_line</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_out_drv</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_pga</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_mixer_named_ctl</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_mixer</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_dac</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_mic</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_micbias</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_mux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_virt_mux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_value_mux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_aif_in</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_aif_out</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_dai</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_dai_link</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_regulator_supply</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_supply</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">[</span><span class="n">snd_soc_dapm_post</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pop_wait</span><span class="p">(</span><span class="n">u32</span> <span class="n">pop_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pop_time</span><span class="p">)</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">pop_time</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pop_dbg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pop_time</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pop_time</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">dapm_dirty_widget</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dapm_mark_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dapm_dirty_widget</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Marking %s dirty due to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_dirty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dapm_mark_dirty</span><span class="p">);</span>

<span class="cm">/* create a new dapm widget */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="nf">dapm_cnew_widget</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">_widget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">_widget</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_widget</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* get snd_card from DAPM context */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="nf">dapm_get_snd_card</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* unreachable */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* get soc_card from DAPM context */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="nf">dapm_get_soc_card</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* unreachable */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_stats</span><span class="p">));</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_checked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">inputs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">outputs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_widget_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_soc_platform_read</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no valid widget read method</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_widget_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_soc_write</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_soc_platform_write</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no valid widget write method</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">soc_widget_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">using_regmap</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">soc_widget_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">using_regmap</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_widget_update_bits_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">using_regmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_update_bits_check</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">control_data</span><span class="p">,</span>
					       <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">change</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">soc_widget_lock</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_widget_read</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">soc_widget_unlock</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">old</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_widget_write</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">soc_widget_unlock</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">soc_widget_unlock</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_set_bias_level - set the bias level for the system</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @level: level to configure</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the bias (power) levels for the SoC audio device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success else error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_dapm_set_bias_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">snd_soc_bias_level</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trace_snd_soc_bias_level_start</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">set_bias_level</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">set_bias_level</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dapm</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_bias_level</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_bias_level</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span>
								  <span class="n">level</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dapm</span><span class="o">-&gt;</span><span class="n">bias_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">set_bias_level_post</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">set_bias_level_post</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dapm</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">trace_snd_soc_bias_level_done</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set up initial codec paths */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_set_path_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_switch</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_mixer</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_mixer_named_ctl</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private_value</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fls</span><span class="p">(</span><span class="n">max</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">soc_widget_read</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">invert</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">invert</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="p">))</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_mux</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private_value</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">soc_widget_read</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">item</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&amp;&amp;</span> <span class="n">item</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_virt_mux</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private_value</span><span class="p">;</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* since a virtual mux has no backing registers to</span>
<span class="cm">		 * decide which path to connect, it will try to match</span>
<span class="cm">		 * with the first enumeration.  This is to ensure</span>
<span class="cm">		 * that the default mux choice (the first) will be</span>
<span class="cm">		 * correctly powered up during initialization.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_value_mux</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">private_value</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">item</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">soc_widget_read</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">item</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">item</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">item</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&amp;&amp;</span> <span class="n">item</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* does not affect routing - always connected */</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_pga</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_out_drv</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_output</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_adc</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_input</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_siggen</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_dac</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_micbias</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_vmid</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_supply</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_regulator_supply</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_aif_in</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_aif_out</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_dai</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_hp</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_mic</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_spk</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_line</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_dai_link</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* does affect routing - dynamically connected */</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_pre</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_post</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* connect mux widget to its interconnecting audio paths */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_connect_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">control_name</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">control_name</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="p">{</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_sink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">);</span>
			<span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">dapm_set_path_status</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* connect mixer widget to its interconnecting audio paths */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_connect_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">control_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* search for mixer kcontrol */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">num_kcontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">control_name</span><span class="p">,</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_sink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">);</span>
			<span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
			<span class="n">dapm_set_path_status</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_is_shared_kcontrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">kcontrolw</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">kcontrol_new</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">**</span><span class="n">kcontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="o">*</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="n">kcontrolw</span> <span class="o">||</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">!=</span> <span class="n">kcontrolw</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">num_kcontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">kcontrol_new</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrols</span><span class="p">)</span>
					<span class="o">*</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrols</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create new dapm mixer control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_new_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">prefix_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">wlistsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span>
		<span class="n">prefix</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prefix</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
		<span class="n">prefix_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prefix_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* add kcontrol */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">num_kcontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* match name */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">,</span> <span class="n">list_sink</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* mixer/mux paths name must match control name */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrols</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">path</span><span class="o">-&gt;</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrols</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">wlistsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span><span class="p">)</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="p">),</span>
			<span class="n">wlist</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">wlistsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wlist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;asoc: can&#39;t allocate widget list for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>

			<span class="cm">/* add dapm control with long name.</span>
<span class="cm">			 * for dapm_mixer this is the concatenation of the</span>
<span class="cm">			 * mixer and kcontrol name.</span>
<span class="cm">			 * for dapm_mixer_named_ctl this is simply the</span>
<span class="cm">			 * kcontrol name.</span>
<span class="cm">			 */</span>
			<span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_mixer_named_ctl</span><span class="p">)</span>
				<span class="n">name_len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="n">path</span><span class="o">-&gt;</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">name_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">long_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">wlist</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="nl">default:</span>
				<span class="cm">/* The control will get a prefix from</span>
<span class="cm">				 * the control creation process but</span>
<span class="cm">				 * we&#39;re also using the same prefix</span>
<span class="cm">				 * for widgets so cut the prefix off</span>
<span class="cm">				 * the front of the widget name.</span>
<span class="cm">				 */</span>
				<span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span>
					 <span class="s">&quot;%s %s&quot;</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">+</span> <span class="n">prefix_len</span><span class="p">,</span>
					 <span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">snd_soc_dapm_mixer_named_ctl</span>:
				<span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span>
					 <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">)[</span><span class="n">name_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

			<span class="n">path</span><span class="o">-&gt;</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="n">snd_soc_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						      <span class="n">wlist</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span>
						      <span class="n">prefix</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;asoc: failed to add dapm kcontrol %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">path</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">wlist</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">);</span>
				<span class="n">path</span><span class="o">-&gt;</span><span class="n">long_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create new dapm mux control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_new_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">prefix_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shared</span><span class="p">,</span> <span class="n">wlistentries</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">wlistsize</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">num_kcontrols</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;asoc: mux %s has incorrect number of controls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">shared</span> <span class="o">=</span> <span class="n">dapm_is_shared_kcontrol</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlist</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">wlistentries</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">wlistentries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wlistsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">wlistentries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="p">),</span>
	<span class="n">wlist</span> <span class="o">=</span> <span class="n">krealloc</span><span class="p">(</span><span class="n">wlist</span><span class="p">,</span> <span class="n">wlistsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;asoc: can&#39;t allocate widget list for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span> <span class="o">=</span> <span class="n">wlistentries</span><span class="p">;</span>
	<span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">wlistentries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kcontrol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span>
			<span class="n">prefix</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">prefix</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shared</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
			<span class="n">prefix_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
				<span class="n">prefix_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">prefix_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The control will get a prefix from the control creation</span>
<span class="cm">		 * process but we&#39;re also using the same prefix for widgets so</span>
<span class="cm">		 * cut the prefix off the front of the widget name.</span>
<span class="cm">		 */</span>
		<span class="n">kcontrol</span> <span class="o">=</span> <span class="n">snd_soc_cnew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wlist</span><span class="p">,</span>
					<span class="n">name</span> <span class="o">+</span> <span class="n">prefix_len</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to add kcontrol %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">wlist</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">wlist</span><span class="p">;</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">,</span> <span class="n">list_sink</span><span class="p">)</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create new dapm volume control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_new_pga</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">num_kcontrols</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;asoc: PGA controls not supported: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* reset &#39;walked&#39; bit for each dapm path */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dapm_clear_walk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">walked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We implement power down on suspend by checking the power state of</span>
<span class="cm"> * the ALSA card - when we are suspending the ALSA state for the card</span>
<span class="cm"> * is set to D3.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_dapm_suspend_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">snd_power_get_state</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_CTL_POWER_D3hot</span>:
	<span class="k">case</span> <span class="n">SNDRV_CTL_POWER_D3cold</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ignoring suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* add widget to list if it&#39;s not already in the list */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_list_add_widget</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wlistsize</span><span class="p">,</span> <span class="n">wlistentries</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wlist</span> <span class="o">=</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>

	<span class="cm">/* is this widget already in the list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate some new space */</span>
	<span class="n">wlistentries</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wlistsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">wlistentries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="p">);</span>
	<span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">krealloc</span><span class="p">(</span><span class="n">wlist</span><span class="p">,</span> <span class="n">wlistsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate widget list for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wlist</span> <span class="o">=</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>

	<span class="cm">/* insert the widget */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;added %s in widget list pos %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="p">);</span>

	<span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Recursively check for a completed path to an active or physically connected</span>
<span class="cm"> * output widget. Returns number of complete paths.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_connected_output_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">con</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">outputs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">;</span>

	<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">path_checks</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_supply</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_regulator_supply</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_adc</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_aif_out</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_dai</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">snd_soc_dapm_suspend_check</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* connected pin ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_output</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">snd_soc_dapm_suspend_check</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* connected jack or spk ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_hp</span> <span class="o">||</span>
		    <span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_spk</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_line</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">snd_soc_dapm_suspend_check</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">,</span> <span class="n">list_source</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">neighbour_checks</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">weak</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">walked</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">trace_snd_soc_dapm_output_path</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span> <span class="o">&amp;&amp;</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">path</span><span class="o">-&gt;</span><span class="n">walked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* do we need to add this widget to the list ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">dapm_list_add_widget</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not add widget %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">con</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">con</span> <span class="o">+=</span> <span class="n">is_connected_output_ep</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">widget</span><span class="o">-&gt;</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">con</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">con</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Recursively check for a completed path to an active or physically connected</span>
<span class="cm"> * input widget. Returns number of complete paths.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_connected_input_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">con</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">;</span>

	<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">path_checks</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_supply</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_regulator_supply</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* active stream ? */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_dac</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_aif_in</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_dai</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">snd_soc_dapm_suspend_check</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* connected pin ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_input</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">snd_soc_dapm_suspend_check</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* connected VMID/Bias for lower pops */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_vmid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">snd_soc_dapm_suspend_check</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* connected jack ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_mic</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_line</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">snd_soc_dapm_suspend_check</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* signal generator */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_siggen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">snd_soc_dapm_suspend_check</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">,</span> <span class="n">list_sink</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">neighbour_checks</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">weak</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">walked</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">trace_snd_soc_dapm_input_path</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">&amp;&amp;</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">path</span><span class="o">-&gt;</span><span class="n">walked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* do we need to add this widget to the list ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">dapm_list_add_widget</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not add widget %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">con</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">con</span> <span class="o">+=</span> <span class="n">is_connected_input_ep</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">widget</span><span class="o">-&gt;</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">con</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">con</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_get_connected_widgets - query audio path and it&#39;s widgets.</span>
<span class="cm"> * @dai: the soc DAI.</span>
<span class="cm"> * @stream: stream direction.</span>
<span class="cm"> * @list: list of active widgets for this stream.</span>
<span class="cm"> *</span>
<span class="cm"> * Queries DAPM graph as to whether an valid audio stream path exists for</span>
<span class="cm"> * the initial stream specified by name. This takes into account</span>
<span class="cm"> * current mixer and mux kcontrol settings. Creates list of valid widgets.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of valid paths or negative error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_dai_get_connected_widgets</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">paths</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="n">dapm_reset</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">paths</span> <span class="o">=</span> <span class="n">is_connected_output_ep</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">paths</span> <span class="o">=</span> <span class="n">is_connected_input_ep</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">trace_snd_soc_dapm_connected</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="n">dapm_clear_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">paths</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handler for generic register modifier widget.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dapm_reg_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SND_SOC_DAPM_EVENT_ON</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">on_val</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">off_val</span><span class="p">;</span>

	<span class="n">soc_widget_update_bits_locked</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
			    <span class="n">w</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">,</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dapm_reg_event</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Handler for regulator supply widget.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dapm_regulator_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SND_SOC_DAPM_EVENT_ON</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">regulator_disable_deferred</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dapm_regulator_event</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_widget_power_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">power_checked</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">new_power</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">force</span><span class="p">)</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">new_power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">new_power</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">power_check</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_checked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">new_power</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Generic check to see if a widget should be powered.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_generic_check_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">power_checks</span><span class="p">);</span>

	<span class="n">in</span> <span class="o">=</span> <span class="n">is_connected_input_ep</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dapm_clear_walk</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
	<span class="n">out</span> <span class="o">=</span> <span class="n">is_connected_output_ep</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dapm_clear_walk</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">out</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">in</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_dai_check_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">power_checks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dapm_generic_check_power</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Check to see if an ADC has power */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_adc_check_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">in</span><span class="p">;</span>

	<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">power_checks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in</span> <span class="o">=</span> <span class="n">is_connected_input_ep</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">dapm_clear_walk</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">in</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">dapm_generic_check_power</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Check to see if a DAC has power */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_dac_check_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">power_checks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span> <span class="o">=</span> <span class="n">is_connected_output_ep</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">dapm_clear_walk</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">out</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">dapm_generic_check_power</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Check to see if a power supply is needed */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_supply_check_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">power_checks</span><span class="p">);</span>

	<span class="cm">/* Check if one of our outputs is connected */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">,</span> <span class="n">list_source</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DAPM_UPDATE_STAT</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">neighbour_checks</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">weak</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dapm_widget_power_check</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dapm_clear_walk</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_always_on_check_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_seq_compare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">power_up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">sort</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_up</span><span class="p">)</span>
		<span class="n">sort</span> <span class="o">=</span> <span class="n">dapm_up_seq</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sort</span> <span class="o">=</span> <span class="n">dapm_down_seq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sort</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sort</span><span class="p">[</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">sort</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">-</span> <span class="n">sort</span><span class="p">[</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">subseq</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">subseq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power_up</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">subseq</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">subseq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">subseq</span> <span class="o">-</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">subseq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Insert a widget in order into a DAPM power sequence. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_seq_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">new_widget</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">power_up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">power_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dapm_seq_compare</span><span class="p">(</span><span class="n">new_widget</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">power_up</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_widget</span><span class="o">-&gt;</span><span class="n">power_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">power_list</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_widget</span><span class="o">-&gt;</span><span class="n">power_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_seq_check_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ev_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">power</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="n">ev_name</span> <span class="o">=</span> <span class="s">&quot;PRE_PMU&quot;</span><span class="p">;</span>
		<span class="n">power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMU</span>:
		<span class="n">ev_name</span> <span class="o">=</span> <span class="s">&quot;POST_PMU&quot;</span><span class="p">;</span>
		<span class="n">power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span>:
		<span class="n">ev_name</span> <span class="o">=</span> <span class="s">&quot;PRE_PMD&quot;</span><span class="p">;</span>
		<span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMD</span>:
		<span class="n">ev_name</span> <span class="o">=</span> <span class="s">&quot;POST_PMD&quot;</span><span class="p">;</span>
		<span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">!=</span> <span class="n">power</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">event_flags</span> <span class="o">&amp;</span> <span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pop_dbg</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pop_time</span><span class="p">,</span> <span class="s">&quot;pop test : %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev_name</span><span class="p">);</span>
		<span class="n">trace_snd_soc_dapm_widget_event_start</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">trace_snd_soc_dapm_widget_event_done</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s event failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ev_name</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Apply the coalesced changes from a DAPM sequence */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_seq_run_coalesced</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">power</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_mask</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span><span class="p">,</span>
			       <span class="n">power_list</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">pending</span><span class="p">,</span> <span class="n">power_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">power</span> <span class="o">=</span> <span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">power</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">;</span>

		<span class="n">mask</span> <span class="o">|=</span> <span class="n">cur_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="n">cur_mask</span><span class="p">;</span>

		<span class="n">pop_dbg</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pop_time</span><span class="p">,</span>
			<span class="s">&quot;pop test : Queue %s: reg=0x%x, 0x%x/0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

		<span class="cm">/* Check for events */</span>
		<span class="n">dapm_seq_check_event</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">);</span>
		<span class="n">dapm_seq_check_event</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Any widget will do, they should all be updating the</span>
<span class="cm">		 * same register.</span>
<span class="cm">		 */</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span><span class="p">,</span>
				     <span class="n">power_list</span><span class="p">);</span>

		<span class="n">pop_dbg</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pop_time</span><span class="p">,</span>
			<span class="s">&quot;pop test : Applying 0x%x/0x%x to %x in %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pop_time</span><span class="p">);</span>
		<span class="n">pop_wait</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pop_time</span><span class="p">);</span>
		<span class="n">soc_widget_update_bits_locked</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">pending</span><span class="p">,</span> <span class="n">power_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dapm_seq_check_event</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMU</span><span class="p">);</span>
		<span class="n">dapm_seq_check_event</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Apply a DAPM power sequence.</span>
<span class="cm"> *</span>
<span class="cm"> * We walk over a pre-sorted list of widgets to apply power to.  In</span>
<span class="cm"> * order to minimise the number of writes to the device required</span>
<span class="cm"> * multiple widgets will be updated in a single write where possible.</span>
<span class="cm"> * Currently anything that requires more than a single write is not</span>
<span class="cm"> * handled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_seq_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="n">bool</span> <span class="n">power_up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">pending</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cur_sort</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_subseq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_reg</span> <span class="o">=</span> <span class="n">SND_SOC_NOPM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">cur_dapm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">sort</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_up</span><span class="p">)</span>
		<span class="n">sort</span> <span class="o">=</span> <span class="n">dapm_up_seq</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sort</span> <span class="o">=</span> <span class="n">dapm_down_seq</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">power_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Do we need to apply any queued changes? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sort</span><span class="p">[</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cur_sort</span> <span class="o">||</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">cur_reg</span> <span class="o">||</span>
		    <span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">!=</span> <span class="n">cur_dapm</span> <span class="o">||</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">subseq</span> <span class="o">!=</span> <span class="n">cur_subseq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending</span><span class="p">))</span>
				<span class="n">dapm_seq_run_coalesced</span><span class="p">(</span><span class="n">cur_dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cur_dapm</span> <span class="o">&amp;&amp;</span> <span class="n">cur_dapm</span><span class="o">-&gt;</span><span class="n">seq_notifier</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dapm_up_seq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">sort</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_sort</span><span class="p">)</span>
						<span class="n">cur_dapm</span><span class="o">-&gt;</span><span class="n">seq_notifier</span><span class="p">(</span><span class="n">cur_dapm</span><span class="p">,</span>
								       <span class="n">i</span><span class="p">,</span>
								       <span class="n">cur_subseq</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending</span><span class="p">);</span>
			<span class="n">cur_sort</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">cur_subseq</span> <span class="o">=</span> <span class="n">INT_MIN</span><span class="p">;</span>
			<span class="n">cur_reg</span> <span class="o">=</span> <span class="n">SND_SOC_NOPM</span><span class="p">;</span>
			<span class="n">cur_dapm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">snd_soc_dapm_pre</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span>
				<span class="n">list_for_each_entry_safe_continue</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span>
								  <span class="n">power_list</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">SND_SOC_DAPM_STREAM_START</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">w</span><span class="p">,</span>
					       <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">SND_SOC_DAPM_STREAM_STOP</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">w</span><span class="p">,</span>
					       <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">snd_soc_dapm_post</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span>
				<span class="n">list_for_each_entry_safe_continue</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span>
								  <span class="n">power_list</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">SND_SOC_DAPM_STREAM_START</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">w</span><span class="p">,</span>
					       <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMU</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">SND_SOC_DAPM_STREAM_STOP</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">w</span><span class="p">,</span>
					       <span class="nb">NULL</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_PMD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* Queue it up for application */</span>
			<span class="n">cur_sort</span> <span class="o">=</span> <span class="n">sort</span><span class="p">[</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
			<span class="n">cur_subseq</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">subseq</span><span class="p">;</span>
			<span class="n">cur_reg</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
			<span class="n">cur_dapm</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">power_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to apply widget power: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending</span><span class="p">))</span>
		<span class="n">dapm_seq_run_coalesced</span><span class="p">(</span><span class="n">cur_dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_dapm</span> <span class="o">&amp;&amp;</span> <span class="n">cur_dapm</span><span class="o">-&gt;</span><span class="n">seq_notifier</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dapm_up_seq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sort</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_sort</span><span class="p">)</span>
				<span class="n">cur_dapm</span><span class="o">-&gt;</span><span class="n">seq_notifier</span><span class="p">(</span><span class="n">cur_dapm</span><span class="p">,</span>
						       <span class="n">i</span><span class="p">,</span> <span class="n">cur_subseq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_widget_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_update</span> <span class="o">*</span><span class="n">update</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">update</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">update</span><span class="o">-&gt;</span><span class="n">widget</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">event_flags</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAPM_PRE_REG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">update</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_PRE_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s DAPM pre-event failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_widget_update_bits_locked</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">update</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">update</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span>
				  <span class="n">update</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s DAPM update failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">event_flags</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAPM_POST_REG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">update</span><span class="o">-&gt;</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_POST_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s DAPM post-event failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Async callback run prior to DAPM sequences - brings to _PREPARE if</span>
<span class="cm"> * they&#39;re changing state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_pre_sequence_async</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">async_cookie_t</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* If we&#39;re off and we&#39;re not supposed to be go into STANDBY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_OFF</span> <span class="o">&amp;&amp;</span>
	    <span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">!=</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_set_bias_level</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to turn on bias: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Prepare for a STADDBY-&gt;ON or ON-&gt;STANDBY transition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bias_level</span> <span class="o">!=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_set_bias_level</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_PREPARE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to prepare bias: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Async callback run prior to DAPM sequences - brings to their final</span>
<span class="cm"> * state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_post_sequence_async</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">async_cookie_t</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* If we just powered the last thing off drop to standby bias */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_PREPARE</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_STANDBY</span> <span class="o">||</span>
	     <span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_set_bias_level</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to apply standby bias: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If we&#39;re in standby and can support bias off then do that */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_STANDBY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_set_bias_level</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to turn off bias: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If we just powered up then move to active bias */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_PREPARE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_set_bias_level</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">SND_SOC_BIAS_ON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to apply active bias: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_widget_set_peer_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span>
				       <span class="n">bool</span> <span class="n">power</span><span class="p">,</span> <span class="n">bool</span> <span class="n">connect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If a connection is being made or broken then that update</span>
<span class="cm">	 * will have marked the peer dirty, otherwise the widgets are</span>
<span class="cm">	 * not connected and this update has no impact. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connect</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* If the peer is already in the state we&#39;re moving to then we</span>
<span class="cm">	 * won&#39;t have an impact on it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">power</span> <span class="o">!=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">)</span>
		<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="s">&quot;peer state change&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_widget_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">bool</span> <span class="n">power</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">up_list</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">down_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">==</span> <span class="n">power</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">trace_snd_soc_dapm_widget_power</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>

	<span class="cm">/* If we changed our power state perhaps our neigbours changed</span>
<span class="cm">	 * also.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">,</span> <span class="n">list_sink</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dapm_widget_set_peer_power</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span>
						   <span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_supply</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_regulator_supply</span>:
		<span class="cm">/* Supplies can&#39;t affect their outputs, only their inputs */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">,</span> <span class="n">list_source</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dapm_widget_set_peer_power</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span>
							   <span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="p">)</span>
		<span class="n">dapm_seq_insert</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">up_list</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dapm_seq_insert</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">down_list</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="n">power</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_power_one_widget</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">up_list</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">down_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">power</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_pre</span>:
		<span class="n">dapm_seq_insert</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">down_list</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_post</span>:
		<span class="n">dapm_seq_insert</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">up_list</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">power</span> <span class="o">=</span> <span class="n">dapm_widget_power_check</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>

		<span class="n">dapm_widget_set_power</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">up_list</span><span class="p">,</span> <span class="n">down_list</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Scan each dapm widget for complete audio path.</span>
<span class="cm"> * A complete path is a route that has valid endpoints i.e.:-</span>
<span class="cm"> *</span>
<span class="cm"> *  o DAC to output pin.</span>
<span class="cm"> *  o Input Pin to ADC.</span>
<span class="cm"> *  o Input pin to Output pin (bypass, sidetone)</span>
<span class="cm"> *  o DAC to ADC (loopback).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dapm_power_widgets</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">up_list</span><span class="p">);</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">down_list</span><span class="p">);</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">async_domain</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">snd_soc_bias_level</span> <span class="n">bias</span><span class="p">;</span>

	<span class="n">trace_snd_soc_dapm_start</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">idle_bias_off</span><span class="p">)</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">=</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">=</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dapm_reset</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Check which widgets we need to power and store them in</span>
<span class="cm">	 * lists indicating if they should be powered up or down.  We</span>
<span class="cm">	 * only check widgets that have been flagged as dirty but note</span>
<span class="cm">	 * that new widgets may be added to the dirty list while we</span>
<span class="cm">	 * iterate.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_dirty</span><span class="p">,</span> <span class="n">dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dapm_power_one_widget</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">down_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>

			<span class="cm">/* Supplies and micbiases only bring the</span>
<span class="cm">			 * context up to STANDBY as unless something</span>
<span class="cm">			 * else is active and passing audio they</span>
<span class="cm">			 * generally don&#39;t require full power.  Signal</span>
<span class="cm">			 * generators are virtual pins and have no</span>
<span class="cm">			 * power impact themselves.</span>
<span class="cm">			 */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">snd_soc_dapm_siggen</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">snd_soc_dapm_supply</span>:
			<span class="k">case</span> <span class="n">snd_soc_dapm_regulator_supply</span>:
			<span class="k">case</span> <span class="n">snd_soc_dapm_micbias</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">&lt;</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">)</span>
					<span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">=</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">=</span> <span class="n">SND_SOC_BIAS_ON</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* Force all contexts in the card to the same bias state if</span>
<span class="cm">	 * they&#39;re not ground referenced.</span>
<span class="cm">	 */</span>
	<span class="n">bias</span> <span class="o">=</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">&gt;</span> <span class="n">bias</span><span class="p">)</span>
			<span class="n">bias</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">idle_bias_off</span><span class="p">)</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">target_bias_level</span> <span class="o">=</span> <span class="n">bias</span><span class="p">;</span>

	<span class="n">trace_snd_soc_dapm_walk_done</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Run all the bias changes in parallel */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">async_schedule_domain</span><span class="p">(</span><span class="n">dapm_pre_sequence_async</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">async_domain</span><span class="p">);</span>
	<span class="n">async_synchronize_full_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async_domain</span><span class="p">);</span>

	<span class="cm">/* Power down widgets first; try to avoid amplifying pops. */</span>
	<span class="n">dapm_seq_run</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">down_list</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">dapm_widget_update</span><span class="p">(</span><span class="n">dapm</span><span class="p">);</span>

	<span class="cm">/* Now power up. */</span>
	<span class="n">dapm_seq_run</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up_list</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Run all the bias changes in parallel */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">async_schedule_domain</span><span class="p">(</span><span class="n">dapm_post_sequence_async</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">async_domain</span><span class="p">);</span>
	<span class="n">async_synchronize_full_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async_domain</span><span class="p">);</span>

	<span class="cm">/* do we need to notify any clients that DAPM event is complete */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">stream_event</span><span class="p">)</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">stream_event</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pop_dbg</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pop_time</span><span class="p">,</span>
		<span class="s">&quot;DAPM sequencing finished, waiting %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pop_time</span><span class="p">);</span>
	<span class="n">pop_wait</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pop_time</span><span class="p">);</span>

	<span class="n">trace_snd_soc_dapm_done</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dapm_widget_power_read_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
					   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">in</span> <span class="o">=</span> <span class="n">is_connected_input_ep</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dapm_clear_walk</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
	<span class="n">out</span> <span class="o">=</span> <span class="n">is_connected_output_ep</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dapm_clear_walk</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s: %s%s  in %d out %d&quot;</span><span class="p">,</span>
		       <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">?</span> <span class="s">&quot;On&quot;</span> <span class="o">:</span> <span class="s">&quot;Off&quot;</span><span class="p">,</span>
		       <span class="n">w</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">?</span> <span class="s">&quot; (forced)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span>
				<span class="s">&quot; - R%d(0x%x) bit %d&quot;</span><span class="p">,</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sname</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span> <span class="s">&quot; stream %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">sname</span><span class="p">,</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">?</span> <span class="s">&quot;active&quot;</span> <span class="o">:</span> <span class="s">&quot;inactive&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">,</span> <span class="n">list_sink</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span>
					<span class="s">&quot; in  </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;static&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">,</span> <span class="n">list_source</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span>
					<span class="s">&quot; out </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;static&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dapm_widget_power_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dapm_widget_power_read_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dapm_bias_read_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">level</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">bias_level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_ON</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="s">&quot;On</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_PREPARE</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="s">&quot;Prepare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_STANDBY</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="s">&quot;Standby</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_OFF</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="s">&quot;Off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="n">level</span> <span class="o">=</span> <span class="s">&quot;Unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
				       <span class="n">strlen</span><span class="p">(</span><span class="n">level</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dapm_bias_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dapm_bias_read_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">snd_soc_dapm_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">dapm</span><span class="o">-&gt;</span><span class="n">debugfs_dapm</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;dapm&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">debugfs_dapm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		       <span class="s">&quot;Failed to create DAPM debugfs directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;bias_level&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
				<span class="n">dapm</span><span class="o">-&gt;</span><span class="n">debugfs_dapm</span><span class="p">,</span> <span class="n">dapm</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dapm_bias_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;ASoC: Failed to create bias level debugfs file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_debugfs_add_widget</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">debugfs_dapm</span> <span class="o">||</span> <span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
				<span class="n">dapm</span><span class="o">-&gt;</span><span class="n">debugfs_dapm</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dapm_widget_power_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;ASoC: Failed to create %s debugfs file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_debugfs_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">debugfs_dapm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="kt">void</span> <span class="nf">snd_soc_dapm_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dapm_debugfs_add_widget</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dapm_debugfs_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* test and update the power status of a mux widget */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_dapm_mux_update_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mux</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_mux</span> <span class="o">&amp;&amp;</span>
	    <span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_virt_mux</span> <span class="o">&amp;&amp;</span>
	    <span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_value_mux</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* find dapm widget path assoc with kcontrol */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">kcontrol</span> <span class="o">!=</span> <span class="n">kcontrol</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">||</span> <span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="n">mux</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* we now need to match the string in the enum to the path */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="n">mux</span><span class="p">])))</span> <span class="p">{</span>
			<span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* new connection */</span>
			<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="s">&quot;mux connection&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">)</span>
				<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span>
						<span class="s">&quot;mux disconnection&quot;</span><span class="p">);</span>
			<span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* old connection must be powered down */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="s">&quot;mux change&quot;</span><span class="p">);</span>
		<span class="n">dapm_power_widgets</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_STREAM_NOP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_soc_dapm_mux_update_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mux</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_dapm_mux_update_power</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">soc_dpcm_runtime_update</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_mux_update_power</span><span class="p">);</span>

<span class="cm">/* test and update the power status of a mixer or switch widget */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_dapm_mixer_update_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">connect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_mixer</span> <span class="o">&amp;&amp;</span>
	    <span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_mixer_named_ctl</span> <span class="o">&amp;&amp;</span>
	    <span class="n">widget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_switch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* find dapm widget path assoc with kcontrol */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">kcontrol</span> <span class="o">!=</span> <span class="n">kcontrol</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* found, now check type */</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="n">connect</span><span class="p">;</span>
		<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="s">&quot;mixer connection&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="s">&quot;mixer update&quot;</span><span class="p">);</span>
		<span class="n">dapm_power_widgets</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_STREAM_NOP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_soc_dapm_mixer_update_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">connect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_dapm_mixer_update_power</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">connect</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">soc_dpcm_runtime_update</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_mixer_update_power</span><span class="p">);</span>

<span class="cm">/* show dapm widget status in sys fs */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dapm_widget_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="s">&quot;not set&quot;</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* only display widgets that burnm power */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">snd_soc_dapm_hp</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_mic</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_spk</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_line</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_micbias</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_dac</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_adc</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_pga</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_out_drv</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_mixer</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_mixer_named_ctl</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_supply</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_regulator_supply</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">?</span> <span class="s">&quot;On&quot;</span><span class="o">:</span><span class="s">&quot;Off&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_ON</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;On&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_PREPARE</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;Prepare&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_STANDBY</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;Standby&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_BIAS_OFF</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;Off&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;PM State: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dapm_widget</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dapm_widget_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">snd_soc_dapm_sys_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dapm_widget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_soc_dapm_sys_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dapm_widget</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* free all dapm widgets and resources */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dapm_free_widgets</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="o">*</span><span class="n">next_w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">next_p</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">next_w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">!=</span> <span class="n">dapm</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * remove source and sink paths associated to this widget.</span>
<span class="cm">		 * While removing the path, remove reference to it from both</span>
<span class="cm">		 * source and sink widgets so that path is removed only once.</span>
<span class="cm">		 */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">,</span> <span class="n">list_sink</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list_sink</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list_source</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">,</span> <span class="n">list_source</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list_sink</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list_source</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">long_name</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrols</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="nf">dapm_find_widget</span><span class="p">(</span>
			<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span><span class="p">,</span>
			<span class="n">bool</span> <span class="n">search_other_contexts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">fallback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pin</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">==</span> <span class="n">dapm</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">w</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fallback</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">search_other_contexts</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fallback</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_dapm_set_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">dapm_find_widget</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dapm: unknown pin %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)</span>
		<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">&quot;pin configuration&quot;</span><span class="p">);</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_sync - scan and power dapm paths</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> *</span>
<span class="cm"> * Walks all dapm audio paths and powers widgets according to their</span>
<span class="cm"> * stream or path usage.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Suppress early reports (eg, jacks syncing their state) to avoid</span>
<span class="cm">	 * silly DAPM runs during card startup.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">||</span> <span class="o">!</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">instantiated</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dapm_power_widgets</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_STREAM_NOP</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_sync</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_dapm_add_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="o">*</span><span class="n">route</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">wsource</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">wsink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">wtsource</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">wtsink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">source</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">prefixed_sink</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">prefixed_source</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">prefixed_sink</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prefixed_sink</span><span class="p">),</span> <span class="s">&quot;%s %s&quot;</span><span class="p">,</span>
			 <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">,</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">);</span>
		<span class="n">sink</span> <span class="o">=</span> <span class="n">prefixed_sink</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">prefixed_source</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prefixed_source</span><span class="p">),</span> <span class="s">&quot;%s %s&quot;</span><span class="p">,</span>
			 <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">,</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
		<span class="n">source</span> <span class="o">=</span> <span class="n">prefixed_source</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sink</span> <span class="o">=</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">;</span>
		<span class="n">source</span> <span class="o">=</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * find src and dest widgets over all widgets but favor a widget from</span>
<span class="cm">	 * current DAPM context</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wsink</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sink</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">wtsink</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">==</span> <span class="n">dapm</span><span class="p">)</span>
				<span class="n">wsink</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wsource</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">wtsource</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">==</span> <span class="n">dapm</span><span class="p">)</span>
				<span class="n">wsource</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* use widget from another DAPM context if not found from this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wsink</span><span class="p">)</span>
		<span class="n">wsink</span> <span class="o">=</span> <span class="n">wtsink</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wsource</span><span class="p">)</span>
		<span class="n">wsource</span> <span class="o">=</span> <span class="n">wtsource</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wsource</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">wsink</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_path</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">path</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">wsource</span><span class="p">;</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span> <span class="o">=</span> <span class="n">wsink</span><span class="p">;</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_source</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_sink</span><span class="p">);</span>

	<span class="cm">/* check for external widgets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wsink</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wsource</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_micbias</span> <span class="o">||</span>
			<span class="n">wsource</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_mic</span> <span class="o">||</span>
			<span class="n">wsource</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_line</span> <span class="o">||</span>
			<span class="n">wsource</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_output</span><span class="p">)</span>
			<span class="n">wsink</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wsource</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wsink</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_spk</span> <span class="o">||</span>
			<span class="n">wsink</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_hp</span> <span class="o">||</span>
			<span class="n">wsink</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_line</span> <span class="o">||</span>
			<span class="n">wsink</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_input</span><span class="p">)</span>
			<span class="n">wsource</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* connect static paths */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_sink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsink</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsource</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">);</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* connect dynamic paths */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wsink</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_adc</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_dac</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_pga</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_out_drv</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_input</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_output</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_siggen</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_micbias</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_vmid</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_pre</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_post</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_supply</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_regulator_supply</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_aif_in</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_aif_out</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_dai</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_dai_link</span>:
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_sink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsink</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsource</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">);</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_mux</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_virt_mux</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_value_mux</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dapm_connect_mux</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wsource</span><span class="p">,</span> <span class="n">wsink</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">wsink</span><span class="o">-&gt;</span><span class="n">kcontrol_news</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_switch</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_mixer</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_mixer_named_ctl</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dapm_connect_mixer</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">wsource</span><span class="p">,</span> <span class="n">wsink</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_hp</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_mic</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_line</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_spk</span>:
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_sink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsink</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">list_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsource</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">);</span>
		<span class="n">path</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;asoc: no dapm match for %s --&gt; %s --&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">source</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">sink</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_add_routes - Add routes between DAPM widgets</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @route: audio routes</span>
<span class="cm"> * @num: number of routes</span>
<span class="cm"> *</span>
<span class="cm"> * Connects 2 dapm widgets together via a named audio path. The sink is</span>
<span class="cm"> * the widget receiving the audio signal, whilst the source is the sender</span>
<span class="cm"> * of the audio signal.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success else error. On error all resources can be freed</span>
<span class="cm"> * with a call to snd_soc_card_free().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="o">*</span><span class="n">route</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_INIT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_add_route</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">route</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to add route %s-&gt;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">route</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">route</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_add_routes</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_dapm_weak_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="o">*</span><span class="n">route</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="n">dapm_find_widget</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span>
							      <span class="n">route</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span>
							      <span class="nb">true</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">sink</span> <span class="o">=</span> <span class="n">dapm_find_widget</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span>
							    <span class="n">route</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">,</span>
							    <span class="nb">true</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to find source %s for weak route</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">route</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to find sink %s for weak route</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">route</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">route</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">||</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ignoring control for weak route %s-&gt;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">route</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">,</span> <span class="n">list_source</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">sink</span> <span class="o">==</span> <span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">path</span><span class="o">-&gt;</span><span class="n">weak</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No path found for weak route %s-&gt;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">route</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d paths found for weak route %s-&gt;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">count</span><span class="p">,</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">route</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_weak_routes - Mark routes between DAPM widgets as weak</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @route: audio routes</span>
<span class="cm"> * @num: number of routes</span>
<span class="cm"> *</span>
<span class="cm"> * Mark existing routes matching those specified in the passed array</span>
<span class="cm"> * as being weak, meaning that they are ignored for the purpose of</span>
<span class="cm"> * power decisions.  The main intended use case is for sidetone paths</span>
<span class="cm"> * which couple audio between other independent paths if they are both</span>
<span class="cm"> * active in order to make the combination work better at the user</span>
<span class="cm"> * level but which aren&#39;t intended to be &quot;used&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that CODEC drivers should not use this as sidetone type paths</span>
<span class="cm"> * can frequently also be used as bypass paths.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_weak_routes</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="o">*</span><span class="n">route</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_INIT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_soc_dapm_weak_route</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">route</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">route</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_weak_routes</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_new_widgets - add new dapm widgets</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> *</span>
<span class="cm"> * Checks the codec for any new dapm widgets and creates them if found.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_new_widgets</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_INIT</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">num_kcontrols</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrols</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">num_kcontrols</span> <span class="o">*</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="p">),</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">kcontrols</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">snd_soc_dapm_switch</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_mixer</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_mixer_named_ctl</span>:
			<span class="n">dapm_new_mixer</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">snd_soc_dapm_mux</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_virt_mux</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_value_mux</span>:
			<span class="n">dapm_new_mux</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">snd_soc_dapm_pga</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_out_drv</span>:
			<span class="n">dapm_new_pga</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read the initial power state from the device */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">soc_widget_read</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="o">!</span><span class="n">val</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">w</span><span class="o">-&gt;</span><span class="n">new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">&quot;new widget&quot;</span><span class="p">);</span>
		<span class="n">dapm_debugfs_add_widget</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dapm_power_widgets</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_STREAM_NOP</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_new_widgets</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_get_volsw - dapm mixer get callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to get the value of a dapm mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_get_volsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fls</span><span class="p">(</span><span class="n">max</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="n">rshift</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">rshift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">max</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="n">rshift</span><span class="p">)</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">max</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_get_volsw</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_put_volsw - dapm mixer set callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to set the value of a dapm mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_put_volsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fls</span><span class="p">(</span><span class="n">max</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connect</span><span class="p">,</span> <span class="n">change</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_update</span> <span class="n">update</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wi</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="cm">/* new connection */</span>
		<span class="n">connect</span> <span class="o">=</span> <span class="n">invert</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* old connection must be powered down */</span>
		<span class="n">connect</span> <span class="o">=</span> <span class="n">invert</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>

	<span class="n">change</span> <span class="o">=</span> <span class="n">snd_soc_test_bits</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">wi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">wi</span> <span class="o">&lt;</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="p">;</span> <span class="n">wi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">wi</span><span class="p">];</span>

			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">update</span><span class="p">.</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">widget</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">update</span><span class="p">;</span>

			<span class="n">soc_dapm_mixer_update_power</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">connect</span><span class="p">);</span>

			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_put_volsw</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_get_enum_double - dapm enumerated double mixer get callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to get the value of a dapm enumerated double mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_get_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_get_enum_double</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_put_enum_double - dapm enumerated double mixer set callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to set the value of a dapm enumerated double mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_put_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_update</span> <span class="n">update</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wi</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mux</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">mux</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>

	<span class="n">change</span> <span class="o">=</span> <span class="n">snd_soc_test_bits</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">wi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">wi</span> <span class="o">&lt;</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="p">;</span> <span class="n">wi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">wi</span><span class="p">];</span>

			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">update</span><span class="p">.</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">widget</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">update</span><span class="p">;</span>

			<span class="n">soc_dapm_mux_update_power</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_put_enum_double</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_get_enum_virt - Get virtual DAPM mux</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_get_enum_virt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_get_enum_virt</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_put_enum_virt - Set virtual DAPM mux</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_put_enum_virt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>

	<span class="n">change</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">wi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">wi</span> <span class="o">&lt;</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="p">;</span> <span class="n">wi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">wi</span><span class="p">];</span>

			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="n">soc_dapm_mux_update_power</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_put_enum_virt</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_get_value_enum_double - dapm semi enumerated double mixer get</span>
<span class="cm"> *					callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to get the value of a dapm semi enumerated double mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Semi enumerated mixer: the enumerated items are referred as values. Can be</span>
<span class="cm"> * used for handling bitfield coded enumeration for example.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_get_value_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mux</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mux</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">mux</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">mux</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mux</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mux</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">mux</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">mux</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mux</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_get_value_enum_double</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_put_value_enum_double - dapm semi enumerated double mixer set</span>
<span class="cm"> *					callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to set the value of a dapm semi enumerated double mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Semi enumerated mixer: the enumerated items are referred as values. Can be</span>
<span class="cm"> * used for handling bitfield coded enumeration for example.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_put_value_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget_list</span> <span class="o">*</span><span class="n">wlist</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_update</span> <span class="n">update</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mux</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>

	<span class="n">change</span> <span class="o">=</span> <span class="n">snd_soc_test_bits</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">wi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">wi</span> <span class="o">&lt;</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">num_widgets</span><span class="p">;</span> <span class="n">wi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">widget</span> <span class="o">=</span> <span class="n">wlist</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">[</span><span class="n">wi</span><span class="p">];</span>

			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">update</span><span class="p">.</span><span class="n">kcontrol</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">widget</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="n">update</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">update</span><span class="p">;</span>

			<span class="n">soc_dapm_mux_update_power</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

			<span class="n">widget</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_put_value_enum_double</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_info_pin_switch - Info for a pin switch</span>
<span class="cm"> *</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @uinfo: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to provide information about a pin switch control.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_info_pin_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_info_pin_switch</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_get_pin_switch - Get information for a pin switch</span>
<span class="cm"> *</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: Value</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_get_pin_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_get_pin_switch</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_put_pin_switch - Set information for a pin switch</span>
<span class="cm"> *</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: Value</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_put_pin_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>

	<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_put_pin_switch</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span>
<span class="nf">snd_soc_dapm_new_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">w</span> <span class="o">=</span> <span class="n">dapm_cnew_widget</span><span class="p">(</span><span class="n">widget</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_regulator_supply</span>:
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">regulator</span> <span class="o">=</span> <span class="n">devm_regulator_get</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to request %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">)</span>
		<span class="n">name_len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">);</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">name_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span> <span class="s">&quot;%s %s&quot;</span><span class="p">,</span>
			<span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">,</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_switch</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_mixer</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_mixer_named_ctl</span>:
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_check</span> <span class="o">=</span> <span class="n">dapm_generic_check_power</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_mux</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_virt_mux</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_value_mux</span>:
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_check</span> <span class="o">=</span> <span class="n">dapm_generic_check_power</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_adc</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_aif_out</span>:
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_check</span> <span class="o">=</span> <span class="n">dapm_adc_check_power</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_dac</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_aif_in</span>:
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_check</span> <span class="o">=</span> <span class="n">dapm_dac_check_power</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_pga</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_out_drv</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_input</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_output</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_micbias</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_spk</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_hp</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_mic</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_line</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_dai_link</span>:
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_check</span> <span class="o">=</span> <span class="n">dapm_generic_check_power</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_supply</span>:
	<span class="k">case</span> <span class="n">snd_soc_dapm_regulator_supply</span>:
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_check</span> <span class="o">=</span> <span class="n">dapm_supply_check_power</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">snd_soc_dapm_dai</span>:
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_check</span> <span class="o">=</span> <span class="n">dapm_dai_check_power</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">power_check</span> <span class="o">=</span> <span class="n">dapm_always_on_check_power</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dapm</span><span class="o">-&gt;</span><span class="n">n_widgets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">=</span> <span class="n">dapm</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">platform</span> <span class="o">=</span> <span class="n">dapm</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">);</span>

	<span class="cm">/* machine layer set ups unconnected pins and insertions */</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">w</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_new_controls - create new dapm controls</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @widget: widget array</span>
<span class="cm"> * @num: number of widgets</span>
<span class="cm"> *</span>
<span class="cm"> * Creates new DAPM controls based upon the templates.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success else error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_INIT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_control</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">widget</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;ASoC: Failed to create DAPM control %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">widget</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_new_controls</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_dai_link_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">source_p</span><span class="p">,</span> <span class="o">*</span><span class="n">sink_p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_pcm_stream</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">)</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">));</span>

	<span class="cm">/* We only support a single source and sink, pick the first */</span>
	<span class="n">source_p</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_path</span><span class="p">,</span>
				    <span class="n">list_sink</span><span class="p">);</span>
	<span class="n">sink_p</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_dapm_path</span><span class="p">,</span>
				  <span class="n">list_source</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">source_p</span> <span class="o">||</span> <span class="o">!</span><span class="n">sink_p</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sink_p</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">||</span> <span class="o">!</span><span class="n">source_p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">source_p</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">||</span> <span class="o">!</span><span class="n">sink_p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="p">);</span>

	<span class="n">source</span> <span class="o">=</span> <span class="n">source_p</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">sink</span> <span class="o">=</span> <span class="n">sink_p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Be a little careful as we don&#39;t want to overflow the mask array */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid format %llx specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">config</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">);</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Currently very limited parameter selection */</span>
	<span class="n">params</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_mask_set</span><span class="p">(</span><span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_FORMAT</span><span class="p">),</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rate_min</span><span class="p">;</span>
	<span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rate_max</span><span class="p">;</span>

	<span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">min</span>
		<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">channels_min</span><span class="p">;</span>
	<span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">max</span>
		<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">channels_max</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">substream</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="p">,</span>
							     <span class="n">params</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;hw_params() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">substream</span><span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">substream</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
							   <span class="n">sink</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;hw_params() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAPM_POST_PMU</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_digital_mute</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to unmute: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAPM_PRE_PMD</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_digital_mute</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to mute: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_soc_dapm_new_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_pcm_stream</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">sink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">routes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">template</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">link_name</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">link_name</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">link_name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s-%s&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">template</span><span class="p">));</span>
	<span class="n">template</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">SND_SOC_NOPM</span><span class="p">;</span>
	<span class="n">template</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">snd_soc_dapm_dai_link</span><span class="p">;</span>
	<span class="n">template</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">link_name</span><span class="p">;</span>
	<span class="n">template</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">snd_soc_dai_link_event</span><span class="p">;</span>
	<span class="n">template</span><span class="p">.</span><span class="n">event_flags</span> <span class="o">=</span> <span class="n">SND_SOC_DAPM_PRE_PMU</span> <span class="o">|</span> <span class="n">SND_SOC_DAPM_POST_PMU</span> <span class="o">|</span>
		<span class="n">SND_SOC_DAPM_PRE_PMD</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adding %s widget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link_name</span><span class="p">);</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">template</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create %s widget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">link_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">routes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">routes</span><span class="p">));</span>

	<span class="n">routes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">routes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sink</span> <span class="o">=</span> <span class="n">link_name</span><span class="p">;</span>
	<span class="n">routes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">source</span> <span class="o">=</span> <span class="n">link_name</span><span class="p">;</span>
	<span class="n">routes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">routes</span><span class="p">,</span>
				       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">routes</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_soc_dapm_new_dai_widgets</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="n">template</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">template</span><span class="p">));</span>
	<span class="n">template</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">SND_SOC_NOPM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">stream_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">template</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">snd_soc_dapm_dai</span><span class="p">;</span>
		<span class="n">template</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">stream_name</span><span class="p">;</span>
		<span class="n">template</span><span class="p">.</span><span class="n">sname</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">stream_name</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adding %s widget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">template</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

		<span class="n">w</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_control</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">template</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create %s widget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">stream_name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">w</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dai</span><span class="p">;</span>
		<span class="n">dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">stream_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">template</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">snd_soc_dapm_dai</span><span class="p">;</span>
		<span class="n">template</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">stream_name</span><span class="p">;</span>
		<span class="n">template</span><span class="p">.</span><span class="n">sname</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">stream_name</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adding %s widget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">template</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

		<span class="n">w</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_control</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">template</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create %s widget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">stream_name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">w</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dai</span><span class="p">;</span>
		<span class="n">dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_soc_dapm_link_dai_widgets</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">dai_w</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>

	<span class="cm">/* For each DAI widget... */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dai_w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai_w</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">snd_soc_dapm_dai</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dai</span> <span class="o">=</span> <span class="n">dai_w</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

		<span class="cm">/* ...find all widgets with the same stream and link them */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">!=</span> <span class="n">dai_w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_dai</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sname</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">stream_name</span> <span class="o">&amp;&amp;</span>
			    <span class="n">strstr</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sname</span><span class="p">,</span>
				   <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">playback</span><span class="p">.</span><span class="n">stream_name</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">r</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
				<span class="n">r</span><span class="p">.</span><span class="n">sink</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">r</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">sink</span><span class="p">);</span>

				<span class="n">snd_soc_dapm_add_route</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">stream_name</span> <span class="o">&amp;&amp;</span>
			    <span class="n">strstr</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sname</span><span class="p">,</span>
				   <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">stream_name</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">r</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
				<span class="n">r</span><span class="p">.</span><span class="n">sink</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">r</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">sink</span><span class="p">);</span>

				<span class="n">snd_soc_dapm_add_route</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_dapm_stream_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w_cpu</span><span class="p">,</span> <span class="o">*</span><span class="n">w_codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w_cpu</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span><span class="p">;</span>
		<span class="n">w_codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">w_cpu</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span><span class="p">;</span>
		<span class="n">w_codec</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w_cpu</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">w_cpu</span><span class="p">,</span> <span class="s">&quot;stream event&quot;</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_START</span>:
			<span class="n">w_cpu</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_STOP</span>:
			<span class="n">w_cpu</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_SUSPEND</span>:
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_RESUME</span>:
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_PAUSE_PUSH</span>:
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_PAUSE_RELEASE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w_codec</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">w_codec</span><span class="p">,</span> <span class="s">&quot;stream event&quot;</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_START</span>:
			<span class="n">w_codec</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_STOP</span>:
			<span class="n">w_codec</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_SUSPEND</span>:
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_RESUME</span>:
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_PAUSE_PUSH</span>:
		<span class="k">case</span> <span class="n">SND_SOC_DAPM_STREAM_PAUSE_RELEASE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dapm_power_widgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_stream_event - send a stream event to the dapm core</span>
<span class="cm"> * @rtd: PCM runtime data</span>
<span class="cm"> * @stream: stream name</span>
<span class="cm"> * @event: stream event</span>
<span class="cm"> *</span>
<span class="cm"> * Sends a stream event to the dapm core. The core then makes any</span>
<span class="cm"> * necessary widget power changes.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success else error.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">,</span> <span class="n">SND_SOC_DAPM_CLASS_RUNTIME</span><span class="p">);</span>
	<span class="n">soc_dapm_stream_event</span><span class="p">(</span><span class="n">rtd</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_enable_pin - enable pin.</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @pin: pin name</span>
<span class="cm"> *</span>
<span class="cm"> * Enables input/output pin and its parents or children widgets iff there is</span>
<span class="cm"> * a valid audio route and active audio stream.</span>
<span class="cm"> * NOTE: snd_soc_dapm_sync() needs to be called after this for DAPM to</span>
<span class="cm"> * do any widget power switching.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_soc_dapm_set_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_enable_pin</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_force_enable_pin - force a pin to be enabled</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @pin: pin name</span>
<span class="cm"> *</span>
<span class="cm"> * Enables input/output pin regardless of any other state.  This is</span>
<span class="cm"> * intended for use with microphone bias supplies used in microphone</span>
<span class="cm"> * jack detection.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: snd_soc_dapm_sync() needs to be called after this for DAPM to</span>
<span class="cm"> * do any widget power switching.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_force_enable_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">dapm_find_widget</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dapm: unknown pin %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dapm: force enable pin %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dapm_mark_dirty</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">&quot;force enable&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_force_enable_pin</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_disable_pin - disable pin.</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @pin: pin name</span>
<span class="cm"> *</span>
<span class="cm"> * Disables input/output pin and its parents or children widgets.</span>
<span class="cm"> * NOTE: snd_soc_dapm_sync() needs to be called after this for DAPM to</span>
<span class="cm"> * do any widget power switching.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_soc_dapm_set_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_disable_pin</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_nc_pin - permanently disable pin.</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @pin: pin name</span>
<span class="cm"> *</span>
<span class="cm"> * Marks the specified pin as being not connected, disabling it along</span>
<span class="cm"> * any parent or child widgets.  At present this is identical to</span>
<span class="cm"> * snd_soc_dapm_disable_pin() but in future it will be extended to do</span>
<span class="cm"> * additional things such as disabling controls which only affect</span>
<span class="cm"> * paths through the pin.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: snd_soc_dapm_sync() needs to be called after this for DAPM to</span>
<span class="cm"> * do any widget power switching.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_nc_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_soc_dapm_set_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_nc_pin</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_get_pin_status - get audio pin status</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @pin: audio signal pin endpoint (or start point)</span>
<span class="cm"> *</span>
<span class="cm"> * Get audio pin status - connected or disconnected.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 for connected otherwise 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_get_pin_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">dapm_find_widget</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_get_pin_status</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_ignore_suspend - ignore suspend status for DAPM endpoint</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> * @pin: audio signal pin endpoint (or start point)</span>
<span class="cm"> *</span>
<span class="cm"> * Mark the given endpoint or pin as ignoring suspend.  When the</span>
<span class="cm"> * system is disabled a path between two endpoints flagged as ignoring</span>
<span class="cm"> * suspend will not be disabled.  The path must already be enabled via</span>
<span class="cm"> * normal means at suspend time, it will not be turned on if it was not</span>
<span class="cm"> * already enabled.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dapm_ignore_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">dapm_find_widget</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dapm: unknown pin %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_ignore_suspend</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">snd_soc_dapm_widget_in_card_paths</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_path</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sink</span> <span class="o">==</span> <span class="n">w</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;... Path %s(id:%d dapm:%p) - %s(id:%d dapm:%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">p</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
			    <span class="n">p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

			<span class="cm">/* Connected to something other than the codec */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Loopback connection from codec external pin to</span>
<span class="cm">			 * codec external pin</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">snd_soc_dapm_input</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">snd_soc_dapm_output</span>:
				<span class="k">case</span> <span class="n">snd_soc_dapm_micbias</span>:
					<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_auto_nc_codec_pins - call snd_soc_dapm_nc_pin for unused pins</span>
<span class="cm"> * @codec: The codec whose pins should be processed</span>
<span class="cm"> *</span>
<span class="cm"> * Automatically call snd_soc_dapm_nc_pin() for any external pins in the codec</span>
<span class="cm"> * which are unused. Pins are used if they are connected externally to the</span>
<span class="cm"> * codec, whether that be to some other device, or a loop-back connection to</span>
<span class="cm"> * the codec itself.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_soc_dapm_auto_nc_codec_pins</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Auto NC: DAPMs: card:%p codec:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">!=</span> <span class="n">dapm</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">snd_soc_dapm_input</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_output</span>:
		<span class="k">case</span> <span class="n">snd_soc_dapm_micbias</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Auto NC: Checking widget %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_dapm_widget_in_card_paths</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;... Not in map; disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">snd_soc_dapm_nc_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dapm_free - free dapm resources</span>
<span class="cm"> * @dapm: DAPM context</span>
<span class="cm"> *</span>
<span class="cm"> * Free all dapm widgets and resources.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_soc_dapm_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_dapm_sys_remove</span><span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dapm_debugfs_cleanup</span><span class="p">(</span><span class="n">dapm</span><span class="p">);</span>
	<span class="n">dapm_free_widgets</span><span class="p">(</span><span class="n">dapm</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dapm_free</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_dapm_shutdown_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dapm_context</span> <span class="o">*</span><span class="n">dapm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">down_list</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">powerdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">widgets</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dapm</span> <span class="o">!=</span> <span class="n">dapm</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dapm_seq_insert</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">down_list</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">powerdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If there were no widgets to power down we&#39;re already in</span>
<span class="cm">	 * standby.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">powerdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_ON</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_set_bias_level</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span>
						    <span class="n">SND_SOC_BIAS_PREPARE</span><span class="p">);</span>
		<span class="n">dapm_seq_run</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">down_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dapm</span><span class="o">-&gt;</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_PREPARE</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_set_bias_level</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span>
						    <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * snd_soc_dapm_shutdown - callback for system shutdown</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_soc_dapm_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_dev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">soc_dapm_shutdown_codec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">==</span> <span class="n">SND_SOC_BIAS_STANDBY</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_set_bias_level</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
						    <span class="n">SND_SOC_BIAS_OFF</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Module information */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Liam Girdwood, lrg@slimlogic.co.uk&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Dynamic Audio Power Management core for ALSA SoC&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
