<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › pxa › pxa-ssp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pxa-ssp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * pxa-ssp.c  --  ALSA Soc Audio Layer</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005,2008 Wolfson Microelectronics PLC.</span>
<span class="cm"> * Author: Liam Girdwood</span>
<span class="cm"> *         Mark Brown &lt;broonie@opensource.wolfsonmicro.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> *  under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *  o Test network mode for &gt; 16bit sample size</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/pxa2xx_ssp.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/pxa2xx-lib.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;mach/dma.h&gt;</span>

<span class="cp">#include &quot;../../arm/pxa2xx-pcm.h&quot;</span>
<span class="cp">#include &quot;pxa-ssp.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * SSP audio private data</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sysclk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dai_fmt</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="kt">uint32_t</span>	<span class="n">cr0</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">cr1</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">to</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">psp</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SSCR0 0x%08x SSCR1 0x%08x SSTO 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">),</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR1</span><span class="p">),</span>
		 <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSTO</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SSPSP 0x%08x SSSR 0x%08x SSACD 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSPSP</span><span class="p">),</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSSR</span><span class="p">),</span>
		 <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSACD</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa_ssp_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">sscr0</span><span class="p">;</span>

	<span class="n">sscr0</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSCR0</span><span class="p">)</span> <span class="o">|</span> <span class="n">SSCR0_SSE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">sscr0</span><span class="p">,</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSCR0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa_ssp_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">sscr0</span><span class="p">;</span>

	<span class="n">sscr0</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSCR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SSCR0_SSE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">sscr0</span><span class="p">,</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSCR0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pxa2xx_pcm_dma_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa2xx_pcm_dma_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa_ssp_set_dma_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width4</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">out</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa2xx_pcm_dma_params</span> <span class="o">*</span><span class="n">dma_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa2xx_pcm_dma_data</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dma_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa2xx_pcm_dma_data</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;SSP%d PCM %s %s&quot;</span><span class="p">,</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span>
			<span class="n">width4</span> <span class="o">?</span> <span class="s">&quot;32-bit&quot;</span> <span class="o">:</span> <span class="s">&quot;16-bit&quot;</span><span class="p">,</span> <span class="n">out</span> <span class="o">?</span> <span class="s">&quot;out&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">);</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">drcmr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DRCMR</span><span class="p">(</span><span class="n">out</span> <span class="o">?</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">drcmr_tx</span> <span class="o">:</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">drcmr_rx</span><span class="p">);</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">dcmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span> <span class="o">?</span> <span class="p">(</span><span class="n">DCMD_INCSRCADDR</span> <span class="o">|</span> <span class="n">DCMD_FLOWTRG</span><span class="p">)</span> <span class="o">:</span>
				  <span class="p">(</span><span class="n">DCMD_INCTRGADDR</span> <span class="o">|</span> <span class="n">DCMD_FLOWSRC</span><span class="p">))</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">width4</span> <span class="o">?</span> <span class="n">DCMD_WIDTH4</span> <span class="o">:</span> <span class="n">DCMD_WIDTH2</span><span class="p">)</span> <span class="o">|</span> <span class="n">DCMD_BURST16</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">phys_base</span> <span class="o">+</span> <span class="n">SSDR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxa2xx_pcm_dma_data</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">pxa_ssp_disable</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa2xx_pcm_dma_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">snd_soc_dai_set_dma_data</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa_ssp_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pxa_ssp_disable</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">snd_soc_dai_get_dma_data</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="n">substream</span><span class="p">));</span>
	<span class="n">snd_soc_dai_set_dma_data</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cr0</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSCR0</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cr1</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSCR1</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">to</span>  <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSTO</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">psp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSPSP</span><span class="p">);</span>

	<span class="n">pxa_ssp_disable</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sssr</span> <span class="o">=</span> <span class="n">SSSR_ROR</span> <span class="o">|</span> <span class="n">SSSR_TUR</span> <span class="o">|</span> <span class="n">SSSR_BCE</span><span class="p">;</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">sssr</span><span class="p">,</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSSR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SSCR0_SSE</span><span class="p">,</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSCR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSCR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">,</span>  <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSTO</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">psp</span><span class="p">,</span> <span class="n">ssp</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">SSPSP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">pxa_ssp_enable</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define pxa_ssp_suspend	NULL</span>
<span class="cp">#define pxa_ssp_resume	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * ssp_set_clkdiv - set SSP clock divider</span>
<span class="cm"> * @div: serial clock rate divider</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa_ssp_set_scr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sscr0</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PXA25x_SSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sscr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0000ff00</span><span class="p">;</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="p">((</span><span class="n">div</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 2..512 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sscr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x000fff00</span><span class="p">;</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">div</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>     <span class="cm">/* 1..4096 */</span>
	<span class="p">}</span>
	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">,</span> <span class="n">sscr0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pxa_ssp_get_clkdiv - get SSP clock divider</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">pxa_ssp_get_scr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sscr0</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PXA25x_SSP</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="p">((</span><span class="n">sscr0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">div</span> <span class="o">=</span> <span class="p">((</span><span class="n">sscr0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">div</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the SSP ports SYSCLK.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_set_dai_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">clk_id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">sscr0</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="n">SSCR0_ECS</span> <span class="o">|</span>  <span class="n">SSCR0_NCS</span> <span class="o">|</span> <span class="n">SSCR0_MOD</span> <span class="o">|</span> <span class="n">SSCR0_ACS</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;pxa_ssp_set_dai_sysclk id: %d, clk_id %d, freq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">clk_id</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clk_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PXA_SSP_CLK_NET_PLL</span>:
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_MOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PXA_SSP_CLK_PLL</span>:
		<span class="cm">/* Internal PLL is fixed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PXA25x_SSP</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sysclk</span> <span class="o">=</span> <span class="mi">1843200</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sysclk</span> <span class="o">=</span> <span class="mi">13000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PXA_SSP_CLK_EXT</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sysclk</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_ECS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PXA_SSP_CLK_NET</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sysclk</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_NCS</span> <span class="o">|</span> <span class="n">SSCR0_MOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PXA_SSP_CLK_AUDIO</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sysclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pxa_ssp_set_scr</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_ACS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The SSP clock must be disabled when changing SSP clock mode</span>
<span class="cm">	 * on PXA2xx.  On PXA3xx it must be enabled when doing so. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PXA3xx_SSP</span><span class="p">)</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">)</span> <span class="o">|</span> <span class="n">sscr0</span><span class="p">;</span>
	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PXA3xx_SSP</span><span class="p">)</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the SSP clock dividers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_set_dai_clkdiv</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">div_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">div_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PXA_SSP_AUDIO_DIV_ACDS</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSACD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">)</span> <span class="o">|</span> <span class="n">SSACD_ACDS</span><span class="p">(</span><span class="n">div</span><span class="p">);</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSACD</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PXA_SSP_AUDIO_DIV_SCDB</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSACD</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSACD_SCDB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PXA3xx_SSP</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSACD_SCDX8</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">div</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PXA_SSP_CLK_SCDB_1</span>:
			<span class="n">val</span> <span class="o">|=</span> <span class="n">SSACD_SCDB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PXA_SSP_CLK_SCDB_4</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PXA_SSP_CLK_SCDB_8</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PXA3xx_SSP</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">SSACD_SCDX8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSACD</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PXA_SSP_DIV_SCR</span>:
		<span class="n">pxa_ssp_set_scr</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the PLL frequency pxa27x and (afaik - pxa320 only)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_set_dai_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pll_id</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">source</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ssacd</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSACD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x70</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PXA3xx_SSP</span><span class="p">)</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSACDD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">freq_out</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5622000</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11345000</span>:
		<span class="n">ssacd</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12235000</span>:
		<span class="n">ssacd</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14857000</span>:
		<span class="n">ssacd</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32842000</span>:
		<span class="n">ssacd</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x4</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000000</span>:
		<span class="n">ssacd</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Disable */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* PXA3xx has a clock ditherer which can be used to generate</span>
<span class="cm">		 * a wider range of frequencies - calculate a value for it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PXA3xx_SSP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">19968</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">1000000</span><span class="p">;</span>
			<span class="n">do_div</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">freq_out</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSACDD</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="n">ssacd</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x6</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Using SSACDD %x to supply %uHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">val</span><span class="p">,</span> <span class="n">freq_out</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSACD</span><span class="p">,</span> <span class="n">ssacd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the active slots in TDM/Network mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_set_dai_tdm_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slots</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sscr0</span><span class="p">;</span>

	<span class="n">sscr0</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">);</span>
	<span class="n">sscr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SSCR0_MOD</span> <span class="o">|</span> <span class="n">SSCR0_SlotsPerFrm</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SSCR0_EDSS</span> <span class="o">|</span> <span class="n">SSCR0_DSS</span><span class="p">);</span>

	<span class="cm">/* set slot width */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot_width</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_EDSS</span> <span class="o">|</span> <span class="n">SSCR0_DataSize</span><span class="p">(</span><span class="n">slot_width</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_DataSize</span><span class="p">(</span><span class="n">slot_width</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable network mode */</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_MOD</span><span class="p">;</span>

		<span class="cm">/* set number of active slots */</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_SlotsPerFrm</span><span class="p">(</span><span class="n">slots</span><span class="p">);</span>

		<span class="cm">/* set active slot mask */</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSTSA</span><span class="p">,</span> <span class="n">tx_mask</span><span class="p">);</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSRSA</span><span class="p">,</span> <span class="n">rx_mask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">,</span> <span class="n">sscr0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tristate the SSP DAI lines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_set_dai_tristate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">tristate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sscr1</span><span class="p">;</span>

	<span class="n">sscr1</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tristate</span><span class="p">)</span>
		<span class="n">sscr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSCR1_TTE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sscr1</span> <span class="o">|=</span> <span class="n">SSCR1_TTE</span><span class="p">;</span>
	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR1</span><span class="p">,</span> <span class="n">sscr1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up the SSP DAI format.</span>
<span class="cm"> * The SSP Port must be inactive before calling this function as the</span>
<span class="cm"> * physical interface format is changed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_set_dai_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sscr0</span><span class="p">,</span> <span class="n">sscr1</span><span class="p">,</span> <span class="n">sspsp</span><span class="p">,</span> <span class="n">scfr</span><span class="p">;</span>

	<span class="cm">/* check if we need to change anything at all */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dai_fmt</span> <span class="o">==</span> <span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* we can only change the settings if the port is not in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSCR0_SSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;can&#39;t change hardware dai format: stream is in use&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset port settings */</span>
	<span class="n">sscr0</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="n">SSCR0_ECS</span> <span class="o">|</span>  <span class="n">SSCR0_NCS</span> <span class="o">|</span> <span class="n">SSCR0_MOD</span> <span class="o">|</span> <span class="n">SSCR0_ACS</span><span class="p">);</span>
	<span class="n">sscr1</span> <span class="o">=</span> <span class="n">SSCR1_RxTresh</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SSCR1_TxTresh</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
	<span class="n">sspsp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
		<span class="n">sscr1</span> <span class="o">|=</span> <span class="n">SSCR1_SCLKDIR</span> <span class="o">|</span> <span class="n">SSCR1_SFRMDIR</span> <span class="o">|</span> <span class="n">SSCR1_SCFR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFS</span>:
		<span class="n">sscr1</span> <span class="o">|=</span> <span class="n">SSCR1_SCLKDIR</span> <span class="o">|</span> <span class="n">SSCR1_SCFR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_INV_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_NB_NF</span>:
		<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_SFRMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_NB_IF</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_IB_IF</span>:
		<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_SCMODE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_IB_NF</span>:
		<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_SCMODE</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SSPSP_SFRMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span>:
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_PSP</span><span class="p">;</span>
		<span class="n">sscr1</span> <span class="o">|=</span> <span class="n">SSCR1_RWOT</span> <span class="o">|</span> <span class="n">SSCR1_TRAIL</span><span class="p">;</span>
		<span class="cm">/* See hw_params() */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_A</span>:
		<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_FSRT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_DSP_B</span>:
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_MOD</span> <span class="o">|</span> <span class="n">SSCR0_PSP</span><span class="p">;</span>
		<span class="n">sscr1</span> <span class="o">|=</span> <span class="n">SSCR1_TRAIL</span> <span class="o">|</span> <span class="n">SSCR1_RWOT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">,</span> <span class="n">sscr0</span><span class="p">);</span>
	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR1</span><span class="p">,</span> <span class="n">sscr1</span><span class="p">);</span>
	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSPSP</span><span class="p">,</span> <span class="n">sspsp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFS</span>:
		<span class="n">scfr</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR1</span><span class="p">)</span> <span class="o">|</span> <span class="n">SSCR1_SCFR</span><span class="p">;</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR1</span><span class="p">,</span> <span class="n">scfr</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSSR_BSY</span><span class="p">)</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dump_registers</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>

	<span class="cm">/* Since we are configuring the timings for the format by hand</span>
<span class="cm">	 * we have to defer some things until hw_params() where we</span>
<span class="cm">	 * know parameters like the sample size.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dai_fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the SSP audio DMA parameters and sample size.</span>
<span class="cm"> * Can be called multiple times by oss emulation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chn</span> <span class="o">=</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sscr0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sspsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">snd_pcm_format_physical_width</span><span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ttsa</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSTSA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxa2xx_pcm_dma_params</span> <span class="o">*</span><span class="n">dma_data</span><span class="p">;</span>

	<span class="n">dma_data</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_dma_data</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>

	<span class="cm">/* Network mode with one active slot (ttsa == 1) can be used</span>
<span class="cm">	 * to force 16-bit frame width on the wire (for S16_LE), even</span>
<span class="cm">	 * with two channels. Use 16-bit DMA transfers for this case.</span>
<span class="cm">	 */</span>
	<span class="n">pxa_ssp_set_dma_params</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span>
		<span class="p">((</span><span class="n">chn</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ttsa</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="mi">32</span><span class="p">),</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="n">dma_data</span><span class="p">);</span>

	<span class="cm">/* we can only change the settings if the port is not in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSCR0_SSE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clear selected SSP bits */</span>
	<span class="n">sscr0</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SSCR0_DSS</span> <span class="o">|</span> <span class="n">SSCR0_EDSS</span><span class="p">);</span>

	<span class="cm">/* bit size */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PXA3xx_SSP</span><span class="p">)</span>
			<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_FPCKE</span><span class="p">;</span>
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="n">SSCR0_DataSize</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_LE</span>:
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SSCR0_EDSS</span> <span class="o">|</span> <span class="n">SSCR0_DataSize</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span>:
		<span class="n">sscr0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SSCR0_EDSS</span> <span class="o">|</span> <span class="n">SSCR0_DataSize</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">,</span> <span class="n">sscr0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dai_fmt</span> <span class="o">&amp;</span> <span class="n">SND_SOC_DAIFMT_FORMAT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_I2S</span>:
	       <span class="n">sspsp</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSPSP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pxa_ssp_get_scr</span><span class="p">(</span><span class="n">ssp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This is a special case where the bitclk is 64fs</span>
<span class="cm">			* and we&#39;re not dealing with 2*32 bits of audio</span>
<span class="cm">			* samples.</span>
<span class="cm">			*</span>
<span class="cm">			* The SSP values used for that are all found out by</span>
<span class="cm">			* trying and failing a lot; some of the registers</span>
<span class="cm">			* needed for that mode are only available on PXA3xx.</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PXA3xx_SSP</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_SFRMWDTH</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_SFRMDLY</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_EDMYSTOP</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
			<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_DMYSTOP</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
			<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_DMYSTRT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The frame width is the width the LRCLK is</span>
<span class="cm">			 * asserted for; the delay is expressed in</span>
<span class="cm">			 * half cycle units.  We need the extra cycle</span>
<span class="cm">			 * because the data starts clocking out one BCLK</span>
<span class="cm">			 * after LRCLK changes polarity.</span>
<span class="cm">			 */</span>
			<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_SFRMWDTH</span><span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_SFRMDLY</span><span class="p">((</span><span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">sspsp</span> <span class="o">|=</span> <span class="n">SSPSP_DMYSTRT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSPSP</span><span class="p">,</span> <span class="n">sspsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* When we use a network mode, we always require TDM slots</span>
<span class="cm">	 * - complain loudly and fail if they&#39;ve not been set up yet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sscr0</span> <span class="o">&amp;</span> <span class="n">SSCR0_MOD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ttsa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No TDM timeslot configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dump_registers</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa_ssp_set_running_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">sscr0</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">sscr1</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR1</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">sspsp</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSPSP</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">sssr</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sscr0</span> <span class="o">&amp;</span> <span class="n">SSCR0_SSE</span><span class="p">))</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">,</span> <span class="n">sscr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SSCR0_SSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
			<span class="n">sscr1</span> <span class="o">|=</span> <span class="n">SSCR1_TSRE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sscr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSCR1_TSRE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
			<span class="n">sscr1</span> <span class="o">|=</span> <span class="n">SSCR1_RSRE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sscr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSCR1_RSRE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR1</span><span class="p">,</span> <span class="n">sscr1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSSR</span><span class="p">,</span> <span class="n">sssr</span><span class="p">);</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSPSP</span><span class="p">,</span> <span class="n">sspsp</span><span class="p">);</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSCR0</span><span class="p">,</span> <span class="n">sscr0</span> <span class="o">|</span> <span class="n">SSCR0_SSE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_device</span> <span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">pxa_ssp_enable</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="n">pxa_ssp_set_running_bit</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">ssp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">pxa_ssp_read_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSSR</span><span class="p">);</span>
		<span class="n">pxa_ssp_write_reg</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span> <span class="n">SSSR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="n">pxa_ssp_set_running_bit</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">ssp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">pxa_ssp_set_running_bit</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">ssp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">pxa_ssp_disable</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="n">pxa_ssp_set_running_bit</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">ssp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dump_registers</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">pxa_ssp_request</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SoC audio&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_priv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dai_fmt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_soc_dai_set_drvdata</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_priv:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_ssp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">snd_soc_dai_get_drvdata</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>

	<span class="n">pxa_ssp_free</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PXA_SSP_RATES (SNDRV_PCM_RATE_8000 | SNDRV_PCM_RATE_11025 |\</span>
<span class="cp">			  SNDRV_PCM_RATE_16000 | SNDRV_PCM_RATE_22050 |	\</span>
<span class="cp">			  SNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_44100 |	\</span>
<span class="cp">			  SNDRV_PCM_RATE_48000 | SNDRV_PCM_RATE_64000 |	\</span>
<span class="cp">			  SNDRV_PCM_RATE_88200 | SNDRV_PCM_RATE_96000)</span>

<span class="cp">#define PXA_SSP_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\</span>
<span class="cp">			    SNDRV_PCM_FMTBIT_S24_LE |	\</span>
<span class="cp">			    SNDRV_PCM_FMTBIT_S32_LE)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">pxa_ssp_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">pxa_ssp_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">pxa_ssp_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>	<span class="o">=</span> <span class="n">pxa_ssp_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span> <span class="n">pxa_ssp_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_sysclk</span>	<span class="o">=</span> <span class="n">pxa_ssp_set_dai_sysclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_clkdiv</span>	<span class="o">=</span> <span class="n">pxa_ssp_set_dai_clkdiv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pll</span>	<span class="o">=</span> <span class="n">pxa_ssp_set_dai_pll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">pxa_ssp_set_dai_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tdm_slot</span>	<span class="o">=</span> <span class="n">pxa_ssp_set_dai_tdm_slot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tristate</span>	<span class="o">=</span> <span class="n">pxa_ssp_set_dai_tristate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="n">pxa_ssp_dai</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pxa_ssp_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">pxa_ssp_remove</span><span class="p">,</span>
		<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">pxa_ssp_suspend</span><span class="p">,</span>
		<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pxa_ssp_resume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">PXA_SSP_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">PXA_SSP_FORMATS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">capture</span> <span class="o">=</span> <span class="p">{</span>
			 <span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">PXA_SSP_RATES</span><span class="p">,</span>
			<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">PXA_SSP_FORMATS</span><span class="p">,</span>
		 <span class="p">},</span>
		<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa_ssp_dai_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">asoc_ssp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_soc_register_dai</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pxa_ssp_dai</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">asoc_ssp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_unregister_dai</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">asoc_ssp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pxa-ssp-dai&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">asoc_ssp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">asoc_ssp_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">asoc_ssp_driver</span><span class="p">);</span>

<span class="cm">/* Module information */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mark Brown &lt;broonie@opensource.wolfsonmicro.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PXA SSP/PCM SoC Interface&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
