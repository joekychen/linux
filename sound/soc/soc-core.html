<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › soc › soc-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>soc-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * soc-core.c  --  ALSA SoC Audio Layer</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005 Wolfson Microelectronics PLC.</span>
<span class="cm"> * Copyright 2005 Openedhand Ltd.</span>
<span class="cm"> * Copyright (C) 2010 Slimlogic Ltd.</span>
<span class="cm"> * Copyright (C) 2010 Texas Instruments Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Liam Girdwood &lt;lrg@slimlogic.co.uk&gt;</span>
<span class="cm"> *         with code, comments and ideas from :-</span>
<span class="cm"> *         Richard Purdie &lt;richard@openedhand.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> *  under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *   o Add hw rules to enforce rates, etc.</span>
<span class="cm"> *   o More testing with other codecs/machines.</span>
<span class="cm"> *   o Add more codecs and platforms to ensure good API coverage.</span>
<span class="cm"> *   o Support TDM on PCM and I2S</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/jack.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/soc.h&gt;</span>
<span class="cp">#include &lt;sound/soc-dpcm.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#define CREATE_TRACE_POINTS</span>
<span class="cp">#include &lt;trace/events/asoc.h&gt;</span>

<span class="cp">#define NAME_SIZE	32</span>

<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">soc_pm_waitq</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">snd_soc_debugfs_root</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_debugfs_root</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">client_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">dai_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">platform_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">codec_list</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This is a timeout to do a DAPM powerdown after a stream is closed().</span>
<span class="cm"> * It can be used to eliminate pops between different playback streams, e.g.</span>
<span class="cm"> * between two audio tracks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pmdown_time</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pmdown_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pmdown_time</span><span class="p">,</span> <span class="s">&quot;DAPM stream powerdown time (msecs)&quot;</span><span class="p">);</span>

<span class="cm">/* returns the minimum number of bytes needed to represent</span>
<span class="cm"> * a particular given value */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">min_bytes_needed</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span> <span class="o">/=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* fill buf which is &#39;len&#39; bytes with a formatted</span>
<span class="cm"> * string of the form &#39;reg: value\n&#39; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">format_register_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wordsize</span> <span class="o">=</span> <span class="n">min_bytes_needed</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_cache_size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">regsize</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_word_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">regbuf</span><span class="p">[</span><span class="n">regsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* since tmpbuf is allocated on the stack, warn the callers if they</span>
<span class="cm">	 * try to abuse this function */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">);</span>

	<span class="cm">/* +2 for &#39;: &#39; and + 1 for &#39;\n&#39; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wordsize</span> <span class="o">+</span> <span class="n">regsize</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">regbuf</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="n">regsize</span><span class="p">);</span>
		<span class="n">regbuf</span><span class="p">[</span><span class="n">regsize</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">regbuf</span><span class="p">,</span> <span class="n">regsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%.*x&quot;</span><span class="p">,</span> <span class="n">regsize</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* prepare the buffer */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%.*x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wordsize</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">regbuf</span><span class="p">);</span>
	<span class="cm">/* copy it back to the caller without the &#39;\0&#39; */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* codec register dump */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">soc_codec_reg_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wordsize</span><span class="p">,</span> <span class="n">regsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wordsize</span> <span class="o">=</span> <span class="n">min_bytes_needed</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_cache_size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">regsize</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_word_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">wordsize</span> <span class="o">+</span> <span class="n">regsize</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_cache_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_cache_step</span><span class="p">)</span>
		<span class="n">step</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_cache_step</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_cache_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">step</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_soc_codec_readable_register</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">display_register</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">display_register</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span>
							 <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* only support larger than PAGE_SIZE bytes debugfs</span>
<span class="cm">			 * entries for the default case */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">format_register_str</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">total</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">total</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">codec_reg_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">soc_codec_reg_show</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">codec_reg</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">codec_reg_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pmdown_time_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pmdown_time</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pmdown_time_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pmdown_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pmdown_time</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">pmdown_time_show</span><span class="p">,</span> <span class="n">pmdown_time_set</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">codec_reg_read_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_codec_reg_show</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">codec_reg_write_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">buf_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">buf_size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">start</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
		<span class="n">start</span><span class="o">++</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">start</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
		<span class="n">start</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Userspace has been fiddling around behind the kernel&#39;s back */</span>
	<span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_USER</span><span class="p">);</span>

	<span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">codec_reg_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">codec_reg_read_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">codec_reg_write_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_init_codec_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_card_root</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_card_root</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">debugfs_codec_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						       <span class="n">debugfs_card_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">debugfs_codec_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create codec debugfs directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debugfs_create_bool</span><span class="p">(</span><span class="s">&quot;cache_sync&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">debugfs_codec_root</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">cache_sync</span><span class="p">);</span>
	<span class="n">debugfs_create_bool</span><span class="p">(</span><span class="s">&quot;cache_only&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">debugfs_codec_root</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">cache_only</span><span class="p">);</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">debugfs_reg</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;codec_reg&quot;</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span>
						 <span class="n">codec</span><span class="o">-&gt;</span><span class="n">debugfs_codec_root</span><span class="p">,</span>
						 <span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_reg_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">debugfs_reg</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create codec register debugfs file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_soc_dapm_debugfs_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">debugfs_codec_root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_cleanup_codec_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">debugfs_codec_root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_init_platform_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_card_root</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_card_root</span><span class="p">;</span>

	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">debugfs_platform_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						       <span class="n">debugfs_card_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">debugfs_platform_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to create platform debugfs directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_soc_dapm_debugfs_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
		<span class="n">platform</span><span class="o">-&gt;</span><span class="n">debugfs_platform_root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_cleanup_platform_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">debugfs_platform_root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">codec_list_read_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">codec_list_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">codec_list_read_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span><span class="cm">/* read accesses f_pos */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dai_list_read_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dai_list_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dai_list_read_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span><span class="cm">/* read accesses f_pos */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">platform_list_read_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				       <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">platform_list_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">platform_list_read_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span><span class="cm">/* read accesses f_pos */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_init_card_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_card_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						     <span class="n">snd_soc_debugfs_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_card_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;ASoC: Failed to create card debugfs directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_pop_time</span> <span class="o">=</span> <span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;dapm_pop_time&quot;</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span>
						    <span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_card_root</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pop_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_pop_time</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		       <span class="s">&quot;Failed to create pop time debugfs file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_cleanup_card_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_card_root</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">soc_init_codec_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">soc_cleanup_codec_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">soc_init_platform_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">soc_cleanup_platform_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">soc_init_card_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">soc_cleanup_card_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="nf">snd_soc_get_dai_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dai_link</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">no_pcm</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dai_link</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">substream</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to find dai link %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai_link</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_get_dai_substream</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="nf">snd_soc_get_pcm_runtime</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dai_link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dai_link</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to find rtd %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai_link</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_get_pcm_runtime</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SND_SOC_AC97_BUS</span>
<span class="cm">/* unregister ac97 codec */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_ac97_dev_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span><span class="p">)</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* stop no dev release warning */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_ac97_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">){}</span>

<span class="cm">/* register ac97 codec to bus */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">soc_ac97_dev_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ac97_bus_type</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">soc_ac97_device_release</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d-%d:%s&quot;</span><span class="p">,</span>
		     <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t register ac97 bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="cm">/* powers down audio subsystem for suspend */</span>
<span class="kt">int</span> <span class="nf">snd_soc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* If the initialization of this soc device failed, there is no codec</span>
<span class="cm">	 * associated with it. Just bail out in this case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_dev_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Due to the resume being scheduled into a workqueue we could</span>
<span class="cm">	* suspend before that&#39;s finished - wait for it to complete.</span>
<span class="cm">	 */</span>
	<span class="n">snd_power_lock</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">);</span>
	<span class="n">snd_power_wait</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="n">snd_power_unlock</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">);</span>

	<span class="cm">/* we&#39;re going to block userspace touching us until resume completes */</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>

	<span class="cm">/* mute any active DACs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">codec_dai</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">digital_mute</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">playback_active</span><span class="p">)</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">digital_mute</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* suspend all pcms */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pcm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">suspend_pre</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">suspend_pre</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu_dai</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">platform</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ac97_control</span><span class="p">)</span>
			<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
			<span class="n">platform</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* close any waiting streams and save state */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flush_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">delayed_work</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">suspend_bias_level</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					  <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
					  <span class="n">SND_SOC_DAPM_STREAM_SUSPEND</span><span class="p">);</span>

		<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					  <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
					  <span class="n">SND_SOC_DAPM_STREAM_SUSPEND</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* suspend all CODECs */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_dev_list</span><span class="p">,</span> <span class="n">card_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If there are paths active then the CODEC will be held with</span>
<span class="cm">		 * bias _ON and should not be suspended. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">&amp;&amp;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SND_SOC_BIAS_STANDBY</span>:
				<span class="cm">/*</span>
<span class="cm">				 * If the CODEC is capable of idle</span>
<span class="cm">				 * bias off then being in STANDBY</span>
<span class="cm">				 * means it&#39;s doing something,</span>
<span class="cm">				 * otherwise fall through.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">idle_bias_off</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;idle_bias_off CODEC on over suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="n">SND_SOC_BIAS_OFF</span>:
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">cache_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CODEC is on over suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu_dai</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ac97_control</span><span class="p">)</span>
			<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">suspend_post</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">suspend_post</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_suspend</span><span class="p">);</span>

<span class="cm">/* deferred resume work, so resume can complete before we finished</span>
<span class="cm"> * setting our codec back up, which can be very slow on I2C</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_resume_deferred</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soc_card</span><span class="p">,</span> <span class="n">deferred_resume_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* our power state is still SNDRV_CTL_POWER_D3hot from suspend time,</span>
<span class="cm">	 * so userspace apps are blocked from touching us</span>
<span class="cm">	 */</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;starting resume work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Bring us up into D2 so that DAPM starts enabling things */</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">resume_pre</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">resume_pre</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* resume AC97 DAIs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu_dai</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ac97_control</span><span class="p">)</span>
			<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_dev_list</span><span class="p">,</span> <span class="n">card_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If the CODEC was idle over suspend then it will have been</span>
<span class="cm">		 * left with bias OFF or STANDBY and suspended so we must now</span>
<span class="cm">		 * resume.  Otherwise the suspend was suppressed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span> <span class="o">&amp;&amp;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SND_SOC_BIAS_STANDBY</span>:
			<span class="k">case</span> <span class="n">SND_SOC_BIAS_OFF</span>:
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CODEC was on over suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					  <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
					  <span class="n">SND_SOC_DAPM_STREAM_RESUME</span><span class="p">);</span>

		<span class="n">snd_soc_dapm_stream_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					  <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
					  <span class="n">SND_SOC_DAPM_STREAM_RESUME</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* unmute any active DACs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">codec_dai</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">digital_mute</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">playback_active</span><span class="p">)</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">digital_mute</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu_dai</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">platform</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">ignore_suspend</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ac97_control</span><span class="p">)</span>
			<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
			<span class="n">platform</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">resume_post</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">resume_post</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resume work completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* userspace can access us now we are back as we were before */</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* powers up audio subsystem after a suspend */</span>
<span class="kt">int</span> <span class="nf">snd_soc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ac97_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the initialization of this soc device failed, there is no codec</span>
<span class="cm">	 * associated with it. Just bail out in this case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_dev_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* AC97 devices might have other drivers hanging off them so</span>
<span class="cm">	 * need to resume immediately.  Other drivers don&#39;t have that</span>
<span class="cm">	 * problem and may take a substantial amount of time to resume</span>
<span class="cm">	 * due to I/O costs and anti-pop so handle them out of line.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu_dai</span><span class="p">;</span>
		<span class="n">ac97_control</span> <span class="o">|=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ac97_control</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Resuming AC97 immediately</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">soc_resume_deferred</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">deferred_resume_work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Scheduling resume work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">deferred_resume_work</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resume work item may be lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_resume</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define snd_soc_suspend NULL</span>
<span class="cp">#define snd_soc_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_dai_ops</span> <span class="n">null_dai_ops</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_bind_dai_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai_link</span> <span class="o">*</span><span class="n">dai_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span><span class="p">,</span> <span class="o">*</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">platform_name</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;binding %s at idx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="cm">/* Find CPU DAI from registered DAIs*/</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">cpu_dai_of_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">!=</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">cpu_dai_of_node</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">cpu_dai_name</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CPU DAI %s not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">cpu_dai_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find CODEC from registered CODECs */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">codec_of_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">!=</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">codec_of_node</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">codec_name</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * CODEC found, so find CODEC DAI from registered DAIs from</span>
<span class="cm">		 * this CODEC</span>
<span class="cm">		 */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">codec_dai_name</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CODEC DAI %s not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">codec_dai_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CODEC %s not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">codec_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if there&#39;s no platform we match on the empty platform */</span>
	<span class="n">platform_name</span> <span class="o">=</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">platform_name</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">platform_name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">platform_of_node</span><span class="p">)</span>
		<span class="n">platform_name</span> <span class="o">=</span> <span class="s">&quot;snd-soc-dummy&quot;</span><span class="p">;</span>

	<span class="cm">/* find one from the set of registered platforms */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">platform_of_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">!=</span>
			    <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">platform_of_node</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">platform_name</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform %s not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">platform_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_remove_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;asoc: failed to remove %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure all DAPM widgets are freed */</span>
	<span class="n">snd_soc_dapm_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="n">soc_cleanup_codec_debugfs</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card_list</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_remove_dai_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">,</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* unregister the rtd device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_pmdown_time</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_codec_reg</span><span class="p">);</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* remove the CODEC DAI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span> <span class="o">&amp;&amp;</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">&amp;&amp;</span>
			<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove_order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: failed to remove %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">card_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* remove the platform */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span> <span class="o">&amp;&amp;</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">&amp;&amp;</span>
			<span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove_order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">platform</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: failed to remove %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Make sure all DAPM widgets are freed */</span>
		<span class="n">snd_soc_dapm_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

		<span class="n">soc_cleanup_platform_debugfs</span><span class="p">(</span><span class="n">platform</span><span class="p">);</span>
		<span class="n">platform</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">card_list</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* remove the CODEC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">&amp;&amp;</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove_order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span>
		<span class="n">soc_remove_codec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="cm">/* remove the cpu_dai */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">&amp;&amp;</span>
			<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove_order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: failed to remove %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">card_list</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_remove_dai_links</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dai</span><span class="p">,</span> <span class="n">order</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="n">SND_SOC_COMP_ORDER_FIRST</span><span class="p">;</span> <span class="n">order</span> <span class="o">&lt;=</span> <span class="n">SND_SOC_COMP_ORDER_LAST</span><span class="p">;</span>
			<span class="n">order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">dai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dai</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">dai</span><span class="o">++</span><span class="p">)</span>
			<span class="n">soc_remove_dai_link</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dai</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_set_name_prefix</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_conf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_configs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_codec_conf</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_conf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_probe_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_codec_driver</span> <span class="o">*</span><span class="n">driver</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">soc_set_name_prefix</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">soc_init_codec_debugfs</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dapm_widgets</span><span class="p">)</span>
		<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">dapm_widgets</span><span class="p">,</span>
					  <span class="n">driver</span><span class="o">-&gt;</span><span class="n">num_dapm_widgets</span><span class="p">);</span>

	<span class="cm">/* Create DAPM widgets for each DAI stream */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">snd_soc_dapm_new_dai_widgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">dai</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">idle_bias_off</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">idle_bias_off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;asoc: failed to probe CODEC %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_probe</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">)</span>
		<span class="n">snd_soc_add_codec_controls</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">,</span>
				     <span class="n">driver</span><span class="o">-&gt;</span><span class="n">num_controls</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dapm_routes</span><span class="p">)</span>
		<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">dapm_routes</span><span class="p">,</span>
					<span class="n">driver</span><span class="o">-&gt;</span><span class="n">num_dapm_routes</span><span class="p">);</span>

	<span class="cm">/* mark codec as probed and add to card codec list */</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">card_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_dev_list</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_probe:</span>
	<span class="n">soc_cleanup_codec_debugfs</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_probe_platform</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_platform_driver</span> <span class="o">*</span><span class="n">driver</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">;</span>

	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">soc_init_platform_debugfs</span><span class="p">(</span><span class="n">platform</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dapm_widgets</span><span class="p">)</span>
		<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span>
			<span class="n">driver</span><span class="o">-&gt;</span><span class="n">dapm_widgets</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">num_dapm_widgets</span><span class="p">);</span>

	<span class="cm">/* Create DAPM widgets for each DAI stream */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">snd_soc_dapm_new_dai_widgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">dai</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">idle_bias_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">platform</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;asoc: failed to probe platform %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_probe</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">)</span>
		<span class="n">snd_soc_add_platform_controls</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">,</span>
				     <span class="n">driver</span><span class="o">-&gt;</span><span class="n">num_controls</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dapm_routes</span><span class="p">)</span>
		<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">dapm_routes</span><span class="p">,</span>
					<span class="n">driver</span><span class="o">-&gt;</span><span class="n">num_dapm_routes</span><span class="p">);</span>

	<span class="cm">/* mark platform as probed and add to card platform list */</span>
	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">card_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">platform_dev_list</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_probe:</span>
	<span class="n">soc_cleanup_platform_debugfs</span><span class="p">(</span><span class="n">platform</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_post_component_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dailess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai_link</span> <span class="o">*</span><span class="n">dai_link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_aux_dev</span> <span class="o">*</span><span class="n">aux_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">temp</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dailess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dai_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="n">rtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aux_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aux_dev</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="n">rtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd_aux</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">aux_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="cm">/* Make sure all DAPM widgets are instantiated */</span>
	<span class="n">snd_soc_dapm_new_widgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="cm">/* machine controls, routes and widgets are not prefixed */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* do machine specific initialization */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dailess</span> <span class="o">&amp;&amp;</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">rtd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dailess</span> <span class="o">&amp;&amp;</span> <span class="n">aux_dev</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">aux_dev</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;asoc: failed to init %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* register the rtd device */</span>
	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>

	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">device_initialize</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">rtd_release</span><span class="p">;</span>
	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rtd</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pcm_mutex</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">be_clients</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">be_clients</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">fe_clients</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dpcm</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">fe_clients</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;asoc: failed to register runtime device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* add DAPM sysfs entries for this codec */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_sys_add</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;asoc: failed to add codec dapm sysfs entries: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* add codec sysfs entries */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_codec_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;asoc: failed to add codec sysfs files: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="cm">/* add DPCM sysfs entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dailess</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_dpcm_debugfs_add</span><span class="p">(</span><span class="n">rtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;asoc: failed to add dpcm sysfs entries: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

<span class="nl">out:</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_probe_dai_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai_link</span> <span class="o">*</span><span class="n">dai_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">codec_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">cpu_dai</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_widget</span> <span class="o">*</span><span class="n">play_w</span><span class="p">,</span> <span class="o">*</span><span class="n">capture_w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probe %s dai link %d late %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>

	<span class="cm">/* config components */</span>
	<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span><span class="p">;</span>
	<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="cm">/* set default power off timeout */</span>
	<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">pmdown_time</span> <span class="o">=</span> <span class="n">pmdown_time</span><span class="p">;</span>

	<span class="cm">/* probe the cpu_dai */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">&amp;&amp;</span>
			<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe_order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">snd_soc_dapm_new_dai_widgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">cpu_dai</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">cpu_dai</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: failed to probe CPU DAI %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="n">module_put</span><span class="p">(</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* mark cpu_dai as probed and add to card dai list */</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">card_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dai_dev_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* probe the CODEC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">&amp;&amp;</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe_order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_probe_codec</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* probe the platform */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">&amp;&amp;</span>
			<span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe_order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_probe_platform</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">platform</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* probe the CODEC DAI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">&amp;&amp;</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe_order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">codec_dai</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: failed to probe CODEC DAI %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* mark codec_dai as probed and add to card dai list */</span>
		<span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">probed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">card_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dai_dev_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* complete DAI probe during last probe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">!=</span> <span class="n">SND_SOC_COMP_ORDER_LAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_post_component_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_pmdown_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;asoc: failed to add pmdown_time sysfs:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* create the pcm */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_new_pcm</span><span class="p">(</span><span class="n">rtd</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: can&#39;t create pcm %s :%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* link the DAI widgets */</span>
		<span class="n">play_w</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span><span class="p">;</span>
		<span class="n">capture_w</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">play_w</span> <span class="o">&amp;&amp;</span> <span class="n">capture_w</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_pcm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span>
						   <span class="n">capture_w</span><span class="p">,</span> <span class="n">play_w</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t link %s to %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">play_w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">capture_w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">play_w</span> <span class="o">=</span> <span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">playback_widget</span><span class="p">;</span>
		<span class="n">capture_w</span> <span class="o">=</span> <span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">capture_widget</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">play_w</span> <span class="o">&amp;&amp;</span> <span class="n">capture_w</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dapm_new_pcm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span>
						   <span class="n">capture_w</span><span class="p">,</span> <span class="n">play_w</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t link %s to %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">play_w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">capture_w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* add platform data for AC97 devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ac97_control</span><span class="p">)</span>
		<span class="n">snd_ac97_dev_add_pdata</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">ac97_pdata</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_SOC_AC97_BUS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_register_ac97_dai_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Only instantiate AC97 if not already done by the adaptor</span>
<span class="cm">	 * for the generic AC97 subsystem.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ac97_control</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * It is possible that the AC97 device is already registered to</span>
<span class="cm">		 * the device subsystem. This happens when the device is created</span>
<span class="cm">		 * via snd_ac97_mixer(). Currently only SoC codec that does so</span>
<span class="cm">		 * is the generic AC97 glue but others migh emerge.</span>
<span class="cm">		 *</span>
<span class="cm">		 * In those cases we don&#39;t try to register the device again.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_created</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_ac97_dev_register</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: AC97 device register failed:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_unregister_ac97_dai_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">soc_ac97_dev_unregister</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_check_aux_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_aux_dev</span> <span class="o">*</span><span class="n">aux_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aux_dev</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>

	<span class="cm">/* find CODEC from registered CODECs*/</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">aux_dev</span><span class="o">-&gt;</span><span class="n">codec_name</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_probe_aux_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_aux_dev</span> <span class="o">*</span><span class="n">aux_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aux_dev</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* find CODEC from registered CODECs*/</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">aux_dev</span><span class="o">-&gt;</span><span class="n">codec_name</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">probed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;asoc: codec already probed&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* codec not found */</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;asoc: codec %s not found&quot;</span><span class="p">,</span> <span class="n">aux_dev</span><span class="o">-&gt;</span><span class="n">codec_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_probe_codec</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_post_component_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">codec</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_remove_aux_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd_aux</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">;</span>

	<span class="cm">/* unregister the rtd device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_codec_reg</span><span class="p">);</span>
		<span class="n">device_del</span><span class="p">(</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtd</span><span class="o">-&gt;</span><span class="n">dev_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">probed</span><span class="p">)</span>
		<span class="n">soc_remove_codec</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_init_codec_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">snd_soc_compress_type</span> <span class="n">compress_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">cache_init</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* override the compress_type if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">compress_type</span> <span class="o">&amp;&amp;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">compress_type</span> <span class="o">!=</span> <span class="n">compress_type</span><span class="p">)</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">compress_type</span> <span class="o">=</span> <span class="n">compress_type</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_cache_init</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set cache compression type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">cache_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_instantiate_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec_conf</span> <span class="o">*</span><span class="n">codec_conf</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">snd_soc_compress_type</span> <span class="n">compress_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai_link</span> <span class="o">*</span><span class="n">dai_link</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">dai_fmt</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="n">SND_SOC_CARD_CLASS_INIT</span><span class="p">);</span>

	<span class="cm">/* bind DAIs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_bind_dai_link</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">base_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check aux_devs too */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_aux_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_check_aux_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">base_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize the register cache for each available codec */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">cache_init</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* by default we don&#39;t override the compress_type */</span>
		<span class="n">compress_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* check to see if we need to override the compress_type */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_configs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">codec_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_conf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">codec_conf</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">compress_type</span> <span class="o">=</span> <span class="n">codec_conf</span><span class="o">-&gt;</span><span class="n">compress_type</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">compress_type</span> <span class="o">&amp;&amp;</span> <span class="n">compress_type</span>
				    <span class="o">!=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">compress_type</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_init_codec_cache</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">compress_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">base_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* card bind complete so register a sound card */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">SNDRV_DEFAULT_IDX1</span><span class="p">,</span> <span class="n">SNDRV_DEFAULT_STR1</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: can&#39;t create sound card for card %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">base_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">=</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_list</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="n">snd_soc_dapm_debugfs_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_card_root</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
	<span class="cm">/* deferred resume work */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">deferred_resume_work</span><span class="p">,</span> <span class="n">soc_resume_deferred</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_widgets</span><span class="p">)</span>
		<span class="n">snd_soc_dapm_new_controls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_widgets</span><span class="p">,</span>
					  <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_dapm_widgets</span><span class="p">);</span>

	<span class="cm">/* initialise the sound card only once */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">card_probe_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* early DAI link probe */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="n">SND_SOC_COMP_ORDER_FIRST</span><span class="p">;</span> <span class="n">order</span> <span class="o">&lt;=</span> <span class="n">SND_SOC_COMP_ORDER_LAST</span><span class="p">;</span>
			<span class="n">order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_probe_dai_link</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: failed to instantiate card %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">probe_dai_err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_aux_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_probe_aux_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: failed to add auxiliary devices %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">probe_aux_dev_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_soc_dapm_link_dai_widgets</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">)</span>
		<span class="n">snd_soc_add_card_controls</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_controls</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_routes</span><span class="p">)</span>
		<span class="n">snd_soc_dapm_add_routes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_routes</span><span class="p">,</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_dapm_routes</span><span class="p">);</span>

	<span class="n">snd_soc_dapm_new_widgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dai_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dai_fmt</span> <span class="o">=</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">dai_fmt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dai_fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_fmt</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">codec_dai</span><span class="p">,</span>
						  <span class="n">dai_fmt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">codec_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;Failed to set DAI format: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* If this is a regular CPU link there will be a platform */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai_fmt</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">platform_name</span> <span class="o">||</span> <span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">platform_of_node</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_fmt</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu_dai</span><span class="p">,</span>
						  <span class="n">dai_fmt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;Failed to set DAI format: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dai_fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Flip the polarity for the &quot;CPU&quot; end */</span>
			<span class="n">dai_fmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dai_link</span><span class="o">-&gt;</span><span class="n">dai_fmt</span> <span class="o">&amp;</span>
				<span class="n">SND_SOC_DAIFMT_MASTER_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span>:
				<span class="n">dai_fmt</span> <span class="o">|=</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBM_CFS</span>:
				<span class="n">dai_fmt</span> <span class="o">|=</span> <span class="n">SND_SOC_DAIFMT_CBS_CFM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBS_CFM</span>:
				<span class="n">dai_fmt</span> <span class="o">|=</span> <span class="n">SND_SOC_DAIFMT_CBM_CFS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span>:
				<span class="n">dai_fmt</span> <span class="o">|=</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_dai_set_fmt</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu_dai</span><span class="p">,</span>
						  <span class="n">dai_fmt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu_dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;Failed to set DAI format: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">),</span>
		 <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">),</span>
		 <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">long_name</span> <span class="o">?</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">long_name</span> <span class="o">:</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">),</span>
		 <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">?</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">:</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;_&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;\0&#39;</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isalnum</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">late_probe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">late_probe</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s late_probe() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">probe_aux_dev_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_soc_dapm_new_widgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fully_routed</span><span class="p">)</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">codec_dev_list</span><span class="p">,</span> <span class="n">card_list</span><span class="p">)</span>
			<span class="n">snd_soc_dapm_auto_nc_codec_pins</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: failed to register soundcard for %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">probe_aux_dev_err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_SOC_AC97_BUS</span>
	<span class="cm">/* register any AC97 codecs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_register_ac97_dai_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: failed to register AC97 %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">soc_unregister_ac97_dai_link</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">codec</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">probe_aux_dev_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">instantiated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">probe_aux_dev_err:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_aux_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">soc_remove_aux_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

<span class="nl">probe_dai_err:</span>
	<span class="n">soc_remove_dai_links</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

<span class="nl">card_probe_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">);</span>

<span class="nl">base_error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* probes a new socdev */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * no card, so machine driver should be registering card</span>
<span class="cm">	 * we should not be here in that case so ret error</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;ASoC machine %s should use snd_soc_register_card()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Bodge while we unpick instantiation */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_register_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to register card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_cleanup_card_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* make sure any delayed work runs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">flush_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* remove auxiliary devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_aux_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">soc_remove_aux_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* remove and free each DAI */</span>
	<span class="n">soc_remove_dai_links</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">soc_cleanup_card_debugfs</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* remove the card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">snd_soc_dapm_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">);</span>

	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* removes a socdev */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">snd_soc_unregister_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_soc_poweroff</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">instantiated</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Flush out pmdown_time work - we actually do want to run it</span>
<span class="cm">	 * now, we&#39;re shutting down so no imminent restart. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span> <span class="o">*</span><span class="n">rtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">flush_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtd</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_soc_dapm_shutdown</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_poweroff</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">snd_soc_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">snd_soc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">snd_soc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">snd_soc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">snd_soc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poweroff</span> <span class="o">=</span> <span class="n">snd_soc_poweroff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">snd_soc_resume</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_pm_ops</span><span class="p">);</span>

<span class="cm">/* ASoC platform driver */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">soc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;soc-audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_soc_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">soc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">soc_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_codec_volatile_register: Report if a register is volatile.</span>
<span class="cm"> *</span>
<span class="cm"> * @codec: CODEC to query.</span>
<span class="cm"> * @reg: Register to query.</span>
<span class="cm"> *</span>
<span class="cm"> * Boolean function indiciating if a CODEC register is volatile.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_codec_volatile_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">volatile_register</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">volatile_register</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_codec_volatile_register</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_codec_readable_register: Report if a register is readable.</span>
<span class="cm"> *</span>
<span class="cm"> * @codec: CODEC to query.</span>
<span class="cm"> * @reg: Register to query.</span>
<span class="cm"> *</span>
<span class="cm"> * Boolean function indicating if a CODEC register is readable.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_codec_readable_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">readable_register</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">readable_register</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_codec_readable_register</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_codec_writable_register: Report if a register is writable.</span>
<span class="cm"> *</span>
<span class="cm"> * @codec: CODEC to query.</span>
<span class="cm"> * @reg: Register to query.</span>
<span class="cm"> *</span>
<span class="cm"> * Boolean function indicating if a CODEC register is writable.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_codec_writable_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">writable_register</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">writable_register</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_codec_writable_register</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">snd_soc_platform_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform has no read back</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read %x =&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">trace_snd_soc_preg_read</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_platform_read</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">snd_soc_platform_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform has no write back</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;write %x = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">trace_snd_soc_preg_write</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_platform_write</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_new_ac97_codec - initailise AC97 device</span>
<span class="cm"> * @codec: audio codec</span>
<span class="cm"> * @ops: AC97 bus operations</span>
<span class="cm"> * @num: AC97 codec number</span>
<span class="cm"> *</span>
<span class="cm"> * Initialises AC97 codec resources for use by ad-hoc devices only.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_new_ac97_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mark the AC97 device to be created by us. This way we ensure that the</span>
<span class="cm">	 * device will be registered with the device subsystem later on.</span>
<span class="cm">	 */</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_created</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_new_ac97_codec</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_free_ac97_codec - free AC97 codec device</span>
<span class="cm"> * @codec: audio codec</span>
<span class="cm"> *</span>
<span class="cm"> * Frees AC97 codec device resources.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_soc_free_ac97_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_SOC_AC97_BUS</span>
	<span class="n">soc_unregister_ac97_dai_link</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ac97_created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_free_ac97_codec</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_soc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read %x =&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">trace_snd_soc_reg_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_read</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_soc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;write %x = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">trace_snd_soc_reg_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_write</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_soc_bulk_write_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">bulk_write_raw</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_bulk_write_raw</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_update_bits - update codec register bits</span>
<span class="cm"> * @codec: audio codec</span>
<span class="cm"> * @reg: codec register</span>
<span class="cm"> * @mask: register mask</span>
<span class="cm"> * @value: new value</span>
<span class="cm"> *</span>
<span class="cm"> * Writes new register value.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 for change, 0 for no change, or negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_update_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">using_regmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_update_bits_check</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">control_data</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
					       <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">change</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">old</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_write</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_update_bits</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_update_bits_locked - update codec register bits</span>
<span class="cm"> * @codec: audio codec</span>
<span class="cm"> * @reg: codec register</span>
<span class="cm"> * @mask: register mask</span>
<span class="cm"> * @value: new value</span>
<span class="cm"> *</span>
<span class="cm"> * Writes new register value, and takes the codec mutex.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 for change else 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_update_bits_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">snd_soc_update_bits</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_update_bits_locked</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_test_bits - test register for change</span>
<span class="cm"> * @codec: audio codec</span>
<span class="cm"> * @reg: codec register</span>
<span class="cm"> * @mask: register mask</span>
<span class="cm"> * @value: new value</span>
<span class="cm"> *</span>
<span class="cm"> * Tests a register with a new value and checks if the new value is</span>
<span class="cm"> * different from the old value.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 for change else 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_test_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_test_bits</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_set_runtime_hwparams - set the runtime hardware parameters</span>
<span class="cm"> * @substream: the pcm substream</span>
<span class="cm"> * @hw: the hardware parameters</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the substream runtime hardware parameters.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_set_runtime_hwparams</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">period_bytes_min</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">period_bytes_max</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">periods_min</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">periods_max</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">buffer_bytes_max</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_set_runtime_hwparams</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_cnew - create new control</span>
<span class="cm"> * @_template: control template</span>
<span class="cm"> * @data: control private data</span>
<span class="cm"> * @long_name: control long name</span>
<span class="cm"> * @prefix: control name prefix</span>
<span class="cm"> *</span>
<span class="cm"> * Create a new mixer control from a template control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, else error.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="nf">snd_soc_cnew</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">_template</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">long_name</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">template</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="n">_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">template</span><span class="p">));</span>
	<span class="n">template</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">long_name</span><span class="p">)</span>
		<span class="n">long_name</span> <span class="o">=</span> <span class="n">template</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">long_name</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">name_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span> <span class="s">&quot;%s %s&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">long_name</span><span class="p">);</span>

		<span class="n">template</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">template</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">long_name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kcontrol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">kcontrol</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_cnew</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_soc_add_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">controls</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_controls</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_controls</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_soc_cnew</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
						     <span class="n">control</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to add %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_add_codec_controls - add an array of controls to a codec.</span>
<span class="cm"> * Convenience function to add a list of controls. Many codecs were</span>
<span class="cm"> * duplicating this code.</span>
<span class="cm"> *</span>
<span class="cm"> * @codec: codec to add controls to</span>
<span class="cm"> * @controls: array of controls to add</span>
<span class="cm"> * @num_controls: number of elements in the array</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 for success, else error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_add_codec_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">controls</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_controls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_soc_add_controls</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">controls</span><span class="p">,</span> <span class="n">num_controls</span><span class="p">,</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name_prefix</span><span class="p">,</span> <span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_add_codec_controls</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_add_platform_controls - add an array of controls to a platform.</span>
<span class="cm"> * Convenience function to add a list of controls.</span>
<span class="cm"> *</span>
<span class="cm"> * @platform: platform to add controls to</span>
<span class="cm"> * @controls: array of controls to add</span>
<span class="cm"> * @num_controls: number of elements in the array</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 for success, else error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_add_platform_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">controls</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_controls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_soc_add_controls</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">controls</span><span class="p">,</span> <span class="n">num_controls</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="n">platform</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_add_platform_controls</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_add_card_controls - add an array of controls to a SoC card.</span>
<span class="cm"> * Convenience function to add a list of controls.</span>
<span class="cm"> *</span>
<span class="cm"> * @soc_card: SoC card to add controls to</span>
<span class="cm"> * @controls: array of controls to add</span>
<span class="cm"> * @num_controls: number of elements in the array</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 for success, else error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_add_card_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">soc_card</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">controls</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_controls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">soc_card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_soc_add_controls</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">soc_card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">controls</span><span class="p">,</span> <span class="n">num_controls</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="n">soc_card</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_add_card_controls</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_add_dai_controls - add an array of controls to a DAI.</span>
<span class="cm"> * Convienience function to add a list of controls.</span>
<span class="cm"> *</span>
<span class="cm"> * @dai: DAI to add controls to</span>
<span class="cm"> * @controls: array of controls to add</span>
<span class="cm"> * @num_controls: number of elements in the array</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 for success, else error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_add_dai_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">controls</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_controls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_soc_add_controls</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">controls</span><span class="p">,</span> <span class="n">num_controls</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="n">dai</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_add_dai_controls</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_info_enum_double - enumerated double mixer info callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @uinfo: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to provide information about a double enumerated</span>
<span class="cm"> * mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_info_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_info_enum_double</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_get_enum_double - enumerated double mixer get callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to get the value of a double enumerated mixer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_get_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_get_enum_double</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_put_enum_double - enumerated double mixer put callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to set the value of a double enumerated mixer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_put_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">bitmask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_put_enum_double</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_get_value_enum_double - semi enumerated double mixer get callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to get the value of a double semi enumerated mixer.</span>
<span class="cm"> *</span>
<span class="cm"> * Semi enumerated mixer: the enumerated items are referred as values. Can be</span>
<span class="cm"> * used for handling bitfield coded enumeration for example.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_get_value_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mux</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mux</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">mux</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">mux</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mux</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&gt;&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mux</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span> <span class="n">mux</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">mux</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mux</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_get_value_enum_double</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_put_value_enum_double - semi enumerated double mixer put callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to set the value of a double semi enumerated mixer.</span>
<span class="cm"> *</span>
<span class="cm"> * Semi enumerated mixer: the enumerated items are referred as values. Can be</span>
<span class="cm"> * used for handling bitfield coded enumeration for example.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_put_value_enum_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_l</span> <span class="o">!=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">shift_r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_put_value_enum_double</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_info_enum_ext - external enumerated single mixer info callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @uinfo: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to provide information about an external enumerated</span>
<span class="cm"> * single mixer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_info_enum_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_enum</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_info_enum_ext</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_info_volsw_ext - external single mixer info callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @uinfo: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to provide information about a single external mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_info_volsw_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strstr</span><span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot; Volume&quot;</span><span class="p">))</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_info_volsw_ext</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_info_volsw - single mixer info callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @uinfo: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to provide information about a single mixer control, or a double</span>
<span class="cm"> * mixer control that spans 2 registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_info_volsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">platform_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">platform_max</span><span class="p">)</span>
		<span class="n">mc</span><span class="o">-&gt;</span><span class="n">platform_max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="n">platform_max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">platform_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_max</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strstr</span><span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot; Volume&quot;</span><span class="p">))</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">snd_soc_volsw_is_stereo</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">platform_max</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_info_volsw</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_get_volsw - single mixer get callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to get the value of a single mixer control, or a double mixer</span>
<span class="cm"> * control that spans 2 registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_get_volsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rreg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fls</span><span class="p">(</span><span class="n">max</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">max</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_soc_volsw_is_stereo</span><span class="p">(</span><span class="n">mc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">reg2</span><span class="p">)</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">rshift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">max</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_get_volsw</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_put_volsw - single mixer put callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to set the value of a single mixer control, or a double mixer</span>
<span class="cm"> * control that spans 2 registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_put_volsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rreg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fls</span><span class="p">(</span><span class="n">max</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">type_2r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_soc_volsw_is_stereo</span><span class="p">(</span><span class="n">mc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">val2</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="n">val2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">reg2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val_mask</span> <span class="o">|=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">val2</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val2</span> <span class="o">=</span> <span class="n">val2</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
			<span class="n">type_2r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type_2r</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg2</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_put_volsw</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_get_volsw_sx - single mixer get callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to get the value of a single mixer control, or a double mixer</span>
<span class="cm"> * control that spans 2 registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_get_volsw_sx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rreg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">fls</span><span class="p">(</span><span class="n">min</span> <span class="o">+</span> <span class="n">max</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="n">min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_soc_volsw_is_stereo</span><span class="p">(</span><span class="n">mc</span><span class="p">))</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">rshift</span><span class="p">)</span> <span class="o">-</span> <span class="n">min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_get_volsw_sx</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_put_volsw_sx - double mixer set callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @uinfo: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to set the value of a double mixer control that spans 2 registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_put_volsw_sx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rreg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">rshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">fls</span><span class="p">(</span><span class="n">min</span> <span class="o">+</span> <span class="n">max</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_soc_volsw_is_stereo</span><span class="p">(</span><span class="n">mc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">val2</span> <span class="o">&lt;&lt;</span> <span class="n">rshift</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg2</span><span class="p">,</span> <span class="n">val_mask</span><span class="p">,</span> <span class="n">val2</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_put_volsw_sx</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_info_volsw_s8 - signed mixer info callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @uinfo: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to provide information about a signed mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_info_volsw_s8</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">platform_max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">platform_max</span><span class="p">)</span>
		<span class="n">mc</span><span class="o">-&gt;</span><span class="n">platform_max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="n">platform_max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">platform_max</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">platform_max</span> <span class="o">-</span> <span class="n">min</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_info_volsw_s8</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_get_volsw_s8 - signed mixer get callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to get the value of a signed mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_get_volsw_s8</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">((</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">)(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span><span class="o">-</span><span class="n">min</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">((</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">)((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span><span class="o">-</span><span class="n">min</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_get_volsw_s8</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_put_volsw_sgn - signed mixer put callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to set the value of a signed mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_put_volsw_s8</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_put_volsw_s8</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_limit_volume - Set new limit to an existing volume control.</span>
<span class="cm"> *</span>
<span class="cm"> * @codec: where to look for the control</span>
<span class="cm"> * @name: Name of the control</span>
<span class="cm"> * @max: new maximum limit</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 for success, else error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_limit_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">snd_card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Sanity check for name and max */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">name</span> <span class="o">||</span> <span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">kctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mc</span><span class="o">-&gt;</span><span class="n">platform_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_limit_volume</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">snd_soc_bytes_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_bytes</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BYTES</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_regs</span> <span class="o">*</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">val_bytes</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_bytes_info</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">snd_soc_bytes_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_bytes</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">using_regmap</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_raw_read</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">control_data</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
				      <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
				      <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_regs</span> <span class="o">*</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">val_bytes</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Hide any masked bytes to ensure consistent data reporting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">val_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
				<span class="o">&amp;=</span> <span class="o">~</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
				<span class="o">&amp;=</span> <span class="o">~</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_bytes_get</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">snd_soc_bytes_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_bytes</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">using_regmap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_regs</span> <span class="o">*</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">val_bytes</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;ve got a mask then we need to preserve the register</span>
<span class="cm">	 * bits.  We shouldn&#39;t modify the incoming data so take a</span>
<span class="cm">	 * copy.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_read</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">control_data</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">val_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
			<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="o">~</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
			<span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="o">~</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_raw_write</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">control_data</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
			       <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_bytes_put</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_info_xr_sx - signed multi register info callback</span>
<span class="cm"> * @kcontrol: mreg control</span>
<span class="cm"> * @uinfo: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to provide information of a control that can</span>
<span class="cm"> * span multiple codec registers which together</span>
<span class="cm"> * forms a single signed value in a MSB/LSB manner.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_info_xr_sx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mreg_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mreg_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_info_xr_sx</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_get_xr_sx - signed multi register get callback</span>
<span class="cm"> * @kcontrol: mreg control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to get the value of a control that can span</span>
<span class="cm"> * multiple codec registers which together forms a single</span>
<span class="cm"> * signed value in a MSB/LSB manner. The control supports</span>
<span class="cm"> * specifying total no of bits used to allow for bitfields</span>
<span class="cm"> * across the multiple codec registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_get_xr_sx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mreg_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mreg_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regbase</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regcount</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">regcount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regwshift</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_word_size</span> <span class="o">*</span> <span class="n">BITS_PER_BYTE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regwmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">regwshift</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">min</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">regcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">regbase</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">regwmask</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">regval</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">regwshift</span><span class="o">*</span><span class="p">(</span><span class="n">regcount</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_get_xr_sx</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_put_xr_sx - signed multi register get callback</span>
<span class="cm"> * @kcontrol: mreg control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback to set the value of a control that can span</span>
<span class="cm"> * multiple codec registers which together forms a single</span>
<span class="cm"> * signed value in a MSB/LSB manner. The control supports</span>
<span class="cm"> * specifying total no of bits used to allow for bitfields</span>
<span class="cm"> * across the multiple codec registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_put_xr_sx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mreg_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mreg_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regbase</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regcount</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">regcount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regwshift</span> <span class="o">=</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reg_word_size</span> <span class="o">*</span> <span class="n">BITS_PER_BYTE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regwmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">regwshift</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">max</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">regval</span><span class="p">,</span> <span class="n">regmask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">regcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">regwshift</span><span class="o">*</span><span class="p">(</span><span class="n">regcount</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">regwmask</span><span class="p">;</span>
		<span class="n">regmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">regwshift</span><span class="o">*</span><span class="p">(</span><span class="n">regcount</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">regwmask</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">regbase</span><span class="o">+</span><span class="n">i</span><span class="p">,</span>
				<span class="n">regmask</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_put_xr_sx</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_get_strobe - strobe get callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback get the value of a strobe mixer control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_get_strobe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">invert</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">snd_soc_read</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">^</span> <span class="n">invert</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_get_strobe</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_put_strobe - strobe put callback</span>
<span class="cm"> * @kcontrol: mixer control</span>
<span class="cm"> * @ucontrol: control element information</span>
<span class="cm"> *</span>
<span class="cm"> * Callback strobe a register bit to high then low (or the inverse)</span>
<span class="cm"> * in one pass of a single mixer enum control.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_put_strobe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">soc_mixer_control</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">invert</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strobe</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val1</span> <span class="o">=</span> <span class="p">(</span><span class="n">strobe</span> <span class="o">^</span> <span class="n">invert</span><span class="p">)</span> <span class="o">?</span> <span class="n">mask</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val2</span> <span class="o">=</span> <span class="p">(</span><span class="n">strobe</span> <span class="o">^</span> <span class="n">invert</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_soc_update_bits_locked</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_put_strobe</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dai_set_sysclk - configure DAI system or master clock.</span>
<span class="cm"> * @dai: DAI</span>
<span class="cm"> * @clk_id: DAI specific clock ID</span>
<span class="cm"> * @freq: new clock frequency in Hz</span>
<span class="cm"> * @dir: new clock direction - input/output.</span>
<span class="cm"> *</span>
<span class="cm"> * Configures the DAI master (MCLK) or system (SYSCLK) clocking.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dai_set_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clk_id</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_sysclk</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_sysclk</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">clk_id</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_sysclk</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_sysclk</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">clk_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						      <span class="n">freq</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dai_set_sysclk</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_codec_set_sysclk - configure CODEC system or master clock.</span>
<span class="cm"> * @codec: CODEC</span>
<span class="cm"> * @clk_id: DAI specific clock ID</span>
<span class="cm"> * @source: Source for the clock</span>
<span class="cm"> * @freq: new clock frequency in Hz</span>
<span class="cm"> * @dir: new clock direction - input/output.</span>
<span class="cm"> *</span>
<span class="cm"> * Configures the CODEC master (MCLK) or system (SYSCLK) clocking.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_codec_set_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clk_id</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">source</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_sysclk</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_sysclk</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">clk_id</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
						 <span class="n">freq</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_codec_set_sysclk</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dai_set_clkdiv - configure DAI clock dividers.</span>
<span class="cm"> * @dai: DAI</span>
<span class="cm"> * @div_id: DAI specific clock divider ID</span>
<span class="cm"> * @div: new clock divisor.</span>
<span class="cm"> *</span>
<span class="cm"> * Configures the clock dividers. This is used to derive the best DAI bit and</span>
<span class="cm"> * frame clocks from the system or master clock. It&#39;s best to set the DAI bit</span>
<span class="cm"> * and frame clocks as low as possible to save system power.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dai_set_clkdiv</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">div_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_clkdiv</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_clkdiv</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">div_id</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dai_set_clkdiv</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dai_set_pll - configure DAI PLL.</span>
<span class="cm"> * @dai: DAI</span>
<span class="cm"> * @pll_id: DAI specific PLL ID</span>
<span class="cm"> * @source: DAI specific source for the PLL</span>
<span class="cm"> * @freq_in: PLL input clock frequency in Hz</span>
<span class="cm"> * @freq_out: requested PLL output clock frequency in Hz</span>
<span class="cm"> *</span>
<span class="cm"> * Configures and enables PLL to generate output clock based on input clock.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dai_set_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pll_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">source</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">pll_id</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
					 <span class="n">freq_in</span><span class="p">,</span> <span class="n">freq_out</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">pll_id</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
						   <span class="n">freq_in</span><span class="p">,</span> <span class="n">freq_out</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dai_set_pll</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * snd_soc_codec_set_pll - configure codec PLL.</span>
<span class="cm"> * @codec: CODEC</span>
<span class="cm"> * @pll_id: DAI specific PLL ID</span>
<span class="cm"> * @source: DAI specific source for the PLL</span>
<span class="cm"> * @freq_in: PLL input clock frequency in Hz</span>
<span class="cm"> * @freq_out: requested PLL output clock frequency in Hz</span>
<span class="cm"> *</span>
<span class="cm"> * Configures and enables PLL to generate output clock based on input clock.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_codec_set_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pll_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">source</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">pll_id</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
					      <span class="n">freq_in</span><span class="p">,</span> <span class="n">freq_out</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_codec_set_pll</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dai_set_fmt - configure DAI hardware audio format.</span>
<span class="cm"> * @dai: DAI</span>
<span class="cm"> * @fmt: SND_SOC_DAIFMT_ format value.</span>
<span class="cm"> *</span>
<span class="cm"> * Configures the DAI hardware format and clocking.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dai_set_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_fmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_fmt</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dai_set_fmt</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dai_set_tdm_slot - configure DAI TDM.</span>
<span class="cm"> * @dai: DAI</span>
<span class="cm"> * @tx_mask: bitmask representing active TX slots.</span>
<span class="cm"> * @rx_mask: bitmask representing active RX slots.</span>
<span class="cm"> * @slots: Number of slots in use.</span>
<span class="cm"> * @slot_width: Width in bits for each slot.</span>
<span class="cm"> *</span>
<span class="cm"> * Configures a DAI for TDM operation. Both mask and slots are codec and DAI</span>
<span class="cm"> * specific.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dai_set_tdm_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slots</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_tdm_slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_tdm_slot</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">tx_mask</span><span class="p">,</span> <span class="n">rx_mask</span><span class="p">,</span>
				<span class="n">slots</span><span class="p">,</span> <span class="n">slot_width</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dai_set_tdm_slot</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dai_set_channel_map - configure DAI audio channel map</span>
<span class="cm"> * @dai: DAI</span>
<span class="cm"> * @tx_num: how many TX channels</span>
<span class="cm"> * @tx_slot: pointer to an array which imply the TX slot number channel</span>
<span class="cm"> *           0~num-1 uses</span>
<span class="cm"> * @rx_num: how many RX channels</span>
<span class="cm"> * @rx_slot: pointer to an array which imply the RX slot number channel</span>
<span class="cm"> *           0~num-1 uses</span>
<span class="cm"> *</span>
<span class="cm"> * configure the relationship between channel number and TDM slot number.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dai_set_channel_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_num</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tx_slot</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_num</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rx_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_channel_map</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_channel_map</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">tx_num</span><span class="p">,</span> <span class="n">tx_slot</span><span class="p">,</span>
			<span class="n">rx_num</span><span class="p">,</span> <span class="n">rx_slot</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dai_set_channel_map</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dai_set_tristate - configure DAI system or master clock.</span>
<span class="cm"> * @dai: DAI</span>
<span class="cm"> * @tristate: tristate enable</span>
<span class="cm"> *</span>
<span class="cm"> * Tristates the DAI so that others can use it.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dai_set_tristate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tristate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_tristate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_tristate</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">tristate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dai_set_tristate</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_dai_digital_mute - configure DAI system or master clock.</span>
<span class="cm"> * @dai: DAI</span>
<span class="cm"> * @mute: mute enable</span>
<span class="cm"> *</span>
<span class="cm"> * Mutes the DAI DAC.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_dai_digital_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">digital_mute</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">digital_mute</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="n">mute</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_dai_digital_mute</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_register_card - Register a card with the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @card: Card to register</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_register_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">||</span> <span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * Codec must be specified by 1 of name or OF node,</span>
<span class="cm">		 * not both or neither.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">codec_name</span> <span class="o">==</span> <span class="o">!!</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">codec_of_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Neither/both codec name/of_node are set for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Platform may be specified by either name or OF node, but</span>
<span class="cm">		 * can be left unspecified, and a dummy platform will be used.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">platform_name</span> <span class="o">&amp;&amp;</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">platform_of_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Both platform name/of_node are set for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * CPU DAI must be specified by 1 of name or OF node,</span>
<span class="cm">		 * not both or neither.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">cpu_dai_name</span> <span class="o">==</span> <span class="o">!!</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">cpu_dai_of_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Neither/both cpu_dai name/of_node are set for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="n">snd_soc_initialize_card_lists</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">soc_init_card_debugfs</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_runtime</span><span class="p">)</span> <span class="o">*</span>
				 <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_aux_devs</span><span class="p">),</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rtd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd_aux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_links</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rtd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dai_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dai_link</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_dirty</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">instantiated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_instantiate_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">soc_cleanup_card_debugfs</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_register_card</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_unregister_card - Unregister a card with the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @card: Card to unregister</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_unregister_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">instantiated</span><span class="p">)</span>
		<span class="n">soc_cleanup_card_resources</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unregistered card &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_unregister_card</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Simplify DAI link configuration by removing &quot;.-1&quot; from device names</span>
<span class="cm"> * and sanitizing names.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">fmt_single_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">found</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="n">NAME_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">NAME_SIZE</span><span class="p">);</span>

	<span class="cm">/* are we a &quot;%s.%d&quot; name (platform and SPI components) */</span>
	<span class="n">found</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get ID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">found</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)],</span> <span class="s">&quot;.%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* discard ID from name if ID == -1 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">found</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I2C component devices are named &quot;bus-addr&quot;  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%x-%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="n">NAME_SIZE</span><span class="p">];</span>

			<span class="cm">/* create unique ID number from I2C addr and bus */</span>
			<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="n">id1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">id2</span><span class="p">;</span>

			<span class="cm">/* sanitize component name for DAI link creation */</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">NAME_SIZE</span><span class="p">,</span> <span class="s">&quot;%s.%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NAME_SIZE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Simplify DAI link naming for single devices with multiple DAIs by removing</span>
<span class="cm"> * any &quot;.-1&quot; and using the DAI name (instead of device name).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">fmt_multiple_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">dai_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai_drv</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;asoc: error - multiple DAI %s registered with no name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">dai_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_register_dai - Register a DAI with the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @dai: DAI to register</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_register_dai</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">dai_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dai register %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">dai</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* create DAI component name */</span>
	<span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">fmt_single_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">dai_drv</span><span class="p">;</span>
	<span class="n">dai</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">null_dai_ops</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mapped DAI %s to CODEC %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai_list</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Registered DAI &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_register_dai</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_unregister_dai - Unregister a DAI from the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @dai: DAI to unregister</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_soc_unregister_dai</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Unregistered DAI &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_unregister_dai</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_register_dais - Register multiple DAIs with the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @dai: Array of DAIs to register</span>
<span class="cm"> * @count: Number of DAIs</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_register_dais</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">dai_drv</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dai register %s #%Zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dai</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_dai</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* create DAI component name */</span>
		<span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">fmt_multiple_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai_drv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dai</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dai_drv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dai</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dai</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
			<span class="n">dai</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">null_dai_ops</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mapped DAI %s to CODEC %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dai</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dai_list</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Registered DAI &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dai</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">snd_soc_unregister_dai</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_register_dais</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_unregister_dais - Unregister multiple DAIs from the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @dai: Array of DAIs to unregister</span>
<span class="cm"> * @count: Number of DAIs</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_soc_unregister_dais</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_soc_unregister_dai</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_unregister_dais</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_register_platform - Register a platform with the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @platform: platform to register</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_register_platform</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_soc_platform_driver</span> <span class="o">*</span><span class="n">platform_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform register %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">platform</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_platform</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* create platform component name */</span>
	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">fmt_single_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">platform</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">platform_drv</span><span class="p">;</span>
	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span><span class="p">;</span>
	<span class="n">platform</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">stream_event</span> <span class="o">=</span> <span class="n">platform_drv</span><span class="o">-&gt;</span><span class="n">stream_event</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Registered platform &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_register_platform</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_unregister_platform - Unregister a platform from the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @platform: platform to unregister</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_soc_unregister_platform</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_platform</span> <span class="o">*</span><span class="n">platform</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Unregistered platform &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">platform</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_unregister_platform</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">codec_format_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_U16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_S24_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S24_BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_U24_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U24_BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_S32_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S32_BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_U32_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U32_BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_S24_3LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U24_3BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_U24_3LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U24_3BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_S20_3LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S20_3BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_U20_3LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U20_3BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_S18_3LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S18_3BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_U18_3LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U18_3BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_FLOAT_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_FLOAT_BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_FLOAT64_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_FLOAT64_BE</span><span class="p">,</span>
	<span class="n">SNDRV_PCM_FMTBIT_IEC958_SUBFRAME_LE</span>
	<span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_IEC958_SUBFRAME_BE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Fix up the DAI formats for endianness: codecs don&#39;t actually see</span>
<span class="cm"> * the endianness of the data but we&#39;re using the CPU format</span>
<span class="cm"> * definitions which do need to include endianness so we ensure that</span>
<span class="cm"> * codec DAIs always have both big and little endian variants set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fixup_codec_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_pcm_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">codec_format_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">formats</span> <span class="o">&amp;</span> <span class="n">codec_format_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">formats</span> <span class="o">|=</span> <span class="n">codec_format_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_register_codec - Register a codec with the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @codec: codec to register</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snd_soc_register_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_soc_codec_driver</span> <span class="o">*</span><span class="n">codec_drv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_soc_dai_driver</span> <span class="o">*</span><span class="n">dai_drv</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">num_dai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">reg_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;codec register %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">codec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_codec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* create CODEC component name */</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">fmt_single_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">compress_type</span><span class="p">)</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">compress_type</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">compress_type</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">compress_type</span> <span class="o">=</span> <span class="n">SND_SOC_FLAT_COMPRESSION</span><span class="p">;</span>

	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">volatile_register</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">volatile_register</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">readable_register</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">readable_register</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">writable_register</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">writable_register</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">ignore_pmdown_time</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">ignore_pmdown_time</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">bias_level</span> <span class="o">=</span> <span class="n">SND_SOC_BIAS_OFF</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">seq_notifier</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">seq_notifier</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">.</span><span class="n">stream_event</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">stream_event</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="p">;</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_dai</span> <span class="o">=</span> <span class="n">num_dai</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* allocate CODEC register cache */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">reg_cache_size</span> <span class="o">&amp;&amp;</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">reg_word_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_size</span> <span class="o">=</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">reg_cache_size</span> <span class="o">*</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">reg_word_size</span><span class="p">;</span>
		<span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_size</span> <span class="o">=</span> <span class="n">reg_size</span><span class="p">;</span>
		<span class="cm">/* it is necessary to make a copy of the default register cache</span>
<span class="cm">		 * because in the case of using a compression type that requires</span>
<span class="cm">		 * the default register cache to be marked as __devinitconst the</span>
<span class="cm">		 * kernel might have freed the array by the time we initialize</span>
<span class="cm">		 * the cache.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">reg_cache_default</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_def_copy</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">reg_cache_default</span><span class="p">,</span>
						      <span class="n">reg_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_def_copy</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">reg_access_size</span> <span class="o">&amp;&amp;</span> <span class="n">codec_drv</span><span class="o">-&gt;</span><span class="n">reg_access_default</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">volatile_register</span><span class="p">)</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">volatile_register</span> <span class="o">=</span> <span class="n">snd_soc_default_volatile_register</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">readable_register</span><span class="p">)</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">readable_register</span> <span class="o">=</span> <span class="n">snd_soc_default_readable_register</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">writable_register</span><span class="p">)</span>
			<span class="n">codec</span><span class="o">-&gt;</span><span class="n">writable_register</span> <span class="o">=</span> <span class="n">snd_soc_default_writable_register</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_dai</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fixup_codec_formats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dai_drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">playback</span><span class="p">);</span>
		<span class="n">fixup_codec_formats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dai_drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">capture</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>

	<span class="cm">/* register any DAIs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_dai</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_soc_register_dais</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dai_drv</span><span class="p">,</span> <span class="n">num_dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to regster DAIs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Registered codec &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_def_copy</span><span class="p">);</span>
	<span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_def_copy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_register_codec</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snd_soc_unregister_codec - Unregister a codec from the ASoC core</span>
<span class="cm"> *</span>
<span class="cm"> * @codec: codec to unregister</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">snd_soc_unregister_codec</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soc_codec</span> <span class="o">*</span><span class="n">codec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_dai</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">num_dai</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">snd_soc_unregister_dai</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_mutex</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Unregistered codec &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">snd_soc_cache_exit</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">reg_def_copy</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codec</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_unregister_codec</span><span class="p">);</span>

<span class="cm">/* Retrieve a card&#39;s name from device tree */</span>
<span class="kt">int</span> <span class="nf">snd_soc_of_parse_card_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">propname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">of_property_read_string_index</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">propname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * EINVAL means the property does not exist. This is fine providing</span>
<span class="cm">	 * card-&gt;name was previously set, which is checked later in</span>
<span class="cm">	 * snd_soc_register_card.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Property &#39;%s&#39; could not be read: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">propname</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_of_parse_card_name</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">snd_soc_of_parse_audio_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">propname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_routes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soc_dapm_route</span> <span class="o">*</span><span class="n">routes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">num_routes</span> <span class="o">=</span> <span class="n">of_property_count_strings</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">propname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_routes</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num_routes</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		     <span class="s">&quot;Property &#39;%s&#39; does not exist or its length is not even</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">propname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">num_routes</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_routes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Property &#39;%s&#39;s length is zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">propname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">routes</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">num_routes</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">routes</span><span class="p">),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">routes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Could not allocate DAPM route table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_routes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">of_property_read_string_index</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">propname</span><span class="p">,</span>
			<span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">routes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sink</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Property &#39;%s&#39; index %d could not be read: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">propname</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">of_property_read_string_index</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">propname</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">routes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">source</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Property &#39;%s&#39; index %d could not be read: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">propname</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_dapm_routes</span> <span class="o">=</span> <span class="n">num_routes</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm_routes</span> <span class="o">=</span> <span class="n">routes</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_of_parse_audio_routing</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">snd_soc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="n">snd_soc_debugfs_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;asoc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">snd_soc_debugfs_root</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">snd_soc_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;ASoC: Failed to create debugfs directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_soc_debugfs_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;codecs&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">snd_soc_debugfs_root</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">codec_list_fops</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;ASoC: Failed to create CODEC list debugfs file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;dais&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">snd_soc_debugfs_root</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">dai_list_fops</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;ASoC: Failed to create DAI list debugfs file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;platforms&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">snd_soc_debugfs_root</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">platform_list_fops</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;ASoC: Failed to create platform list debugfs file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">snd_soc_util_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">snd_soc_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">snd_soc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_soc_util_exit</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">snd_soc_debugfs_root</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">snd_soc_exit</span><span class="p">);</span>

<span class="cm">/* Module information */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Liam Girdwood, lrg@slimlogic.co.uk&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ALSA SoC Core&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:soc-audio&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
