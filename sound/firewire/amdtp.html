<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › firewire › amdtp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>amdtp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Audio and Music Data Transmission Protocol (IEC 61883-6) streams</span>
<span class="cm"> * with Common Isochronous Packet (IEC 61883-1) headers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) Clemens Ladisch &lt;clemens@ladisch.de&gt;</span>
<span class="cm"> * Licensed under the terms of the GNU General Public License, version 2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/firewire.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &quot;amdtp.h&quot;</span>

<span class="cp">#define TICKS_PER_CYCLE		3072</span>
<span class="cp">#define CYCLES_PER_SECOND	8000</span>
<span class="cp">#define TICKS_PER_SECOND	(TICKS_PER_CYCLE * CYCLES_PER_SECOND)</span>

<span class="cp">#define TRANSFER_DELAY_TICKS	0x2e00 </span><span class="cm">/* 479.17 µs */</span><span class="cp"></span>

<span class="cp">#define TAG_CIP			1</span>

<span class="cp">#define CIP_EOH			(1u &lt;&lt; 31)</span>
<span class="cp">#define CIP_FMT_AM		(0x10 &lt;&lt; 24)</span>
<span class="cp">#define AMDTP_FDF_AM824		(0 &lt;&lt; 19)</span>
<span class="cp">#define AMDTP_FDF_SFC_SHIFT	16</span>

<span class="cm">/* TODO: make these configurable */</span>
<span class="cp">#define INTERRUPT_INTERVAL	16</span>
<span class="cp">#define QUEUE_LENGTH		48</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">pcm_period_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_init - initialize an AMDTP output stream structure</span>
<span class="cm"> * @s: the AMDTP output stream to initialize</span>
<span class="cm"> * @unit: the target of the stream</span>
<span class="cm"> * @flags: the packet transmission method to use</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">amdtp_out_stream_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_unit</span> <span class="o">*</span><span class="n">unit</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">cip_out_flags</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">CIP_NONBLOCKING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">fw_unit_get</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">period_tasklet</span><span class="p">,</span> <span class="n">pcm_period_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">s</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_init</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_destroy - free stream resources</span>
<span class="cm"> * @s: the AMDTP output stream to destroy</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">amdtp_out_stream_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">fw_unit_put</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_destroy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_set_rate - set the sample rate</span>
<span class="cm"> * @s: the AMDTP output stream to configure</span>
<span class="cm"> * @rate: the sample rate</span>
<span class="cm"> *</span>
<span class="cm"> * The sample rate must be set before the stream is started, and must not be</span>
<span class="cm"> * changed while the stream is running.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">amdtp_out_stream_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">syt_interval</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">rate_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">CIP_SFC_32000</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>  <span class="mi">32000</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_44100</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>  <span class="mi">44100</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_48000</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>  <span class="mi">48000</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_88200</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>  <span class="mi">88200</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_96000</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>  <span class="mi">96000</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_176400</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">176400</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_192000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">192000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sfc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sfc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sfc</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rate_info</span><span class="p">);</span> <span class="o">++</span><span class="n">sfc</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_info</span><span class="p">[</span><span class="n">sfc</span><span class="p">].</span><span class="n">rate</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span> <span class="o">=</span> <span class="n">sfc</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">syt_interval</span> <span class="o">=</span> <span class="n">rate_info</span><span class="p">[</span><span class="n">sfc</span><span class="p">].</span><span class="n">syt_interval</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_set_rate</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_get_max_payload - get the stream&#39;s packet size</span>
<span class="cm"> * @s: the AMDTP output stream</span>
<span class="cm"> *</span>
<span class="cm"> * This function must not be called before the stream has been configured</span>
<span class="cm"> * with amdtp_out_stream_set_hw_params(), amdtp_out_stream_set_pcm(), and</span>
<span class="cm"> * amdtp_out_stream_set_midi().</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">amdtp_out_stream_get_max_payload</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_data_blocks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">CIP_SFC_32000</span><span class="p">]</span>  <span class="o">=</span>  <span class="mi">4</span><span class="p">,</span>
		<span class="p">[</span><span class="n">CIP_SFC_44100</span><span class="p">]</span>  <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span>
		<span class="p">[</span><span class="n">CIP_SFC_48000</span><span class="p">]</span>  <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span>
		<span class="p">[</span><span class="n">CIP_SFC_88200</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">[</span><span class="n">CIP_SFC_96000</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">[</span><span class="n">CIP_SFC_176400</span><span class="p">]</span> <span class="o">=</span> <span class="mi">23</span><span class="p">,</span>
		<span class="p">[</span><span class="n">CIP_SFC_192000</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_quadlets</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_quadlets</span> <span class="o">+=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">midi_ports</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">max_data_blocks</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_quadlets</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_get_max_payload</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">amdtp_write_s16</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
			    <span class="n">__be32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">amdtp_write_s32</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
			    <span class="n">__be32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_set_pcm_format - set the PCM format</span>
<span class="cm"> * @s: the AMDTP output stream to configure</span>
<span class="cm"> * @format: the format of the ALSA PCM device</span>
<span class="cm"> *</span>
<span class="cm"> * The sample format must be set before the stream is started, and must not be</span>
<span class="cm"> * changed while the stream is running.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">amdtp_out_stream_set_pcm_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				     <span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">transfer_samples</span> <span class="o">=</span> <span class="n">amdtp_write_s16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32</span>:
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">transfer_samples</span> <span class="o">=</span> <span class="n">amdtp_write_s32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_set_pcm_format</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_pcm_prepare - prepare PCM device for running</span>
<span class="cm"> * @s: the AMDTP output stream</span>
<span class="cm"> *</span>
<span class="cm"> * This function should be called from the PCM device&#39;s .prepare callback.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">amdtp_out_stream_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">period_tasklet</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_buffer_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_period_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">pointer_flush</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_pcm_prepare</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calculate_data_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phase</span><span class="p">,</span> <span class="n">data_blocks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cip_sfc_is_base_44100</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Sample_rate / 8000 is an integer, and precomputed. */</span>
		<span class="n">data_blocks</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phase</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_state</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This calculates the number of data blocks per packet so that</span>
<span class="cm">		 * 1) the overall rate is correct and exactly synchronized to</span>
<span class="cm">		 *    the bus clock, and</span>
<span class="cm">		 * 2) packets with a rounded-up number of blocks occur as early</span>
<span class="cm">		 *    as possible in the sequence (to prevent underruns of the</span>
<span class="cm">		 *    device&#39;s buffer).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span> <span class="o">==</span> <span class="n">CIP_SFC_44100</span><span class="p">)</span>
			<span class="cm">/* 6 6 5 6 5 6 5 ... */</span>
			<span class="n">data_blocks</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">((</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span>
					   <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">phase</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="cm">/* 12 11 11 11 11 ... or 23 22 22 22 22 ... */</span>
			<span class="n">data_blocks</span> <span class="o">=</span> <span class="mi">11</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">phase</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_state</span> <span class="o">=</span> <span class="n">phase</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">data_blocks</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calculate_syt</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cycle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">syt_offset</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">syt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">last_syt_offset</span> <span class="o">&lt;</span> <span class="n">TICKS_PER_CYCLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cip_sfc_is_base_44100</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span><span class="p">))</span>
			<span class="n">syt_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">last_syt_offset</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">syt_offset_state</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The time, in ticks, of the n&#39;th SYT_INTERVAL sample is:</span>
<span class="cm">		 *   n * SYT_INTERVAL * 24576000 / sample_rate</span>
<span class="cm">		 * Modulo TICKS_PER_CYCLE, the difference between successive</span>
<span class="cm">		 * elements is about 1386.23.  Rounding the results of this</span>
<span class="cm">		 * formula to the SYT precision results in a sequence of</span>
<span class="cm">		 * differences that begins with:</span>
<span class="cm">		 *   1386 1386 1387 1386 1386 1386 1387 1386 1386 1386 1387 ...</span>
<span class="cm">		 * This code generates _exactly_ the same sequence.</span>
<span class="cm">		 */</span>
			<span class="n">phase</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">syt_offset_state</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">%</span> <span class="mi">13</span><span class="p">;</span>
			<span class="n">syt_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">last_syt_offset</span><span class="p">;</span>
			<span class="n">syt_offset</span> <span class="o">+=</span> <span class="mi">1386</span> <span class="o">+</span> <span class="p">((</span><span class="n">index</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">||</span>
					      <span class="n">phase</span> <span class="o">==</span> <span class="mi">146</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">phase</span> <span class="o">&gt;=</span> <span class="mi">147</span><span class="p">)</span>
				<span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">syt_offset_state</span> <span class="o">=</span> <span class="n">phase</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">syt_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">last_syt_offset</span> <span class="o">-</span> <span class="n">TICKS_PER_CYCLE</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">last_syt_offset</span> <span class="o">=</span> <span class="n">syt_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syt_offset</span> <span class="o">&lt;</span> <span class="n">TICKS_PER_CYCLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">syt_offset</span> <span class="o">+=</span> <span class="n">TRANSFER_DELAY_TICKS</span> <span class="o">-</span> <span class="n">TICKS_PER_CYCLE</span><span class="p">;</span>
		<span class="n">syt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">+</span> <span class="n">syt_offset</span> <span class="o">/</span> <span class="n">TICKS_PER_CYCLE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">syt</span> <span class="o">+=</span> <span class="n">syt_offset</span> <span class="o">%</span> <span class="n">TICKS_PER_CYCLE</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">syt</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="cm">/* no info */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amdtp_write_s32</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
			    <span class="n">__be32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">,</span> <span class="n">remaining_frames</span><span class="p">,</span> <span class="n">frame_step</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="n">channels</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_buffer_pointer</span> <span class="o">*</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">frame_bits</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">remaining_frames</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_buffer_pointer</span><span class="p">;</span>
	<span class="n">frame_step</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_quadlets</span> <span class="o">-</span> <span class="n">channels</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frames</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="o">*</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">);</span>
			<span class="n">src</span><span class="o">++</span><span class="p">;</span>
			<span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">frame_step</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">remaining_frames</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amdtp_write_s16</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
			    <span class="n">__be32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">,</span> <span class="n">remaining_frames</span><span class="p">,</span> <span class="n">frame_step</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="n">channels</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_buffer_pointer</span> <span class="o">*</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">frame_bits</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">remaining_frames</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_buffer_pointer</span><span class="p">;</span>
	<span class="n">frame_step</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_quadlets</span> <span class="o">-</span> <span class="n">channels</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frames</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="o">*</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">);</span>
			<span class="n">src</span><span class="o">++</span><span class="p">;</span>
			<span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">frame_step</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">remaining_frames</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amdtp_fill_pcm_silence</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="n">__be32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frames</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_channels</span><span class="p">;</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mh">0x40000000</span><span class="p">);</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_quadlets</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amdtp_fill_midi</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="n">__be32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frames</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_channels</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_quadlets</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">cpu_to_be32</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_out_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cycle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">data_blocks</span><span class="p">,</span> <span class="n">syt</span><span class="p">,</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_iso_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_index</span><span class="p">;</span>

	<span class="n">data_blocks</span> <span class="o">=</span> <span class="n">calculate_data_blocks</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">syt</span> <span class="o">=</span> <span class="n">calculate_syt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">cycle</span><span class="p">);</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">packets</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">source_node_id_field</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_quadlets</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_counter</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">CIP_EOH</span> <span class="o">|</span> <span class="n">CIP_FMT_AM</span> <span class="o">|</span> <span class="n">AMDTP_FDF_AM824</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span> <span class="o">&lt;&lt;</span> <span class="n">AMDTP_FDF_SFC_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">syt</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">pcm</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">transfer_samples</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pcm</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">data_blocks</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">amdtp_fill_pcm_silence</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">data_blocks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">midi_ports</span><span class="p">)</span>
		<span class="n">amdtp_fill_midi</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">data_blocks</span><span class="p">);</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_counter</span> <span class="o">+</span> <span class="n">data_blocks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">payload_length</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">data_blocks</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_quadlets</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">INTERRUPT_INTERVAL</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">TAG_CIP</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">sy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">header_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fw_iso_context_queue</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">iso_buffer</span><span class="p">,</span>
				   <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">packets</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;queueing error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">amdtp_out_stream_pcm_abort</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">QUEUE_LENGTH</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_buffer_pointer</span> <span class="o">+</span> <span class="n">data_blocks</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span>
			<span class="n">ptr</span> <span class="o">-=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
		<span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_buffer_pointer</span><span class="p">)</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_period_pointer</span> <span class="o">+=</span> <span class="n">data_blocks</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_period_pointer</span> <span class="o">&gt;=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_period_pointer</span> <span class="o">-=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pointer_flush</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">period_tasklet</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm_period_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="p">)</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">out_packet_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_iso_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cycle</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">header_length</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">packets</span> <span class="o">=</span> <span class="n">header_length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute the cycle of the last queued packet.</span>
<span class="cm">	 * (We need only the four lowest bits for the SYT, so we can ignore</span>
<span class="cm">	 * that bits 0-11 must wrap around at 3072.)</span>
<span class="cm">	 */</span>
	<span class="n">cycle</span> <span class="o">+=</span> <span class="n">QUEUE_LENGTH</span> <span class="o">-</span> <span class="n">packets</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">packets</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">queue_out_packet</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">++</span><span class="n">cycle</span><span class="p">);</span>
	<span class="n">fw_iso_context_queue_flush</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">queue_initial_skip_packets</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_iso_packet</span> <span class="n">skip_packet</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QUEUE_LENGTH</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skip_packet</span><span class="p">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						   <span class="n">INTERRUPT_INTERVAL</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fw_iso_context_queue</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skip_packet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_index</span> <span class="o">&gt;=</span> <span class="n">QUEUE_LENGTH</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_start - start sending packets</span>
<span class="cm"> * @s: the AMDTP output stream to start</span>
<span class="cm"> * @channel: the isochronous channel on the bus</span>
<span class="cm"> * @speed: firewire speed code</span>
<span class="cm"> *</span>
<span class="cm"> * The stream cannot be started until it has been configured with</span>
<span class="cm"> * amdtp_out_stream_set_hw_params(), amdtp_out_stream_set_pcm(), and</span>
<span class="cm"> * amdtp_out_stream_set_midi(); and it must be started before any</span>
<span class="cm"> * PCM or MIDI device can be started.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">amdtp_out_stream_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_block</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">syt_offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">initial_state</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">CIP_SFC_32000</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">3072</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_48000</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">1024</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_96000</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1024</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_192000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1024</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_44100</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>   <span class="mi">67</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_88200</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>   <span class="mi">67</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">CIP_SFC_176400</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>   <span class="mi">67</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_channels</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">midi_ports</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADFD</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_state</span> <span class="o">=</span> <span class="n">initial_state</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span><span class="p">].</span><span class="n">data_block</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">syt_offset_state</span> <span class="o">=</span> <span class="n">initial_state</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sfc</span><span class="p">].</span><span class="n">syt_offset</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">last_syt_offset</span> <span class="o">=</span> <span class="n">TICKS_PER_CYCLE</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iso_packets_buffer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">QUEUE_LENGTH</span><span class="p">,</span>
				      <span class="n">amdtp_out_stream_get_max_payload</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
				      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">fw_iso_context_create</span><span class="p">(</span><span class="n">fw_parent_device</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
					   <span class="n">FW_ISO_CONTEXT_TRANSMIT</span><span class="p">,</span>
					   <span class="n">channel</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">out_packet_callback</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="s">&quot;no free output stream on this controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_buffer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">amdtp_out_stream_update</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">packet_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">data_block_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">queue_initial_skip_packets</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_context</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fw_iso_context_start</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_context</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_context:</span>
	<span class="n">fw_iso_context_destroy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="nl">err_buffer:</span>
	<span class="n">iso_packets_buffer_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
<span class="nl">err_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_start</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_pcm_pointer - get the PCM buffer position</span>
<span class="cm"> * @s: the AMDTP output stream that transports the PCM data</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the current buffer position, in frames.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">amdtp_out_stream_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this optimization is allowed to be racy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pointer_flush</span><span class="p">)</span>
		<span class="n">fw_iso_context_flush_completions</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">pointer_flush</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm_buffer_pointer</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_pcm_pointer</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_update - update the stream after a bus reset</span>
<span class="cm"> * @s: the AMDTP output stream</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">amdtp_out_stream_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">source_node_id_field</span><span class="p">)</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">fw_parent_device</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">node_id</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_update</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_stop - stop sending packets</span>
<span class="cm"> * @s: the AMDTP output stream to stop</span>
<span class="cm"> *</span>
<span class="cm"> * All PCM and MIDI devices of the stream must be stopped before the stream</span>
<span class="cm"> * itself can be stopped.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">amdtp_out_stream_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">period_tasklet</span><span class="p">);</span>
	<span class="n">fw_iso_context_stop</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
	<span class="n">fw_iso_context_destroy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">iso_packets_buffer_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_stop</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * amdtp_out_stream_pcm_abort - abort the running PCM device</span>
<span class="cm"> * @s: the AMDTP stream about to be stopped</span>
<span class="cm"> *</span>
<span class="cm"> * If the isochronous stream needs to be stopped asynchronously, call this</span>
<span class="cm"> * function first to stop the PCM device.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">amdtp_out_stream_pcm_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">amdtp_out_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>

	<span class="n">pcm</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_stream_lock_irq</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_running</span><span class="p">(</span><span class="n">pcm</span><span class="p">))</span>
			<span class="n">snd_pcm_stop</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STATE_XRUN</span><span class="p">);</span>
		<span class="n">snd_pcm_stream_unlock_irq</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amdtp_out_stream_pcm_abort</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
