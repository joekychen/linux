<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › sb_audio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sb_audio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sound/oss/sb_audio.c</span>
<span class="cm"> *</span>
<span class="cm"> * Audio routines for Sound Blaster compatible cards.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) by Hannu Savolainen 1993-1997</span>
<span class="cm"> *</span>
<span class="cm"> * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)</span>
<span class="cm"> * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software</span>
<span class="cm"> * for more info.</span>
<span class="cm"> *</span>
<span class="cm"> * Changes</span>
<span class="cm"> *	Alan Cox	:	Formatting and clean ups</span>
<span class="cm"> *</span>
<span class="cm"> * Status</span>
<span class="cm"> *	Mostly working. Weird uart bug causing irq storms</span>
<span class="cm"> *</span>
<span class="cm"> * Daniel J. Rodriksson: Changes to make sb16 work full duplex.</span>
<span class="cm"> *                       Maybe other 16 bit cards in this code could behave</span>
<span class="cm"> *                       the same.</span>
<span class="cm"> * Chris Rankin:         Use spinlocks instead of CLI/STI</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &quot;sound_config.h&quot;</span>

<span class="cp">#include &quot;sb_mixer.h&quot;</span>
<span class="cp">#include &quot;sb.h&quot;</span>

<span class="cp">#include &quot;sb_ess.h&quot;</span>

<span class="kt">int</span> <span class="nf">sb_audio_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound Blaster: incomplete initialization.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		  <span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_NO_RECORDING</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		  <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sound_open_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">,</span> <span class="s">&quot;Sound Blaster 16 bit&quot;</span><span class="p">))</span>
		<span class="p">{</span>
		  	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_NONE</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span> <span class="o">=</span> <span class="n">IMODE_NONE</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">));</span>
	<span class="n">sb_dsp_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="cm">/* At first glance this check isn&#39;t enough, some ESS chips might not </span>
<span class="cm">	 * have a RECLEV. However if they don&#39;t common_mixer_set will refuse </span>
<span class="cm">	 * cause devc-&gt;iomap has no register mapping for RECLEV</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_ESS</span><span class="p">)</span> <span class="n">ess_mixer_reload</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">SOUND_MIXER_RECLEV</span><span class="p">);</span>

	<span class="cm">/* The ALS007 seems to require that the DSP be removed from the output */</span>
	<span class="cm">/* in order for recording to be activated properly.  This is done by   */</span>
	<span class="cm">/* setting the appropriate bits of the output control register 4ch to  */</span>
	<span class="cm">/* zero.  This code assumes that the output control registers are not  */</span>
	<span class="cm">/* used anywhere else and therefore the DSP bits are *always* ON for   */</span>
	<span class="cm">/* output and OFF for sampling.                                        */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">==</span> <span class="n">SUBMDL_ALS007</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span> 
			<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="n">ALS007_OUTPUT_CTRL2</span><span class="p">,</span>
				<span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="n">ALS007_OUTPUT_CTRL2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf9</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="n">ALS007_OUTPUT_CTRL2</span><span class="p">,</span>
				<span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="n">ALS007_OUTPUT_CTRL2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sb_audio_close</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="cm">/* fix things if mmap turned off fullduplex */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span>
	   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span>
	   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap_temp</span><span class="p">;</span>
		<span class="n">dmap_temp</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span> <span class="o">=</span> <span class="n">dmap_temp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="p">)</span> <span class="o">?</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">:</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span>
		<span class="n">sound_close_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">);</span>

	<span class="cm">/* For ALS007, turn DSP output back on if closing the device for read */</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">==</span> <span class="n">SUBMDL_ALS007</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span> 
	<span class="p">{</span>
		<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="n">ALS007_OUTPUT_CTRL2</span><span class="p">,</span>
			<span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="n">ALS007_OUTPUT_CTRL2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb_set_output_parms</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span> <span class="o">=</span> <span class="n">intrflag</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf_16</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes_16</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag_16</span> <span class="o">=</span> <span class="n">intrflag</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb_set_input_parms</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">!=</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span> <span class="o">=</span> <span class="n">intrflag</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_INPUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf_16</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes_16</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag_16</span> <span class="o">=</span> <span class="n">intrflag</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span> <span class="o">=</span> <span class="n">IMODE_INPUT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SB1.x compatible routines </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb1_audio_output_block</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="cm">/* DMAbuf_start_dma (dev, buf, count, DMA_MODE_WRITE); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">))</span>		<span class="cm">/* 8 bit DAC using DMA */</span>
	<span class="p">{</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound Blaster:  unable to start DAC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb1_audio_start_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start a DMA input to the buffer pointed by dmaqtail</span>
<span class="cm">	 */</span>

	<span class="cm">/* DMAbuf_start_dma (dev, buf, count, DMA_MODE_READ); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_INPUT</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">))</span>		<span class="cm">/* 8 bit ADC using DMA */</span>
	<span class="p">{</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound Blaster:  unable to start ADC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb1_audio_trigger</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">&amp;=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bits</span><span class="p">)</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>	<span class="cm">/* Halt DMA */</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">case</span> <span class="n">IMODE_INPUT</span>:
				<span class="n">sb1_audio_start_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span><span class="p">,</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IMODE_OUTPUT</span>:
				<span class="n">sb1_audio_output_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span><span class="p">,</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb1_audio_prepare_for_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">))</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span><span class="p">);</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">DSP_CMD_SPKOFF</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb1_audio_prepare_for_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">))</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span><span class="p">);</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">DSP_CMD_SPKON</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb1_audio_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_speed</span> <span class="o">=</span> <span class="mi">23000</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span>
		<span class="n">max_speed</span> <span class="o">=</span> <span class="mi">13000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">max_speed</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">max_speed</span><span class="p">;</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1000000</span> <span class="o">+</span> <span class="n">speed</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">speed</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span><span class="p">;</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">+</span> <span class="n">tmp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">sb1_audio_set_channels</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sb1_audio_set_bits</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span>        <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb1_audio_halt_xfer</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sb_dsp_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SB 2.0 and SB 2.01 compatible routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb20_audio_output_block</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* DMAbuf_start_dma (dev, buf, count, DMA_MODE_WRITE); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">))</span>		<span class="cm">/* DSP Block size */</span>
	<span class="p">{</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">*</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&lt;=</span> <span class="mi">23000</span><span class="p">)</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">;</span>	<span class="cm">/* 8 bit PCM output */</span>
		<span class="k">else</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>	<span class="cm">/* 8 bit high speed PCM output (SB2.01/Pro) */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound Blaster:  unable to start DAC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound Blaster: unable to start DAC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb20_audio_start_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start a DMA input to the buffer pointed by dmaqtail</span>
<span class="cm">	 */</span>

	<span class="cm">/* DMAbuf_start_dma (dev, buf, count, DMA_MODE_READ); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_INPUT</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">))</span>		<span class="cm">/* DSP Block size */</span>
	<span class="p">{</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">*</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="mi">23000</span> <span class="o">:</span> <span class="mi">13000</span><span class="p">))</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x2c</span><span class="p">;</span>	<span class="cm">/* 8 bit PCM input */</span>
		<span class="k">else</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x98</span><span class="p">;</span>	<span class="cm">/* 8 bit high speed PCM input (SB2.01/Pro) */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound Blaster:  unable to start ADC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound Blaster:  unable to start ADC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb20_audio_trigger</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">bits</span> <span class="o">&amp;=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bits</span><span class="p">)</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>	<span class="cm">/* Halt DMA */</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">case</span> <span class="n">IMODE_INPUT</span>:
				<span class="n">sb20_audio_start_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span><span class="p">,</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IMODE_OUTPUT</span>:
				<span class="n">sb20_audio_output_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span><span class="p">,</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span><span class="p">);</span>
			    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SB2.01 specific speed setup</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb201_audio_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">*</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">44100</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">15000</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">15000</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1000000</span> <span class="o">+</span> <span class="n">s</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span><span class="p">;</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1000000</span> <span class="o">+</span> <span class="n">tmp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SB Pro specific routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbpro_audio_prepare_for_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>				<span class="cm">/* For SB Pro and Jazz16 */</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">)</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">:</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_JAZZ</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_SMW</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* 16 bit mode */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">))</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span><span class="p">);</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">DSP_CMD_SPKOFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="o">|</span> <span class="n">bits</span><span class="p">);</span>	<span class="cm">/* Mono input */</span>
	<span class="k">else</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa8</span> <span class="o">|</span> <span class="n">bits</span><span class="p">);</span>	<span class="cm">/* Stereo input */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbpro_audio_prepare_for_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>				<span class="cm">/* For SB Pro and Jazz16 */</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">)</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">:</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_SBPRO</span><span class="p">)</span>
		<span class="n">sb_mixer_set_stereo</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">))</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span><span class="p">);</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">DSP_CMD_SPKON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_JAZZ</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_SMW</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* 16 bit mode */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="o">|</span> <span class="n">bits</span><span class="p">);</span>	<span class="cm">/* Mono output */</span>
		<span class="k">else</span>
			<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa8</span> <span class="o">|</span> <span class="n">bits</span><span class="p">);</span>	<span class="cm">/* Stereo output */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbpro_audio_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">44100</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">22050</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">22050</span><span class="p">;</span>
		<span class="n">sb201_audio_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">sbpro_audio_set_channels</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_SBPRO</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">sbpro_audio_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jazz16_audio_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">*</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">44100</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1000000</span> <span class="o">+</span> <span class="n">s</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">tconst</span><span class="p">;</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1000000</span> <span class="o">+</span> <span class="n">tmp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SB16 specific routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb16_audio_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">max_speed</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">==</span> <span class="n">SUBMDL_ALS100</span> <span class="o">?</span> <span class="mi">48000</span> <span class="o">:</span> <span class="mi">44100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">max_speed</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">max_speed</span><span class="p">;</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sb16_audio_set_bits</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_U8</span> <span class="o">||</span> <span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb16_audio_prepare_for_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span>
			<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span> <span class="o">?</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">:</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">;</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb16_audio_prepare_for_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span>
			<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span> <span class="o">?</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">:</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">;</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb16_audio_output_block</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">sb_devc</span>        <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active_16</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save value */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">AFMT_U8</span> <span class="o">:</span> <span class="n">AFMT_S16_LE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* DMAbuf_start_dma (dev, buf, count, DMA_MODE_WRITE); */</span>

	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span> <span class="o">?</span> <span class="mh">0xb6</span> <span class="o">:</span> <span class="mh">0xc6</span><span class="p">));</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)));</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* restore real value after all programming */</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	This fails on the Cyrix MediaGX. If you don&#39;t have the DMA enabled</span>
<span class="cm"> *	before the first sample arrives it locks up. However even if you</span>
<span class="cm"> *	do enable the DMA in time you just get DMA timeouts and missing</span>
<span class="cm"> *	interrupts and stuff, so for now I&#39;ve not bothered fixing this either.</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb16_audio_start_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">sb_devc</span>        <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">!=</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_INPUT</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span> <span class="o">=</span> <span class="n">IMODE_INPUT</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active_16</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* DMAbuf_start_dma (dev, buf, count, DMA_MODE_READ); */</span>

	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span> <span class="o">?</span> <span class="mh">0xbe</span> <span class="o">:</span> <span class="mh">0xce</span><span class="p">));</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)));</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb16_audio_trigger</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">bits_16</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span><span class="p">;</span>
	<span class="n">bits</span> <span class="o">&amp;=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bits</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bits_16</span><span class="p">)</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>	<span class="cm">/* Halt DMA */</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">case</span> <span class="n">IMODE_INPUT</span>:
					<span class="n">sb16_audio_start_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">IMODE_OUTPUT</span>:
					<span class="n">sb16_audio_output_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits_16</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">case</span> <span class="n">IMODE_INPUT</span>:
					<span class="n">sb16_audio_start_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf_16</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes_16</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag_16</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">IMODE_OUTPUT</span>:
					<span class="n">sb16_audio_output_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf_16</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes_16</span><span class="p">,</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag_16</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">|</span> <span class="n">bits_16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbuf8</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="o">*</span><span class="n">lbuf16</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">lbuf8</span><span class="p">;</span>
<span class="cp">#define LBUFCOPYSIZE 1024</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sb16_copy_from_user</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">localbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">localoffs</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">useroffs</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">max_in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_out</span><span class="p">,</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">used</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">returned</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span>       <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">int</span>           <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">locallen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf8</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">short</span>  <span class="o">*</span><span class="n">buf16</span><span class="p">;</span>

	<span class="cm">/* if not duplex no conversion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">localbuf</span> <span class="o">+</span> <span class="n">localoffs</span><span class="p">,</span>
				   <span class="n">userbuf</span> <span class="o">+</span> <span class="n">useroffs</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="o">*</span><span class="n">used</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="o">*</span><span class="n">returned</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* 16 -&gt; 8 */</span>
		<span class="cm">/* max_in &gt;&gt; 1, max number of samples in ( 16 bits ) */</span>
		<span class="cm">/* max_out, max number of samples out ( 8 bits ) */</span>
		<span class="cm">/* len, number of samples that will be taken ( 16 bits )*/</span>
		<span class="cm">/* c, count of samples remaining in buffer ( 16 bits )*/</span>
		<span class="cm">/* p, count of samples already processed ( 16 bits )*/</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">max_in</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_out</span><span class="p">)</span> <span class="o">?</span> <span class="n">max_out</span> <span class="o">:</span> <span class="p">(</span><span class="n">max_in</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf8</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">localbuf</span> <span class="o">+</span> <span class="n">localoffs</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">locallen</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="n">LBUFCOPYSIZE</span> <span class="o">?</span> <span class="n">LBUFCOPYSIZE</span> <span class="o">:</span> <span class="n">c</span><span class="p">);</span>
			<span class="cm">/* &lt;&lt; 1 in order to get 16 bit samples */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">lbuf16</span><span class="p">,</span>
					   <span class="n">userbuf</span> <span class="o">+</span> <span class="n">useroffs</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
					   <span class="n">locallen</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">locallen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">buf8</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">lbuf16</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">c</span> <span class="o">-=</span> <span class="n">locallen</span><span class="p">;</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">locallen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* used = ( samples * 16 bits size ) */</span>
		<span class="o">*</span><span class="n">used</span> <span class="o">=</span>  <span class="n">max_in</span>  <span class="o">&gt;</span> <span class="p">(</span> <span class="n">max_out</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">max_out</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">max_in</span><span class="p">;</span>
		<span class="cm">/* returned = ( samples * 8 bits size ) */</span>
		<span class="o">*</span><span class="n">returned</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="cm">/* 8 -&gt; 16 */</span>
		<span class="cm">/* max_in, max number of samples in ( 8 bits ) */</span>
		<span class="cm">/* max_out &gt;&gt; 1, max number of samples out ( 16 bits ) */</span>
		<span class="cm">/* len, number of samples that will be taken ( 8 bits )*/</span>
		<span class="cm">/* c, count of samples remaining in buffer ( 8 bits )*/</span>
		<span class="cm">/* p, count of samples already processed ( 8 bits )*/</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">max_in</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_out</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">max_out</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">max_in</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf16</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">localbuf</span> <span class="o">+</span> <span class="n">localoffs</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">locallen</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="n">LBUFCOPYSIZE</span> <span class="o">?</span> <span class="n">LBUFCOPYSIZE</span> <span class="o">:</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">lbuf8</span><span class="p">,</span>
					   <span class="n">userbuf</span><span class="o">+</span><span class="n">useroffs</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span>
					   <span class="n">locallen</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">locallen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">buf16</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">lbuf8</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
	      		<span class="n">c</span> <span class="o">-=</span> <span class="n">locallen</span><span class="p">;</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">locallen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* used = ( samples * 8 bits size ) */</span>
		<span class="o">*</span><span class="n">used</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="cm">/* returned = ( samples * 16 bits size ) */</span>
		<span class="o">*</span><span class="n">returned</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sb16_audio_mmap</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span>       <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="n">sb1_audio_driver</span> <span class="o">=</span>	<span class="cm">/* SB1.x */</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">sb_audio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">sb_audio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_block</span>		<span class="o">=</span> <span class="n">sb_set_output_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_input</span>		<span class="o">=</span> <span class="n">sb_set_input_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_input</span>	<span class="o">=</span> <span class="n">sb1_audio_prepare_for_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_output</span>	<span class="o">=</span> <span class="n">sb1_audio_prepare_for_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_io</span>		<span class="o">=</span> <span class="n">sb1_audio_halt_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>		<span class="o">=</span> <span class="n">sb1_audio_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed</span>		<span class="o">=</span> <span class="n">sb1_audio_set_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bits</span>		<span class="o">=</span> <span class="n">sb1_audio_set_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channels</span>		<span class="o">=</span> <span class="n">sb1_audio_set_channels</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="n">sb20_audio_driver</span> <span class="o">=</span>	<span class="cm">/* SB2.0 */</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">sb_audio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">sb_audio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_block</span>		<span class="o">=</span> <span class="n">sb_set_output_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_input</span>		<span class="o">=</span> <span class="n">sb_set_input_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_input</span>	<span class="o">=</span> <span class="n">sb1_audio_prepare_for_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_output</span>	<span class="o">=</span> <span class="n">sb1_audio_prepare_for_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_io</span>		<span class="o">=</span> <span class="n">sb1_audio_halt_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>		<span class="o">=</span> <span class="n">sb20_audio_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed</span>		<span class="o">=</span> <span class="n">sb1_audio_set_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bits</span>		<span class="o">=</span> <span class="n">sb1_audio_set_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channels</span>		<span class="o">=</span> <span class="n">sb1_audio_set_channels</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="n">sb201_audio_driver</span> <span class="o">=</span>		<span class="cm">/* SB2.01 */</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">sb_audio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">sb_audio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_block</span>		<span class="o">=</span> <span class="n">sb_set_output_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_input</span>		<span class="o">=</span> <span class="n">sb_set_input_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_input</span>	<span class="o">=</span> <span class="n">sb1_audio_prepare_for_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_output</span>	<span class="o">=</span> <span class="n">sb1_audio_prepare_for_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_io</span>		<span class="o">=</span> <span class="n">sb1_audio_halt_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>		<span class="o">=</span> <span class="n">sb20_audio_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed</span>		<span class="o">=</span> <span class="n">sb201_audio_set_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bits</span>		<span class="o">=</span> <span class="n">sb1_audio_set_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channels</span>		<span class="o">=</span> <span class="n">sb1_audio_set_channels</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="n">sbpro_audio_driver</span> <span class="o">=</span>		<span class="cm">/* SB Pro */</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">sb_audio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">sb_audio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_block</span>		<span class="o">=</span> <span class="n">sb_set_output_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_input</span>		<span class="o">=</span> <span class="n">sb_set_input_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_input</span>	<span class="o">=</span> <span class="n">sbpro_audio_prepare_for_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_output</span>	<span class="o">=</span> <span class="n">sbpro_audio_prepare_for_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_io</span>		<span class="o">=</span> <span class="n">sb1_audio_halt_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>		<span class="o">=</span> <span class="n">sb20_audio_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed</span>		<span class="o">=</span> <span class="n">sbpro_audio_set_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bits</span>		<span class="o">=</span> <span class="n">sb1_audio_set_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channels</span>		<span class="o">=</span> <span class="n">sbpro_audio_set_channels</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="n">jazz16_audio_driver</span> <span class="o">=</span>	<span class="cm">/* Jazz16 and SM Wave */</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">sb_audio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">sb_audio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_block</span>		<span class="o">=</span> <span class="n">sb_set_output_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_input</span>		<span class="o">=</span> <span class="n">sb_set_input_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_input</span>	<span class="o">=</span> <span class="n">sbpro_audio_prepare_for_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_output</span>	<span class="o">=</span> <span class="n">sbpro_audio_prepare_for_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_io</span>		<span class="o">=</span> <span class="n">sb1_audio_halt_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>		<span class="o">=</span> <span class="n">sb20_audio_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed</span>		<span class="o">=</span> <span class="n">jazz16_audio_set_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bits</span>		<span class="o">=</span> <span class="n">sb16_audio_set_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channels</span>		<span class="o">=</span> <span class="n">sbpro_audio_set_channels</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="n">sb16_audio_driver</span> <span class="o">=</span>	<span class="cm">/* SB16 */</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">sb_audio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">sb_audio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_block</span>		<span class="o">=</span> <span class="n">sb_set_output_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_input</span>		<span class="o">=</span> <span class="n">sb_set_input_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_input</span>	<span class="o">=</span> <span class="n">sb16_audio_prepare_for_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_output</span>	<span class="o">=</span> <span class="n">sb16_audio_prepare_for_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_io</span>		<span class="o">=</span> <span class="n">sb1_audio_halt_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">copy_user</span>		<span class="o">=</span> <span class="n">sb16_copy_from_user</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>		<span class="o">=</span> <span class="n">sb16_audio_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed</span>		<span class="o">=</span> <span class="n">sb16_audio_set_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bits</span>		<span class="o">=</span> <span class="n">sb16_audio_set_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channels</span>		<span class="o">=</span> <span class="n">sbpro_audio_set_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>			<span class="o">=</span> <span class="n">sb16_audio_mmap</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">sb_audio_init</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">audio_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">format_mask</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">audio_driver</span> <span class="o">*</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sb1_audio_driver</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">MDL_SB1</span>:	<span class="cm">/* SB1.0 or SB 1.5 */</span>
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Will use standard SB1.x driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">audio_flags</span> <span class="o">=</span> <span class="n">DMA_HARDSTOP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MDL_SB2</span>:
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Will use SB2.0 driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">audio_flags</span> <span class="o">=</span> <span class="n">DMA_AUTOMODE</span><span class="p">;</span>
			<span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sb20_audio_driver</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MDL_SB201</span>:
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Will use SB2.01 (high speed) driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">audio_flags</span> <span class="o">=</span> <span class="n">DMA_AUTOMODE</span><span class="p">;</span>
			<span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sb201_audio_driver</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MDL_JAZZ</span>:
		<span class="k">case</span> <span class="n">MDL_SMW</span>:
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Will use Jazz16 driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">audio_flags</span> <span class="o">=</span> <span class="n">DMA_AUTOMODE</span><span class="p">;</span>
			<span class="n">format_mask</span> <span class="o">|=</span> <span class="n">AFMT_S16_LE</span><span class="p">;</span>
			<span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jazz16_audio_driver</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MDL_ESS</span>:
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Will use ESS ES688/1688 driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">driver</span> <span class="o">=</span> <span class="n">ess_audio_init</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audio_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format_mask</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MDL_SB16</span>:
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Will use SB16 driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">audio_flags</span> <span class="o">=</span> <span class="n">DMA_AUTOMODE</span><span class="p">;</span>
			<span class="n">format_mask</span> <span class="o">|=</span> <span class="n">AFMT_S16_LE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">audio_flags</span> <span class="o">|=</span> <span class="n">DMA_DUPLEX</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sb16_audio_driver</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Will use SB Pro driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">audio_flags</span> <span class="o">=</span> <span class="n">DMA_AUTOMODE</span><span class="p">;</span>
			<span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbpro_audio_driver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="p">)</span>
			<span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sound_install_audiodrv</span><span class="p">(</span><span class="n">AUDIO_DRIVER_VERSION</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span><span class="n">driver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_driver</span><span class="p">),</span>
				<span class="n">audio_flags</span><span class="p">,</span> <span class="n">format_mask</span><span class="p">,</span> <span class="n">devc</span><span class="p">,</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">,</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">?</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">:</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound Blaster:  unable to install audio.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mixer_dev</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">my_mixerdev</span><span class="p">;</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">min_fragment</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
