<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › sb_ess.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sb_ess.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#undef FKS_LOGGING</span>
<span class="cp">#undef FKS_TEST</span>

<span class="cm">/*</span>
<span class="cm"> * tabs should be 4 spaces, in vi(m): set tabstop=4</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: 	consistency speed calculations!!</span>
<span class="cm"> *			cleanup!</span>
<span class="cm"> * ????:	Did I break MIDI support?</span>
<span class="cm"> *</span>
<span class="cm"> * History:</span>
<span class="cm"> *</span>
<span class="cm"> * Rolf Fokkens	 (Dec 20 1998):	ES188x recording level support on a per</span>
<span class="cm"> * fokkensr@vertis.nl			input basis.</span>
<span class="cm"> *				 (Dec 24 1998):	Recognition of ES1788, ES1887, ES1888,</span>
<span class="cm"> *								ES1868, ES1869 and ES1878. Could be used for</span>
<span class="cm"> *								specific handling in the future. All except</span>
<span class="cm"> *								ES1887 and ES1888 and ES688 are handled like</span>
<span class="cm"> *								ES1688.</span>
<span class="cm"> *				 (Dec 27 1998):	RECLEV for all (?) ES1688+ chips. ES188x now</span>
<span class="cm"> *								have the &quot;Dec 20&quot; support + RECLEV</span>
<span class="cm"> *				 (Jan  2 1999):	Preparation for Full Duplex. This means</span>
<span class="cm"> *								Audio 2 is now used for playback when dma16</span>
<span class="cm"> *								is specified. The next step would be to use</span>
<span class="cm"> *								Audio 1 and Audio 2 at the same time.</span>
<span class="cm"> *				 (Jan  9 1999):	Put all ESS stuff into sb_ess.[ch], this</span>
<span class="cm"> *								includes both the ESS stuff that has been in</span>
<span class="cm"> *								sb_*[ch] before I touched it and the ESS support</span>
<span class="cm"> *								I added later</span>
<span class="cm"> *				 (Jan 23 1999):	Full Duplex seems to work. I wrote a small</span>
<span class="cm"> *								test proggy which works OK. Haven&#39;t found</span>
<span class="cm"> *								any applications to test it though. So why did</span>
<span class="cm"> *								I bother to create it anyway?? :) Just for</span>
<span class="cm"> *								fun.</span>
<span class="cm"> *				 (May  2 1999):	I tried to be too smart by &quot;introducing&quot;</span>
<span class="cm"> *								ess_calc_best_speed (). The idea was that two</span>
<span class="cm"> *								dividers could be used to setup a samplerate,</span>
<span class="cm"> *								ess_calc_best_speed () would choose the best.</span>
<span class="cm"> *								This works for playback, but results in</span>
<span class="cm"> *								recording problems for high samplerates. I</span>
<span class="cm"> *								fixed this by removing ess_calc_best_speed ()</span>
<span class="cm"> *								and just doing what the documentation says. </span>
<span class="cm"> * Andy Sloane   (Jun  4 1999): Stole some code from ALSA to fix the playback</span>
<span class="cm"> * andy@guildsoftware.com		speed on ES1869, ES1879, ES1887, and ES1888.</span>
<span class="cm"> * 								1879&#39;s were previously ignored by this driver;</span>
<span class="cm"> * 								added (untested) support for those.</span>
<span class="cm"> * Cvetan Ivanov (Oct 27 1999): Fixed ess_dsp_init to call ess_set_dma_hw for</span>
<span class="cm"> * zezo@inet.bg					_ALL_ ESS models, not only ES1887</span>
<span class="cm"> *</span>
<span class="cm"> * This files contains ESS chip specifics. It&#39;s based on the existing ESS</span>
<span class="cm"> * handling as it resided in sb_common.c, sb_mixer.c and sb_audio.c. This</span>
<span class="cm"> * file adds features like:</span>
<span class="cm"> * - Chip Identification (as shown in /proc/sound)</span>
<span class="cm"> * - RECLEV support for ES1688 and later</span>
<span class="cm"> * - 6 bits playback level support chips later than ES1688</span>
<span class="cm"> * - Recording level support on a per-device basis for ES1887</span>
<span class="cm"> * - Full-Duplex for ES1887</span>
<span class="cm"> *</span>
<span class="cm"> * Full duplex is enabled by specifying dma16. While the normal dma must</span>
<span class="cm"> * be one of 0, 1 or 3, dma16 can be one of 0, 1, 3 or 5. DMA 5 is a 16 bit</span>
<span class="cm"> * DMA channel, while the others are 8 bit..</span>
<span class="cm"> *</span>
<span class="cm"> * ESS detection isn&#39;t full proof (yet). If it fails an additional module</span>
<span class="cm"> * parameter esstype can be specified to be one of the following:</span>
<span class="cm"> * -1, 0, 688, 1688, 1868, 1869, 1788, 1887, 1888</span>
<span class="cm"> * -1 means: mimic 2.0 behaviour, </span>
<span class="cm"> *  0 means: auto detect.</span>
<span class="cm"> *   others: explicitly specify chip</span>
<span class="cm"> * -1 is default, cause auto detect still doesn&#39;t work.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * About the documentation</span>
<span class="cm"> *</span>
<span class="cm"> * I don&#39;t know if the chips all are OK, but the documentation is buggy. &#39;cause</span>
<span class="cm"> * I don&#39;t have all the cips myself, there&#39;s a lot I cannot verify. I&#39;ll try to</span>
<span class="cm"> * keep track of my latest insights about his here. If you have additional info,</span>
<span class="cm"> * please enlighten me (fokkensr@vertis.nl)!</span>
<span class="cm"> *</span>
<span class="cm"> * I had the impression that ES1688 also has 6 bit master volume control. The</span>
<span class="cm"> * documentation about ES1888 (rev C, october &#39;95) claims that ES1888 has</span>
<span class="cm"> * the following features ES1688 doesn&#39;t have:</span>
<span class="cm"> * - 6 bit master volume</span>
<span class="cm"> * - Full Duplex</span>
<span class="cm"> * So ES1688 apparently doesn&#39;t have 6 bit master volume control, but the</span>
<span class="cm"> * ES1688 does have RECLEV control. Makes me wonder: does ES688 have it too?</span>
<span class="cm"> * Without RECLEV ES688 won&#39;t be much fun I guess.</span>
<span class="cm"> *</span>
<span class="cm"> * From the ES1888 (rev C, october &#39;95) documentation I got the impression</span>
<span class="cm"> * that registers 0x68 to 0x6e don&#39;t exist which means: no recording volume</span>
<span class="cm"> * controls. To my surprise the ES888 documentation (1/14/96) claims that</span>
<span class="cm"> * ES888 does have these record mixer registers, but that ES1888 doesn&#39;t have</span>
<span class="cm"> * 0x69 and 0x6b. So the rest should be there.</span>
<span class="cm"> *</span>
<span class="cm"> * I&#39;m trying to get ES1887 Full Duplex. Audio 2 is playback only, while Audio 2</span>
<span class="cm"> * is both record and playback. I think I should use Audio 2 for all playback.</span>
<span class="cm"> *</span>
<span class="cm"> * The documentation is an adventure: it&#39;s close but not fully accurate. I</span>
<span class="cm"> * found out that after a reset some registers are *NOT* reset, though the</span>
<span class="cm"> * docs say the would be. Interesting ones are 0x7f, 0x7d and 0x7a. They are</span>
<span class="cm"> * related to the Audio 2 channel. I also was surprised about the consequences</span>
<span class="cm"> * of writing 0x00 to 0x7f (which should be done by reset): The ES1887 moves</span>
<span class="cm"> * into ES1888 mode. This means that it claims IRQ 11, which happens to be my</span>
<span class="cm"> * ISDN adapter. Needless to say it no longer worked. I now understand why</span>
<span class="cm"> * after rebooting 0x7f already was 0x05, the value of my choice: the BIOS</span>
<span class="cm"> * did it.</span>
<span class="cm"> *</span>
<span class="cm"> * Oh, and this is another trap: in ES1887 docs mixer register 0x70 is</span>
<span class="cm"> * described as if it&#39;s exactly the same as register 0xa1. This is *NOT* true.</span>
<span class="cm"> * The description of 0x70 in ES1869 docs is accurate however.</span>
<span class="cm"> * Well, the assumption about ES1869 was wrong: register 0x70 is very much</span>
<span class="cm"> * like register 0xa1, except that bit 7 is always 1, whatever you want</span>
<span class="cm"> * it to be.</span>
<span class="cm"> *</span>
<span class="cm"> * When using audio 2 mixer register 0x72 seems te be meaningless. Only 0xa2</span>
<span class="cm"> * has effect.</span>
<span class="cm"> *</span>
<span class="cm"> * Software reset not being able to reset all registers is great! Especially</span>
<span class="cm"> * the fact that register 0x78 isn&#39;t reset is great when you wanna change back</span>
<span class="cm"> * to single dma operation (simplex): audio 2 is still operational, and uses</span>
<span class="cm"> * the same dma as audio 1: your ess changes into a funny echo machine.</span>
<span class="cm"> *</span>
<span class="cm"> * Received the news that ES1688 is detected as a ES1788. Did some thinking:</span>
<span class="cm"> * the ES1887 detection scheme suggests in step 2 to try if bit 3 of register</span>
<span class="cm"> * 0x64 can be changed. This is inaccurate, first I inverted the * check: &quot;If</span>
<span class="cm"> * can be modified, it&#39;s a 1688&quot;, which lead to a correct detection</span>
<span class="cm"> * of my ES1887. It resulted however in bad detection of 1688 (reported by mail)</span>
<span class="cm"> * and 1868 (if no PnP detection first): they result in a 1788 being detected.</span>
<span class="cm"> * I don&#39;t have docs on 1688, but I do have docs on 1868: The documentation is</span>
<span class="cm"> * probably inaccurate in the fact that I should check bit 2, not bit 3. This</span>
<span class="cm"> * is what I do now.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * About recognition of ESS chips</span>
<span class="cm"> *</span>
<span class="cm"> * The distinction of ES688, ES1688, ES1788, ES1887 and ES1888 is described in</span>
<span class="cm"> * a (preliminary ??) datasheet on ES1887. Its aim is to identify ES1887, but</span>
<span class="cm"> * during detection the text claims that &quot;this chip may be ...&quot; when a step</span>
<span class="cm"> * fails. This scheme is used to distinct between the above chips.</span>
<span class="cm"> * It appears however that some PnP chips like ES1868 are recognized as ES1788</span>
<span class="cm"> * by the ES1887 detection scheme. These PnP chips can be detected in another</span>
<span class="cm"> * way however: ES1868, ES1869 and ES1878 can be recognized (full proof I think)</span>
<span class="cm"> * by repeatedly reading mixer register 0x40. This is done by ess_identify in</span>
<span class="cm"> * sb_common.c.</span>
<span class="cm"> * This results in the following detection steps:</span>
<span class="cm"> * - distinct between ES688 and ES1688+ (as always done in this driver)</span>
<span class="cm"> *   if ES688 we&#39;re ready</span>
<span class="cm"> * - try to detect ES1868, ES1869 or ES1878</span>
<span class="cm"> *   if successful we&#39;re ready</span>
<span class="cm"> * - try to detect ES1888, ES1887 or ES1788</span>
<span class="cm"> *   if successful we&#39;re ready</span>
<span class="cm"> * - Dunno. Must be 1688. Will do in general</span>
<span class="cm"> *</span>
<span class="cm"> * About RECLEV support:</span>
<span class="cm"> *</span>
<span class="cm"> * The existing ES1688 support didn&#39;t take care of the ES1688+ recording</span>
<span class="cm"> * levels very well. Whenever a device was selected (recmask) for recording</span>
<span class="cm"> * its recording level was loud, and it couldn&#39;t be changed. The fact that</span>
<span class="cm"> * internal register 0xb4 could take care of RECLEV, didn&#39;t work meaning until</span>
<span class="cm"> * its value was restored every time the chip was reset; this reset the</span>
<span class="cm"> * value of 0xb4 too. I guess that&#39;s what 4front also had (have?) trouble with.</span>
<span class="cm"> *</span>
<span class="cm"> * About ES1887 support:</span>
<span class="cm"> *</span>
<span class="cm"> * The ES1887 has separate registers to control the recording levels, for all</span>
<span class="cm"> * inputs. The ES1887 specific software makes these levels the same as their</span>
<span class="cm"> * corresponding playback levels, unless recmask says they aren&#39;t recorded. In</span>
<span class="cm"> * the latter case the recording volumes are 0.</span>
<span class="cm"> * Now recording levels of inputs can be controlled, by changing the playback</span>
<span class="cm"> * levels. Furthermore several devices can be recorded together (which is not</span>
<span class="cm"> * possible with the ES1688).</span>
<span class="cm"> * Besides the separate recording level control for each input, the common</span>
<span class="cm"> * recording level can also be controlled by RECLEV as described above.</span>
<span class="cm"> *</span>
<span class="cm"> * Not only ES1887 have this recording mixer. I know the following from the</span>
<span class="cm"> * documentation:</span>
<span class="cm"> * ES688	no</span>
<span class="cm"> * ES1688	no</span>
<span class="cm"> * ES1868	no</span>
<span class="cm"> * ES1869	yes</span>
<span class="cm"> * ES1878	no</span>
<span class="cm"> * ES1879	yes</span>
<span class="cm"> * ES1888	no/yes	Contradicting documentation; most recent: yes</span>
<span class="cm"> * ES1946	yes		This is a PCI chip; not handled by this driver</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &quot;sound_config.h&quot;</span>
<span class="cp">#include &quot;sb_mixer.h&quot;</span>
<span class="cp">#include &quot;sb.h&quot;</span>

<span class="cp">#include &quot;sb_ess.h&quot;</span>

<span class="cp">#define ESSTYPE_LIKE20	-1		</span><span class="cm">/* Mimic 2.0 behaviour					*/</span><span class="cp"></span>
<span class="cp">#define ESSTYPE_DETECT	0		</span><span class="cm">/* Mimic 2.0 behaviour					*/</span><span class="cp"></span>

<span class="cp">#define SUBMDL_ES1788	0x10	</span><span class="cm">/* Subtype ES1788 for specific handling */</span><span class="cp"></span>
<span class="cp">#define SUBMDL_ES1868	0x11	</span><span class="cm">/* Subtype ES1868 for specific handling */</span><span class="cp"></span>
<span class="cp">#define SUBMDL_ES1869	0x12	</span><span class="cm">/* Subtype ES1869 for specific handling */</span><span class="cp"></span>
<span class="cp">#define SUBMDL_ES1878	0x13	</span><span class="cm">/* Subtype ES1878 for specific handling */</span><span class="cp"></span>
<span class="cp">#define SUBMDL_ES1879	0x16    </span><span class="cm">/* ES1879 was initially forgotten */</span><span class="cp"></span>
<span class="cp">#define SUBMDL_ES1887	0x14	</span><span class="cm">/* Subtype ES1887 for specific handling */</span><span class="cp"></span>
<span class="cp">#define SUBMDL_ES1888	0x15	</span><span class="cm">/* Subtype ES1888 for specific handling */</span><span class="cp"></span>

<span class="cp">#define SB_CAP_ES18XX_RATE 0x100</span>

<span class="cp">#define ES1688_CLOCK1 795444 </span><span class="cm">/* 128 - div */</span><span class="cp"></span>
<span class="cp">#define ES1688_CLOCK2 397722 </span><span class="cm">/* 256 - div */</span><span class="cp"></span>
<span class="cp">#define ES18XX_CLOCK1 793800 </span><span class="cm">/* 128 - div */</span><span class="cp"></span>
<span class="cp">#define ES18XX_CLOCK2 768000 </span><span class="cm">/* 256 - div */</span><span class="cp"></span>

<span class="cp">#ifdef FKS_LOGGING</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ess_show_mixerregs</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ess_read</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ess_write</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ess_chgmixer</span>
	<span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">);</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *																			*</span>
<span class="cm"> *									ESS audio								*</span>
<span class="cm"> *																			*</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">struct</span> <span class="n">ess_command</span> <span class="p">{</span><span class="kt">short</span> <span class="n">cmd</span><span class="p">;</span> <span class="kt">short</span> <span class="n">data</span><span class="p">;};</span>

<span class="cm">/*</span>
<span class="cm"> * Commands for initializing Audio 1 for input (record)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="n">ess_i08m</span><span class="p">[]</span> <span class="o">=</span>		<span class="cm">/* input 8 bit mono */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="n">ess_i16m</span><span class="p">[]</span> <span class="o">=</span>		<span class="cm">/* input 16 bit mono */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="n">ess_i08s</span><span class="p">[]</span> <span class="o">=</span>		<span class="cm">/* input 8 bit stereo */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="n">ess_i16s</span><span class="p">[]</span> <span class="o">=</span>		<span class="cm">/* input 16 bit stereo */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="o">*</span><span class="n">ess_inp_cmds</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="n">ess_i08m</span><span class="p">,</span> <span class="n">ess_i16m</span><span class="p">,</span> <span class="n">ess_i08s</span><span class="p">,</span> <span class="n">ess_i16s</span> <span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Commands for initializing Audio 1 for output (playback)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="n">ess_o08m</span><span class="p">[]</span> <span class="o">=</span>		<span class="cm">/* output 8 bit mono */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="n">ess_o16m</span><span class="p">[]</span> <span class="o">=</span>		<span class="cm">/* output 16 bit mono */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="n">ess_o08s</span><span class="p">[]</span> <span class="o">=</span>		<span class="cm">/* output 8 bit stereo */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="n">ess_o16s</span><span class="p">[]</span> <span class="o">=</span>		<span class="cm">/* output 16 bit stereo */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="o">*</span><span class="n">ess_out_cmds</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="n">ess_o08m</span><span class="p">,</span> <span class="n">ess_o16m</span><span class="p">,</span> <span class="n">ess_o08s</span><span class="p">,</span> <span class="n">ess_o16s</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_exec_commands</span>
	<span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ess_command</span> <span class="o">*</span><span class="n">cmdtab</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ess_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmdtab</span> <span class="p">[</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">!=</span> <span class="n">AFMT_U8</span><span class="p">)</span> <span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_change</span>
	<span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">ess_read</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_set_output_parms</span>
	<span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf_16</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes_16</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag_16</span> <span class="o">=</span> <span class="n">intrflag</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span> <span class="o">=</span> <span class="n">intrflag</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_set_input_parms</span>
	<span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span> <span class="o">=</span> <span class="n">intrflag</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_INPUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_calc_div</span> <span class="p">(</span><span class="kt">int</span> <span class="n">clock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">revert</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">speedp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">diffp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">divider</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="n">diff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">speed</span>   <span class="o">=</span> <span class="o">*</span><span class="n">speedp</span><span class="p">;</span>
	<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span> <span class="o">+</span> <span class="n">speed</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">retval</span>  <span class="o">=</span> <span class="n">revert</span> <span class="o">-</span> <span class="n">divider</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="n">revert</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span>  <span class="o">=</span> <span class="n">revert</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="n">revert</span> <span class="o">-</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* This line is suggested. Must be wrong I think</span>
<span class="cm">	*speedp = (clock + divider / 2) / divider;</span>
<span class="cm">	So I chose the next one */</span>

	<span class="o">*</span><span class="n">speedp</span>	<span class="o">=</span> <span class="n">clock</span> <span class="o">/</span> <span class="n">divider</span><span class="p">;</span>
	<span class="n">diff</span>	<span class="o">=</span> <span class="n">speed</span> <span class="o">-</span> <span class="o">*</span><span class="n">speedp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">diff</span> <span class="o">=-</span><span class="n">diff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">diffp</span>  <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_calc_best_speed</span>
	<span class="p">(</span><span class="kt">int</span> <span class="n">clock1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rev1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clock2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rev2</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">divp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">speedp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">speed1</span> <span class="o">=</span> <span class="o">*</span><span class="n">speedp</span><span class="p">,</span> <span class="n">speed2</span> <span class="o">=</span> <span class="o">*</span><span class="n">speedp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">div1</span><span class="p">,</span> <span class="n">div2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diff1</span><span class="p">,</span> <span class="n">diff2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">div1</span> <span class="o">=</span> <span class="n">ess_calc_div</span> <span class="p">(</span><span class="n">clock1</span><span class="p">,</span> <span class="n">rev1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">diff1</span><span class="p">);</span>
	<span class="n">div2</span> <span class="o">=</span> <span class="n">ess_calc_div</span> <span class="p">(</span><span class="n">clock2</span><span class="p">,</span> <span class="n">rev2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">diff2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diff1</span> <span class="o">&lt;</span> <span class="n">diff2</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">divp</span>   <span class="o">=</span> <span class="n">div1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">speedp</span> <span class="o">=</span> <span class="n">speed1</span><span class="p">;</span>
		<span class="n">retval</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/*	*divp   = div2; */</span>
		<span class="o">*</span><span class="n">divp</span>   <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">div2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">speedp</span> <span class="o">=</span> <span class="n">speed2</span><span class="p">;</span>
		<span class="n">retval</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Depending on the audiochannel ESS devices can</span>
<span class="cm"> * have different clock settings. These are made consistent for duplex</span>
<span class="cm"> * however.</span>
<span class="cm"> * callers of ess_speed only do an audionum suggestion, which means</span>
<span class="cm"> * input suggests 1, output suggests 2. This suggestion is only true</span>
<span class="cm"> * however when doing duplex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_common_speed</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">speedp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">divp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">div</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The 0x80 is important for the first audio channel</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">==</span> <span class="n">SUBMDL_ES1888</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">ess_calc_div</span> <span class="p">(</span><span class="mi">795500</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">speedp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">diff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">ess_calc_div</span> <span class="p">(</span><span class="mi">795500</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">speedp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">diff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_CAP_ES18XX_RATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">==</span> <span class="n">SUBMDL_ES1888</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ess_calc_best_speed</span><span class="p">(</span><span class="mi">397700</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">795500</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> 
						<span class="o">&amp;</span><span class="n">div</span><span class="p">,</span> <span class="n">speedp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ess_calc_best_speed</span><span class="p">(</span><span class="n">ES18XX_CLOCK1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">ES18XX_CLOCK2</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> 
						<span class="o">&amp;</span><span class="n">div</span><span class="p">,</span> <span class="n">speedp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">speedp</span> <span class="o">&gt;</span> <span class="mi">22000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">ess_calc_div</span> <span class="p">(</span><span class="n">ES1688_CLOCK1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">speedp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">diff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="n">ess_calc_div</span> <span class="p">(</span><span class="n">ES1688_CLOCK2</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">speedp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">diff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">divp</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_speed</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">audionum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">div</span><span class="p">,</span> <span class="n">div2</span><span class="p">;</span>

	<span class="n">ess_common_speed</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">div</span><span class="p">);</span>

<span class="cp">#ifdef FKS_REG_LOGGING</span>
<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: ess_speed (%d) b speed = %d, div=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">audionum</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Set filter roll-off to 90% of speed/2 */</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">*</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span><span class="p">;</span>

	<span class="n">div2</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="mi">7160000</span> <span class="o">/</span> <span class="p">(</span><span class="n">speed</span> <span class="o">*</span> <span class="mi">82</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="n">audionum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audionum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Change behaviour of register A1 *</span>
<span class="cm">		sb_chg_mixer(devc, 0x71, 0x20, 0x20)</span>
<span class="cm">		* For ES1869 only??? */</span>
		<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
		<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="n">div2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * FKS: fascinating: 0x72 doesn&#39;t seem to work.</span>
<span class="cm">		 */</span>
		<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="n">div2</span><span class="p">);</span>
		<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="n">div2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_audio_prepare_for_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="n">ess_speed</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">DSP_CMD_SPKOFF</span><span class="p">);</span>

	<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>	<span class="cm">/* Auto init DMA mode */</span>
	<span class="n">ess_change</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>	<span class="cm">/* Mono/stereo */</span>
	<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Demand mode (4 bytes/DMA request) */</span>

	<span class="n">ess_exec_commands</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">ess_inp_cmds</span><span class="p">);</span>

	<span class="n">ess_change</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">ess_change</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_audio_prepare_for_output_audio1</span> <span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="n">sb_dsp_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="n">ess_speed</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* Auto init DMA mode */</span>
	<span class="n">ess_change</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>	<span class="cm">/* Mono/stereo */</span>
	<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Demand mode (4 bytes/request) */</span>

	<span class="n">ess_exec_commands</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">ess_out_cmds</span><span class="p">);</span>

	<span class="n">ess_change</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>	<span class="cm">/* Enable DMA */</span>
	<span class="n">ess_change</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>	<span class="cm">/* Enable IRQ */</span>

	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">DSP_CMD_SPKON</span><span class="p">);</span>	<span class="cm">/* There be sound! */</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_audio_prepare_for_output_audio2</span> <span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">;</span>

<span class="cm">/* FKS: qqq</span>
<span class="cm">	sb_dsp_reset(devc);</span>
<span class="cm">*/</span>

	<span class="cm">/*</span>
<span class="cm">	 * Auto-Initialize:</span>
<span class="cm">	 * DMA mode + demand mode (8 bytes/request, yes I want it all!)</span>
<span class="cm">	 * But leave 16-bit DMA bit untouched!</span>
<span class="cm">	 */</span>
	<span class="n">ess_chgmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>

	<span class="n">ess_speed</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* bits 4:3 on ES1887 represent recording source. Keep them! */</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">;</span>

	<span class="cm">/* Set stereo/mono */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="n">bits</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>

	<span class="cm">/* Init DACs; UNSIGNED mode for 8 bit; SIGNED mode for 16 bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">!=</span> <span class="n">AFMT_U8</span><span class="p">)</span> <span class="n">bits</span> <span class="o">|=</span> <span class="mh">0x05</span><span class="p">;</span>	<span class="cm">/* 16 bit */</span>

	<span class="cm">/* Enable DMA, IRQ will be shared (hopefully)*/</span>
	<span class="n">bits</span> <span class="o">|=</span> <span class="mh">0x60</span><span class="p">;</span>

	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>

	<span class="n">ess_mixer_reload</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">SOUND_MIXER_PCM</span><span class="p">);</span>	<span class="cm">/* There be sound! */</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_audio_prepare_for_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

<span class="cp">#ifdef FKS_REG_LOGGING</span>
<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ess_audio_prepare_for_output: dma_out=%d,dma_in=%d</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="p">,</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ess_audio_prepare_for_output_audio2</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bsize</span><span class="p">,</span> <span class="n">bcount</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ess_audio_prepare_for_output_audio1</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bsize</span><span class="p">,</span> <span class="n">bcount</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_audio_halt_xfer</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sb_dsp_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Audio 2 may still be operational! Creates awful sounds!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="n">ess_chgmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_audio_start_input</span>
	<span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">nr_bytes</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start a DMA input to the buffer pointed by dmaqtail</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_INPUT</span><span class="p">;</span>

	<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">ess_change</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>	<span class="cm">/* Go */</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_audio_output_block_audio1</span>
	<span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">nr_bytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>

	<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">ess_change</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>	<span class="cm">/* Go */</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_audio_output_block_audio2</span>
	<span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">nr_bytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">ess_chgmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>   <span class="cm">/* Go */</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span> <span class="o">=</span> <span class="n">IMODE_OUTPUT</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active_16</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_audio_output_block</span>
	<span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ess_audio_output_block_audio2</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="n">intrflag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ess_audio_output_block_audio1</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="n">intrflag</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FKS: the if-statements for both bits and bits_16 are quite alike.</span>
<span class="cm"> * Combine this...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_audio_trigger</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">bits_16</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span><span class="p">;</span>
	<span class="n">bits</span> <span class="o">&amp;=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bits</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bits_16</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FKS oh oh.... wrong?? for dma 16? */</span>
		<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>	<span class="cm">/* Halt DMA */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">case</span> <span class="n">IMODE_INPUT</span>:
				<span class="n">ess_audio_start_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span><span class="p">,</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IMODE_OUTPUT</span>:
				<span class="n">ess_audio_output_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes</span><span class="p">,</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bits_16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IMODE_INPUT</span>:
			<span class="n">ess_audio_start_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf_16</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes_16</span><span class="p">,</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag_16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IMODE_OUTPUT</span>:
			<span class="n">ess_audio_output_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_buf_16</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_bytes_16</span><span class="p">,</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trg_intrflag_16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">trigger_bits</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">|</span> <span class="n">bits_16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_audio_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minspeed</span><span class="p">,</span> <span class="n">maxspeed</span><span class="p">,</span> <span class="n">dummydiv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minspeed</span> <span class="o">=</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">?</span> <span class="mi">6215</span>  <span class="o">:</span> <span class="mi">5000</span> <span class="p">);</span>
		<span class="n">maxspeed</span> <span class="o">=</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">?</span> <span class="mi">44100</span> <span class="o">:</span> <span class="mi">48000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="n">minspeed</span><span class="p">)</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">minspeed</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">maxspeed</span><span class="p">)</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">maxspeed</span><span class="p">;</span>

		<span class="n">ess_common_speed</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummydiv</span><span class="p">);</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FKS: This is a one-on-one copy of sb1_audio_set_bits</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ess_audio_set_bits</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_U8</span> <span class="o">||</span> <span class="n">bits</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FKS: This is a one-on-one copy of sbpro_audio_set_channels</span>
<span class="cm"> * (*) Modified it!!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">short</span> <span class="nf">ess_audio_set_channels</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="n">ess_audio_driver</span> <span class="o">=</span>   <span class="cm">/* ESS ES688/1688 */</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">sb_audio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">sb_audio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_block</span>		<span class="o">=</span> <span class="n">ess_set_output_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_input</span>		<span class="o">=</span> <span class="n">ess_set_input_parms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_input</span>	<span class="o">=</span> <span class="n">ess_audio_prepare_for_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_output</span>	<span class="o">=</span> <span class="n">ess_audio_prepare_for_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_io</span>		<span class="o">=</span> <span class="n">ess_audio_halt_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>		<span class="o">=</span> <span class="n">ess_audio_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed</span>		<span class="o">=</span> <span class="n">ess_audio_set_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bits</span>		<span class="o">=</span> <span class="n">ess_audio_set_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channels</span>		<span class="o">=</span> <span class="n">ess_audio_set_channels</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ess_audio_init must be called from sb_audio_init</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">audio_driver</span> <span class="o">*</span><span class="nf">ess_audio_init</span>
		<span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">audio_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">format_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">audio_flags</span> <span class="o">=</span> <span class="n">DMA_AUTOMODE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">format_mask</span> <span class="o">|=</span> <span class="n">AFMT_S16_LE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tmp_dma</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * sb_audio_init thinks dma8 is for playback and</span>
<span class="cm">		 * dma16 is for record. Not now! So swap them.</span>
<span class="cm">		 */</span>
		<span class="n">tmp_dma</span>		<span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span>	<span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span>	<span class="o">=</span> <span class="n">tmp_dma</span><span class="p">;</span>

		<span class="o">*</span><span class="n">audio_flags</span> <span class="o">|=</span> <span class="n">DMA_DUPLEX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ess_audio_driver</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *																			*</span>
<span class="cm"> *								ESS common									*</span>
<span class="cm"> *																			*</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_handle_channel</span>
	<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr_active</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_active</span> <span class="o">||</span> <span class="o">!</span><span class="n">flag</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef FKS_REG_LOGGING</span>
<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: ess_handle_channel %s irq_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">irq_mode</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">irq_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IMODE_OUTPUT</span>:
			<span class="n">DMAbuf_outputintr</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IMODE_INPUT</span>:
			<span class="n">DMAbuf_inputintr</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IMODE_INIT</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span><span class="p">;</span>
			<span class="cm">/* printk(KERN_WARNING &quot;ESS: Unexpected interrupt\n&quot;); */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FKS: TODO!!! Finish this!</span>
<span class="cm"> *</span>
<span class="cm"> * I think midi stuff uses uart401, without interrupts.</span>
<span class="cm"> * So IMODE_MIDI isn&#39;t a value for devc-&gt;irq_mode.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ess_intr</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>				<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">src</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">==</span> <span class="n">SUBMDL_ES1887</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef FKS_REG_LOGGING</span>
<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: sbintr src=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">src</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ess_handle_channel</span>
		<span class="p">(</span> <span class="s">&quot;Audio 1&quot;</span>
		<span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span>   <span class="p">,</span> <span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span>   <span class="p">);</span>
	<span class="n">ess_handle_channel</span>
		<span class="p">(</span> <span class="s">&quot;Audio 2&quot;</span>
		<span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active_16</span><span class="p">,</span> <span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Acknowledge interrupts</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">==</span> <span class="n">SUBMDL_ES1887</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ess_chgmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">DSP_DATA_AVAIL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_extended</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enable extended mode */</span>

	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_write</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef FKS_REG_LOGGING</span>
<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: write reg %x: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Write a byte to an extended mode register of ES1688 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_read</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Read a byte from an extended mode register of ES1688 */</span>

	<span class="cm">/* Read register command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span> <span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sb_dsp_get_byte</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ess_dsp_reset</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loopc</span><span class="p">;</span>

<span class="cp">#ifdef FKS_REG_LOGGING</span>
<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: ess_dsp_reset 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">ess_show_mixerregs</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Entered ess_dsp_reset()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">DSP_RESET</span><span class="p">);</span> <span class="cm">/* Reset FIFO too */</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DSP_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loopc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loopc</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">DSP_DATA_AVAIL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span> <span class="n">loopc</span><span class="o">++</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">DSP_READ</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sb: No response to RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* Sorry */</span>
	<span class="p">}</span>
	<span class="n">ess_extended</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sb_dsp_reset() OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

<span class="cp">#ifdef FKS_LOGGING</span>
<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: dsp_reset 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">ess_show_mixerregs</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_irq_bits</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">10</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ESS1688: Invalid IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Set IRQ configuration register for all ESS models</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_common_set_irq_hw</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq_bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irq_bits</span> <span class="o">=</span> <span class="n">ess_irq_bits</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x50</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq_bits</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ES1688: Failed to write to IRQ config register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * I wanna use modern ES1887 mixer irq handling. Funny is the</span>
<span class="cm"> * fact that my BIOS wants the same. But suppose someone&#39;s BIOS</span>
<span class="cm"> * doesn&#39;t do this!</span>
<span class="cm"> * This is independent of duplex. If there&#39;s a 1887 this will</span>
<span class="cm"> * prevent it from going into 1888 mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_es1887_set_irq_hw</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq_bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irq_bits</span> <span class="o">=</span> <span class="n">ess_irq_bits</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">ess_chgmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x01</span> <span class="o">|</span> <span class="p">((</span><span class="n">irq_bits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_set_irq_hw</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">==</span> <span class="n">SUBMDL_ES1887</span><span class="p">)</span> <span class="n">ess_es1887_set_irq_hw</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ess_common_set_irq_hw</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef FKS_TEST</span>

<span class="cm">/*</span>
<span class="cm"> * FKS_test:</span>
<span class="cm"> *	for ES1887: 00, 18, non wr bits: 0001 1000</span>
<span class="cm"> *	for ES1868: 00, b8, non wr bits: 1011 1000</span>
<span class="cm"> *	for ES1888: 00, f8, non wr bits: 1111 1000</span>
<span class="cm"> *	for ES1688: 00, f8, non wr bits: 1111 1000</span>
<span class="cm"> *	+   ES968</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FKS_test</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>
	<span class="n">val1</span> <span class="o">=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">);</span>
	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="o">~</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">)</span> <span class="o">^</span> <span class="o">~</span><span class="n">val1</span><span class="p">;</span>
	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
	<span class="n">val1</span> <span class="o">^=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">);</span>
<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: FKS_test %02x, %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">),</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">));</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ess_identify</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="mh">0x40</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">MIXER_ADDR</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">val</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MIXER_DATA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MIXER_DATA</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ESS technology describes a detection scheme in their docs. It involves</span>
<span class="cm"> * fiddling with the bits in certain mixer registers. ess_probe is supposed</span>
<span class="cm"> * to help.</span>
<span class="cm"> *</span>
<span class="cm"> * FKS: tracing shows ess_probe writes wrong value to 0x64. Bit 3 reads 1, but</span>
<span class="cm"> * should be written 0 only. Check this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_probe</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xorval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val3</span><span class="p">;</span>

	<span class="n">val1</span> <span class="o">=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">^</span> <span class="n">xorval</span><span class="p">;</span>
	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
	<span class="n">val3</span> <span class="o">=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">val2</span> <span class="o">==</span> <span class="n">val3</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ess_init</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ess_major</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ess_minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="n">modelname</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to detect ESS chips.</span>
<span class="cm">	 */</span>

	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">);</span> <span class="cm">/* Return identification */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">DSP_DATA_AVAIL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ess_major</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ess_major</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">DSP_READ</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ess_minor</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">DSP_READ</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ess_major</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ess_major</span> <span class="o">==</span> <span class="mh">0x48</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ess_minor</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ESS ES488 AudioDrive (rev %d)&quot;</span><span class="p">,</span>
			<span class="n">ess_minor</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MDL_SBPRO</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This the detection heuristic of ESS technology, though somewhat</span>
<span class="cm">	 * changed to actually make it work.</span>
<span class="cm">	 * This results in the following detection steps:</span>
<span class="cm">	 * - distinct between ES688 and ES1688+ (as always done in this driver)</span>
<span class="cm">	 *   if ES688 we&#39;re ready</span>
<span class="cm">	 * - try to detect ES1868, ES1869 or ES1878 (ess_identify)</span>
<span class="cm">	 *   if successful we&#39;re ready</span>
<span class="cm">	 * - try to detect ES1888, ES1887 or ES1788 (aim: detect ES1887)</span>
<span class="cm">	 *   if successful we&#39;re ready</span>
<span class="cm">	 * - Dunno. Must be 1688. Will do in general</span>
<span class="cm">	 *</span>
<span class="cm">	 * This is the most BETA part of the software: Will the detection</span>
<span class="cm">	 * always work?</span>
<span class="cm">	 */</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MDL_ESS</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">ess_minor</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ess_major</span> <span class="o">==</span> <span class="mh">0x68</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ess_minor</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">submodel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">sbmo</span><span class="p">.</span><span class="n">esstype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ESSTYPE_DETECT</span>:
		<span class="k">case</span> <span class="n">ESSTYPE_LIKE20</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">688</span>:
			<span class="n">submodel</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1688</span>:
			<span class="n">submodel</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1868</span>:
			<span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1868</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1869</span>:
			<span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1869</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1788</span>:
			<span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1788</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1878</span>:
			<span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1878</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1879</span>:
			<span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1879</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1887</span>:
			<span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1887</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1888</span>:
			<span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1888</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid esstype=%d specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">sbmo</span><span class="p">.</span><span class="n">esstype</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">submodel</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">submodel</span><span class="p">;</span>
			<span class="n">sprintf</span> <span class="p">(</span><span class="n">modelname</span><span class="p">,</span> <span class="s">&quot;ES%d&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">sbmo</span><span class="p">.</span><span class="n">esstype</span><span class="p">);</span>
			<span class="n">chip</span> <span class="o">=</span> <span class="n">modelname</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ess_minor</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES688&quot;</span><span class="p">;</span>
		<span class="p">};</span>
<span class="cp">#ifdef FKS_TEST</span>
<span class="n">FKS_test</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/*</span>
<span class="cm">		 * If Nothing detected yet, and we want 2.0 behaviour...</span>
<span class="cm">		 * Then let&#39;s assume it&#39;s ES1688.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">sbmo</span><span class="p">.</span><span class="n">esstype</span> <span class="o">==</span> <span class="n">ESSTYPE_LIKE20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES1688&quot;</span><span class="p">;</span>
		<span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

			<span class="n">type</span> <span class="o">=</span> <span class="n">ess_identify</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x1868</span>:
				<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES1868&quot;</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1868</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1869</span>:
				<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES1869&quot;</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1869</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1878</span>:
				<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES1878&quot;</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1878</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1879</span>:
				<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES1879&quot;</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1879</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;ess_init: Unrecognized %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">};</span>
		<span class="p">};</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/*</span>
<span class="c">		 * this one failed:</span>
<span class="c">		 * the probing of bit 4 is another thought: from ES1788 and up, all</span>
<span class="c">		 * chips seem to have hardware volume control. Bit 4 is readonly to</span>
<span class="c">		 * check if a hardware volume interrupt has fired.</span>
<span class="c">		 * Cause ES688/ES1688 don&#39;t have this feature, bit 4 might be writeable</span>
<span class="c">		 * for these chips.</span>
<span class="c">		 */</span>
<span class="c">		if (chip == NULL &amp;&amp; !ess_probe(devc, 0x64, (1 &lt;&lt; 4))) {</span>
<span class="cp">#endif</span>
		<span class="cm">/*</span>
<span class="cm">		 * the probing of bit 2 is my idea. The ES1887 docs want me to probe</span>
<span class="cm">		 * bit 3. This results in ES1688 being detected as ES1788.</span>
<span class="cm">		 * Bit 2 is for &quot;Enable HWV IRQE&quot;, but as ES(1)688 chips don&#39;t have</span>
<span class="cm">		 * HardWare Volume, I think they don&#39;t have this IRQE.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ess_probe</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ess_probe</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ess_probe</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES1887&quot;</span><span class="p">;</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1887</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES1888&quot;</span><span class="p">;</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1888</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES1788&quot;</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ES1788</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;ES1688&quot;</span><span class="p">;</span>
		<span class="p">};</span>

	    <span class="n">printk</span> <span class="p">(</span> <span class="n">KERN_INFO</span> <span class="s">&quot;ESS chip %s %s%s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="p">,</span> <span class="n">chip</span>
               <span class="p">,</span> <span class="p">(</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">sbmo</span><span class="p">.</span><span class="n">esstype</span> <span class="o">==</span> <span class="n">ESSTYPE_DETECT</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">sbmo</span><span class="p">.</span><span class="n">esstype</span> <span class="o">==</span> <span class="n">ESSTYPE_LIKE20</span>
                 <span class="o">?</span> <span class="s">&quot;detected&quot;</span>
                 <span class="o">:</span> <span class="s">&quot;specified&quot;</span>
                 <span class="p">)</span>
               <span class="p">,</span> <span class="p">(</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">sbmo</span><span class="p">.</span><span class="n">esstype</span> <span class="o">==</span> <span class="n">ESSTYPE_LIKE20</span>
                 <span class="o">?</span> <span class="s">&quot; (kernel 2.0 compatible)&quot;</span>
                 <span class="o">:</span> <span class="s">&quot;&quot;</span>
                 <span class="p">)</span>
               <span class="p">);</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;ESS %s AudioDrive (rev %d)&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">ess_minor</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Jazz16&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* AAS: info stolen from ALSA: these boards have different clocks */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/* APPARENTLY NOT 1869 AND 1887</span>
<span class="cm">		case SUBMDL_ES1869:</span>
<span class="cm">		case SUBMDL_ES1887:</span>
<span class="cm">*/</span>		
		<span class="k">case</span> <span class="n">SUBMDL_ES1888</span>:
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">SB_CAP_ES18XX_RATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="cm">/* FKS: sb_dsp_reset to enable extended mode???? */</span>
	<span class="n">sb_dsp_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span> <span class="cm">/* Turn on extended mode */</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Enable joystick and OPL3</span>
<span class="cm">	 */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* ES1688 */</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">SB_NO_MIDI</span><span class="p">;</span>   <span class="cm">/* ES1688 uses MPU401 MIDI mode */</span>
	<span class="p">}</span>
	<span class="n">sb_dsp_reset</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is important! If it&#39;s not done, the IRQ probe in sb_dsp_init</span>
<span class="cm">	 * may fail.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">ess_set_irq_hw</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_set_dma_hw</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dma_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dma16_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>

<span class="cp">#ifdef FKS_LOGGING</span>
<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ess_set_dma_hw: dma8=%d,dma16=%d,dup=%d</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * FKS: It seems as if this duplex flag isn&#39;t set yet. Check it.</span>
<span class="cm">	 */</span>
	<span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ESS1688: Invalid DMA8 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Extended mode DMA enable */</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_bits</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_bits</span> <span class="o">=</span> <span class="n">dma</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">|</span> <span class="p">(</span><span class="n">dma_bits</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ESS1688: Failed to write to DMA config register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">;</span>
		<span class="n">dma16_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">dma_bits</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">dma_bits</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">dma_bits</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">dma_bits</span>   <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
				<span class="n">dma16_bits</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ESS1887: Invalid DMA16 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">};</span>
			<span class="n">ess_chgmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">dma16_bits</span><span class="p">);</span>
			<span class="n">ess_chgmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">dma_bits</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This one is called from sb_dsp_init.</span>
<span class="cm"> *</span>
<span class="cm"> * Return values:</span>
<span class="cm"> *  0: Failed</span>
<span class="cm"> *  1: Succeeded or doesn&#39;t apply (not SUBMDL_ES1887)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ess_dsp_init</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Caller also checks this, but anyway</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MDL_ESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ess_dsp_init for non ESS chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * This for ES1887 to run Full Duplex. Actually ES1888</span>
<span class="cm">	 * is allowed to do so too. I have no idea yet if this</span>
<span class="cm">	 * will work for ES1888 however.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For SB16 having both dma8 and dma16 means enable</span>
<span class="cm">	 * Full Duplex. Let&#39;s try this for ES1887 too</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">==</span> <span class="n">SUBMDL_ES1887</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * devc-&gt;duplex initialization is put here, cause</span>
<span class="cm">		 * ess_set_dma_hw needs it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ess_set_dma_hw</span> <span class="p">(</span><span class="n">devc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">devc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *																			*</span>
<span class="cm"> *									ESS mixer								*</span>
<span class="cm"> *																			*</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cp">#define ES688_RECORDING_DEVICES	\</span>
<span class="cp">			( SOUND_MASK_LINE	| SOUND_MASK_MIC	| SOUND_MASK_CD		)</span>
<span class="cp">#define ES688_MIXER_DEVICES		\</span>
<span class="cp">			( SOUND_MASK_SYNTH	| SOUND_MASK_PCM	| SOUND_MASK_LINE	\</span>
<span class="cp">			| SOUND_MASK_MIC	| SOUND_MASK_CD		| SOUND_MASK_VOLUME	\</span>
<span class="cp">			| SOUND_MASK_LINE2	| SOUND_MASK_SPEAKER					)</span>

<span class="cp">#define ES1688_RECORDING_DEVICES	\</span>
<span class="cp">			( ES688_RECORDING_DEVICES					)</span>
<span class="cp">#define ES1688_MIXER_DEVICES		\</span>
<span class="cp">			( ES688_MIXER_DEVICES | SOUND_MASK_RECLEV	)</span>

<span class="cp">#define ES1887_RECORDING_DEVICES	\</span>
<span class="cp">			( ES1688_RECORDING_DEVICES | SOUND_MASK_LINE2 | SOUND_MASK_SYNTH)</span>
<span class="cp">#define ES1887_MIXER_DEVICES		\</span>
<span class="cp">			( ES1688_MIXER_DEVICES											)</span>

<span class="cm">/*</span>
<span class="cm"> * Mixer registers of ES1887</span>
<span class="cm"> *</span>
<span class="cm"> * These registers specifically take care of recording levels. To make the</span>
<span class="cm"> * mapping from playback devices to recording devices every recording</span>
<span class="cm"> * devices = playback device + ES_REC_MIXER_RECDIFF</span>
<span class="cm"> */</span>
<span class="cp">#define ES_REC_MIXER_RECBASE	(SOUND_MIXER_LINE3 + 1)</span>
<span class="cp">#define ES_REC_MIXER_RECDIFF	(ES_REC_MIXER_RECBASE - SOUND_MIXER_SYNTH)</span>

<span class="cp">#define ES_REC_MIXER_RECSYNTH	(SOUND_MIXER_SYNTH	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECPCM		(SOUND_MIXER_PCM	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECSPEAKER	(SOUND_MIXER_SPEAKER + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECLINE	(SOUND_MIXER_LINE	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECMIC		(SOUND_MIXER_MIC	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECCD		(SOUND_MIXER_CD		 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECIMIX	(SOUND_MIXER_IMIX	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECALTPCM	(SOUND_MIXER_ALTPCM	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECRECLEV	(SOUND_MIXER_RECLEV	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECIGAIN	(SOUND_MIXER_IGAIN	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECOGAIN	(SOUND_MIXER_OGAIN	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECLINE1	(SOUND_MIXER_LINE1	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECLINE2	(SOUND_MIXER_LINE2	 + ES_REC_MIXER_RECDIFF)</span>
<span class="cp">#define ES_REC_MIXER_RECLINE3	(SOUND_MIXER_LINE3	 + ES_REC_MIXER_RECDIFF)</span>

<span class="k">static</span> <span class="n">mixer_tab</span> <span class="n">es688_mix</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_VOLUME</span><span class="p">,</span>			<span class="mh">0x32</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_BASS</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_TREBLE</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SYNTH</span><span class="p">,</span>			<span class="mh">0x36</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_PCM</span><span class="p">,</span>			<span class="mh">0x14</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SPEAKER</span><span class="p">,</span>		<span class="mh">0x3c</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE</span><span class="p">,</span>			<span class="mh">0x3e</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_MIC</span><span class="p">,</span>			<span class="mh">0x1a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_CD</span><span class="p">,</span>				<span class="mh">0x38</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IMIX</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_ALTPCM</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_RECLEV</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_OGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE1</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE2</span><span class="p">,</span>			<span class="mh">0x3a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE3</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The ES1688 specifics... hopefully correct...</span>
<span class="cm"> * - 6 bit master volume</span>
<span class="cm"> *   I was wrong, ES1888 docs say ES1688 didn&#39;t have it.</span>
<span class="cm"> * - RECLEV control</span>
<span class="cm"> * These may apply to ES688 too. I have no idea.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">mixer_tab</span> <span class="n">es1688_mix</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_VOLUME</span><span class="p">,</span>			<span class="mh">0x32</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_BASS</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_TREBLE</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SYNTH</span><span class="p">,</span>			<span class="mh">0x36</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_PCM</span><span class="p">,</span>			<span class="mh">0x14</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SPEAKER</span><span class="p">,</span>		<span class="mh">0x3c</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE</span><span class="p">,</span>			<span class="mh">0x3e</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_MIC</span><span class="p">,</span>			<span class="mh">0x1a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_CD</span><span class="p">,</span>				<span class="mh">0x38</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IMIX</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_ALTPCM</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_RECLEV</span><span class="p">,</span>			<span class="mh">0xb4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_OGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE1</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE2</span><span class="p">,</span>			<span class="mh">0x3a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE3</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">mixer_tab</span> <span class="n">es1688later_mix</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_VOLUME</span><span class="p">,</span>			<span class="mh">0x60</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_BASS</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_TREBLE</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SYNTH</span><span class="p">,</span>			<span class="mh">0x36</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_PCM</span><span class="p">,</span>			<span class="mh">0x14</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SPEAKER</span><span class="p">,</span>		<span class="mh">0x3c</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE</span><span class="p">,</span>			<span class="mh">0x3e</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_MIC</span><span class="p">,</span>			<span class="mh">0x1a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_CD</span><span class="p">,</span>				<span class="mh">0x38</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IMIX</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_ALTPCM</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_RECLEV</span><span class="p">,</span>			<span class="mh">0xb4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_OGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE1</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE2</span><span class="p">,</span>			<span class="mh">0x3a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE3</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This one is for all ESS chips with a record mixer.</span>
<span class="cm"> * It&#39;s not used (yet) however</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">mixer_tab</span> <span class="n">es_rec_mix</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_VOLUME</span><span class="p">,</span>			<span class="mh">0x60</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_BASS</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_TREBLE</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SYNTH</span><span class="p">,</span>			<span class="mh">0x36</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_PCM</span><span class="p">,</span>			<span class="mh">0x14</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SPEAKER</span><span class="p">,</span>		<span class="mh">0x3c</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE</span><span class="p">,</span>			<span class="mh">0x3e</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_MIC</span><span class="p">,</span>			<span class="mh">0x1a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_CD</span><span class="p">,</span>				<span class="mh">0x38</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IMIX</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_ALTPCM</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_RECLEV</span><span class="p">,</span>			<span class="mh">0xb4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_OGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE1</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE2</span><span class="p">,</span>			<span class="mh">0x3a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE3</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECSYNTH</span><span class="p">,</span>		<span class="mh">0x6b</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECPCM</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECSPEAKER</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECLINE</span><span class="p">,</span>		<span class="mh">0x6e</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECMIC</span><span class="p">,</span>		<span class="mh">0x68</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECCD</span><span class="p">,</span>			<span class="mh">0x6a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECIMIX</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECALTPCM</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECRECLEV</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECIGAIN</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECOGAIN</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECLINE1</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECLINE2</span><span class="p">,</span>		<span class="mh">0x6c</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECLINE3</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This one is for ES1887. It&#39;s little different from es_rec_mix: it</span>
<span class="cm"> * has 0x7c for PCM playback level. This is because ES1887 uses</span>
<span class="cm"> * Audio 2 for playback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">mixer_tab</span> <span class="n">es1887_mix</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_VOLUME</span><span class="p">,</span>			<span class="mh">0x60</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_BASS</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_TREBLE</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SYNTH</span><span class="p">,</span>			<span class="mh">0x36</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_PCM</span><span class="p">,</span>			<span class="mh">0x7c</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_SPEAKER</span><span class="p">,</span>		<span class="mh">0x3c</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE</span><span class="p">,</span>			<span class="mh">0x3e</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_MIC</span><span class="p">,</span>			<span class="mh">0x1a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_CD</span><span class="p">,</span>				<span class="mh">0x38</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IMIX</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_ALTPCM</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_RECLEV</span><span class="p">,</span>			<span class="mh">0xb4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_IGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_OGAIN</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE1</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE2</span><span class="p">,</span>			<span class="mh">0x3a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">SOUND_MIXER_LINE3</span><span class="p">,</span>			<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECSYNTH</span><span class="p">,</span>		<span class="mh">0x6b</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECPCM</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECSPEAKER</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECLINE</span><span class="p">,</span>		<span class="mh">0x6e</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECMIC</span><span class="p">,</span>		<span class="mh">0x68</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECCD</span><span class="p">,</span>			<span class="mh">0x6a</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECIMIX</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECALTPCM</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECRECLEV</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECIGAIN</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECOGAIN</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECLINE1</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECLINE2</span><span class="p">,</span>		<span class="mh">0x6c</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="n">MIX_ENT</span><span class="p">(</span><span class="n">ES_REC_MIXER_RECLINE3</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ess_has_rec_mixer</span> <span class="p">(</span><span class="kt">int</span> <span class="n">submodel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">submodel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SUBMDL_ES1887</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="cp">#ifdef FKS_LOGGING</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ess_mixer_mon_regs</span><span class="p">[]</span>
	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x7f</span>
	  <span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xa9</span>
	  <span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xb9</span>
	  <span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_show_mixerregs</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ess_mixer_mon_regs</span><span class="p">;</span>

<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">mp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;res (%x)=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="o">*</span><span class="n">mp</span><span class="p">)));</span>
		<span class="n">mp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">ess_setmixer</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef FKS_LOGGING</span>
<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: write mixer %x: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ess_write</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">MIXER_ADDR</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">MIXER_DATA</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">};</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ess_getmixer</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ess_read</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">MIXER_ADDR</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MIXER_DATA</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_chgmixer</span>
	<span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ess_mixer_init must be called from sb_mixer_init</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ess_mixer_init</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_caps</span> <span class="o">=</span> <span class="n">SOUND_CAP_EXCL_INPUT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	* Take care of ES1887 specifics...</span>
<span class="cm">	*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SUBMDL_ES1887</span>:
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span>		<span class="o">=</span> <span class="n">ES1887_MIXER_DEVICES</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span>	<span class="o">=</span> <span class="n">ES1887_RECORDING_DEVICES</span><span class="p">;</span>
<span class="cp">#ifdef FKS_LOGGING</span>
<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: ess_mixer_init dup = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap</span>				<span class="o">=</span> <span class="o">&amp;</span><span class="n">es1887_mix</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap_sz</span>                          <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">es1887_mix</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap</span>				<span class="o">=</span> <span class="o">&amp;</span><span class="n">es_rec_mix</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap_sz</span>                          <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">es_rec_mix</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span>		<span class="o">=</span> <span class="n">ES688_MIXER_DEVICES</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span>	<span class="o">=</span> <span class="n">ES688_RECORDING_DEVICES</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap</span>					<span class="o">=</span> <span class="o">&amp;</span><span class="n">es688_mix</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap_sz</span>                                  <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">es688_mix</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * es1688 has 4 bits master vol.</span>
<span class="cm">			 * later chips have 6 bits (?)</span>
<span class="cm">			 */</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span>		<span class="o">=</span> <span class="n">ES1688_MIXER_DEVICES</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span>	<span class="o">=</span> <span class="n">ES1688_RECORDING_DEVICES</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap</span>				<span class="o">=</span> <span class="o">&amp;</span><span class="n">es1688_mix</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap_sz</span>                          <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">es688_mix</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap</span>				<span class="o">=</span> <span class="o">&amp;</span><span class="n">es1688later_mix</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">iomap_sz</span>                          <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">es1688later_mix</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Changing playback levels at an ESS chip with record mixer means having to</span>
<span class="cm"> * take care of recording levels of recorded inputs (devc-&gt;recmask) too!</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ess_mixer_set</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ess_has_rec_mixer</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">sb_common_mixer_set</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">dev</span> <span class="o">+</span> <span class="n">ES_REC_MIXER_RECDIFF</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sb_common_mixer_set</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * After a sb_dsp_reset extended register 0xb4 (RECLEV) is reset too. After</span>
<span class="cm"> * sb_dsp_reset RECLEV has to be restored. This is where ess_mixer_reload</span>
<span class="cm"> * helps.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ess_mixer_reload</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="n">left</span>  <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">sb_common_mixer_set</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">es_rec_set_recmask</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">i_mask</span><span class="p">,</span> <span class="n">cur_mask</span><span class="p">,</span> <span class="n">diff_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>

<span class="cp">#ifdef FKS_LOGGING</span>
<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FKS: es_rec_set_recmask mask = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Changing the recmask on an ESS chip with recording mixer means:</span>
<span class="cm">	 * (1) Find the differences</span>
<span class="cm">	 * (2) For &quot;turned-on&quot;  inputs: make the recording level the playback level</span>
<span class="cm">	 * (3) For &quot;turned-off&quot; inputs: make the recording level zero</span>
<span class="cm">	 */</span>
	<span class="n">cur_mask</span>  <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span><span class="p">;</span>
	<span class="n">diff_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_mask</span> <span class="o">^</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff_mask</span> <span class="o">&amp;</span> <span class="n">i_mask</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Difference? (1)  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">i_mask</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Turn it on  (2)  */</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">left</span>  <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">;</span>
				<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>				<span class="cm">/* Turn it off (3)  */</span>
				<span class="n">left</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sb_common_mixer_set</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ES_REC_MIXER_RECDIFF</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ess_set_recmask</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This applies to ESS chips with record mixers only! */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ess_has_rec_mixer</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mask</span>	<span class="o">=</span> <span class="n">es_rec_set_recmask</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="o">*</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>									<span class="cm">/* Applied		*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>									<span class="cm">/* Not applied	*/</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ess_mixer_reset must be called from sb_mixer_reset</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ess_mixer_reset</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Separate actions for ESS chips with a record mixer:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ess_has_rec_mixer</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SUBMDL_ES1887</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Separate actions for ES1887:</span>
<span class="cm">			 * Change registers 7a and 1c to make the record mixer the</span>
<span class="cm">			 * actual recording source.</span>
<span class="cm">			 */</span>
			<span class="n">ess_chgmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
			<span class="n">ess_chgmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="cm">/*</span>
<span class="cm">		 * Call set_recmask for proper initialization</span>
<span class="cm">		 */</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span><span class="p">;</span>
		<span class="n">es_rec_set_recmask</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* We took care of recmask.				*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* We didn&#39;t take care; caller do it	*/</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *																			*</span>
<span class="cm"> *								ESS midi									*</span>
<span class="cm"> *																			*</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * FKS: IRQ may be shared. Hm. And if so? Then What?</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ess_midi_init</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">cfg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">);</span>	<span class="cm">/* Enable OPL3 &amp; joystick */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  					 <span class="cm">/* ES688 doesn&#39;t support MPU401 mode */</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">&amp;</span> <span class="mh">0x0f0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* MPU enabled without interrupts */</span>

	<span class="cm">/* May be shared: if so the value is -ve */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">9</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
